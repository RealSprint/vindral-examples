(()=>{"use strict";var e,t,i={4896:(e,t,i)=>{i.d(t,{A:()=>w,i:()=>g,p:()=>v,t:()=>m});var s=Object.defineProperty,n=Object.defineProperties,r=Object.getOwnPropertyDescriptors,o=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,h=Object.prototype.propertyIsEnumerable,d=(e,t,i)=>t in e?s(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,c=(e,t)=>{for(var i in t||(t={}))a.call(t,i)&&d(e,i,t[i]);if(o)for(var i of o(t))h.call(t,i)&&d(e,i,t[i]);return e},u=(e,t,i)=>d(e,"symbol"!=typeof t?t+"":t,i),l=(e,t,i)=>new Promise(((s,n)=>{var r=e=>{try{a(i.next(e))}catch(e){n(e)}},o=e=>{try{a(i.throw(e))}catch(e){n(e)}},a=e=>e.done?s(e.value):Promise.resolve(e.value).then(r,o);a((i=i.apply(e,t)).next())}));const m=e=>{try{return JSON.parse(e)}catch(e){return}};class A extends Error{constructor({status:e,url:t,body:i}){const s=m(i);var n;super("object"==typeof(n=s)&&null!==n&&"message"in n?s.message:`Url ${t.toString()}, Status code: ${e}, Body: ${i}`),u(this,"status"),u(this,"body"),u(this,"url"),this.status=e,this.body=i,this.url=t,Object.setPrototypeOf(this,new.target.prototype)}}const g=e=>"number"==typeof e.status,p=(e,t)=>l(void 0,null,(function*(){const i=yield fetch(e.toString(),c({mode:"cors"},t));if(!i.ok)throw new A({status:i.status,url:e,body:yield i.text()});return i})),f=(e,t)=>l(void 0,null,(function*(){return yield(yield p(e,c({},t))).json()})),v=(e,t)=>l(void 0,null,(function*(){return p(e,c({method:"POST"},t))}));class w{constructor(e){u(this,"baseUrl"),u(this,"tokenFactory"),this.baseUrl=new URL("/api/v2/",e.publicEndpoint).toString(),this.tokenFactory=e.tokenFactory}connect(e){return l(this,null,(function*(){const{channelId:t,channelGroupId:i}=e,s={channelId:t,channelGroupId:i},o=new URL((d=e).channelGroupId?`connect/?channelId=${d.channelId}&channelGroupId=${d.channelGroupId}`:`connect/?channelId=${d.channelId}`,this.baseUrl),a=this.getAuthToken(s),h=yield f(o,{headers:this.getHeaders(a)});var d;return{channels:h.channels.map((e=>{const t=this.toChannel(e,s);return((e,t)=>n(e,r(t)))(c({},t),{renditions:e.renditions,overrides:e.overrides})})),edges:h.edges,logsUrl:h.logsUrl,statsUrl:h.statsUrl,telemetry:h.telemetry}}))}getChannel(e){return l(this,null,(function*(){const t={channelId:e},i=new URL(`channel/${e}`,this.baseUrl),s=this.getAuthToken(t),n=yield f(i,{headers:this.getHeaders(s)});return this.toChannel(n,t,s)}))}getChannels(e){return l(this,null,(function*(){const t={channelGroupId:e},i=new URL(`channels/${e}`,this.baseUrl),s=this.getAuthToken(t),n=yield f(i,{headers:this.getHeaders(s)});return this.toChannels(n,t,s)}))}getHeaders(e){var t,i;return null!=(t=(i=e)?{Authorization:`Bearer ${i}`}:void 0)?t:{}}getAuthToken(e){return this.tokenFactory?this.tokenFactory(e):void 0}toChannels(e,t,i){return e.map((e=>this.toChannel(e,t,i)))}toChannel(e,t,i){const{baseUrl:s,sizes:n}=e.thumbnail,r=s||new URL(((e,t)=>t?e.channelGroupId?`thumbnail/?channelGroupId=${e.channelGroupId}&auth.token=${t}&auth.type=jwt`:e.channelId?`thumbnail/?channelId=${e.channelId}&auth.token=${t}&auth.type=jwt`:"thumbnail":"thumbnail")(t,i),this.baseUrl),o=n.map((s=>new URL(`?channelId=${e.channelId}&width=${s.width}&height=${s.height}${b(t,i)}`,r).toString()));return{channelId:e.channelId,name:e.name,isLive:e.isLive,thumbnailUrls:o}}}const b=(e,t)=>t?e.channelGroupId?`&channelGroupId=${e.channelGroupId}&auth.token=${t}&auth.type=jwt`:`&auth.token=${t}&auth.type=jwt`:""},7848:(e,t,i)=>{i.d(t,{E:()=>n});var s=Object.defineProperty;class n{constructor(){var e;((e,t,i)=>{t in e?s(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(this,"symbol"!=typeof(e="listeners")?e+"":e,{})}emit(e,t){const i=this.listeners[e];i&&(this.listeners[e]=i.filter((e=>!e.once)),i.map((e=>e.fn(t))).map((e=>"function"==typeof e&&(null==e?void 0:e()))))}off(e,t){const i=this.listeners[e];i&&(this.listeners[e]=i.filter((e=>e.fn!==t)))}on(e,t){this.add(e,t,!1)}once(e,t){this.add(e,t,!0)}reset(){this.listeners={}}add(e,t,i){const s=this.listeners[e],n={fn:t,once:i};s?s.push(n):this.listeners[e]=[n]}}},4088:(e,t,i)=>{i.d(t,{F:()=>C,V:()=>ls,d:()=>me,n:()=>q});var s=i(7848),n=i(4896),r=Object.defineProperty,o=Object.defineProperties,a=Object.getOwnPropertyDescriptors,h=Object.getOwnPropertySymbols,d=Object.prototype.hasOwnProperty,c=Object.prototype.propertyIsEnumerable,u=e=>{throw TypeError(e)},l=(e,t,i)=>t in e?r(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,m=(e,t)=>{for(var i in t||(t={}))d.call(t,i)&&l(e,i,t[i]);if(h)for(var i of h(t))c.call(t,i)&&l(e,i,t[i]);return e},A=(e,t)=>o(e,a(t)),g=(e,t,i)=>l(e,"symbol"!=typeof t?t+"":t,i),p=(e,t,i)=>t.has(e)||u("Cannot "+i),f=(e,t,i)=>(p(e,t,"read from private field"),i?i.call(e):t.get(e)),v=(e,t,i)=>t.has(e)?u("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,i),w=(e,t,i,s)=>(p(e,t,"write to private field"),s?s.call(e,i):t.set(e,i),i),b=(e,t,i)=>(p(e,t,"access private method"),i),S=(e,t,i,s)=>({set _(s){w(e,t,s,i)},get _(){return f(e,t,s)}}),y=(e,t,i)=>new Promise(((s,n)=>{var r=e=>{try{a(i.next(e))}catch(e){n(e)}},o=e=>{try{a(i.throw(e))}catch(e){n(e)}},a=e=>e.done?s(e.value):Promise.resolve(e.value).then(r,o);a((i=i.apply(e,t)).next())}));class E{constructor(e){g(this,"maxSize",0),g(this,"size",0),g(this,"buffers",[]),g(this,"_borrowedBuffers",0),g(this,"get",(e=>{const t=this.buffers.shift();return this._borrowedBuffers++,this.size<e||!t?(this.buffers=[],this.size=e,new ArrayBuffer(e)):t})),g(this,"reclaim",(e=>{this._borrowedBuffers=Math.max(0,this._borrowedBuffers-1),!(e.byteLength<this.size)&&(this.buffers.length>=this.maxSize||this.buffers.push(e))})),this.maxSize=e}get bufferSize(){return this.size}get poolSize(){return this.buffers.length}get borrowedBuffers(){return this._borrowedBuffers}}class C{constructor(e=50){g(this,"maxSize"),g(this,"values",[]),g(this,"push",(e=>{this.isFull()&&this.pop(),this.values.push(e)})),g(this,"clear",(()=>{this.values=[]})),g(this,"pop",(()=>this.values.shift())),g(this,"peekFirst",(()=>this.values[0])),g(this,"peekLast",(()=>this.values[this.values.length-1])),g(this,"isFull",(()=>this.values.length>=this.maxSize)),g(this,"isEmpty",(()=>0===this.values.length)),g(this,"items",(()=>this.values)),g(this,"filterPop",(e=>{for(;this.peekFirst()&&!e(this.peekFirst());)this.pop()})),this.maxSize=e}}class T{constructor(e,t=0){g(this,"buffer"),g(this,"bytes"),g(this,"bitOffset"),g(this,"peekBit",(()=>this.getBit(this.bytes,this.bitOffset))),g(this,"readBit",(()=>{const e=this.peekBit();return this.bitOffset++,e})),g(this,"readBits",(e=>{let t=0;for(let i=0;i<e;i++)t=t<<1|(this.getBit(this.bytes,this.bitOffset++)?1:0);return t})),g(this,"readSignedExpGolomb",(()=>{const e=this.readUnsignedExpGolomb();return 1&e?(e+1)/2:-e/2})),g(this,"readUnsignedExpGolomb",(()=>{let e=0;for(;0===this.getBit(this.bytes,this.bitOffset++);)e++;let t=1<<e;for(let i=e-1;i>=0;i--)t|=this.getBit(this.bytes,this.bitOffset++)<<i;return t-1})),g(this,"getBit",((e,t)=>e[t>>3]>>7-(7&t)&1)),this.buffer=e,this.bytes=new Uint8Array(this.buffer),this.bitOffset=t}}function x(){const e=self.MediaSource,t=self.ManagedMediaSource;return null!=e?e:t}const k=new RegExp("(android|bbd+|meego).+mobile|avantgo|bada/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)/|plucker|pocket|psp|series(4|6)0|symbian|treo|up.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw-(n|u)|c55/|capi|ccwa|cdm-|cell|chtm|cldc|cmd-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc-s|devi|dica|dmob|do(c|p)o|ds(12|-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(-|_)|g1 u|g560|gene|gf-5|g-mo|go(.w|od)|gr(ad|un)|haie|hcit|hd-(m|p|t)|hei-|hi(pt|ta)|hp( i|ip)|hs-c|ht(c(-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i-(20|go|ma)|i230|iac( |-|/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |/)|klon|kpt |kwc-|kyo(c|k)|le(no|xi)|lg( g|/(k|l|u)|50|54|-[a-w])|libw|lynx|m1-w|m3ga|m50/|ma(te|ui|xo)|mc(01|21|ca)|m-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|-([1-8]|c))|phil|pire|pl(ay|uc)|pn-2|po(ck|rt|se)|prox|psio|pt-g|qa-a|qc(07|12|21|32|60|-[2-7]|i-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55/|sa(ge|ma|mm|ms|ny|va)|sc(01|h-|oo|p-)|sdk/|se(c(-|0|1)|47|mc|nd|ri)|sgh-|shar|sie(-|m)|sk-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h-|v-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl-|tdg-|tel(i|m)|tim-|t-mo|to(pl|sh)|ts(70|m-|m3|m5)|tx-9|up(.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas-|your|zeto|zte-/","i"),I=navigator.userAgent.toLowerCase(),B=k.test(I),R=()=>{const e=document.createElement("video");return""!==e.canPlayType("application/vnd.apple.mpegURL")||""!==e.canPlayType("audio/mpegurl")},P=()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){return!1}return!1},M=()=>"MacIntel"===navigator.platform&&0===navigator.maxTouchPoints,_=()=>"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1;function U(){var e,t;if(/(iPhone|iPod|iPad)/i.test(I))return null==(t=null==(e=null==I?void 0:I.match(/OS [\d_]+/i))?void 0:e[0])?void 0:t.substring(3).split("_").map((e=>parseInt(e)))[0]}class L{constructor(e=100,t=100){g(this,"resizeSteps"),g(this,"internalBuffer"),g(this,"view"),g(this,"uint8"),g(this,"_position",0),g(this,"_end",0),this.resizeSteps=t,this.internalBuffer=new ArrayBuffer(e),this.view=new DataView(this.internalBuffer),this.uint8=new Uint8Array(this.internalBuffer)}position(){return this._position}seek(e){this._position=Math.max(0,Math.min(this._end,e))}seekToEnd(){this._position=this._end}writeUint8(e){this.writeAndMove(e,1)}writeUint16(e){this.writeAndMove(e,2)}writeUint24(e){this.writeAndMove(e,3)}writeUint32(e){this.writeAndMove(e,4)}writeUint32At(e,t){this.view.setUint32(e,t)}writeBytes(e){this.resizeIfNeeded(this.position()+e.byteLength),this.uint8.set(e,this.position()),this._position+=e.byteLength,this._end=Math.max(this._end,this._position)}buffer(){return this.internalBuffer.slice(0,this._end)}write(e,t){switch(this.resizeIfNeeded(this.position()+t),t){case 1:this.view.setUint8(this.position(),e);break;case 2:this.view.setUint16(this.position(),e);break;case 3:this.view.setUint8(this.position(),e>>16&255),this.view.setUint8(this.position()+1,e>>8&255),this.view.setUint8(this.position()+2,255&e);break;case 4:this.view.setUint32(this.position(),e)}}writeAndMove(e,t){this.write(e,t),this._position+=t,this._end=Math.max(this._end,this._position)}resizeIfNeeded(e){if(e>this.internalBuffer.byteLength){const t=new ArrayBuffer(e+this.resizeSteps),i=new Uint8Array(t);i.set(this.uint8),this.internalBuffer=t,this.view=new DataView(this.internalBuffer),this.uint8=i}}}class D{constructor(e,t,i){g(this,"onSuccess"),g(this,"onError"),g(this,"doExecute"),this.doExecute=e,this.onSuccess=t,this.onError=i}execute(e){try{this.doExecute(e),this.onSuccess()}catch(e){this.onError(e)}}}const O=e=>e.reduce(((e,t)=>e+t),0)/e.length,F=e=>({last:e[e.length-1]||0,average:0===e.length?0:O(e),max:0===e.length?0:Math.max(...e),min:0===e.length?0:Math.min(...e)});class N{constructor(e=10){g(this,"rates"),g(this,"_total",0),g(this,"accumulatedValues",0),g(this,"lastTickTime",Date.now()),g(this,"add",(e=>{this.accumulatedValues+=e,this._total+=e})),g(this,"tick",(()=>{const e=this.accumulatedValues/((Date.now()-this.lastTickTime)/1e3);this.rates.push(e),this.accumulatedValues=0,this.lastTickTime=Date.now()})),this.rates=new C(e)}get total(){return this._total}get average(){return this.rates.isEmpty()?0:O(this.rates.items())}}const Q=(e,t)=>{if(e===t)return!0;if(null==e||"object"!=typeof e||null==t||"object"!=typeof t)return!1;let i=0,s=0;for(const t in e)i+=1;for(const i in t)if(s+=1,!(i in e)||!Q(e[i],t[i]))return!1;return i==s},V=["off","error","warn","info","debug","trace"];var z,G,W,X,H;const j=class e{constructor({context:e,logLevel:t,debug:i}){v(this,z,new Map),v(this,G,""),v(this,W,!1),v(this,X,"off"),g(this,"trace",((...e)=>{})),g(this,"debug",((...e)=>{})),g(this,"info",((...e)=>{})),g(this,"warn",((...e)=>{})),g(this,"error",((...e)=>{})),g(this,"table",((...e)=>{})),g(this,"count",((...e)=>{})),w(this,G,e),w(this,X,t),w(this,W,i||!1),this.setLevel(t),this.setDebug(f(this,W))}setDebug(e){w(this,W,e);for(const[t,i]of f(this,z))i.setDebug(e);e?(this.table=console.table.bind(console),this.count=console.count.bind(console)):(this.table=()=>{},this.count=()=>{})}setLevel(e){w(this,X,e);for(const[t,i]of f(this,z))i.setLevel(e);const t=V.indexOf(e);for(const[e,i]of V.entries())"off"!==i&&(this[i]=e<=t?console[i].bind(console,"%c%s %c%s","font-weight:bold;",i.toUpperCase(),"font-weight:normal;",f(this,G)):()=>{})}createContext(t){const i=f(this,z).get(t);if(!i){const i=new e({context:`${t}`,logLevel:f(this,X),debug:f(this,W)});return f(this,z).set(t,i),i}return i}static get(){return f(e,H)||w(e,H,new e({context:"Vindral",logLevel:"off"})),f(e,H)}};z=new WeakMap,G=new WeakMap,W=new WeakMap,X=new WeakMap,H=new WeakMap,v(j,H);let Z=j;const q=()=>{},J=(e,t)=>{const i=m({},e);return"object"!=typeof i||t.forEach((e=>{delete i[e]})),i},Y=(e,t=Date.now())=>{const i=e.length;if(i>0){const s=e[i-1];s.end||(s.end=t)}},$=(e,t=Date.now())=>{Y(e),e.push({start:t})},K=e=>e.reduce(((e,t)=>{var i;return e+((null!=(i=t.end)?i:Date.now())-t.start)}),0),ee=(e,t,i=Date.now())=>e.reduce(((e,s)=>{var n;const r=Math.max(i-t,s.start),o=null!=(n=s.end)?n:i;return Math.max(0,o-r)+e}),0),te=class{constructor(){g(this,"pendingTimeouts",new Set),g(this,"pendingIntervals",new Set),g(this,"clearTimeout",(e=>{this.pendingTimeouts.delete(e)&&window.clearTimeout(e)})),g(this,"clearInterval",(e=>{this.pendingIntervals.delete(e)&&window.clearInterval(e)})),g(this,"setTimeout",((e,t,...i)=>{const s=window.setTimeout((()=>{e(...i),this.clearTimeout(s)}),t);return this.pendingTimeouts.add(s),s})),g(this,"setInterval",((e,t,...i)=>{const s=window.setInterval((()=>{e(...i)}),t);return this.pendingIntervals.add(s),s})),g(this,"unload",(()=>{this.pendingIntervals.forEach(this.clearInterval),this.pendingTimeouts.forEach(this.clearTimeout)}))}};g(te,"create",(()=>new te));let ie=te;const se=()=>{const e=[...Array(256).keys()].map((e=>e.toString(16).padStart(2,"0"))),t=crypto.getRandomValues(new Uint8Array(16));return t[6]=15&t[6]|64,t[8]=63&t[8]|128,[...t.entries()].map((([t,i])=>[4,6,8,10].includes(t)?`-${e[i]}`:e[i])).join("")},ne=e=>y(void 0,null,(function*(){return new Promise((t=>setTimeout(t,e)))})),re=(e,...t)=>y(void 0,[e,...t],(function*(e,t=new Error("Timeout")){return new Promise(((i,s)=>setTimeout((()=>s(t)),e)))})),oe=e=>"width"in e&&"number"==typeof e.width,ae=e=>"sampleRate"in e&&"number"==typeof e.sampleRate,he=e=>{switch(e.codec){case"opus":return'audio/mp4; codecs="opus"';case"mp3":return"audio/mpeg";case"webvtt":return"text/vtt";case"aac":return e.codecString?`audio/mp4; codecs="${e.codecString}"`:"audio/mp4";case"h264":case"av1":return e.codecString?`video/mp4; codecs="${e.codecString}"`:"video/mp4"}},de=()=>Number.MAX_SAFE_INTEGER,ce=()=>({width:Number.MAX_SAFE_INTEGER,height:Number.MAX_SAFE_INTEGER}),ue=e=>!("object"!=typeof e||null===e||!("type"in e));class le extends Error{constructor(e,t,i={}){super(e),g(this,"props"),g(this,"extra",{}),g(this,"code",(()=>this.props.code)),g(this,"isFatal",(()=>this.props.isFatal)),g(this,"source",(()=>this.props.source)),g(this,"type",(()=>{var e;return null!=(e=this.props.type)?e:"external"})),g(this,"toStringifiable",(()=>{var e;const t=this.source(),i=t instanceof Error?t.stack:this.stack;return A(m({},this.extra),{code:this.props.code,isFatal:this.props.isFatal,type:this.props.type,message:this.message,sourceMessage:null==(e=this.source())?void 0:e.message,stack:i})})),this.props=t,this.extra=i,Object.setPrototypeOf(this,new.target.prototype)}}const me=(e,t)=>new le("Decoder Error",{isFatal:e,code:"decoder_error",source:t,type:"internal"}),Ae=(e,t)=>new le("Audio Player Error",{isFatal:e,code:"audio_player_error",source:t,type:"internal"}),ge=(e,t,i,s)=>new le("MediaSource Error",{isFatal:e,code:"media_source_error",source:t,type:"internal"},{type:s,consecutiveErrorsCount:i}),pe=(e,t)=>new le(`No track context for ${e}${t?`, rendition id ${t}`:""}`,{isFatal:!1,code:"no_track_context",type:"internal"}),fe=e=>new le("Disconnected From Edge Server",{type:"external",source:e,isFatal:!1,code:"disconnected_by_edge"}),ve=e=>new le("Authentication Failed",{isFatal:!0,code:"authentication_error",source:e}),we=(e,t)=>new le("Channel not found",{isFatal:!1,code:"channel_not_found",source:t,type:e}),be=e=>new le(e,{isFatal:!0,code:"access_forbidden"}),Se=(e,t=0)=>{for(let i=t;i<e.byteLength-4;i++){const t=1===e.getUint32(i),s=1==(e.getUint8(i)<<16|e.getUint16(i+1));if(t||s)return{position:i,nalPrefixSize:t?4:3}}},ye=e=>{const t=[],i=[];if(!(e=>0!==(e=>{const t=e.getUint32(0,!1);let i=0;return 1==(e.getUint8(0)<<16|e.getUint16(1,!1))?i+=3:1===t&&(i+=4),i})(new DataView(e,0)))(e)){const s=new DataView(e,0),n=31&s.getUint8(5);let r=6;for(let i=0;i<n;i++){const i=s.getUint16(r);t.push(e.slice(r+2,r+2+i)),r+=i+2}const o=s.getUint8(r);r+=1;for(let t=0;t<o;t++){const t=s.getUint16(r);i.push(e.slice(r+2,r+2+t)),r+=t+2}return{sequenceParameterSets:t,pictureParameterSets:i}}return((e,t)=>{const i=new DataView(e,0);let s=Se(i);for(;s;){const{position:n,nalPrefixSize:r}=s,o=Se(i,n+4),a=o?o.position-n-r:void 0;if(!t(new DataView(e,n+r,a)))return;s=o}})(e,(e=>{const s=e.byteOffset+e.byteLength;switch((e=>31&e)(e.getUint8(0))){case 8:i.push(e.buffer.slice(e.byteOffset,s));break;case 7:t.push(e.buffer.slice(e.byteOffset,s))}return!0})),{sequenceParameterSets:t,pictureParameterSets:i}},Ee=[{numerator:0,denumerator:0},{numerator:1,denumerator:1},{numerator:12,denumerator:11},{numerator:10,denumerator:11},{numerator:16,denumerator:11},{numerator:40,denumerator:33},{numerator:24,denumerator:11},{numerator:20,denumerator:11},{numerator:32,denumerator:11},{numerator:80,denumerator:33},{numerator:18,denumerator:11},{numerator:15,denumerator:11},{numerator:64,denumerator:33},{numerator:160,denumerator:99},{numerator:4,denumerator:3},{numerator:3,denumerator:2},{numerator:2,denumerator:1}];function Ce(e){const t=new ArrayBuffer(e.length),i=new Uint8Array(t);for(let t=0,s=e.length;t<s;t++)i[t]=e.charCodeAt(t);return new Uint8Array(t)}const Te={ftyp:Ce("ftyp"),mvhd:Ce("mvhd"),moov:Ce("moov"),trak:Ce("trak"),tkhd:Ce("tkhd"),mdia:Ce("mdia"),mdhd:Ce("mdhd"),hdlr:Ce("hdlr"),minf:Ce("minf"),vmhd:Ce("vmhd"),smhd:Ce("smhd"),dinf:Ce("dinf"),dref:Ce("dref"),stbl:Ce("stbl"),stsd:Ce("stsd"),avc1:Ce("avc1"),av01:Ce("av01"),av1C:Ce("av1C"),avcC:Ce("avcC"),esds:Ce("esds"),colr:Ce("colr"),nclx:Ce("nclx"),mvex:Ce("mvex"),trex:Ce("trex"),udta:Ce("udta"),meta:Ce("meta"),ilst:Ce("ilst"),moof:Ce("moof"),mfhd:Ce("mfhd"),traf:Ce("traf"),tfhd:Ce("tfhd"),tfdt:Ce("tfdt"),trun:Ce("trun"),mdat:Ce("mdat"),mp4a:Ce("mp4a"),Opus:Ce("Opus"),prft:Ce("prft"),dOps:Ce("dOps"),emsg:Ce("emsg")},xe=Ce("iso6"),ke=new Uint8Array([0,0,2,0]),Ie=[xe,new Uint8Array([105,115,111,109]),new Uint8Array([105,115,111,50]),new Uint8Array([97,118,99,49]),new Uint8Array([109,112,52,49])],Be=[xe,new Uint8Array([105,115,111,109]),new Uint8Array([105,115,111,50]),new Uint8Array([97,118,48,49]),new Uint8Array([109,112,52,49])],Re=[xe,new Uint8Array([105,115,111,109]),new Uint8Array([105,115,111,50]),new Uint8Array([109,112,52,49])];class Pe{constructor(){g(this,"writer",new L)}}const Me=(e,t,i)=>{e.writer.writeUint32(i+8),e.writer.writeBytes(t)},_e=(e,t,i,s,n)=>{Me(e,t,i+4),e.writer.writeUint8(s),e.writer.writeUint24(n)},Ue=(e,t)=>{Me(e,Te.ftyp,xe.byteLength+ke.byteLength+t.reduce(((e,t)=>e+t.byteLength),0)),e.writer.writeBytes(xe),e.writer.writeBytes(ke),t.forEach((t=>e.writer.writeBytes(t)))},Le=e=>"sequenceParameterSets"in e,De=e=>"sequenceHeader"in e,Oe=e=>"video"==e.type,Fe=e=>"audio"==e.type,Ne=(e,t,i)=>{let s=3;for(e.writer.writeUint8(t);s>0;s--)e.writer.writeUint8(i>>7*s|128);e.writer.writeUint8(127&i)},Qe=(e,t)=>{const i=e.writer.position();Me(e,Te.minf,0),Oe(t)?(_e(e,Te.vmhd,8,0,1),e.writer.writeUint32(0),e.writer.writeUint32(0)):Fe(t)&&(_e(e,Te.smhd,4,0,0),e.writer.writeUint16(0),e.writer.writeUint16(0)),(e=>{const t=e.writer.position();Me(e,Te.dinf,0),_e(e,Te.dref,16,0,0),e.writer.writeUint32(1),_e(e,Ce("url "),0,0,1),e.writer.writeUint32At(t,e.writer.position()-t)})(e),((e,t)=>{const i=e.writer.position();Me(e,Te.stbl,0);const s=e.writer.position();_e(e,Te.stsd,0,0,0),e.writer.writeUint32(1),Oe(t)?((e,t)=>{const i=e.writer.position(),s=De(t)?Te.av01:Te.avc1;Me(e,s,0),e.writer.writeUint32(0),e.writer.writeUint16(0),e.writer.writeUint16(1),e.writer.writeUint16(0),e.writer.writeUint16(0),e.writer.writeUint32(0),e.writer.writeUint32(0),e.writer.writeUint32(0),e.writer.writeUint16(t.width),e.writer.writeUint16(t.height),e.writer.writeUint32(4718592),e.writer.writeUint32(4718592),e.writer.writeUint32(0),e.writer.writeUint16(1),e.writer.writeUint8(0),e.writer.writeBytes(new Uint8Array(31)),e.writer.writeUint16(24),e.writer.writeUint16(-1),Le(t)?((e,t)=>{const i=e.writer.position();Me(e,Te.avcC,0),e.writer.writeUint8(1),e.writer.writeUint8(t.sequenceParameterSets[0][1]),e.writer.writeUint8(t.sequenceParameterSets[0][2]),e.writer.writeUint8(t.sequenceParameterSets[0][3]),e.writer.writeUint8(255),e.writer.writeUint8(224|t.sequenceParameterSets.length),t.sequenceParameterSets.forEach((t=>{e.writer.writeUint16(t.byteLength),e.writer.writeBytes(t)})),e.writer.writeUint8(t.pictureParameterSets.length),t.pictureParameterSets.forEach((t=>{e.writer.writeUint16(t.byteLength),e.writer.writeBytes(t)})),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t):De(t)&&(((e,t)=>{var i,s;const n=e.writer.position();Me(e,Te.av1C,0);const{seqProfile:r,operatingPoints:o,colorConfig:a}=t.parsedSequenceHeader,h=o[0];e.writer.writeUint8(129),e.writer.writeUint8(r<<5|(null!=(i=null==h?void 0:h.seqLevelIdx)?i:0)),e.writer.writeUint8((null!=(s=null==h?void 0:h.tier)?s:0)|(a.highBitDepth?1:0)|(12===a.bitDepth?1:0)<<5|(a.monoChrome?1:0)<<4|a.subsamplingX<<3|a.subsamplingY<<2|65535&a.chromaSamplePosition),e.writer.writeUint8(0),e.writer.writeBytes(t.sequenceHeader),e.writer.writeUint32At(n,e.writer.position()-n)})(e,t),t.parsedSequenceHeader.colorConfig&&(Me(e,Ce("colr"),11),e.writer.writeBytes(Te.nclx),e.writer.writeUint16(t.parsedSequenceHeader.colorConfig.colorPrimaries),e.writer.writeUint16(t.parsedSequenceHeader.colorConfig.transferCharacteristics),e.writer.writeUint16(t.parsedSequenceHeader.colorConfig.matrixCoefficients),e.writer.writeUint8(t.parsedSequenceHeader.colorConfig.colorRange?1:0))),t.pixelAspectRatio&&(Me(e,Ce("pasp"),8),e.writer.writeUint32(t.pixelAspectRatio.numerator),e.writer.writeUint32(t.pixelAspectRatio.denumerator)),t.bitrate&&(Me(e,Ce("btrt"),12),e.writer.writeUint32(0),e.writer.writeUint32(t.bitrate),e.writer.writeUint32(t.bitrate)),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t):Fe(t)&&((e,t)=>{const i=e.writer.position();switch(Me(e,Ce((e=>{switch(e){case"aac":case"mp3":return"mp4a";case"opus":return"Opus"}})(t.codec)),0),e.writer.writeUint32(0),e.writer.writeUint16(0),e.writer.writeUint16(1),e.writer.writeUint16(0),e.writer.writeUint16(0),e.writer.writeUint32(0),e.writer.writeUint16(t.channelCount),e.writer.writeUint16(16),e.writer.writeUint32(0),e.writer.writeUint16(t.sampleRate),e.writer.writeUint16(0),t.codec){case"aac":case"mp3":((e,t)=>{const i=t.decoderConfig.byteLength>0?t.decoderConfig.byteLength+5:0,s=e.writer.position();_e(e,Te.esds,0,0,0),Ne(e,3,21+i+5+1),e.writer.writeUint16(t.trackId),e.writer.writeUint8(0),Ne(e,4,13+i);const n="mp3"===t.codec&&t.sampleRate>24e3?107:64;e.writer.writeUint8(n),e.writer.writeUint8(21),e.writer.writeUint24(0),e.writer.writeUint32(t.bitrate||0),e.writer.writeUint32(t.bitrate||0),t.decoderConfig.byteLength>0&&(Ne(e,5,t.decoderConfig.byteLength),e.writer.writeBytes(t.decoderConfig)),Ne(e,6,1),e.writer.writeUint8(2),e.writer.writeUint32At(s,e.writer.position()-s)})(e,t);break;case"opus":((e,t)=>{const i=e.writer.position();Me(e,Ce("dOps"),0),e.writer.writeUint8(0);const s=t.decoderConfig,n=new DataView(s.buffer,s.byteOffset,s.byteLength);e.writer.writeUint8(n.getUint8(9)),e.writer.writeUint16(n.getUint16(10,!0)),e.writer.writeUint32(n.getUint32(12,!0)),e.writer.writeUint16(n.getUint16(16,!0)),e.writer.writeBytes(t.decoderConfig.slice(18)),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t)}t.bitrate&&(Me(e,Ce("btrt"),12),e.writer.writeUint32(0),e.writer.writeUint32(t.bitrate),e.writer.writeUint32(t.bitrate)),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t),e.writer.writeUint32At(s,e.writer.position()-s),_e(e,Ce("stts"),4,0,0),e.writer.writeUint32(0),_e(e,Ce("stsc"),4,0,0),e.writer.writeUint32(0),_e(e,Ce("stsz"),8,0,0),e.writer.writeUint32(0),e.writer.writeUint32(0),_e(e,Ce("stco"),4,0,0),e.writer.writeUint32(0),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t),e.writer.writeUint32At(i,e.writer.position()-i)},Ve=(e,t,i)=>{const s=e.writer.position();Me(e,Te.trak,0),((e,t,i)=>{const s=e.writer.position();_e(e,Te.tkhd,0,0,3),e.writer.writeUint32(0),e.writer.writeUint32(0),e.writer.writeUint32(t.trackId),e.writer.writeUint32(0),e.writer.writeUint32(t.duration*i/t.timescale),e.writer.writeUint32(0),e.writer.writeUint32(0),e.writer.writeUint16(0),e.writer.writeUint16(Fe(t)?1:0),e.writer.writeUint16(Fe(t)?256:0),e.writer.writeUint16(0),e.writer.writeBytes(new Uint8Array([0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0])),Oe(t)?(e.writer.writeUint32(65536*t.width),e.writer.writeUint32(65536*t.height)):Fe(t)&&(e.writer.writeUint32(0),e.writer.writeUint32(0)),e.writer.writeUint32At(s,e.writer.position()-s)})(e,t,i),((e,t)=>{const i=e.writer.position();Me(e,Te.mdia,0),((e,t)=>{_e(e,Te.mdhd,20,0,0),e.writer.writeUint32(0),e.writer.writeUint32(0),e.writer.writeUint32(t.timescale),e.writer.writeUint32(t.duration);const i=t.lang||"und",s=(31&i.charCodeAt(0))<<10|(31&i.charCodeAt(1))<<5|31&i.charCodeAt(2);e.writer.writeUint16(s),e.writer.writeUint16(0)})(e,t),((e,t)=>{const i=e.writer.position();_e(e,Te.hdlr,0,0,0),e.writer.writeUint32(0),e.writer.writeBytes(Ce(Oe(t)?"vide":"soun")),e.writer.writeUint32(0),e.writer.writeUint32(0),e.writer.writeUint32(0),e.writer.writeBytes(Ce(Oe(t)?"VideoHandler\0":"SoundHandler\0")),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t),Qe(e,t),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t),e.writer.writeUint32At(s,e.writer.position()-s)},ze=(e,t,i,s)=>{const n=e.writer.position();Me(e,Te.moov,0),((e,t,i)=>{_e(e,Te.mvhd,96,0,0),e.writer.writeUint32(0),e.writer.writeUint32(0),e.writer.writeUint32(i),e.writer.writeUint32(0),e.writer.writeUint32(65536),e.writer.writeUint16(256),e.writer.writeBytes(new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0])),e.writer.writeUint32(2)})(e,0,i),t.forEach((t=>Ve(e,t,i))),((e,t)=>{const i=e.writer.position();Me(e,Te.mvex,0),t.forEach((t=>((e,t)=>{_e(e,Te.trex,20,0,0),e.writer.writeUint32(t.trackId),e.writer.writeUint32(1),e.writer.writeUint32(0),e.writer.writeUint32(0),e.writer.writeUint32(0)})(e,t))),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t),e.writer.writeUint32At(n,e.writer.position()-n)},Ge=e=>e.isSync?33554432:16842752,We=(e,t)=>{const i=e.writer.position();Me(e,Te.moof,0),((e,t)=>{_e(e,Te.mfhd,4,0,0),e.writer.writeUint32(t)})(e,t.sequenceNumber),((e,t)=>{const i=e.writer.position();Me(e,Te.traf,0),((e,t)=>{const i=e.writer.position();_e(e,Te.tfhd,16,0,56),e.writer.writeUint32(t.trackId),e.writer.writeUint32(t.defaultDuration||0),e.writer.writeUint32(t.defaultSize||0),e.writer.writeUint32(t.defaultFlags||0),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t),((e,t)=>{const i=e.writer.position();_e(e,Te.tfdt,8,1,0);const s=Math.floor(t.timestamp/4294967296),n=(4294967295&t.timestamp)>>>0;e.writer.writeUint32(s),e.writer.writeUint32(n),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t),((e,t)=>{const i=t.samples.some((e=>!!e.compositionTimeOffset)),s=Ge(t.samples[0])!==t.defaultFlags;let n=1;s&&(n|=4),i&&(n|=2048);const r=e.writer.position();_e(e,Te.trun,16,1,n),e.writer.writeUint32(t.samples.length);const o=e.writer.position();e.writer.writeUint32(0),s&&e.writer.writeUint32(Ge(t.samples[0])),i&&t.samples.forEach((t=>e.writer.writeUint32(t.compositionTimeOffset||0))),e.writer.writeUint32At(o,e.writer.position()+8),e.writer.writeUint32At(r,e.writer.position()-r)})(e,t),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t),e.writer.writeUint32At(i,e.writer.position()-i)},Xe=(e,t)=>{const i=new Pe,s=e.filter((e=>Oe(e)&&Le(e))).length>0;return e.filter((e=>Oe(e)&&De(e))).length>0?Ue(i,Be):Ue(i,s?Ie:Re),ze(i,e,1e3),i.writer.buffer()},He=e=>{const t=new Pe;if(1!==e.samples.length)throw new Error("Only one sample is supported");return We(t,e),((e,t)=>{Me(e,Te.mdat,t.samples[0].data.length),e.writer.writeBytes(t.samples[0].data)})(t,e),t.writer.buffer()},je=e=>{const{sequenceParameterSets:t,pictureParameterSets:i}=ye(e),s=t[0],n=i[0];if(!s||!n)throw new Error("No sps or pps provided");return(e=>{var t;const i=new DataView(e),s=i.getUint8(1),n=i.getUint8(2),r=i.getUint8(3),o=new T(e,32);o.readUnsignedExpGolomb();let a=1;switch(s){case 100:case 110:case 122:case 244:case 44:case 83:case 86:case 118:case 128:case 138:case 144:if(a=o.readUnsignedExpGolomb(),3===a&&o.readBits(1),o.readUnsignedExpGolomb(),o.readUnsignedExpGolomb(),o.readBit(),o.readBit())for(let e=0;e<(3!=a?8:12);e++)if(o.readBit()){const t=e<6?16:64;let i=0,s=8,n=8;for(let e=0;e<t;e++)0!=n&&(i=o.readSignedExpGolomb(),n=(s+i+256)%256),s=0==n?s:n}}o.readUnsignedExpGolomb();const h=o.readUnsignedExpGolomb();if(0==h)o.readUnsignedExpGolomb();else if(1==h)throw new Error("Unhandled case");o.readUnsignedExpGolomb(),o.readBit();const d=o.readUnsignedExpGolomb(),c=o.readUnsignedExpGolomb(),u=o.readBit();0===u&&o.readBit(),o.readBit();let l=d+1,m=c+1;if(m*=2-u,m*=16,l*=16,o.readBit()){const e=1<<(1==a||2==a?1:0),t=2-u<<(1==a?1:0);l-=o.readUnsignedExpGolomb()*e+o.readUnsignedExpGolomb()*e,m-=o.readUnsignedExpGolomb()*t+o.readUnsignedExpGolomb()*t}let A={numerator:1,denumerator:1};return o.readBit()&&o.readBit()&&(A=null!=(t=Ee[o.readBits(8)])?t:{numerator:0,denumerator:0}),{width:l,height:m,pixelAspectRatio:A,profileIdc:s,constraintFlags:n,levelIdc:r}})(s)},Ze=e=>{const t=new T(e);return 1===t.peekBit()&&t.readBits(32),qe(t),Je(t)},qe=e=>{const t=e.readBits(8);if(t>>7&1)return;const i=t>>3&15,s=t>>2&1,n=t>>1&1;return 1==s&&e.readBits(8),1==n&&(e=>{let t=0;for(let i=0;i<8;i++){const s=e.readBits(8);if(t|=(127&s)<<7*i,128&~s)break}})(e),{headerLength:1+s,type:i}},Je=e=>{const t=e.readBits(3),i=0!==e.readBit(),s=0!==e.readBit();let n,r=!1,o=!1,a=!1,h=0,d=0;const c=[];if(s)e.readBits(5);else{if(o=0!==e.readBit(),o&&(n=(e=>{const t=e.readBits(32),i=e.readBits(32),s=0!==e.readBit();let n=0;return s&&(n=(e=>{let t=0;for(;t<100&&0===e.readBit();)t++;return t>=32?0:e.readBits(t)+(1<<t)-1})(e)+1),{timescale:i,equalPictureInterval:s,numUnitsInDisplayTick:t,numTicksPerPicture:n}})(e),r=0!==e.readBit(),r))throw new Error("Not implemented");a=0!==e.readBit();const t=e.readBits(5)+1;for(let i=0;i<t;i++){const t=e.readBits(12),i=e.readBits(5);let s=0;if(i>7&&(s=e.readBit()),r)throw new Error("decoderModelInfoPresentFlag==1");a&&0!==e.readBit()&&e.readBits(4),c.push({tier:s,operatingPointIdc:t,seqLevelIdx:i})}}const u=e.readBits(4)+1,l=e.readBits(4)+1,m=e.readBits(u)+1,A=e.readBits(l)+1;let g=!1;g=!s&&0!==e.readBit(),g&&(h=e.readBits(4)+2,d=e.readBits(3)+1);const p=0!==e.readBit(),f=0!==e.readBit(),v=0!==e.readBit();let w=!1,b=!1,S=!1,y=!1,E=!1,C=!1,T=!1,x=2,k=2,I=0;return s||(w=0!==e.readBit(),b=0!==e.readBit(),S=0!==e.readBit(),y=0!==e.readBit(),E=0!==e.readBit(),E&&(C=0!==e.readBit(),T=0!==e.readBit()),x=0!==e.readBit()?2:e.readBit(),k=x>0?e.readBit()>0?2:e.readBit():2,I=E?e.readBits(3):0),{seqProfile:t,stillPicture:i,reducedStillPictureHeader:s,timingInfoPresentFlag:o,timingInfo:null!=n?n:{equalPictureInterval:!1,numUnitsInDisplayTick:0,timescale:0,numTicksPerPicture:0},decoderModelInfoPresentFlag:r,initialDisplayDelayPresentFlag:a,operatingPoints:c,frameWidthBits:u,frameHeightBits:l,maxFrameWidth:m,maxFrameHeight:A,frameIdNumbersPresentFlag:g,deltaFrameIdLength:h,additionalFrameIdLength:d,use_128x128Superblock:p,enableFilterIntra:f,enableIntraEdgeFilter:v,enableInterintraCompound:w,enableMaskedCompound:b,enableWarpedMotion:S,enableDualFilter:y,enableOrderHint:E,enableJntComp:C,enableRefFrameMvs:T,seqForceScreenContentTools:x,seqForceIntegerMv:k,orderHintBits:I,enableSuperres:0!==e.readBit(),enableCdef:0!==e.readBit(),enableRestoration:0!==e.readBit(),colorConfig:Ye(e,t),filmGrainParamsPresent:0!==e.readBit()}},Ye=(e,t)=>{const i=0!==e.readBit();let s=8,n=!1;2===t&&i?s=0!==e.readBit()?12:10:t<=2&&(s=i?10:8),n=1!==t&&0!==e.readBit();const r=n?1:3;let o=2,a=2,h=2,d=!1,c=0,u=0,l=0,m=!1;return 0!==e.readBit()&&(o=e.readBits(8),a=e.readBits(8),h=e.readBits(8)),n?(d=0!==e.readBit(),c=1,u=1,l=0,m=!1,{highBitDepth:i,bitDepth:s,monoChrome:n,chromaSamplePosition:l,colorPrimaries:o,colorRange:d,matrixCoefficients:h,numPlanes:r,separateUvDeltaQ:m,subsamplingX:c,subsamplingY:u,transferCharacteristics:a}):1===o&&13==a&&0==h?(d=!0,c=0,u=0,{highBitDepth:i,bitDepth:s,monoChrome:n,chromaSamplePosition:l,colorPrimaries:o,colorRange:d,matrixCoefficients:h,numPlanes:r,separateUvDeltaQ:m,subsamplingX:c,subsamplingY:u,transferCharacteristics:a}):(d=0!==e.readBit(),0===t?(c=1,u=1):1===t?(c=0,u=0):12===s?(c=e.readBit(),u=0!==c?e.readBit():0):(c=1,u=0),0!==c&&0!==u&&(l=e.readBits(2)),m=0!==e.readBit(),{highBitDepth:i,bitDepth:s,monoChrome:n,chromaSamplePosition:l,colorPrimaries:o,colorRange:d,matrixCoefficients:h,numPlanes:r,separateUvDeltaQ:m,subsamplingX:c,subsamplingY:u,transferCharacteristics:a})},$e=e=>!!(1&e),Ke=()=>"wakeLock"in navigator&&-1===window.navigator.userAgent.indexOf("Samsung");class et{constructor(){g(this,"enabled",!1),g(this,"wakeLockVideo"),g(this,"_wakeLock",null),g(this,"handleVisibilityChange",(()=>{null!==this._wakeLock&&"visible"===document.visibilityState&&this.enable()})),Ke()&&(this._wakeLock=null,document.addEventListener("visibilitychange",this.handleVisibilityChange),document.addEventListener("fullscreenchange",this.handleVisibilityChange))}_addSourceToVideo(e,t,i){const s=document.createElement("source");s.src=i,s.type=`video/${t}`,e.appendChild(s)}get isEnabled(){return this.enabled}attach(e){if(!Ke()){if(!this.wakeLockVideo){const e=document.createElement("video");this.wakeLockVideo=e,this.wakeLockVideo.setAttribute("title","Live Stream"),this.wakeLockVideo.setAttribute("playsinline",""),this._addSourceToVideo(this.wakeLockVideo,"mp4","data:video/mp4;base64,AAAAHGZ0eXBNNFYgAAACAGlzb21pc28yYXZjMQAAAAhmcmVlAAAGF21kYXTeBAAAbGliZmFhYyAxLjI4AABCAJMgBDIARwAAArEGBf//rdxF6b3m2Ui3lizYINkj7u94MjY0IC0gY29yZSAxNDIgcjIgOTU2YzhkOCAtIEguMjY0L01QRUctNCBBVkMgY29kZWMgLSBDb3B5bGVmdCAyMDAzLTIwMTQgLSBodHRwOi8vd3d3LnZpZGVvbGFuLm9yZy94MjY0Lmh0bWwgLSBvcHRpb25zOiBjYWJhYz0wIHJlZj0zIGRlYmxvY2s9MTowOjAgYW5hbHlzZT0weDE6MHgxMTEgbWU9aGV4IHN1Ym1lPTcgcHN5PTEgcHN5X3JkPTEuMDA6MC4wMCBtaXhlZF9yZWY9MSBtZV9yYW5nZT0xNiBjaHJvbWFfbWU9MSB0cmVsbGlzPTEgOHg4ZGN0PTAgY3FtPTAgZGVhZHpvbmU9MjEsMTEgZmFzdF9wc2tpcD0xIGNocm9tYV9xcF9vZmZzZXQ9LTIgdGhyZWFkcz02IGxvb2thaGVhZF90aHJlYWRzPTEgc2xpY2VkX3RocmVhZHM9MCBucj0wIGRlY2ltYXRlPTEgaW50ZXJsYWNlZD0wIGJsdXJheV9jb21wYXQ9MCBjb25zdHJhaW5lZF9pbnRyYT0wIGJmcmFtZXM9MCB3ZWlnaHRwPTAga2V5aW50PTI1MCBrZXlpbnRfbWluPTI1IHNjZW5lY3V0PTQwIGludHJhX3JlZnJlc2g9MCByY19sb29rYWhlYWQ9NDAgcmM9Y3JmIG1idHJlZT0xIGNyZj0yMy4wIHFjb21wPTAuNjAgcXBtaW49MCBxcG1heD02OSBxcHN0ZXA9NCB2YnZfbWF4cmF0ZT03NjggdmJ2X2J1ZnNpemU9MzAwMCBjcmZfbWF4PTAuMCBuYWxfaHJkPW5vbmUgZmlsbGVyPTAgaXBfcmF0aW89MS40MCBhcT0xOjEuMDAAgAAAAFZliIQL8mKAAKvMnJycnJycnJycnXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXiEASZACGQAjgCEASZACGQAjgAAAAAdBmjgX4GSAIQBJkAIZACOAAAAAB0GaVAX4GSAhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZpgL8DJIQBJkAIZACOAIQBJkAIZACOAAAAABkGagC/AySEASZACGQAjgAAAAAZBmqAvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZrAL8DJIQBJkAIZACOAAAAABkGa4C/AySEASZACGQAjgCEASZACGQAjgAAAAAZBmwAvwMkhAEmQAhkAI4AAAAAGQZsgL8DJIQBJkAIZACOAIQBJkAIZACOAAAAABkGbQC/AySEASZACGQAjgCEASZACGQAjgAAAAAZBm2AvwMkhAEmQAhkAI4AAAAAGQZuAL8DJIQBJkAIZACOAIQBJkAIZACOAAAAABkGboC/AySEASZACGQAjgAAAAAZBm8AvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZvgL8DJIQBJkAIZACOAAAAABkGaAC/AySEASZACGQAjgCEASZACGQAjgAAAAAZBmiAvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZpAL8DJIQBJkAIZACOAAAAABkGaYC/AySEASZACGQAjgCEASZACGQAjgAAAAAZBmoAvwMkhAEmQAhkAI4AAAAAGQZqgL8DJIQBJkAIZACOAIQBJkAIZACOAAAAABkGawC/AySEASZACGQAjgAAAAAZBmuAvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZsAL8DJIQBJkAIZACOAAAAABkGbIC/AySEASZACGQAjgCEASZACGQAjgAAAAAZBm0AvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZtgL8DJIQBJkAIZACOAAAAABkGbgCvAySEASZACGQAjgCEASZACGQAjgAAAAAZBm6AnwMkhAEmQAhkAI4AhAEmQAhkAI4AhAEmQAhkAI4AhAEmQAhkAI4AAAAhubW9vdgAAAGxtdmhkAAAAAAAAAAAAAAAAAAAD6AAABDcAAQAAAQAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAwAAAzB0cmFrAAAAXHRraGQAAAADAAAAAAAAAAAAAAABAAAAAAAAA+kAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAALAAAACQAAAAAAAkZWR0cwAAABxlbHN0AAAAAAAAAAEAAAPpAAAAAAABAAAAAAKobWRpYQAAACBtZGhkAAAAAAAAAAAAAAAAAAB1MAAAdU5VxAAAAAAALWhkbHIAAAAAAAAAAHZpZGUAAAAAAAAAAAAAAABWaWRlb0hhbmRsZXIAAAACU21pbmYAAAAUdm1oZAAAAAEAAAAAAAAAAAAAACRkaW5mAAAAHGRyZWYAAAAAAAAAAQAAAAx1cmwgAAAAAQAAAhNzdGJsAAAAr3N0c2QAAAAAAAAAAQAAAJ9hdmMxAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAALAAkABIAAAASAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGP//AAAALWF2Y0MBQsAN/+EAFWdCwA3ZAsTsBEAAAPpAADqYA8UKkgEABWjLg8sgAAAAHHV1aWRraEDyXyRPxbo5pRvPAyPzAAAAAAAAABhzdHRzAAAAAAAAAAEAAAAeAAAD6QAAABRzdHNzAAAAAAAAAAEAAAABAAAAHHN0c2MAAAAAAAAAAQAAAAEAAAABAAAAAQAAAIxzdHN6AAAAAAAAAAAAAAAeAAADDwAAAAsAAAALAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAAiHN0Y28AAAAAAAAAHgAAAEYAAANnAAADewAAA5gAAAO0AAADxwAAA+MAAAP2AAAEEgAABCUAAARBAAAEXQAABHAAAASMAAAEnwAABLsAAATOAAAE6gAABQYAAAUZAAAFNQAABUgAAAVkAAAFdwAABZMAAAWmAAAFwgAABd4AAAXxAAAGDQAABGh0cmFrAAAAXHRraGQAAAADAAAAAAAAAAAAAAACAAAAAAAABDcAAAAAAAAAAAAAAAEBAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAkZWR0cwAAABxlbHN0AAAAAAAAAAEAAAQkAAADcAABAAAAAAPgbWRpYQAAACBtZGhkAAAAAAAAAAAAAAAAAAC7gAAAykBVxAAAAAAALWhkbHIAAAAAAAAAAHNvdW4AAAAAAAAAAAAAAABTb3VuZEhhbmRsZXIAAAADi21pbmYAAAAQc21oZAAAAAAAAAAAAAAAJGRpbmYAAAAcZHJlZgAAAAAAAAABAAAADHVybCAAAAABAAADT3N0YmwAAABnc3RzZAAAAAAAAAABAAAAV21wNGEAAAAAAAAAAQAAAAAAAAAAAAIAEAAAAAC7gAAAAAAAM2VzZHMAAAAAA4CAgCIAAgAEgICAFEAVBbjYAAu4AAAADcoFgICAAhGQBoCAgAECAAAAIHN0dHMAAAAAAAAAAgAAADIAAAQAAAAAAQAAAkAAAAFUc3RzYwAAAAAAAAAbAAAAAQAAAAEAAAABAAAAAgAAAAIAAAABAAAAAwAAAAEAAAABAAAABAAAAAIAAAABAAAABgAAAAEAAAABAAAABwAAAAIAAAABAAAACAAAAAEAAAABAAAACQAAAAIAAAABAAAACgAAAAEAAAABAAAACwAAAAIAAAABAAAADQAAAAEAAAABAAAADgAAAAIAAAABAAAADwAAAAEAAAABAAAAEAAAAAIAAAABAAAAEQAAAAEAAAABAAAAEgAAAAIAAAABAAAAFAAAAAEAAAABAAAAFQAAAAIAAAABAAAAFgAAAAEAAAABAAAAFwAAAAIAAAABAAAAGAAAAAEAAAABAAAAGQAAAAIAAAABAAAAGgAAAAEAAAABAAAAGwAAAAIAAAABAAAAHQAAAAEAAAABAAAAHgAAAAIAAAABAAAAHwAAAAQAAAABAAAA4HN0c3oAAAAAAAAAAAAAADMAAAAaAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAACMc3RjbwAAAAAAAAAfAAAALAAAA1UAAANyAAADhgAAA6IAAAO+AAAD0QAAA+0AAAQAAAAEHAAABC8AAARLAAAEZwAABHoAAASWAAAEqQAABMUAAATYAAAE9AAABRAAAAUjAAAFPwAABVIAAAVuAAAFgQAABZ0AAAWwAAAFzAAABegAAAX7AAAGFwAAAGJ1ZHRhAAAAWm1ldGEAAAAAAAAAIWhkbHIAAAAAAAAAAG1kaXJhcHBsAAAAAAAAAAAAAAAALWlsc3QAAAAlqXRvbwAAAB1kYXRhAAAAAQAAAABMYXZmNTUuMzMuMTAw"),Object.assign(this.wakeLockVideo.style,{position:"absolute",left:"-100%",top:"-100%"}),this.wakeLockVideo.addEventListener("loadedmetadata",(()=>{e.addEventListener("timeupdate",(()=>{e.currentTime>.5&&(e.currentTime=Math.random())}))}))}e&&e.appendChild(this.wakeLockVideo)}}enable(){return y(this,null,(function*(){var e,t;return Ke()?navigator.wakeLock.request("screen").then((e=>{this._wakeLock=e,this.enabled=!0,this._wakeLock.addEventListener("release",(()=>{}))})).catch((()=>{this.enabled=!1})):(null!=(t=null==(e=this.wakeLockVideo)?void 0:e.play())?t:Promise.resolve()).then((e=>(this.enabled=!0,e))).catch((()=>{this.enabled=!1}))}))}disable(){var e,t;Ke()?(this._wakeLock&&this._wakeLock.release(),this._wakeLock=null):(null==(e=this.wakeLockVideo)||e.pause(),null==(t=this.wakeLockVideo)||t.remove()),this.enabled=!1}unload(){document.removeEventListener("visibilitychange",this.handleVisibilityChange),document.removeEventListener("fullscreenchange",this.handleVisibilityChange),this.disable()}}const tt=/\r\n|\r|\n/;var it,st,nt,rt,ot;class at{constructor(e){v(this,it),v(this,st),w(this,it,e),w(this,st,0)}skipEmptyLines(){let e=0;for(;""===f(this,it)[f(this,st)];)S(this,st)._++,e++;return e}readLine(){return f(this,it)[S(this,st)._++]}takeUntilEmptyLine(){const e=[];for(;""!==f(this,it)[f(this,st)];){const t=this.readLine();if(void 0===t)break;e.push(t)}return e}linesLeft(){return f(this,it).length-f(this,st)}}it=new WeakMap,st=new WeakMap;class ht{constructor(){v(this,nt)}parse(e){const t=[],i=e.split(tt),s=new at(i),n=s.readLine();if(!n||!n.startsWith("WEBVTT"))throw new Error("missing 'WEBVTT' signature");for(;""!==s.readLine(););for(;s.linesLeft()>0;){const e=b(this,nt,rt).call(this,s);t.push(e),s.skipEmptyLines()}return t}}nt=new WeakSet,rt=function(e){e.skipEmptyLines();const t=e.takeUntilEmptyLine(),i=new at(t);let s,n=i.readLine();if(null!=n&&n.includes("--\x3e")||(s=n,n=i.readLine()),void 0===n)throw new Error("expected cue line");const[r,o]=n.split("--\x3e").map((e=>e.trim()));if(!r||!o)throw new Error(`a cue needs both start and end time start: ${r} end: ${o}`);const[a,h]=o.split(" ",1).map((e=>e.trim()));if(!a)throw new Error(`missing end time: ${a}`);const d=i.readLine();if(!d)throw new Error("missing text");return{id:s,startTime:b(this,nt,ot).call(this,r),endTime:b(this,nt,ot).call(this,a),text:d}},ot=function(e){const t=e.split(":");if(2==t.length){const[e=0,i=0]=t.map((e=>parseFloat(e)));return 60*e+i}const[i=0,s=0,n=0]=t.map((e=>parseFloat(e)));return 60*i*60+60*s+n};class dt extends s.E{constructor({type:e,autoplay:t,muted:i,logger:s,poster:n}){super(),g(this,"element"),g(this,"logger"),g(this,"seekTimes",new C(10)),g(this,"seekStartTime"),g(this,"_userProvidedMuted"),g(this,"timers",new ie),g(this,"_userHasProvidedInput",!1),g(this,"_isPaused",!0),g(this,"isActivated",!1),g(this,"dummy"),g(this,"_iosHackEnterPiPMode",(()=>{const e=this.element.parentElement,t=this.element.clientWidth/this.element.clientHeight;this.element.style.position="fixed",this.element.style.opacity="0",this.element.style.pointerEvents="none",e&&(this.dummy=document.createElement("video"),this.dummy.style.paddingBottom="calc(100% / "+t+")",this.dummy.style.width="100%",this.dummy.style.height="0px",e.appendChild(this.dummy))})),g(this,"_iosHackExitPiPMode",(()=>{this.element.style.position="relative",this.element.style.opacity="1",this.element.style.pointerEvents="auto",this.dummy&&(this.dummy.remove(),this.dummy=void 0)})),g(this,"attach",(e=>{this.element.remove(),e.appendChild(this.element)})),g(this,"load",(()=>{this.timers.setInterval(this.onPlayPause,500),this.timers.setTimeout((()=>{this.timers.setInterval(this.onBufferStateChange,500)}),1e4)})),g(this,"unload",(()=>{this.timers.unload()})),g(this,"getPlaybackRate",(()=>this.element.playbackRate)),g(this,"getPlaybackState",(()=>this.element.readyState>=this.element.HAVE_FUTURE_DATA?"playing":"buffering")),g(this,"setPlaybackRate",(e=>{this.element.playbackRate=e})),g(this,"getBuffer",(()=>{const e=[],t=this.element.buffered;if(!t)return[];for(let i=0;i<t.length;i++)e.push({start:1e3*t.start(i),end:1e3*t.end(i)});return e})),g(this,"pause",(()=>{this._isPaused=!1,this.element.pause()})),g(this,"tryPlay",(()=>{this.element.muted=this._userProvidedMuted,this._play().catch(q)})),g(this,"play",(()=>{this.element.muted=this._userProvidedMuted,this._play().catch((e=>{if(e instanceof Error){const t=new le("Media Play Error",{source:e,isFatal:!1,code:"media_play_error"});this.emit("error",t)}}))})),g(this,"_play",(()=>y(this,null,(function*(){try{yield this.element.play(),this._userHasProvidedInput=!this.muted||this._userProvidedMuted}catch(e){if(!(e instanceof Error&&"NotAllowedError"===e.name))throw e;if(this._userHasProvidedInput=!1,!this.element.muted)return this.element.muted=!0,this.emit("needs user input",{forAudio:!0,forVideo:!1}),this._play();this.emit("needs user input",{forAudio:!0,forVideo:!0})}})))),g(this,"onEvent",(e=>{this.logger.trace(e.type,{state:this.element.readyState,event:e,playbackState:this.getPlaybackState()})})),g(this,"onVolumeChange",(()=>{this.logger.info("volume state",{isMuted:this.element.muted,volume:this.element.volume}),this.emit("volume state",{isMuted:this.element.muted,volume:this.element.volume})})),g(this,"onPlayPause",(()=>{this._isPaused!==this.element.paused&&(this._isPaused=this.element.paused,this.logger.info("player pause change",{paused:this.element.paused}),this.emit("media element state",this.element.paused?"paused":"playing"))})),g(this,"onBufferStateChange",(()=>{this.emit("buffer state",{isPaused:this.element.paused,buffered:this.getBuffer(),currentTime:this.currentTime,playbackState:this.getPlaybackState()})})),g(this,"onSeekStart",(()=>{this.seekStartTime=Date.now()})),g(this,"onSeekEnd",(()=>{this.seekStartTime&&(this.seekTimes.push(Date.now()-this.seekStartTime),this.seekStartTime=void 0)})),this.logger=s,this._userProvidedMuted=i,this.element=document.createElement(e),this.element instanceof HTMLVideoElement&&(this.element.playsInline=!0),this.element.controls=!1,this.element.autoplay=t,this.element.muted=i,this.element.style.display="block",this.element.style.width="100%",this.element.disableRemotePlayback=!0,this.element.setAttribute("poster","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAJCAQAAACRI2S5AAAAEElEQVR42mNkIAAYRxWAAQAG9gAKqv6+AwAAAABJRU5ErkJggg=="),this.onPlayPause(),setTimeout((()=>{!this.element||!n||this.element.setAttribute("poster",n)}),0),this.element.addEventListener("stalled",this.onEvent),this.element.addEventListener("canplay",this.onEvent),this.element.addEventListener("loadeddata",this.onEvent),this.element.addEventListener("loadedmetadata",this.onEvent),this.element.addEventListener("canplaythrough",this.onEvent),this.element.addEventListener("waiting",this.onEvent),this.element.addEventListener("playing",this.onPlayPause),this.element.addEventListener("pause",this.onPlayPause),this.element.addEventListener("seeked",this.onSeekEnd),this.element.addEventListener("seeking",this.onSeekStart),this.element.addEventListener("volumechange",this.onVolumeChange),this.element.addEventListener("timeupdate",this.onBufferStateChange),this.element.addEventListener("progress",this.onBufferStateChange)}get seekTime(){return this.seekTimes.isEmpty()?0:O(this.seekTimes.items())}get isSeeking(){return this.element.seeking}get currentTime(){return isNaN(this.element.currentTime)?0:1e3*this.element.currentTime}set currentTime(e){Number.isFinite(e)&&(this.element.currentTime=e/1e3)}get playbackRate(){return this.element.playbackRate}set playbackRate(e){this.element.playbackRate=e}get volume(){return this.element.volume}set volume(e){this.element.volume=e}get muted(){return this.element.muted}set muted(e){this._userProvidedMuted=e,this.element.muted=e}get userHasProvidedInput(){return this._userHasProvidedInput}get isPaused(){return this._isPaused}}const ct=["minBufferTime","maxBufferTime","burstEnabled","sizeBasedResolutionCapEnabled","separateVideoSocketEnabled","videoCodecs"];class ut{constructor(e){g(this,"options"),g(this,"overrides",new Map),this.options=e}getOptions(){return this.options}addOverrides(e,t){this.overrides.set(e,t)}set(e,t){this.options[e]=t}get(e,t){var i,s;if(t&&(s=e,ct.includes(s))){const s=null==(i=this.overrides.get(t))?void 0:i[e];if(void 0!==s)return s}return this.options[e]}getOverride(e,t){var i;return null==(i=this.overrides.get(t))?void 0:i[e]}}const lt={sizeBasedResolutionCapEnabled:!0,pictureInPictureEnabled:!0,abrEnabled:!0,burstEnabled:!1,mseEnabled:!0,mseOpusEnabled:!1,muted:!1,minBufferTime:1500,maxBufferTime:1500,logLevel:"off",maxSize:ce(),maxVideoBitRate:de(),maxAudioBitRate:de(),tags:[],media:"audio+video",poster:!0,reconnectHandler:e=>e.reconnectRetries<30,iosWakeLockEnabled:!1,telemetryEnabled:!0,iosMediaElementEnabled:!1,pauseSupportEnabled:!0,advanced:{wasmDecodingConstraint:{bitRate:Number.MAX_SAFE_INTEGER,width:1280,height:1280}},videoCodecs:["av1","h264"]},mt={cooldownTime:3e3,maxBufferingEvents:{last10Seconds:0},maxBufferingRatio:{last10Seconds:0},maxRecentDowngradesCount:3,maxDowngradeLookbackMs:6e4,minTimeSpentPlaying:{factor:.5,ratio:.1},maxCooldownRatio:2},At=e=>t=>t>e,gt=class{constructor(e,t,i,s){g(this,"qualityOfServiceSource"),g(this,"config"),g(this,"emitter"),g(this,"logger"),g(this,"isSuspended",!1),g(this,"lastAdaptTime",Date.now()),g(this,"isEnabled",!0),g(this,"load",(()=>{this.emitter.on("buffer state",this.onBufferState),this.emitter.on("adapted level",this.onAdaptedLevel)})),g(this,"unload",(()=>{this.emitter.off("buffer state",this.onBufferState),this.emitter.off("adapted level",this.onAdaptedLevel)})),g(this,"suspend",(()=>{this.isSuspended=!0})),g(this,"unsuspend",(()=>{this.reset(),this.isSuspended=!1})),g(this,"reset",((e=0)=>{this.lastAdaptTime=Date.now()+e})),g(this,"getStatistics",(()=>({isAbrEnabled:this.isEnabled}))),g(this,"isQoSOk",(e=>{const t=this.qualityOfServiceSource.getLevelStats(e),{upgradesFromLevel:i,downgradesFromLevel:s}=null!=t?t:{upgradesFromLevel:[],downgradesFromLevel:[]},n=Date.now()-this.config.maxDowngradeLookbackMs,r=s.filter(At(n)).length,o=i.filter(At(n)).length;if(r-o>this.config.maxRecentDowngradesCount)return this.logger.debug("Recent downgrades count is over maximum",{downgrades:r-o,maxRecentDowngradesCount:this.config.maxRecentDowngradesCount}),!1;const a=this.qualityOfServiceSource.timeSpentPlayingInAtLeastLevelRatio(e),h=a*(this.qualityOfServiceSource.timeActive()-this.qualityOfServiceSource.timeSpentBuffering())/this.config.maxDowngradeLookbackMs;if(r>1&&h<this.config.minTimeSpentPlaying.factor)return this.logger.debug("Time spent playing is too low",{recentDowngrades:r,timeSpentPlayingInAtLeastLevelRatio:a}),!1;if(r>1&&a<this.config.minTimeSpentPlaying.ratio)return this.logger.debug("Time spent playing in at least this level is too low",{recentDowngrades:r,timeSpentPlayingInAtLeastLevelRatio:a}),!1;const d=Math.max(0,s.length-i.length-h),c=Date.now()-this.config.maxDowngradeLookbackMs*d,u=s.filter(At(c)).length;return!(u&&d>this.config.maxCooldownRatio&&(this.logger.debug("Too many downgrades compared to time spent playing",{downgradesWithinCooldownTime:u,cooldownRatio:d}),1))})),g(this,"onBufferState",(e=>{if(!this.isEnabled||this.isSuspended||this.lastAdaptTime+this.config.cooldownTime>Date.now())return;const{bufferFullness:t,general:i}=this.qualityOfServiceSource.getMetrics(),s=this.qualityOfServiceSource.getBufferFullnessRegression();if(!s)return;const{slope:n}=s,r=s.predict(15),o=n<0,a=s.predict(15)<.4&&s.slope<0,h=s.predict(15)>.6,d=this.qualityOfServiceSource.timeSpentBufferingLast(3e4),c=this.qualityOfServiceSource.timeSpentActiveLast(3e4);t<.15&&d/c>.8?this.adaptLevel("reconnect"):i.decodeRate<=1?this.adaptLevel("downgrade"):a||t<.15?o&&t<.4&&r<.2&&this.adaptLevel("buffering"===e.playbackState?"double downgrade":"downgrade"):t>.5&&h&&!this.tooMuchTimeBuffering(1e4)&&!this.tooManyBufferingEvents(1e4)&&this.adaptLevel("upgrade")})),g(this,"onAdaptedLevel",(()=>{this.reset()})),g(this,"adaptLevel",(e=>this.emitter.emit("adapt level",e))),this.qualityOfServiceSource=i,this.config=m(m({},mt),s),this.emitter=e,this.logger=t}tooMuchTimeBuffering(e){return this.qualityOfServiceSource.timeSpentBufferingLast(e)/this.qualityOfServiceSource.timeSpentActiveLast(e)>this.config.maxBufferingRatio.last10Seconds}tooManyBufferingEvents(e){return this.qualityOfServiceSource.timeSpentBufferingLast(e)>this.config.maxBufferingEvents.last10Seconds}};g(gt,"create",((e,t,i,s={})=>new gt(e,t,i,s)));let pt=gt;const ft={minBufferTime:1500,maxBufferTime:1500,cooldownTime:3e4,maxBufferingEvents:{last30Seconds:3},maxBufferingRatio:{last30Seconds:.15}},vt=class e{constructor(t,i,s,n,r){g(this,"qualityOfServiceSource"),g(this,"targetBufferTimeTarget"),g(this,"config"),g(this,"emitter"),g(this,"logger"),g(this,"isSuspended",!1),g(this,"lastIncreaseTime",Date.now()),g(this,"bufferTimeAdjustmentCount",0),g(this,"load",(()=>{this.emitter.on("buffer state",this.onBufferState)})),g(this,"unload",(()=>{this.emitter.off("buffer state",this.onBufferState)})),g(this,"suspend",(()=>{this.isSuspended=!0})),g(this,"unsuspend",(()=>{this.reset(),this.isSuspended=!1})),g(this,"reset",(()=>{this.lastIncreaseTime=Date.now()})),g(this,"getStatistics",(()=>({bufferTimeAdjustmentCount:this.bufferTimeAdjustmentCount}))),g(this,"onBufferState",(t=>{const{minBufferTime:i,maxBufferTime:s,cooldownTime:n}=this.config;if(this.isSuspended||this.lastIncreaseTime+n>Date.now()||this.targetBufferTimeTarget.targetBufferTime>=s)return;const r=this.qualityOfServiceSource.timeSpentBufferingLast(3e4),o=this.qualityOfServiceSource.bufferingEventsLast(3e4),a=r/this.qualityOfServiceSource.timeSpentActiveLast(3e4),h=Math.ceil(Math.max((s-i)/(e.BUFFER_TIME_MAX_STEPS-1),e.BUFFER_TIME_STEP_SIZE));(a>this.config.maxBufferingRatio.last30Seconds||o>this.config.maxBufferingEvents.last30Seconds)&&(this.targetBufferTimeTarget.targetBufferTime=Math.min(s,this.targetBufferTimeTarget.targetBufferTime+h),this.bufferTimeAdjustmentCount++,this.reset())})),this.qualityOfServiceSource=s,this.targetBufferTimeTarget=n,this.config=m(m({},ft),r),this.emitter=t,this.logger=i}updateConfig(e){this.config=m(m({},this.config),e)}};g(vt,"BUFFER_TIME_STEP_SIZE",500),g(vt,"BUFFER_TIME_MAX_STEPS",3),g(vt,"create",((e,t,i,s,n={})=>new vt(e,t,i,s,n)));let wt=vt;class bt extends s.E{constructor(e,t){super(),g(this,"options"),g(this,"websockets",[]),g(this,"logger"),g(this,"reconnectState",{reconnectRetries:0}),g(this,"isSuspended",!1),g(this,"_connectionAttemptCount",0),g(this,"connectStartTime",0),g(this,"_connectTime"),g(this,"shouldContinueConnecting",!1),g(this,"_isConnectInProgress",!1),g(this,"readyState",(()=>{if(0===this.websockets.length)return WebSocket.CLOSED;const e=this.websockets.map((e=>e.readyState));for(const t of e)if(t!==WebSocket.OPEN)return t;return WebSocket.OPEN})),g(this,"url",(()=>{var e;return null==(e=this.websockets[0])?void 0:e.url})),g(this,"send",(e=>{var t;this.websockets.length&&(null==(t=this.websockets[0])||t.send(e))})),g(this,"close",(e=>{var t;let i=!1;return null==(t=this.websockets)||t.forEach((t=>{t.onmessage=q,t.removeEventListener("error",this.onError),t.removeEventListener("close",this.onClose),t.removeEventListener("open",this.onOpen),t.close(1e3,e),i=!0})),this.websockets=[],this.shouldContinueConnecting=!1,this._isConnectInProgress=!1,this.logger.info("Closed websocket",{reason:e}),i})),g(this,"suspend",(()=>{this.isSuspended=!0})),g(this,"unsuspend",(()=>{this.isSuspended=!1,this.readyState()!==WebSocket.OPEN&&!this.isConnectInProgress&&this.connect()})),g(this,"onMessage",((e,t)=>{0!==this.websockets.length&&this.options.onMessage(e,t.data)})),g(this,"onError",(()=>{this.logger.info("On error",m({},this.options)),this.close("one websocket had an error"),this.connect(!0)})),g(this,"onClose",(e=>{switch(this.logger.info("Closed",A(m({},this.options),{reason:e.reason,code:e.code,isSuspended:this.isSuspended})),this.close("one websocket was closed"),this.emit("close",this),e.code){case 4e3:case 4001:this.emit("error",ve(fe()));break;case 4002:this.emit("error",(i=fe(),new le("Authentication Expired",{isFatal:!0,code:"authentication_expired",source:i})));break;case 4003:this.emit("error",we("internal",fe())),this.connect(!0);break;case 4010:this.emit("error",(t=fe(),new le("Connection closed due to inactivity",{isFatal:!1,code:"connection_inactivity",source:t,type:"internal"}))),this.connect(!0);break;default:this.connect(!0)}var t,i})),g(this,"onOpen",(()=>{this.logger.info("Opened",m({},this.options)),this.readyState()===WebSocket.OPEN&&(this._connectTime=Date.now()-this.connectStartTime,this.reconnectState.reconnectRetries=0,this._isConnectInProgress=!1,this.emit("open",this))})),g(this,"connect",((e=!1)=>y(this,null,(function*(){if(this.isConnectInProgress)return this.logger.info("Connect already in progress"),!1;if(this.isSuspended)return!1;if(this.readyState()!==WebSocket.CLOSED&&this.close("new connection in progress"),this.shouldContinueConnecting=!0,this._isConnectInProgress=!0,e&&this.options.reconnectDelay>0){this.logger.info("Waiting for reconnect delay",m({},this.options)),yield ne(this.options.reconnectDelay);const e=yield this.options.reconnectHandler(this.reconnectState);if(this.reconnectState.reconnectRetries++,!e)return this._isConnectInProgress=!1,this.emit("error",new le("Connection failed - no more reconnect attempts",{isFatal:!0,code:"connection_failed_will_not_attempt_again"})),!1}this._connectionAttemptCount++;try{if(!this.shouldContinueConnecting)return this._isConnectInProgress=!1,this.logger.info("Connection aborted"),!1;const e=yield this.options.connectHandler();if(this.connectStartTime=Date.now(),!this.shouldContinueConnecting)return this._isConnectInProgress=!1,this.logger.info("Connection aborted"),!1;this.logger.info("Connecting websockets",A(m({},this.options),{url:e}));for(let t=0;t<this.options.connectionsCount;t++){const i=new WebSocket(e);i.binaryType="arraybuffer",i.onmessage=e=>this.onMessage(t,e),i.addEventListener("error",this.onError),i.addEventListener("close",this.onClose),i.addEventListener("open",this.onOpen),this.websockets.push(i)}return!0}catch(e){return this._isConnectInProgress=!1,!(e instanceof le&&(this.logger.error("Failed to connect",e.toStringifiable()),e.isFatal()))&&!!this.shouldContinueConnecting&&(this.logger.info("Connection aborted",{error:e}),this.connect(!0))}})))),this.options=e,this.logger=t}get isConnectInProgress(){return this._isConnectInProgress}get connectionCount(){return this.options.connectionsCount}set connectionCount(e){this.options.connectionsCount=e}get connectionAttemptCount(){return this._connectionAttemptCount}get connectTime(){return this._connectTime}}const St=e=>471859200/e,yt=class e{constructor(t,i,s){g(this,"timers",ie.create()),g(this,"emitter"),g(this,"transport"),g(this,"logger"),g(this,"options"),g(this,"rtts",new C(10)),g(this,"lastPingSentTime",Date.now()),g(this,"isPingInFlight",!1),g(this,"connectCount",0),g(this,"_firstConnectionTime"),g(this,"_lastConnectionTime"),g(this,"missedPings",0),g(this,"_connectionsCount",2),g(this,"contextSwitchesInProgress",new Set),g(this,"contextSwitchesCompleted",new Set),g(this,"buffer",[]),g(this,"unload",(()=>{this.logger.debug("Unloading module..."),this.disconnect("Unloading"),this.timers.unload(),this.emitter.off("send signal",this.sendSignal),this.emitter.off("disconnect",this.disconnect),this.emitter.off("reconnect",this.reconnect),this.logger.debug("Unloaded module")})),g(this,"suspend",(()=>{var e;this.resetPingState(),null==(e=this.transport)||e.suspend()})),g(this,"unsuspend",(()=>{var e;null==(e=this.transport)||e.unsuspend()})),g(this,"getState",(()=>{var e;switch(null==(e=this.transport)?void 0:e.readyState()){case WebSocket.OPEN:return"connected";case WebSocket.CONNECTING:return"connecting";default:return"disconnected"}})),g(this,"sendSignal",(e=>{var t,i;this.logger.debug("sending signal",{signal:e}),(null==(t=this.transport)?void 0:t.readyState())===WebSocket.OPEN?null==(i=this.transport)||i.send(e):this.logger.debug("transport is closed")})),g(this,"getStatistics",(()=>{var e,t,i;const s=F(this.rtts.items());return{rtt:s,estimatedBandwidth:St(s.average),edgeUrl:null==(e=this.transport)?void 0:e.url(),connectCount:this.connectCount,connectionAttemptCount:null!=(i=null==(t=this.transport)?void 0:t.connectionAttemptCount)?i:0}})),g(this,"onMessage",((e,t)=>{var i;if(this.pingCooldownExpired()&&this.sendPing(),this.contextSwitchesCompleted.size===(null==(i=this.transport)?void 0:i.connectionCount)){this.logger.info("Completing context switch"),this.contextSwitchesInProgress.clear(),this.contextSwitchesCompleted.clear();const e=this.buffer.filter((([e,t])=>!(t instanceof ArrayBuffer))),t=this.buffer.filter((([e,t])=>t instanceof ArrayBuffer));e.map((e=>this.handleMessage(e[0],e[1]))),t.map((e=>this.handleMessage(e[0],e[1]))),this.buffer=[]}if(this.contextSwitchesInProgress.has(e)){if(!(t instanceof ArrayBuffer)){const i=JSON.parse(t);if(ue(i)&&"context switch complete"===i.type)return this.logger.info("context switch completed",{socketId:e}),this.emitter.emit("context switch complete"),void this.contextSwitchesCompleted.add(e)}this.buffer.push([e,t])}else this.handleMessage(e,t)})),g(this,"handleMessage",((e,t)=>{if(t instanceof ArrayBuffer)this.emitter.emit("received data",t);else{const i=JSON.parse(t);if(!ue(i))return;switch(i.type){case"pong":this.lastPingSentTime&&(this.rtts.push(Date.now()-this.lastPingSentTime),this.isPingInFlight=!1,this.emitter.emit("rtt",this.rtt));break;case"context switch":this.logger.info("Starting context switch",{socketId:e}),this.emitter.emit("context switch started"),this.contextSwitchesInProgress.add(e);break;default:this.emitter.emit("received signal",i)}}})),g(this,"connect",(e=>{this.disconnect("user connected"),this._connectionsCount=e,this.transport=new bt({reconnectDelay:1e3,connectionsCount:this._connectionsCount,onMessage:this.onMessage,reconnectHandler:this.options.reconnectHandler,connectHandler:this.options.connectHandler},this.logger.createContext("Transport")),this.transport.on("open",this.onTransportChange),this.transport.on("close",this.onTransportChange),this.transport.on("error",(e=>this.emitter.emit("error",e))),this.transport.connect()})),g(this,"onTransportChange",(()=>{var t;"connected"===this.getState()?(null!=(t=this.transport)&&t.connectTime&&(this.rtts.push(this.transport.connectTime/e.TLS_ROUNDTRIPS/this.transport.connectionCount),this.emitter.emit("rtt",this.rtt)),this._lastConnectionTime=Date.now(),this._firstConnectionTime||(this._firstConnectionTime=this._lastConnectionTime),this.connectCount++,this.resetPingState()):(this.contextSwitchesCompleted.clear(),this.contextSwitchesInProgress.clear(),this.buffer=[],this.resetPingState()),this.emitter.emit("connection state",this.getState())})),g(this,"disconnect",((e="Disconnect Requested")=>{var t;this.contextSwitchesCompleted.clear(),this.contextSwitchesInProgress.clear(),this.buffer=[],this.resetPingState(),null==(t=this.transport)||t.close(e)})),g(this,"reconnect",(e=>{var t;null!=(t=this.transport)&&t.isConnectInProgress?this.logger.debug("Stopping reconnect, already mid-connection"):(this.disconnect(e),this.connect(this._connectionsCount))})),g(this,"resetPingState",(()=>{this.missedPings=0,this.isPingInFlight=!1})),g(this,"pingCooldownExpired",(()=>Date.now()-this.lastPingSentTime>e.PING_INTERVAL)),g(this,"sendPing",(()=>{if(this.isPingInFlight)return this.missedPings++,void(this.missedPings>e.MAX_MISSED_PINGS&&this.reconnect("missed pings"));this.isPingInFlight=!0,this.lastPingSentTime=Date.now(),this.missedPings=0,this.sendSignal(JSON.stringify({type:"ping"}))})),this.logger=i,this.emitter=t,this.options=s,this.emitter.on("send signal",this.sendSignal),this.emitter.on("disconnect",this.disconnect),this.emitter.on("reconnect",this.reconnect)}get rtt(){return this.rtts.items().length>0?O(this.rtts.items()):0}get estimatedBandwidth(){return this.rtt>0?St(this.rtt):void 0}get connectTime(){var e;return null==(e=this.transport)?void 0:e.connectTime}get firstConnectionTime(){return this._firstConnectionTime}get lastConnectionTime(){return this._lastConnectionTime}setConnectionCount(e){this._connectionsCount=e,this.transport&&(this.transport.connectionCount=e)}getConnectionCount(){return this._connectionsCount}};g(yt,"PING_INTERVAL",5e3),g(yt,"MAX_MISSED_PINGS",4),g(yt,"TLS_ROUNDTRIPS",3),g(yt,"create",((e,t,i)=>new yt(e,t,i)));let Et=yt;const Ct=()=>({video:A(m({},ce()),{bitRate:de()}),audio:{bitRate:de()}}),Tt=class e{constructor(t,i,s,n){g(this,"emitter"),g(this,"timers",new ie),g(this,"pictureInPictureSource"),g(this,"element"),g(this,"currentCap"),g(this,"userSpecifiedCap"),g(this,"renditionLevelSource"),g(this,"resizeObserver"),g(this,"elementSize"),g(this,"_sizeBasedResolutionCapEnabled"),g(this,"unload",(()=>{var e;this.emitter.off("enter picture in picture",this.enterPictureInPicture),this.emitter.off("exit picture in picture",this.exitPictureInPicture),null==(e=this.resizeObserver)||e.disconnect(),this.suspend()})),g(this,"load",(()=>{window.ResizeObserver&&(this.resizeObserver=new ResizeObserver(this.onResize),this.resizeObserver.observe(this.element)),this.evaluateConstraintCap()})),g(this,"unsuspend",(()=>{this.timers.setInterval(this.evaluateConstraintCap,e.CHECK_SIZE_INTERVAL),this.evaluateConstraintCap()})),g(this,"suspend",(()=>{this.timers.unload()})),g(this,"setUserSpecifiedCap",(e=>{var t;const i=null!=(t=this.getUserSpecifiedCap())?t:Ct();this.userSpecifiedCap=A(m({},i),{video:m(m({},i.video),e.video),audio:m(m({},i.audio),e.audio)}),this.evaluateConstraintCap()})),g(this,"getUserSpecifiedCap",(()=>this.userSpecifiedCap)),g(this,"getCurrentConstraintCap",(()=>this.currentCap)),g(this,"getStatistics",(()=>({constraintCap:this.getUserSpecifiedCap(),windowInnerWidth:window.innerWidth,windowInnerHeight:window.innerHeight,elementWidth:this.elementSize.width,elementHeight:this.elementSize.height,pixelRatio:window.devicePixelRatio}))),g(this,"constrainSubscription",(e=>{const t=this.getCurrentConstraintCap();return t&&(e.video.codec&&(e.video.bitRate=Math.min(t.video.bitRate,e.video.bitRate),e.video.width=Math.min(t.video.width,e.video.width),e.video.height=Math.min(t.video.height,e.video.height)),e.audio.codec&&(e.audio.bitRate=Math.min(t.audio.bitRate,e.audio.bitRate))),e})),g(this,"onResize",(e=>{e.forEach((e=>{this.elementSize={width:e.contentRect.width,height:e.contentRect.height}}))})),g(this,"evaluateConstraintCap",(()=>{var e,t,i,s,n;const r=this.sizeBasedResolutionCapEnabled?A(m({},Ct()),{video:{width:window.innerWidth,height:window.innerHeight,bitRate:de()}}):Ct();if(!this.resizeObserver){const e=this.element.getBoundingClientRect();this.elementSize={width:e.width,height:e.height}}if(this.sizeBasedResolutionCapEnabled){const t=window.devicePixelRatio,i=null==(e=this.pictureInPictureSource)?void 0:e.getPictureInPictureSize();this.elementSize.width>0&&this.elementSize.height>0&&(r.video.width=this.elementSize.width,r.video.height=this.elementSize.height),i&&(r.video.width=i.width,r.video.height=i.height),r.video.width*=t,r.video.height*=t}const o=this.renditionLevelSource.getRenditionLevels().find((e=>{if(e.video)return e.video.width/e.video.height>r.video.width/r.video.height?e.video.width>r.video.width:e.video.height>r.video.height}));o&&o.video&&(r.video.width=o.video.width,r.video.height=o.video.height);const a=null==(t=this.userSpecifiedCap)?void 0:t.video,h=null==(i=this.userSpecifiedCap)?void 0:i.audio;a&&r.video.width>a.width&&r.video.height>a.height&&(r.video.width=a.width,r.video.height=a.height),r.video.bitRate=null!=(s=null==a?void 0:a.bitRate)?s:r.video.bitRate,r.audio.bitRate=null!=(n=null==h?void 0:h.bitRate)?n:r.audio.bitRate,Q(r,this.currentCap)?this.currentCap=m({},r):(this.currentCap=m({},r),this.emitter.emit("constraint cap changed",r))})),g(this,"enterPictureInPicture",(e=>{this.pictureInPictureSource=e,this.evaluateConstraintCap()})),g(this,"exitPictureInPicture",(()=>{this.pictureInPictureSource=void 0,this.evaluateConstraintCap()})),this.element=i;const r=this.element.getBoundingClientRect();this.elementSize={width:r.width,height:r.height},this.emitter=t,this.renditionLevelSource=s,this._sizeBasedResolutionCapEnabled=n,this.emitter.on("enter picture in picture",this.enterPictureInPicture),this.emitter.on("exit picture in picture",this.exitPictureInPicture)}get sizeBasedResolutionCapEnabled(){return this._sizeBasedResolutionCapEnabled}set sizeBasedResolutionCapEnabled(e){this._sizeBasedResolutionCapEnabled=e,this.evaluateConstraintCap()}};g(Tt,"CHECK_SIZE_INTERVAL",1e3),g(Tt,"create",((e,t,i,s)=>new Tt(e,t,i,s)));let xt=Tt;class kt{constructor(e,t,i,s){g(this,"timers",ie.create()),g(this,"logger"),g(this,"emitter"),g(this,"trackContexts"),g(this,"playbackSource"),g(this,"isSuspended",!1),g(this,"load",(()=>{this.timers.setInterval(this.emitDecodedFrames,100),this.timers.setInterval(this.emitDecodeRate,1e3),this.emitter.on("init segment",this.onInitSegment),this.emitter.on("coded sample",this.decode)})),g(this,"unload",(()=>{this.trackContexts.forEach((({decoderContext:e})=>e.unload())),this.timers.unload(),this.emitter.off("init segment",this.onInitSegment),this.emitter.off("coded sample",this.decode)})),g(this,"suspend",(()=>{this.isSuspended=!0})),g(this,"unsuspend",(()=>{this.isSuspended=!1})),g(this,"getBuffer",(e=>{var t;return null==(t=this.trackContexts.get(e))?void 0:t.buffer})),g(this,"videoDecodeRate",(()=>{var e,t,i;const s=this.trackContexts.get("video"),n=null!=(e=null==s?void 0:s.sampleDuration)?e:40,r=F(null!=(t=null==s?void 0:s.decodeTime.items())?t:[]),o=F(null!=(i=null==s?void 0:s.transportTime.items())?i:[]);return n/(r.average+o.average)})),g(this,"getStatistics",(()=>{var e,t,i,s;const n=this.trackContexts.get("video"),r=F(null!=(e=null==n?void 0:n.decodeTime.items())?e:[]),o=F(null!=(t=null==n?void 0:n.transportTime.items())?t:[]),a=F(null!=(s=null==(i=this.trackContexts.get("audio"))?void 0:i.decodeTime.items())?s:[]);return{videoDecodeRate:this.videoDecodeRate(),videoDecodeTime:r,audioDecodeTime:a,videoTransportTime:o}})),g(this,"onInitSegment",(({initSegment:e})=>{var t;const i=null==(t=this.trackContexts.get(e.type))?void 0:t.decoderContext;if(!i)throw new le("No known decoder context",{code:"no_known_decoder_context",isFatal:!1});i.initSegment(e)})),g(this,"decode",(e=>{const t=this.trackContexts.get(e.type);if(!t)throw new le("No known decoder context",{code:"no_known_decoder_context",isFatal:!1});if(this.isSuspended)return;t.sampleDuration=e.duration/e.timescale*1e3;const{decoderContext:i,buffer:s}=t,n=e.timestamp/e.timescale*1e3,r=e.duration/e.timescale*1e3,o=s[s.length-1];!o||n-5>o.end?s.push({start:n,end:n+r}):n+5*r<o.end?t.buffer=[{start:n,end:n+r}]:o.end=n+r,i.enqueue(e),this.emitDecodedFrames()})),g(this,"emitDecodedFrames",(()=>{let e;this.updateBufferState(),this.trackContexts.forEach((t=>{var i,s;let n;for(;void 0!==(n=null==(s=(i=t.decoderContext).error)?void 0:s.call(i));)this.emitter.emit("error",me(!1,n));for(;void 0!==(e=t.decoderContext.take());){const{statistics:i}=e;i&&(t.decodeTime.push(i.decodeTime),t.transportTime.push((i.transportTimeToWorker+i.transportTimeFromWorker)/i.samplesInBatch)),this.emitter.emit("decoded frame",e)}}))})),g(this,"emitDecodeRate",(()=>{this.emitter.emit("video decode rate",this.videoDecodeRate())})),g(this,"updateBufferState",(()=>{var e,t;let i;if(this.trackContexts.forEach((e=>{var t,s,n,r;if(i){const o=null!=(s=null==(t=e.buffer[e.buffer.length-1])?void 0:t.end)?s:0;(null!=(r=null==(n=i[i.length-1])?void 0:n.end)?r:0)>o&&(i=e.buffer)}else i=e.buffer})),!i)return;const s=this.playbackSource.currentTime<(null!=(t=null==(e=i[i.length-1])?void 0:e.end)?t:0)?"playing":"buffering";this.emitter.emit("buffer state",{buffered:i,currentTime:this.playbackSource.currentTime,isPaused:this.playbackSource.isPaused,playbackState:s})})),this.logger=t,this.emitter=e,this.trackContexts=i,this.playbackSource=s}static create(e,t,s,n,r){return y(this,null,(function*(){const o=new Map;for(const e of s)switch(e.type){case"audio":{const{OpusDecoderContext:t}=yield i.e(418).then(i.bind(i,5418));o.set(e.type,{buffer:[],decoderContext:yield t.create(48e3,2),decodeTime:new C(100),transportTime:new C(100),sampleDuration:40});break}case"video":{const{H264DecoderWorkerContext:t}=yield i.e(684).then(i.bind(i,1684));o.set(e.type,{buffer:[],decoderContext:yield t.create(r),decodeTime:new C(100),transportTime:new C(100),sampleDuration:40});break}}return new kt(e,t,o,n)}))}}const It=class{constructor(e){g(this,"emitter"),g(this,"isVisibleCount",0),g(this,"isHiddenCount",0),g(this,"isOnlineCount",0),g(this,"isOfflineCount",0),g(this,"isActive","visible"===document.visibilityState),g(this,"unload",(()=>{document.removeEventListener("visibilitychange",this.onVisibilityChanged),window.removeEventListener("pagehide",this.onPageHide),window.removeEventListener("online",this.onOnline),window.removeEventListener("offline",this.onOffline)})),g(this,"load",(()=>{document.addEventListener("visibilitychange",this.onVisibilityChanged),window.addEventListener("pagehide",this.onPageHide),window.addEventListener("online",this.onOnline),window.addEventListener("offline",this.onOffline)})),g(this,"unsuspend",(()=>{})),g(this,"getStatistics",(()=>{var e,t,i,s,n;return{isVisible:this.isVisible,isOnline:this.isOnline,isVisibleCount:this.isVisibleCount,isHiddenCount:this.isHiddenCount,isOnlineCount:this.isOnlineCount,isOfflineCount:this.isOfflineCount,navigatorRtt:null==(e=navigator.connection)?void 0:e.rtt,navigatorEffectiveType:null==(t=navigator.connection)?void 0:t.effectiveType,navigatorConnectionType:null==(i=navigator.connection)?void 0:i.type,navigatorSaveData:null==(s=navigator.connection)?void 0:s.saveData,navigatorDownlink:null==(n=navigator.connection)?void 0:n.downlink}})),g(this,"onOnline",(()=>this.isOnlineCount++)),g(this,"onOffline",(()=>this.isOfflineCount++)),g(this,"onPageHide",(e=>this.emitter.emit("pagehide",e))),g(this,"onVisibilityChanged",(()=>{this.setIsActive("visible"===document.visibilityState)})),g(this,"setIsActive",(e=>{e!==this.isActive&&(this.emitter.emit("page active",e),e?this.isVisibleCount++:this.isHiddenCount++),this.isActive=e})),this.emitter=e}get isOnline(){return navigator.onLine}get isVisible(){return"visible"===document.visibilityState}};g(It,"create",(e=>new It(e)));let Bt=It;const Rt=class e{constructor(t,i,s){var n;g(this,"logger"),g(this,"emitter"),g(this,"waitingEvents",[]),g(this,"isTriggered",(n=e.EVENT_TIMEOUT,(e,t,i)=>e.timestamp<=t||e.timestampAdded<=i-n)),g(this,"timeSource"),g(this,"timers",new ie),g(this,"load",(()=>{this.timers.setInterval(this.onBufferedStateChanged,e.EVENT_CHECK_INTERVAL)})),g(this,"unload",(()=>{this.timers.unload()})),g(this,"addEvent",(e=>{this.logger.debug("Adding event",{event:e}),this.waitingEvents.push(A(m({},e),{timestampAdded:Date.now()}))})),g(this,"extractEvent",((e,t)=>{"video"===t.type&&e.channelId!==t.channelId&&this.addEvent({type:"channel switch",channelId:t.channelId,timestamp:t.timestamp/t.timescale*1e3}),"audio"===t.type&&"audio"===e.type&&void 0!==t.language&&t.language!==e.language&&this.addEvent({type:"language switch",language:t.language,timestamp:t.timestamp/t.timescale*1e3})})),g(this,"onBufferedStateChanged",(()=>{var e;const t=Date.now(),i=null!=(e=this.timeSource.drift)?e:0,s=this.timeSource.serverCurrentTime-i;if(0===this.waitingEvents.length)return;const n=this.waitingEvents.filter((e=>this.isTriggered(e,s,t)));this.waitingEvents=this.waitingEvents.filter((e=>!this.isTriggered(e,s,t))),n.forEach((e=>{this.logger.debug("Emitting event",{event:e}),this.emitter.emit("event",e)}))})),this.logger=i,this.emitter=t,this.timeSource=s}};g(Rt,"EVENT_TIMEOUT",5e3),g(Rt,"EVENT_CHECK_INTERVAL",20),g(Rt,"create",((e,t,i)=>new Rt(e,t,i)));let Pt=Rt;const Mt=class e{constructor(t){g(this,"emitter"),g(this,"timers",ie.create()),g(this,"bytesReceived",new Map),g(this,"timeoutInterval"),g(this,"lastBytesUpdated",Date.now()),g(this,"load",(()=>{this.emitter.on("connection state",this.onConnectionState),this.timers.setInterval((()=>this.bytesReceived.forEach((e=>e.tick()))),100)})),g(this,"unload",(()=>{this.emitter.off("connection state",this.onConnectionState),this.timers.unload()})),g(this,"averageBitRate",(e=>{var t,i;return 8*(null!=(i=null==(t=this.bytesReceived.get(e))?void 0:t.average)?i:0)})),g(this,"totalBytesReceived",(()=>{let e=0;return this.bytesReceived.forEach((t=>{e+=t.total})),e})),g(this,"add",((t,i)=>{let s=this.bytesReceived.get(t);s||(s=new N(20),this.bytesReceived.set(t,s)),i>0&&(this.lastBytesUpdated=Date.now(),this.timeoutInterval||(this.timeoutInterval=this.timers.setInterval(this.checkTimeout,e.UPDATE_RECEIVED_BYTES_INTERVAL))),s.add(i)})),g(this,"getStatistics",(()=>({bytesReceived:this.totalBytesReceived(),videoBitRate:this.averageBitRate("video"),audioBitRate:this.averageBitRate("audio")}))),g(this,"onConnectionState",(t=>{this.clearTimeoutInterval(),"connected"===t&&(this.lastBytesUpdated=Date.now(),this.timeoutInterval=this.timers.setInterval(this.checkTimeout,e.UPDATE_RECEIVED_BYTES_INTERVAL))})),g(this,"checkTimeout",(()=>{const t=Date.now()-this.lastBytesUpdated;if(0===this.totalBytesReceived()&&t>e.NO_DATA_ERROR_TIMEOUT)return this.emitter.emit("error",new le("No Incoming Data",{isFatal:!1,code:"no_incoming_data_error",source:undefined})),this.emitter.emit("reconnect","no incoming data"),void this.clearTimeoutInterval();t>e.NO_DATA_TIMEOUT&&this.totalBytesReceived()>0&&(this.emitter.emit("no data timeout",this.totalBytesReceived()),this.clearTimeoutInterval())})),g(this,"clearTimeoutInterval",(()=>{this.timeoutInterval&&(this.timers.clearInterval(this.timeoutInterval),this.timeoutInterval=void 0)})),this.emitter=t}};g(Mt,"NO_DATA_ERROR_TIMEOUT",2e4),g(Mt,"NO_DATA_TIMEOUT",5e3),g(Mt,"UPDATE_RECEIVED_BYTES_INTERVAL",1e3),g(Mt,"create",(e=>new Mt(e)));let _t=Mt;const Ut=class e extends s.E{constructor(){super(),g(this,"context",new(window.AudioContext||window.webkitAudioContext)),g(this,"timers",ie.create()),g(this,"previousCurrentTime",0),g(this,"_isStuck",!1),g(this,"mediaStreamDestination"),g(this,"unload",(()=>(this.timers.unload(),this.context.removeEventListener("statechange",this.onStateChange),"closed"!==this.context.state?this.context.close():Promise.resolve()))),g(this,"createGain",(()=>this.context.createGain())),g(this,"createBuffer",((e,t,i)=>this.context.createBuffer(e,t,i))),g(this,"createBufferSource",(()=>this.context.createBufferSource())),g(this,"getMediaStreamDestination",(()=>(this.mediaStreamDestination||(this.mediaStreamDestination=this.context.createMediaStreamDestination()),this.mediaStreamDestination))),g(this,"getDefaultDestination",(()=>this.context.destination)),g(this,"resume",(()=>y(this,null,(function*(){try{return yield Promise.race([this.context.resume(),re(1e3,new le("Web Audio Context resume timeout",{isFatal:!1,code:"web_audio_context_resume_timeout"}))])}catch(e){throw this.suspend().catch(q),e}})))),g(this,"suspend",(()=>y(this,null,(function*(){var e;yield null!=(e=this.context.suspend())?e:Promise.resolve()})))),g(this,"onStateChange",(()=>this.emit("state",this.state))),this.context.addEventListener("statechange",this.onStateChange),this.timers.setInterval((()=>{this._isStuck=this.isRunning&&this.context.currentTime===this.previousCurrentTime,this._isStuck&&this.emit("stuck"),this.previousCurrentTime=this.context.currentTime}),e.CHECK_INTERVAL)}get isStuck(){return this._isStuck}get isRunning(){return"running"===this.state}get currentTime(){return this.context.currentTime}get sampleRate(){return this.context.sampleRate}get state(){return this.context.state}};g(Ut,"CHECK_INTERVAL",1e3);let Lt=Ut;const Dt=class extends s.E{constructor(e,t,{muted:i,reInitWhenStuck:s}){super(),g(this,"logger"),g(this,"audio"),g(this,"gainNode"),g(this,"_volume",1),g(this,"_userProvidedMuted",!1),g(this,"_muted",!1),g(this,"startTime",0),g(this,"samples",new Float32Array(new ArrayBuffer(38400))),g(this,"preInitSampleQueue",new C(500)),g(this,"unplayedBufferSources",new C(100)),g(this,"sampleRate",48e3),g(this,"channels",2),g(this,"index",0),g(this,"clockSource"),g(this,"clockDelta"),g(this,"startTimeIsInvalidated",!0),g(this,"lastSampleTimestamp",0),g(this,"reInitWhenStuck"),g(this,"ignoreSuspendCalls",!1),g(this,"isActivated",!1),g(this,"unload",(()=>y(this,null,(function*(){var e,t;null==(e=this.gainNode)||e.disconnect(),yield null==(t=this.audio)?void 0:t.unload(),this.reset(),this.audio=void 0,this.gainNode=void 0})))),g(this,"suspend",(()=>{this.setGain(0)})),g(this,"unsuspend",(()=>{var e;this.setGain(this._volume),this.ignoreSuspendCalls=!!this.audio,null==(e=this.audio)||e.suspend().then((()=>y(this,null,(function*(){yield this.resume(),this.ignoreSuspendCalls=!1})))).catch((()=>{this.ignoreSuspendCalls=!1,this.emit("state change","suspended")}))})),g(this,"flush",(()=>{if(!this.audio||!this.gainNode)throw new le("AudioContext must be initialized to flush",{isFatal:!1,code:"audiocontext_must_be_initialized"});const e=this.samples.length/this.channels,t=this.audio.createBufferSource(),i=this.audio.createBuffer(this.channels,e,this.sampleRate);let s=0;for(let t=0;t<this.channels;t++){s=t;const n=i.getChannelData(t);for(let t=0;t<e;t++)n[t]=this.samples[s],s+=this.channels}const n=Math.max(this.startTime,0);t.buffer=i,t.connect(this.gainNode),t.start(n),this.unplayedBufferSources.push([n,t]),this.startTime+=i.duration})),g(this,"onDecodedFrame",(e=>{if(this.gainNode&&this.audio&&this.audio.isRunning){for(;!this.preInitSampleQueue.isEmpty();){const e=this.preInitSampleQueue.items();this.preInitSampleQueue.clear(),e.forEach(this.onDecodedFrame)}if(this.unplayedBufferSources.filterPop((([e,t])=>{var i,s;return(null!=(s=null==(i=this.audio)?void 0:i.currentTime)?s:0)<e})),"audio"===e.type){const t=e.timestamp/e.timescale*1e3;if(t<this.lastSampleTimestamp&&(this.logger.info("Unordered timestamp - invalidating start time"),this.startTimeIsInvalidated=!0),this.lastSampleTimestamp=t,this.startTimeIsInvalidated){const e=1e3*this.audio.currentTime,i=this.clockSource.currentTime,s=(e+t-i)/1e3;this.clockDelta=i-e,this.startTime=s,this.startTimeIsInvalidated=!1,this.unplayedBufferSources.items().forEach((([e,t])=>{s<=e&&t.stop()}))}this.samples.set(e.data,this.index),this.index+=e.data.length,this.channels=e.channels,this.sampleRate=e.sampleRate,this.samples.length<=this.index&&(this.index=0,this.flush())}}else if("audio"===e.type){this.preInitSampleQueue.push(A(m({},e),{data:e.data.slice(0,e.data.length)}));const t=this.clockSource.currentTime;this.preInitSampleQueue.filterPop((({timestamp:e,timescale:i})=>e/i*1e3>t))}})),g(this,"play",(()=>y(this,null,(function*(){this.audio=this.getAudioContext(),yield this.resume()})))),g(this,"pause",(()=>{})),g(this,"flushBuffer",(()=>{this.unplayedBufferSources.items().forEach((([e,t])=>t.stop())),this.index=0})),g(this,"resume",(()=>y(this,null,(function*(){var e;if(!this._userProvidedMuted)try{yield null==(e=this.audio)?void 0:e.resume(),this._muted=this._userProvidedMuted,this.startTimeIsInvalidated=!0}catch(e){throw this._muted=!0,e}})))),g(this,"getAudioContext",(()=>this.audio?this.audio:this.setupContext())),g(this,"setupContext",(()=>{var e,t;return null==(e=this.audio)||e.unload(),this.audio=new Lt,this.audio.on("state",(e=>{this.logger.info("AudioContext state change",{state:e}),"running"===e&&(this._muted=this._userProvidedMuted,this.setGain(this._volume)),!this.ignoreSuspendCalls&&this.emit("state change",e)})),this.audio.on("stuck",(()=>{this.reInitWhenStuck&&(this.logger.info("Re-init audio context"),this.setupContext(),this.resume().catch(q),this.emit("stuck"))})),null==(t=this.gainNode)||t.disconnect(),this.gainNode=this.audio.createGain(),this.setGain(this._volume),this.startTime=this.audio.currentTime,this.audio})),g(this,"setGain",(e=>{this.gainNode&&(this.gainNode.gain.value=this._muted?0:e)})),this._muted=i,this._userProvidedMuted=i,this.logger=e,this.clockSource=t,this.reInitWhenStuck=s}get isContextRunning(){var e;return"running"===(null==(e=this.audio)?void 0:e.state)}get volume(){return this._volume}set volume(e){this._volume=e,this.muted||this.setGain(e)}get seekTime(){return 0}get isSeeking(){return!1}get muted(){var e;return this._muted||!(null!=(e=this.audio)&&e.isRunning)}set muted(e){this._userProvidedMuted=e,this._muted=e,this.setGain(this._volume)}get isPaused(){return!1}get currentTime(){var e;return this.audio&&this.audio.isRunning&&!this.audio.isStuck?1e3*this.audio.currentTime+(null!=(e=this.clockDelta)?e:0):this.clockSource.currentTime}set currentTime(e){this.logger.debug("setting current time to",{currentTime:e}),this.startTimeIsInvalidated=!0}useMediaStreamDestination(){var e;const t=this.getAudioContext().getMediaStreamDestination();return null==(e=this.gainNode)||e.connect(t),t}useDefaultDestination(){var e;const t=this.getAudioContext().getDefaultDestination();return null==(e=this.gainNode)||e.connect(t),t}};g(Dt,"create",((e,t,i)=>new Dt(e,t,i)));let Ot=Dt;var Ft;class Nt{constructor(){v(this,Ft,[]),w(this,Ft,[])}addTextTrack(e,t,i){const s=[],n={kind:e,label:t,language:i,mode:"disabled",cues:s,addCue:e=>{s.push(e)},removeCue:e=>{const t=s.findIndex((t=>t===e));-1!==t&&s.splice(t,1)}};return f(this,Ft).push(n),n}set language(e){f(this,Ft).forEach((t=>{t.language===e?t.mode="showing":t.mode="hidden"}))}get language(){var e;return null==(e=f(this,Ft).find((e=>"showing"===e.mode)))?void 0:e.language}getActiveCues(e){const t=f(this,Ft).find((e=>"showing"===e.mode));return t?t.cues.filter((({startTime:t,endTime:i})=>e>=t&&e<=i)):[]}}Ft=new WeakMap;const Qt=(e,t)=>{let i;for(i=t;e>1;e--)i+=t;return i};class Vt{constructor(){g(this,"audio"),g(this,"unmute",(()=>this.audio.play().catch(q)));const e=document.createElement("div");e.innerHTML="<audio x-webkit-airplay='deny'></audio>";const t=e.children.item(0);if(!(t instanceof HTMLAudioElement))throw new Error("Failed to create audio tag");this.audio=t,this.audio.controls=!1,this.audio.disableRemotePlayback=!0,this.audio.preload="auto",this.audio.src="data:audio/mpeg;base64,//uQx"+Qt(23,"A")+"WGluZwAAAA8AAAACAAACcQCA"+Qt(16,"gICA")+Qt(66,"/")+"8AAABhTEFNRTMuMTAwA8MAAAAAAAAAABQgJAUHQQAB9AAAAnGMHkkI"+Qt(320,"A")+"//sQxAADgnABGiAAQBCqgCRMAAgEAH"+Qt(15,"/")+"7+n/9FTuQsQH//////2NG0jWUGlio5gLQTOtIoeR2WX////X4s9Atb/JRVCbBUpeRUq"+Qt(18,"/")+"9RUi0f2jn/+xDECgPCjAEQAABN4AAANIAAAAQVTEFNRTMuMTAw"+Qt(97,"V")+"Q==",this.audio.loop=!1,this.audio.load()}}var zt,Gt,Wt,Xt,Ht,jt,Zt,qt;class Jt{constructor(){v(this,Ht),v(this,zt,[]),v(this,Gt,document.createElement("canvas")),v(this,Wt),v(this,Xt,window.devicePixelRatio||1),g(this,"config",{backgroundColor:"rgba(0,0,0,0.6)",textPadding:8,fontSize:"28px",lineGap:16});const e=f(this,Gt).getContext("2d",{alpha:!0});if(!e)throw new Error("Failed to create 2d context");w(this,Wt,e),b(this,Ht,Zt).call(this)}get canvas(){return f(this,Gt)}setActiveCues(e){w(this,zt,e)}render(e,t=!1){const i=f(this,zt).flatMap((t=>t.text.split("\n").flatMap((t=>b(this,Ht,qt).call(this,t,e.width))).map((e=>{b(this,Ht,Zt).call(this);const t=f(this,Wt).measureText(e);return{text:e,measurement:t,size:{height:t.fontBoundingBoxAscent+t.fontBoundingBoxDescent+2*this.config.textPadding,width:t.width+2*this.config.textPadding}}})))),s=Math.max(...i.map((e=>e.size.width))),n=i.reduce(((e,{size:t})=>e+t.height),0)+(i.length-1)*this.config.lineGap;let r=0;b(this,Ht,jt).call(this,s,n),f(this,Wt).clearRect(0,0,f(this,Gt).width,f(this,Gt).height);for(const{size:e,text:t}of i)b(this,Ht,Zt).call(this),f(this,Wt).fillStyle=this.config.backgroundColor,f(this,Wt).fillRect(0,r,e.width,e.height),b(this,Ht,Zt).call(this),f(this,Wt).fillText(t,this.config.textPadding,r+this.config.textPadding),r+=e.height+this.config.lineGap;t&&(f(this,Wt).strokeStyle="red",f(this,Wt).strokeRect(0,0,e.width,f(this,Gt).height))}}zt=new WeakMap,Gt=new WeakMap,Wt=new WeakMap,Xt=new WeakMap,Ht=new WeakSet,jt=function(e,t){f(this,Gt).width=e*f(this,Xt),f(this,Gt).height=t*f(this,Xt),f(this,Wt).scale(f(this,Xt),f(this,Xt)),this.canvas.style.width=`${e}px`,this.canvas.style.height=`${t}px`},Zt=function(){f(this,Wt).fillStyle="white",f(this,Wt).textAlign="left",f(this,Wt).textBaseline="top",f(this,Wt).font=`${this.config.fontSize} sans-serif`},qt=function(e,t){const i=[],s=e.split(" ");let n="";for(;s.length>0;){b(this,Ht,Zt).call(this);let e=0;for(;f(this,Wt).measureText(n+(n.length>0?" ":"")+s[0]).width+2*this.config.textPadding<=t&&s.length>0;)e++,n+=(n.length>0?" ":"")+s.shift();0!=e?(i.push(n),n=""):(i.push(s.shift()||""),n="")}return i};const Yt=(e,t)=>{let i=e.getContext("webgl",t);if(i||(i=e.getContext("experimental-webgl",t)),!i)throw new le("Failed to create webgl context",{isFatal:!0,code:"failed_to_create_web_gl_context"});return i},$t=(e,t,i)=>{const s=e.createShader(t);if(!s)throw new le("Failed to create shader",{isFatal:!0,code:"failed_to_create_shader"});if(e.shaderSource(s,i),e.compileShader(s),!e.getShaderParameter(s,e.COMPILE_STATUS)){const t=e.getShaderInfoLog(s);throw new le(`Failed to compile shader: ${null!=t?t:""}`,{isFatal:!0,code:"failed_to_compile_shader"})}return s},Kt=e=>{const t=e.createTexture();if(!t)throw new le("Failed to create texture",{isFatal:!0,code:"failed_to_create_texture"});return e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),t},ei=(e,t)=>{const i=e.createBuffer();if(!i)throw new le("Failed to create buffer",{isFatal:!0,code:"failed_to_create_buffer"});return e.bindBuffer(e.ARRAY_BUFFER,i),e.bufferData(e.ARRAY_BUFFER,t.buffer,e.STATIC_DRAW),i},ti=(e,t,i)=>{const s=e.createProgram();if(!s)throw new le("Failed to create program",{isFatal:!0,code:"failed_to_create_program"});if(e.attachShader(s,i),e.attachShader(s,t),e.linkProgram(s),!e.getProgramParameter(s,e.LINK_STATUS)){const t=e.getShaderInfoLog(s);throw new le(`Failed to link program: ${null!=t?t:""}`,{isFatal:!0,code:"failed_to_link_program"})}return s};var ii,si,ni,ri,oi,ai,hi,di,ci,ui;class li{constructor(e){v(this,hi),v(this,ii,96),v(this,si),v(this,ni),v(this,ri),v(this,oi),v(this,ai),g(this,"subtitleRenderer",new Jt),v(this,ui,((e,t,i,s)=>[e,0,0,0,0,-t,0,0,0,0,1,0,i,s,0,1])),w(this,si,e),w(this,ni,Kt(e)),w(this,ri,$t(e,e.FRAGMENT_SHADER,"\nprecision mediump float;\nuniform sampler2D texture;\n\nvarying vec2 texture_coordinate;\n\nvoid main() {\n  float y = texture2D(texture, texture_coordinate).r;\n  float a = texture2D(texture, texture_coordinate).a;\n\n  gl_FragColor = vec4(y, y, y, a);\n}\n")),w(this,oi,$t(e,e.VERTEX_SHADER,"\n  attribute vec2 position;\n  varying vec2 texture_coordinate;\n  uniform mat4 model;\n\n  void main() {\n    texture_coordinate = position;\n    gl_Position = model * vec4(position, 0.0, 1.0);\n  }\n")),w(this,ai,ti(e,f(this,oi),f(this,ri))),this.subtitleRenderer.config.fontSize="64px"}setActiveCues(e,t){this.subtitleRenderer.setActiveCues(e),this.subtitleRenderer.render(t)}render(e){const t=this.subtitleRenderer.canvas,i=(e.padding+f(this,ii))*window.devicePixelRatio;0!==t.width&&(f(this,si).useProgram(f(this,ai)),b(this,hi,di).call(this),b(this,hi,ci).call(this,this.subtitleRenderer.canvas.width/e.width,this.subtitleRenderer.canvas.height/e.height,-this.subtitleRenderer.canvas.width/e.width/2,-(1-(this.subtitleRenderer.canvas.height+i)/e.height)),f(this,si).uniform1i(f(this,si).getUniformLocation(f(this,ai),"texture"),4),f(this,si).activeTexture(f(this,si).TEXTURE4),f(this,si).bindTexture(f(this,si).TEXTURE_2D,f(this,ni)),f(this,si).enable(f(this,si).BLEND),f(this,si).blendFunc(f(this,si).SRC_ALPHA,f(this,si).ONE_MINUS_SRC_ALPHA),f(this,si).texImage2D(f(this,si).TEXTURE_2D,0,f(this,si).RGBA,f(this,si).RGBA,f(this,si).UNSIGNED_BYTE,t),f(this,si).texParameteri(f(this,si).TEXTURE_2D,f(this,si).TEXTURE_MAG_FILTER,f(this,si).LINEAR),f(this,si).drawArrays(f(this,si).TRIANGLE_STRIP,0,4))}}ii=new WeakMap,si=new WeakMap,ni=new WeakMap,ri=new WeakMap,oi=new WeakMap,ai=new WeakMap,hi=new WeakSet,di=function(){const e=f(this,si).getAttribLocation(f(this,ai),"position");f(this,si).enableVertexAttribArray(e),f(this,si).vertexAttribPointer(e,2,f(this,si).FLOAT,!1,0,0)},ci=function(e,t,i,s){const n=f(this,si).getUniformLocation(f(this,ai),"model");f(this,si).uniformMatrix4fv(n,!1,f(this,ui).call(this,e,t,i,s))},ui=new WeakMap;const mi="\nprecision mediump float;\nuniform sampler2D y_texture;\nuniform sampler2D u_texture;\nuniform sampler2D v_texture;\nuniform mat4 conversion;\n\nvarying vec2 texture_coordinate;\n\nvoid main() {\n  float y = texture2D(y_texture, texture_coordinate).r;\n  float u = texture2D(u_texture, texture_coordinate).r;\n  float v = texture2D(v_texture, texture_coordinate).r;\n\n  gl_FragColor = vec4(y, u, v, 1) * conversion;\n}\n",Ai="\n  attribute vec2 position;\n  varying vec2 texture_coordinate;\n  uniform mat4 model;\n\n  void main() {\n    texture_coordinate = position;\n    gl_Position = model * vec4(position, 0.0, 1.0);\n  }\n",gi={width:256,codedWidth:256,height:144,codedHeight:144},pi={preserveDrawingBuffer:!1,alpha:!1,depth:!1,stencil:!1,antialias:!1,premultipliedAlpha:!1},fi=class e extends s.E{constructor(){super(),g(this,"canvas",document.createElement("canvas")),g(this,"context",Yt(this.canvas,pi)),g(this,"pixelShader",$t(this.context,this.context.FRAGMENT_SHADER,mi)),g(this,"vertexShader",$t(this.context,this.context.VERTEX_SHADER,Ai)),g(this,"buffer",ei(this.context,e.SQUARE_VERTICES)),g(this,"program",ti(this.context,this.vertexShader,this.pixelShader)),g(this,"textures",{y:Kt(this.context),u:Kt(this.context),v:Kt(this.context)}),g(this,"textRenderer"),g(this,"size",gi),g(this,"onContextLost",(e=>{this.textRenderer=void 0;const t=new Error(e instanceof WebGLContextEvent?e.statusMessage:"webgl context lost");this.emit("context lost",new le("WebGL Context Lost",{isFatal:!1,code:"webgl_context_lost_error",source:t,type:"internal"})),e.preventDefault()})),g(this,"onContextRestored",(()=>{this.emit("context restored"),this.context=Yt(this.canvas,pi),this.pixelShader=$t(this.context,this.context.FRAGMENT_SHADER,mi),this.vertexShader=$t(this.context,this.context.VERTEX_SHADER,Ai),this.buffer=ei(this.context,e.SQUARE_VERTICES),this.program=ti(this.context,this.vertexShader,this.pixelShader),this.textures={y:Kt(this.context),u:Kt(this.context),v:Kt(this.context)},this.load()})),g(this,"load",(()=>{this.context.useProgram(this.program),this.setupPositionVertexAttributes(),this.setSize(gi),this.context.uniform1i(this.context.getUniformLocation(this.program,"y_texture"),0),this.context.uniform1i(this.context.getUniformLocation(this.program,"u_texture"),1),this.context.uniform1i(this.context.getUniformLocation(this.program,"v_texture"),2),this.setConversionMatrix(this.rec709())})),g(this,"unload",(()=>{var e;this.setSize({width:1,height:1,codedHeight:1,codedWidth:1}),[this.textures.y,this.textures.u,this.textures.v].forEach((e=>this.context.deleteTexture(e))),this.context.deleteShader(this.pixelShader),this.context.deleteShader(this.vertexShader),this.context.deleteProgram(this.program),this.context.deleteBuffer(this.buffer),this.canvas.removeEventListener("webglcontextlost",this.onContextLost),this.canvas.removeEventListener("webglcontextrestored",this.onContextRestored),null==(e=this.context.getExtension("WEBGL_lose_context"))||e.loseContext()})),g(this,"resetSize",(()=>{this.setSize({width:this.size.width/2,height:this.size.height/2,codedHeight:this.size.codedHeight/2,codedWidth:this.size.codedWidth/2})})),g(this,"render",((e,t)=>{var i;this.context.useProgram(this.program),this.setSize({width:e.width,height:e.height,codedWidth:e.codedWidth,codedHeight:e.codedHeight}),this.setConversionMatrix(this.rec709()),this.setModelMatrix(this.size.width/this.size.codedWidth,this.size.height/this.size.codedHeight),this.context.activeTexture(this.context.TEXTURE0),this.updateTexture(this.textures.y,this.size.codedWidth,this.size.codedHeight,e.data[0]),this.context.activeTexture(this.context.TEXTURE1),this.updateTexture(this.textures.u,this.size.codedWidth/2,this.size.codedHeight/2,e.data[1]),this.context.activeTexture(this.context.TEXTURE2),this.updateTexture(this.textures.v,this.size.codedWidth/2,this.size.codedHeight/2,e.data[2]),this.context.drawArrays(this.context.TRIANGLE_STRIP,0,4),this.textRenderer&&this.textRenderer.render({width:Math.max(t.clientWidth,960)*window.devicePixelRatio,height:Math.max(t.clientHeight,540)*window.devicePixelRatio,padding:-parseInt(null!=(i=t.style.getPropertyValue("--vindral-control-bar-offset"))?i:"0",10)})})),g(this,"updateTexture",((e,t,i,s)=>{const n=this.context.LUMINANCE,r=this.context.UNSIGNED_BYTE;this.context.bindTexture(this.context.TEXTURE_2D,e),this.context.texImage2D(this.context.TEXTURE_2D,0,n,t,i,0,n,r,s)})),g(this,"setupPositionVertexAttributes",(()=>{const e=this.context.getAttribLocation(this.program,"position");this.context.enableVertexAttribArray(e),this.context.vertexAttribPointer(e,2,this.context.FLOAT,!1,0,0)})),g(this,"setSize",(e=>{Q(e,this.size)||(this.size=e,this.canvas.setAttribute("width",e.width.toString()),this.canvas.setAttribute("height",e.height.toString()),this.context.viewport(0,0,e.width,e.height),this.setModelMatrix(e.width/e.codedWidth,e.height/e.codedHeight))})),g(this,"setModelMatrix",((e,t)=>{const i=this.context.getUniformLocation(this.program,"model");this.context.uniformMatrix4fv(i,!1,this.transformMatrix(e,t))})),g(this,"setConversionMatrix",(e=>{const t=this.context.getUniformLocation(this.program,"conversion");this.context.uniformMatrix4fv(t,!1,e)})),g(this,"transformMatrix",((e,t)=>[2/e,0,0,0,0,-2/t,0,0,0,0,2,0,-1,1,0,1])),g(this,"rec709",(()=>[1.16438,0,1.79274,-.97295,1.16438,-.21325,-.53291,.30148,1.16438,2.1124,0,-1.1334,0,0,0,1])),g(this,"rec601",(()=>[1.16438,0,1.59603,-.87079,1.16438,-.39176,-.81297,.52959,1.16438,2.01723,0,-1.08139,0,0,0,1])),this.canvas.addEventListener("webglcontextlost",this.onContextLost),this.canvas.addEventListener("webglcontextrestored",this.onContextRestored,!1),this.canvas.style.width="100%",this.canvas.style.position="relative"}getTextRenderer(){return this.textRenderer||(this.textRenderer=new li(this.context)),this.textRenderer}};g(fi,"SQUARE_VERTICES",new Float32Array([0,0,0,1,1,0,1,1]));let vi=fi;const wi=class{constructor(e,t,i,s){g(this,"oldTimestampLimit",400),g(this,"pool"),g(this,"logger"),g(this,"videoRenderer",new vi),g(this,"renderQueue",[]),g(this,"clockSource"),g(this,"isFirstFrame",!0),g(this,"animationFrameRequest"),g(this,"renderedFrameCount",0),g(this,"rendererDroppedFrameCount",0),g(this,"renderTargetSize"),g(this,"load",(()=>{this.videoRenderer.load()})),g(this,"unload",(()=>(this.stopRender(),this.videoRenderer.unload(),Promise.resolve()))),g(this,"suspend",(()=>{this.renderQueue=[],this.stopRender()})),g(this,"unsuspend",(()=>{this.animationFrameRequest=requestAnimationFrame(this.render)})),g(this,"element",(()=>this.videoRenderer.canvas)),g(this,"getStatistics",(()=>({renderedFrameCount:this.renderedFrameCount,rendererDroppedFrameCount:this.rendererDroppedFrameCount,contextLostCount:0,contextRestoredCount:0}))),g(this,"resetSize",(()=>{this.videoRenderer.resetSize()})),g(this,"setActiveCues",((e,t)=>{this.videoRenderer.getTextRenderer().setActiveCues(e,t)})),g(this,"onDecodedFrame",(e=>{if("video"===e.type)if(this.isFirstFrame)this.isFirstFrame=!1,requestAnimationFrame((()=>{this.renderSample(e)}));else{const t=(this.clockSource.currentTime-this.oldTimestampLimit)/1e3;this.renderQueue=this.renderQueue.filter((i=>{const s=i.timestamp/i.timescale,n=e.timestamp/e.timescale,r=s>t&&s<=n;return r||this.pool.reclaim(i.buffer),r})),this.renderQueue.push(e)}})),g(this,"render",(()=>{const e=this.clockSource.currentTime;let t,i=this.renderQueue[0],s=0;for(;i&&i.timestamp/i.timescale*1e3<=e;)i=this.renderQueue.shift(),i&&(s++,t&&this.pool.reclaim(t.buffer),t=i),i=this.renderQueue[0];t&&this.renderSample(t),this.rendererDroppedFrameCount+=Math.max(s-1,0),this.animationFrameRequest=requestAnimationFrame(this.render)})),g(this,"renderSample",(e=>{this.renderedFrameCount++,this.videoRenderer.render(e,this.renderTargetSize),this.pool.reclaim(e.buffer)})),g(this,"stopRender",(()=>{this.animationFrameRequest&&cancelAnimationFrame(this.animationFrameRequest)})),this.logger=e,this.clockSource=t,this.pool=i,this.renderTargetSize=s||this.videoRenderer.canvas}};g(wi,"create",((e,t,i,s)=>new wi(e,t,i,s)));let bi=wi;const Si=class{constructor(e,t,i,s,n){g(this,"logger"),g(this,"emitter"),g(this,"audioPlayer"),g(this,"videoPlayer"),g(this,"pool"),g(this,"unmuter",new Vt),g(this,"_isPaused",!1),g(this,"isDisconnected",!1),g(this,"timers",new ie),g(this,"textTracks",new Nt),g(this,"playbackRate"),g(this,"reset",(()=>{})),g(this,"load",(()=>{this.audioPlayer.useDefaultDestination(),this.emitter.on("decoded frame",this.onDecodedFrame),this.emitter.on("flush buffers",this.flushBuffers),this.videoPlayer.load(),this.timers.setInterval((()=>{if(!this.textTracks.language)return;const e=this.textTracks.getActiveCues(this.currentTime/1e3);this.videoPlayer.setActiveCues(e,{width:this.videoPlayer.element().clientWidth,height:this.videoPlayer.element().clientHeight})}),100)})),g(this,"unload",(()=>{this.emitter.off("decoded frame",this.onDecodedFrame),this.emitter.off("flush buffers",this.flushBuffers),this.audioPlayer.unload(),this.videoPlayer.unload(),this.timers.unload()})),g(this,"suspend",(()=>{this.videoPlayer.suspend(),this.audioPlayer.suspend()})),g(this,"unsuspend",(()=>{this.videoPlayer.unsuspend(),this.audioPlayer.unsuspend()})),g(this,"element",(()=>this.videoPlayer.element())),g(this,"getStatistics",(()=>this.videoPlayer.getStatistics())),g(this,"flushBuffers",(()=>{this.audioPlayer.flushBuffer()})),g(this,"activateAudioPlayer",(()=>(this.isDisconnected&&(this.isDisconnected=!1,this.audioPlayer.useDefaultDestination()),this._isPaused=!1,this.unmuter.unmute(),this.audioPlayer.play()))),g(this,"onDecodedFrame",(e=>{try{this.audioPlayer.onDecodedFrame(e)}catch(e){e instanceof Error&&this.emitter.emit("error",Ae(!1,e))}this.videoPlayer.onDecodedFrame(e)})),this.logger=t,this.emitter=e,this.pool=i,this.audioPlayer=Ot.create(this.logger.createContext("AudioPlayerModule"),s,{muted:n,reInitWhenStuck:!0}),this.audioPlayer.on("stuck",(()=>{this.isDisconnected=!0})),this.audioPlayer.on("state change",(()=>{this.emitter.emit("volume state",{volume:this.volume,isMuted:this.muted})})),this.videoPlayer=bi.create(this.logger.createContext("VideoPlayerModule"),this.audioPlayer,this.pool)}get volume(){return this.audioPlayer.volume}set volume(e){this.audioPlayer.volume=e}get muted(){return this.audioPlayer.muted}set muted(e){const t=this.muted;this.audioPlayer.muted=e,!e&&t&&this.activateAudioPlayer().catch(q)}get currentTime(){return this.audioPlayer.currentTime}set currentTime(e){this.audioPlayer.currentTime=e}get isActivated(){return this.audioPlayer.isActivated}set isActivated(e){this.audioPlayer.isActivated=e}get seekTime(){return this.audioPlayer.seekTime}get isPaused(){return this._isPaused}get isSeeking(){return this.audioPlayer.isSeeking}play(){this.activateAudioPlayer().then((()=>{this.emitter.emit("media element state","playing")})).catch((()=>{this.emitter.emit("needs user input",{forAudio:!0,forVideo:!1})}))}pause(){this._isPaused=!0,this.audioPlayer.pause(),this.emitter.emit("media element state","paused")}};g(Si,"create",((e,t,i,s,n)=>new Si(e,t,i,s,n)));let yi=Si;const Ei=class{constructor(e,t,i,s,{muted:n,type:r,poster:o}){g(this,"logger"),g(this,"emitter"),g(this,"mediaElement"),g(this,"audioPlayer"),g(this,"videoPlayer"),g(this,"pool"),g(this,"isDisconnected",!0),g(this,"_userProvidedMuted",!1),g(this,"timers",new ie),g(this,"volumeState"),g(this,"textTracks",new Nt),g(this,"reset",(()=>{})),g(this,"load",(()=>{this.mediaElement.load(),this.emitter.on("decoded frame",this.onDecodedFrame),this.emitter.on("flush buffers",this.flushBuffers),this.emitter.on("ios-hack: reset size",this.resetCanvasSize),this.emitter.on("enter picture in picture",this.onEnterIOSHack),this.emitter.on("exit picture in picture",this.onExitIOSHack),this.element().element.addEventListener("webkitendfullscreen",this.onExitIOSHack),this.element().element.addEventListener("webkitbeginfullscreen",this.onEnterIOSHack),this.videoPlayer.load(),this.timers.setInterval((()=>{if(!this.textTracks.language)return;const e=this.textTracks.getActiveCues(this.currentTime/1e3);this.videoPlayer.setActiveCues(e,{width:this.mediaElement.element.clientWidth,height:this.mediaElement.element.clientHeight})}),100)})),g(this,"unload",(()=>{this.emitter.off("decoded frame",this.onDecodedFrame),this.emitter.off("flush buffers",this.flushBuffers),this.emitter.off("ios-hack: reset size",this.resetCanvasSize),this.emitter.off("enter picture in picture",this.onEnterIOSHack),this.emitter.off("exit picture in picture",this.onExitIOSHack),this.element().element.removeEventListener("webkitendfullscreen",this.onExitIOSHack),this.element().element.removeEventListener("webkitbeginfullscreen",this.onEnterIOSHack),this.mediaElement.unload(),this.timers.unload(),this.audioPlayer.unload(),this.videoPlayer.unload()})),g(this,"suspend",(()=>{this.videoPlayer.suspend(),this.audioPlayer.suspend()})),g(this,"unsuspend",(()=>{this.videoPlayer.unsuspend(),this.audioPlayer.unsuspend()})),g(this,"element",(()=>this.mediaElement)),g(this,"getStatistics",(()=>this.videoPlayer.getStatistics())),g(this,"activateAudioPlayer",(()=>(this.isDisconnected&&this.connectStreams(),this.audioPlayer.play()))),g(this,"flushBuffers",(()=>{this.audioPlayer.flushBuffer()})),g(this,"resetCanvasSize",(()=>{this.videoPlayer.resetSize()})),g(this,"onEnterIOSHack",(()=>{this.mediaElement._iosHackEnterPiPMode()})),g(this,"onExitIOSHack",(()=>{this.mediaElement._iosHackExitPiPMode()})),g(this,"onDecodedFrame",(e=>{try{this.audioPlayer.onDecodedFrame(e)}catch(e){e instanceof Error&&this.emitter.emit("error",Ae(!1,e))}this.videoPlayer.onDecodedFrame(e)})),g(this,"connectStreams",(()=>{const e=this.videoPlayer.element().captureStream(),t=this.audioPlayer.useMediaStreamDestination().stream,i=[];i.push(...e.getTracks(),...t.getTracks()),this.mediaElement.element.srcObject=new MediaStream(i),this.isDisconnected=!1})),g(this,"updateVolumeState",(()=>{const e={isMuted:this.muted,volume:this.volume};Q(e,this.volumeState)||(this.volumeState=e,this.emitter.emit("volume state",this.volumeState))})),this.logger=t,this.emitter=e,this.pool=i,this._userProvidedMuted=n,this.mediaElement=new dt({poster:o,type:r,muted:n,autoplay:!1,logger:this.logger.createContext("MediaElement")}),this.mediaElement.on("volume state",(e=>{this.updateVolumeState(),!e.isMuted&&!this.audioPlayer.isContextRunning&&this.activateAudioPlayer().catch(q),e.isMuted||(this._userProvidedMuted=!1)})),this.mediaElement.on("media element state",(e=>{"paused"===e&&this.audioPlayer.flushBuffer(),this.emitter.emit("media element state",e)})),this.audioPlayer=Ot.create(this.logger.createContext("AudioPlayerModule"),s,{muted:!1,reInitWhenStuck:!1}),this.audioPlayer.on("stuck",(()=>{this.isDisconnected=!0})),this.audioPlayer.on("state change",(e=>{"suspended"===e||"interrupted"===e?this.mediaElement.muted=!0:"running"===e&&(this.mediaElement.muted=this._userProvidedMuted||"hidden"===document.visibilityState),this.updateVolumeState()})),this.videoPlayer=bi.create(this.logger.createContext("VideoPlayerModule"),this.audioPlayer,this.pool,this.mediaElement.element),this.volumeState={volume:this.volume,isMuted:this.muted}}get volume(){return this.mediaElement.volume}set volume(e){this.mediaElement.volume=e}get muted(){return this.mediaElement.muted||this.audioPlayer.muted}set muted(e){const t=this.muted;this._userProvidedMuted=e,this.mediaElement.muted=e,!e&&t&&this.activateAudioPlayer().catch(q)}get currentTime(){return this.audioPlayer.currentTime}set currentTime(e){this.audioPlayer.currentTime=e}get isActivated(){return this.mediaElement.isActivated}set isActivated(e){this.mediaElement.isActivated=e}get seekTime(){return this.mediaElement.seekTime}get isPaused(){return this.mediaElement.isPaused}get isSeeking(){return this.mediaElement.isSeeking}play(){const e=this._userProvidedMuted;return this.activateAudioPlayer().catch((()=>{e||this.emitter.emit("needs user input",{forAudio:!0,forVideo:!1})})),this.mediaElement.play()}pause(){this.mediaElement.pause()}};g(Ei,"create",((e,t,i,s,n)=>new Ei(e,t,i,s,n)));let Ci=Ei;const Ti=()=>e=>xi(e.buffered.start(0),e.buffered.end(e.buffered.length-1)),xi=(e,t)=>i=>i.remove(Math.max(0,e),Math.min(Number.POSITIVE_INFINITY,t)),ki=e=>t=>t.appendBuffer(e);class Ii{constructor(e){g(this,"commandQueue",[]),g(this,"sourceBuffer"),g(this,"currentInit"),g(this,"handleQueue",(()=>{var e;this.sourceBuffer.updating||null==(e=this.commandQueue.shift())||e.execute(this.sourceBuffer)})),g(this,"appendBuffer",((e,t)=>new Promise(((i,s)=>{if(t&&this.currentInit!==t){const e=new D(ki(t),i,s);this.commandQueue.push(e),this.currentInit=t}const n=new D(ki(e),i,s);this.commandQueue.push(n),this.handleQueue()})))),g(this,"execute",(e=>new Promise(((t,i)=>{const s=new D((n=e,e=>n(e)),t,i);var n;this.commandQueue.push(s),this.handleQueue()})))),g(this,"buffered",(()=>this.sourceBuffer.buffered)),g(this,"removeFromMediaSource",(e=>{e.removeSourceBuffer(this.sourceBuffer)})),g(this,"changeType",(e=>new Promise(((t,i)=>{const s=new D((n=e,e=>e.changeType(n)),t,i);var n;this.commandQueue.push(s),this.handleQueue()})))),g(this,"removeBuffer",((e,t)=>new Promise(((i,s)=>{const n=new D(xi(e,t),i,s);this.commandQueue.push(n),this.handleQueue()})))),g(this,"flush",(()=>new Promise(((e,t)=>{const i=new D(Ti,e,t);this.commandQueue.push(i),this.handleQueue()})))),this.sourceBuffer=e,this.sourceBuffer.addEventListener("updateend",this.handleQueue)}}class Bi extends s.E{constructor(){super(),g(this,"MediaSource",x()),g(this,"mediaSource",new this.MediaSource),g(this,"isOpen",(()=>"open"===this.mediaSource.readyState)),g(this,"isClosed",(()=>"closed"===this.mediaSource.readyState)),g(this,"isEnded",(()=>"ended"===this.mediaSource.readyState)),g(this,"createObjectURL",(()=>URL.createObjectURL(this.mediaSource))),g(this,"attach",(e=>{const t=e;if("srcObject"in t)try{t.srcObject=this.mediaSource}catch(e){if(e instanceof Error&&"TypeError"!==e.name)throw e;t.src=this.createObjectURL()}else e.src=this.createObjectURL()})),g(this,"detach",(e=>{if(this.mediaSource&&"open"===this.mediaSource.readyState)try{this.mediaSource.endOfStream()}catch(e){}e.srcObject&&(e.srcObject=null),""!==e.src&&(URL.revokeObjectURL(e.src),e.removeAttribute("src")),e.load()})),g(this,"addSourceBuffer",(e=>{const t=this.mediaSource.addSourceBuffer(e);return new Ii(t)})),g(this,"removeSourceBuffer",(e=>{e.removeFromMediaSource(this.mediaSource)})),g(this,"endOfStream",(e=>{this.mediaSource.endOfStream(e)})),g(this,"onSourceOpen",(()=>{this.setDurationIfNeeded(),this.emit("source open")})),g(this,"onSourceEnded",(()=>this.emit("source ended"))),g(this,"onSourceClosed",(()=>this.emit("source close"))),g(this,"setDurationIfNeeded",(()=>{if(Number.isNaN(this.mediaSource.duration)&&"open"===this.mediaSource.readyState){for(let e=0;e<this.mediaSource.sourceBuffers.length;e++){const t=this.mediaSource.sourceBuffers[e];if(null!=t&&t.updating)return}this.mediaSource.duration=Number.POSITIVE_INFINITY}})),this.mediaSource.addEventListener("sourceopen",this.onSourceOpen),this.mediaSource.addEventListener("sourceclose",this.onSourceClosed),this.mediaSource.addEventListener("sourceended",this.onSourceEnded)}}g(Bi,"isTypeSupported",(e=>{var t,i;return null!=(i=null==(t=x())?void 0:t.isTypeSupported(e))&&i}));class Ri{constructor(){g(this,"initSegments",new Map),g(this,"set",((e,t,i)=>{var s;const n=null!=(s=this.initSegments.get(e))?s:new Map;n.set(t,i),this.initSegments.set(e,n)})),g(this,"get",((e,t)=>{var i;return null==(i=this.initSegments.get(e))?void 0:i.get(t)}))}}function Pi(e,{mediaSource:t,mimeType:i}){return A(m({},e),{state:"initialized",mimeType:i,sourceBuffer:t.addSourceBuffer(i),isWorkingOnPendingSamples:!1,sequenceNumber:0,lastBufferCleanupTime:Date.now()})}function Mi({initSegments:e,pendingSamples:t}){return{state:"uninitialized",initSegments:null!=e?e:new Ri,sequenceNumber:0,isWorkingOnPendingSamples:!1,hasFirstSync:!!t,pendingSamples:null!=t?t:[],consecutiveQuotaExceededErrorCount:0,successfulAppendCalls:0}}const _i=class{constructor(e,t,i){g(this,"maxChunkSize",20),g(this,"minConsecutiveErrorsBeforeEmit",5),g(this,"maxSecondsInBuffer",60),g(this,"logger"),g(this,"timers",ie.create()),g(this,"emitter"),g(this,"mediaElement"),g(this,"mediaSource",new Bi),g(this,"trackContexts",new Map),g(this,"autoRecoverFromMediaErrors",!0),g(this,"quotaErrorCount",0),g(this,"recoveredFromErrorCount",0),g(this,"sourceOpenStartTime",Date.now()),g(this,"sourceOpenEndTime",Date.now()),g(this,"pendingTracksToAddSourceBuffers"),g(this,"hasAddedInitialPosterFrame",!0),g(this,"load",(()=>{this.emitter.on("init segment",this.init),this.emitter.on("coded sample",this.onCodedSample),this.emitter.on("flush buffers",this.flushBuffers)})),g(this,"unload",(()=>{this.logger.debug("Unloading module..."),this.emitter.off("init segment",this.init),this.emitter.off("coded sample",this.onCodedSample),this.emitter.off("flush buffers",this.flushBuffers),this.mediaSource.off("source ended",this.onSourceEnded),this.mediaSource.off("source open",this.onSourceOpen),this.mediaSource.detach(this.mediaElement),this.trackContexts.forEach((e=>e.pendingSamples=[])),this.timers.unload(),this.logger.debug("Unloaded module")})),g(this,"getStatistics",(()=>{var e,t,i,s;const n={quotaErrorCount:this.quotaErrorCount,mediaSourceOpenTime:this.sourceOpenEndTime-this.sourceOpenStartTime,successfulAudioAppendsCalls:null==(e=this.trackContexts.get("audio"))?void 0:e.successfulAppendCalls,successfulVideoAppendCalls:null==(t=this.trackContexts.get("video"))?void 0:t.successfulAppendCalls};if(this.mediaElement instanceof HTMLVideoElement){const e=null==(s=(i=this.mediaElement).getVideoPlaybackQuality)?void 0:s.call(i);n.totalVideoFrames=null==e?void 0:e.totalVideoFrames,n.droppedVideoFrames=null==e?void 0:e.droppedVideoFrames}return n})),g(this,"flushBuffers",(()=>{this.trackContexts.forEach((e=>{e.pendingSamples=[],e.hasFirstSync=!1,"uninitialized"!==e.state&&this.mediaSource.isOpen()&&e.sourceBuffer.removeBuffer(0,Number.POSITIVE_INFINITY).catch((e=>{this.logger.error("Failed to remove buffer",e)}))}))})),g(this,"setTrackContexts",((e=new Map)=>{this.logger.debug("setTrackContexts"),["audio","video"].forEach((t=>{var i,s,n,r;const o=null!=(s=null==(i=e.get(t))?void 0:i.pendingSamples)?s:[],a=null==(n=e.get(t))?void 0:n.initSegments;for(;o.length>0&&(null==(r=o[0])||!r.isSync);)o.shift();this.trackContexts.set(t,Mi({pendingSamples:o,initSegments:a}))}))})),g(this,"setSourceBuffers",(e=>y(this,null,(function*(){if(this.mediaSource.isClosed())return void(this.pendingTracksToAddSourceBuffers=e);let t=!0;for(const i of e){const e=this.trackContexts.get(i.type);if(!e||"uninitialized"===e.state||e.mimeType!==i.mimeType){t=!1;break}}if(t)this.logger.debug("Already setup with the correct mime types");else for(const t of e){let e=this.trackContexts.get(t.type);e||(e=Mi({pendingSamples:[],initSegments:new Ri}),this.trackContexts.set(t.type,e)),"initialized"===e.state?t.mimeType!==e.mimeType&&(yield e.sourceBuffer.changeType(t.mimeType)):this.trackContexts.set(t.type,Pi(e,{mimeType:t.mimeType,mediaSource:this.mediaSource}))}})))),g(this,"getBuffer",(e=>{const t=[];if(this.mediaSource.isClosed())return[];const i=this.trackContexts.get(e);if(!i||"uninitialized"===i.state)return[];try{const e=i.sourceBuffer.buffered();if(!e)return[];for(let i=0;i<e.length;i++)t.push({start:1e3*e.start(i),end:1e3*e.end(i)});return t}catch(e){return[]}})),g(this,"init",(({initSegment:e,mimeType:t})=>{this.logger.debug("Added init segment",{channel:e.channelId,renditionId:e.renditionId});const i=this.trackContexts.get(e.type);if(!i)throw pe(e.type,e.renditionId);"initialized"===i.state&&(i.mimeType=t);const s=((e,t,i)=>{switch(e){case"h264":return((e,t)=>((e,t)=>{const{sequenceParameterSets:i,pictureParameterSets:s}=ye(e),n=je(e);return Xe([{type:"video",sequenceParameterSets:i.map((e=>new Uint8Array(e))),pictureParameterSets:s.map((e=>new Uint8Array(e))),width:n.width,height:n.height,timescale:t,duration:0,trackId:1}])})(e,t))(t,i);case"av1":return((e,t)=>((e,t)=>{const i=Ze(e);if(!i)throw new Error("Failed to parse sequence header");return Xe([{type:"video",parsedSequenceHeader:i,sequenceHeader:new Uint8Array(e),width:i.maxFrameWidth,height:i.maxFrameHeight,timescale:t,duration:0,trackId:1}])})(e,t))(t,i);case"opus":return((e,t)=>((e,t,i)=>Xe([{type:"audio",trackId:1,channelCount:2,timescale:i,codec:"opus",decoderConfig:e,duration:0,sampleRate:48e3}]))(new Uint8Array(e),0,t))(t,i);case"aac":return((e,t)=>((e,t,i,s)=>Xe([{type:"audio",codec:"aac",decoderConfig:e,channelCount:2,sampleRate:i,timescale:s,duration:0,trackId:1}]))(new Uint8Array(e),0,t,t))(t,i);default:throw new Error(`Failed to initialize ${e} segment`)}})(e.codec,e.data,e.timescale);s&&i.initSegments.set(e.channelId,e.renditionId,s)})),g(this,"append",((e,t)=>y(this,null,(function*(){var i;const s=e[0];if(!s)return;const n=this.trackContexts.get(s.type),r=null==n?void 0:n.initSegments.get(s.channelId,s.renditionId);if(this.mediaSource.isClosed())return;if(!r)throw((e,t)=>new le(`No init segment for rendition id ${e} for channel ${t}`,{isFatal:!1,code:"missing_init_segment",type:"internal"}))(s.renditionId,s.channelId);if(!n)throw pe(s.type,s.renditionId);if("uninitialized"===n.state)throw((e,t)=>new le(`Track context is in an invalid state for ${e}${t?`, rendition id ${t}`:""}`,{isFatal:!1,code:"invalid_track_context_state",type:"internal"}))(s.type,s.renditionId);if(t){const e=(s.timestamp+(null!=(i=s.compositionTimeOffset)?i:0))/s.timescale;yield n.sourceBuffer.removeBuffer(e,Number.POSITIVE_INFINITY);const t=n.previousSample;if(t&&t.codec!==s.codec&&n.sourceBuffer.changeType)try{yield n.sourceBuffer.changeType(n.mimeType)}catch(e){}yield n.sourceBuffer.appendBuffer(r)}const o=Math.max(0,s.timestamp/s.timescale-this.maxSecondsInBuffer);o>0&&Date.now()-n.lastBufferCleanupTime>1e4&&(n.lastBufferCleanupTime=Date.now(),yield n.sourceBuffer.removeBuffer(0,o+10));try{let t=n.sequenceNumber;const i=Di(e.map((e=>((e,t)=>{switch(e.codec){case"h264":case"av1":return(({isSync:e,timestamp:t,data:i,duration:s,compositionTimeOffset:n},r)=>He({trackId:1,timestamp:t,sequenceNumber:r,defaultSize:i.byteLength,defaultFlags:e?33554432:16842752,defaultDuration:s,samples:[{isSync:e,data:new Uint8Array(i),duration:s,compositionTimeOffset:n}]}))(e,t);case"opus":case"aac":return(({isSync:e,timestamp:t,data:i,duration:s},n)=>He({trackId:1,timestamp:t,sequenceNumber:n,defaultSize:i.byteLength,defaultFlags:33554432,defaultDuration:s,samples:[{isSync:e,data:new Uint8Array(i),duration:s}]}))(e,t);default:throw new Error(`Unsupported codec ${e.codec}`)}})(e,t++))));yield n.sourceBuffer.appendBuffer(i),n.sequenceNumber=t,n.consecutiveQuotaExceededErrorCount=0,n.successfulAppendCalls++}catch(t){throw t instanceof DOMException&&(t.code===DOMException.QUOTA_EXCEEDED_ERR?(this.quotaErrorCount++,n.consecutiveQuotaExceededErrorCount++,this.logger.error("quota exceeded error",{error:t}),n.pendingSamples.unshift(...e)):this.mediaElement.error&&n.pendingSamples.unshift(...e)),t}})))),g(this,"onCodedSample",(e=>{if(0===e.duration)return;const t=this.trackContexts.get(e.type);if(!t)throw pe(e.type,e.renditionId);if(t.hasFirstSync||e.isSync){if(this.hasAddedInitialPosterFrame&&e.isSync&&"video"===e.type){this.hasAddedInitialPosterFrame=!1;const i=m({},e);i.timestamp=0,t.pendingSamples.push(i)}t.hasFirstSync=!0,t.pendingSamples.push(e),"uninitialized"!==t.state&&(t.isWorkingOnPendingSamples||Oi(t,this.append,this.maxChunkSize).catch((i=>{if(t.isWorkingOnPendingSamples=!1,i instanceof Error){if(this.logger.error("append failed",{message:i.message,name:i.name}),i instanceof DOMException&&i.code===DOMException.QUOTA_EXCEEDED_ERR){if(t.consecutiveQuotaExceededErrorCount>=this.minConsecutiveErrorsBeforeEmit){const s=ge(!1,i,t.consecutiveQuotaExceededErrorCount,e.type);this.emitter.emit("error",s)}}else{const s=ge(!1,i,t.consecutiveQuotaExceededErrorCount,e.type);this.emitter.emit("error",s)}this.mediaElement.error&&this.onSourceEnded()}})))}})),g(this,"onSourceOpen",(()=>{this.logger.debug("source opened"),this.sourceOpenEndTime=Date.now(),this.pendingTracksToAddSourceBuffers&&(this.setSourceBuffers(this.pendingTracksToAddSourceBuffers),this.pendingTracksToAddSourceBuffers=void 0)})),g(this,"onSourceEnded",(()=>{const{error:e}=this.mediaElement;if(e){const t=((e,t)=>new le("MediaElement Error",{isFatal:e,code:"media_element_error",source:t},{mediaErrorCode:t.code}))(/AUDIO_RENDERER/.test(e.message)||!this.autoRecoverFromMediaErrors,e);if(this.logger.error("MediaElement error",{error:t}),this.emitter.emit("error",t),!t.isFatal()){this.logger.info("Re-opening MediaSource"),this.emitter.emit("recovered from media error",{error:t,count:this.recoveredFromErrorCount}),this.recoveredFromErrorCount++;const e=!this.mediaElement.paused,i=[];this.trackContexts.forEach(((e,t)=>{"initialized"===e.state&&i.push({type:t,mimeType:e.mimeType})})),this.sourceOpenStartTime=Date.now(),this.pendingTracksToAddSourceBuffers=i,this.mediaElement.src="",this.setTrackContexts(this.trackContexts),this.mediaSource.attach(this.mediaElement),e&&this.mediaElement.play().catch(q)}}this.logger.debug("source ended")})),this.logger=e,this.mediaElement=i,this.emitter=t}};g(_i,"create",((e,t,i)=>{const s=new _i(e,t,i);return s.setTrackContexts(),s.mediaSource.on("source ended",s.onSourceEnded),s.mediaSource.on("source open",s.onSourceOpen),s.mediaSource.attach(i),s}));let Ui=_i;const Li=(e,t)=>{var i;const s=e.renditionId!==t.renditionId,n=e.channelId!==t.channelId,r=(null!=(i=e.timestamp)?i:0)>t.timestamp;let o=!1;return"video"===e.type&&"video"===t.type&&(o=t.width!==e.width||t.height!==e.height),n||s||r||o},Di=function(e){const t=e.reduce(((e,t)=>e+t.byteLength),0),i=new Uint8Array(t);let s=0;return e.forEach((e=>{i.set(new Uint8Array(e),s),s+=e.byteLength})),i.buffer},Oi=(e,t,i)=>y(void 0,null,(function*(){for(e.isWorkingOnPendingSamples=!0;e.pendingSamples.length>0;){const s=[];let n=0;for(let t=0;t<e.pendingSamples.length;t++){n=t;const r=e.pendingSamples[t],o=e.pendingSamples[t+1];if(r&&(s.push(r),o&&Li(r,o))||t===i-1)break}const r=s[0];if(!r)break;const o=!e.previousSample||Li(e.previousSample,r);yield t(s,o),e.pendingSamples=e.pendingSamples.slice(n+1),e.previousSample=s[s.length-1]}e.isWorkingOnPendingSamples=!1})),Fi=class{constructor(e,t){g(this,"logger"),g(this,"emitter"),g(this,"element"),g(this,"pictureInPictureWindow"),g(this,"unload",(()=>{this.emitter.off("add picture in picture listener",this.onEnablePictureInPicture)})),g(this,"onEnablePictureInPicture",(e=>{this.element=e.element,e.element.addEventListener("leavepictureinpicture",(()=>{this.pictureInPictureWindow=void 0,this.logger.debug("Leave picture in picture"),this.emitter.emit("exit picture in picture")})),e.element.addEventListener("enterpictureinpicture",(e=>{this.pictureInPictureWindow=e.pictureInPictureWindow,this.logger.debug("Enter picture in picture"),this.emitter.emit("enter picture in picture",this)})),e.element.autopictureinpicture=!0})),g(this,"getPictureInPictureSize",(()=>this.pictureInPictureWindow)),g(this,"isPictureInPictureActive",(()=>this.isWebkitPresentationModeActive()||this.isStandardPictureInPictureActive())),g(this,"isPictureInPictureSupported",(()=>this.isWebkitPresentationModeSupported()||this.isStandardPictureInPictureSupported())),g(this,"requestPictureInPicture",(()=>(this.emitter.emit("ios-hack: reset size"),this.isStandardPictureInPictureSupported()?this.requestStandardPictureInPicture():this.isWebkitPresentationModeSupported()?this.requestWebkitPresentationMode("picture-in-picture"):Promise.reject(new Error("Picture in picture is not supported"))))),g(this,"exitPictureInPicture",(()=>this.isStandardPictureInPictureSupported()?this.exitStandardPictureInPicture():this.isWebkitPresentationModeSupported()?this.requestWebkitPresentationMode("inline"):Promise.reject(new Error("Picture in picture is not supported")))),g(this,"getStatistics",(()=>({isPictureInPictureActive:this.isPictureInPictureActive()}))),g(this,"requestStandardPictureInPicture",(()=>y(this,null,(function*(){return yield this.element.requestPictureInPicture()})))),g(this,"exitStandardPictureInPicture",(()=>y(this,null,(function*(){return yield document.exitPictureInPicture()})))),g(this,"isStandardPictureInPictureSupported",(()=>!!this.element&&!!this.element.requestPictureInPicture&&!!document.pictureInPictureEnabled)),g(this,"isStandardPictureInPictureActive",(()=>!!this.element&&!!document.pictureInPictureElement)),g(this,"isWebkitPresentationModeActive",(()=>!!this.element&&"picture-in-picture"===this.element.webkitPresentationMode)),g(this,"requestWebkitPresentationMode",(e=>y(this,null,(function*(){return this.element.webkitSetPresentationMode(e),Promise.resolve()})))),g(this,"isWebkitPresentationModeSupported",(()=>!!this.element&&!!this.element.webkitSetPresentationMode)),this.emitter=e,this.logger=t,this.emitter.on("add picture in picture listener",this.onEnablePictureInPicture)}};g(Fi,"create",((e,t)=>new Fi(e,t)));let Ni=Fi;const Qi=class{constructor(e,t,i,s){g(this,"emitter"),g(this,"logger"),g(this,"clockSource"),g(this,"state","buffering"),g(this,"bufferFullness",0),g(this,"targetBufferTime"),g(this,"lastBufferStateEvent","drained"),g(this,"firstFrameTime"),g(this,"currentTimeIsInRange",!1),g(this,"needsInputForAudioCount",0),g(this,"needsInputForVideoCount",0),g(this,"unload",(()=>{this.emitter.off("buffer state",this.onBufferedStateChanged),this.emitter.off("needs user input",this.onNeedsUserInput)})),g(this,"setTargetBufferTime",(e=>{this.targetBufferTime=e})),g(this,"getTargetBufferTime",(()=>this.targetBufferTime)),g(this,"getBufferFullness",(()=>this.bufferFullness)),g(this,"getLastBufferStateEvent",(()=>this.lastBufferStateEvent)),g(this,"getState",(()=>this.state)),g(this,"getFirstFrameTime",(()=>this.firstFrameTime)),g(this,"getStatistics",(()=>({bufferTime:this.targetBufferTime,needsInputForAudioCount:this.needsInputForAudioCount,needsInputForVideoCount:this.needsInputForVideoCount}))),g(this,"onBufferedStateChanged",(({buffered:e,isPaused:t})=>{const i=this.clockSource.currentTime,s=e.some((e=>e.start<i&&i<e.end)),n=e[e.length-1],r=!!n&&n.end-n.start>=this.targetBufferTime,o=n?Math.max(0,n.end-i)/this.targetBufferTime:0,a=t?"paused":s?"playing":"buffering",h=this.state;this.currentTimeIsInRange===s||s?s&&r&&"drained"===this.lastBufferStateEvent&&(this.lastBufferStateEvent="filled",this.emitter.emit("buffer state event",this.lastBufferStateEvent)):(this.lastBufferStateEvent="drained",this.emitter.emit("buffer state event",this.lastBufferStateEvent)),"playing"===a&&!this.firstFrameTime&&(this.firstFrameTime=Date.now()),this.currentTimeIsInRange=s,this.state=a,this.bufferFullness=s?o:0,h!==a&&this.emitter.emit("playback state",a),this.emitter.emit("buffer fullness",this.bufferFullness)})),g(this,"onNeedsUserInput",(({forAudio:e,forVideo:t})=>{e&&this.needsInputForAudioCount++,t&&this.needsInputForVideoCount++})),this.emitter=e,this.logger=t,this.clockSource=i,this.targetBufferTime=s,this.emitter.on("buffer state",this.onBufferedStateChanged),this.emitter.on("needs user input",this.onNeedsUserInput)}};g(Qi,"create",((e,t,i,s)=>new Qi(e,t,i,s)));let Vi=Qi;const zi=()=>({upgradesFromLevel:[],downgradesFromLevel:[],bufferingRanges:[],activeRanges:[],decodeRate:Number.MAX_SAFE_INTEGER}),Gi=class{constructor(e,t){g(this,"minBufferFullnessLengthForRegression",6),g(this,"logger"),g(this,"emitter"),g(this,"timers",ie.create()),g(this,"metrics",{levels:{},levelDowngrades:[],levelUpgrades:[],bufferFullness:0,general:zi()}),g(this,"bufferFullness",new C(30)),g(this,"bufferFullnessRegression"),g(this,"currentLevel"),g(this,"isSuspended",!1),g(this,"_fatalQosCount",0),g(this,"hasAsserted",!1),g(this,"load",(()=>{this.emitter.on("playback state",this.onPlaybackState),this.emitter.on("buffer fullness",this.onBufferFullness),this.emitter.on("rendition level changed",this.onRenditionLevelChanged),this.emitter.on("video decode rate",this.onVideoDecodeRate)})),g(this,"unload",(()=>{this.emitter.off("playback state",this.onPlaybackState),this.emitter.off("buffer fullness",this.onBufferFullness),this.emitter.off("rendition level changed",this.onRenditionLevelChanged),this.emitter.off("video decode rate",this.onVideoDecodeRate),this.suspend()})),g(this,"suspend",(()=>{this.isSuspended=!0,this.timers.unload(),this.stopBuffering(),this.unsetActive()})),g(this,"unsuspend",(()=>{this.isSuspended=!1,this.currentLevel&&this.setActive()})),g(this,"fatalQosGraceTime",(()=>1e4*(this.fatalQosCount+1))),g(this,"incrementFatalQosCount",(()=>{this._fatalQosCount++})),g(this,"getMetrics",(()=>this.metrics)),g(this,"getLevelStats",(e=>{var t,i,s,n;const r=(null!=(i=null==(t=e.video)?void 0:t.bitRate)?i:0)+(null!=(n=null==(s=e.audio)?void 0:s.bitRate)?n:0);return this.metrics.levels[r]})),g(this,"getBufferFullnessRegression",(()=>this.bufferFullnessRegression)),g(this,"activeRatios",(()=>{const e=new Map,t=K(this.metrics.general.activeRanges);if(Object.entries(this.metrics.levels).forEach((([i,s])=>{e.set(i,t?K(s.activeRanges)/t:0)})),!this.hasAsserted){const t=!e.size||Math.abs(Array.from(e.values()).reduce(((e,t)=>e+t),0)-1)<=.02;t||(this.hasAsserted=!0,console.assert(t,`Active ratios should be close to 1 - actual: ${Array.from(e.values()).reduce(((e,t)=>e+t),0)}`))}return e})),g(this,"bufferingRatios",(()=>{const e=new Map,t=K(this.metrics.general.bufferingRanges);if(Object.entries(this.metrics.levels).forEach((([i,s])=>{e.set(i,t?K(s.bufferingRanges)/t:0)})),!this.hasAsserted){const t=Array.from(e.values()).reduce(((e,t)=>e+t),0)<=1;t||(this.hasAsserted=!0,console.assert(t,`Buffering ratios should be less than 1 - actual: ${Array.from(e.values()).reduce(((e,t)=>e+t),0)}`))}return e})),g(this,"bufferingEventsLast",(e=>this.metrics.general.bufferingRanges.filter((t=>t.start>=Date.now()-e)).length)),g(this,"timeSpentBufferingLast",(e=>ee(this.metrics.general.bufferingRanges,e))),g(this,"timeSpentActiveLast",(e=>ee(this.metrics.general.activeRanges,e))),g(this,"timeSpentPlayingInAtLeastLevelRatio",(e=>{var t,i,s,n;const r=this.timeSpentBuffering(),o=this.timeActive(),a=this.bufferingRatios(),h=this.activeRatios(),d=(null!=(i=null==(t=e.video)?void 0:t.bitRate)?i:0)+(null!=(n=null==(s=e.audio)?void 0:s.bitRate)?n:0),c=r/o;return Object.keys(this.metrics.levels).map((e=>parseInt(e,10))).filter((e=>e>=d)).reduce(((e,t)=>{var i,s;return(null!=(i=h.get(t.toString()))?i:0)-(null!=(s=a.get(t.toString()))?s:0)*c+e}),0)})),g(this,"timeSpentBuffering",(()=>K(this.metrics.general.bufferingRanges))),g(this,"timeActive",(()=>K(this.metrics.general.activeRanges))),g(this,"getStatistics",(()=>({timeSpentBuffering:this.timeSpentBuffering(),bufferingEventsCount:this.metrics.general.bufferingRanges.length,timeSpentRatio:[...this.activeRatios()].reduce(((e,[t,i])=>(e[t]=i,e)),{}),fatalQosCount:this.fatalQosCount}))),g(this,"onRenditionLevelChanged",(e=>{var t,i,s,n,r,o,a,h,d,c,u,l,m,A;const g=(null!=(s=null==(i=null==(t=e.from)?void 0:t.video)?void 0:i.bitRate)?s:0)+(null!=(o=null==(r=null==(n=e.from)?void 0:n.audio)?void 0:r.bitRate)?o:0),p=(null!=(d=null==(h=null==(a=e.to)?void 0:a.video)?void 0:h.bitRate)?d:0)+(null!=(l=null==(u=null==(c=e.to)?void 0:c.audio)?void 0:u.bitRate)?l:0);this.logger.info("rendition level changed",{fromLevel:g,toLevel:p}),0===this.metrics.general.activeRanges.length&&this.setActive(),e.from&&e.to&&(g<p?this.metrics.general.upgradesFromLevel.push(Date.now()):this.metrics.general.downgradesFromLevel.push(Date.now()));let f=!1;if(e.from){const e=null!=(m=this.metrics.levels[g])?m:zi();g<p?e.upgradesFromLevel.push(Date.now()):e.downgradesFromLevel.push(Date.now()),Y(e.activeRanges);const t=e.bufferingRanges[e.bufferingRanges.length-1];f=!!t&&!t.end,Y(e.bufferingRanges),this.metrics.levels[g]=e}if(e.to){const e=null!=(A=this.metrics.levels[p])?A:zi();$(e.activeRanges),f&&$(e.bufferingRanges),this.metrics.levels[p]=e,this.currentLevel=p}})),g(this,"onBufferFullness",(e=>{this.bufferFullness.push(e),this.metrics.bufferFullness=e,this.bufferFullness.items().length>=this.minBufferFullnessLengthForRegression&&(this.bufferFullnessRegression=this.calculateLinearRegression())})),g(this,"onPlaybackState",(e=>{switch(this.logger.info("Playback state",{state:e,currentLevel:this.currentLevel}),e){case"playing":this.stopBuffering();break;case"buffering":this.isSuspended||this.startBuffering()}})),g(this,"onVideoDecodeRate",(e=>{var t;if(this.metrics.general.decodeRate=e,!this.currentLevel)return;const i=this.metrics.levels[null!=(t=this.currentLevel)?t:0];i&&(i.decodeRate=e)})),g(this,"calculateLinearRegression",(()=>(e=>{let t=0,i=0,s=0,n=0,r=0;for(let o=0;o<e.length;o++){const{x:a,y:h}=e[o];t+=a,i+=h,s+=a*h,n+=a*a,r+=h*h}const o=(e.length*s-t*i)/(e.length*n-t*t),a=(i-o*t)/e.length,h=Math.pow((e.length*s-t*i)/Math.sqrt((e.length*n-t*t)*(e.length*r-i*i)),2);return{slope:o,intercept:a,r2:h,predict:t=>o*(e.length+t)+a}})(this.bufferFullness.items().map(((e,t)=>({x:t,y:e})))))),g(this,"stopBuffering",(()=>{if(this.currentLevel){const e=this.metrics.levels[this.currentLevel];e&&Y(e.bufferingRanges)}Y(this.metrics.general.bufferingRanges)})),g(this,"startBuffering",(()=>{if(this.currentLevel){const e=this.metrics.levels[this.currentLevel];e&&$(e.bufferingRanges)}$(this.metrics.general.bufferingRanges)})),g(this,"unsetActive",(()=>{if(this.currentLevel){const e=this.metrics.levels[this.currentLevel];e&&Y(e.activeRanges)}Y(this.metrics.general.activeRanges)})),this.logger=t,this.emitter=e}get fatalQosCount(){return this._fatalQosCount}setActive(){if(this.currentLevel){const e=this.metrics.levels[this.currentLevel];e&&$(e.activeRanges)}$(this.metrics.general.activeRanges)}};g(Gi,"create",((e,t)=>new Gi(e,t)));let Wi=Gi;const Xi=class{constructor(e,t){g(this,"renditions",new Map),g(this,"renditionLevels",[]),g(this,"languages",[]),g(this,"emitter"),g(this,"subscriptionSource"),g(this,"renditionLevelChangeCount",0),g(this,"unload",(()=>{this.emitter.off("renditions",this.onRenditions),this.emitter.off("subscription changed",this.onSubscriptionChanged)})),g(this,"getRenditionLevels",(e=>e?this.createRenditionLevels(e):this.renditionLevels)),g(this,"getRenditionLevel",(e=>{var t;const i=null!=e?e:this.getCurrentSubscription(),s=e?this.createRenditionLevels(e):this.renditionLevels;if(!i.video)return s.length?s[0]:void 0;const n=i.video.bitRate||Number.MAX_SAFE_INTEGER,r=i.video.width||Number.MAX_SAFE_INTEGER,o=i.video.height||Number.MAX_SAFE_INTEGER;return null!=(t=s.filter((e=>!e.video||!i.video||e.video.bitRate<=n&&e.video.width<=r&&e.video.height<=o)).pop())?t:s[0]})),g(this,"setRenditions",((e,t)=>{this.renditions.set(e,t)})),g(this,"getLanguages",(()=>this.languages)),g(this,"getVideoRendition",((e,t=this.getCurrentSubscription().channelId)=>{const i=this.getRendition(e,t);if(i&&oe(i))return i})),g(this,"getAudioRenditions",(e=>{const t=this.renditions.get(e);return null==t?void 0:t.filter((e=>ae(e)))})),g(this,"getVideoRenditions",(e=>{const t=this.renditions.get(e);return null==t?void 0:t.filter((e=>oe(e)))})),g(this,"getAudioRendition",((e,t=this.getCurrentSubscription().channelId)=>{const i=this.getRendition(e,t);if(i&&ae(i))return i})),g(this,"getRendition",((e,t=this.getCurrentSubscription().channelId)=>{var i;return null==(i=this.renditions.get(t))?void 0:i.find((t=>t.id===e))})),g(this,"getStatistics",(()=>{var e,t,i,s,n,r,o,a,h,d;const c=this.getRenditionLevel();return{videoCodec:null==(e=null==c?void 0:c.video)?void 0:e.codec,audioCodec:null==(t=null==c?void 0:c.audio)?void 0:t.codec,videoRenditionId:null==(i=null==c?void 0:c.video)?void 0:i.id,audioRenditionId:null==(s=null==c?void 0:c.audio)?void 0:s.id,videoWidth:null==(n=null==c?void 0:c.video)?void 0:n.width,videoHeight:null==(r=null==c?void 0:c.video)?void 0:r.height,expectedVideoBitRate:null==(o=null==c?void 0:c.video)?void 0:o.bitRate,expectedAudioBitRate:null==(a=null==c?void 0:c.audio)?void 0:a.bitRate,frameRate:null==(h=null==c?void 0:c.video)?void 0:h.frameRate,language:null==(d=null==c?void 0:c.audio)?void 0:d.language,renditionLevelChangeCount:this.renditionLevelChangeCount}})),g(this,"onRenditions",(e=>{const t=this.subscriptionSource.getCurrentSubscription();this.renditions.set(e.channelId,e.renditions),this.updateRenditionLevels({to:t,from:t})})),g(this,"onSubscriptionChanged",(e=>{this.updateRenditionLevels(e)})),g(this,"updateRenditionLevels",(({to:e,from:t})=>{var i;const{channelId:s,initiator:n}=e,r=this.getRenditionLevel(t),o=new Set;(null!=(i=this.renditions.get(s))?i:[]).filter((e=>"webvtt"!==e.codec)).forEach((e=>e.language?o.add(e.language):void 0)),this.languages=Array.from(o),this.renditionLevels=this.createRenditionLevels(e);const a=this.getRenditionLevel(e);Q(r,a)||(this.renditionLevelChangeCount++,this.emitter.emit("rendition level changed",{to:a,from:r,reason:n?"manual":"abr"}))})),g(this,"createRenditionLevels",(e=>{var t;const{video:i,audio:s,channelId:n}=e,r=null!=(t=this.renditions.get(n))?t:[],o=r.filter(oe).filter((e=>i&&e.codec===i.codec)),a=r.filter(ae).filter((e=>s&&e.codec===s.codec&&e.language===s.language)),h=Math.max(o.length,a.length),d=[];for(let e=0;e<h;e++){const t=o[Math.min(o.length-1,e)],i=a[Math.min(a.length-1,e)];d.push({audio:i,video:t})}return d})),g(this,"getCurrentSubscription",(()=>this.subscriptionSource.getCurrentSubscription())),this.subscriptionSource=t,this.emitter=e,this.emitter.on("renditions",this.onRenditions),this.emitter.on("subscription changed",this.onSubscriptionChanged)}};g(Xi,"create",((e,t)=>new Xi(e,t)));let Hi=Xi;const ji=e=>JSON.parse(JSON.stringify(e)),Zi=class{constructor(e,t,i){g(this,"logger"),g(this,"timers",new ie),g(this,"emitter"),g(this,"targetSubscription"),g(this,"currentSubscription"),g(this,"_isSwitchingSubscription",!1),g(this,"pendingSubscriptionTimeoutId"),g(this,"burstMs",0),g(this,"unload",(()=>{this.logger.debug("Unloading module..."),this.timers.unload(),this.emitter.off("subscription changed",this.onSubscriptionChanged),this.logger.debug("Unloaded module")})),g(this,"isSwitchingSubscription",(()=>this._isSwitchingSubscription)),g(this,"getTargetSubscription",(()=>this.targetSubscription)),g(this,"getCurrentSubscription",(()=>this.currentSubscription)),g(this,"enableBurst",(e=>{this.burstMs=e})),g(this,"setSize",(e=>{this.targetSubscription.video.width=e.width,this.targetSubscription.video.height=e.height,this.scheduleSubscriptionChange()})),g(this,"setVideoConstraint",(e=>{this.targetSubscription.video=e,this.scheduleSubscriptionChange()})),g(this,"setAudioConstraint",(e=>{this.targetSubscription.audio=e,this.scheduleSubscriptionChange()})),g(this,"setVideoBitRate",(e=>{this.targetSubscription.video.bitRate=e,this.scheduleSubscriptionChange()})),g(this,"setAudioBitRate",(e=>{this.targetSubscription.audio.bitRate=e,this.scheduleSubscriptionChange()})),g(this,"setChannelId",(e=>{this.targetSubscription.channelId=e,this.scheduleSubscriptionChange()})),g(this,"setLanguage",(e=>{this.targetSubscription.audio.language=e,this.scheduleSubscriptionChange()})),g(this,"setVideoCodec",(e=>{this.targetSubscription.video.codec=e,this.scheduleSubscriptionChange()})),g(this,"setAudioCodec",(e=>{this.targetSubscription.audio.codec=e,this.scheduleSubscriptionChange()})),g(this,"setBurst",(e=>{e?this.targetSubscription.burstMs=e:delete this.targetSubscription.burstMs})),g(this,"isNewSubscription",(()=>{const e=["burstMs","meta","initiator","channelGroupId"];return!Q(J(this.currentSubscription,e),J(this.targetSubscription,e))})),g(this,"onSubscriptionChanged",(({to:e})=>{this.logger.debug("onSubscriptionChanged",{to:e}),this.currentSubscription=m({},e),this._isSwitchingSubscription=this.isNewSubscription()})),g(this,"scheduleSubscriptionChange",(()=>{this.targetSubscription=ji(this.targetSubscription),this._isSwitchingSubscription=this.isNewSubscription();const e=this.currentSubscription.channelId!==this.targetSubscription.channelId;this._isSwitchingSubscription&&(e&&this.burstMs?this.setBurst(this.burstMs):this.setBurst(0),this.pendingSubscriptionTimeoutId&&(this.timers.clearTimeout(this.pendingSubscriptionTimeoutId),this.pendingSubscriptionTimeoutId=void 0),this.pendingSubscriptionTimeoutId=this.timers.setTimeout((()=>this.emitter.emit("send signal",JSON.stringify({type:"subscribe",subscription:this.getTargetSubscription()}))),0))})),this.logger=e,this.targetSubscription=t,this.currentSubscription=ji(t),this.emitter=i,this.emitter.on("subscription changed",this.onSubscriptionChanged)}};g(Zi,"create",((e,t,i)=>new Zi(e,i,t)));let qi=Zi;const Ji=()=>M()||_()||-1!==I.indexOf("CrKey")?100:0,Yi=e=>t=>t>e,$i=class{constructor(e,t,i,s,n){g(this,"emitter"),g(this,"logger"),g(this,"playbackSource"),g(this,"bufferSource"),g(this,"keyframeTimestamps",new C(10)),g(this,"lastSeekTime",Date.now()),g(this,"seekCooldownTime",1e3),g(this,"seekTimeoutTime",5e3),g(this,"seekKeyframeOvershoot",50),g(this,"syncMaxBehind"),g(this,"syncMaxBehindMultiplierStep",1),g(this,"syncMaxBehindIncreaseEvery",2),g(this,"syncMaxBehindMaximumAllowed",2e3),g(this,"syncMaxBehindMultiplier",1),g(this,"timeshiftOnAudio",!1),g(this,"syncMaxAhead",150),g(this,"timeshiftSync",{enabled:!1,maxBehind:50,multiplier:1,maxBehindAllowed:600,overshoot:Ji(),minOvershootAllowed:Ji(),maxOvershootAllowed:500}),g(this,"maxTimeSyncDifferenceTolerance",150),g(this,"timers",ie.create()),g(this,"rtt",0),g(this,"channelSyncInfo",new Map),g(this,"driftAdjustmentsCount",0),g(this,"timeshiftDriftAdjustmentCount",0),g(this,"driftAdjustments",[]),g(this,"timeShiftAdjustments",[]),g(this,"timestampOffset"),g(this,"currentChannelId"),g(this,"highestSeenTimestamps",new Map),g(this,"isSuspended",!1),g(this,"isSyncAdjustmentActivated",!1),g(this,"load",(()=>{this.timers.setInterval(this.onSync,100)})),g(this,"unload",(()=>{this.logger.debug("Unloading module..."),this.emitter.off("rtt",this.updateRtt),this.timers.unload(),this.logger.debug("Unloaded module")})),g(this,"suspend",(()=>{this.isSuspended=!0})),g(this,"unsuspend",(()=>{this.resetSyncState(),this.isSuspended=!1})),g(this,"deactivateSyncAdjustments",(()=>{this.isSyncAdjustmentActivated=!1})),g(this,"activateSyncAdjustments",(()=>{this.tryApplySyncInfo(0),this.lastSeekTime=Date.now(),this.isSyncAdjustmentActivated=!0})),g(this,"reset",(()=>{this.logger.info("Reset sync state"),this.currentChannelId=void 0,this.timestampOffset=void 0,this.resetSyncState(),this.highestSeenTimestamps.clear()})),g(this,"getTimeshiftOffset",(()=>{var e;return null!=(e=this.timestampOffset)?e:0})),g(this,"getCurrentChannelId",(()=>this.currentChannelId)),g(this,"resetSyncState",(()=>{this.timeshiftSync.multiplier=1,this.syncMaxBehindMultiplier=1,this.driftAdjustments=[],this.timeShiftAdjustments=[]})),g(this,"getLiveEdgeTime",(e=>{const t=this.channelSyncInfo.get(e);if(!t)return;const i=Date.now()-t.localTimestamp;return t.timestamp+i})),g(this,"getLiveEdgeTimeLatencyAdjusted",(e=>{const t=this.getLiveEdgeTime(e);if(t)return t+this.rtt/2})),g(this,"getWallclockTime",(e=>{const t=this.channelSyncInfo.get(e);if(!t)return;const i=Date.now()-t.localTimestamp;return t.wallclockTime+i})),g(this,"getWallclockTimeLatencyAdjusted",(e=>{const t=this.getWallclockTime(e);if(t)return t+this.rtt/2})),g(this,"processSample",(e=>{var t;if(!e.channelId)throw new Error("Sample must be assigned to a channel");this.currentChannelId||(this.currentChannelId=e.channelId),this.timestampOffset||(this.timestampOffset=e.timestamp/e.timescale*1e3-5e3);const i="video"===e.type&&e.isSync;if(this.currentChannelId!==e.channelId){let t=Number.MAX_SAFE_INTEGER;console.assert(0!==this.highestSeenTimestamps.size,"no known timestamps"),this.highestSeenTimestamps.forEach((e=>{t=Math.min(t,e)}));const i=e.timestamp/e.timescale*1e3;this.currentChannelId=e.channelId,this.timestampOffset=i-t}else(i||this.timeshiftOnAudio)&&this.tryTimeshiftSync();const s=this.timestampOffset*e.timescale/1e3;return e.timestamp-=s,i&&this.keyframeTimestamps.push(e.timestamp/e.timescale*1e3),this.highestSeenTimestamps.set(e.type,Math.max(null!=(t=this.highestSeenTimestamps.get(e.type))?t:0,e.timestamp/e.timescale*1e3)),e})),g(this,"getStatistics",(()=>({drift:this.drift,driftAdjustmentCount:this.driftAdjustmentsCount,timeshiftDriftAdjustmentCount:this.timeshiftDriftAdjustmentCount,seekTime:this.playbackSource.seekTime}))),g(this,"updateRtt",(e=>{this.rtt=e})),g(this,"isPlaybackSourceReadyToSeek",(()=>!this.isSeeking()&&this.isSeekCooldownExpired()&&this.isSyncAdjustmentActivated)),g(this,"isSeeking",(()=>!!this.playbackSource.isSeeking&&!this.isSeekTimeoutExpired())),g(this,"isAllowedToSync",(()=>this.isPlaybackSourceReadyToSeek()&&!!this.currentChannelId&&!this.isSuspended&&!this.playbackSource.isPaused)),g(this,"isSeekCooldownExpired",(()=>Date.now()-this.lastSeekTime>this.seekCooldownTime)),g(this,"isSeekTimeoutExpired",(()=>Date.now()-this.lastSeekTime>this.seekTimeoutTime)),g(this,"currentTimeshiftMaxBehind",(()=>Math.min(this.timeshiftSync.maxBehind*this.timeshiftSync.multiplier,this.timeshiftSync.maxBehindAllowed))),g(this,"currentSyncMaxBehind",(()=>Math.min(this.syncMaxBehindMultiplier*this.syncMaxBehind,this.syncMaxBehindMaximumAllowed))),g(this,"currentSyncMaxAhead",(()=>this.playbackSource.seekTime>500?Math.max(this.syncMaxAhead*this.syncMaxBehindMultiplier,300):this.syncMaxAhead)),g(this,"tryTimeshiftSync",(()=>{var e;if(!this.timeshiftSync.enabled||!this.isAllowedToSync())return;const t=null!=(e=this.drift)?e:0;if(t>=this.syncMaxBehind)return;if(t<this.currentTimeshiftMaxBehind())return void(this.timeshiftSync.overshoot=0);if(!this.timestampOffset)return;const i=Date.now()-this.seekTimeoutTime*this.timeshiftSync.multiplier,s=this.timeShiftAdjustments.filter(Yi(i)).length;if(s&&this.timeshiftSync.multiplier>2)return this.logger.debug("Too many diff timeShifts within sliding window",{timeShiftsCooldownMs:i,timeShiftsWithinCooldownTime:s}),!1;const n=t+this.timeshiftSync.overshoot;this.logger.info("Adjusting for drift using timeshift",{drift:t,syncAmount:n,currentTime:this.playbackSource.currentTime,rtt:this.rtt,overshoot:this.timeshiftSync.overshoot}),this.timestampOffset+=n,this.lastSeekTime=Date.now(),!this.playbackSource.isPaused&&(this.timeShiftAdjustments.push(this.lastSeekTime),this.timeshiftDriftAdjustmentCount++,this.timeshiftSync.multiplier++,this.timeshiftSync.overshoot=Math.max(this.timeshiftSync.minOvershootAllowed,Math.min(this.timeshiftSync.multiplier*t/2,this.timeshiftSync.maxOvershootAllowed)))})),g(this,"onSync",(()=>{var e;if(!this.isAllowedToSync())return;const t=null!=(e=this.drift)?e:0;if(t<0&&-t<this.currentSyncMaxAhead()||t>0&&t<this.currentSyncMaxBehind()||Math.abs(t)<1||!this.isSeekCooldownExpired())return;const i=Date.now()-this.seekTimeoutTime*this.syncMaxBehindMultiplier,s=this.driftAdjustments.filter(Yi(i)).length;if(s&&this.syncMaxBehindMultiplier>2)return this.logger.debug("Too many diff adjustments within sliding window",{adjustmentsCooldownMs:i,adjustmentsWithinCooldownTime:s}),!1;const n=this.playbackSource.seekTime,r=this.playbackSource.currentTime+t,o=this.findKeyframeCloseToTimestamp(r);if(o||this.keyframeTimestamps.isEmpty()){const e=o?o+this.seekKeyframeOvershoot:r;if(this.logger.info("Adjusting for drift using seek",{drift:t,currentTime:this.playbackSource.currentTime,targetCurrentTime:e,seekTime:n,rtt:this.rtt}),this.lastSeekTime=Date.now(),this.driftAdjustments.push(this.lastSeekTime),this.driftAdjustmentsCount++,this.playbackSource.currentTime=e+n,this.timeshiftSync.overshoot=Math.max(this.timeshiftSync.minOvershootAllowed,this.timeshiftSync.overshoot/2),this.driftAdjustmentsCount%this.syncMaxBehindIncreaseEvery==0&&!this.playbackSource.isPaused){const e=this.currentSyncMaxBehind;this.syncMaxBehindMultiplier+=this.syncMaxBehindMultiplierStep,e!==this.currentSyncMaxBehind&&this.logger.info("Increasing max drift behind allowed",{from:e,to:this.currentSyncMaxBehind})}}})),g(this,"findKeyframeCloseToTimestamp",(e=>{const t=this.keyframeTimestamps.items();for(const i of t)if(i>=e&&i<=e+200)return i})),this.logger=t,this.emitter=e,this.playbackSource=i,this.bufferSource=s,this.timeshiftSync.enabled=n,this.syncMaxBehind=this.timeshiftSync.enabled?1e3:200,this.emitter.on("rtt",this.updateRtt)}updateChannelSyncInfo(e,t){const i=Date.now(),s=this.channelSyncInfo.get(e),n=this.getLiveEdgeTime(e);if(this.isSuspended)return;if(!s||!n)return this.logger.info("Initial timing info",{syncInfo:t}),void this.channelSyncInfo.set(e,A(m({},t),{localTimestamp:i,timeDifferences:new C(12)}));const r=t.wallclockTime-s.wallclockTime,o=t.timestamp-s.timestamp,a=i-s.localTimestamp,h=o-a;if(s.timeDifferences.push(h),this.logger.debug("Timing info",{rtt:this.rtt,channelId:e,syncInfo:t,localTimestamp:i,diffFromEstimated:h,timestampDelta:o,wallclockDelta:r,localWallclockDelta:a}),Math.abs(h)>=2*this.bufferSource.getTargetBufferTime())return this.logger.info("Resetting sync info",{diffFromEstimated:h}),this.channelSyncInfo.set(e,A(m({},t),{localTimestamp:i,timeDifferences:new C(s.timeDifferences.maxSize+1)})),void(this.currentChannelId&&this.currentChannelId===e&&(this.reset(),this.emitter.emit("channel reset")));s.timeDifferences.isFull()&&this.tryApplySyncInfo(this.maxTimeSyncDifferenceTolerance)}tryApplySyncInfo(e){const t=this.getCurrentChannelId();if(!t)return;const i=this.channelSyncInfo.get(t);if(!i)return;const s=O(i.timeDifferences.items());Math.abs(s)>e&&(this.logger.info("Adjusting sync info",{averageDifference:s}),i.timestamp+=s,i.timeDifferences.clear())}get serverCurrentTime(){return this.channelCurrentTime-this.getTimeshiftOffset()}get channelCurrentTime(){const e=this.getCurrentChannelId();if(!e)return 0;const t=this.getLiveEdgeTime(e);return t?t-this.bufferSource.getTargetBufferTime():0}get drift(){return this.serverCurrentTime-this.playbackSource.currentTime}};g($i,"create",((e,t,i,s,n)=>new $i(e,t,i,s,n)));let Ki=$i;const es={enabled:!0,interval:3e4,includeErrors:!0,includeEvents:!0,includeStats:!0,maxRetries:10,maxErrorReports:50,maxEvents:50},ts=(e,t)=>A(m({},t),{type:e,timestamp:(new Date).toISOString(),discriminator:"web"}),is=class{constructor(e,t,i,s){g(this,"logger"),g(this,"timers",new ie),g(this,"emitter"),g(this,"options"),g(this,"parentContext"),g(this,"unsentLines",new C(100)),g(this,"retries",0),g(this,"errorCount",0),g(this,"eventCount",0),g(this,"statsCount",0),g(this,"unload",(()=>{this.logger.debug("Unloading module..."),window.removeEventListener("error",this.onError),window.removeEventListener("unhandledrejection",this.onRejection),this.timers.unload(),this.emitter.off("error",this.addError),this.emitter.off("visibilitystate",this.onVisibilityChange),this.emitter.off("pagehide",this.onPageHide),this.addStats({isFinal:!0,initiator:"unload"}),this.send("beacon"),this.logger.debug("Unloaded module")})),g(this,"load",(()=>{window.addEventListener("error",this.onError),window.addEventListener("unhandledrejection",this.onRejection),this.emitter.on("error",this.addError),this.emitter.on("visibilitystate",this.onVisibilityChange),this.emitter.on("pagehide",this.onPageHide),this.timers.setInterval((()=>{this.addStats(),this.send("fetch")}),this.options.interval)})),g(this,"addStats",(({isFinal:e,initiator:t}={isFinal:!1,initiator:"interval"},i={})=>{if(!this.options.includeStats)return;const s=this.parentContext.getStatistics(),n=ts("stats",A(m(m({},i),s),{isFinal:e,initiator:t,count:this.statsCount++}));this.unsentLines.push(n)})),g(this,"addEvent",(e=>{if(!this.options.includeEvents||this.eventCount>this.options.maxEvents)return;const t=this.parentContext.getStatistics(),i=ts("event",m(m({},t),e));this.eventCount++,this.unsentLines.push(i)})),g(this,"getStatistics",(()=>({errorCount:this.errorCount}))),g(this,"send",(e=>y(this,null,(function*(){if(this.options.enabled&&!(this.retries>=this.options.maxRetries)&&!this.unsentLines.isEmpty()){this.logger.debug("Sending telemetry",{lines:this.unsentLines.items()});try{const t=this.unsentLines.items().map((e=>JSON.stringify(e))).reverse().join("\n");"beacon"===e?navigator.sendBeacon(this.options.url,t):"connected"===this.parentContext.connectionState?this.emitter.emit("send signal",JSON.stringify({type:"telemetry",body:t})):yield(0,n.p)(new URL(this.options.url),{body:t,headers:{"Content-Type":"text/plain"}}),this.retries=0,this.unsentLines.clear()}catch(e){this.retries++}}})))),g(this,"onVisibilityChange",(e=>{"hidden"===e&&(this.addStats({isFinal:!0,initiator:"visibilitychange"}),this.send("beacon"))})),g(this,"onPageHide",(e=>{this.addStats({isFinal:!0,initiator:"pagehide"},{persisted:e.persisted}),this.send("beacon")})),g(this,"onRejection",(e=>this.addError(e.reason))),g(this,"onError",(e=>this.addError(e.error))),g(this,"addError",(e=>{const{includeErrors:t,maxErrorReports:i}=this.options;if(t&&e instanceof le){if(this.errorCount++,this.errorCount>i)return;const t=this.parentContext.getStatistics();this.unsentLines.push(ts("error",m(m({},t),e.toStringifiable())))}})),this.logger=e,this.emitter=t,this.options=m(m({},es),i),this.parentContext=s}};g(is,"create",((e,t,i,s)=>new is(e,t,i,s)));let ss=is;const ns=class{constructor(e,t,i){g(this,"logger"),g(this,"element"),g(this,"documentState"),g(this,"timers",new ie),g(this,"unload",(()=>{this.timers.unload()})),g(this,"unpause",(()=>{this.element.userHasProvidedInput&&this.element.isPaused&&this.documentState.isVisible&&this.documentState.isOnline&&(this.logger.debug("Unpause video"),this.element.tryPlay())})),this.logger=e,this.element=t,this.documentState=i,this.timers.setInterval(this.unpause,100)}};g(ns,"create",((e,t,i)=>new ns(e,t,i)));let rs=ns;class os{constructor(){var e;g(this,"highEntropyValues"),null==(e=self.navigator.userAgentData)||e.getHighEntropyValues(["architecture","model","platformVersion","fullVersionList"]).then((e=>{this.highEntropyValues=e}))}getUserAgentInformation(){var e,t,i,s,n,r;const o=window.location.origin,a=o&&"null"!=o?`${window.location.pathname}${window.location.search}`.substring(0,1e3):"",h={locationOrigin:window.location.origin,locationPath:a,ancestorOrigins:(null==(e=window.location.ancestorOrigins)?void 0:e.length)>0?Array.from(window.location.ancestorOrigins):void 0,hardwareConcurrency:navigator.hardwareConcurrency,deviceMemory:navigator.deviceMemory};if(self.navigator.userAgentData&&this.highEntropyValues){const e="1",o=[...null!=(t=this.highEntropyValues.brands)?t:[]];o.sort(((e,t)=>e.brand.localeCompare(t.brand)));const a=[...null!=(i=this.highEntropyValues.fullVersionList)?i:[]];a.sort(((e,t)=>e.brand.localeCompare(t.brand)));const d=a.map((e=>e.version)),c=o.map((e=>e.brand)),u=o.map((e=>e.version)),l=parseInt(null!=(n=null==(s=this.highEntropyValues.platformVersion)?void 0:s.split(".")[0])?n:e);return m({userAgentLegacy:window.navigator.userAgent,ua:{browser:{brands:c,fullVersionBrands:d,majorVersions:u},device:this.highEntropyValues.model||"Other",os:{family:this.highEntropyValues.platform||"Other",version:null!=(r=this.highEntropyValues.platformVersion)?r:e,major_version:Number.isFinite(l)?l:0}}},h)}return m({userAgent:window.navigator.userAgent},h)}}const as=(e,t)=>e&&"object"==typeof e&&t in e;var hs,ds,cs;const us=class e extends s.E{constructor(t){super(),g(this,"pictureInPicture"),g(this,"browser",(()=>{var e;const t=!!x();let i=!1;return t&&(i=(()=>{var e,t;return!_()&&null!=(t=null==(e=x())?void 0:e.isTypeSupported('audio/mp4; codecs="opus"'))&&t})()),{isMobile:B,supportsMp4Opus:i,supportsMediaSource:t,supportsHls:R(),supportsWebAssembly:P(),platform:{iosVersion:null!=(e=U())?e:Number.MAX_SAFE_INTEGER,isIpadOS:_(),isMacOS:M(),isIOS:I.indexOf("iphone")>=0&&I.indexOf("like iphone")<0||I.indexOf("ipad")>=0&&I.indexOf("like ipad")<0||I.indexOf("ipod")>=0&&I.indexOf("like ipod")<0||_()}}})()),g(this,"options"),g(this,"element"),g(this,"playbackSource"),g(this,"emitter",new s.E),g(this,"logger"),g(this,"modules"),g(this,"clientIp"),g(this,"sessionId"),g(this,"clientId",se()),g(this,"_channels",[]),g(this,"createdAt",Date.now()),g(this,"hasCalledConnect",!1),g(this,"apiClient"),g(this,"latestEmittedLanguages",[]),g(this,"wakeLock"),g(this,"cachedEdges",[]),g(this,"shiftedEdges",[]),g(this,"pool",new E(e.MAX_POOL_SIZE)),g(this,"userAgentInformation",new os),v(this,hs,0),v(this,ds,[]),g(this,"sampleProcessingSesssions",new Map),g(this,"sizes",new Map),g(this,"isSuspended",!0),g(this,"disconnectTimeout"),v(this,cs),g(this,"attach",(e=>{var t;null==(t=this.wakeLock)||t.attach(e),e.appendChild(this.element)})),g(this,"getOptions",(()=>this.options.getOptions())),g(this,"getThumbnailUrl",(()=>{let e=this.options.get("edgeUrl")||this.options.get("url");e=e.replace("wss://","https://"),e=e.replace("ws://","http://"),e=e.endsWith("/")?e.slice(0,-1):e;const t=this.options.get("authenticationToken"),i=t?`&auth.token=${t}`:"";return`${e}/api/thumbnail?channelId=${this.options.get("channelId")}${i}`})),g(this,"updateAuthenticationToken",(e=>{this.logger.debug("Got new auth token",{token:e}),this.options.set("authenticationToken",e),this.emitter.emit("send signal",JSON.stringify({type:"refresh auth",token:e}))})),g(this,"connect",(()=>{this.hasCalledConnect||(this.play(),this._connect())})),g(this,"_connect",(()=>{var e,t;this.hasCalledConnect||(this.hasCalledConnect=!0,Object.values(this.modules).forEach((e=>{e&&"load"in e&&e.load()})),this.unsuspend(),this.playbackSource instanceof dt&&(null==(t=(e=this.playbackSource).load)||t.call(e)),this.modules.connection.connect("audio+video"===this.options.get("media")?2:1))})),g(this,"getCastOptions",(()=>({url:this.options.get("url"),channelId:this.options.get("channelId"),channelGroupId:this.options.get("channelGroupId"),authenticationToken:this.options.get("authenticationToken"),language:this.options.get("language"),logLevel:this.options.get("logLevel"),minBufferTime:this.options.get("minBufferTime"),tags:this.options.get("tags"),ownerSessionId:this.sessionId,edgeUrl:this.options.get("edgeUrl"),media:this.options.get("media")}))),g(this,"connectionInfo",(()=>y(this,null,(function*(){try{return yield this.apiClient.connect(this.options.getOptions())}catch(t){if((0,n.i)(t))switch(t.status){case 401:throw this.emitter.emit("error",ve(t)),ve(t);case 403:throw this.emitter.emit("error",be(t.message)),be(t.message)}throw this.emitter.emit("error",(e=t instanceof Error?t:void 0,new le("Connection attempt failed",{isFatal:!1,code:"connection_failed",source:e}))),t}var e})))),g(this,"estimateRTT",(()=>y(this,null,(function*(){const t=Date.now(),i=()=>Date.now()-t;return Promise.race([ne(e.PING_TIMEOUT),fetch(new URL("/api/v2/connect/ping",this.options.get("url")).toString(),{method:"HEAD"})]).then(i,i)})))),g(this,"connectHandler",(()=>y(this,null,(function*(){var e,t;this.sessionId=se();const i=this.modules.subscription.getTargetSubscription(),[s,n]=yield Promise.all([this.connectionInfo(),this.estimateRTT()]),r=St(n/2),o=s.channels.find((e=>e.channelId===i.channelId));if(this.emitter.emit("connect info",s),this._channels=s.channels,this.updateTextTracks(null!=(e=null==o?void 0:o.renditions)?e:[]),!this.textTrack&&this.options.get("textTrack")&&(this.textTrack=this.options.get("textTrack")),yield Promise.all(s.channels.map((e=>y(this,null,(function*(){e.overrides&&this.options.addOverrides(e.channelId,e.overrides),e.renditions=yield this.filterRenditions(e.renditions),this.modules.renditions.setRenditions(e.channelId,e.renditions)}))))),!o)throw we("external");const a=this.options.getOverride("sizeBasedResolutionCapEnabled",this.channelId);void 0!==a&&(this.modules.constraintCap.sizeBasedResolutionCapEnabled=a);const h=this.options.getOverride("separateVideoSocketEnabled",this.channelId);void 0!==h&&"audio+video"===this.options.get("media")&&this.modules.connection.setConnectionCount(h?2:1);const d=this.options.getOverride("minBufferTime",this.channelId),c=this.options.getOverride("maxBufferTime",this.channelId);if((d||c)&&(this.modules.bufferTime.updateConfig({minBufferTime:this.options.get("minBufferTime",this.channelId),maxBufferTime:this.options.get("maxBufferTime",this.channelId)}),this.targetBufferTime=this.options.get("minBufferTime",this.channelId)),this.options.get("burstEnabled",this.channelId)&&this.modules.subscription.enableBurst(this.targetBufferTime),this.emit("is live",o.isLive),!o.isLive)throw new Error("Waiting for channel to go live");this.patchSubscription(o,r),yield this.initializeDecodingModule(),this.resetModules(),this.emit("rendition levels",this.modules.renditions.getRenditionLevels()),this.emit("channels",this.channels),this.emitLanguagesIfChanged(),this.sampleProcessingSesssions.clear(),this.cachedEdges=0===this.cachedEdges.length?s.edges:this.cachedEdges;const u=(this.options.get("edgeUrl")?[this.options.get("edgeUrl")]:[this.cachedEdges.shift()])[0],l=this.options.get("burstEnabled",this.channelId),m=((e,t)=>{if(!e)return;const i=new URL("/subscribe",e);return i.searchParams.append("channelId",t.channelId),i.searchParams.append("sessionId",t.sessionId),i.searchParams.append("clientId",t.clientId),t.audio&&t.audio.codec&&(i.searchParams.append("audio.bitRate",Math.round(t.audio.bitRate).toString()),i.searchParams.append("audio.codec",t.audio.codec),t.audio.language&&i.searchParams.append("audio.language",t.audio.language)),t.video&&t.video.codec&&(i.searchParams.append("video.width",t.video.width.toString()),i.searchParams.append("video.height",t.video.height.toString()),i.searchParams.append("video.bitRate",Math.round(t.video.bitRate).toString()),i.searchParams.append("video.codec",t.video.codec)),t.expectAdditionalConnection&&i.searchParams.append("expectAdditionalConnection",t.expectAdditionalConnection.toString()),t.burstMs&&i.searchParams.append("burstMs",t.burstMs.toString()),t.channelGroupId&&i.searchParams.append("channelGroupId",t.channelGroupId),t.authToken&&(i.searchParams.append("auth.token",t.authToken),i.searchParams.append("auth.type","jwt")),i.toString()})(u,{video:this.targetSubscription.video,audio:this.targetSubscription.audio,burstMs:l?this.targetBufferTime:void 0,sessionId:this.sessionId,clientId:this.clientId,channelId:this.channelId,channelGroupId:this.options.get("channelGroupId"),expectAdditionalConnection:this.modules.connection.getConnectionCount()>1,authToken:this.options.get("authenticationToken")});if(!m||!u)throw new le("Failed to resolve edge url",{isFatal:!0,code:"failed_to_resolve_edge_url"});const A=this.shiftedEdges[this.shiftedEdges.length-1];return A&&(null==(t=this.modules.telemetry)||t.addEvent({code:"shifted_edge",edgeUrl:A})),this.shiftedEdges.push(u),this.logger.debug("resolved edge url",{edgeUrl:m}),Promise.resolve(m)})))),g(this,"emitLanguagesIfChanged",(()=>{const e=this.modules.renditions.getLanguages(),t=this.latestEmittedLanguages;e.length==t.length&&e.every((e=>t.includes(e)))||(this.logger.debug("Emitting new languages",{currentLanguages:e}),this.latestEmittedLanguages=e,this.emit("languages",this.latestEmittedLanguages))})),g(this,"updateTextTracks",(e=>{const t=e.filter((e=>"webvtt"===e.codec));t.forEach((e=>{if(!f(this,ds).find((t=>t.language===e.language)))if(this.modules.canvasModule){const t=this.modules.canvasModule.textTracks.addTextTrack(e.kind,e.label||e.language||"",e.language||"");f(this,ds).push(t)}else if(this.mediaElement instanceof HTMLVideoElement){const t=this.mediaElement.addTextTrack(e.kind,e.label||e.language,e.language);f(this,ds).push(t)}}));for(const e of f(this,ds))t.find((t=>t.language===e.language))?"disabled"===e.mode&&(e.mode="hidden"):e.mode="disabled";this.emit("text tracks",this.textTracks)})),g(this,"cleanupTextTracks",((e=this.currentTime-2e4)=>{f(this,ds).forEach((t=>{if(t.cues)for(const i of t.cues)1e3*i.endTime<e-2e3&&t.removeCue(i)}))})),g(this,"filterRenditions",(e=>y(this,null,(function*(){const t=yield Promise.all(e.map((e=>y(this,null,(function*(){var t,i,s;if(ae(e))return!0;if(!oe(e)||!this.isSupportedVideoCodecProfile(e.codec,e.codecString))return!1;if(!this.willUseMediaSource()){const n=this.options.get("advanced"),r=null!=(t=n.wasmDecodingConstraint.bitRate)?t:Number.MAX_SAFE_INTEGER,o=null!=(i=n.wasmDecodingConstraint.width)?i:Number.MAX_SAFE_INTEGER,a=null!=(s=n.wasmDecodingConstraint.height)?s:Number.MAX_SAFE_INTEGER;return e.bitRate<=r&&e.width<=o&&e.height<=a}const n=yield(e=>{if(!navigator.mediaCapabilities)return Promise.resolve({smooth:!0,supported:!0,powerEfficient:!0,failedToQuery:!0});if("webvtt"===e.codec)throw new Error("WebVTT is not supported");let t;return t=ae(e)?{type:"media-source",audio:{contentType:he(e),bitrate:e.bitRate,channels:e.channels.toString(),samplerate:e.sampleRate}}:{type:"media-source",video:{contentType:he(e),bitrate:e.bitRate,width:e.width,height:e.height,framerate:e.frameRate[0]/e.frameRate[1]}},navigator.mediaCapabilities.decodingInfo(t)})(e);if(!n.supported||"av1"==e.codec&&!n.smooth&&!n.powerEfficient)return!1;const r=this.options.getOverride("maxVideoBitRate",this.channelId);return!r||r>=e.bitRate})))));let i=e.filter(((e,i)=>t[i]));const s=i.filter((e=>"h264"===e.codec)).reverse()[0],n=i.filter((e=>"av1"===e.codec)).reverse()[0];return s&&n&&s.width>n.width&&s.height>n.height&&(i=i.filter((e=>"av1"!==e.codec))),i})))),g(this,"patchSubscription",((t,i)=>{const s=Math.min(this.options.get("maxVideoBitRate"),e.INITIAL_MAX_BIT_RATE,i,this.targetSubscription.video.bitRate),n=Math.min(this.options.get("maxAudioBitRate"),e.INITIAL_MAX_BIT_RATE,i,this.targetSubscription.audio.bitRate),r="audio"===this.options.get("media")?[]:this.options.get("videoCodecs",this.channelId),o=this.supportedAudioCodecs(),a=t.renditions.filter(ae),h=t.renditions.filter(oe),d=o.find((e=>void 0!==a.find((t=>t.codec===e)))),c=r.find((e=>void 0!==h.find((t=>t.codec===e)))),u=a.map((e=>e.language));if(this.logger.debug("supported and selected codecs",{audioCodecs:o,videoCodecs:r,audioCodec:d,videoCodec:c}),c){const e=this.options.get("maxSize");this.modules.subscription.setVideoConstraint(m({codec:c,bitRate:this.abrEnabled?s:this.options.get("maxVideoBitRate")},e))}d&&(this.modules.subscription.setAudioConstraint({codec:d,bitRate:this.abrEnabled?n:this.options.get("maxAudioBitRate"),language:this.options.get("language")}),(!u.includes(this.options.get("language"))||void 0===this.language)&&this.modules.subscription.setLanguage(u[0])),this.alignSizeAndBitRate(this.targetSubscription);const l=this.modules.subscription.getTargetSubscription();this.emitter.emit("subscription changed",{to:l,from:this.modules.subscription.getCurrentSubscription()})})),g(this,"isSupportedVideoCodecProfile",((e,t)=>{if(this.willUseMediaSource()){const i=x();return!i||i.isTypeSupported(he({codec:e,codecString:t}))}if("h264"===e){const e=!(null==t||!t.startsWith("avc1.42")),i=!(null==t||!t.startsWith("avc1.66."));return e||i}return"av1"!==e})),g(this,"supportedAudioCodecs",(()=>{if("video"===this.options.get("media"))return[];const e=[];return(this.browser.supportsMp4Opus&&this.options.get("mseOpusEnabled")||!this.willUseMediaSource())&&e.push("opus"),this.willUseMediaSource()&&e.push("aac"),e})),g(this,"initializeDecodingModule",(()=>y(this,null,(function*(){var e,t;const i=this.currentRenditionLevel,s=[];if(!i)throw new le("No currentRenditionLevel",{code:"no_current_rendition_level",isFatal:!1});if(null!=i&&i.video&&s.push({type:"video",mimeType:he(i.video)}),null!=i&&i.audio&&s.push({type:"audio",mimeType:he(i.audio)}),0===s.length)throw new le("Can't initialize decoding module without tracks",{code:"no_tracks",isFatal:!1});if(this.willUseMediaSource()&&this.element instanceof HTMLMediaElement)this.emitter.emit("flush buffers"),yield null==(e=this.modules.mseModule)?void 0:e.setSourceBuffers(s);else{const e=yield kt.create(this.emitter,this.logger.createContext("DecoderModule"),s,this.playbackSource,this.pool);null==(t=this.modules.decoder)||t.unload(),this.modules.decoder=e,this.modules.decoder.load()}})))),g(this,"unload",(()=>y(this,null,(function*(){var t,i,s;this.logger.debug("Unloading modules..."),yield Promise.all(Object.values(this.modules).map((e=>null==e?void 0:e.unload()))),null==(t=this.wakeLock)||t.unload(),this.pool=new E(e.MAX_POOL_SIZE),null==(s=(i=this.playbackSource).unload)||s.call(i),this.element.remove(),this.emitter.reset(),this.reset(),this.logger.debug("Unloaded modules")})))),g(this,"userInput",(()=>{this.play()})),g(this,"pause",(()=>{this.options.get("pauseSupportEnabled")&&"paused"!==this.playbackState&&(this.playbackSource.pause(),this.hasCalledConnect&&this.suspend())})),g(this,"registerDebugInstance",(()=>{(e=>{const t=window;t.vindralInstances=t.vindralInstances||{},t.vindralInstances[e.getStatistics().clientId.substring(0,8)]=e})(this)})),g(this,"play",(()=>{var t;this.hasCalledConnect?this.unsuspend():"playing"!==this.playbackState&&(this._connect(),self.addEventListener("__vindral_register_debug__",this.registerDebugInstance),this.modules.timer.setInterval((()=>this.cleanupTextTracks()),e.REMOVE_CUE_THRESHOLD)),null==(t=this.wakeLock)||t.enable(),"paused"===this.playbackState&&(this.resetModules(),this.emitter.emit("flush buffers"),this.cleanupTextTracks(Number.MAX_SAFE_INTEGER)),this.playbackSource.play()})),g(this,"getStatistics",(()=>Object.values(this.modules).reduce(((e,t)=>t&&"getStatistics"in t?m(m({},e),t.getStatistics()):e),this.getRuntimeInfo()))),g(this,"resetModules",(()=>{Object.values(this.modules).forEach((e=>{e&&"reset"in e&&e.reset()})),this.sampleProcessingSesssions.clear(),this.playbackSource.currentTime=0,this.playbackSource.isActivated=!1})),g(this,"getRuntimeInfo",(()=>{const e=this.modules.canvasModule?this.options.get("iosMediaElementEnabled"):void 0;return m({uptime:Date.now()-this.createdAt,version:"4.0.0",clientId:this.clientId,sessionId:this.sessionId,channelId:this.channelId,channelGroupId:this.options.get("channelGroupId"),ip:this.clientIp,url:this.options.get("url"),timeToFirstFrame:this.timeToFirstFrame(),iosMediaElementEnabled:e},this.userAgentInformation.getUserAgentInformation())})),g(this,"onMediaElementState",(e=>{this.logger.info("media element state",{state:e}),this.options.get("pauseSupportEnabled")&&("paused"===e?this.modules.documentState.isVisible&&(this.suspend(),this.modules.connection.disconnect()):(this.unsuspend(),"disconnected"===this.modules.connection.getState()&&this.modules.connection.unsuspend()))})),g(this,"onBufferEvent",(e=>{var t,i,s,n;this.emit("buffer state event",e);const r=!this.playbackSource.isActivated||this.playbackSource.isPaused;if("filled"===e&&r){const e=Math.max(this.currentTime,null!=(i=null==(t=this.videoBufferedRanges[0])?void 0:t.start)?i:0,null!=(n=null==(s=this.audioBufferedRanges[0])?void 0:s.start)?n:0);this.logger.info("Buffer filled - starting playback",{currentTime:e}),this.playbackSource.currentTime=e,this.modules.sync.activateSyncAdjustments(),this.playbackSource.isActivated=!0}else"drained"===e&&this.playbackSource.isPaused&&(this.playbackSource.isActivated=!1,this.modules.sync.deactivateSyncAdjustments())})),g(this,"timeToFirstFrame",(()=>{const e=this.modules.playback.getFirstFrameTime(),t=this.modules.connection.firstConnectionTime;if(t&&e)return e-t})),this.options=new ut(m(m({},lt),(e=>{if(!(e=>!("object"!=typeof e||!as(e,"channelId")||"string"!=typeof e.channelId||!as(e,"url")||"string"!=typeof e.url||0===e.channelId.length||0===e.url.length))(e))throw new le("Invalid options",{isFatal:!0,code:"invalid_options"});const t=m({},e);return Object.keys(t).forEach((e=>{const i=t;void 0===i[e]&&delete i[e]})),t})(t))),void 0===t.telemetryEnabled&&["localhost","127.0.0.1"].includes(location.hostname)&&this.options.set("telemetryEnabled",!1);const i={channelId:this.options.get("channelId"),audio:{language:this.options.get("language"),bitRate:this.options.get("maxAudioBitRate")},video:{bitRate:this.options.get("maxVideoBitRate"),width:this.options.get("maxSize").width,height:this.options.get("maxSize").height}},r=Z.get();r.setLevel(this.options.get("logLevel")),r.setDebug(!1),this.logger=r;const o=Ni.create(this.emitter,this.logger.createContext("PictureInPictureModule")),a=ie.create();this.apiClient=new n.A({publicEndpoint:this.options.get("url").toString(),tokenFactory:()=>this.options.get("authenticationToken")});const h=Et.create(this.emitter,this.logger.createContext("ConnectionModule"),{connectHandler:this.connectHandler,reconnectHandler:this.options.get("reconnectHandler")}),d=qi.create(this.logger.createContext("SubscriptionModule"),this.emitter,i),c=Hi.create(this.emitter,d),u=Wi.create(this.emitter,this.logger.createContext("QualityOfServiceModule")),l=Vi.create(this.emitter,this.logger.createContext("PlaybackModule"),this,this.options.get("minBufferTime")),p=Bt.create(this.emitter),b=this.options.get("poster"),S=!0===b?this.getThumbnailUrl():b||void 0;let C,T,k;if(this.willUseMediaSource()){const e=new dt({type:"audio"==this.options.get("media")?"audio":"video",autoplay:!1,muted:this.options.get("muted")||"video"===this.options.get("media"),logger:this.logger.createContext("MediaElement"),poster:S});e.on("buffer state",(e=>this.emitter.emit("buffer state",e))),e.on("needs user input",(e=>this.emitter.emit("needs user input",e))),e.on("volume state",(e=>this.emit("volume state",e))),e.on("media element state",(e=>this.onMediaElementState(e))),this.element=e.element,this.playbackSource=e,C=Ui.create(this.logger.createContext("MseModule"),this.emitter,this.element),this.options.get("pauseSupportEnabled")||(T=rs.create(this.logger.createContext("UnpauseModule"),e,p)),this.options.get("pictureInPictureEnabled")&&this.emitter.emit("add picture in picture listener",{element:e.element})}else if(this.browser.platform.iosVersion>=15&&this.options.get("iosMediaElementEnabled")){const e=Ci.create(this.emitter,this.logger.createContext("ModernCanvasModule"),this.pool,this,{type:"audio"==this.options.get("media")?"audio":"video",muted:this.options.get("muted")||"video"===this.options.get("media"),poster:S}),t=e.element();this.element=t.element,this.playbackSource=e,k=e,this.options.get("pictureInPictureEnabled")&&this.browser.platform.iosVersion>15&&this.emitter.emit("add picture in picture listener",{element:this.element}),this.options.get("pauseSupportEnabled")||(T=rs.create(this.logger.createContext("UnpauseModule"),t,p))}else{const e=yi.create(this.emitter,this.logger.createContext("LegacyCanvasModule"),this.pool,this,this.options.get("muted")||"video"===this.options.get("media"));this.element=e.element(),this.playbackSource=e,k=e,this.options.get("iosWakeLockEnabled")&&(this.wakeLock=new et)}this.emitter.on("channel reset",this.resetModules),this.emitter.on("no data timeout",this.resetModules),this.emitter.on("media element state",(e=>this.onMediaElementState(e))),this.emitter.on("volume state",(e=>this.emit("volume state",e))),this.options.get("pauseSupportEnabled")||this.emitter.on("exit picture in picture",(()=>a.setTimeout((()=>this.play()),0))),this.emitter.on("constraint cap changed",(e=>{this.logger.info("new cap set",{cap:e}),this.alignSizeAndBitRate(this.targetSubscription)})),this.pictureInPicture={enter:()=>o.requestPictureInPicture(),exit:()=>o.exitPictureInPicture(),isActive:()=>o.isPictureInPictureActive(),isSupported:()=>o.isPictureInPictureSupported()},this.emitter.on("error",(e=>{if("external"===e.type()&&this.emit("error",e),e.isFatal())return()=>{this.unload()}}));const L=this.browser.platform.isIOS&&!this.browser.platform.isIpadOS,D=Ki.create(this.emitter,this.logger.createContext("SyncModule"),this.playbackSource,l,this.willUseMediaSource()&&!L),O=(this.options.get("edgeUrl")||this.options.get("url")).replace("wss://","https://").replace("ws://","http://").replace("//lb.","//errors."),F=new URL("/telemetry",O).toString(),N=ss.create(this.logger.createContext("TelemetryModule"),this.emitter,{url:F,enabled:this.options.get("telemetryEnabled"),includeStats:!1,interval:5e3},this);let V;this.modules={telemetry:N,bufferTime:wt.create(this.emitter,this.logger.createContext("BufferTimeModule"),u,this,{maxBufferTime:this.options.get("maxBufferTime"),minBufferTime:this.options.get("minBufferTime")}),incomingData:_t.create(this.emitter),adaptivity:pt.create(this.emitter,this.logger.createContext("AdaptivityModule"),u,{cooldownTime:Math.max(this.options.get("minBufferTime"),2e3)}),constraintCap:xt.create(this.emitter,this.element,c,!!this.options.get("abrEnabled")&&this.options.get("sizeBasedResolutionCapEnabled")),event:Pt.create(this.emitter,this.logger.createContext("EventModule"),D),sync:D,documentState:p,connection:h,playback:l,pictureInPicture:o,timer:a,subscription:d,renditions:c,qualityOfService:u,mseModule:C,unpause:T,canvasModule:k},this.modules.adaptivity.isEnabled=this.options.get("abrEnabled"),this.emitter.on("page active",(t=>{var i;t&&"number"==typeof this.disconnectTimeout&&(this.modules.timer.clearInterval(this.disconnectTimeout),this.disconnectTimeout=void 0),t?this.playbackSource.isPaused||(this.logger.debug("Unsuspending"),this.unsuspend()):(this.logger.debug("Suspending"),this.suspend(),this.modules.decoder?this.options.get("iosBackgroundPlayEnabled")?(this.modules.decoder.unsuspend(),null==(i=this.modules.canvasModule)||i.unsuspend()):this.modules.connection.disconnect():(this.disconnectTimeout&&this.modules.timer.clearInterval(this.disconnectTimeout),this.disconnectTimeout=this.modules.timer.setInterval((()=>{const e="paused"===this.playbackState||this.muted;"connected"===this.connectionState&&e&&(this.emitter.emit("flush buffers"),this.modules.connection.disconnect("Page inactive timeout"))}),e.DISCONNECT_TIMEOUT)))})),this.emitter.on("context switch complete",(()=>{V||(V=window.setTimeout((()=>{window.clearTimeout(V),V=void 0,this.emit("context switch","completed"),this.emitLanguagesIfChanged()}),this.targetBufferTime))})),this.emitter.on("context switch started",(()=>this.emit("context switch","started"))),this.emitter.on("needs user input",(e=>this.emit("needs user input",e))),this.emitter.on("event",(e=>{switch(e.type){case"metadata":this.emit("metadata",e);break;case"channel switch":this.emit("channel switch",{channelId:e.channelId});break;case"language switch":this.emit("language switch",{language:e.language})}})),this.emitter.on("buffer state event",this.onBufferEvent),this.emitter.on("playback state",(e=>this.emit("playback state",e))),this.emitter.on("rendition level changed",(({to:e})=>{e&&this.emit("rendition level",e)})),this.emitter.on("connection state",(e=>{"connected"===e&&(this.cachedEdges=[],this.shiftedEdges=[]),this.emit("connection state",e)})),this.emitter.on("recovered from media error",(()=>{this.modules.adaptivity.reset(2*this.targetBufferTime)})),this.emitter.once("connect info",(e=>{var t,i,s;const n=(null!=(i=null==(t=e.telemetry)?void 0:t.probability)?i:1)>=Math.random();e.telemetry&&(null==(s=this.modules.telemetry)||s.unload(),this.modules.telemetry=ss.create(this.logger.createContext("TelemetryModule"),this.emitter,A(m({},e.telemetry),{enabled:this.options.get("telemetryEnabled")&&n}),this),this.modules.telemetry.load())})),this.emitter.on("adapt level",(e=>{var t,i,s,n,r;this.logger.debug("adapt level",{direction:e});const o=this.modules.renditions.getRenditionLevels(),a=this.modules.renditions.getRenditionLevel(),h=o.findIndex((e=>e===a)),d=o.length-1;let c=h;switch(e){case"upgrade":{const e=Math.min(h+1,d),a=o[e],u=null!=(t=this.modules.connection.estimatedBandwidth)?t:de(),l=(null!=(s=null==(i=null==a?void 0:a.audio)?void 0:i.bitRate)?s:0)+(null!=(r=null==(n=null==a?void 0:a.video)?void 0:n.bitRate)?r:0);a&&2*u>l&&this.modules.adaptivity.isQoSOk(a)&&(c=e)}break;case"downgrade":c=Math.max(h-1,0);break;case"double downgrade":c=Math.max(h-2,0);break;case"reconnect":if(0===h||this.modules.qualityOfService.timeSpentBufferingLast(6e3)>5e3){if(!this.modules.connection.lastConnectionTime||Date.now()-this.modules.connection.lastConnectionTime<this.modules.qualityOfService.fatalQosGraceTime()||"connected"!==this.modules.connection.getState())return;return this.modules.qualityOfService.incrementFatalQosCount(),this.logger.info("Reconnecting due to poor qos"),this.modules.connection.reconnect("Fatal QOS"),void this.emitter.emit("adapted level")}c=0}if(c===h)return;const u=o[c];this.alignSizeAndBitRate(A(m({},this.targetSubscription),{video:m(m({},this.targetSubscription.video),null==u?void 0:u.video),audio:m(m({},this.targetSubscription.audio),null==u?void 0:u.audio)})),this.emitter.emit("adapted level")})),this.emitter.on("received signal",(e=>{var t;const i=e;switch(this.logger.debug("received",m({},i)),i.type){case"client ip":this.clientIp=i.ip;break;case"renditions":this.updateTextTracks(i.renditions),w(this,cs,this.filterRenditions(i.renditions).then((e=>{this.emitter.emit("renditions",{renditions:e,channelId:this.currentSubscription.channelId}),this.emit("rendition levels",this.modules.renditions.getRenditionLevels()),this.emitLanguagesIfChanged()})).finally((()=>{w(this,cs,void 0)})));break;case"subscription changed":try{(e=>{if("object"!=typeof e||null===e)throw new Error("not an object");if(!("video"in e))throw new Error("missing video in subscription");if(!("audio"in e))throw new Error("missing audio in subscription");if(!("channelId"in e))throw new Error("missing channelId")})(i.subscription)}catch(e){this.emitter.emit("error",new le("Subscription failed validation",{source:e instanceof Error?e:void 0,isFatal:!1,code:"subscription_failed_validation"}))}this.emitter.emit("subscription changed",{to:i.subscription,from:this.modules.subscription.getCurrentSubscription()}),this.modules.sync.timeshiftOnAudio=!(null!=(t=i.subscription.video)&&t.codec),this.modules.adaptivity.reset();break;case"timing info":this.modules.sync.updateChannelSyncInfo(i.timingInfo.channelId,i.timingInfo),this.emit("server wallclock time",i.timingInfo.wallclockTime)}})),this.emitter.on("received data",(e=>{const t=this.modules.subscription.getCurrentSubscription(),i=(e=>{const t=new DataView(e,0),i=t.getUint8(0),s=t.getUint16(1),n=t.getUint8(3),r=t.getUint8(4),o=((e,t,i)=>{let s=0;for(let t=5;t<=12;t++)if(5===t){const i=e[t];s+=127&i,128&i&&(s-=128)}else s=256*s+e[t];return s})(new Uint8Array(e)),a=t.getUint32(13),h=(e=>!!(16&e))(n)?t.getInt16(17):void 0;return{version:i,renditionId:r,flags:n,timestamp:o,timescale:a,payload:e.slice(s),compositionTimeOffset:h}})(e);t?G(A(m({},i),{channelId:t.channelId})):this.logger.warn("Received unwanted message",m({},i))}));const z=this.options.get("container");z&&this.attach(z),this.logger.info("Created Vindral instance",{options:this.options});const G=e=>y(this,null,(function*(){const t=e.channelId;f(this,cs)&&(yield f(this,cs));const i=this.modules.renditions.getRendition(e.renditionId,t);if(!(4&e.flags))if(8&e.flags){const t=(new TextDecoder).decode(e.payload),i=this.modules.sync.getTimeshiftOffset();if(0!==e.renditionId){const e=(0,n.t)(t);if(e&&void 0!==e.language){const t=(new ht).parse(e.content||""),s=i/1e3,n=f(this,ds).find((t=>t.language===e.language)),r=s-f(this,hs);if(w(this,hs,s),n){if(n.cues)for(const e of n.cues)e.startTime-=r,e.endTime-=r;for(const e of t){const t=new VTTCue(e.startTime-s,e.endTime-s,e.text);n.addCue(t)}}}}else this.modules.event.addEvent({timestamp:e.timestamp/e.timescale*1e3-this.modules.sync.getTimeshiftOffset(),content:t,type:"metadata"})}else if(null!=i&&i.codec){const s=(e=>{switch(e){case"h264":case"av1":return"video";case"aac":case"opus":case"mp3":return"audio";case"webvtt":return"text";default:throw new Error("Unknown codec")}})(i.codec);if("text"===s)throw new Error("Subtitles are not supported");if(this.modules.incomingData.add(s,e.payload.byteLength),(e=>!!(2&e))(e.flags)){const n=A(m({type:s,data:e.payload,codec:i.codec},e),{channelId:t}),r=((e,t)=>{switch(e){case"h264":return je(t);case"av1":return(e=>{const t=Ze(e);if(t)return{width:t.maxFrameWidth,height:t.maxFrameHeight}})(t)}})(n.codec,n.payload);r&&this.sizes.set(n.renditionId,r);const o=he({codec:i.codec,codecString:i.codecString});this.emitter.emit("init segment",{initSegment:n,mimeType:o}),this.emit("initialized media")}else{const t=((e,t,i)=>{if(oe(t))return m(A(m({},e),{type:"video",codec:t.codec,isSync:$e(e.flags),data:e.payload,duration:0,width:t.width,height:t.height}),i);if("webvtt"===t.codec)throw new Error("WebVTT is not supported");return A(m({},e),{type:"audio",channels:t.channels,sampleRate:t.sampleRate,codec:t.codec,language:t.language,isSync:$e(e.flags),data:e.payload,duration:0})})(e,i,this.sizes.get(e.renditionId));let n=this.sampleProcessingSesssions.get(s);if(n){const e=n(this.modules.sync.processSample(t),this.isSwitchingRenditionLevel&&"video"===t.type);let i=t;e.forEach((e=>{this.modules.event.extractEvent(e,i),this.emitter.emit("coded sample",e),i=e}))}else n=(e=>{let t=[e],i=0,s=0,n=!1;return(e,r=!1)=>{if(e.flags&&$e(e.flags)&&r&&(n=!n),!(r&&t.length<6&&n)&&t.length>0){n=!1;let r=e;for(let e=t.length-1;e>0;e--){const i=t[e];if(!i||!r)break;i.timestamp>=r.timestamp?t.splice(e,1):r=i}const o=t.map(((n,r)=>((e,t)=>{var n,r,o;e.flags&&$e(e.flags)&&(i=null!=(n=e.compositionTimeOffset)?n:0),e.timestamp+=i,e.compositionTimeOffset=(null!=(r=e.compositionTimeOffset)?r:0)-i;const a=e.timestamp/e.timescale,h=t.flags&&$e(t.flags)?null!=(o=t.compositionTimeOffset)?o:0:i,d=(t.timestamp+h)/t.timescale,c=Math.max(0,Math.round((d-a)*e.timescale));return c>0&&(s=c),A(m({},e),{duration:c>0?c:s})})(n,t[r+1]||e)));return t=[e],o}return t.push(e),[]}})(this.modules.sync.processSample(t)),this.sampleProcessingSesssions.set(s,n)}}}));this.options.get("maxVideoBitRate")!==Number.MAX_SAFE_INTEGER&&(this.maxVideoBitRate=this.options.get("maxVideoBitRate")),this.options.get("maxAudioBitRate")!==Number.MAX_SAFE_INTEGER&&(this.maxAudioBitRate=this.options.get("maxAudioBitRate")),Q(this.options.get("maxSize"),ce())||(this.maxSize=this.options.get("maxSize")),this.options.get("burstEnabled")&&d.enableBurst(this.targetBufferTime)}set volume(e){this.playbackSource.volume=e}get volume(){return this.playbackSource.volume}set muted(e){if(e===this.muted)return;const t=this.playbackSource.muted;this.playbackSource.muted=e,!e&&t&&!this.playbackSource.isPaused&&this.playbackSource.play()}get muted(){return this.playbackSource.muted}get media(){return this.options.get("media")}get videoBitRate(){return this.modules.incomingData.averageBitRate("video")}get audioBitRate(){return this.modules.incomingData.averageBitRate("audio")}get connectionState(){return this.modules.connection.getState()}get playbackState(){return this.modules.playback.getState()}get bufferFullness(){return this.modules.playback.getBufferFullness()}get sizeBasedResolutionCapEnabled(){return this.modules.constraintCap.sizeBasedResolutionCapEnabled}set sizeBasedResolutionCapEnabled(e){this.modules.constraintCap.sizeBasedResolutionCapEnabled=e}get abrEnabled(){return this.modules.adaptivity.isEnabled}set abrEnabled(e){this.modules.constraintCap.sizeBasedResolutionCapEnabled=!!e&&this.options.get("sizeBasedResolutionCapEnabled"),this.modules.adaptivity.isEnabled=e,this.alignSizeAndBitRate(this.targetSubscription)}get serverEdgeTime(){return this.modules.sync.getLiveEdgeTimeLatencyAdjusted(this.currentSubscription.channelId)}get serverWallclockTime(){return this.modules.sync.getWallclockTimeLatencyAdjusted(this.currentSubscription.channelId)}get currentTime(){return this.modules.sync.serverCurrentTime}get channelCurrentTime(){return this.modules.sync.channelCurrentTime}get targetBufferTime(){return this.modules.playback.getTargetBufferTime()}set targetBufferTime(e){this.modules.playback.getTargetBufferTime()!==e&&(this.modules.playback.setTargetBufferTime(e),this.playbackSource.currentTime=this.modules.sync.serverCurrentTime,this.options.get("burstEnabled",this.channelId)?this.modules.subscription.enableBurst(this.targetBufferTime):this.modules.subscription.enableBurst(0))}get playbackLatency(){var e;if(0!==this.playbackSource.currentTime)return this.targetBufferTime+(null!=(e=this.modules.sync.drift)?e:0)+this.modules.connection.rtt/2}get playbackWallclockTime(){if(this.serverWallclockTime&&this.playbackLatency)return this.serverWallclockTime-this.playbackLatency}get channels(){return this._channels}get languages(){return this.modules.renditions.getLanguages()}get language(){return this.modules.subscription.getTargetSubscription().audio.language}set language(e){this.modules.subscription.setLanguage(e)}set textTrack(e){f(this,ds).forEach((t=>{t.label===e?t.mode="showing":t.mode="hidden"}))}get textTracks(){return f(this,ds).filter((e=>"disabled"!==e.mode)).map((e=>e.label))}get textTrack(){var e;return null==(e=f(this,ds).find((e=>"showing"===e.mode)))?void 0:e.label}get channelId(){return this.modules.subscription.getTargetSubscription().channelId}set channelId(e){if(e===this.channelId)return;this.modules.subscription.setChannelId(e);const t="audio"===this.options.get("media")?[]:this.options.get("videoCodecs"),i=this.modules.renditions.getAudioRenditions(e),s=this.modules.renditions.getVideoRenditions(e),n=this.targetSubscription.audio.language,r=null==i?void 0:i.some((e=>e.language===n)),o=t.find((e=>void 0!==(null==s?void 0:s.find((t=>t.codec===e)))));o&&this.modules.subscription.setVideoCodec(o),this.logger.debug("Channel switch - started",{audioRenditions:i,targetSubscriptionLanguage:n,targetHasCurrentLanguage:r}),this.alignSizeAndBitRate(this.targetSubscription)}get maxSize(){var e,t;const{width:i,height:s}=null!=(t=null==(e=this.modules.constraintCap.getCurrentConstraintCap())?void 0:e.video)?t:ce();return{width:i,height:s}}set maxSize(e){this.modules.constraintCap.setUserSpecifiedCap({video:{width:e.width,height:e.height}}),this.alignSizeAndBitRate(this.targetSubscription)}get maxVideoBitRate(){var e,t;return null!=(t=null==(e=this.modules.constraintCap.getCurrentConstraintCap())?void 0:e.video.bitRate)?t:de()}set maxVideoBitRate(e){this.modules.constraintCap.setUserSpecifiedCap({video:{bitRate:e}}),this.alignSizeAndBitRate(this.targetSubscription)}get maxAudioBitRate(){var e,t;return null!=(t=null==(e=this.modules.constraintCap.getCurrentConstraintCap())?void 0:e.audio.bitRate)?t:de()}set maxAudioBitRate(e){this.modules.constraintCap.setUserSpecifiedCap({audio:{bitRate:e}}),this.alignSizeAndBitRate(this.targetSubscription)}get renditionLevels(){return this.modules.renditions.getRenditionLevels()}get currentRenditionLevel(){return this.modules.renditions.getRenditionLevel()}get targetRenditionLevel(){return this.modules.renditions.getRenditionLevel(this.modules.subscription.getTargetSubscription())}get isSwitchingRenditionLevel(){return this.modules.subscription.isSwitchingSubscription()}get videoBufferedRanges(){var e,t,i,s;return null!=(s=null!=(i=null==(e=this.modules.mseModule)?void 0:e.getBuffer("video"))?i:null==(t=this.modules.decoder)?void 0:t.getBuffer("video"))?s:[]}get audioBufferedRanges(){var e,t,i,s;return null!=(s=null!=(i=null==(e=this.modules.mseModule)?void 0:e.getBuffer("audio"))?i:null==(t=this.modules.decoder)?void 0:t.getBuffer("audio"))?s:[]}getApiClient(){return this.apiClient}get lastBufferEvent(){return this.modules.playback.getLastBufferStateEvent()}get activeRatios(){return this.modules.qualityOfService.activeRatios()}get bufferingRatios(){return this.modules.qualityOfService.bufferingRatios()}get timeSpentBuffering(){return this.modules.qualityOfService.timeSpentBuffering()}get timeActive(){return this.modules.qualityOfService.timeActive()}get mediaElement(){return this.element}get uptime(){return Date.now()-this.createdAt}suspend(){this.isSuspended||(Object.values(this.modules).forEach((e=>{e&&"suspend"in e&&e.suspend()})),this.isSuspended=!0)}unsuspend(){this.isSuspended&&(Object.values(this.modules).forEach((e=>{e&&"unsuspend"in e&&e.unsuspend()})),this.isSuspended=!1)}alignSizeAndBitRate(e){const t=this.modules.constraintCap.constrainSubscription(A(m({},e),{video:m({},e.video),audio:m({},e.audio)})),i=this.modules.constraintCap.getUserSpecifiedCap();!this.abrEnabled&&i&&(t.audio.bitRate=i.audio.bitRate,t.video.bitRate=i.video.bitRate,t.video.width=i.video.width,t.video.height=i.video.height);const s=this.modules.renditions.getRenditionLevel(t);if(s)if(s.video&&(this.modules.subscription.setVideoBitRate(s.video.bitRate),this.modules.subscription.setSize(s.video)),s.audio)this.modules.subscription.setAudioBitRate(s.audio.bitRate),this.modules.subscription.setLanguage(s.audio.language);else if(t.audio.language){let e=this.modules.renditions.getAudioRenditions(t.channelId);!this.abrEnabled&&i&&(e=null==e?void 0:e.filter((e=>e.bitRate<i.audio.bitRate)));const s=t.audio.language,n=null==e?void 0:e.some((e=>e.language===s)),r=null==e?void 0:e.find((e=>e.language)),o=(null==e?void 0:e.length)&&e[0]||void 0;n||(r?(this.logger.debug("Randomizing language since target did not have current language"),this.modules.subscription.setAudioBitRate(r.bitRate),this.modules.subscription.setLanguage(r.language)):(this.logger.debug("Randomizing audio rendition since target did not have current language"),null!=o&&o.bitRate&&this.modules.subscription.setAudioBitRate(o.bitRate),this.modules.subscription.setLanguage(null==o?void 0:o.language)))}}get currentSubscription(){return this.modules.subscription.getCurrentSubscription()}get targetSubscription(){return this.modules.subscription.getTargetSubscription()}willUseMediaSource(){return this.browser.supportsMediaSource&&this.options.get("mseEnabled")}};hs=new WeakMap,ds=new WeakMap,cs=new WeakMap,g(us,"MAX_POOL_SIZE",10),g(us,"INITIAL_MAX_BIT_RATE",25e5),g(us,"PING_TIMEOUT",1e3),g(us,"DISCONNECT_TIMEOUT",15e3),g(us,"REMOVE_CUE_THRESHOLD",1e4);let ls=us}},s={};function n(e){var t=s[e];if(void 0!==t)return t.exports;var r=s[e]={exports:{}};return i[e](r,r.exports,n),r.exports}n.m=i,n.d=(e,t)=>{for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},n.f={},n.e=e=>Promise.all(Object.keys(n.f).reduce(((t,i)=>(n.f[i](e,t),t)),[])),n.u=e=>e+"."+{418:"8adec1ee0f3a27e0fe4d",684:"78b0efe9ae917632040d"}[e]+".bundle.js",n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},t="vindral-examples:",n.l=(i,s,r,o)=>{if(e[i])e[i].push(s);else{var a,h;if(void 0!==r)for(var d=document.getElementsByTagName("script"),c=0;c<d.length;c++){var u=d[c];if(u.getAttribute("src")==i||u.getAttribute("data-webpack")==t+r){a=u;break}}a||(h=!0,(a=document.createElement("script")).charset="utf-8",a.timeout=120,n.nc&&a.setAttribute("nonce",n.nc),a.setAttribute("data-webpack",t+r),a.src=i),e[i]=[s];var l=(t,s)=>{a.onerror=a.onload=null,clearTimeout(m);var n=e[i];if(delete e[i],a.parentNode&&a.parentNode.removeChild(a),n&&n.forEach((e=>e(s))),t)return t(s)},m=setTimeout(l.bind(null,void 0,{type:"timeout",target:a}),12e4);a.onerror=l.bind(null,a.onerror),a.onload=l.bind(null,a.onload),h&&document.head.appendChild(a)}},n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;n.g.importScripts&&(e=n.g.location+"");var t=n.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var i=t.getElementsByTagName("script");if(i.length)for(var s=i.length-1;s>-1&&(!e||!/^http(s?):/.test(e));)e=i[s--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),n.p=e})(),(()=>{var e={672:0};n.f.j=(t,i)=>{var s=n.o(e,t)?e[t]:void 0;if(0!==s)if(s)i.push(s[2]);else{var r=new Promise(((i,n)=>s=e[t]=[i,n]));i.push(s[2]=r);var o=n.p+n.u(t),a=new Error;n.l(o,(i=>{if(n.o(e,t)&&(0!==(s=e[t])&&(e[t]=void 0),s)){var r=i&&("load"===i.type?"missing":i.type),o=i&&i.target&&i.target.src;a.message="Loading chunk "+t+" failed.\n("+r+": "+o+")",a.name="ChunkLoadError",a.type=r,a.request=o,s[1](a)}}),"chunk-"+t,t)}};var t=(t,i)=>{var s,r,[o,a,h]=i,d=0;if(o.some((t=>0!==e[t]))){for(s in a)n.o(a,s)&&(n.m[s]=a[s]);h&&h(n)}for(t&&t(i);d<o.length;d++)r=o[d],n.o(e,r)&&e[r]&&e[r][0](),e[r]=0},i=self.webpackChunkvindral_examples=self.webpackChunkvindral_examples||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))})();var r=n(4088);const o=document.querySelector("#vindral-area"),a=document.querySelector("#vindral-container"),h=document.querySelector("#activate-audio-button"),d=document.querySelector("#playback-state"),c=document.querySelector("#vindral-thumbnail"),u=document.querySelector("#start-button"),l=document.querySelector("#stop-button"),m=document.querySelector("#channel-button"),A=["vindral_demo1_ci_099ee1fa-80f3-455e-aa23-3d184e93e04f","vindral_demo2_ci_dbd1ca98-4e05-4a36-8215-0e8bca295ed2","vindral_demo3_ci_e922b823-3746-481d-bdde-57f356989f71"];let g,p=0;function f(){d.textContent="stopped",g?.unload()}h.style.display="none",u.onclick=()=>(f(),d.textContent="initializing...",c.innerHTML='<img src="https://lb.cdn.vindral.com/api/thumbnail?channelId=vindral_demo1_ci_099ee1fa-80f3-455e-aa23-3d184e93e04f&width=640&height=360" alt="">',g=new r.V({url:"https://lb.cdn.vindral.com",channelId:A[p],channelGroupId:"vindral_demo_pk_932730be-db0c-46a0-a592-cfce7bdc5a43"}),g.on("error",(e=>{e.isFatal()&&console.log("fatal error: ",e.message)})),g.on("playback state",(e=>{d.textContent=e,"playing"===e?(c.style.display="none",o.classList.remove("buffering")):o.classList.add("buffering")})),g.on("metadata",(e=>console.log("metadata: ",e.content))),g.on("needs user input",(()=>h.style.display="block")),g.play(),void g.attach(a)),l.onclick=()=>f(),m.onclick=()=>{g&&(p=++p>=A.length?0:p,g.channelId=A[p],console.log(A[p]))}})();