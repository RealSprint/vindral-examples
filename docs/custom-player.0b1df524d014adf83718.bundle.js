(()=>{"use strict";var t,e,i={2725:(t,e,i)=>{i.d(e,{A:()=>ce,C:()=>he,F:()=>H,L:()=>Rt,V:()=>Em,a:()=>lt,d:()=>ue,i:()=>ht,n:()=>G});var n=i(9633),s=i(3989),r=Object.create,a=Object.defineProperty,o=Object.defineProperties,l=Object.getOwnPropertyDescriptor,h=Object.getOwnPropertyDescriptors,c=Object.getOwnPropertySymbols,d=Object.prototype.hasOwnProperty,u=Object.prototype.propertyIsEnumerable,m=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),p=t=>{throw TypeError(t)},g=(t,e,i)=>e in t?a(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,f=(t,e)=>{for(var i in e||(e={}))d.call(e,i)&&g(t,i,e[i]);if(c)for(var i of c(e))u.call(e,i)&&g(t,i,e[i]);return t},A=(t,e)=>o(t,h(e)),v=(t,e)=>a(t,"name",{value:e,configurable:!0}),b=t=>{var e;return[,,,r(null!=(e=null==t?void 0:t[m("metadata")])?e:null)]},w=["class","method","getter","setter","accessor","field","value","get","set"],y=t=>void 0!==t&&"function"!=typeof t?p("Function expected"):t,S=(t,e,i,n,s)=>({kind:w[t],name:e,metadata:n,addInitializer:t=>i._?p("Already initialized"):s.push(y(t||null))}),k=(t,e)=>g(e,m("metadata"),t[3]),E=(t,e,i,n)=>{for(var s=0,r=t[e>>1],a=r&&r.length;s<a;s++)1&e?r[s].call(i):n=r[s].call(i,n);return n},T=(t,e,i,n,s,r)=>{var o,h,c,d,u,m=7&e,g=!!(8&e),f=!!(16&e),A=m>3?t.length+1:m?g?1:2:0,b=w[m+5],E=m>3&&(t[A-1]=[]),T=t[A]||(t[A]=[]),I=m&&(!f&&!g&&(s=s.prototype),m<5&&(m>3||!f)&&l(m<4?s:{get[i](){return M(this,r)},set[i](t){return R(this,r,t)}},i));m?f&&m<4&&v(r,(m>2?"set ":m>1?"get ":"")+i):v(s,i);for(var C=n.length-1;C>=0;C--)d=S(m,i,c={},t[3],T),m&&(d.static=g,d.private=f,u=d.access={has:f?t=>x(s,t):t=>i in t},3^m&&(u.get=f?t=>(1^m?M:L)(t,s,4^m?r:I.get):t=>t[i]),m>2&&(u.set=f?(t,e)=>R(t,s,e,4^m?r:I.set):(t,e)=>t[i]=e)),h=(0,n[C])(m?m<4?f?r:I[b]:m>4?void 0:{get:I.get,set:I.set}:s,d),c._=1,4^m||void 0===h?y(h)&&(m>4?E.unshift(h):m?f?r=h:I[b]=h:s=h):"object"!=typeof h||null===h?p("Object expected"):(y(o=h.get)&&(I.get=o),y(o=h.set)&&(I.set=o),y(o=h.init)&&E.unshift(o));return m||k(t,s),I&&a(s,i,I),f?4^m?r:I:s},I=(t,e,i)=>g(t,"symbol"!=typeof e?e+"":e,i),C=(t,e,i)=>e.has(t)||p("Cannot "+i),x=(t,e)=>Object(e)!==e?p('Cannot use the "in" operator on this value'):t.has(e),M=(t,e,i)=>(C(t,e,"read from private field"),i?i.call(t):e.get(t)),U=(t,e,i)=>e.has(t)?p("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),R=(t,e,i,n)=>(C(t,e,"write to private field"),n?n.call(t,i):e.set(t,i),i),L=(t,e,i)=>(C(t,e,"access private method"),i),P=(t,e,i,n)=>({set _(n){R(t,e,n,i)},get _(){return M(t,e,n)}}),B=(t,e,i)=>new Promise(((n,s)=>{var r=t=>{try{o(i.next(t))}catch(t){s(t)}},a=t=>{try{o(i.throw(t))}catch(t){s(t)}},o=t=>t.done?n(t.value):Promise.resolve(t.value).then(r,a);o((i=i.apply(t,e)).next())})),_=function(t,e){this[0]=t,this[1]=e},D=(t,e,i)=>{var n=(t,e,s,r)=>{try{var a=i[t](e),o=(e=a.value)instanceof _,l=a.done;Promise.resolve(o?e[0]:e).then((i=>o?n("return"===t?t:"next",e[1]?{done:i.done,value:i.value}:i,s,r):s({value:i,done:l}))).catch((t=>n("throw",t,s,r)))}catch(t){r(t)}},s=t=>r[t]=e=>new Promise(((i,s)=>n(t,e,i,s))),r={};return i=i.apply(t,e),r[m("asyncIterator")]=()=>r,s("next"),s("throw"),s("return"),r},N=t=>{var e,i=t[m("asyncIterator")],n=!1,s={};return null==i?(i=t[m("iterator")](),e=t=>s[t]=e=>i[t](e)):(i=i.call(t),e=t=>s[t]=e=>{if(n){if(n=!1,"throw"===t)throw e;return e}return n=!0,{done:!1,value:new _(new Promise((n=>{var s=i[t](e);s instanceof Object||p("Object expected"),n(s)})),1)}}),s[m("iterator")]=()=>s,e("next"),"throw"in i?e("throw"):s.throw=t=>{throw t},"return"in i&&e("return"),s},W=(t,e,i)=>(e=t[m("asyncIterator")])?e.call(t):(t=t[m("iterator")](),e={},i=(i,n)=>(n=t[i])&&(e[i]=e=>new Promise(((i,s,r)=>(e=n.call(t,e),r=e.done,Promise.resolve(e.value).then((t=>i({value:t,done:r})),s))))),i("next"),i("return"),e),O=(t,e,i)=>{var n;return null!=e?("object"!=typeof e&&"function"!=typeof e&&p("Object expected"),i&&(n=e[m("asyncDispose")]),void 0===n&&(n=e[m("dispose")]),"function"!=typeof n&&p("Object not disposable"),t.push([i,n,e])):i&&t.push([i]),e},F=(t,e,i)=>{var n="function"==typeof SuppressedError?SuppressedError:function(t,e,i,n){return(n=Error(i)).name="SuppressedError",n.error=t,n.suppressed=e,n},s=t=>e=i?new n(t,e,"An error was suppressed during disposal"):(i=!0,t),r=n=>{for(;n=t.pop();)try{var a=n[1]&&n[1].call(n[2]);if(n[0])return Promise.resolve(a).then(r,(t=>(s(t),r())))}catch(t){s(t)}if(i)throw e};return r()};class V{constructor(t){I(this,"maxSize",0),I(this,"size",0),I(this,"buffers",[]),I(this,"_borrowedBuffers",0),I(this,"get",(t=>{const e=this.buffers.shift();return this._borrowedBuffers++,this.size<t||!e?(this.buffers=[],this.size=t,new ArrayBuffer(t)):e})),I(this,"reclaim",(t=>{this._borrowedBuffers=Math.max(0,this._borrowedBuffers-1),!(t.byteLength<this.size)&&(this.buffers.length>=this.maxSize||this.buffers.push(t))})),this.maxSize=t}get bufferSize(){return this.size}get poolSize(){return this.buffers.length}get borrowedBuffers(){return this._borrowedBuffers}}const G=()=>{};class z{constructor(){I(this,"promise"),I(this,"resolved"),I(this,"resolve"),I(this,"reject"),I(this,"pending",!0),this.promise=new Promise(((t,e)=>{this.resolve=e=>{this.pending=!1,this.resolved=e,t(e)},this.reject=t=>{this.pending=!1,e(t)}})),this.promise.catch(G)}static resolved(t){const e=new z;return e.resolve(t),e}static fromPromise(t){const e=new z;return e.promise=t,t.then((t=>{e.pending=!1,e.resolved=t}),(t=>{e.pending=!1,e.reject(t)})),e}}class H{constructor(t=50){I(this,"maxSize"),I(this,"values",[]),I(this,"push",(t=>{this.isFull()&&this.pop(),this.values.push(t)})),I(this,"clear",(()=>{this.values=[]})),I(this,"pop",(()=>this.values.shift())),I(this,"peekFirst",(()=>this.values[0])),I(this,"peekLast",(()=>this.values[this.values.length-1])),I(this,"isFull",(()=>this.values.length>=this.maxSize)),I(this,"isEmpty",(()=>0===this.values.length)),I(this,"items",(()=>this.values)),I(this,"filterPop",(t=>{for(;this.peekFirst()&&!t(this.peekFirst());)this.pop()})),this.maxSize=t}}function j(t){const e=new Z(t);return[e,e]}var X,q,Q,$;class Z{constructor(t){U(this,X),U(this,q,new z),U(this,Q),U(this,$,!1),R(this,X,new H(t))}isFull(){return M(this,X).isFull()}close(){var t;null==(t=M(this,Q))||t.resolve(),R(this,$,!0)}abort(t){var e,i;null==(e=M(this,Q))||e.promise.catch(G),null==(i=M(this,Q))||i.reject(t)}push(t){return B(this,null,(function*(){var e;M(this,X).isFull()&&(yield M(this,q).promise),M(this,X).push(t),null==(e=M(this,Q))||e.resolve(),R(this,Q,new z)}))}pop(){return B(this,null,(function*(){for(var t;!M(this,$)||!M(this,X).isEmpty();){const e=M(this,X).pop();if(e)return M(this,q).resolve(),R(this,q,new z),e;M(this,Q)||R(this,Q,new z),yield null==(t=M(this,Q))?void 0:t.promise}}))}start(t){}pull(t){return B(this,null,(function*(){const e=yield this.pop();e?t.enqueue(e):t.close()}))}cancel(t){this.abort(new Error(t))}next(){return B(this,null,(function*(){const t=yield this.pop().catch((()=>{}));return t?{done:!1,value:t}:{done:!0,value:void 0}}))}return(){return this.close(),Promise.resolve({done:!0,value:void 0})}[Symbol.asyncIterator](){return this}}function K(t){const e=atob(t),i=new Uint8Array(e.length);for(let t=0;t<e.length;t++)i[t]=e.charCodeAt(t);return i.buffer}function J(t){return"function"==typeof BigInt?BigInt(t):t}X=new WeakMap,q=new WeakMap,Q=new WeakMap,$=new WeakMap;class Y{constructor(t,e=0){I(this,"buffer"),I(this,"bytes"),I(this,"bitOffset"),I(this,"peekBit",(()=>this.getBit(this.bytes,this.bitOffset))),I(this,"readBit",(()=>{const t=this.peekBit();return this.bitOffset++,t})),I(this,"readBits",(t=>{let e=0;for(let i=0;i<t;i++)e=e<<1|(this.getBit(this.bytes,this.bitOffset++)?1:0);return e})),I(this,"readSignedExpGolomb",(()=>{const t=this.readUnsignedExpGolomb();return 1&t?(t+1)/2:-t/2})),I(this,"readUnsignedExpGolomb",(()=>{let t=0;for(;0===this.getBit(this.bytes,this.bitOffset++);)t++;let e=1<<t;for(let i=t-1;i>=0;i--)e|=this.getBit(this.bytes,this.bitOffset++)<<i;return e-1})),I(this,"getBit",((t,e)=>t[e>>3]>>7-(7&e)&1)),this.buffer=t,this.bytes=new Uint8Array(this.buffer),this.bitOffset=e}}function tt(){const t=self.MediaSource,e=self.ManagedMediaSource;return null!=t?t:e}const et=new RegExp("(android|bbd+|meego).+mobile|avantgo|bada/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)/|plucker|pocket|psp|series(4|6)0|symbian|treo|up.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw-(n|u)|c55/|capi|ccwa|cdm-|cell|chtm|cldc|cmd-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc-s|devi|dica|dmob|do(c|p)o|ds(12|-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(-|_)|g1 u|g560|gene|gf-5|g-mo|go(.w|od)|gr(ad|un)|haie|hcit|hd-(m|p|t)|hei-|hi(pt|ta)|hp( i|ip)|hs-c|ht(c(-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i-(20|go|ma)|i230|iac( |-|/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |/)|klon|kpt |kwc-|kyo(c|k)|le(no|xi)|lg( g|/(k|l|u)|50|54|-[a-w])|libw|lynx|m1-w|m3ga|m50/|ma(te|ui|xo)|mc(01|21|ca)|m-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|-([1-8]|c))|phil|pire|pl(ay|uc)|pn-2|po(ck|rt|se)|prox|psio|pt-g|qa-a|qc(07|12|21|32|60|-[2-7]|i-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55/|sa(ge|ma|mm|ms|ny|va)|sc(01|h-|oo|p-)|sdk/|se(c(-|0|1)|47|mc|nd|ri)|sgh-|shar|sie(-|m)|sk-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h-|v-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl-|tdg-|tel(i|m)|tim-|t-mo|to(pl|sh)|ts(70|m-|m3|m5)|tx-9|up(.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas-|your|zeto|zte-/","i"),it=navigator.userAgent.toLowerCase(),nt=et.test(it),st=()=>{const t=document.createElement("video");return""!==t.canPlayType("application/vnd.apple.mpegURL")||""!==t.canPlayType("audio/mpegurl")},rt=()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const t=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(t instanceof WebAssembly.Module)return new WebAssembly.Instance(t)instanceof WebAssembly.Instance}}catch(t){return!1}return!1},at=()=>"MacIntel"===navigator.platform&&0===navigator.maxTouchPoints,ot=()=>"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1,lt=()=>"ontouchstart"in window||navigator.maxTouchPoints>0,ht=()=>/^(?!.*chrome).*safari/i.test(it);function ct(){var t,e;if(/(iPhone|iPod|iPad)/i.test(it))return null==(e=null==(t=null==it?void 0:it.match(/OS [\d_]+/i))?void 0:t[0])?void 0:e.substring(3).split("_").map((t=>parseInt(t)))[0]}function dt(){var t,e;if(/^((?!chrome|android).)*safari/i.test(it))return null==(e=null==(t=it.match(/version\/([\d.]+)/))?void 0:t[1])?void 0:e.split(".").map((t=>parseInt(t)))[0]}const ut=()=>{var t,e;const i=!!tt();let n=!1;return i&&(n=(()=>{var t,e;return!ot()&&null!=(e=null==(t=tt())?void 0:t.isTypeSupported('audio/mp4; codecs="opus"'))&&e})()),{isMobile:nt,supportsMp4Opus:n,supportsMediaSource:i,supportsHls:st(),supportsWebAssembly:rt(),platform:{iosVersion:null!=(t=ct())?t:Number.MAX_SAFE_INTEGER,safariVersion:null!=(e=dt())?e:Number.MAX_SAFE_INTEGER,isIpadOS:ot(),isMacOS:at(),isIOS:it.indexOf("iphone")>=0&&it.indexOf("like iphone")<0||it.indexOf("ipad")>=0&&it.indexOf("like ipad")<0||it.indexOf("ipod")>=0&&it.indexOf("like ipod")<0||ot()}}},mt=(t,e,i)=>{let n=0;for(let s=e;s<=i;s++)if(s===e){const e=t[s];n+=127&e,128&e&&(n-=128)}else n=256*n+t[s];return n};var pt,gt,ft;class At{constructor(t){U(this,pt),U(this,gt),U(this,ft),R(this,gt,t),R(this,ft,new DataView(t.buffer,t.byteOffset,t.byteLength)),R(this,pt,0)}position(){return M(this,pt)}byteOffset(){return M(this,gt).byteOffset+M(this,pt)}buffer(){return M(this,gt)}remaining(){return M(this,gt).length-M(this,pt)}readUint8(){const t=M(this,ft).getUint8(M(this,pt));return R(this,pt,M(this,pt)+1),t}readUint24(){const t=M(this,ft).getUint32(M(this,pt))>>8&16777215;return R(this,pt,M(this,pt)+3),t}readUint16(){const t=M(this,ft).getUint16(M(this,pt));return R(this,pt,M(this,pt)+2),t}readUint32(){const t=M(this,ft).getUint32(M(this,pt));return R(this,pt,M(this,pt)+4),t}readUint64(){const t=mt(M(this,gt),M(this,pt),M(this,pt)+7);return R(this,pt,M(this,pt)+8),t}readBytes(t){const e=M(this,gt).subarray(M(this,pt),M(this,pt)+t);return R(this,pt,M(this,pt)+t),e}readRemaining(){return this.readBytes(this.remaining())}readUtf8String(){const t=[];let e;for(;0!==(e=this.readUint8())&&(t.push(e),0!=this.remaining()););return(new TextDecoder).decode(new Uint8Array(t))}}pt=new WeakMap,gt=new WeakMap,ft=new WeakMap;class vt{constructor(t=100,e=100){I(this,"resizeSteps"),I(this,"internalBuffer"),I(this,"view"),I(this,"uint8"),I(this,"_position",0),I(this,"_end",0),this.resizeSteps=e,this.internalBuffer=new ArrayBuffer(t),this.view=new DataView(this.internalBuffer),this.uint8=new Uint8Array(this.internalBuffer)}position(){return this._position}seek(t){this._position=Math.max(0,Math.min(this._end,t))}seekToEnd(){this._position=this._end}writeUint8(t){this.writeAndMove(t,1)}writeUint16(t){this.writeAndMove(t,2)}writeUint24(t){this.writeAndMove(t,3)}writeUint32(t){this.writeAndMove(t,4)}writeUint32At(t,e){this.view.setUint32(t,e)}writeBytes(t){this.resizeIfNeeded(this.position()+t.byteLength),this.uint8.set(t,this.position()),this._position+=t.byteLength,this._end=Math.max(this._end,this._position)}buffer(){return this.internalBuffer.slice(0,this._end)}write(t,e){switch(this.resizeIfNeeded(this.position()+e),e){case 1:this.view.setUint8(this.position(),t);break;case 2:this.view.setUint16(this.position(),t);break;case 3:this.view.setUint8(this.position(),t>>16&255),this.view.setUint8(this.position()+1,t>>8&255),this.view.setUint8(this.position()+2,255&t);break;case 4:this.view.setUint32(this.position(),t)}}writeAndMove(t,e){this.write(t,e),this._position+=e,this._end=Math.max(this._end,this._position)}resizeIfNeeded(t){if(t>this.internalBuffer.byteLength){const e=new ArrayBuffer(t+this.resizeSteps),i=new Uint8Array(e);i.set(this.uint8),this.internalBuffer=e,this.view=new DataView(this.internalBuffer),this.uint8=i}}}class bt{constructor(t,e,i){I(this,"onSuccess"),I(this,"onError"),I(this,"doExecute"),this.doExecute=t,this.onSuccess=e,this.onError=i}execute(t){try{this.doExecute(t),this.onSuccess()}catch(t){this.onError(t)}}}const wt=t=>t.reduce(((t,e)=>t+e),0)/t.length,yt=t=>({last:t[t.length-1]||0,average:0===t.length?0:wt(t),max:0===t.length?0:Math.max(...t),min:0===t.length?0:Math.min(...t)});class St{constructor(t=10){I(this,"rates"),I(this,"_total",0),I(this,"accumulatedValues",0),I(this,"lastTickTime",Date.now()),I(this,"add",(t=>{this.accumulatedValues+=t,this._total+=t})),I(this,"tick",(()=>{const t=this.accumulatedValues/((Date.now()-this.lastTickTime)/1e3);this.rates.push(t),this.accumulatedValues=0,this.lastTickTime=Date.now()})),this.rates=new H(t)}get total(){return this._total}get average(){return this.rates.isEmpty()?0:wt(this.rates.items())}get minMaxAverage(){return yt(this.rates.items())}}const kt=(t,e)=>{if(t===e)return!0;if(null==t||"object"!=typeof t||null==e||"object"!=typeof e)return!1;let i=0,n=0;for(const e in t)i+=1;for(const i in e)if(n+=1,!(i in t)||!kt(t[i],e[i]))return!1;return i==n},Et=["off","error","warn","info","debug","trace"];var Tt,It,Ct,xt,Mt;const Ut=class t{constructor({context:t,logLevel:e,debug:i}){U(this,Tt,new Map),U(this,It,""),U(this,Ct,!1),U(this,xt,"off"),I(this,"trace",((...t)=>{})),I(this,"debug",((...t)=>{})),I(this,"info",((...t)=>{})),I(this,"warn",((...t)=>{})),I(this,"error",((...t)=>{})),I(this,"table",((...t)=>{})),I(this,"count",((...t)=>{})),R(this,It,t),R(this,xt,e),R(this,Ct,i||!1),this.setLevel(e),this.setDebug(M(this,Ct))}setDebug(t){R(this,Ct,t);for(const[e,i]of M(this,Tt))i.setDebug(t);t?(this.table=console.table.bind(console),this.count=console.count.bind(console)):(this.table=()=>{},this.count=()=>{})}setLevel(t){R(this,xt,t);for(const[e,i]of M(this,Tt))i.setLevel(t);const e=Et.indexOf(t);for(const[t,i]of Et.entries())"off"!==i&&(this[i]=t<=e?console[i].bind(console,"%c%s %c%s","font-weight:bold;",i.toUpperCase(),"font-weight:normal;",M(this,It)):()=>{})}createContext(e){const i=M(this,Tt).get(e);if(!i){const i=new t({context:`${e}`,logLevel:M(this,xt),debug:M(this,Ct)});return M(this,Tt).set(e,i),i}return i}static get(){return M(t,Mt)||R(t,Mt,new t({context:"Vindral",logLevel:"off"})),M(t,Mt)}};Tt=new WeakMap,It=new WeakMap,Ct=new WeakMap,xt=new WeakMap,Mt=new WeakMap,U(Ut,Mt);let Rt=Ut;function Lt(t){const e=Rt.get().createContext(t.context);return function(i,n){const s=String(n.name);return function(...n){t.enter&&e[t.enter](`Enter '${s}'`,f({},n));try{const r=i.call(this,...n);return r instanceof Promise?r.then((i=>{t.return&&e[t.return](`Return '${s}'`,i)})).catch((i=>{t.error&&e[t.error](`Error '${s}'`,i)})):t.return&&e[t.return](`Return '${s}'`,r),r}catch(i){throw t.error&&e[t.error](`Error '${s}'`,i),i}}}}function Pt(){return"symbol"!=typeof Symbol.asyncDispose&&Object.defineProperty(Symbol,"asyncDispose",{value:Symbol.for("asyncDispose")}),Symbol.asyncDispose}function Bt(){return"symbol"!=typeof Symbol.dispose&&Object.defineProperty(Symbol,"dispose",{value:Symbol.for("dispose")}),Symbol.dispose}var _t,Dt,Nt,Wt,Ot,Ft;class Vt{constructor(t,e){U(this,_t),I(this,"value"),I(this,"unlocker"),this.value=t,this.unlocker=e}unlocked(){var t;return null==(t=this.unlocker)?void 0:t.promise}[Bt()](){L(this,_t,Dt).call(this)}[Symbol.dispose](){L(this,_t,Dt).call(this)}}_t=new WeakSet,Dt=function(){this.unlocker.resolve(this.value)};class Gt{constructor(t){U(this,Nt),U(this,Wt,new z),R(this,Nt,t),M(this,Wt).resolve(t)}unsafeValue(){return M(this,Nt)}isLocked(){return M(this,Wt).pending}lock(){return B(this,null,(function*(){const t=new z;t.promise.then((t=>{R(this,Nt,t)})).catch(G);const e=M(this,Wt).promise.then((()=>t));return R(this,Wt,t),yield e,new Vt(M(this,Nt),t)}))}}Nt=new WeakMap,Wt=new WeakMap;class zt{constructor(t){U(this,Ot),U(this,Ft),R(this,Ot,t),R(this,Ft,new z)}isClosed(){var t;return!(null!=(t=M(this,Ft))&&t.pending)}current(){return M(this,Ot)}value(){var t;return[M(this,Ot),null==(t=M(this,Ft))?void 0:t.promise]}update(t){var e;if(null==(e=M(this,Ft))||!e.pending)throw new Error("ObservableValue is closed");R(this,Ot,t instanceof Function?t(M(this,Ot)):t),M(this,Ft).resolve(M(this,Ot)),R(this,Ft,new z)}close(){var t;null==(t=M(this,Ft))||t.resolve(M(this,Ot)),R(this,Ft,void 0)}waitFor(t){return B(this,null,(function*(){if(t(M(this,Ot)))return M(this,Ot);for(;;){const[e,i]=this.value();if(!i)throw new Error("ObservableValue was closed while waiting for condition");const n=yield i;if(t(n))return n}}))}[Symbol.asyncIterator](){return D(this,null,(function*(){for(;;){const[t,e]=this.value();if(yield t,!e)return;yield new _(e)}}))}}Ot=new WeakMap,Ft=new WeakMap;const Ht=(t,e)=>{const i=f({},t);return"object"!=typeof i||e.forEach((t=>{delete i[t]})),i},jt=(t,e=Date.now())=>{const i=t.length;if(i>0){const n=t[i-1];n.end||(n.end=e)}},Xt=(t,e=Date.now())=>{jt(t),t.push({start:e})},qt=t=>t.reduce(((t,e)=>{var i;return t+((null!=(i=e.end)?i:Date.now())-e.start)}),0),Qt=(t,e,i=Date.now())=>t.reduce(((t,n)=>{var s;const r=Math.max(i-e,n.start),a=null!=(s=n.end)?s:i;return Math.max(0,a-r)+t}),0),$t=class{constructor(){I(this,"pendingTimeouts",new Set),I(this,"pendingIntervals",new Set),I(this,"clearTimeout",(t=>{this.pendingTimeouts.delete(t)&&window.clearTimeout(t)})),I(this,"clearInterval",(t=>{this.pendingIntervals.delete(t)&&window.clearInterval(t)})),I(this,"setTimeout",((t,e,...i)=>{const n=window.setTimeout((()=>{t(...i),this.clearTimeout(n)}),e);return this.pendingTimeouts.add(n),n})),I(this,"setInterval",((t,e,...i)=>{const n=window.setInterval((()=>{t(...i)}),e);return this.pendingIntervals.add(n),n})),I(this,"unload",(()=>{this.pendingIntervals.forEach(this.clearInterval),this.pendingTimeouts.forEach(this.clearTimeout)}))}};I($t,"create",(()=>new $t));let Zt=$t;function Kt(t){try{return t()}catch(t){return t}}const Jt=()=>{const t=[...Array(256).keys()].map((t=>t.toString(16).padStart(2,"0"))),e=crypto.getRandomValues(new Uint8Array(16));return e[6]=15&e[6]|64,e[8]=63&e[8]|128,[...e.entries()].map((([e,i])=>[4,6,8,10].includes(e)?`-${t[i]}`:t[i])).join("")},Yt=t=>B(void 0,null,(function*(){return new Promise((e=>setTimeout(e,t)))})),te=(t,...e)=>B(void 0,[t,...e],(function*(t,e=new Error("Timeout")){return new Promise(((i,n)=>setTimeout((()=>n(e)),t)))})),ee=(t,e)=>B(void 0,null,(function*(){throw yield t,new Error(e)})),ie=t=>"width"in t&&"number"==typeof t.width,ne=t=>"sampleRate"in t&&"number"==typeof t.sampleRate,se=t=>{switch(t.codec){case"opus":return'audio/mp4; codecs="opus"';case"mp3":return"audio/mpeg";case"webvtt":return"text/vtt";case"aac":return t.codecString?`audio/mp4; codecs="${t.codecString}"`:"audio/mp4";case"h264":case"av1":return t.codecString?`video/mp4; codecs="${t.codecString}"`:"video/mp4"}},re=()=>Number.MAX_SAFE_INTEGER,ae=()=>({width:Number.MAX_SAFE_INTEGER,height:Number.MAX_SAFE_INTEGER}),oe=t=>!("object"!=typeof t||null===t||!("type"in t)),le={sizeBasedResolutionCapEnabled:!0,pictureInPictureEnabled:!0,abrEnabled:!0,burstEnabled:!1,mseEnabled:!0,mseOpusEnabled:!1,muted:!1,minBufferTime:1500,maxBufferTime:1500,logLevel:"off",maxSize:ae(),maxVideoBitRate:re(),maxAudioBitRate:re(),tags:[],media:"audio+video",poster:!0,reconnectHandler:t=>t.reconnectRetries<30,iosWakeLockEnabled:!1,telemetryEnabled:!0,iosMediaElementEnabled:!1,pauseSupportEnabled:!0,advanced:{wasmDecodingConstraint:{bitRate:Number.MAX_SAFE_INTEGER,width:1280,height:1280}},videoCodecs:["av1","h264"],webtransportEnabled:!0},he="connection_failed",ce="access_forbidden";class de extends Error{constructor(t,e,i={}){super(t),I(this,"props"),I(this,"extra",{}),I(this,"code",(()=>this.props.code)),I(this,"isFatal",(()=>this.props.isFatal)),I(this,"source",(()=>this.props.source)),I(this,"type",(()=>{var t;return null!=(t=this.props.type)?t:"external"})),I(this,"toStringifiable",(()=>{var t;const e=this.source(),i=e instanceof Error?e.stack:this.stack;return A(f({},this.extra),{code:this.props.code,isFatal:this.props.isFatal,type:this.props.type,message:this.message,sourceMessage:null==(t=this.source())?void 0:t.message,stack:i})})),this.props=e,this.extra=i,Object.setPrototypeOf(this,new.target.prototype)}}const ue=(t,e)=>new de("Decoder Error",{isFatal:t,code:"decoder_error",source:e,type:"internal"}),me=(t,e)=>new de("Audio Player Error",{isFatal:t,code:"audio_player_error",source:e,type:"internal"}),pe=(t,e,i,n)=>new de("MediaSource Error",{isFatal:t,code:"media_source_error",source:e,type:"internal"},{type:n,consecutiveErrorsCount:i}),ge=(t,e)=>new de(`No track context for ${t}${e?`, rendition id ${e}`:""}`,{isFatal:!1,code:"no_track_context",type:"internal"}),fe=t=>new de("Disconnected From Edge Server",{type:"external",source:t,isFatal:!1,code:"disconnected_by_edge"}),Ae=t=>new de("Authentication Failed",{isFatal:!0,code:"authentication_error",source:t}),ve=(t,e)=>new de("Channel not found",{isFatal:!1,code:"channel_not_found",source:e,type:t}),be=()=>new de("Connection failed - no more reconnect attempts",{isFatal:!0,code:"connection_failed_will_not_attempt_again"}),we=t=>new de(t,{isFatal:!0,code:ce}),ye=t=>new de(`Channel switch to '${t}' failed`,{isFatal:!1,code:"channel_switch_failed"}),Se=(t,e=!1,i)=>new de(t,{isFatal:e,code:"drm_error",source:i}),ke=(t,e)=>t&&"object"==typeof t&&e in t,Ee={playready:["150","2000","3000"],widevine:["SW_SECURE_CRYPTO","SW_SECURE_DECODE","HW_SECURE_CRYPTO","HW_SECURE_DECODE","HW_SECURE_ALL"],fairplay:[""],clearkey:[""]},Te={initDataTypes:["cenc"],audioCapabilities:[{contentType:'audio/mp4; codecs="mp4a.40.2"'}],videoCapabilities:[{contentType:'video/mp4; codecs="avc1.42c01f"'}]},Ie={fairplay:{keySystem:"com.apple.fps",supportedConfig:{initDataTypes:["sinf"],videoCapabilities:[{contentType:'video/mp4; codecs="avc1.42c01f"'}]}},playready:{keySystem:"com.microsoft.playready",supportedConfig:Te},widevine:{keySystem:"com.widevine.alpha",supportedConfig:Te},clearkey:{keySystem:"org.w3.clearkey",supportedConfig:Te}},Ce=(t,e)=>B(void 0,null,(function*(){return navigator.requestMediaKeySystemAccess(t,[e]).catch((()=>{}))})),xe=(t,e,i,n,s,r)=>B(void 0,null,(function*(){let a;for(const o of n){const n=null==i?void 0:i.map((t=>A(f({},t),{robustness:o,contentType:r?`${"audioCapabilities"===s?"audio/mp4":"video/mp4"}; codecs="${r}"`:t.contentType})));if(!(yield Ce(t,{initDataTypes:e,[s]:n})))break;a=n}return a})),Me=(t,e,i)=>B(void 0,null,(function*(){const{keySystem:n,supportedConfig:s}=Ie[t],{initDataTypes:r,videoCapabilities:a,audioCapabilities:o}=s,l=Ee[t],[h,c]=yield Promise.all([xe(n,r,a,l,"videoCapabilities",e),xe(n,r,o,l,"audioCapabilities",i)]);return h||c?yield Ce(n,{initDataTypes:r,videoCapabilities:h,audioCapabilities:c}):void 0}));var Ue,Re,Le,Pe,Be,_e,De,Ne,We,Oe,Fe,Ve,Ge,ze,He,je,Xe,qe,Qe,$e,Ze,Ke,Je,Ye,ti,ei,ii,ni;class si{constructor(t,e,i,n){I(this,"keySystem"),I(this,"licenseServerUrl"),I(this,"certificate"),I(this,"headers",{}),I(this,"queryParams",{}),U(this,Ue),U(this,Re),R(this,Ue,e),this.keySystem=t,this.licenseServerUrl=i,this.certificate=n}get statistics(){return{keySystem:M(this,Ue).keySystem,licenseServerUrl:this.licenseServerUrl,mediaKeySystemConfiguration:M(this,Ue).getConfiguration()}}getMediaKeys(){return B(this,null,(function*(){return M(this,Re)||R(this,Re,yield M(this,Ue).createMediaKeys()),M(this,Re)}))}requestLicense(t){return B(this,null,(function*(){const e=new URL(this.licenseServerUrl);for(const[t,i]of Object.entries(this.queryParams))e.searchParams.append(t,i);const i=yield fetch(e,{method:"POST",body:t,headers:f({"Content-Type":"application/octet-stream"},this.headers)});if(!i.ok)throw new Error(`Failed to fetch license: ${i.statusText}`);return yield i.arrayBuffer()}))}}function ri(t){const e=window.atob(t.replace(/-/g,"+").replace(/_/g,"/"));let i="";for(let t=0;t<e.length;t++)i+=("0"+e.charCodeAt(t).toString(16)).substr(-2);return i}function ai(t){let e="";for(let i=0;i<t.length;i+=2)e+=String.fromCharCode(parseInt(t.substr(i,2),16));return window.btoa(e).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function oi(t,e){if(t.byteLength!==e.byteLength)return!1;const i=new Uint8Array(t),n=new Uint8Array(e);for(let t=0;t<i.length;t++)if(i[t]!==n[t])return!1;return!0}Ue=new WeakMap,Re=new WeakMap;class li extends si{constructor(t,e){super("clearkey",t,""),U(this,Le),R(this,Le,e)}handleLicenseRequest(t){const e=new Uint8Array(t),i=String.fromCharCode(...e),n=JSON.parse(i),s=[];for(let t=0;t<n.kids.length;t++){const e=n.kids[t];if(e){const t=ri(e).toLowerCase(),i=M(this,Le)[t];i&&s.push({kty:"oct",alg:"A128KW",kid:e,k:ai(i)})}}const r=JSON.stringify({keys:s,type:n.type});return(new TextEncoder).encode(r)}}Le=new WeakMap;class hi extends si{constructor(t,e,i){super("fairplay",t,e,i)}}class ci extends si{constructor(t,e){super("playready",t,e)}requestLicense(t){return B(this,null,(function*(){(0,s.a)(this.licenseServerUrl,"No license server URL set");const e=new URL(this.licenseServerUrl);for(const[t,i]of Object.entries(this.queryParams))e.searchParams.append(t,i);const i=(t=>{var e,i,n,s;const r=String.fromCharCode(...new Uint16Array(t)),a=(new window.DOMParser).parseFromString(r,"application/xml"),o=a.getElementsByTagName("HttpHeaders")[0];let l={};if(o){const t=o.getElementsByTagName("name"),n=o.getElementsByTagName("value");for(let s=0;s<t.length;s++){const r=null==(e=t[s])?void 0:e.childNodes[0],a=null==(i=n[s])?void 0:i.childNodes[0];null!=r&&r.nodeValue&&a&&a.nodeValue&&(l[r.nodeValue]=a.nodeValue)}}const h=a.getElementsByTagName("Challenge")[0];let c;return h&&null!=(n=h.childNodes[0])&&n.nodeValue&&(c=window.atob(null==(s=h.childNodes[0])?void 0:s.nodeValue)),a.querySelector("parsererror")&&(l={"Content-Type":"text/xml; charset=utf-8",SOAPAction:'"http://schemas.microsoft.com/DRM/2007/03/protocols/AcquireLicense"'},c=t),{headers:l,message:c}})(t),n=yield fetch(e,{method:"POST",headers:f(f({},i.headers),this.headers),body:i.message});if(!n.ok)throw new Error(`Failed to fetch license: ${n.statusText}`);return yield n.arrayBuffer()}))}}class di extends si{constructor(t,e){super("widevine",t,e)}}class ui{constructor(t,e,i,n){U(this,Xe),U(this,Pe),U(this,Be),U(this,_e),U(this,De,new z),U(this,Ne,{}),U(this,We,{}),U(this,Oe),U(this,Fe,new Map),U(this,Ve),U(this,Ge),U(this,ze,ut()),U(this,He,(t=>{if(M(this,Pe).info("Received DRM data",{options:t}),window.clearTimeout(M(this,Ge)),M(this,Oe)){const e=L(this,Xe,ni).call(this,t)[M(this,Oe).keySystem];e&&(M(this,Oe).licenseServerUrl=e)}M(this,De).resolve(t)})),U(this,je,(t=>{M(this,Pe).info("Encrypted event received",{event:t}),L(this,Xe,qe).call(this,t)})),U(this,Ke,(t=>{var e,i;M(this,Pe).debug("Session message received",{event:t});const n=t.target,s=t.message;M(this,Fe).get(n)?(M(this,Pe).debug("Requesting license for session",{sessionId:n.sessionId,licenseServerUrl:null==(e=M(this,Oe))?void 0:e.licenseServerUrl}),null==(i=M(this,Oe))||i.requestLicense(s).then((t=>{M(this,Pe).debug("License received for session",{sessionId:n.sessionId}),n.update(t).catch((t=>{L(this,Xe,ti).call(this,{message:"Failed to update session with license",isFatal:!1,error:t})}))})).catch((t=>{L(this,Xe,ti).call(this,{message:"Failed to request license",isFatal:!1,error:t})}))):M(this,Pe).error("No active session found for event",{event:t})})),U(this,Je,(t=>{const e=t.target;M(this,Pe).debug("Key status changed for session",{sessionId:e.sessionId}),e.keyStatuses.forEach(((t,e)=>{const i=ri(window.btoa(String.fromCharCode(...new Uint8Array(e))));M(this,Pe).debug("Key status",{base64kid:i,status:t})}))})),U(this,ei,(t=>B(this,null,(function*(){const e=L(this,Xe,ii).call(this,t);M(this,Pe).debug("Prioritized key system list",{keySystemList:e});const i=yield((t,e,i)=>B(void 0,null,(function*(){let n;for(const s of t)if(n=yield Me(s,e,i),n)return{keySystem:s,mediaKeySystemAccess:n}})))(e,t.videoCodec,t.audioCodec);if(!i)return M(this,Pe).warn("No supported key system found"),null;M(this,Pe).debug("Supported key system found",i.mediaKeySystemAccess.getConfiguration());const{keySystem:n,mediaKeySystemAccess:r}=i;let a=null;return"clearkey"===n?((0,s.a)(t.clearkeys,"No clearkeys found"),a=new li(r,t.clearkeys)):"playready"===n?((0,s.a)(t.playreadyLicenseUrl,"No playreadyLicenseUrl found"),a=new ci(r,t.playreadyLicenseUrl)):"widevine"===n?((0,s.a)(t.widevineLicenseUrl,"No widevineLicenseUrl found"),a=new di(r,t.widevineLicenseUrl)):"fairplay"===n&&((0,s.a)(t.fairplayLicenseUrl,"No fairplayLicenseUrl found"),(0,s.a)(t.fairplayCertificate,"No fairplayCertificate found"),a=new hi(r,t.fairplayLicenseUrl,t.fairplayCertificate)),a&&(a.headers=M(this,Ne),a.queryParams=M(this,We)),a})))),R(this,Be,t),R(this,Pe,e),R(this,Ne,i||{}),R(this,We,n||{}),M(this,Be).on("received drm data",M(this,He))}static isSupported(){return!!navigator.requestMediaKeySystemAccess}attach(t){R(this,_e,t),M(this,Pe).info("Media element attached"),M(this,_e).addEventListener("encrypted",M(this,je))}getStatistics(){var t,e;return M(this,De).resolved||null!=(t=M(this,Oe))&&t.statistics?f(f({},M(this,De).resolved),null==(e=M(this,Oe))?void 0:e.statistics):null}unload(){var t;M(this,Pe).info("Unloading EncryptedMediaExtensions"),M(this,Be).off("received drm data",M(this,He)),null==(t=M(this,_e))||t.removeEventListener("encrypted",M(this,je)),M(this,Fe).forEach(((t,e)=>{e.close()})),M(this,Fe).clear(),R(this,Ve,void 0),R(this,Oe,void 0)}set headers(t){R(this,Ne,t),M(this,Oe)&&(M(this,Oe).headers=t)}set queryParams(t){R(this,We,t),M(this,Oe)&&(M(this,Oe).queryParams=t)}onChannelSwitch(){if(!M(this,De).resolved)return void M(this,Pe).debug("DRM is not used, skipping channel switch handling");ht()&&M(this,ze).platform.safariVersion<18&&L(this,Xe,ti).call(this,{message:"DRM channel switch not supported on Safari < 18",isFatal:!0}),window.clearTimeout(M(this,Ge));const t=M(this,De).resolved;R(this,De,new z),R(this,Ge,window.setTimeout((()=>{M(this,De).resolve(t)}),5e3))}}Pe=new WeakMap,Be=new WeakMap,_e=new WeakMap,De=new WeakMap,Ne=new WeakMap,We=new WeakMap,Oe=new WeakMap,Fe=new WeakMap,Ve=new WeakMap,Ge=new WeakMap,ze=new WeakMap,He=new WeakMap,je=new WeakMap,Xe=new WeakSet,qe=function(t){return B(this,null,(function*(){try{yield L(this,Xe,Qe).call(this),M(this,Pe).debug("Media keys initialization completed"),yield L(this,Xe,$e).call(this,t.initData,t.initDataType)}catch(t){L(this,Xe,ti).call(this,{message:"Failed to handle encrypted event",isFatal:!0,error:t})}}))},Qe=function(){return B(this,null,(function*(){var t;M(this,Pe).debug("Initializing media keys");const e=yield M(this,De).promise;if(null==(t=M(this,_e))||!t.mediaKeys)return M(this,Ve)?(M(this,Pe).debug("Media keys initialization already in progress, waiting for completion"),void(yield M(this,Ve))):(R(this,Ve,B(this,null,(function*(){const t=yield M(this,ei).call(this,e);M(this,Pe).debug("CDM obtained",{cdm:t}),(0,s.a)(M(this,_e),"No media element found"),(0,s.a)(t,"No CDM found");const i=yield t.getMediaKeys();t.certificate&&(yield L(this,Xe,Ye).call(this,i,t.certificate)),M(this,Pe).debug("Setting media keys on media element"),yield M(this,_e).setMediaKeys(i),R(this,Oe,t)}))),void(yield M(this,Ve)));M(this,Pe).debug("Media keys already set on media element")}))},$e=function(t,e){return B(this,null,(function*(){(0,s.a)(M(this,Oe),"No CDM manager found");const i=yield M(this,Oe).getMediaKeys();if(!t||!L(this,Xe,Ze).call(this,t))return void M(this,Pe).debug("Duplicate initData, no need to create new session",{initData:t});const n=i.createSession();M(this,Pe).debug("Creating new session",{session:n}),n.addEventListener("keystatuseschange",M(this,Je)),n.closed.then((t=>{M(this,Pe).info("Session is closed",{reason:t})})),n.addEventListener("message",M(this,Ke)),M(this,Fe).set(n,t),M(this,Pe).debug("Generating request for session",{session:n,initDataType:e,initData:t}),yield n.generateRequest(e,t)}))},Ze=function(t){for(const[e,i]of M(this,Fe))if(oi(t,i))return!1;return!0},Ke=new WeakMap,Je=new WeakMap,Ye=function(t,e){return B(this,null,(function*(){try{M(this,Pe).debug("Setting server certificate",{certificate:e}),(yield t.setServerCertificate(e))||M(this,Pe).warn("Server certificates are not supported by the CDM.")}catch(t){M(this,Pe).error("Failed to set server certificate",{error:t})}}))},ti=function(t){const{message:e,isFatal:i,error:n}=t;M(this,Pe).error(e,{error:n}),M(this,Be).emit("error",Se(e,i,n))},ei=new WeakMap,ii=function(t){const e=[];return t.clearkeys&&e.push("clearkey"),t.playreadyLicenseUrl&&e.push("playready"),t.widevineLicenseUrl&&e.push("widevine"),t.fairplayLicenseUrl&&t.fairplayCertificate&&e.push("fairplay"),e},ni=function(t){return{fairplay:t.fairplayLicenseUrl,playready:t.playreadyLicenseUrl,widevine:t.widevineLicenseUrl,clearkey:void 0}};const mi=(t,e=0)=>{for(let i=e;i<t.byteLength-4;i++){const e=1===t.getUint32(i),n=1==(t.getUint8(i)<<16|t.getUint16(i+1));if(e||n)return{position:i,nalPrefixSize:e?4:3}}},pi=t=>{const e=[],i=[];if(!(t=>0!==(t=>{const e=t.getUint32(0,!1);let i=0;return 1==(t.getUint8(0)<<16|t.getUint16(1,!1))?i+=3:1===e&&(i+=4),i})(new DataView(t,0)))(t)){const n=new DataView(t,0),s=31&n.getUint8(5);let r=6;for(let i=0;i<s;i++){const i=n.getUint16(r);e.push(t.slice(r+2,r+2+i)),r+=i+2}const a=n.getUint8(r);r+=1;for(let e=0;e<a;e++){const e=n.getUint16(r);i.push(t.slice(r+2,r+2+e)),r+=e+2}return{sequenceParameterSets:e,pictureParameterSets:i}}return((t,e)=>{const i=new DataView(t,0);let n=mi(i);for(;n;){const{position:s,nalPrefixSize:r}=n,a=mi(i,s+4),o=a?a.position-s-r:void 0;if(!e(new DataView(t,s+r,o)))return;n=a}})(t,(t=>{const n=t.byteOffset+t.byteLength;switch((t=>31&t)(t.getUint8(0))){case 8:i.push(t.buffer.slice(t.byteOffset,n));break;case 7:e.push(t.buffer.slice(t.byteOffset,n))}return!0})),{sequenceParameterSets:e,pictureParameterSets:i}},gi=[{numerator:0,denumerator:0},{numerator:1,denumerator:1},{numerator:12,denumerator:11},{numerator:10,denumerator:11},{numerator:16,denumerator:11},{numerator:40,denumerator:33},{numerator:24,denumerator:11},{numerator:20,denumerator:11},{numerator:32,denumerator:11},{numerator:80,denumerator:33},{numerator:18,denumerator:11},{numerator:15,denumerator:11},{numerator:64,denumerator:33},{numerator:160,denumerator:99},{numerator:4,denumerator:3},{numerator:3,denumerator:2},{numerator:2,denumerator:1}];function fi(t){return{encoding:t.readUint8(),description:t.readUtf8String(),value:t.readUtf8String()}}function Ai(t){let e=t.readUint32();const i=[t.readUint8(),t.readUint8(),t.readUint8(),t.readUint8()],n=String.fromCharCode.apply(null,i);return 1===e&&(e=t.readUint64()-8),{size:e-8,type:n}}function vi(t){return{version:t.readUint8(),flags:t.readUint24()}}const bi=class t{constructor({timescale:e,presentationTime:i,presentationTimeDelta:n,schemeIdUri:s,value:r,eventDuration:a,id:o,data:l}){I(this,"type",t.type),I(this,"timescale"),I(this,"presentationTime"),I(this,"presentationTimeDelta"),I(this,"schemeIdUri"),I(this,"value"),I(this,"eventDuration"),I(this,"id"),I(this,"data"),this.timescale=e,this.presentationTime=i,this.presentationTimeDelta=n,this.schemeIdUri=s,this.value=r,this.eventDuration=a,this.id=o,this.data=l}static decodeData(e){const{version:i}=vi(e);switch(i){case 1:{const i=e.readUint32(),n=e.readUint64(),s=e.readUint32(),r=e.readUint32(),a=e.readUtf8String(),o=e.readUtf8String(),l=e.remaining(),h=e.readBytes(l);return new t({timescale:i,presentationTime:n,eventDuration:s,id:r,schemeIdUri:a,value:o,data:h})}case 0:{const i=e.readUtf8String(),n=e.readUtf8String(),s=e.readUint32(),r=e.readUint32(),a=e.readUint32(),o=e.readUint32(),l=e.remaining(),h=e.readBytes(l);return new t({timescale:s,presentationTimeDelta:r,schemeIdUri:i,value:n,eventDuration:a,id:o,data:h})}default:throw new Error(`unsupported version ${i}`)}}};I(bi,"type","emsg");let wi=bi;const yi=class t{constructor(e){I(this,"type",t.type),I(this,"data"),this.data=e}static decodeData(e){const i=e.readRemaining();return new t(i)}};I(yi,"type","mdat");let Si=yi;const ki=class t{constructor(e,i,n){I(this,"type",t.type),I(this,"extra"),I(this,"byteOffset"),I(this,"baseMediaDecodeTime"),this.extra=e,this.byteOffset=i,this.baseMediaDecodeTime=n}static decodeData(e){const i=vi(e),n=e.byteOffset();let s=0;return s=1===i.version?e.readUint64():e.readUint32(),new t(i,n,s)}};I(ki,"type","tfdt");let Ei=ki;const Ti=class t{constructor(e,i,n){I(this,"type",t.type),I(this,"dataOffset"),I(this,"firstSampleFlags"),I(this,"samplesCount"),I(this,"sampleDurations",[]),I(this,"sampleSizes",[]),I(this,"sampleFlags",[]),I(this,"sampleCts",[]),this.dataOffset=i,this.firstSampleFlags=n,this.samplesCount=e}is_sync_sample(e){const i=t.FLAG_SAMPLE_FLAG_IS_NON_SYNC|t.FLAG_SAMPLE_DEPENDS_YES,n=this.sampleFlags[e];return void 0!==n?!(n&i):0===e&&this.firstSampleFlags?!(this.firstSampleFlags&i):void 0}static decodeData(e){const{flags:i}=vi(e),n=e.readUint32();let s,r;i&t.TRUN_DATA_OFFSET&&(s=e.readUint32()),i&t.TRUN_FIRST_SAMPLE_FLAGS&&(r=e.readUint32());const a=new t(n,s,r);for(let s=0;s<n;s++)i&t.SAMPLE_DURATION&&a.sampleDurations.push(e.readUint32()),i&t.SAMPLE_SIZE&&a.sampleSizes.push(e.readUint32()),i&t.SAMPLE_FLAGS&&a.sampleFlags.push(e.readUint32()),i&t.SAMPLE_CTS&&a.sampleCts.push(e.readUint32());return a}};I(Ti,"TRUN_DATA_OFFSET",1),I(Ti,"TRUN_FIRST_SAMPLE_FLAGS",4),I(Ti,"SAMPLE_DURATION",256),I(Ti,"SAMPLE_SIZE",512),I(Ti,"SAMPLE_FLAGS",1024),I(Ti,"SAMPLE_CTS",2048),I(Ti,"FLAG_SAMPLE_FLAG_IS_NON_SYNC",65536),I(Ti,"FLAG_SAMPLE_DEPENDS_NO",33554432),I(Ti,"FLAG_SAMPLE_DEPENDS_YES",16777216),I(Ti,"type","trun");let Ii=Ti;const Ci=class t{constructor(e,i){I(this,"type",t.type),I(this,"tfdt"),I(this,"trun"),this.tfdt=e,this.trun=i}static decodeData(e){let i,n;for(;e.remaining()>0;){const t=un(e);t instanceof Ei&&(i=t),t instanceof Ii&&(n=t)}return new t(i,n)}};I(Ci,"type","traf");let xi=Ci;const Mi=class t{constructor(e){I(this,"type",t.type),I(this,"traf"),this.traf=e}static decodeData(e){let i;for(;e.remaining()>0;){const t=un(e);t instanceof xi&&(i=t)}if(!i)throw new Error("No traf found");return new t(i)}};I(Mi,"type","moof");let Ui=Mi;const Ri=class t{constructor(){I(this,"type",t.type)}static decodeData(e){return new t}};I(Ri,"type","mvhd");let Li=Ri;const Pi=class t{constructor(e){I(this,"type",t.type),I(this,"fourCC"),this.fourCC=e}mediaType(){switch(this.fourCC){case"vide":return"video";case"soun":return"audio";case"sbtl":return"text";default:throw new Error("Unknown media type")}}static decodeData(e){vi(e),e.readUint32();const i=String.fromCharCode(...e.readBytes(4));return new t(i)}};I(Pi,"type","hdlr");let Bi=Pi;const _i=class t{constructor(e,i,n,s){I(this,"type",t.type),I(this,"creationTime"),I(this,"modificationTime"),I(this,"timescale"),I(this,"duration"),this.creationTime=e,this.modificationTime=i,this.timescale=n,this.duration=s}static decodeData(e){const{version:i}=vi(e);if(1===i){const i=e.readUint64(),n=e.readUint64(),s=e.readUint32(),r=e.readUint64();return new t(i,n,s,r)}const n=e.readUint32(),s=e.readUint32(),r=e.readUint32(),a=e.readUint32();return new t(n,s,r,a)}};I(_i,"type","mdhd");let Di=_i;const Ni=class t{constructor(e,i,n,s){I(this,"type",t.type),I(this,"av01"),I(this,"avc1"),I(this,"opus"),I(this,"codec"),this.avc1=e,this.av01=i,this.opus=n,this.codec=s}mediaType(){return this.avc1||this.av01?"video":"audio"}width(){var t;return null==(t=this.avc1)?void 0:t.width}height(){var t;return null==(t=this.avc1)?void 0:t.height}static decodeData(e){vi(e);const i=e.readUint32();let n,s,r,a;for(let t=0;t<i;t++)for(;e.remaining()>0;){const t=un(e);switch(t.type){case"avc1":n="h264",s=t;break;case"av01":n="av1",a=t;break;case"mp4a":n="aac";break;case"Opus":n="opus",r=t}}return new t(s,a,r,n)}};I(Ni,"type","stsd");let Wi=Ni;const Oi=class t{constructor(e){I(this,"type",t.type),I(this,"stsd"),this.stsd=e}static decodeData(e){let i;for(;e.remaining()>0;){const t=un(e);t instanceof Wi&&(i=t)}if(!i)throw new Error("No stsd found");return new t(i)}};I(Oi,"type","stbl");let Fi=Oi;const Vi=class t{constructor(e){I(this,"type",t.type),I(this,"stbl"),this.stbl=e}static decodeData(e){let i;for(;e.remaining()>0;){const t=un(e);t instanceof Fi&&(i=t)}if(!i)throw new Error("No stbl found");return new t(i)}};I(Vi,"type","minf");let Gi=Vi;const zi=class t{constructor(e,i,n){I(this,"type",t.type),I(this,"hdlr"),I(this,"minf"),I(this,"mdhd"),this.hdlr=e,this.minf=i,this.mdhd=n}static decodeData(e){let i,n,s;for(;e.remaining()>0;){const t=un(e);t instanceof Bi&&(i=t),t instanceof Gi&&(n=t),t instanceof Di&&(s=t)}if(!i)throw new Error("No hdlr found");if(!n)throw new Error("No minf found");if(!s)throw new Error("No mdhd found");return new t(i,n,s)}};I(zi,"type","mdia");let Hi=zi;const ji=class t{constructor(e,i,n,s,r,a,o,l){I(this,"type",t.type),I(this,"modificationTime"),I(this,"creationTime"),I(this,"trackId"),I(this,"duration"),I(this,"alternateGroup"),I(this,"volume"),I(this,"width"),I(this,"height"),this.modificationTime=e,this.creationTime=i,this.trackId=n,this.duration=s,this.alternateGroup=r,this.volume=a,this.width=o,this.height=l}static decodeData(e){let i=0,n=0;1===vi(e).version?(i=e.readUint64(),n=e.readUint64()):(i=e.readUint32(),n=e.readUint32());const s=e.readUint32();e.readUint32();const r=e.readUint32();e.readUint32(),e.readUint32(),e.readUint16();const a=e.readUint16(),o=e.readUint16();e.readUint16(),new Array(9).fill(0).map((()=>e.readUint32()));const l=e.readUint16();e.readUint16();const h=e.readUint16();return e.readUint16(),new t(i,n,s,r,a,o,l,h)}};I(ji,"type","tkhd");let Xi=ji;const qi=class t{constructor(e,i){I(this,"type",t.type),I(this,"tkhd"),I(this,"mdia"),this.tkhd=e,this.mdia=i}static decodeData(e){let i,n;for(;e.remaining()>0;){const t=un(e);t instanceof Xi&&(i=t),t instanceof Hi&&(n=t)}if(!i)throw new Error("No tkhd found");if(!n)throw new Error("No mdia found");return new t(i,n)}};I(qi,"type","trak");let Qi=qi;const $i=class t{constructor(e,i){I(this,"type",t.type),I(this,"mvhd"),I(this,"traks"),this.mvhd=e,this.traks=i}static decodeData(e){let i;const n=[];for(;e.remaining()>0;){const t=un(e);t instanceof Qi&&n.push(t),t instanceof Li&&(i=t)}if(!i)throw new Error("No mvhd found");return new t(i,n)}};I($i,"type","moov");let Zi=$i;const Ki=class t{constructor(e,i,n,s,r,a,o,l){I(this,"type",t.type),I(this,"configurationVersion"),I(this,"avcProfileIndication"),I(this,"profileCompatibility"),I(this,"avcLevelIndication"),I(this,"lengthSizeMinusOne"),I(this,"sequenceParameterSets"),I(this,"pictureParameterSets"),I(this,"bytes"),this.configurationVersion=e,this.avcProfileIndication=i,this.profileCompatibility=n,this.avcLevelIndication=s,this.lengthSizeMinusOne=r,this.sequenceParameterSets=a,this.pictureParameterSets=o,this.bytes=l}static decodeData(e){const i=e.buffer(),n=e.readUint8(),s=e.readUint8(),r=e.readUint8(),a=e.readUint8(),o=3&e.readUint8(),l=31&e.readUint8(),h=[];for(let t=0;t<l;t++){const t=e.readBytes(e.readUint16());h.push(t)}const c=e.readUint8(),d=[];for(let t=0;t<c;t++){const t=e.readBytes(e.readUint16());d.push(t)}return new t(n,s,r,a,o,h,d,i)}};I(Ki,"type","avcC");let Ji=Ki;const Yi=class t{constructor(e,i,n,s,r){I(this,"type",t.type),I(this,"avcC"),I(this,"width"),I(this,"height"),I(this,"horizontalResolution"),I(this,"verticalResolution"),this.avcC=e,this.width=i,this.height=n,this.horizontalResolution=s,this.verticalResolution=r}static decodeData(e){e.readUint32(),e.readUint16(),e.readUint16(),e.readUint32(),e.readUint64(),e.readUint32();const i=e.readUint16(),n=e.readUint16(),s=e.readUint32(),r=e.readUint32();let a;for(e.readUint32(),e.readUint16(),e.readBytes(32),e.readUint16(),e.readUint16();e.remaining()>0;){const t=un(e);"avcC"===t.type&&(a=t)}if(!a)throw new Error("no avcC");return new t(a,i,n,s,r)}};I(Yi,"type","avc1");let tn=Yi;const en=class t{constructor(){I(this,"type",t.type)}static decodeData(e){return new t}};I(en,"type","dOps");let nn=en;const sn=class t{constructor(e,i,n){I(this,"type",t.type),I(this,"dops"),I(this,"channelCount"),I(this,"sampleRate"),this.dops=e,this.channelCount=i,this.sampleRate=n}static decodeData(e){e.readUint32(),e.readUint16(),e.readUint16();const i=e.readUint16();e.readUint16(),e.readUint32();const n=e.readUint16();e.readUint16(),e.readUint32();const s=e.readUint16();e.readUint16(),1===i&&(e.readUint64(),e.readUint64());const r=function(t,e){const i=Ai(e),n=new At(e.readBytes(i.size));if(i.type!==t.type)throw new Error(`invalid error type: ${i.type}, expected ${t.type}`);const s=t.decodeData(n);return n.readRemaining(),s}(nn,e);return new t(r,n,s)}};I(sn,"type","Opus");let rn=sn;const an=class t{constructor(e,i){I(this,"type",t.type),I(this,"ntpTimestamp"),I(this,"mediaTime"),this.ntpTimestamp=e,this.mediaTime=i}static decodeData(e){const{version:i}=vi(e);e.readUint32();const n=e.readUint32(),s=e.readUint32();if(1===i){const i=e.readUint64();return new t([n,s],i)}const r=e.readUint32();return new t([n,s],r)}};I(an,"type","prft");let on=an;var ln,hn;class cn{constructor(t,e){U(this,ln),U(this,hn),R(this,ln,t),R(this,hn,e.readBytes(t.size))}data(){return M(this,hn)}get type(){return M(this,ln).type}}ln=new WeakMap,hn=new WeakMap;const dn={moov:Zi,trak:Qi,tkhd:Xi,mvhd:Li,moof:Ui,traf:xi,tfdt:Ei,trun:Ii,mdat:Si,mdia:Hi,hdlr:Bi,minf:Gi,stbl:Fi,mdhd:Di,stsd:Wi,prft:on,avc1:tn,avcC:Ji,Opus:rn,emsg:wi};function un(t){const e=Ai(t),i=dn[e.type],n=new At(t.readBytes(e.size));if(!i){const t=new cn(e,n);return n.readRemaining(),t}const s=i.decodeData(n);return n.readRemaining(),s}var mn,pn,gn,fn,An;class vn{constructor(t){U(this,mn),U(this,pn),R(this,mn,t),R(this,pn,function(t){if(t.byteLength<8)throw new Error("Buffer too small");const e=new At(t),i=new Map;for(;e.remaining()>0;){const t=un(e);i.set(t.type,t)}const n=i.get("ftyp"),s=i.get("moov");if(!n)throw new Error("ftyp atom not found");if(!(s&&s instanceof Zi))throw new Error("moov atom not found");return{ftyp:n,moov:s}}(t))}rawBytes(){return M(this,mn)}init(){return M(this,pn)}}mn=new WeakMap,pn=new WeakMap,gn=new WeakMap,fn=new WeakMap,An=new WeakMap;let bn=class t{constructor(t,e){U(this,gn),U(this,fn),U(this,An),R(this,gn,e),R(this,fn,t),R(this,An,function(t){if(t.byteLength<8)throw new Error("Buffer too small");const e=new At(t),i=new Map,n=[];for(;e.remaining()>0;){const t=un(e);t instanceof wi&&n.push(t),i.set(t.type,t)}const s=i.get("moof"),r=i.get("mdat"),a=i.get("prft");if(!(s&&s instanceof Ui))throw new Error("moof atom not found");if(!(r&&r instanceof Si))throw new Error("mdat atom not found");if(a&&!(a instanceof on))throw new Error("invalid prft found");return{moof:s,mdat:r,prft:a,emsgs:n}}(e))}clone(){return new t(M(this,fn),new Uint8Array(M(this,gn).buffer.slice(M(this,gn).byteOffset,M(this,gn).byteOffset+M(this,gn).byteLength)))}updateBaseMediaDecodeTime(t){const e=new DataView(M(this,gn).buffer,M(this,gn).byteOffset,M(this,gn).byteLength);if(M(this,An).moof.traf.tfdt)if(M(this,An).moof.traf.tfdt.baseMediaDecodeTime=t,1===M(this,An).moof.traf.tfdt.extra.version){const i=Math.floor(t/4294967296),n=(4294967295&t)>>>0;e.setUint32(M(this,An).moof.traf.tfdt.byteOffset-M(this,gn).byteOffset,i),e.setUint32(M(this,An).moof.traf.tfdt.byteOffset-M(this,gn).byteOffset+4,n)}else e.setUint32(M(this,An).moof.traf.tfdt.byteOffset-M(this,gn).byteOffset,t)}producerReferenceTime(){if(!M(this,An).prft)return;const[t,e]=M(this,An).prft.ntpTimestamp,i=1e3*t+e/2**32*1e3,n=new Date(Date.UTC(1900,0,1,0,0,0));return new Date(n.getTime()+i)}duration(){var t;return(null==(t=M(this,An).moof.traf.trun)?void 0:t.sampleDurations.reduce(((t,e)=>t+e),0))||0}baseMediaDecodeTime(){var t;const e=null==(t=M(this,An).moof.traf.tfdt)?void 0:t.baseMediaDecodeTime;if(!e)throw new Error("no baseMediaDecodeTime");return e}startsWithKeyframe(){const t=M(this,An).moof.traf.trun,e=(null==t?void 0:t.firstSampleFlags)||(null==t?void 0:t.sampleFlags[0]);return!!e&&!!(e&Ii.FLAG_SAMPLE_DEPENDS_NO)}compositionTimeOffset(t){var e;return null==(e=M(this,An).moof.traf.trun)?void 0:e.sampleCts[t]}timescale(){const t=M(this,fn).init().moov.traks[0];if(!t)throw new Error("no tracks");return t.mdia.mdhd.timescale}mediaType(){var t;const e=null==(t=M(this,fn).init().moov.traks[0])?void 0:t.mdia.hdlr.mediaType();if(!e)throw new Error("no media type");return e}header(){return M(this,fn)}fragment(){return M(this,An)}samplesCount(){var t;return(null==(t=M(this,An).moof.traf.trun)?void 0:t.samplesCount)||0}sample(t){var e,i,n,s,r,a,o,l,h,c,d,u,m,p,g;const f=null==(e=M(this,fn).init().moov.traks[0])?void 0:e.mdia.minf.stbl.stsd.codec,A=(null==(i=M(this,An).moof.traf.trun)?void 0:i.samplesCount)||0,v=null==(n=M(this,An).moof.traf.tfdt)?void 0:n.baseMediaDecodeTime;if(t>=A||void 0===v||!f)return;const b=(null==(s=M(this,An).moof.traf.trun)?void 0:s.sampleDurations[t])||0,w=(null==(r=M(this,An).moof.traf.trun)?void 0:r.sampleDurations.slice(0,t).reduce(((t,e)=>t+e),0))||0,y=v+w,S=(null==(a=M(this,fn).init().moov.traks[0])?void 0:a.mdia.mdhd.timescale)||1e3,k=(null==(o=M(this,An).moof.traf.trun)?void 0:o.sampleSizes[t])||M(this,An).mdat.data.byteLength,E=(null==(l=M(this,An).moof.traf.trun)?void 0:l.sampleSizes.slice(0,t).reduce(((t,e)=>t+e),0))||0,T=M(this,An).mdat.data.subarray(E,E+k),I=(null==(h=M(this,An).moof.traf.trun)?void 0:h.is_sync_sample(t))||!1;return"video"===this.mediaType()?{type:"video",codec:f,width:(null==(c=M(this,fn).init().moov.traks[0])?void 0:c.tkhd.width)||0,height:(null==(d=M(this,fn).init().moov.traks[0])?void 0:d.tkhd.height)||0,duration:b,isSync:I,timescale:S,timestamp:y,data:T}:{type:"audio",codec:f,channels:(null==(m=null==(u=M(this,fn).init().moov.traks[0])?void 0:u.mdia.minf.stbl.stsd.opus)?void 0:m.channelCount)||0,sampleRate:(null==(g=null==(p=M(this,fn).init().moov.traks[0])?void 0:p.mdia.minf.stbl.stsd.opus)?void 0:g.sampleRate)||0,duration:b,isSync:I,timestamp:y,data:T,timescale:S}}rawBytes(){return M(this,gn)}};var wn;class yn{constructor(t){U(this,wn),R(this,wn,new vn(t))}header(){return M(this,wn)}createFragment(t){return new bn(M(this,wn),t)}}function Sn(t){const e=new ArrayBuffer(t.length),i=new Uint8Array(e);for(let e=0,n=t.length;e<n;e++)i[e]=t.charCodeAt(e);return new Uint8Array(e)}wn=new WeakMap;const kn={ftyp:Sn("ftyp"),mvhd:Sn("mvhd"),moov:Sn("moov"),trak:Sn("trak"),tkhd:Sn("tkhd"),mdia:Sn("mdia"),mdhd:Sn("mdhd"),hdlr:Sn("hdlr"),minf:Sn("minf"),vmhd:Sn("vmhd"),smhd:Sn("smhd"),dinf:Sn("dinf"),dref:Sn("dref"),stbl:Sn("stbl"),stsd:Sn("stsd"),avc1:Sn("avc1"),av01:Sn("av01"),av1C:Sn("av1C"),avcC:Sn("avcC"),esds:Sn("esds"),colr:Sn("colr"),nclx:Sn("nclx"),mvex:Sn("mvex"),trex:Sn("trex"),udta:Sn("udta"),meta:Sn("meta"),ilst:Sn("ilst"),moof:Sn("moof"),mfhd:Sn("mfhd"),traf:Sn("traf"),tfhd:Sn("tfhd"),tfdt:Sn("tfdt"),trun:Sn("trun"),mdat:Sn("mdat"),mp4a:Sn("mp4a"),Opus:Sn("Opus"),prft:Sn("prft"),dOps:Sn("dOps"),emsg:Sn("emsg")},En=Sn("iso6"),Tn=new Uint8Array([0,0,2,0]),In=[En,new Uint8Array([105,115,111,109]),new Uint8Array([105,115,111,50]),new Uint8Array([97,118,99,49]),new Uint8Array([109,112,52,49])],Cn=[En,new Uint8Array([105,115,111,109]),new Uint8Array([105,115,111,50]),new Uint8Array([97,118,48,49]),new Uint8Array([109,112,52,49])],xn=[En,new Uint8Array([105,115,111,109]),new Uint8Array([105,115,111,50]),new Uint8Array([109,112,52,49])];class Mn{constructor(){I(this,"writer",new vt)}}const Un=(t,e,i)=>{t.writer.writeUint32(i+8),t.writer.writeBytes(e)},Rn=(t,e,i,n,s)=>{Un(t,e,i+4),t.writer.writeUint8(n),t.writer.writeUint24(s)},Ln=(t,e)=>{Un(t,kn.ftyp,En.byteLength+Tn.byteLength+e.reduce(((t,e)=>t+e.byteLength),0)),t.writer.writeBytes(En),t.writer.writeBytes(Tn),e.forEach((e=>t.writer.writeBytes(e)))},Pn=t=>"sequenceParameterSets"in t,Bn=t=>"sequenceHeader"in t,_n=t=>"video"==t.type,Dn=t=>"audio"==t.type,Nn=(t,e,i)=>{let n=3;for(t.writer.writeUint8(e);n>0;n--)t.writer.writeUint8(i>>7*n|128);t.writer.writeUint8(127&i)},Wn=(t,e)=>{const i=t.writer.position();Un(t,kn.minf,0),_n(e)?(Rn(t,kn.vmhd,8,0,1),t.writer.writeUint32(0),t.writer.writeUint32(0)):Dn(e)&&(Rn(t,kn.smhd,4,0,0),t.writer.writeUint16(0),t.writer.writeUint16(0)),(t=>{const e=t.writer.position();Un(t,kn.dinf,0),Rn(t,kn.dref,16,0,0),t.writer.writeUint32(1),Rn(t,Sn("url "),0,0,1),t.writer.writeUint32At(e,t.writer.position()-e)})(t),((t,e)=>{const i=t.writer.position();Un(t,kn.stbl,0);const n=t.writer.position();Rn(t,kn.stsd,0,0,0),t.writer.writeUint32(1),_n(e)?((t,e)=>{const i=t.writer.position(),n=Bn(e)?kn.av01:kn.avc1;Un(t,n,0),t.writer.writeUint32(0),t.writer.writeUint16(0),t.writer.writeUint16(1),t.writer.writeUint16(0),t.writer.writeUint16(0),t.writer.writeUint32(0),t.writer.writeUint32(0),t.writer.writeUint32(0),t.writer.writeUint16(e.width),t.writer.writeUint16(e.height),t.writer.writeUint32(4718592),t.writer.writeUint32(4718592),t.writer.writeUint32(0),t.writer.writeUint16(1),t.writer.writeUint8(0),t.writer.writeBytes(new Uint8Array(31)),t.writer.writeUint16(24),t.writer.writeUint16(-1),Pn(e)?((t,e)=>{const i=t.writer.position();Un(t,kn.avcC,0),t.writer.writeUint8(1),t.writer.writeUint8(e.sequenceParameterSets[0][1]),t.writer.writeUint8(e.sequenceParameterSets[0][2]),t.writer.writeUint8(e.sequenceParameterSets[0][3]),t.writer.writeUint8(255),t.writer.writeUint8(224|e.sequenceParameterSets.length),e.sequenceParameterSets.forEach((e=>{t.writer.writeUint16(e.byteLength),t.writer.writeBytes(e)})),t.writer.writeUint8(e.pictureParameterSets.length),e.pictureParameterSets.forEach((e=>{t.writer.writeUint16(e.byteLength),t.writer.writeBytes(e)})),t.writer.writeUint32At(i,t.writer.position()-i)})(t,e):Bn(e)&&(((t,e)=>{var i,n;const s=t.writer.position();Un(t,kn.av1C,0);const{seqProfile:r,operatingPoints:a,colorConfig:o}=e.parsedSequenceHeader,l=a[0];t.writer.writeUint8(129),t.writer.writeUint8(r<<5|(null!=(i=null==l?void 0:l.seqLevelIdx)?i:0)),t.writer.writeUint8((null!=(n=null==l?void 0:l.tier)?n:0)|(o.highBitDepth?1:0)|(12===o.bitDepth?1:0)<<5|(o.monoChrome?1:0)<<4|o.subsamplingX<<3|o.subsamplingY<<2|65535&o.chromaSamplePosition),t.writer.writeUint8(0),t.writer.writeBytes(e.sequenceHeader),t.writer.writeUint32At(s,t.writer.position()-s)})(t,e),e.parsedSequenceHeader.colorConfig&&(Un(t,Sn("colr"),11),t.writer.writeBytes(kn.nclx),t.writer.writeUint16(e.parsedSequenceHeader.colorConfig.colorPrimaries),t.writer.writeUint16(e.parsedSequenceHeader.colorConfig.transferCharacteristics),t.writer.writeUint16(e.parsedSequenceHeader.colorConfig.matrixCoefficients),t.writer.writeUint8(e.parsedSequenceHeader.colorConfig.colorRange?1:0))),e.pixelAspectRatio&&(Un(t,Sn("pasp"),8),t.writer.writeUint32(e.pixelAspectRatio.numerator),t.writer.writeUint32(e.pixelAspectRatio.denumerator)),e.bitrate&&(Un(t,Sn("btrt"),12),t.writer.writeUint32(0),t.writer.writeUint32(e.bitrate),t.writer.writeUint32(e.bitrate)),t.writer.writeUint32At(i,t.writer.position()-i)})(t,e):Dn(e)&&((t,e)=>{const i=t.writer.position();switch(Un(t,Sn((t=>{switch(t){case"aac":case"mp3":return"mp4a";case"opus":return"Opus"}})(e.codec)),0),t.writer.writeUint32(0),t.writer.writeUint16(0),t.writer.writeUint16(1),t.writer.writeUint16(0),t.writer.writeUint16(0),t.writer.writeUint32(0),t.writer.writeUint16(e.channelCount),t.writer.writeUint16(16),t.writer.writeUint32(0),t.writer.writeUint16(e.sampleRate),t.writer.writeUint16(0),e.codec){case"aac":case"mp3":((t,e)=>{const i=e.decoderConfig.byteLength>0?e.decoderConfig.byteLength+5:0,n=t.writer.position();Rn(t,kn.esds,0,0,0),Nn(t,3,21+i+5+1),t.writer.writeUint16(e.trackId),t.writer.writeUint8(0),Nn(t,4,13+i);const s="mp3"===e.codec&&e.sampleRate>24e3?107:64;t.writer.writeUint8(s),t.writer.writeUint8(21),t.writer.writeUint24(0),t.writer.writeUint32(e.bitrate||0),t.writer.writeUint32(e.bitrate||0),e.decoderConfig.byteLength>0&&(Nn(t,5,e.decoderConfig.byteLength),t.writer.writeBytes(e.decoderConfig)),Nn(t,6,1),t.writer.writeUint8(2),t.writer.writeUint32At(n,t.writer.position()-n)})(t,e);break;case"opus":((t,e)=>{const i=t.writer.position();Un(t,Sn("dOps"),0),t.writer.writeUint8(0);const n=e.decoderConfig,s=new DataView(n.buffer,n.byteOffset,n.byteLength);t.writer.writeUint8(s.getUint8(9)),t.writer.writeUint16(s.getUint16(10,!0)),t.writer.writeUint32(s.getUint32(12,!0)),t.writer.writeUint16(s.getUint16(16,!0)),t.writer.writeBytes(e.decoderConfig.slice(18)),t.writer.writeUint32At(i,t.writer.position()-i)})(t,e)}e.bitrate&&(Un(t,Sn("btrt"),12),t.writer.writeUint32(0),t.writer.writeUint32(e.bitrate),t.writer.writeUint32(e.bitrate)),t.writer.writeUint32At(i,t.writer.position()-i)})(t,e),t.writer.writeUint32At(n,t.writer.position()-n),Rn(t,Sn("stts"),4,0,0),t.writer.writeUint32(0),Rn(t,Sn("stsc"),4,0,0),t.writer.writeUint32(0),Rn(t,Sn("stsz"),8,0,0),t.writer.writeUint32(0),t.writer.writeUint32(0),Rn(t,Sn("stco"),4,0,0),t.writer.writeUint32(0),t.writer.writeUint32At(i,t.writer.position()-i)})(t,e),t.writer.writeUint32At(i,t.writer.position()-i)},On=(t,e,i)=>{const n=t.writer.position();Un(t,kn.trak,0),((t,e,i)=>{const n=t.writer.position();Rn(t,kn.tkhd,0,0,3),t.writer.writeUint32(0),t.writer.writeUint32(0),t.writer.writeUint32(e.trackId),t.writer.writeUint32(0),t.writer.writeUint32(e.duration*i/e.timescale),t.writer.writeUint32(0),t.writer.writeUint32(0),t.writer.writeUint16(0),t.writer.writeUint16(Dn(e)?1:0),t.writer.writeUint16(Dn(e)?256:0),t.writer.writeUint16(0),t.writer.writeBytes(new Uint8Array([0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0])),_n(e)?(t.writer.writeUint32(65536*e.width),t.writer.writeUint32(65536*e.height)):Dn(e)&&(t.writer.writeUint32(0),t.writer.writeUint32(0)),t.writer.writeUint32At(n,t.writer.position()-n)})(t,e,i),((t,e)=>{const i=t.writer.position();Un(t,kn.mdia,0),((t,e)=>{Rn(t,kn.mdhd,20,0,0),t.writer.writeUint32(0),t.writer.writeUint32(0),t.writer.writeUint32(e.timescale),t.writer.writeUint32(e.duration);const i=e.lang||"und",n=(31&i.charCodeAt(0))<<10|(31&i.charCodeAt(1))<<5|31&i.charCodeAt(2);t.writer.writeUint16(n),t.writer.writeUint16(0)})(t,e),((t,e)=>{const i=t.writer.position();Rn(t,kn.hdlr,0,0,0),t.writer.writeUint32(0),t.writer.writeBytes(Sn(_n(e)?"vide":"soun")),t.writer.writeUint32(0),t.writer.writeUint32(0),t.writer.writeUint32(0),t.writer.writeBytes(Sn(_n(e)?"VideoHandler\0":"SoundHandler\0")),t.writer.writeUint32At(i,t.writer.position()-i)})(t,e),Wn(t,e),t.writer.writeUint32At(i,t.writer.position()-i)})(t,e),t.writer.writeUint32At(n,t.writer.position()-n)},Fn=(t,e,i,n)=>{const s=t.writer.position();Un(t,kn.moov,0),((t,e,i)=>{Rn(t,kn.mvhd,96,0,0),t.writer.writeUint32(0),t.writer.writeUint32(0),t.writer.writeUint32(i),t.writer.writeUint32(0),t.writer.writeUint32(65536),t.writer.writeUint16(256),t.writer.writeBytes(new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0])),t.writer.writeUint32(2)})(t,0,i),e.forEach((e=>On(t,e,i))),((t,e)=>{const i=t.writer.position();Un(t,kn.mvex,0),e.forEach((e=>((t,e)=>{Rn(t,kn.trex,20,0,0),t.writer.writeUint32(e.trackId),t.writer.writeUint32(1),t.writer.writeUint32(0),t.writer.writeUint32(0),t.writer.writeUint32(0)})(t,e))),t.writer.writeUint32At(i,t.writer.position()-i)})(t,e),t.writer.writeUint32At(s,t.writer.position()-s)},Vn=t=>t.isSync?33554432:16842752,Gn=(t,e)=>{const i=t.writer.position();Un(t,kn.moof,0),((t,e)=>{Rn(t,kn.mfhd,4,0,0),t.writer.writeUint32(e)})(t,e.sequenceNumber),((t,e)=>{const i=t.writer.position();Un(t,kn.traf,0),((t,e)=>{const i=t.writer.position();Rn(t,kn.tfhd,16,0,56),t.writer.writeUint32(e.trackId),t.writer.writeUint32(e.defaultDuration||0),t.writer.writeUint32(e.defaultSize||0),t.writer.writeUint32(e.defaultFlags||0),t.writer.writeUint32At(i,t.writer.position()-i)})(t,e),((t,e)=>{const i=t.writer.position();Rn(t,kn.tfdt,8,1,0);const n=Math.floor(e.timestamp/4294967296),s=(4294967295&e.timestamp)>>>0;t.writer.writeUint32(n),t.writer.writeUint32(s),t.writer.writeUint32At(i,t.writer.position()-i)})(t,e),((t,e)=>{if(!e.samples[0])throw new Error("At least one sample must be provided");const i=e.samples.some((t=>!!t.compositionTimeOffset)),n=Vn(e.samples[0])!==e.defaultFlags,s=e.samples.length>1;let r=1;n&&(r|=4),i&&(r|=2048),s&&(r|=512,r|=256,r|=1024);const a=t.writer.position();Rn(t,kn.trun,16,1,r),t.writer.writeUint32(e.samples.length);const o=t.writer.position();t.writer.writeUint32(0),n&&t.writer.writeUint32(Vn(e.samples[0]));for(const n of e.samples)s&&(t.writer.writeUint32(n.duration),t.writer.writeUint32(n.data.byteLength),t.writer.writeUint32(Vn(n))),i&&t.writer.writeUint32(n.compositionTimeOffset||0);t.writer.writeUint32At(o,t.writer.position()+8),t.writer.writeUint32At(a,t.writer.position()-a)})(t,e),t.writer.writeUint32At(i,t.writer.position()-i)})(t,e),t.writer.writeUint32At(i,t.writer.position()-i)},zn=(t,e)=>{const i=new Mn,n=t.filter((t=>_n(t)&&Pn(t))).length>0;return t.filter((t=>_n(t)&&Bn(t))).length>0?Ln(i,Cn):Ln(i,n?In:xn),Fn(i,t,1e3),i.writer.buffer()},Hn=t=>{const e=new Mn;return Gn(e,t),((t,e)=>{const i=e.samples.reduce(((t,e)=>t+e.data.byteLength),0);Un(t,kn.mdat,i),e.samples.forEach((e=>t.writer.writeBytes(e.data)))})(e,t),e.writer.buffer()},jn=t=>{const{sequenceParameterSets:e,pictureParameterSets:i}=pi(t),n=e[0],s=i[0];if(!n||!s)throw new Error("No sps or pps provided");return(t=>{var e;const i=new DataView(t),n=i.getUint8(1),s=i.getUint8(2),r=i.getUint8(3),a=new Y(t,32);a.readUnsignedExpGolomb();let o=1;switch(n){case 100:case 110:case 122:case 244:case 44:case 83:case 86:case 118:case 128:case 138:case 144:if(o=a.readUnsignedExpGolomb(),3===o&&a.readBits(1),a.readUnsignedExpGolomb(),a.readUnsignedExpGolomb(),a.readBit(),a.readBit())for(let t=0;t<(3!=o?8:12);t++)if(a.readBit()){const e=t<6?16:64;let i=0,n=8,s=8;for(let t=0;t<e;t++)0!=s&&(i=a.readSignedExpGolomb(),s=(n+i+256)%256),n=0==s?n:s}}a.readUnsignedExpGolomb();const l=a.readUnsignedExpGolomb();if(0==l)a.readUnsignedExpGolomb();else if(1==l)throw new Error("Unhandled case");a.readUnsignedExpGolomb(),a.readBit();const h=a.readUnsignedExpGolomb(),c=a.readUnsignedExpGolomb(),d=a.readBit();0===d&&a.readBit(),a.readBit();let u=h+1,m=c+1;if(m*=2-d,m*=16,u*=16,a.readBit()){const t=1<<(1==o||2==o?1:0),e=2-d<<(1==o?1:0);u-=a.readUnsignedExpGolomb()*t+a.readUnsignedExpGolomb()*t,m-=a.readUnsignedExpGolomb()*e+a.readUnsignedExpGolomb()*e}let p={numerator:1,denumerator:1};return a.readBit()&&a.readBit()&&(p=null!=(e=gi[a.readBits(8)])?e:{numerator:0,denumerator:0}),{width:u,height:m,pixelAspectRatio:p,profileIdc:n,constraintFlags:s,levelIdc:r}})(n)},Xn=t=>{const e=new Y(t);return 1===e.peekBit()&&e.readBits(32),qn(e),Qn(e)},qn=t=>{const e=t.readBits(8);if(e>>7&1)return;const i=e>>3&15,n=e>>2&1,s=e>>1&1;return 1==n&&t.readBits(8),1==s&&(t=>{let e=0;for(let i=0;i<8;i++){const n=t.readBits(8);if(e|=(127&n)<<7*i,128&~n)break}})(t),{headerLength:1+n,type:i}},Qn=t=>{const e=t.readBits(3),i=0!==t.readBit(),n=0!==t.readBit();let s,r=!1,a=!1,o=!1,l=0,h=0;const c=[];if(n)t.readBits(5);else{if(a=0!==t.readBit(),a&&(s=(t=>{const e=t.readBits(32),i=t.readBits(32),n=0!==t.readBit();let s=0;return n&&(s=(t=>{let e=0;for(;e<100&&0===t.readBit();)e++;return e>=32?0:t.readBits(e)+(1<<e)-1})(t)+1),{timescale:i,equalPictureInterval:n,numUnitsInDisplayTick:e,numTicksPerPicture:s}})(t),r=0!==t.readBit(),r))throw new Error("Not implemented");o=0!==t.readBit();const e=t.readBits(5)+1;for(let i=0;i<e;i++){const e=t.readBits(12),i=t.readBits(5);let n=0;if(i>7&&(n=t.readBit()),r)throw new Error("decoderModelInfoPresentFlag==1");o&&0!==t.readBit()&&t.readBits(4),c.push({tier:n,operatingPointIdc:e,seqLevelIdx:i})}}const d=t.readBits(4)+1,u=t.readBits(4)+1,m=t.readBits(d)+1,p=t.readBits(u)+1;let g=!1;g=!n&&0!==t.readBit(),g&&(l=t.readBits(4)+2,h=t.readBits(3)+1);const f=0!==t.readBit(),A=0!==t.readBit(),v=0!==t.readBit();let b=!1,w=!1,y=!1,S=!1,k=!1,E=!1,T=!1,I=2,C=2,x=0;return n||(b=0!==t.readBit(),w=0!==t.readBit(),y=0!==t.readBit(),S=0!==t.readBit(),k=0!==t.readBit(),k&&(E=0!==t.readBit(),T=0!==t.readBit()),I=0!==t.readBit()?2:t.readBit(),C=I>0?t.readBit()>0?2:t.readBit():2,x=k?t.readBits(3):0),{seqProfile:e,stillPicture:i,reducedStillPictureHeader:n,timingInfoPresentFlag:a,timingInfo:null!=s?s:{equalPictureInterval:!1,numUnitsInDisplayTick:0,timescale:0,numTicksPerPicture:0},decoderModelInfoPresentFlag:r,initialDisplayDelayPresentFlag:o,operatingPoints:c,frameWidthBits:d,frameHeightBits:u,maxFrameWidth:m,maxFrameHeight:p,frameIdNumbersPresentFlag:g,deltaFrameIdLength:l,additionalFrameIdLength:h,use_128x128Superblock:f,enableFilterIntra:A,enableIntraEdgeFilter:v,enableInterintraCompound:b,enableMaskedCompound:w,enableWarpedMotion:y,enableDualFilter:S,enableOrderHint:k,enableJntComp:E,enableRefFrameMvs:T,seqForceScreenContentTools:I,seqForceIntegerMv:C,orderHintBits:x,enableSuperres:0!==t.readBit(),enableCdef:0!==t.readBit(),enableRestoration:0!==t.readBit(),colorConfig:$n(t,e),filmGrainParamsPresent:0!==t.readBit()}},$n=(t,e)=>{const i=0!==t.readBit();let n=8,s=!1;2===e&&i?n=0!==t.readBit()?12:10:e<=2&&(n=i?10:8),s=1!==e&&0!==t.readBit();const r=s?1:3;let a=2,o=2,l=2,h=!1,c=0,d=0,u=0,m=!1;return 0!==t.readBit()&&(a=t.readBits(8),o=t.readBits(8),l=t.readBits(8)),s?(h=0!==t.readBit(),c=1,d=1,u=0,m=!1,{highBitDepth:i,bitDepth:n,monoChrome:s,chromaSamplePosition:u,colorPrimaries:a,colorRange:h,matrixCoefficients:l,numPlanes:r,separateUvDeltaQ:m,subsamplingX:c,subsamplingY:d,transferCharacteristics:o}):1===a&&13==o&&0==l?(h=!0,c=0,d=0,{highBitDepth:i,bitDepth:n,monoChrome:s,chromaSamplePosition:u,colorPrimaries:a,colorRange:h,matrixCoefficients:l,numPlanes:r,separateUvDeltaQ:m,subsamplingX:c,subsamplingY:d,transferCharacteristics:o}):(h=0!==t.readBit(),0===e?(c=1,d=1):1===e?(c=0,d=0):12===n?(c=t.readBit(),d=0!==c?t.readBit():0):(c=1,d=0),0!==c&&0!==d&&(u=t.readBits(2)),m=0!==t.readBit(),{highBitDepth:i,bitDepth:n,monoChrome:s,chromaSamplePosition:u,colorPrimaries:a,colorRange:h,matrixCoefficients:l,numPlanes:r,separateUvDeltaQ:m,subsamplingX:c,subsamplingY:d,transferCharacteristics:o})},Zn=t=>!!(1&t),Kn=()=>"wakeLock"in navigator&&-1===window.navigator.userAgent.indexOf("Samsung");class Jn{constructor(){I(this,"enabled",!1),I(this,"wakeLockVideo"),I(this,"_wakeLock",null),I(this,"handleVisibilityChange",(()=>{null!==this._wakeLock&&"visible"===document.visibilityState&&this.enable()})),Kn()&&(this._wakeLock=null,document.addEventListener("visibilitychange",this.handleVisibilityChange),document.addEventListener("fullscreenchange",this.handleVisibilityChange))}_addSourceToVideo(t,e,i){const n=document.createElement("source");n.src=i,n.type=`video/${e}`,t.appendChild(n)}get isEnabled(){return this.enabled}attach(t){if(!Kn()){if(!this.wakeLockVideo){const t=document.createElement("video");this.wakeLockVideo=t,this.wakeLockVideo.setAttribute("title","Live Stream"),this.wakeLockVideo.setAttribute("playsinline",""),this._addSourceToVideo(this.wakeLockVideo,"mp4","data:video/mp4;base64,AAAAHGZ0eXBNNFYgAAACAGlzb21pc28yYXZjMQAAAAhmcmVlAAAGF21kYXTeBAAAbGliZmFhYyAxLjI4AABCAJMgBDIARwAAArEGBf//rdxF6b3m2Ui3lizYINkj7u94MjY0IC0gY29yZSAxNDIgcjIgOTU2YzhkOCAtIEguMjY0L01QRUctNCBBVkMgY29kZWMgLSBDb3B5bGVmdCAyMDAzLTIwMTQgLSBodHRwOi8vd3d3LnZpZGVvbGFuLm9yZy94MjY0Lmh0bWwgLSBvcHRpb25zOiBjYWJhYz0wIHJlZj0zIGRlYmxvY2s9MTowOjAgYW5hbHlzZT0weDE6MHgxMTEgbWU9aGV4IHN1Ym1lPTcgcHN5PTEgcHN5X3JkPTEuMDA6MC4wMCBtaXhlZF9yZWY9MSBtZV9yYW5nZT0xNiBjaHJvbWFfbWU9MSB0cmVsbGlzPTEgOHg4ZGN0PTAgY3FtPTAgZGVhZHpvbmU9MjEsMTEgZmFzdF9wc2tpcD0xIGNocm9tYV9xcF9vZmZzZXQ9LTIgdGhyZWFkcz02IGxvb2thaGVhZF90aHJlYWRzPTEgc2xpY2VkX3RocmVhZHM9MCBucj0wIGRlY2ltYXRlPTEgaW50ZXJsYWNlZD0wIGJsdXJheV9jb21wYXQ9MCBjb25zdHJhaW5lZF9pbnRyYT0wIGJmcmFtZXM9MCB3ZWlnaHRwPTAga2V5aW50PTI1MCBrZXlpbnRfbWluPTI1IHNjZW5lY3V0PTQwIGludHJhX3JlZnJlc2g9MCByY19sb29rYWhlYWQ9NDAgcmM9Y3JmIG1idHJlZT0xIGNyZj0yMy4wIHFjb21wPTAuNjAgcXBtaW49MCBxcG1heD02OSBxcHN0ZXA9NCB2YnZfbWF4cmF0ZT03NjggdmJ2X2J1ZnNpemU9MzAwMCBjcmZfbWF4PTAuMCBuYWxfaHJkPW5vbmUgZmlsbGVyPTAgaXBfcmF0aW89MS40MCBhcT0xOjEuMDAAgAAAAFZliIQL8mKAAKvMnJycnJycnJycnXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXiEASZACGQAjgCEASZACGQAjgAAAAAdBmjgX4GSAIQBJkAIZACOAAAAAB0GaVAX4GSAhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZpgL8DJIQBJkAIZACOAIQBJkAIZACOAAAAABkGagC/AySEASZACGQAjgAAAAAZBmqAvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZrAL8DJIQBJkAIZACOAAAAABkGa4C/AySEASZACGQAjgCEASZACGQAjgAAAAAZBmwAvwMkhAEmQAhkAI4AAAAAGQZsgL8DJIQBJkAIZACOAIQBJkAIZACOAAAAABkGbQC/AySEASZACGQAjgCEASZACGQAjgAAAAAZBm2AvwMkhAEmQAhkAI4AAAAAGQZuAL8DJIQBJkAIZACOAIQBJkAIZACOAAAAABkGboC/AySEASZACGQAjgAAAAAZBm8AvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZvgL8DJIQBJkAIZACOAAAAABkGaAC/AySEASZACGQAjgCEASZACGQAjgAAAAAZBmiAvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZpAL8DJIQBJkAIZACOAAAAABkGaYC/AySEASZACGQAjgCEASZACGQAjgAAAAAZBmoAvwMkhAEmQAhkAI4AAAAAGQZqgL8DJIQBJkAIZACOAIQBJkAIZACOAAAAABkGawC/AySEASZACGQAjgAAAAAZBmuAvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZsAL8DJIQBJkAIZACOAAAAABkGbIC/AySEASZACGQAjgCEASZACGQAjgAAAAAZBm0AvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZtgL8DJIQBJkAIZACOAAAAABkGbgCvAySEASZACGQAjgCEASZACGQAjgAAAAAZBm6AnwMkhAEmQAhkAI4AhAEmQAhkAI4AhAEmQAhkAI4AhAEmQAhkAI4AAAAhubW9vdgAAAGxtdmhkAAAAAAAAAAAAAAAAAAAD6AAABDcAAQAAAQAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAwAAAzB0cmFrAAAAXHRraGQAAAADAAAAAAAAAAAAAAABAAAAAAAAA+kAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAALAAAACQAAAAAAAkZWR0cwAAABxlbHN0AAAAAAAAAAEAAAPpAAAAAAABAAAAAAKobWRpYQAAACBtZGhkAAAAAAAAAAAAAAAAAAB1MAAAdU5VxAAAAAAALWhkbHIAAAAAAAAAAHZpZGUAAAAAAAAAAAAAAABWaWRlb0hhbmRsZXIAAAACU21pbmYAAAAUdm1oZAAAAAEAAAAAAAAAAAAAACRkaW5mAAAAHGRyZWYAAAAAAAAAAQAAAAx1cmwgAAAAAQAAAhNzdGJsAAAAr3N0c2QAAAAAAAAAAQAAAJ9hdmMxAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAALAAkABIAAAASAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGP//AAAALWF2Y0MBQsAN/+EAFWdCwA3ZAsTsBEAAAPpAADqYA8UKkgEABWjLg8sgAAAAHHV1aWRraEDyXyRPxbo5pRvPAyPzAAAAAAAAABhzdHRzAAAAAAAAAAEAAAAeAAAD6QAAABRzdHNzAAAAAAAAAAEAAAABAAAAHHN0c2MAAAAAAAAAAQAAAAEAAAABAAAAAQAAAIxzdHN6AAAAAAAAAAAAAAAeAAADDwAAAAsAAAALAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAAiHN0Y28AAAAAAAAAHgAAAEYAAANnAAADewAAA5gAAAO0AAADxwAAA+MAAAP2AAAEEgAABCUAAARBAAAEXQAABHAAAASMAAAEnwAABLsAAATOAAAE6gAABQYAAAUZAAAFNQAABUgAAAVkAAAFdwAABZMAAAWmAAAFwgAABd4AAAXxAAAGDQAABGh0cmFrAAAAXHRraGQAAAADAAAAAAAAAAAAAAACAAAAAAAABDcAAAAAAAAAAAAAAAEBAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAkZWR0cwAAABxlbHN0AAAAAAAAAAEAAAQkAAADcAABAAAAAAPgbWRpYQAAACBtZGhkAAAAAAAAAAAAAAAAAAC7gAAAykBVxAAAAAAALWhkbHIAAAAAAAAAAHNvdW4AAAAAAAAAAAAAAABTb3VuZEhhbmRsZXIAAAADi21pbmYAAAAQc21oZAAAAAAAAAAAAAAAJGRpbmYAAAAcZHJlZgAAAAAAAAABAAAADHVybCAAAAABAAADT3N0YmwAAABnc3RzZAAAAAAAAAABAAAAV21wNGEAAAAAAAAAAQAAAAAAAAAAAAIAEAAAAAC7gAAAAAAAM2VzZHMAAAAAA4CAgCIAAgAEgICAFEAVBbjYAAu4AAAADcoFgICAAhGQBoCAgAECAAAAIHN0dHMAAAAAAAAAAgAAADIAAAQAAAAAAQAAAkAAAAFUc3RzYwAAAAAAAAAbAAAAAQAAAAEAAAABAAAAAgAAAAIAAAABAAAAAwAAAAEAAAABAAAABAAAAAIAAAABAAAABgAAAAEAAAABAAAABwAAAAIAAAABAAAACAAAAAEAAAABAAAACQAAAAIAAAABAAAACgAAAAEAAAABAAAACwAAAAIAAAABAAAADQAAAAEAAAABAAAADgAAAAIAAAABAAAADwAAAAEAAAABAAAAEAAAAAIAAAABAAAAEQAAAAEAAAABAAAAEgAAAAIAAAABAAAAFAAAAAEAAAABAAAAFQAAAAIAAAABAAAAFgAAAAEAAAABAAAAFwAAAAIAAAABAAAAGAAAAAEAAAABAAAAGQAAAAIAAAABAAAAGgAAAAEAAAABAAAAGwAAAAIAAAABAAAAHQAAAAEAAAABAAAAHgAAAAIAAAABAAAAHwAAAAQAAAABAAAA4HN0c3oAAAAAAAAAAAAAADMAAAAaAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAACMc3RjbwAAAAAAAAAfAAAALAAAA1UAAANyAAADhgAAA6IAAAO+AAAD0QAAA+0AAAQAAAAEHAAABC8AAARLAAAEZwAABHoAAASWAAAEqQAABMUAAATYAAAE9AAABRAAAAUjAAAFPwAABVIAAAVuAAAFgQAABZ0AAAWwAAAFzAAABegAAAX7AAAGFwAAAGJ1ZHRhAAAAWm1ldGEAAAAAAAAAIWhkbHIAAAAAAAAAAG1kaXJhcHBsAAAAAAAAAAAAAAAALWlsc3QAAAAlqXRvbwAAAB1kYXRhAAAAAQAAAABMYXZmNTUuMzMuMTAw"),Object.assign(this.wakeLockVideo.style,{position:"absolute",left:"-100%",top:"-100%"}),this.wakeLockVideo.addEventListener("loadedmetadata",(()=>{t.addEventListener("timeupdate",(()=>{t.currentTime>.5&&(t.currentTime=Math.random())}))}))}t&&t.appendChild(this.wakeLockVideo)}}enable(){return B(this,null,(function*(){var t,e;return Kn()?navigator.wakeLock.request("screen").then((t=>{this._wakeLock=t,this.enabled=!0,this._wakeLock.addEventListener("release",(()=>{}))})).catch((()=>{this.enabled=!1})):(null!=(e=null==(t=this.wakeLockVideo)?void 0:t.play())?e:Promise.resolve()).then((t=>(this.enabled=!0,t))).catch((()=>{this.enabled=!1}))}))}disable(){var t,e;Kn()?(this._wakeLock&&this._wakeLock.release(),this._wakeLock=null):(null==(t=this.wakeLockVideo)||t.pause(),null==(e=this.wakeLockVideo)||e.remove()),this.enabled=!1}unload(){document.removeEventListener("visibilitychange",this.handleVisibilityChange),document.removeEventListener("fullscreenchange",this.handleVisibilityChange),this.disable()}}const Yn=/\r\n|\r|\n/;var ts,es,is,ns,ss;class rs{constructor(t){U(this,ts),U(this,es),R(this,ts,t),R(this,es,0)}skipEmptyLines(){let t=0;for(;""===M(this,ts)[M(this,es)];)P(this,es)._++,t++;return t}readLine(){return M(this,ts)[P(this,es)._++]}takeUntilEmptyLine(){const t=[];for(;""!==M(this,ts)[M(this,es)];){const e=this.readLine();if(void 0===e)break;t.push(e)}return t}linesLeft(){return M(this,ts).length-M(this,es)}}ts=new WeakMap,es=new WeakMap;class as{constructor(){U(this,is)}parse(t){const e=[],i=t.split(Yn),n=new rs(i),s=n.readLine();if(!s||!s.startsWith("WEBVTT"))throw new Error("missing 'WEBVTT' signature");for(;""!==n.readLine(););for(;n.linesLeft()>0;){const t=L(this,is,ns).call(this,n);e.push(t),n.skipEmptyLines()}return e}}is=new WeakSet,ns=function(t){t.skipEmptyLines();const e=t.takeUntilEmptyLine(),i=new rs(e);let n,s=i.readLine();if(null!=s&&s.includes("--\x3e")||(n=s,s=i.readLine()),void 0===s)throw new Error("expected cue line");const[r,a]=s.split("--\x3e").map((t=>t.trim()));if(!r||!a)throw new Error(`a cue needs both start and end time start: ${r} end: ${a}`);const[o,l]=a.split(" ",1).map((t=>t.trim()));if(!o)throw new Error(`missing end time: ${o}`);const h=i.readLine();if(!h)throw new Error("missing text");return{id:n,startTime:L(this,is,ss).call(this,r),endTime:L(this,is,ss).call(this,o),text:h}},ss=function(t){const e=t.split(":");if(2==e.length){const[t=0,i=0]=e.map((t=>parseFloat(t)));return 60*t+i}const[i=0,n=0,s=0]=e.map((t=>parseFloat(t)));return 60*i*60+60*n+s};class os extends n.E{constructor({type:t,autoplay:e,muted:i,logger:n,poster:s}){super(),I(this,"element"),I(this,"logger"),I(this,"seekTimes",new H(10)),I(this,"seekStartTime"),I(this,"_userProvidedMuted"),I(this,"timers",new Zt),I(this,"_userHasProvidedInput",!1),I(this,"_isPaused",!0),I(this,"isActivated",!1),I(this,"dummy"),I(this,"_iosHackEnterPiPMode",(()=>{const t=this.element.parentElement,e=this.element.clientWidth/this.element.clientHeight;this.element.style.position="fixed",this.element.style.opacity="0",this.element.style.pointerEvents="none",t&&(this.dummy=document.createElement("video"),this.dummy.style.paddingBottom="calc(100% / "+e+")",this.dummy.style.width="100%",this.dummy.style.height="0px",t.appendChild(this.dummy))})),I(this,"_iosHackExitPiPMode",(()=>{this.element.style.position="relative",this.element.style.opacity="1",this.element.style.pointerEvents="auto",this.dummy&&(this.dummy.remove(),this.dummy=void 0)})),I(this,"attach",(t=>{this.element.remove(),t.appendChild(this.element)})),I(this,"load",(()=>{this.timers.setInterval(this.onPlayPause,500),this.timers.setTimeout((()=>{this.timers.setInterval(this.onBufferStateChange,500)}),1e4)})),I(this,"unload",(()=>{this.timers.unload()})),I(this,"getPlaybackRate",(()=>this.element.playbackRate)),I(this,"getPlaybackState",(()=>this.element.readyState>=this.element.HAVE_FUTURE_DATA?"playing":"buffering")),I(this,"setPlaybackRate",(t=>{this.element.playbackRate=t})),I(this,"getBuffer",(()=>{const t=[],e=this.element.buffered;if(!e)return[];for(let i=0;i<e.length;i++)t.push({start:1e3*e.start(i),end:1e3*e.end(i)});return t})),I(this,"pause",(()=>{this._isPaused=!1,this.element.pause()})),I(this,"tryPlay",(()=>{this.element.muted=this._userProvidedMuted,this._play().catch(G)})),I(this,"play",(()=>{this.element.muted=this._userProvidedMuted,this._play().catch((t=>{if(t instanceof Error){const e=new de("Media Play Error",{source:t,isFatal:!1,code:"media_play_error"});this.emit("error",e)}}))})),I(this,"_play",(()=>B(this,null,(function*(){try{yield this.element.play(),this._userHasProvidedInput=!this.muted||this._userProvidedMuted}catch(t){if(!(t instanceof Error&&"NotAllowedError"===t.name))throw t;if(this._userHasProvidedInput=!1,!this.element.muted)return this.element.muted=!0,this.emit("needs user input",{forAudio:!0,forVideo:!1}),this._play();this.emit("needs user input",{forAudio:!0,forVideo:!0})}})))),I(this,"onEvent",(t=>{this.logger.trace(t.type,{state:this.element.readyState,event:t,playbackState:this.getPlaybackState()})})),I(this,"onVolumeChange",(()=>{this.logger.info("volume state",{isMuted:this.element.muted,volume:this.element.volume}),this.emit("volume state",{isMuted:this.element.muted,volume:this.element.volume})})),I(this,"onPlayPause",(()=>{this._isPaused!==this.element.paused&&(this._isPaused=this.element.paused,this.logger.info("player pause change",{paused:this.element.paused}),this.emit("media element state",this.element.paused?"paused":"playing"))})),I(this,"onBufferStateChange",(()=>{this.emit("buffer state",{isPaused:this.element.paused,buffered:this.getBuffer(),currentTime:this.currentTime,playbackState:this.getPlaybackState()})})),I(this,"onSeekStart",(()=>{this.seekStartTime=Date.now()})),I(this,"onSeekEnd",(()=>{this.seekStartTime&&(this.seekTimes.push(Date.now()-this.seekStartTime),this.seekStartTime=void 0)})),this.logger=n,this._userProvidedMuted=i,this.element=document.createElement(t),this.element instanceof HTMLVideoElement&&(this.element.playsInline=!0),this.element.controls=!1,this.element.autoplay=e,this.element.muted=i,this.element.style.display="block",this.element.style.width="100%",this.element.disableRemotePlayback=!0,this.element.setAttribute("poster","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAJCAQAAACRI2S5AAAAEElEQVR42mNkIAAYRxWAAQAG9gAKqv6+AwAAAABJRU5ErkJggg=="),this.onPlayPause(),setTimeout((()=>{!this.element||!s||this.element.setAttribute("poster",s)}),0),this.element.addEventListener("stalled",this.onEvent),this.element.addEventListener("canplay",this.onEvent),this.element.addEventListener("loadeddata",this.onEvent),this.element.addEventListener("loadedmetadata",this.onEvent),this.element.addEventListener("canplaythrough",this.onEvent),this.element.addEventListener("waiting",this.onEvent),this.element.addEventListener("playing",this.onPlayPause),this.element.addEventListener("pause",this.onPlayPause),this.element.addEventListener("seeked",this.onSeekEnd),this.element.addEventListener("seeking",this.onSeekStart),this.element.addEventListener("volumechange",this.onVolumeChange),this.element.addEventListener("timeupdate",this.onBufferStateChange),this.element.addEventListener("progress",this.onBufferStateChange)}get seekTime(){return this.seekTimes.isEmpty()?0:wt(this.seekTimes.items())}get isSeeking(){return this.element.seeking}get currentTime(){return isNaN(this.element.currentTime)?0:1e3*this.element.currentTime}set currentTime(t){Number.isFinite(t)&&(this.element.currentTime=t/1e3)}get playbackRate(){return this.element.playbackRate}set playbackRate(t){this.element.playbackRate=t}get volume(){return this.element.volume}set volume(t){this.element.volume=t}get muted(){return this.element.muted}set muted(t){this._userProvidedMuted=t,this.element.muted=t}get userHasProvidedInput(){return this._userHasProvidedInput}get isPaused(){return this._isPaused}}const ls=["minBufferTime","maxBufferTime","burstEnabled","sizeBasedResolutionCapEnabled","separateVideoSocketEnabled","videoCodecs"];class hs{constructor(t){I(this,"options"),I(this,"overrides",new Map),this.options=t}getOptions(){return this.options}addOverrides(t,e){this.overrides.set(t,e)}set(t,e){this.options[t]=e}get(t,e){var i;if(e&&function(t){return ls.includes(t)}(t)){const n=null==(i=this.overrides.get(e))?void 0:i[t];if(void 0!==n)return n}return this.options[t]}getOverride(t,e){var i;return null==(i=this.overrides.get(e))?void 0:i[t]}}const cs={cooldownTime:3e3,maxBufferingEvents:{last10Seconds:0},maxBufferingRatio:{last10Seconds:0},maxRecentDowngradesCount:3,maxDowngradeLookbackMs:6e4,minTimeSpentPlaying:{factor:.5,ratio:.1},maxCooldownRatio:2},ds=t=>e=>e>t,us=class{constructor(t,e,i,n){I(this,"qualityOfServiceSource"),I(this,"config"),I(this,"emitter"),I(this,"logger"),I(this,"isSuspended",!1),I(this,"lastAdaptTime",Date.now()),I(this,"isEnabled",!0),I(this,"load",(()=>{this.emitter.on("buffer state",this.onBufferState),this.emitter.on("adapted level",this.onAdaptedLevel)})),I(this,"unload",(()=>{this.emitter.off("buffer state",this.onBufferState),this.emitter.off("adapted level",this.onAdaptedLevel)})),I(this,"suspend",(()=>{this.isSuspended=!0})),I(this,"unsuspend",(()=>{this.reset(),this.isSuspended=!1})),I(this,"reset",((t=0)=>{this.lastAdaptTime=Date.now()+t})),I(this,"getStatistics",(()=>({isAbrEnabled:this.isEnabled}))),I(this,"isQoSOk",(t=>{const e=this.qualityOfServiceSource.getLevelStats(t),{upgradesFromLevel:i,downgradesFromLevel:n}=null!=e?e:{upgradesFromLevel:[],downgradesFromLevel:[]},s=Date.now()-this.config.maxDowngradeLookbackMs,r=n.filter(ds(s)).length,a=i.filter(ds(s)).length;if(r-a>this.config.maxRecentDowngradesCount)return this.logger.debug("Recent downgrades count is over maximum",{downgrades:r-a,maxRecentDowngradesCount:this.config.maxRecentDowngradesCount}),!1;const o=this.qualityOfServiceSource.timeSpentPlayingInAtLeastLevelRatio(t),l=o*(this.qualityOfServiceSource.timeActive()-this.qualityOfServiceSource.timeSpentBuffering())/this.config.maxDowngradeLookbackMs;if(r>1&&l<this.config.minTimeSpentPlaying.factor)return this.logger.debug("Time spent playing is too low",{recentDowngrades:r,timeSpentPlayingInAtLeastLevelRatio:o}),!1;if(r>1&&o<this.config.minTimeSpentPlaying.ratio)return this.logger.debug("Time spent playing in at least this level is too low",{recentDowngrades:r,timeSpentPlayingInAtLeastLevelRatio:o}),!1;const h=Math.max(0,n.length-i.length-l),c=Date.now()-this.config.maxDowngradeLookbackMs*h,d=n.filter(ds(c)).length;return!(d&&h>this.config.maxCooldownRatio&&(this.logger.debug("Too many downgrades compared to time spent playing",{downgradesWithinCooldownTime:d,cooldownRatio:h}),1))})),I(this,"onBufferState",(t=>{if(!this.isEnabled||this.isSuspended||this.lastAdaptTime+this.config.cooldownTime>Date.now())return;const{bufferFullness:e,general:i}=this.qualityOfServiceSource.getMetrics(),n=this.qualityOfServiceSource.getBufferFullnessRegression();if(!n)return;const{slope:s}=n,r=n.predict(15),a=s<0,o=n.predict(15)<.4&&n.slope<0,l=n.predict(15)>.6,h=this.qualityOfServiceSource.timeSpentBufferingLast(3e4),c=this.qualityOfServiceSource.timeSpentActiveLast(3e4);e<.15&&h/c>.8?this.adaptLevel("reconnect"):i.decodeRate<=1?this.adaptLevel("downgrade"):o||e<.15?a&&e<.4&&r<.2&&this.adaptLevel("buffering"===t.playbackState?"double downgrade":"downgrade"):e>.5&&l&&!this.tooMuchTimeBuffering(1e4)&&!this.tooManyBufferingEvents(1e4)&&this.adaptLevel("upgrade")})),I(this,"onAdaptedLevel",(()=>{this.reset()})),I(this,"adaptLevel",(t=>this.emitter.emit("adapt level",t))),this.qualityOfServiceSource=i,this.config=f(f({},cs),n),this.emitter=t,this.logger=e}tooMuchTimeBuffering(t){return this.qualityOfServiceSource.timeSpentBufferingLast(t)/this.qualityOfServiceSource.timeSpentActiveLast(t)>this.config.maxBufferingRatio.last10Seconds}tooManyBufferingEvents(t){return this.qualityOfServiceSource.timeSpentBufferingLast(t)>this.config.maxBufferingEvents.last10Seconds}};I(us,"create",((t,e,i,n={})=>new us(t,e,i,n)));let ms=us;const ps={minBufferTime:1500,maxBufferTime:1500,cooldownTime:3e4,maxBufferingEvents:{last30Seconds:3},maxBufferingRatio:{last30Seconds:.15}},gs=class t{constructor(e,i,n,s,r){I(this,"qualityOfServiceSource"),I(this,"targetBufferTimeTarget"),I(this,"config"),I(this,"emitter"),I(this,"logger"),I(this,"isSuspended",!1),I(this,"lastIncreaseTime",Date.now()),I(this,"bufferTimeAdjustmentCount",0),I(this,"load",(()=>{this.emitter.on("buffer state",this.onBufferState)})),I(this,"unload",(()=>{this.emitter.off("buffer state",this.onBufferState)})),I(this,"suspend",(()=>{this.isSuspended=!0})),I(this,"unsuspend",(()=>{this.reset(),this.isSuspended=!1})),I(this,"reset",(()=>{this.lastIncreaseTime=Date.now()})),I(this,"getStatistics",(()=>({bufferTimeAdjustmentCount:this.bufferTimeAdjustmentCount}))),I(this,"onBufferState",(e=>{const{minBufferTime:i,maxBufferTime:n,cooldownTime:s}=this.config;if(this.isSuspended||this.lastIncreaseTime+s>Date.now()||this.targetBufferTimeTarget.targetBufferTime>=n)return;const r=this.qualityOfServiceSource.timeSpentBufferingLast(3e4),a=this.qualityOfServiceSource.bufferingEventsLast(3e4),o=r/this.qualityOfServiceSource.timeSpentActiveLast(3e4),l=Math.ceil(Math.max((n-i)/(t.BUFFER_TIME_MAX_STEPS-1),t.BUFFER_TIME_STEP_SIZE));(o>this.config.maxBufferingRatio.last30Seconds||a>this.config.maxBufferingEvents.last30Seconds)&&(this.targetBufferTimeTarget.targetBufferTime=Math.min(n,this.targetBufferTimeTarget.targetBufferTime+l),this.bufferTimeAdjustmentCount++,this.reset())})),this.qualityOfServiceSource=n,this.targetBufferTimeTarget=s,this.config=f(f({},ps),r),this.emitter=e,this.logger=i}updateConfig(t){this.config=f(f({},this.config),t)}};I(gs,"BUFFER_TIME_STEP_SIZE",500),I(gs,"BUFFER_TIME_MAX_STEPS",3),I(gs,"create",((t,e,i,n,s={})=>new gs(t,e,i,n,s)));let fs=gs;var As=(t=>(t[t.StreamHeaderGroup=4]="StreamHeaderGroup",t[t.FetchHeader=5]="FetchHeader",t[t.StreamHeaderTrack=60]="StreamHeaderTrack",t))(As||{});function vs(t){switch(t){case 0:case 1:case 2:case 3:case 4:return}throw new Error("Unknown object status "+t)}var bs,ws,ys,Ss,ks,Es,Ts,Is,Cs,xs,Ms,Us,Rs,Ls,Ps,Bs,_s,Ds,Ns,Ws,Os,Fs,Vs,Gs,zs,Hs,js,Xs,qs,Qs,$s,Zs,Ks,Js,Ys,tr,er,ir,nr,sr,rr,ar,or,lr,hr,cr,dr,ur,mr;class pr{constructor(t,e,i,n,s,r){U(this,bs),U(this,ws),U(this,ys),U(this,Ss),U(this,ks),U(this,Es,new z),U(this,Ts,0),U(this,Is),R(this,bs,t),R(this,ws,e),R(this,ys,i),R(this,Ss,n),R(this,ks,s),R(this,Is,r)}endStatus(){return M(this,Es).promise}groupId(){return M(this,ws)}subscribeId(){return M(this,ys)}next(){return B(this,null,(function*(){if(!M(this,Es).pending)return{done:!0,value:void 0};if(yield M(this,bs).isDone())return{done:!0,value:void 0};const t=0===M(this,Ts)?M(this,ws):yield M(this,bs).readBigVarInt(),e=yield M(this,bs).readBigVarInt(),i=yield M(this,bs).readVarInt();let n=0,s=new Uint8Array;return i>0?s=yield M(this,bs).read(i):n=yield M(this,bs).readVarInt(),vs(n),(4===n||3===n)&&M(this,Es).resolve(n),P(this,Ts)._++,{done:!1,value:{subscribeId:M(this,ys),trackAlias:M(this,Ss),groupId:t,subGroupId:J(0),objectId:e,subscriberPriority:M(this,ks),streamId:M(this,Is),objectStatus:n,payload:s}}}))}return(){return B(this,null,(function*(){for(;!(yield this.next()).done;);return{done:!0,value:void 0}}))}[Symbol.asyncIterator](){return this}[Pt()](){return Promise.resolve()}[Symbol.asyncDispose](){return Promise.resolve()}}bs=new WeakMap,ws=new WeakMap,ys=new WeakMap,Ss=new WeakMap,ks=new WeakMap,Es=new WeakMap,Ts=new WeakMap,Is=new WeakMap;class gr{constructor(t,e,i,n,s){U(this,Ls),U(this,Cs),U(this,xs),U(this,Ms),U(this,Us),U(this,Rs),R(this,Cs,t),R(this,xs,e),R(this,Ms,i),R(this,Us,n),R(this,Rs,s)}streamId(){return M(this,Rs)}groups(){return L(this,Ls,Ps).call(this)}subscribeId(){return M(this,xs)}return(){return B(this,null,(function*(){return yield M(this,Cs).close(),{done:!0,value:void 0}}))}[Symbol.asyncIterator](){return this}[Pt()](){return L(this,Ls,Bs).call(this)}[Symbol.asyncDispose](){return L(this,Ls,Bs).call(this)}}Cs=new WeakMap,xs=new WeakMap,Ms=new WeakMap,Us=new WeakMap,Rs=new WeakMap,Ls=new WeakSet,Ps=function(){return D(this,null,(function*(){for(;!(yield new _(M(this,Cs).isDone()));){const t=yield new _(M(this,Cs).readBigVarInt()),e=new pr(M(this,Cs),t,M(this,xs),M(this,Ms),M(this,Us),M(this,Rs));if(yield e,4===(yield new _(Promise.race([e.endStatus(),M(this,Cs).closed()]))))return}}))},Bs=function(){return M(this,Cs).close().catch((()=>{}))};class fr{constructor(t,e,i,n,s,r,a){U(this,Hs),U(this,_s),U(this,Ds),U(this,Ns),U(this,Ws),U(this,Os),U(this,Fs),U(this,Vs,!1),U(this,Gs),U(this,zs,Rt.get().createContext("GroupReader")),R(this,_s,t),R(this,Ds,e),R(this,Ns,i),R(this,Ws,n),R(this,Os,s),R(this,Fs,r),R(this,Gs,a)}streamId(){return M(this,Gs)}groupId(){return M(this,Ws)}subscribeId(){return M(this,Ds)}next(){return B(this,null,(function*(){try{if((yield M(this,_s).isDone())||M(this,Vs))return{done:!0,value:void 0};const t=yield M(this,_s).readBigVarInt(),e=yield M(this,_s).readVarInt();let i=0,n=new Uint8Array;return e>0?n=yield M(this,_s).read(e):i=yield M(this,_s).readVarInt(),vs(i),3===i&&R(this,Vs,!0),{done:!1,value:{subscribeId:M(this,Ds),trackAlias:M(this,Ns),groupId:M(this,Ws),subGroupId:M(this,Os),subscriberPriority:M(this,Fs),streamId:M(this,Gs),objectId:t,objectStatus:i,payload:n}}}catch(t){return M(this,zs).info("Error reading object",{error:t}),{done:!0,value:void 0}}}))}return(){return B(this,null,(function*(){return yield M(this,_s).close().catch((()=>{})),{done:!0,value:void 0}}))}groups(){return L(this,Hs,js).call(this)}[Symbol.asyncIterator](){return this}[Pt()](){return L(this,Hs,Xs).call(this)}[Symbol.asyncDispose](){return L(this,Hs,Xs).call(this)}}function Ar(t,e){return B(this,null,(function*(){const i=yield t.readVarInt();switch(i){case As.StreamHeaderGroup:{const i=yield t.readBigVarInt(),n=yield t.readBigVarInt(),s=yield t.readBigVarInt(),r=yield t.readBigVarInt(),a=yield t.readUnsigned8();return new fr(t,i,n,s,r,a,e)}case As.StreamHeaderTrack:{const i=yield t.readBigVarInt(),n=yield t.readBigVarInt(),s=yield t.readUnsigned8();return new gr(t,i,n,s,e)}default:throw new Error("Unexpected message type "+i)}}))}_s=new WeakMap,Ds=new WeakMap,Ns=new WeakMap,Ws=new WeakMap,Os=new WeakMap,Fs=new WeakMap,Vs=new WeakMap,Gs=new WeakMap,zs=new WeakMap,Hs=new WeakSet,js=function(){return D(this,null,(function*(){yield this}))},Xs=function(){return M(this,_s).close().catch((()=>{}))};class vr{constructor(t,e){U(this,qs),U(this,Qs),R(this,qs,t),R(this,Qs,e)}start(t){M(this,qs).addEventListener("message",(e=>{if("object"==typeof e.data&&e.data instanceof ArrayBuffer){const i=new Uint8Array(e.data);i[0]==M(this,Qs)&&t.enqueue(i.subarray(1))}})),M(this,qs).addEventListener("error",(()=>t.error(new Error("WebSocket error")))),M(this,qs).addEventListener("close",(()=>Kt((()=>t.close()))))}cancel(t){M(this,qs).close(void 0,t)}}qs=new WeakMap,Qs=new WeakMap;class br{constructor(t){U(this,$s),U(this,Zs,null),U(this,Ks,null),U(this,Js,null),R(this,$s,t)}start(t){R(this,Zs,(e=>{if("object"==typeof e.data&&e.data instanceof ArrayBuffer){const i=new Uint8Array(e.data),n=i[0]||0,s=127&n,r=(n>>7&1)>0;if(s&&0!==s){const e=i.subarray(1);t.enqueue([r,s,e])}}})),R(this,Ks,(()=>Kt((()=>t.close())))),R(this,Js,(()=>t.error(new Error("WebSocket error")))),M(this,$s).addEventListener("message",M(this,Zs)),M(this,$s).addEventListener("error",M(this,Js)),M(this,$s).addEventListener("close",M(this,Ks))}cancel(t){M(this,Zs)&&M(this,$s).removeEventListener("message",M(this,Zs)),M(this,Js)&&M(this,$s).removeEventListener("error",M(this,Js)),M(this,Ks)&&M(this,$s).removeEventListener("close",M(this,Ks))}}$s=new WeakMap,Zs=new WeakMap,Ks=new WeakMap,Js=new WeakMap;class wr{constructor(t,e){U(this,sr),U(this,Ys),U(this,tr),U(this,er),U(this,ir,0),U(this,nr,new TextDecoder),R(this,Ys,t),R(this,tr,e),R(this,er,e.getReader())}readUnsigned8(){return B(this,null,(function*(){return yield L(this,sr,or).call(this,1),L(this,sr,hr).call(this,1)[0]}))}readString(){return B(this,null,(function*(){const t=yield this.readVarInt(),e=yield this.read(t);return M(this,nr).decode(e)}))}readVarInt(){return B(this,null,(function*(){const t=yield this.readBigVarInt();if(t>Number.MAX_SAFE_INTEGER)throw new Error("VarInt is too large");return Number(t)}))}readBigVarInt(){return B(this,null,(function*(){yield L(this,sr,or).call(this,1);const t=(192&L(this,sr,lr).call(this,1)[0])>>6;switch(M(this,Ys)[M(this,ir)]=63&L(this,sr,lr).call(this,1)[0],t){case 0:return J(L(this,sr,hr).call(this,1)[0]);case 1:{yield L(this,sr,or).call(this,2);const t=L(this,sr,hr).call(this,2);return J(new DataView(t.buffer,t.byteOffset,t.byteLength).getUint16(0))}case 2:{yield L(this,sr,or).call(this,4);const t=L(this,sr,hr).call(this,4);return J(new DataView(t.buffer,t.byteOffset,t.byteLength).getUint32(0))}case 3:{yield L(this,sr,or).call(this,8);const t=L(this,sr,hr).call(this,8),e=new DataView(t.buffer,t.byteOffset,t.byteLength);return void 0!==e.getBigUint64?J(e.getBigUint64(0)):J(mt(t,0,7))}default:throw new Error("Invalid VarInt size")}}))}read(t){return B(this,null,(function*(){return yield L(this,sr,or).call(this,t),L(this,sr,hr).call(this,t)}))}readAll(){return B(this,null,(function*(){for(;yield L(this,sr,ar).call(this););return L(this,sr,hr).call(this,L(this,sr,rr).call(this))}))}isDone(){return B(this,null,(function*(){return!(L(this,sr,rr).call(this)>0)&&0==(yield L(this,sr,ar).call(this))}))}closed(){return B(this,null,(function*(){return M(this,er).closed}))}close(){return B(this,null,(function*(){return M(this,er).releaseLock(),M(this,tr).cancel()}))}}Ys=new WeakMap,tr=new WeakMap,er=new WeakMap,ir=new WeakMap,nr=new WeakMap,sr=new WeakSet,rr=function(){return M(this,Ys).length-M(this,ir)},ar=function(){return B(this,null,(function*(){const{value:t,done:e}=yield M(this,er).read();if(e)return Promise.resolve(0);if(0===L(this,sr,rr).call(this))R(this,Ys,t);else{const e=M(this,Ys).subarray(M(this,ir)),i=new Uint8Array(e.length+t.length);i.set(e),i.set(t,e.byteLength),R(this,Ys,i)}return R(this,ir,0),Promise.resolve(t.length)}))},or=function(t){return B(this,null,(function*(){for(;L(this,sr,rr).call(this)<t;)if(0===(yield L(this,sr,ar).call(this)))throw new Error("Read failed")}))},lr=function(t){return M(this,Ys).subarray(M(this,ir),M(this,ir)+t)},hr=function(t){const e=L(this,sr,lr).call(this,t);return R(this,ir,M(this,ir)+e.length),e};class yr{constructor(t){U(this,cr,new Uint8Array(8)),U(this,dr),U(this,ur),U(this,mr,new TextEncoder),R(this,dr,t),R(this,ur,M(this,dr).getWriter())}writeString(t){return B(this,null,(function*(){const e=M(this,mr).encode(t);return yield this.writeVarInt(e.length),this.write(e)}))}write(t){return M(this,ur).write(t)}writeUnsigned8(t){return M(this,ur).write(Pr(t,M(this,cr)))}writeVarInt(t){return M(this,ur).write(Wr(t,M(this,cr)))}writeBigVarInt(t){return M(this,ur).write(Or(t,M(this,cr)))}flush(){return B(this,null,(function*(){}))}close(){return B(this,null,(function*(){M(this,ur).releaseLock(),yield M(this,dr).close()}))}}cr=new WeakMap,dr=new WeakMap,ur=new WeakMap,mr=new WeakMap;var Sr,kr,Er,Tr;const Ir=class t{constructor(e){U(this,Sr,0),U(this,kr,new Uint8Array(t.DEFAULT_BUFFER_SIZE)),U(this,Er),U(this,Tr,new TextEncoder),R(this,Er,e)}writeString(t){return B(this,null,(function*(){const e=M(this,Tr).encode(t);return yield this.writeVarInt(e.length),this.write(e)}))}ensureBufferSpace(t){if(M(this,kr).length-M(this,Sr)>=t)return;const e=new Uint8Array(M(this,kr).length+t);e.set(M(this,kr)),R(this,kr,e)}write(t){return this.ensureBufferSpace(t.length),M(this,kr).set(t,M(this,Sr)),R(this,Sr,M(this,Sr)+t.byteLength),Promise.resolve()}writeUnsigned8(t){return this.ensureBufferSpace(1),Pr(t,M(this,kr).subarray(M(this,Sr))),R(this,Sr,M(this,Sr)+1),Promise.resolve()}writeVarInt(t){if(t<0)throw new Error(`VarInt can not be negative: ${t}`);return this.ensureBufferSpace(8),R(this,Sr,M(this,Sr)+Wr(t,M(this,kr).subarray(M(this,Sr))).byteLength),Promise.resolve()}writeBigVarInt(t){if(t<0)throw new Error(`VarInt can not be negative: ${t}`);return this.ensureBufferSpace(8),R(this,Sr,M(this,Sr)+Or(t,M(this,kr).subarray(M(this,Sr))).byteLength),Promise.resolve()}flush(){if(1!==M(this,Er).readyState)throw new Error("Writer is not open");return M(this,Er).send(M(this,kr).subarray(0,M(this,Sr))),R(this,Sr,0),R(this,kr,new Uint8Array(t.DEFAULT_BUFFER_SIZE)),Promise.resolve()}close(){return M(this,Er).close(),Promise.resolve()}};Sr=new WeakMap,kr=new WeakMap,Er=new WeakMap,Tr=new WeakMap,I(Ir,"DEFAULT_BUFFER_SIZE",1024);let Cr=Ir;const xr=Math.pow(2,6)-1,Mr=Math.pow(2,14)-1,Ur=Math.pow(2,30)-1,Rr=Number.MAX_SAFE_INTEGER,Lr="function"==typeof BigInt?J(2)**J(62)-J(1):J(Number.MAX_SAFE_INTEGER);function Pr(t,e){return e[0]=t,e.subarray(0,1)}function Br(t,e){const i=new DataView(e.buffer,e.byteOffset,2);return i.setUint16(0,t),new Uint8Array(i.buffer,i.byteOffset,i.byteLength)}function _r(t,e){const i=new DataView(e.buffer,e.byteOffset,4);return i.setUint32(0,t),new Uint8Array(i.buffer,i.byteOffset,i.byteLength)}function Dr(t,e){const i=new DataView(e.buffer,e.byteOffset,8);return i.setBigUint64(0,t),new Uint8Array(i.buffer,i.byteOffset,i.byteLength)}function Nr(t,e){const i=new DataView(e.buffer,e.byteOffset,8);return i.setUint32(0,t/4294967296),i.setUint32(4,4294967295&t),e.set([192],0),new Uint8Array(i.buffer,i.byteOffset,i.byteLength)}function Wr(t,e){if(t<=xr)return Pr(t,e);if(t<=Mr)return Br(16384|t,e);if(t<=Ur)return _r(2147483648|t,e);if(t<=Rr)return"function"==typeof BigInt?Dr(BigInt(t)|BigInt(3221225472)<<BigInt(32),e):Nr(Number(t),e);throw new Error(`overflow, value larger than 53-bits: ${t}`)}function Or(t,e){if(t<xr)return Pr(Number(t),e);if(t<Mr)return Br(16384|Number(t),e);if(t<=Ur)return _r(2147483648|Number(t),e);if(t<=Lr)return"function"==typeof BigInt?Dr(BigInt(t)|BigInt(3221225472)<<BigInt(32),e):Nr(Number(t),e);throw new Error(`overflow, value larger than 62-bits: ${t}`)}var Fr=(t=>(t[t.SubscribeUpdate=2]="SubscribeUpdate",t[t.Subscribe=3]="Subscribe",t[t.SubscribeOk=4]="SubscribeOk",t[t.SubscribeError=5]="SubscribeError",t[t.Announce=6]="Announce",t[t.AnnounceOk=7]="AnnounceOk",t[t.AnnounceError=8]="AnnounceError",t[t.Unannounce=9]="Unannounce",t[t.Unsubscribe=10]="Unsubscribe",t[t.SubscribeDone=11]="SubscribeDone",t[t.AnnounceCancel=12]="AnnounceCancel",t[t.TrackStatusRequest=13]="TrackStatusRequest",t[t.TrackStatus=14]="TrackStatus",t[t.Goaway=16]="Goaway",t[t.ClientSetup=64]="ClientSetup",t[t.ServerSetup=65]="ServerSetup",t[t.Unknown=255]="Unknown",t))(Fr||{});function Vr(t){return B(this,null,(function*(){const e=yield t.readVarInt();if(e<1||e>32)throw new Error(`namespace must be between 1 and 32, got ${e}`);const i=[];for(let n=0;n<e;n++)i.push(yield t.readString());return i}))}function Gr(t,e){return B(this,null,(function*(){yield t.writeVarInt(e.length);for(const i of e)yield t.writeString(i)}))}const zr=J(2);function Hr(t){return B(this,null,(function*(){const e=yield t.readVarInt(),i=new Map;for(let n=0;n<e;n++){const e=yield t.readBigVarInt(),n=yield t.read(yield t.readVarInt());i.set(e,{type:e,payload:n})}return i}))}function jr(t,e){return B(this,null,(function*(){yield t.writeVarInt(e.size);for(const[i,n]of e)yield t.writeBigVarInt(i),yield t.writeVarInt(n.payload.length),yield t.write(n.payload)}))}const Xr={Role:J(0)},qr={Draft07:4278190087};function Qr(t){return B(this,null,(function*(){const e=yield t.readVarInt();return e===qr.Draft07?{type:"known",value:e}:{type:"unknown",value:e}}))}const $r={"latest-group":1,"latest-object":2,"absolute-start":3,"absolute-range":4};function Zr(t){return B(this,null,(function*(){const e=yield t.readUnsigned8();switch(e){case 0:return"inherit-publisher";case 1:return"ascending";case 2:return"descending";default:throw new Error(`Invalid location type ${e}`)}}))}function Kr(t,e){return B(this,null,(function*(){switch(e){case"inherit-publisher":yield t.writeUnsigned8(0);break;case"ascending":yield t.writeUnsigned8(1);break;case"descending":yield t.writeUnsigned8(2)}}))}var Jr,Yr,ta,ea,ia,na,sa,ra,aa,oa,la,ha,ca,da,ua,ma,pa,ga,fa,Aa,va,ba,wa,ya;class Sa{constructor(t){U(this,ta),U(this,Jr),U(this,Yr,new Uint8Array),R(this,Jr,t)}write(t){return B(this,null,(function*(){yield M(this,Jr).writeVarInt(t.type);const e=new Cr({close:()=>{},readyState:1,send:t=>{R(this,Yr,new Uint8Array(t))}});switch(t.type){case Fr.Subscribe:yield L(this,ta,na).call(this,e,t);break;case Fr.Announce:yield L(this,ta,ha).call(this,e,t);break;case Fr.SubscribeOk:yield L(this,ta,sa).call(this,e,t);break;case Fr.SubscribeUpdate:yield L(this,ta,aa).call(this,e,t);break;case Fr.SubscribeError:yield L(this,ta,ra).call(this,e,t);break;case Fr.SubscribeDone:yield L(this,ta,oa).call(this,e,t);break;case Fr.Unsubscribe:yield L(this,ta,la).call(this,e,t);break;case Fr.ClientSetup:yield L(this,ta,ea).call(this,e,t);break;case Fr.ServerSetup:yield L(this,ta,ia).call(this,e,t);break;case Fr.AnnounceOk:yield L(this,ta,ca).call(this,e,t);break;default:throw new Error(`Unknown message type: ${t.type}`)}yield e.flush(),yield M(this,Jr).writeVarInt(M(this,Yr).byteLength),yield M(this,Jr).write(M(this,Yr)),yield M(this,Jr).flush()}))}close(){return B(this,null,(function*(){return M(this,Jr).close()}))}}Jr=new WeakMap,Yr=new WeakMap,ta=new WeakSet,ea=function(t,e){return B(this,null,(function*(){yield function(t,e){return B(this,null,(function*(){yield t.writeVarInt(e.supportedVersions.length);for(const i of e.supportedVersions)yield t.writeVarInt(i.value);yield jr(t,e.parameters)}))}(t,e)}))},ia=function(t,e){return B(this,null,(function*(){yield function(t,e){return B(this,null,(function*(){yield t.writeVarInt(e.selectedVersion.value),yield jr(t,e.parameters)}))}(t,e)}))},na=function(t,e){return B(this,null,(function*(){yield function(t,e){return B(this,null,(function*(){yield t.writeBigVarInt(e.id),yield t.writeBigVarInt(e.trackAlias),yield Gr(t,e.namespace),yield t.writeString(e.name),yield t.writeUnsigned8(e.subscriberPriority),yield Kr(t,e.groupOrder),yield function(t,e){return B(this,null,(function*(){const i=$r[e.type];switch(yield t.writeVarInt(i),e.type){case"absolute-range":yield t.writeBigVarInt(e.start.group),yield t.writeBigVarInt(e.start.object),yield t.writeBigVarInt(e.end.group),yield t.writeBigVarInt(e.end.object);break;case"absolute-start":yield t.writeBigVarInt(e.start.group),yield t.writeBigVarInt(e.start.object);break;case"latest-object":case"latest-group":break;default:throw new Error(`Invalid location type ${i}`)}}))}(t,e.filterType),yield jr(t,e.params)}))}(t,e)}))},sa=function(t,e){return B(this,null,(function*(){yield function(t,e){return B(this,null,(function*(){yield t.writeBigVarInt(e.id),yield t.writeBigVarInt(e.expires),yield Kr(t,e.groupOrder),yield t.writeUnsigned8(e.largestInfo?1:0),e.largestInfo&&(yield t.writeBigVarInt(e.largestInfo.group),yield t.writeBigVarInt(e.largestInfo.object)),yield jr(t,e.params)}))}(t,e)}))},ra=function(t,e){return B(this,null,(function*(){yield function(t,e){return B(this,null,(function*(){yield t.writeBigVarInt(e.id),yield t.writeBigVarInt(e.errorCode),yield t.writeString(e.reason),yield t.writeBigVarInt(e.trackAlias)}))}(t,e)}))},aa=function(t,e){return B(this,null,(function*(){yield function(t,e){return B(this,null,(function*(){yield t.writeBigVarInt(e.id),yield t.writeBigVarInt(e.start.group),yield t.writeBigVarInt(e.start.object),yield t.writeBigVarInt(e.end.group),yield t.writeBigVarInt(e.end.object),yield t.writeUnsigned8(e.subscriberPriority),yield jr(t,e.params)}))}(t,e)}))},oa=function(t,e){return B(this,null,(function*(){yield function(t,e){return B(this,null,(function*(){yield t.writeBigVarInt(e.id),yield t.writeVarInt(e.errorCode),yield t.writeString(e.reason),yield t.writeUnsigned8(e.finalInfo?1:0),e.finalInfo&&(yield t.writeBigVarInt(e.finalInfo.group),yield t.writeBigVarInt(e.finalInfo.object))}))}(t,e)}))},la=function(t,e){return B(this,null,(function*(){yield function(t,e){return B(this,null,(function*(){yield t.writeBigVarInt(e.id)}))}(t,e)}))},ha=function(t,e){return B(this,null,(function*(){yield function(t,e){return B(this,null,(function*(){yield Gr(t,e.namespace),yield jr(t,e.params)}))}(t,e)}))},ca=function(t,e){return B(this,null,(function*(){yield function(t,e){return B(this,null,(function*(){yield Gr(t,e.namespace)}))}(t,e)}))};class ka{constructor(t,e){U(this,da),U(this,ua),U(this,ma),R(this,da,t),R(this,ua,new Sa(t)),R(this,ma,e)}write(t){return B(this,null,(function*(){yield M(this,da).write(M(this,ma)),yield M(this,ua).write(t)}))}close(){return M(this,da).close()}}da=new WeakMap,ua=new WeakMap,ma=new WeakMap;class Ea{constructor(t){U(this,pa),R(this,pa,t)}cancel(){return M(this,pa).close()}read(){return B(this,null,(function*(){const t=yield M(this,pa).readVarInt(),e=yield M(this,pa).readVarInt();switch(t){case Fr.ServerSetup:return function(t){return B(this,null,(function*(){const e=yield Qr(t);if("known"!==e.type)throw new Error("Expected known version");const i=yield Hr(t);if(!i.has(Xr.Role))throw new Error("Role parameter is required");return{type:Fr.ServerSetup,selectedVersion:e,parameters:i}}))}(M(this,pa));case Fr.ClientSetup:return function(t){return B(this,null,(function*(){const e=[],i=yield t.readVarInt();for(let n=0;n<i;n++)e.push(yield Qr(t));const n=yield Hr(t);if(!n.has(Xr.Role))throw new Error("Role parameter is required");return{type:Fr.ClientSetup,supportedVersions:e,parameters:n}}))}(M(this,pa));case Fr.Subscribe:return function(t){return B(this,null,(function*(){const e=yield t.readBigVarInt(),i=yield t.readBigVarInt(),n=yield Vr(t),s=yield t.readString(),r=yield t.readUnsigned8(),a=yield Zr(t),o=yield function(t){return B(this,null,(function*(){const e=yield t.readVarInt();switch(e){case 1:return{type:"latest-group"};case 2:return{type:"latest-object"};case 3:return{type:"absolute-start",start:{group:yield t.readBigVarInt(),object:yield t.readBigVarInt()}};case 4:return{type:"absolute-range",start:{group:yield t.readBigVarInt(),object:yield t.readBigVarInt()},end:{group:yield t.readBigVarInt(),object:yield t.readBigVarInt()}};default:throw new Error(`Invalid location type ${e}`)}}))}(t),l=yield Hr(t);if("absolute-range"===o.type){const t=o.start.group>o.end.group,e=o.start.group===o.end.group&&o.start.object>o.end.object;if(t||e)throw new Error("Invalid filter range")}return{type:Fr.Subscribe,id:e,trackAlias:i,namespace:n,name:s,subscriberPriority:r,groupOrder:a,filterType:o,params:l}}))}(M(this,pa));case Fr.SubscribeOk:return function(t){return B(this,null,(function*(){const e=yield t.readBigVarInt(),i=yield t.readBigVarInt(),n=yield Zr(t),s=1==(yield t.readUnsigned8());let r;if("inherit-publisher"==n)throw new Error("SusbcribeOk cannot have inherit publisher group order");s&&(r={group:yield t.readBigVarInt(),object:yield t.readBigVarInt()});const a=yield Hr(t);return{type:Fr.SubscribeOk,id:e,groupOrder:n,expires:i,largestInfo:r,params:a}}))}(M(this,pa));case Fr.SubscribeDone:return function(t){return B(this,null,(function*(){const e=yield t.readBigVarInt(),i=yield t.readVarInt(),n=yield t.readString();let s;return 1==(yield t.readUnsigned8())&&(s={group:yield t.readBigVarInt(),object:yield t.readBigVarInt()}),{type:Fr.SubscribeDone,id:e,errorCode:i,reason:n,finalInfo:s}}))}(M(this,pa));case Fr.SubscribeError:return function(t){return B(this,null,(function*(){return{type:Fr.SubscribeError,id:yield t.readBigVarInt(),errorCode:yield t.readBigVarInt(),reason:yield t.readString(),trackAlias:yield t.readBigVarInt()}}))}(M(this,pa));case Fr.SubscribeUpdate:return function(t){return B(this,null,(function*(){const e=yield t.readBigVarInt(),i=yield t.readBigVarInt(),n=yield t.readBigVarInt(),s=yield t.readBigVarInt(),r=yield t.readBigVarInt(),a=yield t.readUnsigned8(),o=yield Hr(t);if(i>s||i===s&&n>r)throw new Error("Invalid filter range");return{type:Fr.SubscribeUpdate,id:e,start:{group:i,object:n},end:{group:s,object:r},subscriberPriority:a,params:o}}))}(M(this,pa));case Fr.Unsubscribe:return function(t){return B(this,null,(function*(){return{type:Fr.Unsubscribe,id:yield t.readBigVarInt()}}))}(M(this,pa));case Fr.Announce:return function(t){return B(this,null,(function*(){return{type:Fr.Announce,namespace:yield Vr(t),params:yield Hr(t)}}))}(M(this,pa));case Fr.AnnounceOk:return function(t){return B(this,null,(function*(){return{type:Fr.AnnounceOk,namespace:yield Vr(t)}}))}(M(this,pa));case Fr.AnnounceError:return function(t){return B(this,null,(function*(){return{type:Fr.AnnounceError,namespace:yield Vr(t),errorCode:yield t.readBigVarInt(),reason:yield t.readString()}}))}(M(this,pa))}return function(t,e,i){return B(this,null,(function*(){return{type:Fr.Unknown,messageType:e,payload:yield t.read(i)}}))}(M(this,pa),J(t),e)}))}}pa=new WeakMap;const Ta=class t{constructor(t,e){U(this,ba),U(this,ga),U(this,fa),U(this,Aa,new z),U(this,va,new z),R(this,ga,t),R(this,fa,e),M(this,Aa).resolve()}write(t){return B(this,null,(function*(){const e=yield L(this,ba,wa).call(this);try{yield M(this,ga).write(t)}finally{e.resolve()}}))}markPostHandshake(){M(this,va).resolve()}postHandshake(){return M(this,va).promise}read(){return B(this,null,(function*(){return M(this,fa).read()}))}cancel(){return M(this,fa).cancel()}static wrapWebsocket(e){const i=new ReadableStream(new vr(e,M(t,ya))),n=new Ea(new wr(new Uint8Array([]),i)),s=new ka(new Cr(e),new Uint8Array([0]));return new t(s,n)}static wrapWebTransport(e){const i=e.writable,n=e.readable;return new t(new Sa(new yr(i)),new Ea(new wr(new Uint8Array,n)))}};ga=new WeakMap,fa=new WeakMap,Aa=new WeakMap,va=new WeakMap,ba=new WeakSet,wa=function(){const t=new z,e=M(this,Aa).promise.then((()=>t));return R(this,Aa,t),e},ya=new WeakMap,U(Ta,ya,0);let Ia=Ta;function Ca(t,e){return B(this,null,(function*(){yield t.write({type:Fr.ClientSetup,supportedVersions:[{type:"known",value:qr.Draft07}],parameters:new Map([[Xr.Role,{type:Xr.Role,payload:new Uint8Array([e])}]])});const i=yield t.read();if(t.markPostHandshake(),i.type!==Fr.ServerSetup)throw new Error("Expected server setup message");if("known"!==i.selectedVersion.type)throw new Error("Expected known version")}))}var xa,Ma,Ua,Ra,La,Pa,Ba;class _a{constructor(t){I(this,"announce"),U(this,xa,new z),this.announce=t}onOk(t){M(this,xa).resolve(t)}onError(t){const e=new Error(t.reason);return M(this,xa).reject(e),e}ok(){return M(this,xa).promise}}xa=new WeakMap;class Da{constructor(t){I(this,"state"),this.state=t}}const Na=class t{constructor(t){switch(I(this,"subscribe"),U(this,Ma,new z),U(this,Ua,new z),U(this,Ra,new z),U(this,La,Date.now()),U(this,Pa,new z),U(this,Ba),this.subscribe=t,t.filterType.type){case"absolute-start":R(this,Ba,{startGroup:t.filterType.start.group});break;case"absolute-range":R(this,Ba,{startGroup:t.filterType.start.group,endGroup:t.filterType.end.group})}}onUpdate(t){R(this,Ba,{startGroup:t.start.group}),t.end.group>J(0)&&(M(this,Ba).endGroup=t.end.group-J(1))}onError(t){const e=new Error(t.reason);return M(this,Ma).reject(e),M(this,Ua).reject(e),e}onDone(t){t.finalInfo&&(M(this,Ba)||R(this,Ba,{startGroup:J(0)}),M(this,Ba).endGroup=t.finalInfo.group),M(this,Ua).resolve(t)}onUnsubscribe(t){M(this,Ra).resolve(t)}onOk(e){const i=Math.max(0,Date.now()-M(this,La)),n=Number(e.expires);if(n>0){const e=Math.max(t.minGraceTime,Math.min(n/10,t.maxGraceTime));Promise.race([Yt(n-e-i),this.done().catch(G)]).then((()=>M(this,Pa).resolve(this.expiryState()))).catch(G)}M(this,Ma).resolve(e)}done(){return M(this,Ua).promise}ok(){return M(this,Ma).promise}range(){return M(this,Ba)}close(){M(this,Pa).promise.catch(G),M(this,Pa).reject(new Error("Subscription closed"))}expiryState(){return M(this,Ua).resolved&&6!==M(this,Ua).resolved.errorCode?"done":M(this,Ra).pending?"active":"unsubscribed"}unsubscribed(){return M(this,Ra).promise}isUnsubscribed(){return M(this,Ra).resolved}expiryNotification(){return M(this,Pa).promise}};Ma=new WeakMap,Ua=new WeakMap,Ra=new WeakMap,La=new WeakMap,Pa=new WeakMap,Ba=new WeakMap,I(Na,"maxGraceTime",15e3),I(Na,"minGraceTime",3e3);let Wa=Na;var Oa,Fa,Va,Ga,za,Ha,ja,Xa,qa,Qa,$a,Za,Ka,Ja,Ya,to,eo,io,no,so,ro,ao,oo,lo,ho,co,uo,mo,po,go,fo,Ao,vo,bo,wo,yo,So,ko,Eo,To,Io,Co,xo,Mo,Uo,Ro,Lo,Po,Bo,_o,Do,No,Wo,Oo,Fo,Vo,Go,zo,Ho,jo,Xo,qo,Qo,$o,Zo,Ko,Jo,Yo,tl,el,il,nl,sl,rl,al,ol,ll,hl,cl,dl,ul,ml,pl,gl,fl,Al,vl,bl,wl,yl,Sl,kl,El,Tl,Il,Cl,xl,Ml,Ul,Rl,Ll,Pl;class Bl{constructor(t){U(this,Oa),U(this,Fa,!1),R(this,Oa,t)}write(t){return B(this,null,(function*(){M(this,Fa)||(yield M(this,Oa).writeVarInt(As.StreamHeaderGroup),yield M(this,Oa).writeBigVarInt(t.subscribeId),yield M(this,Oa).writeBigVarInt(t.trackAlias),yield M(this,Oa).writeBigVarInt(t.groupId),yield M(this,Oa).writeBigVarInt(t.subGroupId),yield M(this,Oa).writeUnsigned8(t.subscriberPriority),R(this,Fa,!0)),yield M(this,Oa).writeBigVarInt(t.objectId),yield M(this,Oa).writeVarInt(t.payload.length),t.payload.length>0?yield M(this,Oa).write(t.payload):yield M(this,Oa).writeVarInt(t.objectStatus),yield M(this,Oa).flush()}))}close(){return B(this,null,(function*(){yield M(this,Oa).close()}))}}Oa=new WeakMap,Fa=new WeakMap;class _l{constructor(t,e,i,n){U(this,qa),U(this,Va),U(this,Ga),U(this,za),U(this,Ha),U(this,ja),U(this,Xa),R(this,Va,e),R(this,Ga,t),R(this,za,i),R(this,Ha,n),R(this,Xa,Rt.get().createContext(`SubscriptionWriter:${t.subscribe.name}`))}finalInfo(){return M(this,ja)}run(){return B(this,null,(function*(){yield Promise.race([L(this,qa,Qa).call(this).catch((t=>M(this,Xa).error("error writing subscription",t))),M(this,Ga).unsubscribed(),M(this,Ga).done(),M(this,Ga).expiryNotification().catch(G)])}))}done(t,e){return B(this,null,(function*(){if(M(this,Ga).isUnsubscribed())return;const i={type:Fr.SubscribeDone,id:M(this,Ga).subscribe.id,errorCode:t,reason:e,finalInfo:M(this,ja)};M(this,Ga).onDone(i),yield M(this,Ha).push(i)}))}[Pt()](){return this.done(3,"Track ended")}[Symbol.asyncDispose](){return this.done(3,"Track ended")}}Va=new WeakMap,Ga=new WeakMap,za=new WeakMap,Ha=new WeakMap,ja=new WeakMap,Xa=new WeakMap,qa=new WeakSet,Qa=function(){return B(this,null,(function*(){try{for(var t,e,i,n=W(M(this,Va));t=!(e=yield n.next()).done;t=!1){const t=e.value;var s=[];try{const e=M(this,Ga).range();if(e&&(e.startGroup>t.id||e.endGroup&&e.endGroup<t.id))break;const i=yield M(this,za).openSendStream(),n=new Bl(i),r=O(s,new Dl(n,t.consume(),M(this,Ga)),!0);yield r.run(),R(this,ja,r.finalGroup())}catch(t){var r=t,a=!0}finally{var o=F(s,r,a);o&&(yield o)}}}catch(e){i=[e]}finally{try{t&&(e=n.return)&&(yield e.call(n))}finally{if(i)throw i[0]}}}))};class Dl{constructor(t,e,i){U(this,$a),U(this,Za),U(this,Ka),U(this,Ja),U(this,Ya),R(this,$a,t),R(this,Za,e),R(this,Ka,i),R(this,Ya,Rt.get().createContext(`GroupSubscriptionWriter:${i.subscribe.name}`))}finalGroup(){return M(this,Ja)}run(){return B(this,null,(function*(){M(this,Ya).debug("write group");try{for(var t,e,i,n=W(M(this,Za));t=!(e=yield n.next()).done;t=!1){const t=e.value;yield M(this,$a).write({subscribeId:M(this,Ka).subscribe.id,trackAlias:M(this,Ka).subscribe.trackAlias,subGroupId:J(0),subscriberPriority:0,groupId:t.groupId,objectId:t.objectId,objectStatus:t.objectStatus,payload:t.payload}),R(this,Ja,{group:t.groupId,object:t.objectId})}}catch(e){i=[e]}finally{try{t&&(e=n.return)&&(yield e.call(n))}finally{if(i)throw i[0]}}M(this,Ya).debug("write group done")}))}[Pt()](){return M(this,$a).close().catch(G)}[Symbol.asyncDispose](){return M(this,$a).close().catch(G)}}$a=new WeakMap,Za=new WeakMap,Ka=new WeakMap,Ja=new WeakMap,Ya=new WeakMap;class Nl{constructor(t,e,i){U(this,io),I(this,"state"),U(this,to),U(this,eo),this.state=t,R(this,to,e),R(this,eo,i)}ok(t){return B(this,null,(function*(){var e,i,n;const s=null==(e=this.state.range())?void 0:e.startGroup,r=t.latest(),a=null==r?void 0:r.id,o=null!=(n=null==(i=null==r?void 0:r.latest())?void 0:i.objectId)?n:J(0),l=t.consume(null!=s?s:a),h={type:Fr.SubscribeOk,id:this.state.subscribe.id,expires:J(0),groupOrder:"ascending",params:new Map,largestInfo:a?{group:a,object:o}:void 0};return yield M(this,eo).push(h),new _l(this.state,l,M(this,to),M(this,eo))}))}invalidRange(){return L(this,io,no).call(this,J(1),"Invalid range")}retryTrackAlias(){return L(this,io,no).call(this,J(2),"Retry track alias")}trackDoesNotExist(){return L(this,io,no).call(this,J(3),"Track does not exist")}unauthorized(){return L(this,io,no).call(this,J(4),"Unauthorized")}timeout(){return L(this,io,no).call(this,J(5),"Timeout")}[Pt()](){return this.trackDoesNotExist()}[Symbol.asyncDispose](){return this.trackDoesNotExist()}}to=new WeakMap,eo=new WeakMap,io=new WeakSet,no=function(t,e){const i={type:Fr.SubscribeError,id:this.state.subscribe.id,errorCode:t,reason:e,trackAlias:this.state.subscribe.trackAlias};return M(this,eo).push(i)},so=[Lt({context:"Session",enter:"info",error:"error"})];class Wl{constructor(t,e,i){E(mo,5,this),U(this,ro),U(this,ao),U(this,oo),U(this,lo,Rt.get().createContext("Publisher")),U(this,ho,new zt(new Map)),U(this,co,new zt(new Map)),U(this,uo,new Z(10)),R(this,ro,t),R(this,ao,e),R(this,oo,i)}announce(t){return B(this,null,(function*(){if(M(this,ho).current().has(t.join("/")))throw new Error("Duplicate announcement");const e=new Map,i=M(this,ro).authToken();i&&e.set(zr,{type:zr,payload:(new TextEncoder).encode(i)});const n={type:Fr.Announce,namespace:t,params:e},s=function(t){const e=new _a(t);return new Da(e)}(n);if(M(this,ho).update((t=>t.set(n.namespace.join("/"),s))),yield M(this,oo).push(n),!(yield Promise.race([s.state.ok(),M(this,ro).closed()])))throw new Error("Session closed")}))}close(){M(this,co).current().forEach((t=>t.close())),M(this,co).close(),M(this,ho).close(),M(this,uo).close()}incomingSubscriptions(){return M(this,uo)}onMessage(t){return B(this,null,(function*(){switch(t.type){case Fr.Subscribe:{const e=new Wa(t);if(M(this,co).update((i=>(i.set(t.id,e),i))),M(this,uo).isFull()){const t=yield M(this,uo).pop();yield null==t?void 0:t.timeout()}yield M(this,uo).push(new Nl(e,M(this,ao),M(this,oo)))}break;case Fr.SubscribeUpdate:{const e=M(this,co).current().get(t.id);e||M(this,lo).debug("No subscription found",t),null==e||e.onUpdate(t)}break;case Fr.Unsubscribe:{const e=M(this,co).current().get(t.id);e||M(this,lo).debug("No subscription found",t),null==e||e.onUnsubscribe(t)}break;case Fr.AnnounceOk:{const e=M(this,ho).current().get(t.namespace.join("/"));e||M(this,lo).debug("No announcement found",t),null==e||e.state.onOk(t)}break;case Fr.AnnounceError:{const e=M(this,ho).current().get(t.namespace.join("/"));e||M(this,lo).debug("No announcement found",t),null==e||e.state.onError(t)}}}))}}mo=b(null),ro=new WeakMap,ao=new WeakMap,oo=new WeakMap,lo=new WeakMap,ho=new WeakMap,co=new WeakMap,uo=new WeakMap,T(mo,1,"announce",so,Wl),k(mo,Wl);class Ol{constructor(t,e){I(this,"state"),U(this,po),this.state=t,R(this,po,e)}onDone(t){this.state.onDone(t)}onData(t){return M(this,po).push(t)}onError(t){const e=this.state.onError(t);M(this,po).abort(e)}close(){this.state.close(),M(this,po).close()}}po=new WeakMap;class Fl{constructor(t,e,i){E(wo,5,this),U(this,yo),U(this,fo),U(this,Ao),U(this,vo),U(this,bo,new z),R(this,fo,t),R(this,Ao,e),R(this,vo,i)}get id(){return M(this,Ao).subscribe.id}get trackAlias(){return M(this,Ao).subscribe.trackAlias}get name(){return M(this,Ao).subscribe.name}range(){return M(this,Ao).range()}expiryNotification(){return M(this,Ao).expiryNotification()}update(t,e){return B(this,null,(function*(){const i={type:Fr.SubscribeUpdate,id:M(this,Ao).subscribe.id,start:{group:t,object:J(0)},end:{group:e+J(1),object:J(0)},params:new Map,subscriberPriority:0};M(this,Ao).onUpdate(i),yield M(this,fo).push(i)}))}unsubscribe(){return B(this,null,(function*(){const t={type:Fr.Unsubscribe,id:M(this,Ao).subscribe.id};M(this,Ao).onUnsubscribe(t),yield M(this,fo).push(t)}))}close(){var t,e;return M(this,bo).resolve(),null==(e=(t=M(this,vo)).return)?void 0:e.call(t)}closed(){return M(this,bo).promise}done(){return M(this,Ao).done()}expiryState(){return M(this,Ao).expiryState()}unsubscribed(){return M(this,Ao).isUnsubscribed()}return(){return B(this,null,(function*(){return M(this,bo).resolve(),yield this.unsubscribe(),{done:!0,value:void 0}}))}groups(){return D(this,null,(function*(){var t,e;try{for(var i,n,s,r=W(M(this,vo));i=!(n=yield new _(r.next())).done;i=!1){var a=n.value,o=[];try{const i=O(o,a,!0);try{for(var l,h,c,d=W(i.groups());l=!(h=yield new _(d.next())).done;l=!1){const i=h.value,n=null==(t=M(this,Ao).range())?void 0:t.startGroup,s=null==(e=M(this,Ao).range())?void 0:e.endGroup;if(n&&i.groupId()<n)return{done:!0,value:void 0};if(s&&i.groupId()>s)return{done:!0,value:void 0};yield i}}catch(h){c=[h]}finally{try{l&&(h=d.return)&&(yield new _(h.call(d)))}finally{if(c)throw c[0]}}}catch(t){var u=t,m=!0}finally{var p=F(o,u,m);p&&(yield new _(p))}}}catch(n){s=[n]}finally{try{i&&(n=r.return)&&(yield new _(n.call(r)))}finally{if(s)throw s[0]}}}))}[Symbol.asyncIterator](){return this.groups()}objects(){return D(this,null,(function*(){try{for(var t,e,i,n=W(this.groups());t=!(e=yield new _(n.next())).done;t=!1){const t=e.value;try{for(var s,r,a,o=W(t);s=!(r=yield new _(o.next())).done;s=!1){const t=r.value;yield t}}catch(r){a=[r]}finally{try{s&&(r=o.return)&&(yield new _(r.call(o)))}finally{if(a)throw a[0]}}}}catch(e){i=[e]}finally{try{t&&(e=n.return)&&(yield new _(e.call(n)))}finally{if(i)throw i[0]}}}))}[(go=[Lt({context:"SubscriptionConsumer",enter:"info"})],Pt())](){return L(this,yo,So).call(this)}[Symbol.asyncDispose](){return L(this,yo,So).call(this)}}wo=b(null),fo=new WeakMap,Ao=new WeakMap,vo=new WeakMap,bo=new WeakMap,yo=new WeakSet,So=T(wo,17,"#dispose",go,yo,So=function(){return B(this,null,(function*(){return yield this.close(),this.unsubscribe()}))}),k(wo,Fl),Io=[Lt({context:"Session",return:"debug"})],To=[Lt({context:"Session",enter:"info",error:"error"})],Eo=[Lt({context:"Session",enter:"debug"})],ko=[Lt({context:"Session",enter:"debug"})];class Vl{constructor(t,e){E(Ro,5,this),U(this,Lo),U(this,Co),I(this,"nextSubscribeId",J(0)),U(this,xo,new zt(new Map)),U(this,Mo),U(this,Uo,Rt.get().createContext("Subscriber")),R(this,Co,t),R(this,Mo,e),L(this,Lo,Po).call(this).catch(G)}subscribe(t,e){return B(this,null,(function*(){const i=this.nextSubscribeId++,n=new Map,s=M(this,Co).authToken();s&&n.set(zr,{type:zr,payload:(new TextEncoder).encode(s)});const r={type:Fr.Subscribe,namespace:t,name:e.name,id:i,trackAlias:i,groupOrder:e.groupOrder,subscriberPriority:e.priority,filterType:e.filterType,params:n},[a,o]=function(t,e){const i=new Wa(e),[n,s]=j(100);return[new Ol(i,n),new Fl(t,i,s)]}(M(this,Mo),r);if(M(this,xo).update((t=>t.set(i,a))),yield M(this,Mo).push(r),!(yield Promise.race([a.state.ok(),M(this,Co).closed()])))throw new Error("Session closed");return o.closed().then((()=>Promise.race([Yt(2e3),this.closed()]))).then((()=>L(this,Lo,Bo).call(this,o.id))).catch((()=>L(this,Lo,Bo).call(this,o.id))),o}))}closed(){return M(this,Co).closed()}transportType(){return M(this,Co).transportType()}url(){return M(this,Co).url()}onMessage(t){return B(this,null,(function*(){switch(t.type){case Fr.Announce:yield M(this,Mo).push({type:Fr.AnnounceOk,namespace:t.namespace});break;case Fr.SubscribeOk:{const e=M(this,xo).current().get(t.id);e&&e.state.onOk(t)}break;case Fr.SubscribeError:{const e=M(this,xo).current().get(t.id);e||M(this,Uo).debug("No subscription found",t),null==e||e.onError(t),L(this,Lo,Bo).call(this,t.id)}break;case Fr.SubscribeDone:{const e=M(this,xo).current().get(t.id);e||M(this,Uo).debug("No subscription found",t),null==e||e.onDone(t)}}}))}onObjectReader(t){return B(this,null,(function*(){const e=M(this,xo).current().get(t.subscribeId());e?yield e.onData(t):M(this,Uo).warn("No subscription found",t.subscribeId())}))}close(){M(this,xo).current().forEach((t=>t.close())),M(this,xo).close()}}Ro=b(null),Co=new WeakMap,xo=new WeakMap,Mo=new WeakMap,Uo=new WeakMap,Lo=new WeakSet,Po=function(){return B(this,null,(function*(){try{for(var t,e,i,n=W(M(this,xo));t=!(e=yield n.next()).done;t=!1){const t=[...e.value.values()].map((t=>t.state.subscribe));M(this,Uo).debug("current subscriptions",t)}}catch(e){i=[e]}finally{try{t&&(e=n.return)&&(yield e.call(n))}finally{if(i)throw i[0]}}}))},Bo=function(t){M(this,xo).isClosed()||M(this,xo).update((e=>(e.delete(t),e)))},Po=T(Ro,17,"#observeChanges",Io,Lo,Po),T(Ro,1,"subscribe",To,Vl),T(Ro,1,"close",Eo,Vl),Bo=T(Ro,17,"#deleteSubscription",ko,Lo,Bo),k(Ro,Vl);class Gl{constructor(t,e){E(qo,5,this),U(this,Ho),U(this,Oo),U(this,Fo),U(this,Vo),U(this,Go,Rt.get().createContext("Session")),I(this,"subscriber"),I(this,"publisher"),U(this,zo);const[i,n]=j(100);R(this,Oo,t),R(this,Vo,n),this.subscriber=new Vl(this,i),this.publisher=new Wl(this,t,i),R(this,Fo,L(this,Ho,Xo).call(this)),R(this,zo,new zt(e)),this.closed().then((()=>this.close())).catch(G)}updateAuthToken(t){M(this,zo).update(t)}authToken(){return M(this,zo).current()}transportType(){return M(this,Oo).transportType()}url(){return M(this,Oo).url()}closed(){return M(this,Fo)}close(){try{this.subscriber.close(),this.publisher.close(),M(this,Vo).cancel("closing"),M(this,Oo).close()}catch(t){M(this,Go).warn("Error closing session",t)}}[(Wo=[Lt({context:"Session",return:"info",error:"error"})],No=[Lt({context:"Session",return:"info",error:"error"})],Do=[Lt({context:"Session",return:"info",error:"error"})],_o=[Lt({context:"Session",enter:"debug"})],Bt())](){L(this,Ho,Ko).call(this)}[Symbol.dispose](){L(this,Ho,Ko).call(this)}}qo=b(null),Oo=new WeakMap,Fo=new WeakMap,Vo=new WeakMap,Go=new WeakMap,zo=new WeakMap,Ho=new WeakSet,jo=function(t){return B(this,null,(function*(){var e,i;M(this,Go).debug("received message",t),yield null==(e=this.subscriber)?void 0:e.onMessage(t),yield null==(i=this.publisher)?void 0:i.onMessage(t),t.type,Fr.Goaway}))},Xo=function(){return B(this,null,(function*(){return(yield Promise.all([L(this,Ho,$o).call(this),L(this,Ho,Zo).call(this),L(this,Ho,Qo).call(this)])).find((t=>t instanceof Error))}))},Qo=function(){return B(this,null,(function*(){try{try{for(var t,e,i,n=W(M(this,Vo));t=!(e=yield n.next()).done;t=!1){const t=e.value;M(this,Go).debug("sending message",t),yield M(this,Oo).writeMessage(t)}}catch(e){i=[e]}finally{try{t&&(e=n.return)&&(yield e.call(n))}finally{if(i)throw i[0]}}}catch(t){return t}}))},$o=function(){return B(this,null,(function*(){try{for(yield M(this,Oo).afterHandshake();;){const t=yield M(this,Oo).readMessage().catch((()=>{}));if(!t)break;yield L(this,Ho,jo).call(this,t)}}catch(t){return t}finally{M(this,Vo).cancel("closing")}}))},Zo=function(){return B(this,null,(function*(){var t;try{for(;;){const e=yield M(this,Oo).objectStream();if(!e)break;yield null==(t=this.subscriber)?void 0:t.onObjectReader(e)}}catch(t){return t}}))},Ko=function(){this.close()},Qo=T(qo,17,"#runOutgoingMessages",Wo,Ho,Qo),$o=T(qo,17,"#runControl",No,Ho,$o),Zo=T(qo,17,"#runObjects",Do,Ho,Zo),Ko=T(qo,17,"#dispose",_o,Ho,Ko),k(qo,Gl);class zl{constructor(t,e,i){U(this,nl),U(this,Jo),U(this,Yo),U(this,tl,!0),U(this,el,!1),U(this,il),R(this,Jo,t),R(this,Yo,e),R(this,il,i)}writeUnsigned8(t){return B(this,null,(function*(){return L(this,nl,sl).call(this),yield L(this,nl,rl).call(this),M(this,Jo).writeUnsigned8(t)}))}writeVarInt(t){return B(this,null,(function*(){return L(this,nl,sl).call(this),yield L(this,nl,rl).call(this),M(this,Jo).writeVarInt(t)}))}writeBigVarInt(t){return B(this,null,(function*(){return L(this,nl,sl).call(this),yield L(this,nl,rl).call(this),M(this,Jo).writeBigVarInt(t)}))}write(t){return B(this,null,(function*(){return L(this,nl,sl).call(this),yield L(this,nl,rl).call(this),M(this,Jo).write(t)}))}writeString(t){return B(this,null,(function*(){return L(this,nl,sl).call(this),yield L(this,nl,rl).call(this),M(this,Jo).writeString(t)}))}flush(){return B(this,null,(function*(){L(this,nl,sl).call(this),R(this,tl,!0),yield M(this,Jo).flush()}))}close(){return B(this,null,(function*(){M(this,el)||(R(this,tl,!0),yield L(this,nl,rl).call(this,!1),yield M(this,Jo).flush(),R(this,el,!0),M(this,il).call(this))}))}}Jo=new WeakMap,Yo=new WeakMap,tl=new WeakMap,el=new WeakMap,il=new WeakMap,nl=new WeakSet,sl=function(){if(M(this,el))throw new Error("Stream is closed")},rl=function(t=!0){if(M(this,tl))return R(this,tl,!1),M(this,Jo).writeUnsigned8(M(this,Yo)|(t?128:0))};class Hl{constructor(t,e){U(this,ml),U(this,al),U(this,ol),U(this,ll),U(this,hl),U(this,cl,new Map),U(this,dl,Rt.get().createContext("WebSocketConnection")),U(this,ul,new Set(new Array(128).fill(0).map(((t,e)=>e+1)))),R(this,al,t),R(this,ol,e),R(this,ll,new ReadableStream(new br(t))),M(this,al).addEventListener("close",(()=>{M(this,ol).markPostHandshake(),M(this,cl).forEach((t=>t.close()))}))}openSendStream(){const t=M(this,ul).values().next().value;if(!t)throw new Error("No stream IDs available");return M(this,ul).delete(t),Promise.resolve(new zl(new Cr(M(this,al)),t,(()=>L(this,ml,pl).call(this,t))))}transportType(){return"websocket"}url(){return M(this,al).url}afterHandshake(){return M(this,ol).postHandshake()}objectStream(){return B(this,null,(function*(){for(var t;;){R(this,hl,M(this,ll).getReader());try{const{value:t,done:e}=yield M(this,hl).read();if(e)return;const[i,n,s]=t;if(M(this,cl).has(J(n))){const t=M(this,cl).get(J(n));if(!t)throw new Error("Stream not found");s.length>0&&(yield t.push(s)),i||(M(this,dl).debug("Closing stream",{streamId:n}),t.close(),M(this,cl).delete(J(n)))}else{M(this,dl).debug("Creating new stream",{streamId:n});const[t,e]=j(1e3),r=new ReadableStream({pull(t){return B(this,null,(function*(){const i=yield e.pop();i?t.enqueue(i):t.close()}))}});if(M(this,cl).set(J(n),t),i||(M(this,dl).debug("Closing new stream",{streamId:n}),yield r.cancel(),M(this,cl).delete(J(n))),s.length>0)return yield Ar(new wr(s,r),n)}}finally{null==(t=M(this,hl))||t.releaseLock()}}}))}close(){var t;return M(this,ol).cancel().catch(G),M(this,ll).cancel("closing").catch(G),null==(t=M(this,hl))||t.cancel("closing").catch(G),M(this,al).close()}closed(){return Promise.resolve()}writeMessage(t){return B(this,null,(function*(){yield M(this,ol).write(t)}))}readMessage(){return B(this,null,(function*(){return M(this,ol).read()}))}}al=new WeakMap,ol=new WeakMap,ll=new WeakMap,hl=new WeakMap,cl=new WeakMap,dl=new WeakMap,ul=new WeakMap,ml=new WeakSet,pl=function(t){M(this,ul).add(t)};class jl{constructor(t,e,i){U(this,yl),U(this,gl),U(this,fl),U(this,Al,new Z(100)),U(this,vl),U(this,bl,0),U(this,wl,Rt.get().createContext("WebTransportConnection")),R(this,vl,i),R(this,gl,t),R(this,fl,e),L(this,yl,Sl).call(this).catch((t=>{M(this,wl).debug("Incoming streams handling ended with error",t),M(this,fl).markPostHandshake(),M(this,Al).close()}))}openSendStream(){return B(this,null,(function*(){const t=yield M(this,gl).createUnidirectionalStream();return new yr(t)}))}transportType(){return"webtransport"}url(){return M(this,vl)}afterHandshake(){return M(this,fl).postHandshake()}closed(){return B(this,null,(function*(){yield M(this,gl).closed}))}close(){M(this,gl).close()}writeMessage(t){return B(this,null,(function*(){yield M(this,fl).write(t)}))}readMessage(){return B(this,null,(function*(){return M(this,fl).read()}))}objectStream(){return B(this,null,(function*(){return M(this,Al).pop()}))}}function Xl(t){return B(this,null,(function*(){const e=new WebSocket(t.wsUrl||t.url);e.binaryType="arraybuffer",yield new Promise(((t,i)=>{e.addEventListener("error",(()=>i(new Error("WebSocket error"))),{once:!0}),e.addEventListener("open",t,{once:!0})}));const i=Ia.wrapWebsocket(e);Ca(i,t.role).catch((()=>{e.close()}));const n=new Hl(e,i);return new Gl(n,t.authToken)}))}gl=new WeakMap,fl=new WeakMap,Al=new WeakMap,vl=new WeakMap,bl=new WeakMap,wl=new WeakMap,yl=new WeakSet,Sl=function(){return B(this,null,(function*(){const t=M(this,gl).incomingUnidirectionalStreams.getReader();for(;;){const{value:e,done:i}=yield t.read();if(i)return void M(this,Al).close();const n=new wr(new Uint8Array,e);yield M(this,Al).push(Ar(n,M(this,bl))),P(this,bl)._++}}))};class ql{constructor(){U(this,kl,{name:"",priority:0,groupOrder:"descending",filterType:{type:"latest-group"}})}name(t){return M(this,kl).name=t,this}priority(t){return M(this,kl).priority=t,this}groupOrder(t){return M(this,kl).groupOrder=t,this}startGroup(t){return M(this,kl).filterType={type:"absolute-start",start:{group:t,object:J(0)}},this}range(t,e){return M(this,kl).filterType={type:"absolute-range",start:{group:t,object:J(0)},end:{group:e,object:J(0)}},this}build(){return M(this,kl)}}kl=new WeakMap;class Ql{constructor(t,e){U(this,El),U(this,Tl),R(this,El,t),R(this,Tl,e)}subscribe(t){return M(this,El).subscribe(this.namespace(),t)}closed(){return M(this,El).closed()}namespace(){return M(this,Tl).namespace}}function $l(t,e){return["com.vindral.moq",t]}function Zl(t){const e=t[1];if(!e)throw new Error("namespace must contain a channel ID");return e}El=new WeakMap,Tl=new WeakMap;const Kl=class t{constructor(t,e){U(this,Ll),U(this,Il),U(this,Cl),U(this,xl,new H(100)),U(this,Ml),U(this,Ul),U(this,Rl,(t=>B(this,null,(function*(){if(!t)return M(this,Il).close();if(M(this,Ml))return;const e=M(this,xl).items().reduce(((t,e)=>t<e?t:e),t);R(this,Ml,L(this,Ll,Pl).call(this,e,t)),0===M(this,Ml).size&&(yield M(this,Il).close())})))),R(this,Il,t),R(this,Cl,e),t.done().then((t=>B(this,null,(function*(){var e;return M(this,Rl).call(this,null==(e=t.finalInfo)?void 0:e.group)})))).catch(G),R(this,Ul,t.groups())}static subscribe(e,i){return B(this,null,(function*(){const n=yield e.subscribe(i);return new t(n,void 0)}))}subscribeId(){return M(this,Il).id}name(){return M(this,Il).name}largestGroupId(){return M(this,Cl)}needsRenewal(){return"active"===M(this,Il).expiryState()&&void 0===M(this,Ml)}endOfTrack(t){const e=M(this,xl).items().reduce(((t,e)=>t<e?t:e),t);return this.update(e,t)}update(t,e){return B(this,null,(function*(){return R(this,Ml,L(this,Ll,Pl).call(this,t,e)),0===M(this,Ml).size&&(yield M(this,Il).close()),M(this,Il).update(t,e)}))}unsubscribe(){return M(this,Il).unsubscribe()}next(){return B(this,null,(function*(){var t;if(M(this,Ml)&&0===M(this,Ml).size)return{done:!0,value:void 0};const e=yield M(this,Ul).next();if(e.done)return e;const i=e.value.groupId();return null==(t=M(this,Ml))||t.delete(i),M(this,xl).push(i),M(this,Cl)||R(this,Cl,i),R(this,Cl,M(this,Cl)<i?i:M(this,Cl)),e}))}return(){return M(this,Il).return()}[Symbol.asyncIterator](){return this}};Il=new WeakMap,Cl=new WeakMap,xl=new WeakMap,Ml=new WeakMap,Ul=new WeakMap,Rl=new WeakMap,Ll=new WeakSet,Pl=function(t,e){const i=new Set;for(let n=t;n<=e;n++)null==i||i.add(n);return M(this,xl).items().forEach((t=>{null==i||i.delete(t)})),i};let Jl=Kl;var Yl,th,eh,ih,nh,sh,rh;const ah=class t{constructor(t){U(this,nh),U(this,Yl),U(this,th),U(this,eh,new Z(10)),U(this,ih),U(this,rh,((t,e)=>B(this,null,(function*(){var i=[];try{const n=O(i,yield M(this,Yl).lock()),s={subscribeId:n.value.subscribeId()};if(!n.value.needsRenewal())return void M(this,ih).debug("Subscription does not need renewal",s);const r=n.value.largestGroupId(),a=void 0!==r,o=(new ql).name(e.name).priority(e.priority).groupOrder(e.groupOrder);switch(s.largestGroupId=r,M(this,ih).debug("Renewing subscription",s),e.filterType.type){case"absolute-range":return void M(this,ih).debug("Absolute range is not renewed",s);case"absolute-start":case"latest-group":case"latest-object":a&&o.startGroup(r+J(1))}const l=o.build();s.newTrack=l;const[h]=yield Promise.all([t.subscribe(l),a?n.value.update(r,r):n.value.unsubscribe()]);h.done().then((()=>L(this,nh,sh).call(this,h))).catch(G),h.expiryNotification().then((()=>M(this,rh).call(this,t,l))).catch(G);const c=new Jl(h,r);n.value=c,yield M(this,eh).push(c),M(this,ih).info("Subscription renewed",s)}catch(t){var n=t,s=!0}finally{F(i,n,s)}})))),R(this,Yl,new Gt(t)),R(this,th,t),R(this,ih,Rt.get().createContext(`Renewable '${t.name()}'`))}static subscribe(e,i,n){return B(this,null,(function*(){const s=yield e.subscribe(i),r=new t(new Jl(s,n));return s.done().then((()=>{var t;return L(t=r,nh,sh).call(t,s)})).catch(G),s.expiryNotification().then((()=>{var t;return M(t=r,rh).call(t,e,i)})).catch(G),r}))}largestGroupId(){return M(this,Yl).unsafeValue().largestGroupId()}update(t,e){return B(this,null,(function*(){var i=[];try{const n=O(i,yield M(this,Yl).lock());return M(this,eh).close(),n.value.update(t,e)}catch(t){var n=t,s=!0}finally{F(i,n,s)}}))}endOfTrack(t){return B(this,null,(function*(){var e=[];try{const i=O(e,yield M(this,Yl).lock());return M(this,eh).close(),i.value.endOfTrack(t)}catch(t){var i=t,n=!0}finally{F(e,i,n)}}))}unsubscribe(){return B(this,null,(function*(){var t=[];try{const e=O(t,yield M(this,Yl).lock());return M(this,eh).close(),e.value.unsubscribe()}catch(t){var e=t,i=!0}finally{F(t,e,i)}}))}return(){return B(this,null,(function*(){var t=[];try{const e=O(t,yield M(this,Yl).lock());return M(this,eh).close(),e.value.return()}catch(t){var e=t,i=!0}finally{F(t,e,i)}}))}next(){return B(this,null,(function*(){var t,e;const i=yield M(this,th).next();if(i.done){yield null==(e=(t=M(this,th)).return)?void 0:e.call(t);const i=yield M(this,eh).pop();if(i)return R(this,th,i),this.next()}return i}))}[Symbol.asyncIterator](){return this}objects(){return D(this,null,(function*(){try{for(var t,e,i,n=W(this);t=!(e=yield new _(n.next())).done;t=!1){var s=e.value,r=[];try{const t=O(r,s,!0);yield*N(t)}catch(t){var a=t,o=!0}finally{var l=F(r,a,o);l&&(yield new _(l))}}}catch(e){i=[e]}finally{try{t&&(e=n.return)&&(yield new _(e.call(n)))}finally{if(i)throw i[0]}}}))}};Yl=new WeakMap,th=new WeakMap,eh=new WeakMap,ih=new WeakMap,nh=new WeakSet,sh=function(t){return B(this,null,(function*(){var e;if(t.unsubscribed()||null!=(e=t.range())&&e.endGroup)M(this,ih).info("Server initiated subscribe done but the subscription is already closing");else{if(M(this,Yl).unsafeValue().subscribeId()===t.id)return this.return();M(this,ih).info("subscribeId mismatch - the subscription already has been renewed")}}))},rh=new WeakMap;let oh=ah;function lh(t){const e=function(t){const e=(new TextDecoder).decode(t);return JSON.parse(e)}(t.payload);if(!function(t){return"tracks"in t}(e))throw new Error("unexpected catalog type");return e}var hh,ch,dh,uh,mh,ph;hh=new WeakMap,ch=new WeakMap,dh=new WeakMap,uh=new WeakMap,mh=new WeakSet,ph=function(){return B(this,null,(function*(){const t=yield M(this,dh).promise;try{for(var e,i,n,s=W(t);e=!(i=yield s.next()).done;e=!1){const t=i.value;if(0!==t.objectStatus)continue;const e=lh(t);M(this,hh).update(e)}}catch(i){n=[i]}finally{try{e&&(i=s.return)&&(yield i.call(s))}finally{if(n)throw n[0]}}}))};let gh=class t{constructor(t,e,i){U(this,mh),U(this,hh),U(this,ch),U(this,dh),U(this,uh),R(this,ch,t),R(this,hh,e),R(this,dh,i),R(this,uh,L(this,mh,ph).call(this)),this.closed().finally((()=>M(this,hh).close())).catch(G)}catalog(){return M(this,hh)}closed(){return M(this,uh)}close(){return B(this,null,(function*(){return M(this,hh).close(),(yield M(this,ch).promise).unsubscribe()}))}static start(e,i){return B(this,null,(function*(){const n=z.fromPromise(oh.subscribe(e,(new ql).name(i.catalogName||"catalog").groupOrder("ascending").build())),s=z.fromPromise(n.promise.then((t=>t.objects())));if(i.catalog)return new t(n,new zt(i.catalog),s);const r=yield(yield s.promise).next();if(!r.value)throw new Error("No catalog found");const a=lh(r.value);return new t(n,new zt(a),s)}))}};var fh,Ah,vh,bh,wh,yh,Sh,kh,Eh,Th,Ih,Ch;class xh{constructor(t,e,i,n){U(this,wh),U(this,fh),U(this,Ah),U(this,vh),I(this,"track"),U(this,bh,Rt.get().createContext("CmafGroup")),this.track=n,R(this,fh,i),R(this,Ah,t),R(this,vh,e)}[Symbol.asyncIterator](){return D(this,null,(function*(){const t={name:this.track.trackObject.name,namespace:this.track.namespace};M(this,bh).debug("start",f({},t));try{for(var e,i,n,s=W(M(this,Ah));e=!(i=yield new _(s.next())).done;e=!1){const e=i.value;if(4===e.objectStatus&&(yield new _(this.track.endOfTrack(e.groupId))),0!==e.objectStatus)continue;const n=M(this,vh).createFragment(e.payload),s=n.timescale(),r=n.baseMediaDecodeTime()/s*1e3,a=r+n.duration()/s*1e3,o=M(this,fh)/1e3*s;n.updateBaseMediaDecodeTime(n.baseMediaDecodeTime()-o);const l=this.track.timestampRange();if(l&&r>=l[1])break;M(this,bh).debug("fragment",A(f({},t),{startTime:r,endTime:a,subscribeId:e.subscribeId,groupId:e.groupId,objectId:e.objectId,streamId:e.streamId})),yield[e.groupId,n]}}catch(i){n=[i]}finally{try{e&&(i=s.return)&&(yield new _(i.call(s)))}finally{if(n)throw n[0]}}M(this,bh).debug("end",f({},t))}))}[Pt()](){return L(this,wh,yh).call(this)}[Symbol.asyncDispose](){return L(this,wh,yh).call(this)}}fh=new WeakMap,Ah=new WeakMap,vh=new WeakMap,bh=new WeakMap,wh=new WeakSet,yh=function(){return B(this,null,(function*(){var t,e;return yield null==(e=(t=M(this,Ah)).return)?void 0:e.call(t),Promise.resolve()}))};const Mh=class t{constructor(t,e,i,n,s){U(this,Sh),U(this,kh),U(this,Eh),U(this,Th),I(this,"trackObject"),I(this,"namespace"),this.trackObject=t,this.namespace=e,R(this,kh,i),R(this,Sh,n),R(this,Eh,s)}static subscribe(e,i,n,r){return B(this,null,(function*(){var a;if("cmaf"!==i.format)throw new Error("format must be cmaf");const o=(new ql).name(i.name);r&&o.startGroup(r);const l=o.build();if(i.initTrack){const s=(new ql).name(i.initTrack).build(),[o,h]=yield Promise.all([L(a=t,Ih,Ch).call(a,e,s),oh.subscribe(e,l,r?r-J(1):void 0)]),c=new yn(o);return new t(i,e.namespace(),h,c,n)}(0,s.a)(i.initData,"no init data found on track");const h=K(i.initData),c=new yn(new Uint8Array(h)),d=yield oh.subscribe(e,l,r?r-J(1):void 0);return new t(i,e.namespace(),d,c,n)}))}largestGroupId(){return M(this,kh).largestGroupId()}stopAfterTimestampReached(t){R(this,Th,[0,t])}timestampRange(){return M(this,Th)}endOfTrack(t){return M(this,kh).endOfTrack(t)}update(t,e){return M(this,kh).update(t,e)}unsubscribe(){return B(this,null,(function*(){return M(this,kh).unsubscribe()}))}next(){return B(this,null,(function*(){const t=yield M(this,kh).next();return t.done?t:{done:!1,value:new xh(t.value,M(this,Sh),M(this,Eh),this)}}))}return(){return B(this,null,(function*(){return yield M(this,kh).return(),{done:!0,value:void 0}}))}[Symbol.asyncIterator](){return this}[Pt()](){return this.unsubscribe()}[Symbol.asyncDispose](){return B(this,null,(function*(){return this.unsubscribe()}))}};Sh=new WeakMap,kh=new WeakMap,Eh=new WeakMap,Th=new WeakMap,Ih=new WeakSet,Ch=function(t,e){return B(this,null,(function*(){var i=[];try{const n=O(i,yield t.subscribe(e),!0),s=yield n.objects().next();if(s.done)throw new Error("No init object");return yield n.close(),s.value.payload}catch(t){var n=t,s=!0}finally{var r=F(i,n,s);r&&(yield r)}}))},U(Mh,Ih);let Uh=Mh;var Rh,Lh,Ph,Bh,_h,Dh,Nh,Wh,Oh;Rh=new WeakMap,Lh=new WeakMap,Ph=new WeakMap,Bh=new WeakMap,_h=new WeakMap,Dh=new WeakMap,Nh=new WeakSet,Wh=function(t){return B(this,null,(function*(){const e=yield t.promise;try{for(var i,n,s,r=W(e);i=!(n=yield r.next()).done;i=!1){var a=n.value,o=[];try{const t=O(o,a,!0);try{for(var l,h,c,d=W(t);l=!(h=yield d.next()).done;l=!1){const t=h.value;if(0!==t.objectStatus)continue;const i=Vh(t.payload);M(this,Lh).update((t=>{var e,n;for(t.push(...i),t.sort(((t,e)=>t.wallclock-e.wallclock));t[0]&&(null!=(n=null==(e=t[t.length-1])?void 0:e.wallclock)?n:0)-t[0].wallclock>3e4;)t.shift();return t})),e===M(this,Ph).resolved&&t.groupId>J(0)&&t.objectId==J(0)&&L(this,Nh,Oh).call(this,t.groupId).catch((t=>{M(this,Rh).warn("backfill failed",t)}))}}catch(h){c=[h]}finally{try{l&&(h=d.return)&&(yield h.call(d))}finally{if(c)throw c[0]}}}catch(t){var u=t,m=!0}finally{var p=F(o,u,m);p&&(yield p)}}}catch(n){s=[n]}finally{try{i&&(n=r.return)&&(yield n.call(r))}finally{if(s)throw s[0]}}}))},Oh=function(t){return B(this,null,(function*(){const e=t-J(1),i=this.timeline(),n=i[0],s=i[i.length-1];if(!n||!s||s.wallclock-n.wallclock>1e4)return;const r=z.fromPromise(oh.subscribe(M(this,Bh),(new ql).name(M(this,_h)).groupOrder("ascending").range(e,e).build()));return L(this,Nh,Wh).call(this,r)}))};let Fh=class t{constructor(t,e,i){U(this,Nh),U(this,Rh,Rt.get().createContext("Timeline")),U(this,Lh,new zt([])),U(this,Ph),U(this,Bh),U(this,_h),U(this,Dh),R(this,Bh,t),R(this,_h,i),R(this,Ph,e),R(this,Dh,L(this,Nh,Wh).call(this,M(this,Ph))),this.closed().finally((()=>M(this,Lh).close())).catch(G)}closed(){return M(this,Dh)}close(){return B(this,null,(function*(){return(yield M(this,Ph).promise).unsubscribe()}))}timeline(){const[t,e]=M(this,Lh).value();return t}timestampWallclockOffset(){return wt(this.timeline().map((t=>t.mediaPts-t.wallclock)))}static start(e,i){const n=z.fromPromise(oh.subscribe(e,(new ql).name(i).groupOrder("ascending").build()));return new t(e,n,i)}waitForWallclockTime(t){return B(this,null,(function*(){return yield M(this,Lh).waitFor((e=>!!e.find((e=>e.wallclock>=t)))),this.timeline()}))}waitForTimelineToHaveMinDuration(){return B(this,null,(function*(){return yield M(this,Lh).waitFor((t=>{const e=t[0],i=t[t.length-1];return!(!e||!i)&&i.wallclock-e.wallclock>1e4})),this.timeline()}))}};function Vh(t){var e;const i=new TextDecoder("utf-8").decode(t).split("\n");return null!=(e=i[0])&&e.startsWith("MEDIA_PTS")&&i.shift(),i.filter((t=>t.length>0)).map((t=>{const[e,i,n,s,r]=t.split(",");if(!e||!s)throw new Error(`invalid timeline row: ${t}`);return{mediaPts:parseInt(e),groupId:i?parseInt(i):void 0,objectId:n?parseInt(n):void 0,wallclock:parseInt(s),metadata:r}}))}var Gh,zh,Hh,jh;const Xh=class t{constructor(t,e,i,n,s){U(this,Gh,new as),U(this,zh),U(this,Hh),U(this,jh,0),I(this,"trackObject"),I(this,"namespace"),R(this,Hh,t),R(this,zh,e),this.trackObject=i,this.namespace=n,R(this,jh,s)}static subscribe(e,i,n){return B(this,null,(function*(){if(!function(t){return"string"==typeof t.language}(i))throw new Error("track object language is required");const s=(new ql).name(i.name).build(),r=yield oh.subscribe(e,s),a=r.objects();return new t(r,a,i,e.namespace(),n)}))}largestGroupId(){return M(this,Hh).largestGroupId()}update(t,e){return M(this,Hh).update(t,e)}unsubscribe(){return M(this,Hh).unsubscribe()}next(){return B(this,null,(function*(){for(;;){const t=yield M(this,zh).next();if(t.done)return t;if(0!==t.value.objectStatus)continue;const e=(new TextDecoder).decode(t.value.payload),i=M(this,Gh).parse(e).map((t=>(t.startTime-=M(this,jh)/1e3,t.endTime-=M(this,jh)/1e3,t)));return{done:!1,value:{language:this.trackObject.language,cues:i}}}}))}return(){return B(this,null,(function*(){return yield M(this,Hh).return(),{done:!0,value:void 0}}))}[Symbol.asyncIterator](){return this}[Pt()](){return this.unsubscribe()}[Symbol.asyncDispose](){return this.unsubscribe()}};Gh=new WeakMap,zh=new WeakMap,Hh=new WeakMap,jh=new WeakMap;let qh=Xh;var Qh,$h,Zh,Kh,Jh,Yh,tc,ec;Qh=[Lt({context:"Channel",enter:"info"})];const ic=class t{constructor(t,e,i,n,s){U(this,tc),I(this,"namespace"),U(this,$h),U(this,Zh),U(this,Kh),U(this,Jh),this.namespace=n,R(this,$h,t),R(this,Zh,e),R(this,Kh,i),R(this,Jh,s)}static start(e,i){return B(this,null,(function*(){const n=new Ql(e,{namespace:i.namespace}),[s,r]=yield Promise.all([Fh.start(n,"timeline"),gh.start(n,{catalog:i.catalog,namespace:i.namespace})]);return new t(n,s,r,i.namespace,0)}))}closed(){return M(this,Kh).closed()}catalog(){return M(this,Kh).catalog()}timestampWallclockOffset(){return M(this,Zh).timestampWallclockOffset()}timestampOffsetMs(){return M(this,Jh)}setTimestampOffsetMs(t){R(this,Jh,t)}waitForWallclockTime(t){return M(this,Zh).waitForWallclockTime(t)}subscribeCmafTrack(t,e){const i=this.catalog().current().tracks,n=void 0!==t["com.vindral.variant_uid"]?i.find((e=>e["com.vindral.variant_uid"]===t["com.vindral.variant_uid"])):void 0;return L(this,tc,ec).call(this,(()=>Uh.subscribe(M(this,$h),null!=n?n:t,M(this,Jh),e)))}subscribeWebVttTrack(t){return L(this,tc,ec).call(this,(()=>qh.subscribe(M(this,$h),t,M(this,Jh))))}subscribeTrack(t){return L(this,tc,ec).call(this,(()=>M(this,$h).subscribe(t)))}close(){return Promise.all([M(this,Kh).close(),M(this,Zh).close()])}};Yh=b(null),$h=new WeakMap,Zh=new WeakMap,Kh=new WeakMap,Jh=new WeakMap,tc=new WeakSet,ec=function(t){return B(this,null,(function*(){const[e,i]=this.catalog().value();try{return yield t()}catch(n){if(e===this.catalog().current()&&i&&(yield Promise.race([i,Yt(500)])),e!==this.catalog().current())return t();throw n}}))},T(Yh,9,"start",Qh,ic),k(Yh,ic),E(Yh,3,ic);let nc=ic;var sc,rc,ac,oc;sc=new WeakMap,rc=new WeakMap,ac=new WeakSet,oc=function(t){return B(this,null,(function*(){try{for(var e,i,n,s=W(t.value);e=!(i=yield s.next()).done;e=!1){const t=i.value;R(this,sc,{createdAt:new Date,wallclock:new Date(t.ntpTimestamp),rtt:t.rtt})}}catch(i){n=[i]}finally{try{e&&(i=s.return)&&(yield i.call(s))}finally{if(n)throw n[0]}}}))};let lc=class t{constructor(t){U(this,ac),U(this,sc),U(this,rc);const[e,i]=t.value.value();R(this,sc,{createdAt:new Date,wallclock:new Date(e.ntpTimestamp),rtt:e.rtt}),R(this,rc,L(this,ac,oc).call(this,t))}wallclock(){const t=Date.now()-M(this,sc).createdAt.getTime();return M(this,sc).wallclock.getTime()+t}closed(){return M(this,rc)}static start(e){return new t(e)}};function hc(t){return"string"==typeof t||null==t}function cc(t){try{return K(t)}catch(t){throw new Error("Failed to convert fairplayCertificate")}}class dc{constructor(t){I(this,"value"),this.value=t}static create(t,e,i){return B(this,null,(function*(){var n=[];try{const s=O(n,yield t.subscribeTrack((new ql).name("drm").build()),!0).objects(),r=yield s.next();if(r.done)throw new Error("No drm object received");const a=function(t){const e=(new TextDecoder).decode(t),i=JSON.parse(e);if(!function(t){return"provider"in t&&"string"==typeof t.provider&&(!("widevineLicenseUrl"in t)||hc(t.widevineLicenseUrl))&&(!("playreadyLicenseUrl"in t)||hc(t.playreadyLicenseUrl))&&(!("fairplayLicenseUrl"in t)||hc(t.fairplayLicenseUrl))&&(!("fairplayCertificate"in t)||hc(t.fairplayCertificate))}(i))throw new Error("Invalid drm object");const n=i,{fairplayCertificate:s}=n,r=((t,e)=>{var i={};for(var n in t)d.call(t,n)&&e.indexOf(n)<0&&(i[n]=t[n]);if(null!=t&&c)for(var n of c(t))e.indexOf(n)<0&&u.call(t,n)&&(i[n]=t[n]);return i})(n,["fairplayCertificate"]);return A(f({},r),{fairplayCertificate:s?cc(s):void 0})}(r.value.payload);return new dc(A(f({},a),{videoCodec:e,audioCodec:i}))}catch(t){var s=t,r=!0}finally{var a=F(n,s,r);a&&(yield a)}}))}}function uc(t){const e=(new TextDecoder).decode(t),i=JSON.parse(e);if(!function(t){return"rtt"in t&&"number"==typeof t.rtt&&"ntpTimestamp"in t&&"number"==typeof t.ntpTimestamp&&"estimatedBandwidth"in t&&"number"==typeof t.estimatedBandwidth}(i))throw new Error("Invalid stats object");return i}var mc,pc,gc;mc=new WeakMap,pc=new WeakSet,gc=function(t){return B(this,null,(function*(){try{for(var e,i,n,s=W(t);e=!(i=yield s.next()).done;e=!1){const t=i.value;if(0!==t.objectStatus)continue;const e=uc(t.payload);this.value.update(e)}}catch(i){n=[i]}finally{try{e&&(i=s.return)&&(yield i.call(s))}finally{if(n)throw n[0]}}}))};let fc=class t{constructor(t,e,i){U(this,pc),I(this,"ip"),I(this,"value"),U(this,mc),this.ip=i,this.value=new zt(e),R(this,mc,L(this,pc,gc).call(this,t))}closed(){return M(this,mc)}idleTimeout(){return B(this,null,(function*(){for(;;){const[t,e]=this.value.value();try{yield Promise.race([te(1e4,new Error("Idle timeout")),e])}catch(t){return t}}}))}static start(e){return B(this,null,(function*(){const i=(yield e.subscribe((new ql).name("stats").groupOrder("ascending").build())).objects(),n=yield i.next();if(n.done)throw new Error("No stats object received");const s=uc(n.value.payload);if(!s.ip)throw new Error("Expected IP in initial stats object");return new t(i,s,s.ip)}))}};var Ac,vc,bc,wc,yc,Sc,kc,Ec,Tc,Ic,Cc,xc,Mc,Uc,Rc,Lc,Pc,Bc,_c,Dc,Nc,Wc,Oc;class Fc{constructor(t){U(this,Ac,Rt.get().createContext("UpstreamWatcher")),U(this,vc),R(this,vc,new zt(z.fromPromise(t.closed())))}update(t){M(this,vc).update(z.fromPromise(t.closed()))}closed(){return B(this,null,(function*(){try{for(;;){const[t,e]=M(this,vc).value();let i=!1;yield Promise.race([null==e?void 0:e.then((()=>i=!0)),t.promise.then((()=>{if(!i)throw M(this,Ac).warn("Upstream closed"),new Error("Upstream closed")}))])}}catch(t){return t}}))}}Ac=new WeakMap,vc=new WeakMap;class Vc{constructor(t,e){U(this,bc,Rt.get().createContext("TracksIterator")),U(this,wc),U(this,yc),R(this,wc,t),R(this,yc,e)}[Symbol.asyncIterator](){return D(this,null,(function*(){const t=M(this,yc);try{for(var e,i,n,s=W(M(this,wc));e=!(i=yield new _(s.next())).done;e=!1){const e=i.value;if(!e)continue;const n={name:e.trackObject.name,namespace:e.namespace};M(this,bc).debug("track start",f({mediaType:t},n)),yield*N(e),M(this,bc).debug("track end",f({mediaType:t},n))}}catch(i){n=[i]}finally{try{e&&(i=s.return)&&(yield new _(i.call(s)))}finally{if(n)throw n[0]}}M(this,bc).debug("tracks ended",{mediaType:t})}))}}bc=new WeakMap,wc=new WeakMap,yc=new WeakMap,Ec=[Lt({context:"Player",enter:"info"})],kc=[Lt({context:"Player",enter:"info",return:"info"})],Sc=[Lt({context:"Player",enter:"info"})];const Gc=class t{constructor(t,e,i){E(Bc,5,this),U(this,_c),U(this,Tc),U(this,Ic),U(this,Cc),U(this,xc),U(this,Mc,new zt(void 0)),U(this,Uc,new zt(void 0)),U(this,Rc,new zt(void 0)),U(this,Lc),U(this,Pc),I(this,"subtitles",new Vc(M(this,Rc),"subtitles")),I(this,"video",new Vc(M(this,Uc),"video")),I(this,"audio",new Vc(M(this,Mc),"audio")),R(this,Tc,t),R(this,Ic,lc.start(i)),R(this,Cc,i),R(this,xc,new zt(e)),R(this,Lc,new Fc(e)),R(this,Pc,Promise.race([i.idleTimeout(),L(this,_c,Wc).call(this),M(this,Lc).closed()])),M(this,Tc).closed().then((()=>this.close())).catch(G)}closed(){return M(this,Pc)}static start(e,i){return B(this,null,(function*(){const n=new Ql(e,{namespace:$l("auxiliary")}),[[s,r,a],o]=yield Promise.all([nc.start(e,i).then((t=>Promise.all([Promise.resolve(t),i.videoTrack?t.subscribeCmafTrack(i.videoTrack):void 0,i.audioTrack?t.subscribeCmafTrack(i.audioTrack):void 0]))),fc.start(n)]),l=new t(e,s,o);return a&&M(l,Mc).update(a),r&&M(l,Uc).update(r),l}))}connectionInfo(){const t=M(this,Cc).value.current();return{ip:M(this,Cc).ip,rtt:t.rtt,estimatedBandwidth:t.estimatedBandwidth}}stats(){return M(this,Cc).value}catalog(){return M(this,xc).current().catalog()}namespace(){return M(this,xc).current().namespace}videoTrack(){var t;return null==(t=M(this,Uc).current())?void 0:t.trackObject}audioTrack(){var t;return null==(t=M(this,Mc).current())?void 0:t.trackObject}referenceClock(){return M(this,Ic)}drm(){return B(this,null,(function*(){var t,e;if(this.catalog().current().tracks.find((({name:t})=>"drm"===t)))return dc.create(M(this,xc).current(),null==(t=this.videoTrack())?void 0:t.codec,null==(e=this.audioTrack())?void 0:e.codec)}))}close(){return Promise.all([M(this,xc).current().close(),M(this,xc).close(),L(this,_c,Dc).call(this,M(this,Mc)),L(this,_c,Dc).call(this,M(this,Uc)),L(this,_c,Dc).call(this,M(this,Rc))])}zap(t,e){return B(this,null,(function*(){var i,n;const s=yield nc.start(M(this,Tc),t),r=M(this,Ic).wallclock()-e,a=M(this,xc).current(),o=a.timestampWallclockOffset(),l=yield s.waitForWallclockTime(r);M(this,Lc).update(s),yield M(this,xc).current().close();const h=l.toReversed().find((t=>t.wallclock<=r)),c=null!=h&&h.mediaPts?h.mediaPts-a.timestampOffsetMs():void 0,d=s.timestampWallclockOffset()-o+a.timestampOffsetMs();s.setTimestampOffsetMs(d);const u=null!=h&&h.groupId?J(h.groupId):void 0;c&&(null==(i=M(this,Uc).current())||i.stopAfterTimestampReached(c),null==(n=M(this,Mc).current())||n.stopAfterTimestampReached(c)),M(this,xc).update(s),yield Promise.all([t.videoTrack?this.setVideoTrack(t.videoTrack,u):void 0,t.audioTrack?this.setAudioTrack(t.audioTrack,u):void 0])}))}setSubtitleTrack(t){return B(this,null,(function*(){var e,i;if(!t)return void(yield null==(e=M(this,Rc).current())?void 0:e.unsubscribe());const[n]=yield Promise.all([M(this,xc).current().subscribeWebVttTrack(t),null==(i=M(this,Rc).current())?void 0:i.unsubscribe()]);M(this,Rc).update(n)}))}setVideoTrack(t,e){return B(this,null,(function*(){const i=yield L(this,_c,Nc).call(this,M(this,xc).current(),t,M(this,Uc).current(),e);M(this,Uc).update(i)}))}setAudioTrack(t,e){return B(this,null,(function*(){const i=yield L(this,_c,Nc).call(this,M(this,xc).current(),t,M(this,Mc).current(),e);M(this,Mc).update(i)}))}};Bc=b(null),Tc=new WeakMap,Ic=new WeakMap,Cc=new WeakMap,xc=new WeakMap,Mc=new WeakMap,Uc=new WeakMap,Rc=new WeakMap,Lc=new WeakMap,Pc=new WeakMap,_c=new WeakSet,Dc=function(t){const e=t.current(),i=null==e?void 0:e.largestGroupId();return t.isClosed()||t.update(void 0),t.close(),i?null==e?void 0:e.update(i,i):null==e?void 0:e.unsubscribe()},Nc=function(t,e,i,n){return B(this,null,(function*(){const s=null==i?void 0:i.largestGroupId(),[r,a]=yield Promise.all([t.subscribeCmafTrack(e,n||(s?s+J(1):void 0)),s?null==i?void 0:i.update(s,s):null==i?void 0:i.unsubscribe()]);return r}))},Wc=function(){return B(this,null,(function*(){try{for(var t,e,i,n=W(M(this,xc));t=!(e=yield n.next()).done;t=!1){const t=e.value;try{for(var s,r,a,o=W(t.catalog());s=!(r=yield o.next()).done;s=!1){const t=r.value;yield Promise.all([L(this,_c,Oc).call(this,t,M(this,Uc)),L(this,_c,Oc).call(this,t,M(this,Mc))])}}catch(r){a=[r]}finally{try{s&&(r=o.return)&&(yield r.call(o))}finally{if(a)throw a[0]}}}}catch(e){i=[e]}finally{try{t&&(e=n.return)&&(yield e.call(n))}finally{if(i)throw i[0]}}}))},Oc=function(t,e){return B(this,null,(function*(){const i=e.current();if(!i)return;const n=i.trackObject.name,s=i.trackObject["com.vindral.variant_uid"],r=t.tracks.find((t=>t.name===n)),a=t.tracks.find((t=>t["com.vindral.variant_uid"]===s));if(!r){if(!a)return void e.update(void 0);e.update(yield M(this,xc).current().subscribeCmafTrack(a))}}))},T(Bc,1,"close",Ec,Gc),T(Bc,1,"zap",kc,Gc),Nc=T(Bc,17,"#replaceTrack",Sc,_c,Nc),k(Bc,Gc);let zc=Gc;function Hc(t,e,i){const n=new URL("/voq/subscribe",t);return n.searchParams.set("sessionId",e.sessionId),n.searchParams.set("clientId",e.clientId),n.searchParams.set("channelId",e.channelId),i&&n.searchParams.set("authToken",i),n}var jc,Xc,qc,Qc,$c,Zc,Kc,Jc,Yc,td,ed,id,nd,sd,rd,ad,od,ld,hd,cd;jc=new WeakMap,Xc=new WeakMap,qc=new WeakMap,Qc=new WeakMap,$c=new WeakMap,Zc=new WeakMap,Kc=new WeakMap,Jc=new WeakMap,Yc=new WeakMap,td=new WeakMap,ed=new WeakSet,id=function(){return B(this,null,(function*(){try{for(var t,e,i,n=W(M(this,$c).stats());t=!(e=yield n.next()).done;t=!1){const{rtt:t}=e.value;M(this,Jc).push(t)}}catch(e){i=[e]}finally{try{t&&(e=n.return)&&(yield e.call(n))}finally{if(i)throw i[0]}}}))},nd=new WeakMap,sd=new WeakMap,rd=new WeakMap,ad=function(t){return B(this,null,(function*(){var e;const i=yield M(this,Kc).connect({channelId:t});if(!(0,s.i)(i))throw new Error("no moq connect info found");const n=null==(e=i.channels.find((e=>e.channelId===t)))?void 0:e.catalog;if(!n)throw new Error("no catalog found");return n}))},od=function(t){return B(this,null,(function*(){var e,i,n;M(this,Xc).info("handle subscription",t);const s=M(this,$c);let r=M(this,Zc).get(t.channelId);if(r||(r=new Ad(new zt(yield L(this,ed,ad).call(this,t.channelId))),M(this,Zc).set(t.channelId,r)),s.namespace().join("/")!==r.namespace().join("/")){M(this,Xc).info("changing channel",t.channelId);const i=r.getVideoTrack(t.video),n=r.getAudioTrack(t.audio);return yield s.zap({namespace:r.namespace(),catalog:r.catalog(),videoTrack:null==i?void 0:i.track,audioTrack:null==n?void 0:n.track},500),s.drm().then((t=>{t&&M(this,jc).emit("received drm data",t.value)})).catch((t=>{M(this,Xc).error("Error getting DRM data",t)})),M(this,Xc).info("switched channel",t.channelId),null==(e=M(this,Zc).get(Zl(s.namespace())))||e.updateCatalog(s.catalog()),void M(this,jc).emit("received signal",{type:"subscription changed",subscription:t})}const a=r.getVideoTrack(t.video),o=r.getAudioTrack(t.audio);yield Promise.all([a&&a.track.name!==(null==(i=M(this,$c).videoTrack())?void 0:i.name)?M(this,$c).setVideoTrack(a.track):void 0,o&&o.track.name!==(null==(n=M(this,$c).audioTrack())?void 0:n.name)?M(this,$c).setAudioTrack(o.track):void 0]),M(this,jc).emit("received signal",{type:"subscription changed",subscription:t})}))},ld=function(){return B(this,null,(function*(){try{R(this,Qc,"connecting"),M(this,Xc).info("Connecting..."),R(this,Qc,"connected"),yield Promise.all([L(this,ed,cd).call(this,M(this,$c).referenceClock(),M(this,$c).audio),L(this,ed,cd).call(this,M(this,$c).referenceClock(),M(this,$c).video),L(this,ed,hd).call(this,M(this,$c).subtitles)]),yield M(this,$c).closed(),M(this,qc).close(),M(this,Xc).info("Session closed")}catch(t){M(this,Xc).warn("Session error",t)}}))},hd=function(t){return B(this,null,(function*(){try{for(var e,i,n,s=W(t);e=!(i=yield s.next()).done;e=!1){const t=i.value;M(this,jc).emit("text track data",t)}}catch(i){n=[i]}finally{try{e&&(i=s.return)&&(yield i.call(s))}finally{if(n)throw n[0]}}}))},cd=function(t,e){return B(this,null,(function*(){var i;let n,r="",a="";const o=void 0===M(this,$c).videoTrack();try{for(var l,h,c,d=W(e);l=!(h=yield d.next()).done;l=!1){const e=h.value,l=Zl(e.track.namespace),c=e.track.trackObject.language,d=(0,s.c)(null!=(i=e.track.trackObject.codec)?i:""),f=e.track.trackObject.codec,A=d?se({codec:d,codecString:f}):void 0,v=!!e.track.trackObject["com.vindral.drm"];try{for(var u,m,p,g=W(e);u=!(m=yield g.next()).done;u=!1){const[i,s]=m.value,h={channelId:""===r||!o&&"video"!==s.mediaType()||r===l?void 0:l,language:"audio"===s.mediaType()&&a!==c?c:void 0,drmTransition:void 0!==n&&n!==v};r=l,a=c,n=v;const u=s.producerReferenceTime(),p=M(this,td).get(e.track.namespace)||0;if(u&&Date.now()-p>1e3){M(this,td).set(e.track.namespace,Date.now());const n=t.wallclock()-u.getTime();M(this,Xc).debug("timing-info",{mediaType:s.mediaType(),referenceClock:t,delta:n,groupId:i,timestamp:s.baseMediaDecodeTime()/s.timescale()*1e3+n,wallclockTime:u.getTime()}),M(this,jc).emit("received signal",{type:"timing info",timingInfo:{channelId:l,timestamp:s.baseMediaDecodeTime()/s.timescale()*1e3+n,wallclockTime:u.getTime()}})}M(this,jc).emit("received moq data",{payload:s,channelId:l,groupId:i,mimeType:A,codec:d,switchInfo:h,renditionId:ud(e.track.trackObject.name)})}}catch(m){p=[m]}finally{try{u&&(m=g.return)&&(yield m.call(g))}finally{if(p)throw p[0]}}}}catch(h){c=[h]}finally{try{l&&(h=d.return)&&(yield h.call(d))}finally{if(c)throw c[0]}}}))};let dd=class t{constructor(t,e,i,n,r,a){U(this,ed),U(this,jc),U(this,Xc),U(this,qc),U(this,Qc,"disconnected"),U(this,$c),U(this,Zc,new Map),U(this,Kc),U(this,Jc,new H(10)),U(this,Yc,Number.MAX_SAFE_INTEGER),U(this,td,new Map),U(this,nd,(t=>{if(!t)return void M(this,$c).setSubtitleTrack(void 0).catch(G);const e=M(this,Zc).get(Zl(M(this,$c).namespace())),i=null==e?void 0:e.getTextTrack(t);i&&M(this,$c).setSubtitleTrack(i).catch(G)})),U(this,sd,(t=>{switch(t.type){case"subscribe":if(M(this,rd))return void M(this,Xc).info("Ignoring  - we are already switching");R(this,rd,!0),L(this,ed,od).call(this,t.subscription).catch((e=>{M(this,Xc).error("error handling subscription",e),M(this,jc).emit("received signal",{type:"subscription changed",subscription:t.subscription,reset:!0})})).finally((()=>R(this,rd,!1)));break;case"telemetry":(0,s.p)(new URL("/api/telemetry",M(this,qc).url().replace("wss://","https://")),{body:t.body,headers:{"Content-Type":"text/plain"}}).catch(G);break;case"refresh auth":M(this,qc).updateAuthToken(t.token)}})),U(this,rd,!1),I(this,"disconnect",((t="Disconnect Requested")=>{M(this,Xc).info("Disconnecting",t),M(this,qc).close(),M(this,$c).close().catch(G),R(this,td,new Map),R(this,Qc,"disconnected")})),R(this,jc,t),R(this,Xc,e),R(this,qc,i),R(this,$c,n),R(this,Zc,r),R(this,Kc,a),M(this,jc).on("send signal",M(this,sd)),M(this,jc).on("disconnect",this.disconnect),M(this,jc).on("text track",M(this,nd)),L(this,ed,id).call(this).catch(G),L(this,ed,ld).call(this).catch(G)}get estimatedBandwidth(){return M(this,Yc)}unload(){M(this,jc).off("send signal",M(this,sd)),M(this,jc).off("disconnect",this.disconnect),M(this,jc).off("text track",M(this,nd)),this.disconnect()}suspend(){}unsuspend(){}getStatistics(){const t=M(this,$c).connectionInfo().estimatedBandwidth;return{rtt:yt(M(this,Jc).items()),estimatedBandwidth:t,connectCount:0,connectionAttemptCount:0,edgeUrl:M(this,qc).url(),connectionProtocol:"moq"}}static start(e,i,n,r){return B(this,null,(function*(){var a,o,l,h;const c=new Map(r.connectInfo.channels.map((t=>[Zl(t.catalog.namespace),new Ad(new zt(t.catalog))]))),d=yield r.onConnectInfo(r.connectInfo),u=r.options.get("authenticationToken");let m,p;"string"==typeof r.edgeUrl?m=Hc(r.edgeUrl,d,u):(m=Hc(r.edgeUrl.moqUrl||r.edgeUrl.moqWsUrl,d,u),p=Hc(r.edgeUrl.moqWsUrl,d,u));const g=null==(a=r.connectInfo.channels.find((t=>t.channelId===d.channelId)))?void 0:a.catalog;i.debug("Resolved edge url",{edgeUrl:m,edgeWsUrl:p}),(0,s.a)(g,"no catalog found");const f=null==(o=c.get(Zl(g.namespace)))?void 0:o.getVideoTrack(d.video),A=null==(l=c.get(Zl(g.namespace)))?void 0:l.getAudioTrack(d.audio),v=yield function(t){return B(this,null,(function*(){if(self.WebTransport&&"websocket"!==(null==t?void 0:t.preferredTransport)&&t.url.protocol.startsWith("https")){const e=function(t){return B(this,null,(function*(){const e=new Uint8Array(32);for(let t=0;t<e.length;t+=1)e[t]=parseInt("60b82e8021689e163c1041b4475ef9c86e7565bc45d1a0aa43f5148769f461c7".slice(2*t,2*t+2),16);const i=new WebTransport(t.url,{congestionControl:"low-latency"});yield Promise.race([i.ready,i.closed.then((()=>Promise.reject(new Error("WebTransport closed"))))]);const n=yield i.createBidirectionalStream(),s=Ia.wrapWebTransport(n);Ca(s,t.role).catch((()=>{i.close()}));const r=new jl(i,s,t.url.toString());return new Gl(r,t.authToken)}))}(t).catch((()=>Xl(t)));return(yield Promise.race([e,Yt(t.websocketFallbackTimeoutMs)]))||Xl(t)}return Xl(t)}))}({url:m,wsUrl:p,authToken:r.options.get("authenticationToken"),preferredTransport:r.options.get("webtransportEnabled")?"webtransport":"websocket",role:2,websocketFallbackTimeoutMs:2e3}),b=yield Promise.race([zc.start(v.subscriber,{namespace:g.namespace,catalog:g,videoTrack:null==f?void 0:f.track,audioTrack:null==A?void 0:A.track}),te(1e4,new Error("Timeout waiting for player to start")),ee(v.closed(),"Session closed before player started")]),w=new Ad(b.catalog());c.set(Zl(g.namespace),w),e.emit("received signal",{type:"client ip",ip:b.connectionInfo().ip}),b.drm().then((t=>{t&&e.emit("received drm data",t.value)})).catch((t=>{i.error("Error getting DRM data",t)}));const y=new t(e,i,v,b,c,n);return d.textTrack&&M(h=y,nd).call(h,d.textTrack),y}))}getState(){return M(this,Qc)}get rtt(){return M(this,$c).connectionInfo().rtt}close(){M(this,qc).close()}closed(){return Promise.race([M(this,qc).closed(),M(this,$c).closed()])}};function ud(t){return t.split("").reduce(((t,e)=>e.charCodeAt(0)+(t<<6)+(t<<16)-t),0)}var md,pd,gd,fd;class Ad{constructor(t){U(this,gd),U(this,md),U(this,pd),R(this,md,t),R(this,pd,L(this,gd,fd).call(this))}catalog(){return M(this,md).current()}namespace(){return M(this,md).current().namespace}updateCatalog(t){R(this,md,t)}getTextTrack(t){return M(this,md).current().tracks.find((e=>e.label===t))}getAudioTrack(t){if(!t.codec)return;const e=M(this,pd).filter((e=>!(!ne(e)||e.bitRate>t.bitRate||t.codec&&e.codec!==t.codec||t.language&&e.language!==t.language)));return e[e.length-1]}getVideoTrack(t){if(!t.codec)return;const e=M(this,pd).filter((e=>!(!ie(e)||e.bitRate>t.bitRate||t.codec&&e.codec!==t.codec)));return e[e.length-1]}renditions(){return M(this,pd)}}md=new WeakMap,pd=new WeakMap,gd=new WeakSet,fd=function(){const[t,e]=M(this,md).value();return(0,s.b)(t)};class vd extends n.E{constructor(t,e){super(),I(this,"options"),I(this,"websockets",[]),I(this,"logger"),I(this,"reconnectState",{reconnectRetries:0}),I(this,"isSuspended",!1),I(this,"_connectionAttemptCount",0),I(this,"connectStartTime",0),I(this,"_connectTime"),I(this,"shouldContinueConnecting",!1),I(this,"_isConnectInProgress",!1),I(this,"readyState",(()=>{if(0===this.websockets.length)return WebSocket.CLOSED;const t=this.websockets.map((t=>t.readyState));for(const e of t)if(e!==WebSocket.OPEN)return e;return WebSocket.OPEN})),I(this,"url",(()=>{var t;return null==(t=this.websockets[0])?void 0:t.url})),I(this,"send",(t=>{var e;this.websockets.length&&(null==(e=this.websockets[0])||e.send(t))})),I(this,"close",(t=>{var e;let i=!1;return null==(e=this.websockets)||e.forEach((e=>{e.onmessage=G,e.removeEventListener("error",this.onError),e.removeEventListener("close",this.onClose),e.removeEventListener("open",this.onOpen),e.close(1e3,t),i=!0})),this.websockets=[],this.shouldContinueConnecting=!1,this._isConnectInProgress=!1,this.logger.info("Closed websocket",{reason:t}),i})),I(this,"suspend",(()=>{this.isSuspended=!0})),I(this,"unsuspend",(()=>{this.isSuspended=!1,this.readyState()!==WebSocket.OPEN&&!this.isConnectInProgress&&this.connect()})),I(this,"onMessage",((t,e)=>{0!==this.websockets.length&&this.options.onMessage(t,e.data)})),I(this,"onError",(()=>{this.logger.info("On error",f({},this.options)),this.close("one websocket had an error"),this.emit("error",new de("WebSocket error",{code:"websocket_error",isFatal:!1}))})),I(this,"onClose",(t=>{switch(this.logger.info("Closed",A(f({},this.options),{reason:t.reason,code:t.code,isSuspended:this.isSuspended})),this.close("one websocket was closed"),t.code){case 4e3:case 4001:this.emit("error",Ae(fe()));break;case 4002:this.emit("error",(t=>new de("Authentication Expired",{isFatal:!0,code:"authentication_expired",source:t}))(fe()));break;case 4003:this.emit("error",ve("internal",fe()));break;case 4010:this.emit("error",((t,e)=>new de("Connection closed due to inactivity",{isFatal:!1,code:"connection_inactivity",source:e,type:"internal"}))(0,fe()))}this.emit("close",this)})),I(this,"onOpen",(()=>{this.logger.info("Opened",f({},this.options)),this.readyState()===WebSocket.OPEN&&(this._connectTime=Date.now()-this.connectStartTime,this.reconnectState.reconnectRetries=0,this._isConnectInProgress=!1,this.emit("open",this))})),I(this,"connect",((t=!1)=>B(this,null,(function*(){if(this.isConnectInProgress)return this.logger.info("Connect already in progress"),!1;if(this.isSuspended)return!1;if(this.readyState()!==WebSocket.CLOSED&&this.close("new connection in progress"),this.shouldContinueConnecting=!0,this._isConnectInProgress=!0,t&&this.options.reconnectDelay>0){this.logger.info("Waiting for reconnect delay",f({},this.options)),yield Yt(this.options.reconnectDelay);const t=yield this.options.reconnectHandler(this.reconnectState);if(this.reconnectState.reconnectRetries++,!t)return this._isConnectInProgress=!1,this.emit("error",be()),!1}this._connectionAttemptCount++;try{if(!this.shouldContinueConnecting)return this._isConnectInProgress=!1,this.logger.info("Connection aborted"),!1;const{url:t,connectionCount:e}=yield this.options.connectHandler();if(this.connectStartTime=Date.now(),!this.shouldContinueConnecting)return this._isConnectInProgress=!1,this.logger.info("Connection aborted"),!1;this.logger.info("Connecting websockets",A(f({},this.options),{url:t}));for(let i=0;i<e;i++){const e=new WebSocket(t);e.binaryType="arraybuffer",e.onmessage=t=>this.onMessage(i,t),e.addEventListener("error",this.onError),e.addEventListener("close",this.onClose),e.addEventListener("open",this.onOpen),this.websockets.push(e)}return!0}catch(t){return this._isConnectInProgress=!1,t instanceof de&&(this.logger.error("Failed to connect",t.toStringifiable()),t.isFatal())||this.shouldContinueConnecting&&(this.logger.info("Connection aborted",{error:t}),this.emit("error",new de("Failed to connect",{code:"failed_to_connect",isFatal:!1,source:t,type:"internal"}))),!1}})))),this.options=t,this.logger=e}get isConnectInProgress(){return this._isConnectInProgress}get connectionCount(){return this.websockets.length}get connectionAttemptCount(){return this._connectionAttemptCount}get connectTime(){return this._connectTime}}const bd=t=>471859200/t,wd=class t{constructor(e,i,n){I(this,"emitter"),I(this,"transport"),I(this,"logger"),I(this,"config"),I(this,"rtts",new H(10)),I(this,"lastPingSentTime",Date.now()),I(this,"isPingInFlight",!1),I(this,"connectCount",0),I(this,"missedPings",0),I(this,"_estimatedPingBandwidth"),I(this,"contextSwitchesInProgress",new Set),I(this,"contextSwitchesCompleted",new Set),I(this,"buffer",[]),I(this,"disconnected",new z),I(this,"unload",(()=>{this.logger.debug("Unloading module..."),this.close("Unloading"),this.emitter.off("send signal",this.sendSignal),this.emitter.off("disconnect",this.close),this.emitter.off("reconnect",this.reconnect),this.logger.debug("Unloaded module")})),I(this,"suspend",(()=>{this.resetPingState(),this.transport.suspend()})),I(this,"unsuspend",(()=>{this.transport.unsuspend()})),I(this,"getState",(()=>{switch(this.transport.readyState()){case WebSocket.OPEN:return"connected";case WebSocket.CONNECTING:return"connecting";default:return"disconnected"}})),I(this,"sendSignal",(t=>{this.logger.debug("sending signal",{signal:t}),this.transport.readyState()===WebSocket.OPEN?this.transport.send(JSON.stringify(t)):this.logger.debug("transport is closed")})),I(this,"getStatistics",(()=>{var t;const e=yt(this.rtts.items());return{rtt:e,estimatedBandwidth:bd(e.average),edgeUrl:null==(t=this.transport)?void 0:t.url(),connectionProtocol:"vindral_ws"}})),I(this,"onMessage",((t,e)=>{var i;if(this.pingCooldownExpired()&&this.sendPing(),this.contextSwitchesCompleted.size===(null==(i=this.transport)?void 0:i.connectionCount)){this.logger.info("Completing context switch"),this.contextSwitchesInProgress.clear(),this.contextSwitchesCompleted.clear();const t=this.buffer.filter((([t,e])=>!(e instanceof ArrayBuffer))),e=this.buffer.filter((([t,e])=>e instanceof ArrayBuffer));t.map((t=>this.handleMessage(t[0],t[1]))),e.map((t=>this.handleMessage(t[0],t[1]))),this.buffer=[]}if(this.contextSwitchesInProgress.has(t)){if(!(e instanceof ArrayBuffer)){const i=JSON.parse(e);if(oe(i)&&"context switch complete"===i.type)return this.logger.info("context switch completed",{socketId:t}),this.emitter.emit("context switch complete"),void this.contextSwitchesCompleted.add(t)}this.buffer.push([t,e])}else this.handleMessage(t,e)})),I(this,"resolveEdgeUrl",(()=>B(this,null,(function*(){const t=this.config.connectInfo,e=yield this.config.onConnectInfo(t),i=this.config.options.getOverride("separateVideoSocketEnabled",e.channelId);let n=1;"audio+video"===this.config.options.get("media")&&(n=!1!==i?2:1);const s=((t,e)=>{const i=new URL("/subscribe",t);return i.searchParams.append("channelId",e.channelId),i.searchParams.append("sessionId",e.sessionId),i.searchParams.append("clientId",e.clientId),e.audio&&e.audio.codec&&(i.searchParams.append("audio.bitRate",Math.round(e.audio.bitRate).toString()),i.searchParams.append("audio.codec",e.audio.codec),e.audio.language&&i.searchParams.append("audio.language",e.audio.language)),e.video&&e.video.codec&&(i.searchParams.append("video.width",e.video.width.toString()),i.searchParams.append("video.height",e.video.height.toString()),i.searchParams.append("video.bitRate",Math.round(e.video.bitRate).toString()),i.searchParams.append("video.codec",e.video.codec)),e.expectAdditionalConnection&&i.searchParams.append("expectAdditionalConnection",e.expectAdditionalConnection.toString()),e.burstMs&&i.searchParams.append("burstMs",e.burstMs.toString()),e.channelGroupId&&i.searchParams.append("channelGroupId",e.channelGroupId),e.authToken&&(i.searchParams.append("auth.token",e.authToken),i.searchParams.append("auth.type","jwt")),i.toString()})(this.config.edgeUrl,{video:e.video,audio:e.audio,burstMs:e.burstMs,sessionId:e.sessionId,clientId:e.clientId,channelId:e.channelId,channelGroupId:e.channelGroupId,expectAdditionalConnection:n>1,authToken:this.config.options.get("authenticationToken")});return this.logger.debug("Resolved edge url",{edgeUrl:s}),{url:s,connectionCount:n}})))),I(this,"handleMessage",((t,e)=>{if(e instanceof ArrayBuffer)this.emitter.emit("received data",e);else{const i=JSON.parse(e);if(!oe(i))return;switch(i.type){case"pong":this.lastPingSentTime&&(this.rtts.push(Date.now()-this.lastPingSentTime),this.isPingInFlight=!1,this.emitter.emit("rtt",this.rtt));break;case"context switch":this.logger.info("Starting context switch",{socketId:t}),this.emitter.emit("context switch started"),this.contextSwitchesInProgress.add(t);break;default:this.emitter.emit("received signal",i)}}})),I(this,"connectWebSocketTransport",(()=>{const t=new vd({reconnectDelay:1e3,onMessage:this.onMessage,reconnectHandler:this.config.reconnectHandler,connectHandler:this.resolveEdgeUrl},this.logger.createContext("Transport"));return t.on("open",this.onTransportChange),t.on("close",this.onTransportChange),t.on("error",(t=>this.disconnected.reject(t))),t.connect(),t})),I(this,"close",((t="Disconnect Requested")=>{var e;this.contextSwitchesCompleted.clear(),this.contextSwitchesInProgress.clear(),this.buffer=[],this.resetPingState(),this.disconnected.resolve(),null==(e=this.transport)||e.close(t)})),I(this,"onTransportChange",(()=>{var e;"connected"===this.getState()?(null!=(e=this.transport)&&e.connectTime&&(this.rtts.push(this.transport.connectTime/t.TLS_ROUNDTRIPS/this.transport.connectionCount),this.emitter.emit("rtt",this.rtt)),this.connectCount++,this.resetPingState()):(this.contextSwitchesCompleted.clear(),this.contextSwitchesInProgress.clear(),this.buffer=[],this.resetPingState(),this.disconnected.resolve()),this.emitter.emit("connection state",this.getState())})),I(this,"reconnect",(t=>{this.transport.isConnectInProgress?this.logger.debug("Stopping reconnect, already mid-connection"):this.close(t)})),I(this,"resetPingState",(()=>{this.missedPings=0,this.isPingInFlight=!1})),I(this,"pingCooldownExpired",(()=>Date.now()-this.lastPingSentTime>t.PING_INTERVAL)),I(this,"sendPing",(()=>{if(this.isPingInFlight)return this.missedPings++,void(this.missedPings>t.MAX_MISSED_PINGS&&this.reconnect("missed pings"));this.isPingInFlight=!0,this.lastPingSentTime=Date.now(),this.missedPings=0,this.sendSignal({type:"ping"})})),this._estimatedPingBandwidth=bd(n.estimatedRtt),this.logger=i,this.emitter=e,this.config=n,this.emitter.on("send signal",this.sendSignal),this.emitter.on("disconnect",this.close),this.emitter.on("reconnect",this.reconnect),this.disconnected.promise.catch(G),this.transport=this.connectWebSocketTransport()}get rtt(){return this.rtts.items().length>0?wt(this.rtts.items()):0}get estimatedBandwidth(){return this.rtt>0?bd(this.rtt):this._estimatedPingBandwidth}closed(){return this.disconnected.promise}};I(wd,"PING_INTERVAL",5e3),I(wd,"MAX_MISSED_PINGS",4),I(wd,"TLS_ROUNDTRIPS",3),I(wd,"start",((t,e,i)=>new Promise(((n,s)=>{const r=new wd(t,e,i);r.transport.once("error",(t=>s(t))),r.transport.once("open",(()=>n(r)))}))));let yd=wd;var Sd,kd,Ed,Td,Id,Cd,xd,Md,Ud,Rd,Ld,Pd,Bd;class _d{constructor(t){U(this,Sd),U(this,kd,[]),U(this,Ed),R(this,Sd,t)}select(t){if(M(this,Sd).edgeUrl)return M(this,Sd).edgeUrl;0===M(this,kd).length&&R(this,kd,M(this,kd).concat(t));const e=M(this,kd).shift();return R(this,Ed,e),e||void 0}shiftedEdge(){return M(this,Ed)}reset(){R(this,Ed,void 0),R(this,kd,[])}}Sd=new WeakMap,kd=new WeakMap,Ed=new WeakMap;const Dd=class t{constructor(e,i,n){U(this,Pd),I(this,"emitter"),I(this,"logger"),I(this,"config"),I(this,"apiClient"),I(this,"connectionImpl"),U(this,Td,!0),U(this,Id),U(this,Cd,0),U(this,xd,0),U(this,Md),U(this,Ud),I(this,"unload",(()=>{var t;this.logger.debug("Unloading module..."),this.disconnect("Unloading"),null==(t=this.connectionImpl)||t.unload(),this.logger.debug("Unloaded module")})),I(this,"suspend",(()=>{var t;R(this,Td,!1),null==(t=this.connectionImpl)||t.suspend()})),I(this,"unsuspend",(()=>{var t;R(this,Td,!0),null==(t=this.connectionImpl)||t.unsuspend(),this.connect()})),I(this,"getState",(()=>this.connectionImpl?this.connectionImpl.getState():"disconnected")),I(this,"getStatistics",(()=>this.connectionImpl?A(f({},this.connectionImpl.getStatistics()),{connectCount:M(this,xd),connectionAttemptCount:M(this,Cd)}):{rtt:{min:0,max:0,average:0,last:0},estimatedBandwidth:0,connectCount:M(this,xd),connectionAttemptCount:M(this,Cd),connectionProtocol:void 0})),I(this,"connect",(()=>{R(this,Td,!0),!M(this,Id)&&R(this,Id,L(this,Pd,Bd).call(this))})),I(this,"disconnect",((t="Disconnect Requested")=>{var e;R(this,Td,!1),null==(e=this.connectionImpl)||e.close(t)})),I(this,"reconnect",(t=>{this.disconnect(t),this.connect()})),U(this,Rd,(()=>B(this,null,(function*(){try{return yield this.apiClient.connect(this.config.options.getOptions())}catch(t){if((0,s.d)(t))switch(t.status){case 401:throw this.emitter.emit("error",Ae(t)),Ae(t);case 403:throw this.emitter.emit("error",we(t.message)),we(t.message)}throw this.emitter.emit("error",(t=>new de("Connection attempt failed",{isFatal:!1,code:he,source:t}))(t instanceof Error?t:void 0)),t}})))),U(this,Ld,(()=>B(this,null,(function*(){const e=Date.now(),i=()=>Date.now()-e;return Promise.race([Yt(t.PING_TIMEOUT),fetch(new URL("/api/v4/connect/ping",this.config.options.get("url")).toString(),{method:"HEAD"})]).then(i,i)})))),this.logger=i,this.emitter=e,this.config=n,this.apiClient=new s.A({publicEndpoint:this.config.options.get("url").toString(),tokenFactory:()=>this.config.options.get("authenticationToken")})}get rtt(){var t,e;return null!=(e=null==(t=this.connectionImpl)?void 0:t.rtt)?e:0}get estimatedBandwidth(){var t;return(null==(t=this.connectionImpl)?void 0:t.estimatedBandwidth)||Number.MAX_SAFE_INTEGER}get firstConnectionTime(){return M(this,Md)}get lastConnectionTime(){return M(this,Ud)}};Td=new WeakMap,Id=new WeakMap,Cd=new WeakMap,xd=new WeakMap,Md=new WeakMap,Ud=new WeakMap,Rd=new WeakMap,Ld=new WeakMap,Pd=new WeakSet,Bd=function(){return B(this,null,(function*(){var t;const e=new _d({edgeUrl:this.config.options.get("edgeUrl")});for(R(this,Cd,0);;){P(this,Cd)._++;try{const[t,i]=yield Promise.all([M(this,Rd).call(this),M(this,Ld).call(this)]),n=i/2;if(!M(this,Td))break;const r=e.select(t.edges);if(!r)throw new de("Failed to resolve edge url",{isFatal:!0,code:"failed_to_resolve_edge_url"});(0,s.i)(t)?this.connectionImpl=yield dd.start(this.emitter,this.logger,this.apiClient,A(f({},this.config),{connectInfo:t,estimatedRtt:n,edgeUrl:r})):((0,s.a)("string"==typeof r,"Edge URL is expected to be a string"),this.connectionImpl=yield yd.start(this.emitter,this.logger,A(f({},this.config),{connectInfo:t,estimatedRtt:n,edgeUrl:r}))),e.reset(),P(this,xd)._++,R(this,Cd,0),R(this,Ud,Date.now()),M(this,Md)||R(this,Md,M(this,Ud)),yield this.connectionImpl.closed()}catch(t){this.logger.info("Failed to connect",t);const i=e.shiftedEdge();i&&this.emitter.emit("telemetry event",{code:"shifted_edge",edgeUrl:"string"==typeof i?i:i.moqUrl||i.moqWsUrl}),t instanceof de?this.emitter.emit("error",t):t instanceof Error&&this.emitter.emit("error",new de(t.message,{code:"start_failed",isFatal:!1}))}if(null==(t=this.connectionImpl)||t.unload(),this.connectionImpl=void 0,!M(this,Td))break;if(!(yield this.config.reconnectHandler({reconnectRetries:M(this,Cd)}))){this.emitter.emit("error",be());break}if(yield Yt(1e3),!M(this,Td))break}R(this,Id,void 0)}))},I(Dd,"PING_TIMEOUT",1e3),I(Dd,"create",((t,e,i)=>new Dd(t,e,i)));let Nd=Dd;const Wd=()=>({video:A(f({},ae()),{bitRate:re()}),audio:{bitRate:re()}}),Od=class t{constructor(e,i,n,s){I(this,"emitter"),I(this,"timers",new Zt),I(this,"pictureInPictureSource"),I(this,"element"),I(this,"currentCap"),I(this,"userSpecifiedCap"),I(this,"renditionLevelSource"),I(this,"resizeObserver"),I(this,"elementSize"),I(this,"_sizeBasedResolutionCapEnabled"),I(this,"unload",(()=>{var t;this.emitter.off("enter picture in picture",this.enterPictureInPicture),this.emitter.off("exit picture in picture",this.exitPictureInPicture),null==(t=this.resizeObserver)||t.disconnect(),this.suspend()})),I(this,"load",(()=>{window.ResizeObserver&&(this.resizeObserver=new ResizeObserver(this.onResize),this.resizeObserver.observe(this.element)),this.evaluateConstraintCap()})),I(this,"unsuspend",(()=>{this.timers.setInterval(this.evaluateConstraintCap,t.CHECK_SIZE_INTERVAL),this.evaluateConstraintCap()})),I(this,"suspend",(()=>{this.timers.unload()})),I(this,"setUserSpecifiedCap",(t=>{var e;const i=null!=(e=this.getUserSpecifiedCap())?e:Wd();this.userSpecifiedCap=A(f({},i),{video:f(f({},i.video),t.video),audio:f(f({},i.audio),t.audio)}),this.evaluateConstraintCap()})),I(this,"getUserSpecifiedCap",(()=>this.userSpecifiedCap)),I(this,"getCurrentConstraintCap",(()=>this.currentCap)),I(this,"getStatistics",(()=>({constraintCap:this.getUserSpecifiedCap(),windowInnerWidth:window.innerWidth,windowInnerHeight:window.innerHeight,elementWidth:this.elementSize.width,elementHeight:this.elementSize.height,pixelRatio:window.devicePixelRatio}))),I(this,"constrainSubscription",(t=>{const e=this.getCurrentConstraintCap();return e&&(t.video.codec&&(t.video.bitRate=Math.min(e.video.bitRate,t.video.bitRate),t.video.width=Math.min(e.video.width,t.video.width),t.video.height=Math.min(e.video.height,t.video.height)),t.audio.codec&&(t.audio.bitRate=Math.min(e.audio.bitRate,t.audio.bitRate))),t})),I(this,"onResize",(t=>{t.forEach((t=>{this.elementSize={width:t.contentRect.width,height:t.contentRect.height}}))})),I(this,"evaluateConstraintCap",(()=>{var t,e,i,n,s;const r=this.sizeBasedResolutionCapEnabled?A(f({},Wd()),{video:{width:window.innerWidth,height:window.innerHeight,bitRate:re()}}):Wd();if(!this.resizeObserver){const t=this.element.getBoundingClientRect();this.elementSize={width:t.width,height:t.height}}if(this.sizeBasedResolutionCapEnabled){const e=window.devicePixelRatio,i=null==(t=this.pictureInPictureSource)?void 0:t.getPictureInPictureSize();this.elementSize.width>0&&this.elementSize.height>0&&(r.video.width=this.elementSize.width,r.video.height=this.elementSize.height),i&&(r.video.width=i.width,r.video.height=i.height),r.video.width*=e,r.video.height*=e}const a=this.renditionLevelSource.getRenditionLevels().find((t=>{if(t.video)return t.video.width/t.video.height>r.video.width/r.video.height?t.video.width>r.video.width:t.video.height>r.video.height}));a&&a.video&&(r.video.width=a.video.width,r.video.height=a.video.height);const o=null==(e=this.userSpecifiedCap)?void 0:e.video,l=null==(i=this.userSpecifiedCap)?void 0:i.audio;o&&(r.video.width>o.width&&(r.video.width=o.width),r.video.height>o.height&&(r.video.height=o.height)),r.video.bitRate=null!=(n=null==o?void 0:o.bitRate)?n:r.video.bitRate,r.audio.bitRate=null!=(s=null==l?void 0:l.bitRate)?s:r.audio.bitRate,kt(r,this.currentCap)?this.currentCap=f({},r):(this.currentCap=f({},r),this.emitter.emit("constraint cap changed",r))})),I(this,"enterPictureInPicture",(t=>{this.pictureInPictureSource=t,this.evaluateConstraintCap()})),I(this,"exitPictureInPicture",(()=>{this.pictureInPictureSource=void 0,this.evaluateConstraintCap()})),this.element=i;const r=this.element.getBoundingClientRect();this.elementSize={width:r.width,height:r.height},this.emitter=e,this.renditionLevelSource=n,this._sizeBasedResolutionCapEnabled=s,this.emitter.on("enter picture in picture",this.enterPictureInPicture),this.emitter.on("exit picture in picture",this.exitPictureInPicture)}get sizeBasedResolutionCapEnabled(){return this._sizeBasedResolutionCapEnabled}set sizeBasedResolutionCapEnabled(t){this._sizeBasedResolutionCapEnabled=t,this.evaluateConstraintCap()}};I(Od,"CHECK_SIZE_INTERVAL",1e3),I(Od,"create",((t,e,i,n)=>new Od(t,e,i,n)));let Fd=Od;class Vd{constructor(t,e,i,n){I(this,"timers",Zt.create()),I(this,"logger"),I(this,"emitter"),I(this,"trackContexts"),I(this,"playbackSource"),I(this,"isSuspended",!1),I(this,"load",(()=>{this.timers.setInterval(this.emitDecodedFrames,100),this.timers.setInterval(this.emitDecodeRate,1e3),this.emitter.on("init segment",this.onInitSegment),this.emitter.on("coded sample",this.decode)})),I(this,"unload",(()=>{this.trackContexts.forEach((({decoderContext:t})=>t.unload())),this.timers.unload(),this.emitter.off("init segment",this.onInitSegment),this.emitter.off("coded sample",this.decode)})),I(this,"suspend",(()=>{this.isSuspended=!0})),I(this,"unsuspend",(()=>{this.isSuspended=!1})),I(this,"getBuffer",(t=>{var e;return null==(e=this.trackContexts.get(t))?void 0:e.buffer})),I(this,"videoDecodeRate",(()=>{var t,e,i;const n=this.trackContexts.get("video"),s=null!=(t=null==n?void 0:n.sampleDuration)?t:40,r=yt(null!=(e=null==n?void 0:n.decodeTime.items())?e:[]),a=yt(null!=(i=null==n?void 0:n.transportTime.items())?i:[]);return s/(r.average+a.average)})),I(this,"getStatistics",(()=>{var t,e,i,n;const s=this.trackContexts.get("video"),r=yt(null!=(t=null==s?void 0:s.decodeTime.items())?t:[]),a=yt(null!=(e=null==s?void 0:s.transportTime.items())?e:[]),o=yt(null!=(n=null==(i=this.trackContexts.get("audio"))?void 0:i.decodeTime.items())?n:[]);return{videoDecodeRate:this.videoDecodeRate(),videoDecodeTime:r,audioDecodeTime:o,videoTransportTime:a}})),I(this,"onInitSegment",(({initSegment:t})=>{var e;const i=null==(e=this.trackContexts.get(t.type))?void 0:e.decoderContext;if(!i)throw new de("No known decoder context",{code:"no_known_decoder_context",isFatal:!1});i.initSegment(t)})),I(this,"decode",(t=>{const e=this.trackContexts.get(t.type);if(!e)throw new de("No known decoder context",{code:"no_known_decoder_context",isFatal:!1});if(this.isSuspended)return;e.sampleDuration=t.duration/t.timescale*1e3;const{decoderContext:i,buffer:n}=e,s=t.timestamp/t.timescale*1e3,r=t.duration/t.timescale*1e3,a=n[n.length-1];!a||s-5>a.end?n.push({start:s,end:s+r}):s+5*r<a.end?e.buffer=[{start:s,end:s+r}]:a.end=s+r,i.enqueue(t),this.emitDecodedFrames()})),I(this,"emitDecodedFrames",(()=>{let t;this.updateBufferState(),this.trackContexts.forEach((e=>{var i,n;let s;for(;void 0!==(s=null==(n=(i=e.decoderContext).error)?void 0:n.call(i));)this.emitter.emit("error",ue(!1,s));for(;void 0!==(t=e.decoderContext.take());){const{statistics:i}=t;i&&(e.decodeTime.push(i.decodeTime),e.transportTime.push((i.transportTimeToWorker+i.transportTimeFromWorker)/i.samplesInBatch)),this.emitter.emit("decoded frame",t)}}))})),I(this,"emitDecodeRate",(()=>{this.emitter.emit("video decode rate",this.videoDecodeRate())})),I(this,"updateBufferState",(()=>{var t,e;let i;if(this.trackContexts.forEach((t=>{var e,n,s,r;if(i){const a=null!=(n=null==(e=t.buffer[t.buffer.length-1])?void 0:e.end)?n:0;(null!=(r=null==(s=i[i.length-1])?void 0:s.end)?r:0)>a&&(i=t.buffer)}else i=t.buffer})),!i)return;const n=this.playbackSource.currentTime<(null!=(e=null==(t=i[i.length-1])?void 0:t.end)?e:0)?"playing":"buffering";this.emitter.emit("buffer state",{buffered:i,currentTime:this.playbackSource.currentTime,isPaused:this.playbackSource.isPaused,playbackState:n})})),this.logger=e,this.emitter=t,this.trackContexts=i,this.playbackSource=n}static create(t,e,n,s,r){return B(this,null,(function*(){const a=new Map;for(const t of n)switch(t.type){case"audio":{const{OpusDecoderContext:e}=yield i.e(597).then(i.bind(i,8597));a.set(t.type,{buffer:[],decoderContext:yield e.create(48e3,2),decodeTime:new H(100),transportTime:new H(100),sampleDuration:40});break}case"video":{const{H264DecoderWorkerContext:e}=yield i.e(790).then(i.bind(i,2790));a.set(t.type,{buffer:[],decoderContext:yield e.create(r),decodeTime:new H(100),transportTime:new H(100),sampleDuration:40});break}}return new Vd(t,e,a,s)}))}}const Gd=class{constructor(t){I(this,"emitter"),I(this,"isVisibleCount",0),I(this,"isHiddenCount",0),I(this,"isOnlineCount",0),I(this,"isOfflineCount",0),I(this,"isActive","visible"===document.visibilityState),I(this,"unload",(()=>{document.removeEventListener("visibilitychange",this.onVisibilityChanged),window.removeEventListener("pagehide",this.onPageHide),window.removeEventListener("online",this.onOnline),window.removeEventListener("offline",this.onOffline)})),I(this,"load",(()=>{document.addEventListener("visibilitychange",this.onVisibilityChanged),window.addEventListener("pagehide",this.onPageHide),window.addEventListener("online",this.onOnline),window.addEventListener("offline",this.onOffline)})),I(this,"unsuspend",(()=>{})),I(this,"getStatistics",(()=>{var t,e,i,n,s;return{isVisible:this.isVisible,isOnline:this.isOnline,isVisibleCount:this.isVisibleCount,isHiddenCount:this.isHiddenCount,isOnlineCount:this.isOnlineCount,isOfflineCount:this.isOfflineCount,navigatorRtt:null==(t=navigator.connection)?void 0:t.rtt,navigatorEffectiveType:null==(e=navigator.connection)?void 0:e.effectiveType,navigatorConnectionType:null==(i=navigator.connection)?void 0:i.type,navigatorSaveData:null==(n=navigator.connection)?void 0:n.saveData,navigatorDownlink:null==(s=navigator.connection)?void 0:s.downlink}})),I(this,"onOnline",(()=>this.isOnlineCount++)),I(this,"onOffline",(()=>this.isOfflineCount++)),I(this,"onPageHide",(t=>this.emitter.emit("pagehide",t))),I(this,"onVisibilityChanged",(()=>{this.setIsActive("visible"===document.visibilityState)})),I(this,"setIsActive",(t=>{t!==this.isActive&&(this.emitter.emit("page active",t),t?this.isVisibleCount++:this.isHiddenCount++),this.isActive=t})),this.emitter=t}get isOnline(){return navigator.onLine}get isVisible(){return"visible"===document.visibilityState}};I(Gd,"create",(t=>new Gd(t)));let zd=Gd;const Hd=class t{constructor(e,i,n){I(this,"logger"),I(this,"emitter"),I(this,"waitingEvents",[]),I(this,"isTriggered",(t=>(e,i,n)=>e.timestamp<=i||e.timestampAdded<=n-t)(t.EVENT_TIMEOUT)),I(this,"timeSource"),I(this,"timers",new Zt),I(this,"load",(()=>{this.timers.setInterval(this.onBufferedStateChanged,t.EVENT_CHECK_INTERVAL),this.emitter.on("add event",this.addEvent)})),I(this,"unload",(()=>{this.timers.unload(),this.emitter.off("add event",this.addEvent)})),I(this,"addEvent",(t=>{this.logger.debug("Adding event",{event:t}),!this.waitingEvents.some((e=>void 0!==e.id&&e.id===t.id))&&this.waitingEvents.push(A(f({},t),{timestampAdded:Date.now()}))})),I(this,"extractEvent",((t,e)=>{"video"===e.type&&t.channelId!==e.channelId&&this.addEvent({type:"channel switch",channelId:e.channelId,timestamp:e.timestamp/e.timescale*1e3}),"audio"===e.type&&"audio"===t.type&&void 0!==e.language&&e.language!==t.language&&this.addEvent({type:"language switch",language:e.language,timestamp:e.timestamp/e.timescale*1e3})})),I(this,"onBufferedStateChanged",(()=>{var t;const e=Date.now(),i=null!=(t=this.timeSource.drift)?t:0,n=this.timeSource.serverCurrentTime-i;if(0===this.waitingEvents.length)return;const s=this.waitingEvents.filter((t=>this.isTriggered(t,n,e)));this.waitingEvents=this.waitingEvents.filter((t=>!this.isTriggered(t,n,e))),s.forEach((t=>{this.logger.debug("Emitting event",{event:t}),this.emitter.emit("event",t)}))})),this.logger=i,this.emitter=e,this.timeSource=n}};I(Hd,"EVENT_TIMEOUT",5e3),I(Hd,"EVENT_CHECK_INTERVAL",20),I(Hd,"create",((t,e,i)=>new Hd(t,e,i)));let jd=Hd;const Xd=class t{constructor(e){I(this,"emitter"),I(this,"timers",Zt.create()),I(this,"bytesReceived",new Map),I(this,"timeoutInterval"),I(this,"lastBytesUpdated",Date.now()),I(this,"load",(()=>{this.emitter.on("connection state",this.onConnectionState),this.timers.setInterval((()=>this.bytesReceived.forEach((t=>t.tick()))),100)})),I(this,"unload",(()=>{this.emitter.off("connection state",this.onConnectionState),this.timers.unload()})),I(this,"averageBitRate",(t=>{var e,i;return 8*(null!=(i=null==(e=this.bytesReceived.get(t))?void 0:e.average)?i:0)})),I(this,"totalBytesReceived",(()=>{let t=0;return this.bytesReceived.forEach((e=>{t+=e.total})),t})),I(this,"add",((e,i)=>{let n=this.bytesReceived.get(e);n||(n=new St(20),this.bytesReceived.set(e,n)),i>0&&(this.lastBytesUpdated=Date.now(),this.timeoutInterval||(this.timeoutInterval=this.timers.setInterval(this.checkTimeout,t.UPDATE_RECEIVED_BYTES_INTERVAL))),n.add(i)})),I(this,"getStatistics",(()=>({bytesReceived:this.totalBytesReceived(),videoBitRate:this.averageBitRate("video"),audioBitRate:this.averageBitRate("audio")}))),I(this,"onConnectionState",(e=>{this.clearTimeoutInterval(),"connected"===e&&(this.lastBytesUpdated=Date.now(),this.timeoutInterval=this.timers.setInterval(this.checkTimeout,t.UPDATE_RECEIVED_BYTES_INTERVAL))})),I(this,"checkTimeout",(()=>{const e=Date.now()-this.lastBytesUpdated;if(0===this.totalBytesReceived()&&e>t.NO_DATA_ERROR_TIMEOUT)return this.emitter.emit("error",new de("No Incoming Data",{isFatal:!1,code:"no_incoming_data_error",source:void 0})),this.emitter.emit("reconnect","no incoming data"),void this.clearTimeoutInterval();e>t.NO_DATA_TIMEOUT&&this.totalBytesReceived()>0&&(this.emitter.emit("no data timeout",this.totalBytesReceived()),this.clearTimeoutInterval())})),I(this,"clearTimeoutInterval",(()=>{this.timeoutInterval&&(this.timers.clearInterval(this.timeoutInterval),this.timeoutInterval=void 0)})),this.emitter=e}};I(Xd,"NO_DATA_ERROR_TIMEOUT",2e4),I(Xd,"NO_DATA_TIMEOUT",5e3),I(Xd,"UPDATE_RECEIVED_BYTES_INTERVAL",1e3),I(Xd,"create",(t=>new Xd(t)));let qd=Xd;const Qd=class t extends n.E{constructor(){super(),I(this,"context",new(window.AudioContext||window.webkitAudioContext)),I(this,"timers",Zt.create()),I(this,"previousCurrentTime",0),I(this,"_isStuck",!1),I(this,"mediaStreamDestination"),I(this,"unload",(()=>(this.timers.unload(),this.context.removeEventListener("statechange",this.onStateChange),"closed"!==this.context.state?this.context.close():Promise.resolve()))),I(this,"createGain",(()=>this.context.createGain())),I(this,"createBuffer",((t,e,i)=>this.context.createBuffer(t,e,i))),I(this,"createBufferSource",(()=>this.context.createBufferSource())),I(this,"getMediaStreamDestination",(()=>(this.mediaStreamDestination||(this.mediaStreamDestination=this.context.createMediaStreamDestination()),this.mediaStreamDestination))),I(this,"getDefaultDestination",(()=>this.context.destination)),I(this,"createSplitter",(()=>this.context.createChannelSplitter(2))),I(this,"resume",(()=>B(this,null,(function*(){try{return yield Promise.race([this.context.resume(),te(1e3,new de("Web Audio Context resume timeout",{isFatal:!1,code:"web_audio_context_resume_timeout"}))])}catch(t){throw this.suspend().catch(G),t}})))),I(this,"suspend",(()=>B(this,null,(function*(){var t;yield null!=(t=this.context.suspend())?t:Promise.resolve()})))),I(this,"onStateChange",(()=>this.emit("state",this.state))),this.context.addEventListener("statechange",this.onStateChange),this.timers.setInterval((()=>{this._isStuck=this.isRunning&&this.context.currentTime===this.previousCurrentTime,this._isStuck&&this.emit("stuck"),this.previousCurrentTime=this.context.currentTime}),t.CHECK_INTERVAL)}get isStuck(){return this._isStuck}get isRunning(){return"running"===this.state}get currentTime(){return this.context.currentTime}get sampleRate(){return this.context.sampleRate}get state(){return this.context.state}};I(Qd,"CHECK_INTERVAL",1e3);let $d=Qd;const Zd=class extends n.E{constructor(t,e,{muted:i,reInitWhenStuck:n}){super(),I(this,"logger"),I(this,"audio"),I(this,"gainNode"),I(this,"splitter"),I(this,"_volume",1),I(this,"_userProvidedMuted",!1),I(this,"_muted",!1),I(this,"startTime",0),I(this,"samples",new Float32Array(new ArrayBuffer(38400))),I(this,"preInitSampleQueue",new H(500)),I(this,"unplayedBufferSources",new H(100)),I(this,"sampleRate",48e3),I(this,"channels",2),I(this,"index",0),I(this,"clockSource"),I(this,"clockDelta"),I(this,"startTimeIsInvalidated",!0),I(this,"lastSampleTimestamp",0),I(this,"reInitWhenStuck"),I(this,"ignoreSuspendCalls",!1),I(this,"isActivated",!1),I(this,"unload",(()=>B(this,null,(function*(){var t,e;null==(t=this.gainNode)||t.disconnect(),yield null==(e=this.audio)?void 0:e.unload(),this.reset(),this.audio=void 0,this.gainNode=void 0})))),I(this,"suspend",(()=>{this.setGain(0)})),I(this,"unsuspend",(()=>{var t;this.setGain(this._volume),this.ignoreSuspendCalls=!!this.audio,null==(t=this.audio)||t.suspend().then((()=>B(this,null,(function*(){yield this.resume(),this.ignoreSuspendCalls=!1})))).catch((()=>{this.ignoreSuspendCalls=!1,this.emit("state change","suspended")}))})),I(this,"flush",(()=>{if(!this.audio||!this.gainNode)throw new de("AudioContext must be initialized to flush",{isFatal:!1,code:"audiocontext_must_be_initialized"});const t=this.samples.length/this.channels,e=this.audio.createBufferSource(),i=this.audio.createBuffer(this.channels,t,this.sampleRate);let n=0;for(let e=0;e<this.channels;e++){n=e;const s=i.getChannelData(e);for(let e=0;e<t;e++)s[e]=this.samples[n],n+=this.channels}const s=Math.max(this.startTime,0);e.buffer=i,e.connect(this.gainNode),this.splitter&&e.connect(this.splitter),e.start(s),this.unplayedBufferSources.push([s,e]),this.startTime+=i.duration})),I(this,"onDecodedFrame",(t=>{if(this.gainNode&&this.audio&&this.audio.isRunning){for(;!this.preInitSampleQueue.isEmpty();){const t=this.preInitSampleQueue.items();this.preInitSampleQueue.clear(),t.forEach(this.onDecodedFrame)}if(this.unplayedBufferSources.filterPop((([t,e])=>{var i,n;return(null!=(n=null==(i=this.audio)?void 0:i.currentTime)?n:0)<t})),"audio"===t.type){const e=t.timestamp/t.timescale*1e3;if(e<this.lastSampleTimestamp&&(this.logger.info("Unordered timestamp - invalidating start time"),this.startTimeIsInvalidated=!0),this.lastSampleTimestamp=e,this.startTimeIsInvalidated){const t=1e3*this.audio.currentTime,i=this.clockSource.currentTime,n=(t+e-i)/1e3;this.clockDelta=i-t,this.startTime=n,this.startTimeIsInvalidated=!1,this.unplayedBufferSources.items().forEach((([t,e])=>{n<=t&&e.stop()}))}this.samples.set(t.data,this.index),this.index+=t.data.length,this.channels=t.channels,this.sampleRate=t.sampleRate,this.samples.length<=this.index&&(this.index=0,this.flush())}}else if("audio"===t.type){this.preInitSampleQueue.push(A(f({},t),{data:t.data.slice(0,t.data.length)}));const e=this.clockSource.currentTime;this.preInitSampleQueue.filterPop((({timestamp:t,timescale:i})=>t/i*1e3>e))}})),I(this,"play",(()=>B(this,null,(function*(){this.audio=this.getAudioContext(),yield this.resume()})))),I(this,"pause",(()=>{})),I(this,"flushBuffer",(()=>{this.unplayedBufferSources.items().forEach((([t,e])=>e.stop())),this.index=0})),I(this,"resume",(()=>B(this,null,(function*(){var t;if(!this._userProvidedMuted)try{yield null==(t=this.audio)?void 0:t.resume(),this._muted=this._userProvidedMuted,this.startTimeIsInvalidated=!0}catch(t){throw this._muted=!0,t}})))),I(this,"getAudioContext",(()=>this.audio?this.audio:this.setupContext())),I(this,"setupContext",(()=>{var t,e,i;return null==(t=this.audio)||t.unload(),this.audio=new $d,this.audio.on("state",(t=>{this.logger.info("AudioContext state change",{state:t}),"running"===t&&(this._muted=this._userProvidedMuted,this.setGain(this._volume)),!this.ignoreSuspendCalls&&this.emit("state change",t)})),this.audio.on("stuck",(()=>{this.reInitWhenStuck&&(this.logger.info("Re-init audio context"),this.setupContext(),this.resume().catch(G),this.emit("stuck"))})),null==(e=this.gainNode)||e.disconnect(),this.gainNode=this.audio.createGain(),this.setGain(this._volume),this.startTime=this.audio.currentTime,null==(i=this.splitter)||i.disconnect(),this.splitter=this.audio.createSplitter(),this.audio})),I(this,"setGain",(t=>{this.gainNode&&(this.gainNode.gain.value=this._muted?0:t)})),this._muted=i,this._userProvidedMuted=i,this.logger=t,this.clockSource=e,this.reInitWhenStuck=n}get isContextRunning(){var t;return"running"===(null==(t=this.audio)?void 0:t.state)}get volume(){return this._volume}set volume(t){this._volume=t,this.muted||this.setGain(t)}get seekTime(){return 0}get isSeeking(){return!1}get muted(){var t;return this._muted||!(null!=(t=this.audio)&&t.isRunning)}set muted(t){this._userProvidedMuted=t,this._muted=t,this.setGain(this._volume)}get isPaused(){return!1}get currentTime(){var t;return this.audio&&this.audio.isRunning&&!this.audio.isStuck?1e3*this.audio.currentTime+(null!=(t=this.clockDelta)?t:0):this.clockSource.currentTime}set currentTime(t){this.logger.debug("setting current time to",{currentTime:t}),this.startTimeIsInvalidated=!0}get audioNode(){return this.splitter}useMediaStreamDestination(){var t;const e=this.getAudioContext().getMediaStreamDestination();return null==(t=this.gainNode)||t.connect(e),e}useDefaultDestination(){var t;const e=this.getAudioContext().getDefaultDestination();return null==(t=this.gainNode)||t.connect(e),e}};I(Zd,"create",((t,e,i)=>new Zd(t,e,i)));let Kd=Zd;var Jd;class Yd{constructor(){U(this,Jd,[]),R(this,Jd,[])}addTextTrack(t,e,i){const n=[],s={kind:t,label:e,language:i,mode:"disabled",cues:n,addCue:t=>{n.push(t)},removeCue:t=>{const e=n.findIndex((e=>e===t));-1!==e&&n.splice(e,1)}};return M(this,Jd).push(s),s}set language(t){M(this,Jd).forEach((e=>{e.language===t?e.mode="showing":e.mode="hidden"}))}get language(){var t;return null==(t=M(this,Jd).find((t=>"showing"===t.mode)))?void 0:t.language}getActiveCues(t){const e=M(this,Jd).find((t=>"showing"===t.mode));return e?e.cues.filter((({startTime:e,endTime:i})=>t>=e&&t<=i)):[]}}Jd=new WeakMap;const tu=(t,e)=>{let i;for(i=e;t>1;t--)i+=e;return i};class eu{constructor(){I(this,"audio"),I(this,"unmute",(()=>this.audio.play().catch(G)));const t=document.createElement("div");t.innerHTML="<audio x-webkit-airplay='deny'></audio>";const e=t.children.item(0);if(!(e instanceof HTMLAudioElement))throw new Error("Failed to create audio tag");this.audio=e,this.audio.controls=!1,this.audio.disableRemotePlayback=!0,this.audio.preload="auto",this.audio.src="data:audio/mpeg;base64,//uQx"+tu(23,"A")+"WGluZwAAAA8AAAACAAACcQCA"+tu(16,"gICA")+tu(66,"/")+"8AAABhTEFNRTMuMTAwA8MAAAAAAAAAABQgJAUHQQAB9AAAAnGMHkkI"+tu(320,"A")+"//sQxAADgnABGiAAQBCqgCRMAAgEAH"+tu(15,"/")+"7+n/9FTuQsQH//////2NG0jWUGlio5gLQTOtIoeR2WX////X4s9Atb/JRVCbBUpeRUq"+tu(18,"/")+"9RUi0f2jn/+xDECgPCjAEQAABN4AAANIAAAAQVTEFNRTMuMTAw"+tu(97,"V")+"Q==",this.audio.loop=!1,this.audio.load()}}var iu,nu,su,ru,au,ou,lu,hu;class cu{constructor(){U(this,au),U(this,iu,[]),U(this,nu,document.createElement("canvas")),U(this,su),U(this,ru,window.devicePixelRatio||1),I(this,"config",{backgroundColor:"rgba(0,0,0,0.6)",textPadding:8,fontSize:"28px",lineGap:16});const t=M(this,nu).getContext("2d",{alpha:!0});if(!t)throw new Error("Failed to create 2d context");R(this,su,t),L(this,au,lu).call(this)}get canvas(){return M(this,nu)}setActiveCues(t){R(this,iu,t)}render(t,e=!1){const i=M(this,iu).flatMap((e=>e.text.split("\n").flatMap((e=>L(this,au,hu).call(this,e,t.width))).map((t=>{L(this,au,lu).call(this);const e=M(this,su).measureText(t);return{text:t,measurement:e,size:{height:e.fontBoundingBoxAscent+e.fontBoundingBoxDescent+2*this.config.textPadding,width:e.width+2*this.config.textPadding}}})))),n=Math.max(...i.map((t=>t.size.width))),s=i.reduce(((t,{size:e})=>t+e.height),0)+(i.length-1)*this.config.lineGap;let r=0;L(this,au,ou).call(this,n,s),M(this,su).clearRect(0,0,M(this,nu).width,M(this,nu).height);for(const{size:t,text:e}of i)L(this,au,lu).call(this),M(this,su).fillStyle=this.config.backgroundColor,M(this,su).fillRect(0,r,t.width,t.height),L(this,au,lu).call(this),M(this,su).fillText(e,this.config.textPadding,r+this.config.textPadding),r+=t.height+this.config.lineGap;e&&(M(this,su).strokeStyle="red",M(this,su).strokeRect(0,0,t.width,M(this,nu).height))}}iu=new WeakMap,nu=new WeakMap,su=new WeakMap,ru=new WeakMap,au=new WeakSet,ou=function(t,e){M(this,nu).width=t*M(this,ru),M(this,nu).height=e*M(this,ru),M(this,su).scale(M(this,ru),M(this,ru)),this.canvas.style.width=`${t}px`,this.canvas.style.height=`${e}px`},lu=function(){M(this,su).fillStyle="white",M(this,su).textAlign="left",M(this,su).textBaseline="top",M(this,su).font=`${this.config.fontSize} sans-serif`},hu=function(t,e){const i=[],n=t.split(" ");let s="";for(;n.length>0;){L(this,au,lu).call(this);let t=0;for(;M(this,su).measureText(s+(s.length>0?" ":"")+n[0]).width+2*this.config.textPadding<=e&&n.length>0;)t++,s+=(s.length>0?" ":"")+n.shift();0!=t?(i.push(s),s=""):(i.push(n.shift()||""),s="")}return i};const du=(t,e)=>{let i=t.getContext("webgl",e);if(i||(i=t.getContext("experimental-webgl",e)),!i)throw new de("Failed to create webgl context",{isFatal:!0,code:"failed_to_create_web_gl_context"});return i},uu=(t,e,i)=>{const n=t.createShader(e);if(!n)throw new de("Failed to create shader",{isFatal:!0,code:"failed_to_create_shader"});if(t.shaderSource(n,i),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS)){const e=t.getShaderInfoLog(n);throw new de(`Failed to compile shader: ${null!=e?e:""}`,{isFatal:!0,code:"failed_to_compile_shader"})}return n},mu=t=>{const e=t.createTexture();if(!e)throw new de("Failed to create texture",{isFatal:!0,code:"failed_to_create_texture"});return t.bindTexture(t.TEXTURE_2D,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),e},pu=(t,e)=>{const i=t.createBuffer();if(!i)throw new de("Failed to create buffer",{isFatal:!0,code:"failed_to_create_buffer"});return t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,e.buffer,t.STATIC_DRAW),i},gu=(t,e,i)=>{const n=t.createProgram();if(!n)throw new de("Failed to create program",{isFatal:!0,code:"failed_to_create_program"});if(t.attachShader(n,i),t.attachShader(n,e),t.linkProgram(n),!t.getProgramParameter(n,t.LINK_STATUS)){const e=t.getShaderInfoLog(n);throw new de(`Failed to link program: ${null!=e?e:""}`,{isFatal:!0,code:"failed_to_link_program"})}return n};var fu,Au,vu,bu,wu,yu,Su,ku,Eu,Tu;class Iu{constructor(t){U(this,Su),U(this,fu,96),U(this,Au),U(this,vu),U(this,bu),U(this,wu),U(this,yu),I(this,"subtitleRenderer",new cu),U(this,Tu,((t,e,i,n)=>[t,0,0,0,0,-e,0,0,0,0,1,0,i,n,0,1])),R(this,Au,t),R(this,vu,mu(t)),R(this,bu,uu(t,t.FRAGMENT_SHADER,"\nprecision mediump float;\nuniform sampler2D texture;\n\nvarying vec2 texture_coordinate;\n\nvoid main() {\n  float y = texture2D(texture, texture_coordinate).r;\n  float a = texture2D(texture, texture_coordinate).a;\n\n  gl_FragColor = vec4(y, y, y, a);\n}\n")),R(this,wu,uu(t,t.VERTEX_SHADER,"\n  attribute vec2 position;\n  varying vec2 texture_coordinate;\n  uniform mat4 model;\n\n  void main() {\n    texture_coordinate = position;\n    gl_Position = model * vec4(position, 0.0, 1.0);\n  }\n")),R(this,yu,gu(t,M(this,wu),M(this,bu))),this.subtitleRenderer.config.fontSize="64px"}setActiveCues(t,e){this.subtitleRenderer.setActiveCues(t),this.subtitleRenderer.render(e)}render(t){const e=this.subtitleRenderer.canvas,i=(t.padding+M(this,fu))*window.devicePixelRatio;0!==e.width&&(M(this,Au).useProgram(M(this,yu)),L(this,Su,ku).call(this),L(this,Su,Eu).call(this,this.subtitleRenderer.canvas.width/t.width,this.subtitleRenderer.canvas.height/t.height,-this.subtitleRenderer.canvas.width/t.width/2,-(1-(this.subtitleRenderer.canvas.height+i)/t.height)),M(this,Au).uniform1i(M(this,Au).getUniformLocation(M(this,yu),"texture"),4),M(this,Au).activeTexture(M(this,Au).TEXTURE4),M(this,Au).bindTexture(M(this,Au).TEXTURE_2D,M(this,vu)),M(this,Au).enable(M(this,Au).BLEND),M(this,Au).blendFunc(M(this,Au).SRC_ALPHA,M(this,Au).ONE_MINUS_SRC_ALPHA),M(this,Au).texImage2D(M(this,Au).TEXTURE_2D,0,M(this,Au).RGBA,M(this,Au).RGBA,M(this,Au).UNSIGNED_BYTE,e),M(this,Au).texParameteri(M(this,Au).TEXTURE_2D,M(this,Au).TEXTURE_MAG_FILTER,M(this,Au).LINEAR),M(this,Au).drawArrays(M(this,Au).TRIANGLE_STRIP,0,4))}}fu=new WeakMap,Au=new WeakMap,vu=new WeakMap,bu=new WeakMap,wu=new WeakMap,yu=new WeakMap,Su=new WeakSet,ku=function(){const t=M(this,Au).getAttribLocation(M(this,yu),"position");M(this,Au).enableVertexAttribArray(t),M(this,Au).vertexAttribPointer(t,2,M(this,Au).FLOAT,!1,0,0)},Eu=function(t,e,i,n){const s=M(this,Au).getUniformLocation(M(this,yu),"model");M(this,Au).uniformMatrix4fv(s,!1,M(this,Tu).call(this,t,e,i,n))},Tu=new WeakMap;const Cu="\nprecision mediump float;\nuniform sampler2D y_texture;\nuniform sampler2D u_texture;\nuniform sampler2D v_texture;\nuniform mat4 conversion;\n\nvarying vec2 texture_coordinate;\n\nvoid main() {\n  float y = texture2D(y_texture, texture_coordinate).r;\n  float u = texture2D(u_texture, texture_coordinate).r;\n  float v = texture2D(v_texture, texture_coordinate).r;\n\n  gl_FragColor = vec4(y, u, v, 1) * conversion;\n}\n",xu="\n  attribute vec2 position;\n  varying vec2 texture_coordinate;\n  uniform mat4 model;\n\n  void main() {\n    texture_coordinate = position;\n    gl_Position = model * vec4(position, 0.0, 1.0);\n  }\n",Mu={width:256,codedWidth:256,height:144,codedHeight:144},Uu={preserveDrawingBuffer:!1,alpha:!1,depth:!1,stencil:!1,antialias:!1,premultipliedAlpha:!1},Ru=class t extends n.E{constructor(){super(),I(this,"canvas",document.createElement("canvas")),I(this,"context",du(this.canvas,Uu)),I(this,"pixelShader",uu(this.context,this.context.FRAGMENT_SHADER,Cu)),I(this,"vertexShader",uu(this.context,this.context.VERTEX_SHADER,xu)),I(this,"buffer",pu(this.context,t.SQUARE_VERTICES)),I(this,"program",gu(this.context,this.vertexShader,this.pixelShader)),I(this,"textures",{y:mu(this.context),u:mu(this.context),v:mu(this.context)}),I(this,"textRenderer"),I(this,"size",Mu),I(this,"onContextLost",(t=>{this.textRenderer=void 0;const e=new Error(t instanceof WebGLContextEvent?t.statusMessage:"webgl context lost");this.emit("context lost",(t=>new de("WebGL Context Lost",{isFatal:!1,code:"webgl_context_lost_error",source:t,type:"internal"}))(e)),t.preventDefault()})),I(this,"onContextRestored",(()=>{this.emit("context restored"),this.context=du(this.canvas,Uu),this.pixelShader=uu(this.context,this.context.FRAGMENT_SHADER,Cu),this.vertexShader=uu(this.context,this.context.VERTEX_SHADER,xu),this.buffer=pu(this.context,t.SQUARE_VERTICES),this.program=gu(this.context,this.vertexShader,this.pixelShader),this.textures={y:mu(this.context),u:mu(this.context),v:mu(this.context)},this.load()})),I(this,"load",(()=>{this.context.useProgram(this.program),this.setupPositionVertexAttributes(),this.setSize(Mu),this.context.uniform1i(this.context.getUniformLocation(this.program,"y_texture"),0),this.context.uniform1i(this.context.getUniformLocation(this.program,"u_texture"),1),this.context.uniform1i(this.context.getUniformLocation(this.program,"v_texture"),2),this.setConversionMatrix(this.rec709())})),I(this,"unload",(()=>{var t;this.setSize({width:1,height:1,codedHeight:1,codedWidth:1}),[this.textures.y,this.textures.u,this.textures.v].forEach((t=>this.context.deleteTexture(t))),this.context.deleteShader(this.pixelShader),this.context.deleteShader(this.vertexShader),this.context.deleteProgram(this.program),this.context.deleteBuffer(this.buffer),this.canvas.removeEventListener("webglcontextlost",this.onContextLost),this.canvas.removeEventListener("webglcontextrestored",this.onContextRestored),null==(t=this.context.getExtension("WEBGL_lose_context"))||t.loseContext()})),I(this,"resetSize",(()=>{this.setSize({width:this.size.width/2,height:this.size.height/2,codedHeight:this.size.codedHeight/2,codedWidth:this.size.codedWidth/2})})),I(this,"render",((t,e)=>{var i;this.context.useProgram(this.program),this.setSize({width:t.width,height:t.height,codedWidth:t.codedWidth,codedHeight:t.codedHeight}),this.setConversionMatrix(this.rec709()),this.setModelMatrix(this.size.width/this.size.codedWidth,this.size.height/this.size.codedHeight),this.context.activeTexture(this.context.TEXTURE0),this.updateTexture(this.textures.y,this.size.codedWidth,this.size.codedHeight,t.data[0]),this.context.activeTexture(this.context.TEXTURE1),this.updateTexture(this.textures.u,this.size.codedWidth/2,this.size.codedHeight/2,t.data[1]),this.context.activeTexture(this.context.TEXTURE2),this.updateTexture(this.textures.v,this.size.codedWidth/2,this.size.codedHeight/2,t.data[2]),this.context.drawArrays(this.context.TRIANGLE_STRIP,0,4),this.textRenderer&&this.textRenderer.render({width:Math.max(e.clientWidth,960)*window.devicePixelRatio,height:Math.max(e.clientHeight,540)*window.devicePixelRatio,padding:-parseInt(null!=(i=e.style.getPropertyValue("--vindral-control-bar-offset"))?i:"0",10)})})),I(this,"updateTexture",((t,e,i,n)=>{const s=this.context.LUMINANCE,r=this.context.UNSIGNED_BYTE;this.context.bindTexture(this.context.TEXTURE_2D,t),this.context.texImage2D(this.context.TEXTURE_2D,0,s,e,i,0,s,r,n)})),I(this,"setupPositionVertexAttributes",(()=>{const t=this.context.getAttribLocation(this.program,"position");this.context.enableVertexAttribArray(t),this.context.vertexAttribPointer(t,2,this.context.FLOAT,!1,0,0)})),I(this,"setSize",(t=>{kt(t,this.size)||(this.size=t,this.canvas.setAttribute("width",t.width.toString()),this.canvas.setAttribute("height",t.height.toString()),this.context.viewport(0,0,t.width,t.height),this.setModelMatrix(t.width/t.codedWidth,t.height/t.codedHeight))})),I(this,"setModelMatrix",((t,e)=>{const i=this.context.getUniformLocation(this.program,"model");this.context.uniformMatrix4fv(i,!1,this.transformMatrix(t,e))})),I(this,"setConversionMatrix",(t=>{const e=this.context.getUniformLocation(this.program,"conversion");this.context.uniformMatrix4fv(e,!1,t)})),I(this,"transformMatrix",((t,e)=>[2/t,0,0,0,0,-2/e,0,0,0,0,2,0,-1,1,0,1])),I(this,"rec709",(()=>[1.16438,0,1.79274,-.97295,1.16438,-.21325,-.53291,.30148,1.16438,2.1124,0,-1.1334,0,0,0,1])),I(this,"rec601",(()=>[1.16438,0,1.59603,-.87079,1.16438,-.39176,-.81297,.52959,1.16438,2.01723,0,-1.08139,0,0,0,1])),this.canvas.addEventListener("webglcontextlost",this.onContextLost),this.canvas.addEventListener("webglcontextrestored",this.onContextRestored,!1),this.canvas.style.width="100%",this.canvas.style.position="relative"}getTextRenderer(){return this.textRenderer||(this.textRenderer=new Iu(this.context)),this.textRenderer}};I(Ru,"SQUARE_VERTICES",new Float32Array([0,0,0,1,1,0,1,1]));let Lu=Ru;const Pu=class{constructor(t,e,i,n){I(this,"oldTimestampLimit",400),I(this,"pool"),I(this,"logger"),I(this,"videoRenderer",new Lu),I(this,"renderQueue",[]),I(this,"clockSource"),I(this,"isFirstFrame",!0),I(this,"animationFrameRequest"),I(this,"renderedFrameCount",0),I(this,"rendererDroppedFrameCount",0),I(this,"renderTargetSize"),I(this,"load",(()=>{this.videoRenderer.load()})),I(this,"unload",(()=>(this.stopRender(),this.videoRenderer.unload(),Promise.resolve()))),I(this,"suspend",(()=>{this.renderQueue=[],this.stopRender()})),I(this,"unsuspend",(()=>{this.animationFrameRequest=requestAnimationFrame(this.render)})),I(this,"element",(()=>this.videoRenderer.canvas)),I(this,"getStatistics",(()=>({renderedFrameCount:this.renderedFrameCount,rendererDroppedFrameCount:this.rendererDroppedFrameCount,contextLostCount:0,contextRestoredCount:0}))),I(this,"resetSize",(()=>{this.videoRenderer.resetSize()})),I(this,"setActiveCues",((t,e)=>{this.videoRenderer.getTextRenderer().setActiveCues(t,e)})),I(this,"onDecodedFrame",(t=>{if("video"===t.type)if(this.isFirstFrame)this.isFirstFrame=!1,requestAnimationFrame((()=>{this.renderSample(t)}));else{const e=(this.clockSource.currentTime-this.oldTimestampLimit)/1e3;this.renderQueue=this.renderQueue.filter((i=>{const n=i.timestamp/i.timescale,s=t.timestamp/t.timescale,r=n>e&&n<=s;return r||this.pool.reclaim(i.buffer),r})),this.renderQueue.push(t)}})),I(this,"render",(()=>{const t=this.clockSource.currentTime;let e,i=this.renderQueue[0],n=0;for(;i&&i.timestamp/i.timescale*1e3<=t;)i=this.renderQueue.shift(),i&&(n++,e&&this.pool.reclaim(e.buffer),e=i),i=this.renderQueue[0];e&&this.renderSample(e),this.rendererDroppedFrameCount+=Math.max(n-1,0),this.animationFrameRequest=requestAnimationFrame(this.render)})),I(this,"renderSample",(t=>{this.renderedFrameCount++,this.videoRenderer.render(t,this.renderTargetSize),this.pool.reclaim(t.buffer)})),I(this,"stopRender",(()=>{this.animationFrameRequest&&cancelAnimationFrame(this.animationFrameRequest)})),this.logger=t,this.clockSource=e,this.pool=i,this.renderTargetSize=n||this.videoRenderer.canvas}};I(Pu,"create",((t,e,i,n)=>new Pu(t,e,i,n)));let Bu=Pu;const _u=class{constructor(t,e,i,n,s){I(this,"logger"),I(this,"emitter"),I(this,"audioPlayer"),I(this,"videoPlayer"),I(this,"pool"),I(this,"unmuter",new eu),I(this,"_isPaused",!1),I(this,"isDisconnected",!1),I(this,"timers",new Zt),I(this,"textTracks",new Yd),I(this,"playbackRate"),I(this,"reset",(()=>{})),I(this,"load",(()=>{this.audioPlayer.useDefaultDestination(),this.emitter.on("decoded frame",this.onDecodedFrame),this.emitter.on("flush buffers",this.flushBuffers),this.videoPlayer.load(),this.timers.setInterval((()=>{if(!this.textTracks.language)return;const t=this.textTracks.getActiveCues(this.currentTime/1e3);this.videoPlayer.setActiveCues(t,{width:this.videoPlayer.element().clientWidth,height:this.videoPlayer.element().clientHeight})}),100)})),I(this,"unload",(()=>{this.emitter.off("decoded frame",this.onDecodedFrame),this.emitter.off("flush buffers",this.flushBuffers),this.audioPlayer.unload(),this.videoPlayer.unload(),this.timers.unload()})),I(this,"suspend",(()=>{this.videoPlayer.suspend(),this.audioPlayer.suspend()})),I(this,"unsuspend",(()=>{this.videoPlayer.unsuspend(),this.audioPlayer.unsuspend()})),I(this,"element",(()=>this.videoPlayer.element())),I(this,"getStatistics",(()=>this.videoPlayer.getStatistics())),I(this,"flushBuffers",(()=>{this.audioPlayer.flushBuffer()})),I(this,"activateAudioPlayer",(()=>(this.isDisconnected&&(this.isDisconnected=!1,this.audioPlayer.useDefaultDestination()),this._isPaused=!1,this.unmuter.unmute(),this.audioPlayer.play()))),I(this,"onDecodedFrame",(t=>{try{this.audioPlayer.onDecodedFrame(t)}catch(t){t instanceof Error&&this.emitter.emit("error",me(!1,t))}this.videoPlayer.onDecodedFrame(t)})),this.logger=e,this.emitter=t,this.pool=i,this.audioPlayer=Kd.create(this.logger.createContext("AudioPlayerModule"),n,{muted:s,reInitWhenStuck:!0}),this.audioPlayer.on("stuck",(()=>{this.isDisconnected=!0})),this.audioPlayer.on("state change",(()=>{this.emitter.emit("volume state",{volume:this.volume,isMuted:this.muted})})),this.videoPlayer=Bu.create(this.logger.createContext("VideoPlayerModule"),this.audioPlayer,this.pool)}get volume(){return this.audioPlayer.volume}set volume(t){this.audioPlayer.volume=t}get muted(){return this.audioPlayer.muted}set muted(t){const e=this.muted;this.audioPlayer.muted=t,!t&&e&&this.activateAudioPlayer().catch(G)}get currentTime(){return this.audioPlayer.currentTime}set currentTime(t){this.audioPlayer.currentTime=t}get isActivated(){return this.audioPlayer.isActivated}set isActivated(t){this.audioPlayer.isActivated=t}get seekTime(){return this.audioPlayer.seekTime}get isPaused(){return this._isPaused}get isSeeking(){return this.audioPlayer.isSeeking}get audioNode(){return this.audioPlayer.audioNode}play(){this.activateAudioPlayer().then((()=>{this.emitter.emit("media element state","playing")})).catch((()=>{this.emitter.emit("needs user input",{forAudio:!0,forVideo:!1})}))}pause(){this._isPaused=!0,this.audioPlayer.pause(),this.emitter.emit("media element state","paused")}};I(_u,"create",((t,e,i,n,s)=>new _u(t,e,i,n,s)));let Du=_u;const Nu=class{constructor(t,e,i,n,{muted:s,type:r,poster:a}){I(this,"logger"),I(this,"emitter"),I(this,"mediaElement"),I(this,"audioPlayer"),I(this,"videoPlayer"),I(this,"pool"),I(this,"isDisconnected",!0),I(this,"_userProvidedMuted",!1),I(this,"timers",new Zt),I(this,"volumeState"),I(this,"textTracks",new Yd),I(this,"reset",(()=>{})),I(this,"load",(()=>{this.mediaElement.load(),this.emitter.on("decoded frame",this.onDecodedFrame),this.emitter.on("flush buffers",this.flushBuffers),this.emitter.on("ios-hack: reset size",this.resetCanvasSize),this.emitter.on("enter picture in picture",this.onEnterIOSHack),this.emitter.on("exit picture in picture",this.onExitIOSHack),this.element().element.addEventListener("webkitendfullscreen",this.onExitIOSHack),this.element().element.addEventListener("webkitbeginfullscreen",this.onEnterIOSHack),this.videoPlayer.load(),this.timers.setInterval((()=>{if(!this.textTracks.language)return;const t=this.textTracks.getActiveCues(this.currentTime/1e3);this.videoPlayer.setActiveCues(t,{width:this.mediaElement.element.clientWidth,height:this.mediaElement.element.clientHeight})}),100)})),I(this,"unload",(()=>{this.emitter.off("decoded frame",this.onDecodedFrame),this.emitter.off("flush buffers",this.flushBuffers),this.emitter.off("ios-hack: reset size",this.resetCanvasSize),this.emitter.off("enter picture in picture",this.onEnterIOSHack),this.emitter.off("exit picture in picture",this.onExitIOSHack),this.element().element.removeEventListener("webkitendfullscreen",this.onExitIOSHack),this.element().element.removeEventListener("webkitbeginfullscreen",this.onEnterIOSHack),this.mediaElement.unload(),this.timers.unload(),this.audioPlayer.unload(),this.videoPlayer.unload()})),I(this,"suspend",(()=>{this.videoPlayer.suspend(),this.audioPlayer.suspend()})),I(this,"unsuspend",(()=>{this.videoPlayer.unsuspend(),this.audioPlayer.unsuspend()})),I(this,"element",(()=>this.mediaElement)),I(this,"getStatistics",(()=>this.videoPlayer.getStatistics())),I(this,"activateAudioPlayer",(()=>(this.isDisconnected&&this.connectStreams(),this.audioPlayer.play()))),I(this,"flushBuffers",(()=>{this.audioPlayer.flushBuffer()})),I(this,"resetCanvasSize",(()=>{this.videoPlayer.resetSize()})),I(this,"onEnterIOSHack",(()=>{this.mediaElement._iosHackEnterPiPMode()})),I(this,"onExitIOSHack",(()=>{this.mediaElement._iosHackExitPiPMode()})),I(this,"onDecodedFrame",(t=>{try{this.audioPlayer.onDecodedFrame(t)}catch(t){t instanceof Error&&this.emitter.emit("error",me(!1,t))}this.videoPlayer.onDecodedFrame(t)})),I(this,"connectStreams",(()=>{const t=this.videoPlayer.element().captureStream(),e=this.audioPlayer.useMediaStreamDestination().stream,i=[];i.push(...t.getTracks(),...e.getTracks()),this.mediaElement.element.srcObject=new MediaStream(i),this.isDisconnected=!1})),I(this,"updateVolumeState",(()=>{const t={isMuted:this.muted,volume:this.volume};kt(t,this.volumeState)||(this.volumeState=t,this.emitter.emit("volume state",this.volumeState))})),this.logger=e,this.emitter=t,this.pool=i,this._userProvidedMuted=s,this.mediaElement=new os({poster:a,type:r,muted:s,autoplay:!1,logger:this.logger.createContext("MediaElement")}),this.mediaElement.on("volume state",(t=>{this.updateVolumeState(),!t.isMuted&&!this.audioPlayer.isContextRunning&&this.activateAudioPlayer().catch(G),t.isMuted||(this._userProvidedMuted=!1)})),this.mediaElement.on("media element state",(t=>{"paused"===t&&this.audioPlayer.flushBuffer(),this.emitter.emit("media element state",t)})),this.audioPlayer=Kd.create(this.logger.createContext("AudioPlayerModule"),n,{muted:!1,reInitWhenStuck:!1}),this.audioPlayer.on("stuck",(()=>{this.isDisconnected=!0})),this.audioPlayer.on("state change",(t=>{"suspended"===t||"interrupted"===t?this.mediaElement.muted=!0:"running"===t&&(this.mediaElement.muted=this._userProvidedMuted||"hidden"===document.visibilityState),this.updateVolumeState()})),this.videoPlayer=Bu.create(this.logger.createContext("VideoPlayerModule"),this.audioPlayer,this.pool,this.mediaElement.element),this.volumeState={volume:this.volume,isMuted:this.muted}}get volume(){return this.mediaElement.volume}set volume(t){this.mediaElement.volume=t}get muted(){return this.mediaElement.muted||this.audioPlayer.muted}set muted(t){const e=this.muted;this._userProvidedMuted=t,this.mediaElement.muted=t,!t&&e&&this.activateAudioPlayer().catch(G)}get currentTime(){return this.audioPlayer.currentTime}set currentTime(t){this.audioPlayer.currentTime=t}get isActivated(){return this.mediaElement.isActivated}set isActivated(t){this.mediaElement.isActivated=t}get seekTime(){return this.mediaElement.seekTime}get isPaused(){return this.mediaElement.isPaused}get isSeeking(){return this.mediaElement.isSeeking}get audioNode(){return this.audioPlayer.audioNode}play(){const t=this._userProvidedMuted;return this.activateAudioPlayer().catch((()=>{t||this.emitter.emit("needs user input",{forAudio:!0,forVideo:!1})})),this.mediaElement.play()}pause(){this.mediaElement.pause()}};I(Nu,"create",((t,e,i,n,s)=>new Nu(t,e,i,n,s)));let Wu=Nu;const Ou=()=>t=>Fu(t.buffered.start(0),t.buffered.end(t.buffered.length-1)),Fu=(t,e)=>i=>i.remove(Math.max(0,t),Math.min(Number.POSITIVE_INFINITY,e)),Vu=t=>e=>e.appendBuffer(t);class Gu{constructor(t){I(this,"commandQueue",[]),I(this,"sourceBuffer"),I(this,"currentInit"),I(this,"handleQueue",(()=>{var t;this.sourceBuffer.updating||null==(t=this.commandQueue.shift())||t.execute(this.sourceBuffer)})),I(this,"appendBuffer",((t,e)=>new Promise(((i,n)=>{if(e&&this.currentInit!==e){const t=new bt(Vu(e),i,n);this.commandQueue.push(t),this.currentInit=e}const s=new bt(Vu(t),i,n);this.commandQueue.push(s),this.handleQueue()})))),I(this,"execute",(t=>new Promise(((e,i)=>{const n=new bt((t=>e=>t(e))(t),e,i);this.commandQueue.push(n),this.handleQueue()})))),I(this,"buffered",(()=>this.sourceBuffer.buffered)),I(this,"removeFromMediaSource",(t=>{t.removeSourceBuffer(this.sourceBuffer)})),I(this,"changeType",(t=>new Promise(((e,i)=>{const n=new bt((t=>e=>e.changeType(t))(t),e,i);this.commandQueue.push(n),this.handleQueue()})))),I(this,"removeBuffer",((t,e)=>new Promise(((i,n)=>{const s=new bt(Fu(t,e),i,n);this.commandQueue.push(s),this.handleQueue()})))),I(this,"flush",(()=>new Promise(((t,e)=>{const i=new bt(Ou,t,e);this.commandQueue.push(i),this.handleQueue()})))),this.sourceBuffer=t,this.sourceBuffer.addEventListener("updateend",this.handleQueue)}}class zu extends n.E{constructor(){super(),I(this,"MediaSource",tt()),I(this,"mediaSource",new this.MediaSource),I(this,"isOpen",(()=>"open"===this.mediaSource.readyState)),I(this,"isClosed",(()=>"closed"===this.mediaSource.readyState)),I(this,"isEnded",(()=>"ended"===this.mediaSource.readyState)),I(this,"createObjectURL",(()=>URL.createObjectURL(this.mediaSource))),I(this,"attach",(t=>{const e=t;if("srcObject"in e)try{e.srcObject=this.mediaSource}catch(t){if(t instanceof Error&&"TypeError"!==t.name)throw t;e.src=this.createObjectURL()}else t.src=this.createObjectURL()})),I(this,"detach",(t=>{if(this.mediaSource&&"open"===this.mediaSource.readyState)try{this.mediaSource.endOfStream()}catch(t){}t.srcObject&&(t.srcObject=null),""!==t.src&&(URL.revokeObjectURL(t.src),t.removeAttribute("src")),t.load()})),I(this,"addSourceBuffer",(t=>{const e=this.mediaSource.addSourceBuffer(t);return new Gu(e)})),I(this,"removeSourceBuffer",(t=>{t.removeFromMediaSource(this.mediaSource)})),I(this,"endOfStream",(t=>{this.mediaSource.endOfStream(t)})),I(this,"onSourceOpen",(()=>{this.setDurationIfNeeded(),this.emit("source open")})),I(this,"onSourceEnded",(()=>this.emit("source ended"))),I(this,"onSourceClosed",(()=>this.emit("source close"))),I(this,"setDurationIfNeeded",(()=>{if(Number.isNaN(this.mediaSource.duration)&&"open"===this.mediaSource.readyState){for(let t=0;t<this.mediaSource.sourceBuffers.length;t++){const e=this.mediaSource.sourceBuffers[t];if(null!=e&&e.updating)return}this.mediaSource.duration=Number.POSITIVE_INFINITY}})),this.mediaSource.addEventListener("sourceopen",this.onSourceOpen),this.mediaSource.addEventListener("sourceclose",this.onSourceClosed),this.mediaSource.addEventListener("sourceended",this.onSourceEnded)}}I(zu,"isTypeSupported",(t=>{var e,i;return null!=(i=null==(e=tt())?void 0:e.isTypeSupported(t))&&i}));class Hu{constructor(){I(this,"initSegments",new Map),I(this,"set",((t,e,i)=>{var n;const s=null!=(n=this.initSegments.get(t))?n:new Map;s.set(e,i),this.initSegments.set(t,s)})),I(this,"get",((t,e)=>{var i;return null==(i=this.initSegments.get(t))?void 0:i.get(e)}))}}function ju(t,{mediaSource:e,mimeType:i,codec:n}){return A(f({},t),{state:"initialized",mimeType:i,codec:n,sourceBuffer:e.addSourceBuffer(i),isWorkingOnPendingSamples:!1,sequenceNumber:0,lastBufferCleanupTime:Date.now()})}function Xu({initSegments:t,pendingSamples:e}){return{state:"uninitialized",initSegments:null!=t?t:new Hu,sequenceNumber:0,isWorkingOnPendingSamples:!1,hasFirstSync:!!e,pendingSamples:null!=e?e:[],consecutiveQuotaExceededErrorCount:0,successfulAppendCalls:0}}const qu=class{constructor(t,e,i){I(this,"maxChunkSize",20),I(this,"minConsecutiveErrorsBeforeEmit",5),I(this,"maxSecondsInBuffer",60),I(this,"logger"),I(this,"timers",Zt.create()),I(this,"emitter"),I(this,"mediaElement"),I(this,"mediaSource",new zu),I(this,"trackContexts",new Map),I(this,"autoRecoverFromMediaErrors",!0),I(this,"quotaErrorCount",0),I(this,"recoveredFromErrorCount",0),I(this,"sourceOpenStartTime",Date.now()),I(this,"sourceOpenEndTime",Date.now()),I(this,"pendingTracksToAddSourceBuffers"),I(this,"hasAddedInitialPosterFrame",!0),I(this,"load",(()=>{this.emitter.on("init segment",this.init),this.emitter.on("coded sample",this.onCodedSample),this.emitter.on("flush buffers",this.flushBuffers),this.emitter.on("fragment",this.onFragment)})),I(this,"unload",(()=>{this.logger.debug("Unloading module..."),this.emitter.off("init segment",this.init),this.emitter.off("coded sample",this.onCodedSample),this.emitter.off("flush buffers",this.flushBuffers),this.emitter.off("fragment",this.onFragment),this.mediaSource.off("source ended",this.onSourceEnded),this.mediaSource.off("source open",this.onSourceOpen),this.mediaSource.detach(this.mediaElement),this.trackContexts.forEach((t=>t.pendingSamples=[])),this.timers.unload(),this.logger.debug("Unloaded module")})),I(this,"getStatistics",(()=>{var t,e,i,n;const s={quotaErrorCount:this.quotaErrorCount,mediaSourceOpenTime:this.sourceOpenEndTime-this.sourceOpenStartTime,successfulAudioAppendsCalls:null==(t=this.trackContexts.get("audio"))?void 0:t.successfulAppendCalls,successfulVideoAppendCalls:null==(e=this.trackContexts.get("video"))?void 0:e.successfulAppendCalls};if(this.mediaElement instanceof HTMLVideoElement){const t=null==(n=(i=this.mediaElement).getVideoPlaybackQuality)?void 0:n.call(i);s.totalVideoFrames=null==t?void 0:t.totalVideoFrames,s.droppedVideoFrames=null==t?void 0:t.droppedVideoFrames}return s})),I(this,"flushBuffers",(()=>{this.trackContexts.forEach((t=>{t.pendingSamples=[],t.hasFirstSync=!1,"uninitialized"!==t.state&&this.mediaSource.isOpen()&&t.sourceBuffer.removeBuffer(0,Number.POSITIVE_INFINITY).catch((t=>{this.logger.error("Failed to remove buffer",t)}))}))})),I(this,"setTrackContexts",((t=new Map)=>{this.logger.debug("setTrackContexts"),["audio","video"].forEach((e=>{var i,n,s,r;const a=null!=(n=null==(i=t.get(e))?void 0:i.pendingSamples)?n:[],o=null==(s=t.get(e))?void 0:s.initSegments;for(;a.length>0&&(null==(r=a[0])||!r.isSync);)a.shift();this.trackContexts.set(e,Xu({pendingSamples:a,initSegments:o}))}))})),I(this,"setSourceBuffers",(t=>B(this,null,(function*(){if(this.mediaSource.isClosed())return void(this.pendingTracksToAddSourceBuffers=t);let e=!0;for(const i of t){const t=this.trackContexts.get(i.type);if(!t||"uninitialized"===t.state||t.mimeType!==i.mimeType){e=!1;break}}if(e)this.logger.debug("Already setup with the correct mime types");else for(const e of t){let t=this.trackContexts.get(e.type);t||(t=Xu({pendingSamples:[],initSegments:new Hu}),this.trackContexts.set(e.type,t)),"initialized"===t.state?e.mimeType!==t.mimeType&&(yield t.sourceBuffer.changeType(e.mimeType)):this.trackContexts.set(e.type,ju(t,{mimeType:e.mimeType,mediaSource:this.mediaSource,codec:e.codec}))}})))),I(this,"getBuffer",(t=>{const e=[];if(this.mediaSource.isClosed())return[];const i=this.trackContexts.get(t);if(!i||"uninitialized"===i.state)return[];try{const t=i.sourceBuffer.buffered();if(!t)return[];for(let i=0;i<t.length;i++)e.push({start:1e3*t.start(i),end:1e3*t.end(i)});return e}catch(t){return[]}})),I(this,"init",(({initSegment:t,mimeType:e})=>{this.logger.debug("Added init segment",{channel:t.channelId,renditionId:t.renditionId});const i=this.trackContexts.get(t.type);if(!i)throw ge(t.type,t.renditionId);"initialized"===i.state&&(i.mimeType=e);const n=((t,e,i)=>{switch(t){case"h264":return((t,e)=>((t,e)=>{const{sequenceParameterSets:i,pictureParameterSets:n}=pi(t),s=jn(t);return zn([{type:"video",sequenceParameterSets:i.map((t=>new Uint8Array(t))),pictureParameterSets:n.map((t=>new Uint8Array(t))),width:s.width,height:s.height,timescale:e,duration:0,trackId:1}])})(t,e))(e,i);case"av1":return((t,e)=>((t,e)=>{const i=Xn(t);if(!i)throw new Error("Failed to parse sequence header");return zn([{type:"video",parsedSequenceHeader:i,sequenceHeader:new Uint8Array(t),width:i.maxFrameWidth,height:i.maxFrameHeight,timescale:e,duration:0,trackId:1}])})(t,e))(e,i);case"opus":return((t,e)=>((t,e,i)=>zn([{type:"audio",trackId:1,channelCount:2,timescale:i,codec:"opus",decoderConfig:t,duration:0,sampleRate:48e3}]))(new Uint8Array(t),0,e))(e,i);case"aac":return((t,e)=>((t,e,i,n)=>zn([{type:"audio",codec:"aac",decoderConfig:t,channelCount:2,sampleRate:i,timescale:n,duration:0,trackId:1}]))(new Uint8Array(t),0,e,e))(e,i);default:throw new Error(`Failed to initialize ${t} segment`)}})(t.codec,t.data,t.timescale);n&&i.initSegments.set(t.channelId,t.renditionId,new Uint8Array(n))})),I(this,"append",((t,e)=>B(this,null,(function*(){var i;const n=t[0];if(!n)return;const s=this.trackContexts.get(n.type),r=null==s?void 0:s.initSegments.get(n.channelId,n.renditionId);if(this.mediaSource.isClosed())return;if(!r)throw((t,e)=>new de(`No init segment for rendition id ${t} for channel ${e}`,{isFatal:!1,code:"missing_init_segment",type:"internal"}))(n.renditionId,n.channelId);if(!s)throw ge(n.type,n.renditionId);if("uninitialized"===s.state)throw((t,e)=>new de(`Track context is in an invalid state for ${t}${e?`, rendition id ${e}`:""}`,{isFatal:!1,code:"invalid_track_context_state",type:"internal"}))(n.type,n.renditionId);if(e){const t=(n.timestamp+(null!=(i=n.compositionTimeOffset)?i:0))/n.timescale;yield s.sourceBuffer.removeBuffer(t,Number.POSITIVE_INFINITY);const e=s.previousSample;if(e&&e.codec!==n.codec&&s.sourceBuffer.changeType)try{yield s.sourceBuffer.changeType(s.mimeType)}catch(t){}"fragmented"in n||(yield s.sourceBuffer.appendBuffer(r))}const a=Math.max(0,n.timestamp/n.timescale-this.maxSecondsInBuffer);a>0&&Date.now()-s.lastBufferCleanupTime>1e4&&(s.lastBufferCleanupTime=Date.now(),yield s.sourceBuffer.removeBuffer(0,a+10));try{let e=s.sequenceNumber;if("fragmented"in n)for(const e of t)"initData"in e&&(yield s.sourceBuffer.appendBuffer(e.data,e.initData));else{const i=((t,e)=>{if(!t[0])throw new Error("At least one sample must be provided");switch(t[0].codec){case"h264":return((t,e)=>{const i=t.map((t=>A(f({},t),{data:new Uint8Array(t.data)})));if(!i[0])throw new Error("At least one sample must be provided");const{isSync:n,timestamp:s,data:r,duration:a}=i[0];return Hn({trackId:1,timestamp:s,sequenceNumber:e,defaultSize:r.byteLength,defaultFlags:n?33554432:16842752,defaultDuration:a,samples:i})})(t,e);case"opus":return((t,e)=>{const i=t.map((t=>A(f({},t),{data:new Uint8Array(t.data)})));if(!i[0])throw new Error("At least one sample must be provided");const{timestamp:n,data:s,duration:r}=i[0];return Hn({trackId:1,timestamp:n,sequenceNumber:e,defaultSize:s.byteLength,defaultFlags:33554432,defaultDuration:r,samples:i})})(t,e);case"aac":return((t,e)=>{const i=t.map((t=>A(f({},t),{data:new Uint8Array(t.data)})));if(!i[0])throw new Error("At least one sample must be provided");const{timestamp:n,data:s,duration:r}=i[0];return Hn({trackId:1,timestamp:n,sequenceNumber:e,defaultSize:s.byteLength,defaultFlags:33554432,defaultDuration:r,samples:i})})(t,e);case"av1":return((t,e)=>{const i=t.map((t=>A(f({},t),{data:new Uint8Array(t.data)})));if(!i[0])throw new Error("At least one sample must be provided");const{isSync:n,timestamp:s,data:r,duration:a}=i[0];return Hn({trackId:1,timestamp:s,sequenceNumber:e,defaultSize:r.byteLength,defaultFlags:n?33554432:16842752,defaultDuration:a,samples:i})})(t,e);default:throw new Error(`Unsupported codec ${t[0].codec}`)}})(t,e++);yield s.sourceBuffer.appendBuffer(i)}s.sequenceNumber=e,s.consecutiveQuotaExceededErrorCount=0,s.successfulAppendCalls++}catch(e){throw e instanceof DOMException&&(e.code===DOMException.QUOTA_EXCEEDED_ERR?(this.quotaErrorCount++,s.consecutiveQuotaExceededErrorCount++,this.logger.error("quota exceeded error",{error:e}),s.pendingSamples.unshift(...t)):this.mediaElement.error&&s.pendingSamples.unshift(...t)),e}})))),I(this,"onFragment",(({fragment:t,mimeType:e,codec:i,channelId:n,renditionId:s})=>{const r=t.mediaType(),a=t.rawBytes(),o=t.header().rawBytes(),l=t.baseMediaDecodeTime(),h=t.timescale(),c=t.duration(),d="video"!==r||t.startsWithKeyframe(),u=t.compositionTimeOffset(0);if("text"===r)return void this.logger.warn("Skipping unexpected text fragment");if(!i)return void this.logger.warn("Skipping fragment with no codec");const m=this.trackContexts.get(r);if(!m)throw ge(r);"initialized"===m.state&&e&&(m.mimeType=e,m.initSegments.set(n,s,o));const p={fragmented:!0,type:r,data:a,initData:o,timestamp:l,duration:c,timescale:h,channelId:n,renditionId:s,isSync:d,codec:i,fragment:t,compositionTimeOffset:u};this.onCodedSample(p)})),I(this,"onCodedSample",(t=>{if(0===t.duration)return;const e=this.trackContexts.get(t.type);if(!e)throw ge(t.type,t.renditionId);if(e.hasFirstSync||t.isSync){if(this.hasAddedInitialPosterFrame&&t.isSync&&"video"===t.type){this.hasAddedInitialPosterFrame=!1;const i=f({},t);"fragment"in i?(i.fragment=i.fragment.clone(),i.fragment.updateBaseMediaDecodeTime(0),i.data=i.fragment.rawBytes()):i.timestamp=0,e.pendingSamples.push(i)}e.hasFirstSync=!0,e.pendingSamples.push(t),"uninitialized"!==e.state&&(e.isWorkingOnPendingSamples||Zu(e,this.append,this.maxChunkSize).catch((i=>{if(e.isWorkingOnPendingSamples=!1,i instanceof Error){if(this.logger.error("append failed",{message:i.message,name:i.name}),i instanceof DOMException&&i.code===DOMException.QUOTA_EXCEEDED_ERR){if(e.consecutiveQuotaExceededErrorCount>=this.minConsecutiveErrorsBeforeEmit){const n=pe(!1,i,e.consecutiveQuotaExceededErrorCount,t.type);this.emitter.emit("error",n)}}else{const n=pe(!1,i,e.consecutiveQuotaExceededErrorCount,t.type);this.emitter.emit("error",n)}this.mediaElement.error&&this.onSourceEnded()}})))}})),I(this,"onSourceOpen",(()=>{this.logger.debug("source opened"),this.sourceOpenEndTime=Date.now(),this.pendingTracksToAddSourceBuffers&&(this.setSourceBuffers(this.pendingTracksToAddSourceBuffers),this.pendingTracksToAddSourceBuffers=void 0)})),I(this,"onSourceEnded",(()=>{const{error:t}=this.mediaElement;if(t){const e=((t,e)=>new de("MediaElement Error",{isFatal:t,code:"media_element_error",source:e},{mediaErrorCode:e.code}))(/AUDIO_RENDERER/.test(t.message)||!this.autoRecoverFromMediaErrors,t);if(this.logger.error("MediaElement error",{error:e}),this.emitter.emit("error",e),!e.isFatal()){this.logger.info("Re-opening MediaSource"),this.emitter.emit("recovered from media error",{error:e,count:this.recoveredFromErrorCount}),this.recoveredFromErrorCount++;const t=!this.mediaElement.paused,i=[];this.trackContexts.forEach(((t,e)=>{"initialized"===t.state&&i.push({type:e,mimeType:t.mimeType,codec:t.codec})})),this.sourceOpenStartTime=Date.now(),this.pendingTracksToAddSourceBuffers=i,this.mediaElement.src="",this.setTrackContexts(this.trackContexts),this.mediaSource.attach(this.mediaElement),t&&this.mediaElement.play().catch(G)}}this.logger.debug("source ended")})),this.logger=t,this.mediaElement=i,this.emitter=e}};I(qu,"create",((t,e,i)=>{const n=new qu(t,e,i);return n.setTrackContexts(),n.mediaSource.on("source ended",n.onSourceEnded),n.mediaSource.on("source open",n.onSourceOpen),n.mediaSource.attach(i),n}));let Qu=qu;const $u=(t,e)=>{var i;const n=t.renditionId!==e.renditionId,s=t.channelId!==e.channelId,r=(null!=(i=t.timestamp)?i:0)>e.timestamp,a="video"===t.type&&"video"===e.type&&"levelIdc"in t&&"levelIdc"in e&&t.levelIdc!==e.levelIdc;let o=!1;return"video"===t.type&&"video"===e.type&&"width"in t&&"width"in e&&(o=e.width!==t.width||e.height!==t.height),s||n||r||o||a},Zu=(t,e,i)=>B(void 0,null,(function*(){for(t.isWorkingOnPendingSamples=!0;t.pendingSamples.length>0;){const n=[];let s=0;for(let e=0;e<t.pendingSamples.length;e++){s=e;const r=t.pendingSamples[e],a=t.pendingSamples[e+1];if(r&&(n.push(r),a)){if($u(r,a))break;const t=(r.timestamp+r.duration)/r.timescale;if(a.timestamp/a.timescale-t>.1)break}if(e===i-1)break}const r=n[0];if(!r)break;const a=!t.previousSample||$u(t.previousSample,r);yield e(n,a),t.pendingSamples=t.pendingSamples.slice(s+1),t.previousSample=n[n.length-1]}t.isWorkingOnPendingSamples=!1})),Ku=class{constructor(t,e){I(this,"logger"),I(this,"emitter"),I(this,"element"),I(this,"pictureInPictureWindow"),I(this,"unload",(()=>{this.emitter.off("add picture in picture listener",this.onEnablePictureInPicture)})),I(this,"onEnablePictureInPicture",(t=>{this.element=t.element,t.element.addEventListener("leavepictureinpicture",(()=>{this.pictureInPictureWindow=void 0,this.logger.debug("Leave picture in picture"),this.emitter.emit("exit picture in picture")})),t.element.addEventListener("enterpictureinpicture",(t=>{this.pictureInPictureWindow=t.pictureInPictureWindow,this.logger.debug("Enter picture in picture"),this.emitter.emit("enter picture in picture",this)})),t.element.autopictureinpicture=!0})),I(this,"getPictureInPictureSize",(()=>this.pictureInPictureWindow)),I(this,"isPictureInPictureActive",(()=>this.isWebkitPresentationModeActive()||this.isStandardPictureInPictureActive())),I(this,"isPictureInPictureSupported",(()=>this.isWebkitPresentationModeSupported()||this.isStandardPictureInPictureSupported())),I(this,"requestPictureInPicture",(()=>(this.emitter.emit("ios-hack: reset size"),this.isStandardPictureInPictureSupported()?this.requestStandardPictureInPicture():this.isWebkitPresentationModeSupported()?this.requestWebkitPresentationMode("picture-in-picture"):Promise.reject(new Error("Picture in picture is not supported"))))),I(this,"exitPictureInPicture",(()=>this.isStandardPictureInPictureSupported()?this.exitStandardPictureInPicture():this.isWebkitPresentationModeSupported()?this.requestWebkitPresentationMode("inline"):Promise.reject(new Error("Picture in picture is not supported")))),I(this,"getStatistics",(()=>({isPictureInPictureActive:this.isPictureInPictureActive()}))),I(this,"requestStandardPictureInPicture",(()=>B(this,null,(function*(){return yield this.element.requestPictureInPicture()})))),I(this,"exitStandardPictureInPicture",(()=>B(this,null,(function*(){return yield document.exitPictureInPicture()})))),I(this,"isStandardPictureInPictureSupported",(()=>!!this.element&&!!this.element.requestPictureInPicture&&!!document.pictureInPictureEnabled)),I(this,"isStandardPictureInPictureActive",(()=>!!this.element&&!!document.pictureInPictureElement)),I(this,"isWebkitPresentationModeActive",(()=>!!this.element&&"picture-in-picture"===this.element.webkitPresentationMode)),I(this,"requestWebkitPresentationMode",(t=>B(this,null,(function*(){return this.element.webkitSetPresentationMode(t),Promise.resolve()})))),I(this,"isWebkitPresentationModeSupported",(()=>!!this.element&&!!this.element.webkitSetPresentationMode)),this.emitter=t,this.logger=e,this.emitter.on("add picture in picture listener",this.onEnablePictureInPicture)}};I(Ku,"create",((t,e)=>new Ku(t,e)));let Ju=Ku;const Yu=class{constructor(t,e,i,n){I(this,"emitter"),I(this,"logger"),I(this,"clockSource"),I(this,"state","buffering"),I(this,"bufferFullness",0),I(this,"targetBufferTime"),I(this,"lastBufferStateEvent","drained"),I(this,"firstFrameTime"),I(this,"currentTimeIsInRange",!1),I(this,"needsInputForAudioCount",0),I(this,"needsInputForVideoCount",0),I(this,"unload",(()=>{this.emitter.off("buffer state",this.onBufferedStateChanged),this.emitter.off("needs user input",this.onNeedsUserInput)})),I(this,"setTargetBufferTime",(t=>{this.targetBufferTime=t})),I(this,"getTargetBufferTime",(()=>this.targetBufferTime)),I(this,"getBufferFullness",(()=>this.bufferFullness)),I(this,"getLastBufferStateEvent",(()=>this.lastBufferStateEvent)),I(this,"getState",(()=>this.state)),I(this,"getFirstFrameTime",(()=>this.firstFrameTime)),I(this,"getStatistics",(()=>({bufferTime:this.targetBufferTime,needsInputForAudioCount:this.needsInputForAudioCount,needsInputForVideoCount:this.needsInputForVideoCount}))),I(this,"onBufferedStateChanged",(({buffered:t,isPaused:e})=>{const i=this.clockSource.currentTime,n=t.some((t=>t.start<i&&i<t.end)),s=t[t.length-1],r=!!s&&s.end-s.start>=this.targetBufferTime,a=s?Math.max(0,s.end-i)/this.targetBufferTime:0,o=e?"paused":n?"playing":"buffering",l=this.state;this.currentTimeIsInRange===n||n?n&&r&&"drained"===this.lastBufferStateEvent&&(this.lastBufferStateEvent="filled",this.emitter.emit("buffer state event",this.lastBufferStateEvent)):(this.lastBufferStateEvent="drained",this.emitter.emit("buffer state event",this.lastBufferStateEvent)),"playing"===o&&!this.firstFrameTime&&(this.firstFrameTime=Date.now()),this.currentTimeIsInRange=n,this.state=o,this.bufferFullness=n?a:0,l!==o&&this.emitter.emit("playback state",o),this.emitter.emit("buffer fullness",this.bufferFullness)})),I(this,"onNeedsUserInput",(({forAudio:t,forVideo:e})=>{t&&this.needsInputForAudioCount++,e&&this.needsInputForVideoCount++})),this.emitter=t,this.logger=e,this.clockSource=i,this.targetBufferTime=n,this.emitter.on("buffer state",this.onBufferedStateChanged),this.emitter.on("needs user input",this.onNeedsUserInput)}};I(Yu,"create",((t,e,i,n)=>new Yu(t,e,i,n)));let tm=Yu;const em=()=>({upgradesFromLevel:[],downgradesFromLevel:[],bufferingRanges:[],activeRanges:[],decodeRate:Number.MAX_SAFE_INTEGER}),im=class{constructor(t,e){I(this,"minBufferFullnessLengthForRegression",6),I(this,"logger"),I(this,"emitter"),I(this,"timers",Zt.create()),I(this,"metrics",{levels:{},levelDowngrades:[],levelUpgrades:[],bufferFullness:0,general:em()}),I(this,"bufferFullness",new H(30)),I(this,"bufferFullnessRegression"),I(this,"currentLevel"),I(this,"isSuspended",!1),I(this,"_fatalQosCount",0),I(this,"hasAsserted",!1),I(this,"load",(()=>{this.emitter.on("playback state",this.onPlaybackState),this.emitter.on("buffer fullness",this.onBufferFullness),this.emitter.on("rendition level changed",this.onRenditionLevelChanged),this.emitter.on("video decode rate",this.onVideoDecodeRate)})),I(this,"unload",(()=>{this.emitter.off("playback state",this.onPlaybackState),this.emitter.off("buffer fullness",this.onBufferFullness),this.emitter.off("rendition level changed",this.onRenditionLevelChanged),this.emitter.off("video decode rate",this.onVideoDecodeRate),this.suspend()})),I(this,"suspend",(()=>{this.isSuspended=!0,this.timers.unload(),this.stopBuffering(),this.unsetActive()})),I(this,"unsuspend",(()=>{this.isSuspended=!1,this.currentLevel&&this.setActive()})),I(this,"fatalQosGraceTime",(()=>1e4*(this.fatalQosCount+1))),I(this,"incrementFatalQosCount",(()=>{this._fatalQosCount++})),I(this,"getMetrics",(()=>this.metrics)),I(this,"getLevelStats",(t=>{var e,i,n,s;const r=(null!=(i=null==(e=t.video)?void 0:e.bitRate)?i:0)+(null!=(s=null==(n=t.audio)?void 0:n.bitRate)?s:0);return this.metrics.levels[r]})),I(this,"getBufferFullnessRegression",(()=>this.bufferFullnessRegression)),I(this,"activeRatios",(()=>{const t=new Map,e=qt(this.metrics.general.activeRanges);if(Object.entries(this.metrics.levels).forEach((([i,n])=>{t.set(i,e?qt(n.activeRanges)/e:0)})),!this.hasAsserted){const e=!t.size||Math.abs(Array.from(t.values()).reduce(((t,e)=>t+e),0)-1)<=.02;e||(this.hasAsserted=!0,console.assert(e,`Active ratios should be close to 1 - actual: ${Array.from(t.values()).reduce(((t,e)=>t+e),0)}`))}return t})),I(this,"bufferingRatios",(()=>{const t=new Map,e=qt(this.metrics.general.bufferingRanges);if(Object.entries(this.metrics.levels).forEach((([i,n])=>{t.set(i,e?qt(n.bufferingRanges)/e:0)})),!this.hasAsserted){const e=Array.from(t.values()).reduce(((t,e)=>t+e),0)<=1;e||(this.hasAsserted=!0,console.assert(e,`Buffering ratios should be less than 1 - actual: ${Array.from(t.values()).reduce(((t,e)=>t+e),0)}`))}return t})),I(this,"bufferingEventsLast",(t=>this.metrics.general.bufferingRanges.filter((e=>e.start>=Date.now()-t)).length)),I(this,"timeSpentBufferingLast",(t=>Qt(this.metrics.general.bufferingRanges,t))),I(this,"timeSpentActiveLast",(t=>Qt(this.metrics.general.activeRanges,t))),I(this,"timeSpentPlayingInAtLeastLevelRatio",(t=>{var e,i,n,s;const r=this.timeSpentBuffering(),a=this.timeActive(),o=this.bufferingRatios(),l=this.activeRatios(),h=(null!=(i=null==(e=t.video)?void 0:e.bitRate)?i:0)+(null!=(s=null==(n=t.audio)?void 0:n.bitRate)?s:0),c=r/a;return Object.keys(this.metrics.levels).map((t=>parseInt(t,10))).filter((t=>t>=h)).reduce(((t,e)=>{var i,n;return(null!=(i=l.get(e.toString()))?i:0)-(null!=(n=o.get(e.toString()))?n:0)*c+t}),0)})),I(this,"timeSpentBuffering",(()=>qt(this.metrics.general.bufferingRanges))),I(this,"timeActive",(()=>qt(this.metrics.general.activeRanges))),I(this,"getStatistics",(()=>({timeSpentBuffering:this.timeSpentBuffering(),bufferingEventsCount:this.metrics.general.bufferingRanges.length,timeSpentRatio:[...this.activeRatios()].reduce(((t,[e,i])=>(t[e]=i,t)),{}),fatalQosCount:this.fatalQosCount}))),I(this,"onRenditionLevelChanged",(t=>{var e,i,n,s,r,a,o,l,h,c,d,u,m,p;const g=(null!=(n=null==(i=null==(e=t.from)?void 0:e.video)?void 0:i.bitRate)?n:0)+(null!=(a=null==(r=null==(s=t.from)?void 0:s.audio)?void 0:r.bitRate)?a:0),f=(null!=(h=null==(l=null==(o=t.to)?void 0:o.video)?void 0:l.bitRate)?h:0)+(null!=(u=null==(d=null==(c=t.to)?void 0:c.audio)?void 0:d.bitRate)?u:0);this.logger.info("rendition level changed",{fromLevel:g,toLevel:f}),0===this.metrics.general.activeRanges.length&&this.setActive(),t.from&&t.to&&(g<f?this.metrics.general.upgradesFromLevel.push(Date.now()):this.metrics.general.downgradesFromLevel.push(Date.now()));let A=!1;if(t.from){const t=null!=(m=this.metrics.levels[g])?m:em();g<f?t.upgradesFromLevel.push(Date.now()):t.downgradesFromLevel.push(Date.now()),jt(t.activeRanges);const e=t.bufferingRanges[t.bufferingRanges.length-1];A=!!e&&!e.end,jt(t.bufferingRanges),this.metrics.levels[g]=t}if(t.to){const t=null!=(p=this.metrics.levels[f])?p:em();Xt(t.activeRanges),A&&Xt(t.bufferingRanges),this.metrics.levels[f]=t,this.currentLevel=f}})),I(this,"onBufferFullness",(t=>{this.bufferFullness.push(t),this.metrics.bufferFullness=t,this.bufferFullness.items().length>=this.minBufferFullnessLengthForRegression&&(this.bufferFullnessRegression=this.calculateLinearRegression())})),I(this,"onPlaybackState",(t=>{switch(this.logger.info("Playback state",{state:t,currentLevel:this.currentLevel}),t){case"playing":this.stopBuffering();break;case"buffering":this.isSuspended||this.startBuffering()}})),I(this,"onVideoDecodeRate",(t=>{var e;if(this.metrics.general.decodeRate=t,!this.currentLevel)return;const i=this.metrics.levels[null!=(e=this.currentLevel)?e:0];i&&(i.decodeRate=t)})),I(this,"calculateLinearRegression",(()=>(t=>{let e=0,i=0,n=0,s=0,r=0;for(let a=0;a<t.length;a++){const{x:o,y:l}=t[a];e+=o,i+=l,n+=o*l,s+=o*o,r+=l*l}const a=(t.length*n-e*i)/(t.length*s-e*e),o=(i-a*e)/t.length,l=Math.pow((t.length*n-e*i)/Math.sqrt((t.length*s-e*e)*(t.length*r-i*i)),2);return{slope:a,intercept:o,r2:l,predict:e=>a*(t.length+e)+o}})(this.bufferFullness.items().map(((t,e)=>({x:e,y:t})))))),I(this,"stopBuffering",(()=>{if(this.currentLevel){const t=this.metrics.levels[this.currentLevel];t&&jt(t.bufferingRanges)}jt(this.metrics.general.bufferingRanges)})),I(this,"startBuffering",(()=>{if(this.currentLevel){const t=this.metrics.levels[this.currentLevel];t&&Xt(t.bufferingRanges)}Xt(this.metrics.general.bufferingRanges)})),I(this,"unsetActive",(()=>{if(this.currentLevel){const t=this.metrics.levels[this.currentLevel];t&&jt(t.activeRanges)}jt(this.metrics.general.activeRanges)})),this.logger=e,this.emitter=t}get fatalQosCount(){return this._fatalQosCount}setActive(){if(this.currentLevel){const t=this.metrics.levels[this.currentLevel];t&&Xt(t.activeRanges)}Xt(this.metrics.general.activeRanges)}};I(im,"create",((t,e)=>new im(t,e)));let nm=im;const sm=class{constructor(t,e){I(this,"renditions",new Map),I(this,"renditionLevels",[]),I(this,"languages",[]),I(this,"emitter"),I(this,"subscriptionSource"),I(this,"renditionLevelChangeCount",0),I(this,"unload",(()=>{this.emitter.off("renditions",this.onRenditions),this.emitter.off("subscription changed",this.onSubscriptionChanged)})),I(this,"getRenditionLevels",(t=>t?this.createRenditionLevels(t):this.renditionLevels)),I(this,"getRenditionLevel",(t=>{var e;const i=null!=t?t:this.getCurrentSubscription(),n=t?this.createRenditionLevels(t):this.renditionLevels;if(!i.video)return n.length?n[0]:void 0;const s=i.video.bitRate||Number.MAX_SAFE_INTEGER,r=i.video.width||Number.MAX_SAFE_INTEGER,a=i.video.height||Number.MAX_SAFE_INTEGER;return null!=(e=n.filter((t=>!t.video||!i.video||t.video.bitRate<=s&&t.video.width<=r&&t.video.height<=a)).pop())?e:n[0]})),I(this,"setRenditions",((t,e)=>{this.renditions.set(t,e)})),I(this,"getLanguages",(()=>this.languages)),I(this,"getVideoRendition",((t,e=this.getCurrentSubscription().channelId)=>{const i=this.getRendition(t,e);if(i&&ie(i))return i})),I(this,"getAudioRenditions",(t=>{const e=this.renditions.get(t);return null==e?void 0:e.filter((t=>ne(t)))})),I(this,"getVideoRenditions",(t=>{const e=this.renditions.get(t);return null==e?void 0:e.filter((t=>ie(t)))})),I(this,"getAudioRendition",((t,e=this.getCurrentSubscription().channelId)=>{const i=this.getRendition(t,e);if(i&&ne(i))return i})),I(this,"getRendition",((t,e=this.getCurrentSubscription().channelId)=>{var i;return null==(i=this.renditions.get(e))?void 0:i.find((e=>e.id===t))})),I(this,"getStatistics",(()=>{var t,e,i,n,s,r,a,o,l,h;const c=this.getRenditionLevel();return{videoCodec:null==(t=null==c?void 0:c.video)?void 0:t.codec,audioCodec:null==(e=null==c?void 0:c.audio)?void 0:e.codec,videoRenditionId:null==(i=null==c?void 0:c.video)?void 0:i.id,audioRenditionId:null==(n=null==c?void 0:c.audio)?void 0:n.id,videoWidth:null==(s=null==c?void 0:c.video)?void 0:s.width,videoHeight:null==(r=null==c?void 0:c.video)?void 0:r.height,expectedVideoBitRate:null==(a=null==c?void 0:c.video)?void 0:a.bitRate,expectedAudioBitRate:null==(o=null==c?void 0:c.audio)?void 0:o.bitRate,frameRate:null==(l=null==c?void 0:c.video)?void 0:l.frameRate,language:null==(h=null==c?void 0:c.audio)?void 0:h.language,renditionLevelChangeCount:this.renditionLevelChangeCount}})),I(this,"onRenditions",(t=>{const e=this.subscriptionSource.getCurrentSubscription();this.renditions.set(t.channelId,t.renditions),this.updateRenditionLevels({to:e,from:e})})),I(this,"onSubscriptionChanged",(t=>{this.updateRenditionLevels(t)})),I(this,"updateRenditionLevels",(({to:t,from:e})=>{var i;const{channelId:n,initiator:s}=t,r=this.getRenditionLevel(e),a=new Set;(null!=(i=this.renditions.get(n))?i:[]).filter((t=>"webvtt"!==t.codec)).forEach((t=>t.language?a.add(t.language):void 0)),this.languages=Array.from(a),this.renditionLevels=this.createRenditionLevels(t);const o=this.getRenditionLevel(t);kt(r,o)||(this.renditionLevelChangeCount++,this.emitter.emit("rendition level changed",{to:o,from:r,reason:s?"manual":"abr"}))})),I(this,"createRenditionLevels",(t=>{var e;const{video:i,audio:n,channelId:s}=t,r=null!=(e=this.renditions.get(s))?e:[],a=r.filter(ie).filter((t=>i&&t.codec===i.codec)),o=r.filter(ne).filter((t=>n&&t.codec===n.codec&&t.language===n.language)),l=Math.max(a.length,o.length),h=[];for(let t=0;t<l;t++){const e=a[Math.min(a.length-1,t)],i=o[Math.min(o.length-1,t)];h.push({audio:i,video:e})}return h})),I(this,"getCurrentSubscription",(()=>this.subscriptionSource.getCurrentSubscription())),this.subscriptionSource=e,this.emitter=t,this.emitter.on("renditions",this.onRenditions),this.emitter.on("subscription changed",this.onSubscriptionChanged)}};I(sm,"create",((t,e)=>new sm(t,e)));let rm=sm;const am=t=>JSON.parse(JSON.stringify(t)),om=class{constructor(t,e,i){I(this,"logger"),I(this,"timers",new Zt),I(this,"emitter"),I(this,"targetSubscription"),I(this,"currentSubscription"),I(this,"_isSwitchingSubscription",!1),I(this,"pendingSubscriptionTimeoutId"),I(this,"burstMs",0),I(this,"unload",(()=>{this.logger.debug("Unloading module..."),this.timers.unload(),this.emitter.off("subscription changed",this.onSubscriptionChanged),this.logger.debug("Unloaded module")})),I(this,"isSwitchingSubscription",(()=>this._isSwitchingSubscription)),I(this,"getTargetSubscription",(()=>this.targetSubscription)),I(this,"getCurrentSubscription",(()=>this.currentSubscription)),I(this,"enableBurst",(t=>{this.burstMs=t})),I(this,"setSize",(t=>{this.targetSubscription.video.width=t.width,this.targetSubscription.video.height=t.height,this.scheduleSubscriptionChange()})),I(this,"setVideoConstraint",(t=>{this.targetSubscription.video=t,this.scheduleSubscriptionChange()})),I(this,"setAudioConstraint",(t=>{this.targetSubscription.audio=t,this.scheduleSubscriptionChange()})),I(this,"setVideoBitRate",(t=>{this.targetSubscription.video.bitRate=t,this.scheduleSubscriptionChange()})),I(this,"setAudioBitRate",(t=>{this.targetSubscription.audio.bitRate=t,this.scheduleSubscriptionChange()})),I(this,"setChannelId",(t=>{this.targetSubscription.channelId=t,this.scheduleSubscriptionChange()})),I(this,"setLanguage",(t=>{this.targetSubscription.audio.language=t,this.scheduleSubscriptionChange()})),I(this,"setVideoCodec",(t=>{this.targetSubscription.video.codec=t,this.scheduleSubscriptionChange()})),I(this,"setAudioCodec",(t=>{this.targetSubscription.audio.codec=t,this.scheduleSubscriptionChange()})),I(this,"setBurst",(t=>{t?this.targetSubscription.burstMs=t:delete this.targetSubscription.burstMs})),I(this,"isNewSubscription",(()=>{const t=["burstMs","meta","initiator","channelGroupId"];return!kt(Ht(this.currentSubscription,t),Ht(this.targetSubscription,t))})),I(this,"onSubscriptionChanged",(({to:t,reset:e})=>{this.logger.debug("onSubscriptionChanged",{to:t,reset:e}),e?this.targetSubscription=am(this.currentSubscription):this.currentSubscription=am(t),this._isSwitchingSubscription=this.isNewSubscription()})),I(this,"scheduleSubscriptionChange",(()=>{this.targetSubscription=am(this.targetSubscription),this._isSwitchingSubscription=this.isNewSubscription();const t=this.currentSubscription.channelId,e=this.targetSubscription.channelId,i=t!==e;this._isSwitchingSubscription&&(i&&this.burstMs?this.setBurst(this.burstMs):this.setBurst(0),this.pendingSubscriptionTimeoutId&&(this.timers.clearTimeout(this.pendingSubscriptionTimeoutId),this.pendingSubscriptionTimeoutId=void 0),i&&this.timers.setTimeout((()=>{this.currentSubscription.channelId===t&&this.targetSubscription.channelId===e&&(this.logger.warn("Channel switch timeout",e),this.targetSubscription=am(this.currentSubscription),this.emitter.emit("channel switch timeout",e))}),1e4),this.pendingSubscriptionTimeoutId=this.timers.setTimeout((()=>this.emitter.emit("send signal",{type:"subscribe",subscription:this.getTargetSubscription()})),0))})),this.logger=t,this.targetSubscription=e,this.currentSubscription=am(e),this.emitter=i,this.emitter.on("subscription changed",this.onSubscriptionChanged)}};I(om,"create",((t,e,i)=>new om(t,i,e)));let lm=om;const hm=()=>at()||ot()||-1!==it.indexOf("CrKey")?100:0,cm=t=>e=>e>t,dm=class{constructor(t,e,i,n,s){I(this,"emitter"),I(this,"logger"),I(this,"playbackSource"),I(this,"bufferSource"),I(this,"keyframeTimestamps",new H(10)),I(this,"lastSeekTime",Date.now()),I(this,"seekCooldownTime",1e3),I(this,"seekTimeoutTime",5e3),I(this,"seekKeyframeOvershoot",50),I(this,"syncMaxBehind"),I(this,"syncMaxBehindMultiplierStep",1),I(this,"syncMaxBehindIncreaseEvery",2),I(this,"syncMaxBehindMaximumAllowed",2e3),I(this,"syncMaxBehindMultiplier",1),I(this,"timeshiftOnAudio",!1),I(this,"syncMaxAhead",150),I(this,"timeshiftSync",{enabled:!1,maxBehind:50,multiplier:1,maxBehindAllowed:600,overshoot:hm(),minOvershootAllowed:hm(),maxOvershootAllowed:500}),I(this,"maxTimeSyncDifferenceTolerance",150),I(this,"timers",Zt.create()),I(this,"rtt",0),I(this,"channelSyncInfo",new Map),I(this,"driftAdjustmentsCount",0),I(this,"timeshiftDriftAdjustmentCount",0),I(this,"driftAdjustments",[]),I(this,"timeShiftAdjustments",[]),I(this,"timestampOffset"),I(this,"currentChannelId"),I(this,"highestSeenTimestamps",new Map),I(this,"isSuspended",!1),I(this,"isSyncAdjustmentActivated",!1),I(this,"load",(()=>{this.timers.setInterval(this.onSync,100)})),I(this,"unload",(()=>{this.logger.debug("Unloading module..."),this.emitter.off("rtt",this.updateRtt),this.timers.unload(),this.logger.debug("Unloaded module")})),I(this,"suspend",(()=>{this.isSuspended=!0})),I(this,"unsuspend",(()=>{this.resetSyncState(),this.isSuspended=!1})),I(this,"deactivateSyncAdjustments",(()=>{this.isSyncAdjustmentActivated=!1})),I(this,"activateSyncAdjustments",(()=>{this.tryApplySyncInfo(0),this.lastSeekTime=Date.now(),this.isSyncAdjustmentActivated=!0})),I(this,"reset",(()=>{this.logger.info("Reset sync state"),this.currentChannelId=void 0,this.timestampOffset=void 0,this.resetSyncState(),this.highestSeenTimestamps.clear()})),I(this,"getTimeshiftOffset",(()=>{var t;return null!=(t=this.timestampOffset)?t:0})),I(this,"getCurrentChannelId",(()=>this.currentChannelId)),I(this,"resetSyncState",(()=>{this.timeshiftSync.multiplier=1,this.syncMaxBehindMultiplier=1,this.driftAdjustments=[],this.timeShiftAdjustments=[]})),I(this,"getLiveEdgeTime",(t=>{const e=this.channelSyncInfo.get(t);if(!e)return;const i=Date.now()-e.localTimestamp;return e.timestamp+i})),I(this,"getLiveEdgeTimeLatencyAdjusted",(t=>{const e=this.getLiveEdgeTime(t);if(e)return e+this.rtt/2})),I(this,"getWallclockTime",(t=>{const e=this.channelSyncInfo.get(t);if(!e)return;const i=Date.now()-e.localTimestamp;return e.wallclockTime+i})),I(this,"getWallclockTimeLatencyAdjusted",(t=>{const e=this.getWallclockTime(t);if(e)return e+this.rtt/2})),I(this,"processSample",(t=>{var e;if(!t.channelId)throw new Error("Sample must be assigned to a channel");this.currentChannelId||(this.currentChannelId=t.channelId),this.timestampOffset||(this.timestampOffset=t.timestamp/t.timescale*1e3-5e3);const i="video"===t.type&&t.isSync;if(this.currentChannelId!==t.channelId){let e=Number.MAX_SAFE_INTEGER;console.assert(0!==this.highestSeenTimestamps.size,"no known timestamps"),this.highestSeenTimestamps.forEach((t=>{e=Math.min(e,t)}));const i=t.timestamp/t.timescale*1e3;this.currentChannelId=t.channelId,this.timestampOffset=i-e}else(i||this.timeshiftOnAudio)&&this.tryTimeshiftSync();const n=this.timestampOffset*t.timescale/1e3;return t.timestamp-=n,i&&this.keyframeTimestamps.push(t.timestamp/t.timescale*1e3),this.highestSeenTimestamps.set(t.type,Math.max(null!=(e=this.highestSeenTimestamps.get(t.type))?e:0,t.timestamp/t.timescale*1e3)),t})),I(this,"processFragment",((t,e)=>{var i;this.currentChannelId||(this.currentChannelId=t);const n=e.mediaType();if(!n)throw new Error("Fragment must have a media type");this.timestampOffset||(this.timestampOffset=e.baseMediaDecodeTime()/e.timescale()*1e3-5e3);const s="video"===e.mediaType()&&e.startsWithKeyframe();this.currentChannelId!==t?(console.assert(0!==this.highestSeenTimestamps.size,"no known timestamps"),this.highestSeenTimestamps.forEach((t=>{})),this.currentChannelId=t):(s||this.timeshiftOnAudio)&&this.tryTimeshiftSync();const r=this.timestampOffset*e.timescale()/1e3;return e.updateBaseMediaDecodeTime(e.baseMediaDecodeTime()-r),s&&this.keyframeTimestamps.push(e.baseMediaDecodeTime()/e.timescale()*1e3),this.highestSeenTimestamps.set(n,Math.max(null!=(i=this.highestSeenTimestamps.get(n))?i:0,e.baseMediaDecodeTime()/e.timescale()*1e3)),e})),I(this,"getStatistics",(()=>({drift:this.drift,driftAdjustmentCount:this.driftAdjustmentsCount,timeshiftDriftAdjustmentCount:this.timeshiftDriftAdjustmentCount,seekTime:this.playbackSource.seekTime}))),I(this,"updateRtt",(t=>{this.rtt=t})),I(this,"isPlaybackSourceReadyToSeek",(()=>!this.isSeeking()&&this.isSeekCooldownExpired()&&this.isSyncAdjustmentActivated)),I(this,"isSeeking",(()=>!!this.playbackSource.isSeeking&&!this.isSeekTimeoutExpired())),I(this,"isAllowedToSync",(()=>this.isPlaybackSourceReadyToSeek()&&!!this.currentChannelId&&!this.isSuspended&&!this.playbackSource.isPaused)),I(this,"isSeekCooldownExpired",(()=>Date.now()-this.lastSeekTime>this.seekCooldownTime)),I(this,"isSeekTimeoutExpired",(()=>Date.now()-this.lastSeekTime>this.seekTimeoutTime)),I(this,"currentTimeshiftMaxBehind",(()=>Math.min(this.timeshiftSync.maxBehind*this.timeshiftSync.multiplier,this.timeshiftSync.maxBehindAllowed))),I(this,"currentSyncMaxBehind",(()=>Math.min(this.syncMaxBehindMultiplier*this.syncMaxBehind,this.syncMaxBehindMaximumAllowed))),I(this,"currentSyncMaxAhead",(()=>this.playbackSource.seekTime>500?Math.max(this.syncMaxAhead*this.syncMaxBehindMultiplier,300):this.syncMaxAhead)),I(this,"tryTimeshiftSync",(()=>{var t;if(!this.timeshiftSync.enabled||!this.isAllowedToSync())return;const e=null!=(t=this.drift)?t:0;if(e>=this.syncMaxBehind)return;if(e<this.currentTimeshiftMaxBehind())return void(this.timeshiftSync.overshoot=0);if(!this.timestampOffset)return;const i=Date.now()-this.seekTimeoutTime*this.timeshiftSync.multiplier,n=this.timeShiftAdjustments.filter(cm(i)).length;if(n&&this.timeshiftSync.multiplier>2)return this.logger.debug("Too many diff timeShifts within sliding window",{timeShiftsCooldownMs:i,timeShiftsWithinCooldownTime:n}),!1;const s=e+this.timeshiftSync.overshoot;this.logger.info("Adjusting for drift using timeshift",{drift:e,syncAmount:s,currentTime:this.playbackSource.currentTime,rtt:this.rtt,overshoot:this.timeshiftSync.overshoot}),this.timestampOffset+=s,this.lastSeekTime=Date.now(),!this.playbackSource.isPaused&&(this.timeShiftAdjustments.push(this.lastSeekTime),this.timeshiftDriftAdjustmentCount++,this.timeshiftSync.multiplier++,this.timeshiftSync.overshoot=Math.max(this.timeshiftSync.minOvershootAllowed,Math.min(this.timeshiftSync.multiplier*e/2,this.timeshiftSync.maxOvershootAllowed)))})),I(this,"onSync",(()=>{var t;if(!this.isAllowedToSync())return;const e=null!=(t=this.drift)?t:0;if(e<0&&-e<this.currentSyncMaxAhead()||e>0&&e<this.currentSyncMaxBehind()||Math.abs(e)<1||!this.isSeekCooldownExpired())return;const i=Date.now()-this.seekTimeoutTime*this.syncMaxBehindMultiplier,n=this.driftAdjustments.filter(cm(i)).length;if(n&&this.syncMaxBehindMultiplier>2)return this.logger.debug("Too many diff adjustments within sliding window",{adjustmentsCooldownMs:i,adjustmentsWithinCooldownTime:n}),!1;const s=this.playbackSource.seekTime,r=this.playbackSource.currentTime+e,a=this.findKeyframeCloseToTimestamp(r);if(a||this.keyframeTimestamps.isEmpty()){const t=a?a+this.seekKeyframeOvershoot:r;if(this.logger.info("Adjusting for drift using seek",{drift:e,currentTime:this.playbackSource.currentTime,targetCurrentTime:t,seekTime:s,rtt:this.rtt}),this.lastSeekTime=Date.now(),this.driftAdjustments.push(this.lastSeekTime),this.driftAdjustmentsCount++,this.playbackSource.currentTime=t+s,this.timeshiftSync.overshoot=Math.max(this.timeshiftSync.minOvershootAllowed,this.timeshiftSync.overshoot/2),this.driftAdjustmentsCount%this.syncMaxBehindIncreaseEvery==0&&!this.playbackSource.isPaused){const t=this.currentSyncMaxBehind;this.syncMaxBehindMultiplier+=this.syncMaxBehindMultiplierStep,t!==this.currentSyncMaxBehind&&this.logger.info("Increasing max drift behind allowed",{from:t,to:this.currentSyncMaxBehind})}}})),I(this,"findKeyframeCloseToTimestamp",(t=>{const e=this.keyframeTimestamps.items();for(const i of e)if(i>=t&&i<=t+200)return i})),this.logger=e,this.emitter=t,this.playbackSource=i,this.bufferSource=n,this.timeshiftSync.enabled=s,this.syncMaxBehind=this.timeshiftSync.enabled?1e3:200,this.emitter.on("rtt",this.updateRtt)}updateChannelSyncInfo(t,e){const i=Date.now(),n=this.channelSyncInfo.get(t),s=this.getLiveEdgeTime(t);if(this.isSuspended)return;if(!n||!s)return this.logger.info("Initial timing info",{syncInfo:e}),void this.channelSyncInfo.set(t,A(f({},e),{localTimestamp:i,timeDifferences:new H(12)}));const r=e.wallclockTime-n.wallclockTime,a=e.timestamp-n.timestamp,o=i-n.localTimestamp,l=a-o;if(n.timeDifferences.push(l),this.logger.debug("Timing info",{rtt:this.rtt,channelId:t,syncInfo:e,localTimestamp:i,diffFromEstimated:l,timestampDelta:a,wallclockDelta:r,localWallclockDelta:o}),Math.abs(l)>=2*this.bufferSource.getTargetBufferTime())return this.logger.info("Resetting sync info",{diffFromEstimated:l}),this.channelSyncInfo.set(t,A(f({},e),{localTimestamp:i,timeDifferences:new H(n.timeDifferences.maxSize+1)})),void(this.currentChannelId&&this.currentChannelId===t&&(this.reset(),this.emitter.emit("channel reset")));n.timeDifferences.isFull()&&this.tryApplySyncInfo(this.maxTimeSyncDifferenceTolerance)}tryApplySyncInfo(t){const e=this.getCurrentChannelId();if(!e)return;const i=this.channelSyncInfo.get(e);if(!i)return;const n=wt(i.timeDifferences.items());Math.abs(n)>t&&(this.logger.info("Adjusting sync info",{averageDifference:n}),i.timestamp+=n,i.timeDifferences.clear())}get serverCurrentTime(){return this.channelCurrentTime-this.getTimeshiftOffset()}get channelCurrentTime(){const t=this.getCurrentChannelId();if(!t)return 0;const e=this.getLiveEdgeTime(t);return e?e-this.bufferSource.getTargetBufferTime():0}get drift(){return this.serverCurrentTime-this.playbackSource.currentTime}};I(dm,"create",((t,e,i,n,s)=>new dm(t,e,i,n,s)));let um=dm;const mm={enabled:!0,interval:3e4,includeErrors:!0,includeEvents:!0,includeStats:!0,maxRetries:10,maxErrorReports:50,maxEvents:50},pm=(t,e)=>A(f({},e),{type:t,timestamp:(new Date).toISOString(),discriminator:"web"}),gm=class{constructor(t,e,i,n){I(this,"logger"),I(this,"timers",new Zt),I(this,"emitter"),I(this,"options"),I(this,"parentContext"),I(this,"unsentLines",new H(100)),I(this,"retries",0),I(this,"errorCount",0),I(this,"eventCount",0),I(this,"statsCount",0),I(this,"unload",(()=>{this.logger.debug("Unloading module..."),window.removeEventListener("error",this.onError),window.removeEventListener("unhandledrejection",this.onRejection),this.timers.unload(),this.emitter.off("error",this.addError),this.emitter.off("visibilitystate",this.onVisibilityChange),this.emitter.off("pagehide",this.onPageHide),this.emitter.off("telemetry event",this.addEvent),this.addStats({isFinal:!0,initiator:"unload"}),this.send("beacon"),this.logger.debug("Unloaded module")})),I(this,"load",(()=>{window.addEventListener("error",this.onError),window.addEventListener("unhandledrejection",this.onRejection),this.emitter.on("error",this.addError),this.emitter.on("visibilitystate",this.onVisibilityChange),this.emitter.on("pagehide",this.onPageHide),this.emitter.on("telemetry event",this.addEvent),this.timers.setInterval((()=>{this.addStats(),this.send("fetch")}),this.options.interval)})),I(this,"addStats",(({isFinal:t,initiator:e}={isFinal:!1,initiator:"interval"},i={})=>{if(!this.options.includeStats)return;const n=this.parentContext.getStatistics(),s=pm("stats",A(f(f({},i),n),{isFinal:t,initiator:e,count:this.statsCount++}));this.unsentLines.push(s)})),I(this,"addEvent",(t=>{if(!this.options.includeEvents||this.eventCount>this.options.maxEvents)return;const e=this.parentContext.getStatistics(),i=pm("event",f(f({},e),t));this.eventCount++,this.unsentLines.push(i)})),I(this,"getStatistics",(()=>({errorCount:this.errorCount}))),I(this,"send",(t=>B(this,null,(function*(){if(this.options.enabled&&!(this.retries>=this.options.maxRetries)&&!this.unsentLines.isEmpty()){this.logger.debug("Sending telemetry",{lines:this.unsentLines.items()});try{const e=this.unsentLines.items().map((t=>JSON.stringify(t))).reverse().join("\n");"beacon"===t?navigator.sendBeacon(this.options.url,e):"connected"===this.parentContext.connectionState?this.emitter.emit("send signal",{type:"telemetry",body:e}):yield(0,s.p)(new URL(this.options.url),{body:e,headers:{"Content-Type":"text/plain"}}),this.retries=0,this.unsentLines.clear()}catch(t){this.retries++}}})))),I(this,"onVisibilityChange",(t=>{"hidden"===t&&(this.addStats({isFinal:!0,initiator:"visibilitychange"}),this.send("beacon"))})),I(this,"onPageHide",(t=>{this.addStats({isFinal:!0,initiator:"pagehide"},{persisted:t.persisted}),this.send("beacon")})),I(this,"onRejection",(t=>this.addError(t.reason))),I(this,"onError",(t=>this.addError(t.error))),I(this,"addError",(t=>{const{includeErrors:e,maxErrorReports:i}=this.options;if(e&&t instanceof de){if(this.errorCount++,this.errorCount>i)return;const e=this.parentContext.getStatistics();this.unsentLines.push(pm("error",f(f({},e),t.toStringifiable())))}})),this.logger=t,this.emitter=e,this.options=f(f({},mm),i),this.parentContext=n}};I(gm,"create",((t,e,i,n)=>new gm(t,e,i,n)));let fm=gm;const Am=class{constructor(t,e,i){I(this,"logger"),I(this,"element"),I(this,"documentState"),I(this,"timers",new Zt),I(this,"unload",(()=>{this.timers.unload()})),I(this,"unpause",(()=>{this.element.userHasProvidedInput&&this.element.isPaused&&this.documentState.isVisible&&this.documentState.isOnline&&(this.logger.debug("Unpause video"),this.element.tryPlay())})),this.logger=t,this.element=e,this.documentState=i,this.timers.setInterval(this.unpause,100)}};I(Am,"create",((t,e,i)=>new Am(t,e,i)));let vm=Am;class bm{constructor(){var t;I(this,"highEntropyValues"),null==(t=self.navigator.userAgentData)||t.getHighEntropyValues(["architecture","model","platformVersion","fullVersionList"]).then((t=>{this.highEntropyValues=t}))}getUserAgentInformation(){var t,e,i,n,s,r;const a=window.location.origin,o=a&&"null"!=a?`${window.location.pathname}${window.location.search}`.substring(0,1e3):"",l={locationOrigin:window.location.origin,locationPath:o,ancestorOrigins:(null==(t=window.location.ancestorOrigins)?void 0:t.length)>0?Array.from(window.location.ancestorOrigins):void 0,hardwareConcurrency:navigator.hardwareConcurrency,deviceMemory:navigator.deviceMemory};if(self.navigator.userAgentData&&this.highEntropyValues){const t="1",a=[...null!=(e=this.highEntropyValues.brands)?e:[]];a.sort(((t,e)=>t.brand.localeCompare(e.brand)));const o=[...null!=(i=this.highEntropyValues.fullVersionList)?i:[]];o.sort(((t,e)=>t.brand.localeCompare(e.brand)));const h=o.map((t=>t.version)),c=a.map((t=>t.brand)),d=a.map((t=>t.version)),u=parseInt(null!=(s=null==(n=this.highEntropyValues.platformVersion)?void 0:n.split(".")[0])?s:t);return f({userAgentLegacy:window.navigator.userAgent,ua:{browser:{brands:c,fullVersionBrands:h,majorVersions:d},device:this.highEntropyValues.model||"Other",os:{family:this.highEntropyValues.platform||"Other",version:null!=(r=this.highEntropyValues.platformVersion)?r:t,major_version:Number.isFinite(u)?u:0}}},l)}return f({userAgent:window.navigator.userAgent},l)}}var wm,ym,Sm;const km=class t extends n.E{constructor(e){var i,r;super(),I(this,"pictureInPicture"),I(this,"drm"),I(this,"browser",ut()),I(this,"options"),I(this,"element"),I(this,"playbackSource"),I(this,"emitter",new n.E),I(this,"logger"),I(this,"modules"),I(this,"clientIp"),I(this,"sessionId"),I(this,"clientId",Jt()),I(this,"_channels",[]),I(this,"createdAt",Date.now()),I(this,"hasCalledConnect",!1),I(this,"latestEmittedLanguages",[]),I(this,"wakeLock"),I(this,"pool",new V(t.MAX_POOL_SIZE)),I(this,"userAgentInformation",new bm),I(this,"encryptedMediaExtensions"),U(this,wm,0),U(this,ym,[]),I(this,"sampleProcessingSesssions",new Map),I(this,"sizes",new Map),I(this,"isSuspended",!0),I(this,"disconnectTimeout"),U(this,Sm),I(this,"attach",(t=>{var e;null==(e=this.wakeLock)||e.attach(t),t.appendChild(this.element)})),I(this,"getOptions",(()=>this.options.getOptions())),I(this,"getThumbnailUrl",(()=>{let t=this.options.get("edgeUrl")||this.options.get("url");t=t.replace("wss://","https://"),t=t.replace("ws://","http://"),t=t.endsWith("/")?t.slice(0,-1):t;const e=window.devicePixelRatio||1,i=Math.round(window.innerWidth*e),n=Math.round(window.innerHeight*e),s=this.options.get("authenticationToken"),r=s?`&auth.token=${s}`:"";return`${t}/api/thumbnail?channelId=${this.channelId}${r}&width=${i}&height=${n}`})),I(this,"updateAuthenticationToken",(t=>{this.logger.debug("Got new auth token",{token:t}),this.options.set("authenticationToken",t),this.emitter.emit("send signal",{type:"refresh auth",token:t})})),I(this,"connect",(()=>{this.hasCalledConnect||(this.play(),this._connect())})),I(this,"_connect",(()=>{var t,e;this.hasCalledConnect||(this.hasCalledConnect=!0,Object.values(this.modules).forEach((t=>{t&&"load"in t&&t.load()})),this.unsuspend(),this.playbackSource instanceof os&&(null==(e=(t=this.playbackSource).load)||e.call(t)),this.modules.connection.connect())})),I(this,"getCastOptions",(()=>({url:this.options.get("url"),channelId:this.options.get("channelId"),channelGroupId:this.options.get("channelGroupId"),authenticationToken:this.options.get("authenticationToken"),language:this.options.get("language"),logLevel:this.options.get("logLevel"),minBufferTime:this.options.get("minBufferTime"),tags:this.options.get("tags"),ownerSessionId:this.sessionId,edgeUrl:this.options.get("edgeUrl"),media:this.options.get("media"),drm:this.options.get("drm")}))),I(this,"onConnectInfo",(t=>B(this,null,(function*(){var e;this.sessionId=Jt();const i=this.modules.subscription.getTargetSubscription(),n=t.channels.find((t=>t.channelId===i.channelId));if(this.emitter.emit("connect info",t),this._channels=t.channels,this.updateTextTracks(null!=(e=null==n?void 0:n.renditions)?e:[]),!this.textTrack&&this.options.get("textTrack")&&(this.textTrack=this.options.get("textTrack")),yield Promise.all(t.channels.map((t=>B(this,null,(function*(){t.overrides&&this.options.addOverrides(t.channelId,t.overrides),t.renditions=yield this.filterRenditions(t.renditions),this.modules.renditions.setRenditions(t.channelId,t.renditions)}))))),!n)throw ve("external");const s=this.options.getOverride("sizeBasedResolutionCapEnabled",this.channelId);void 0!==s&&(this.modules.constraintCap.sizeBasedResolutionCapEnabled=s);const r=this.options.getOverride("minBufferTime",this.channelId),a=this.options.getOverride("maxBufferTime",this.channelId);if((r||a)&&(this.modules.bufferTime.updateConfig({minBufferTime:this.options.get("minBufferTime",this.channelId),maxBufferTime:this.options.get("maxBufferTime",this.channelId)}),this.targetBufferTime=this.options.get("minBufferTime",this.channelId)),this.options.get("burstEnabled",this.channelId)&&this.modules.subscription.enableBurst(this.targetBufferTime),this.emit("is live",n.isLive),!n.isLive)throw new Error("Waiting for channel to go live");this.patchSubscription(n,this.modules.connection.estimatedBandwidth),yield this.initializeDecodingModule(),this.resetModules(),this.emit("rendition levels",this.modules.renditions.getRenditionLevels()),this.emit("channels",this.channels),this.emitLanguagesIfChanged(),this.sampleProcessingSesssions.clear();const o=this.options.get("burstEnabled",this.channelId);return{video:this.targetSubscription.video,audio:this.targetSubscription.audio,burstMs:o?this.targetBufferTime:void 0,sessionId:this.sessionId,clientId:this.clientId,channelId:this.channelId,channelGroupId:this.options.get("channelGroupId"),authToken:this.options.get("authenticationToken"),textTrack:this.textTrack}})))),I(this,"emitLanguagesIfChanged",(()=>{const t=this.modules.renditions.getLanguages(),e=this.latestEmittedLanguages;t.length==e.length&&t.every((t=>e.includes(t)))||(this.logger.debug("Emitting new languages",{currentLanguages:t}),this.latestEmittedLanguages=t,this.emit("languages",this.latestEmittedLanguages))})),I(this,"updateTextTracks",(t=>{const e=t.filter((t=>"webvtt"===t.codec));e.forEach((t=>{if(!M(this,ym).find((e=>e.language===t.language)))if(this.modules.canvasModule){const e=this.modules.canvasModule.textTracks.addTextTrack(t.kind,t.label||t.language||"",t.language||"");M(this,ym).push(e)}else if(this.mediaElement instanceof HTMLVideoElement){const e=this.mediaElement.addTextTrack(t.kind,t.label||t.language,t.language);M(this,ym).push(e)}}));for(const t of M(this,ym))e.find((e=>e.language===t.language))?"disabled"===t.mode&&(t.mode="hidden"):t.mode="disabled";this.emit("text tracks",this.textTracks)})),I(this,"cleanupTextTracks",((t=this.currentTime-2e4)=>{M(this,ym).forEach((e=>{if(e.cues)for(const i of e.cues)1e3*i.endTime<t-2e3&&e.removeCue(i)}))})),I(this,"filterRenditions",(t=>B(this,null,(function*(){const e=yield Promise.all(t.map((t=>B(this,null,(function*(){var e,i,n;if(ne(t))return!0;if(!ie(t)||!this.isSupportedVideoCodecProfile(t.codec,t.codecString))return!1;if(!this.willUseMediaSource()){const s=this.options.get("advanced"),r=null!=(e=s.wasmDecodingConstraint.bitRate)?e:Number.MAX_SAFE_INTEGER,a=null!=(i=s.wasmDecodingConstraint.width)?i:Number.MAX_SAFE_INTEGER,o=null!=(n=s.wasmDecodingConstraint.height)?n:Number.MAX_SAFE_INTEGER;return t.bitRate<=r&&t.width<=a&&t.height<=o}const s=yield(t=>{if(!navigator.mediaCapabilities)return Promise.resolve({smooth:!0,supported:!0,powerEfficient:!0,failedToQuery:!0});if("webvtt"===t.codec)throw new Error("WebVTT is not supported");let e;return e=ne(t)?{type:"media-source",audio:{contentType:se(t),bitrate:t.bitRate,channels:t.channels.toString(),samplerate:t.sampleRate}}:{type:"media-source",video:{contentType:se(t),bitrate:t.bitRate,width:t.width,height:t.height,framerate:t.frameRate[0]/t.frameRate[1]}},navigator.mediaCapabilities.decodingInfo(e)})(t);if(!s.supported||"av1"==t.codec&&!s.smooth&&!s.powerEfficient)return!1;const r=this.options.getOverride("maxVideoBitRate",this.channelId);return!r||r>=t.bitRate})))));let i=t.filter(((t,i)=>e[i]));const n=i.filter((t=>"h264"===t.codec)).reverse()[0],s=i.filter((t=>"av1"===t.codec)).reverse()[0];return n&&s&&n.width>s.width&&n.height>s.height&&(i=i.filter((t=>"av1"!==t.codec))),i})))),I(this,"patchSubscription",((e,i)=>{const n=Math.min(this.options.get("maxVideoBitRate"),t.INITIAL_MAX_BIT_RATE,i,this.targetSubscription.video.bitRate),s=Math.min(this.options.get("maxAudioBitRate"),t.INITIAL_MAX_BIT_RATE,i,this.targetSubscription.audio.bitRate),r="audio"===this.options.get("media")?[]:this.options.get("videoCodecs",this.channelId),a=this.supportedAudioCodecs(),o=e.renditions.filter(ne),l=e.renditions.filter(ie),h=a.find((t=>void 0!==o.find((e=>e.codec===t)))),c=r.find((t=>void 0!==l.find((e=>e.codec===t)))),d=o.map((t=>t.language));if(this.logger.debug("supported and selected codecs",{audioCodecs:a,videoCodecs:r,audioCodec:h,videoCodec:c}),c){const t=this.options.get("maxSize");this.modules.subscription.setVideoConstraint(f({codec:c,bitRate:this.abrEnabled?n:this.options.get("maxVideoBitRate")},t))}h&&(this.modules.subscription.setAudioConstraint({codec:h,bitRate:this.abrEnabled?s:this.options.get("maxAudioBitRate"),language:this.options.get("language")}),(!d.includes(this.options.get("language"))||void 0===this.language)&&this.modules.subscription.setLanguage(d[0])),this.alignSizeAndBitRate(this.targetSubscription);const u=this.modules.subscription.getTargetSubscription();this.emitter.emit("subscription changed",{to:u,from:this.modules.subscription.getCurrentSubscription()})})),I(this,"isSupportedVideoCodecProfile",((t,e)=>{if(this.willUseMediaSource()){const i=tt();return!i||i.isTypeSupported(se({codec:t,codecString:e}))}if("h264"===t){const t=!(null==e||!e.startsWith("avc1.42")),i=!(null==e||!e.startsWith("avc1.66."));return t||i}return"av1"!==t})),I(this,"supportedAudioCodecs",(()=>{if("video"===this.options.get("media"))return[];const t=[];return(this.browser.supportsMp4Opus&&this.options.get("mseOpusEnabled")||!this.willUseMediaSource())&&t.push("opus"),this.willUseMediaSource()&&t.push("aac"),t})),I(this,"initializeDecodingModule",(()=>B(this,null,(function*(){var t,e;const i=this.currentRenditionLevel,n=[];if(!i)throw new de("No currentRenditionLevel",{code:"no_current_rendition_level",isFatal:!1});if(null!=i&&i.video&&n.push({type:"video",mimeType:se(i.video),codec:i.video.codec}),null!=i&&i.audio&&n.push({type:"audio",codec:i.audio.codec,mimeType:se(i.audio)}),0===n.length)throw new de("Can't initialize decoding module without tracks",{code:"no_tracks",isFatal:!1});if(this.willUseMediaSource()&&this.element instanceof HTMLMediaElement)this.emitter.emit("flush buffers"),yield null==(t=this.modules.mseModule)?void 0:t.setSourceBuffers(n);else{const t=yield Vd.create(this.emitter,this.logger.createContext("DecoderModule"),n,this.playbackSource,this.pool);null==(e=this.modules.decoder)||e.unload(),this.modules.decoder=t,this.modules.decoder.load()}})))),I(this,"unload",(()=>B(this,null,(function*(){var e,i,n;this.logger.debug("Unloading modules..."),yield Promise.all(Object.values(this.modules).map((t=>null==t?void 0:t.unload()))),null==(e=this.wakeLock)||e.unload(),this.pool=new V(t.MAX_POOL_SIZE),null==(n=(i=this.playbackSource).unload)||n.call(i),this.element.remove(),this.emitter.reset(),this.encryptedMediaExtensions.unload(),this.reset(),this.logger.debug("Unloaded modules")})))),I(this,"userInput",(()=>{this.play()})),I(this,"pause",(()=>{this.options.get("pauseSupportEnabled")&&"paused"!==this.playbackState&&(this.playbackSource.pause(),this.hasCalledConnect&&this.suspend())})),I(this,"registerDebugInstance",(()=>{(t=>{const e=window;e.vindralInstances=e.vindralInstances||{},e.vindralInstances[t.getStatistics().clientId.substring(0,8)]=t})(this)})),I(this,"play",(()=>{var e;this.hasCalledConnect?this.unsuspend():"playing"!==this.playbackState&&(this._connect(),self.addEventListener("__vindral_register_debug__",this.registerDebugInstance),this.modules.timer.setInterval((()=>this.cleanupTextTracks()),t.REMOVE_CUE_THRESHOLD)),null==(e=this.wakeLock)||e.enable(),"paused"===this.playbackState&&(this.resetModules(),this.emitter.emit("flush buffers"),this.cleanupTextTracks(Number.MAX_SAFE_INTEGER)),this.playbackSource.play()})),I(this,"getStatistics",(()=>Object.values(this.modules).reduce(((t,e)=>e&&"getStatistics"in e?f(f({},t),e.getStatistics()):t),this.getRuntimeInfo()))),I(this,"resetModules",(()=>{Object.values(this.modules).forEach((t=>{t&&"reset"in t&&t.reset()})),this.sampleProcessingSesssions.clear(),this.playbackSource.currentTime=0,this.playbackSource.isActivated=!1})),I(this,"getRuntimeInfo",(()=>{const t=this.modules.canvasModule?this.options.get("iosMediaElementEnabled"):void 0;return f({uptime:Date.now()-this.createdAt,version:"4.1.1",clientId:this.clientId,sessionId:this.sessionId,channelId:this.channelId,channelGroupId:this.options.get("channelGroupId"),ip:this.clientIp,url:this.options.get("url"),timeToFirstFrame:this.timeToFirstFrame(),iosMediaElementEnabled:t},this.userAgentInformation.getUserAgentInformation())})),I(this,"onMediaElementState",(t=>{this.logger.info("media element state",{state:t}),this.options.get("pauseSupportEnabled")&&("paused"===t?this.modules.documentState.isVisible&&(this.suspend(),this.modules.connection.disconnect()):(this.unsuspend(),"disconnected"===this.modules.connection.getState()&&this.modules.connection.unsuspend()))})),I(this,"onBufferEvent",(t=>{var e,i,n,s;this.emit("buffer state event",t);const r=!this.playbackSource.isActivated||this.playbackSource.isPaused;if("filled"===t&&r){const t=Math.max(this.currentTime,null!=(i=null==(e=this.videoBufferedRanges[0])?void 0:e.start)?i:0,null!=(s=null==(n=this.audioBufferedRanges[0])?void 0:n.start)?s:0);this.logger.info("Buffer filled - starting playback",{currentTime:t}),this.playbackSource.currentTime=t,this.modules.sync.activateSyncAdjustments(),this.playbackSource.isActivated=!0}else"drained"===t&&this.playbackSource.isPaused&&(this.playbackSource.isActivated=!1,this.modules.sync.deactivateSyncAdjustments())})),I(this,"timeToFirstFrame",(()=>{const t=this.modules.playback.getFirstFrameTime(),e=this.modules.connection.firstConnectionTime;if(e&&t)return t-e})),this.options=new hs(f(f({},le),(t=>{if(!(t=>!("object"!=typeof t||!ke(t,"channelId")||"string"!=typeof t.channelId||!ke(t,"url")||"string"!=typeof t.url||0===t.channelId.length||0===t.url.length))(t))throw new de("Invalid options",{isFatal:!0,code:"invalid_options"});const e=f({},t);return Object.keys(e).forEach((t=>{const i=e;void 0===i[t]&&delete i[t]})),e})(e))),void 0===e.telemetryEnabled&&["localhost","127.0.0.1"].includes(location.hostname)&&this.options.set("telemetryEnabled",!1);const a={channelId:this.options.get("channelId"),audio:{language:this.options.get("language"),bitRate:this.options.get("maxAudioBitRate")},video:{bitRate:this.options.get("maxVideoBitRate"),width:this.options.get("maxSize").width,height:this.options.get("maxSize").height}},o=Rt.get();o.setLevel(this.options.get("logLevel")),o.setDebug(!1),this.logger=o;const l=Ju.create(this.emitter,this.logger.createContext("PictureInPictureModule")),h=Zt.create(),c=Nd.create(this.emitter,this.logger.createContext("ConnectionModule"),{reconnectHandler:this.options.get("reconnectHandler"),options:this.options,onConnectInfo:this.onConnectInfo}),d=lm.create(this.logger.createContext("SubscriptionModule"),this.emitter,a),u=rm.create(this.emitter,d),m=nm.create(this.emitter,this.logger.createContext("QualityOfServiceModule")),p=tm.create(this.emitter,this.logger.createContext("PlaybackModule"),this,this.options.get("minBufferTime"));this.encryptedMediaExtensions=new ui(this.emitter,this.logger.createContext("EncryptedMediaExtensions"),null==(i=e.drm)?void 0:i.headers,null==(r=e.drm)?void 0:r.queryParams),this.drm={setHeaders:t=>{this.encryptedMediaExtensions.headers=t},setQueryParams:t=>{this.encryptedMediaExtensions.queryParams=t}};const g=zd.create(this.emitter),v=this.options.get("poster"),b=!0===v?this.getThumbnailUrl():v||void 0;let w,y,S;if(this.willUseMediaSource()){const t=new os({type:"audio"==this.options.get("media")?"audio":"video",autoplay:!1,muted:this.options.get("muted")||"video"===this.options.get("media"),logger:this.logger.createContext("MediaElement"),poster:b});t.on("buffer state",(t=>this.emitter.emit("buffer state",t))),t.on("needs user input",(t=>this.emitter.emit("needs user input",t))),t.on("volume state",(t=>this.emit("volume state",t))),t.on("media element state",(t=>this.onMediaElementState(t))),this.element=t.element,this.playbackSource=t,ui.isSupported()&&this.encryptedMediaExtensions.attach(t.element),w=Qu.create(this.logger.createContext("MseModule"),this.emitter,this.element),this.options.get("pauseSupportEnabled")||(y=vm.create(this.logger.createContext("UnpauseModule"),t,g)),this.options.get("pictureInPictureEnabled")&&this.emitter.emit("add picture in picture listener",{element:t.element})}else if(this.browser.platform.iosVersion>=15&&this.options.get("iosMediaElementEnabled")){const t=Wu.create(this.emitter,this.logger.createContext("ModernCanvasModule"),this.pool,this,{type:"audio"==this.options.get("media")?"audio":"video",muted:this.options.get("muted")||"video"===this.options.get("media"),poster:b}),e=t.element();this.element=e.element,this.playbackSource=t,S=t,this.options.get("pictureInPictureEnabled")&&this.browser.platform.iosVersion>15&&this.emitter.emit("add picture in picture listener",{element:this.element}),this.options.get("pauseSupportEnabled")||(y=vm.create(this.logger.createContext("UnpauseModule"),e,g))}else{const t=Du.create(this.emitter,this.logger.createContext("LegacyCanvasModule"),this.pool,this,this.options.get("muted")||"video"===this.options.get("media"));this.element=t.element(),this.playbackSource=t,S=t,this.options.get("iosWakeLockEnabled")&&(this.wakeLock=new Jn)}this.emitter.on("channel reset",this.resetModules),this.emitter.on("no data timeout",this.resetModules),this.emitter.on("media element state",(t=>this.onMediaElementState(t))),this.emitter.on("volume state",(t=>this.emit("volume state",t))),this.options.get("pauseSupportEnabled")||this.emitter.on("exit picture in picture",(()=>h.setTimeout((()=>this.play()),0))),this.emitter.on("constraint cap changed",(t=>{this.logger.info("new cap set",{cap:t}),this.alignSizeAndBitRate(this.targetSubscription)})),this.pictureInPicture={enter:()=>l.requestPictureInPicture(),exit:()=>l.exitPictureInPicture(),isActive:()=>l.isPictureInPictureActive(),isSupported:()=>l.isPictureInPictureSupported()},this.emitter.on("error",(t=>{if("external"===t.type()&&this.emit("error",t),t.isFatal())return()=>{this.unload()}}));const k=this.browser.platform.isIOS&&!this.browser.platform.isIpadOS,E=um.create(this.emitter,this.logger.createContext("SyncModule"),this.playbackSource,p,this.willUseMediaSource()&&!k),T=(this.options.get("edgeUrl")||this.options.get("url")).replace("wss://","https://").replace("ws://","http://").replace("//lb.","//errors."),C=new URL("/telemetry",T).toString(),x=fm.create(this.logger.createContext("TelemetryModule"),this.emitter,{url:C,enabled:this.options.get("telemetryEnabled"),includeStats:!1,interval:5e3},this);let L;this.modules={telemetry:x,bufferTime:fs.create(this.emitter,this.logger.createContext("BufferTimeModule"),m,this,{maxBufferTime:this.options.get("maxBufferTime"),minBufferTime:this.options.get("minBufferTime")}),incomingData:qd.create(this.emitter),adaptivity:ms.create(this.emitter,this.logger.createContext("AdaptivityModule"),m,{cooldownTime:Math.max(this.options.get("minBufferTime"),2e3)}),constraintCap:Fd.create(this.emitter,this.element,u,!!this.options.get("abrEnabled")&&this.options.get("sizeBasedResolutionCapEnabled")),event:jd.create(this.emitter,this.logger.createContext("EventModule"),E),sync:E,documentState:g,connection:c,playback:p,pictureInPicture:l,timer:h,subscription:d,renditions:u,qualityOfService:m,mseModule:w,unpause:y,canvasModule:S},this.modules.adaptivity.isEnabled=this.options.get("abrEnabled"),this.emitter.on("page active",(e=>{var i;e&&"number"==typeof this.disconnectTimeout&&(this.modules.timer.clearInterval(this.disconnectTimeout),this.disconnectTimeout=void 0),e?this.playbackSource.isPaused||(this.logger.debug("Unsuspending"),this.unsuspend()):(this.logger.debug("Suspending"),this.suspend(),this.modules.decoder?this.options.get("iosBackgroundPlayEnabled")?(this.modules.decoder.unsuspend(),null==(i=this.modules.canvasModule)||i.unsuspend()):this.modules.connection.disconnect():(this.disconnectTimeout&&this.modules.timer.clearInterval(this.disconnectTimeout),this.disconnectTimeout=this.modules.timer.setInterval((()=>{const t="paused"===this.playbackState||this.muted;"connected"===this.connectionState&&t&&(this.emitter.emit("flush buffers"),this.modules.connection.disconnect("Page inactive timeout"))}),t.DISCONNECT_TIMEOUT)))})),this.emitter.on("context switch complete",(()=>{L||(L=window.setTimeout((()=>{window.clearTimeout(L),L=void 0,this.emit("context switch","completed"),this.emitLanguagesIfChanged()}),this.targetBufferTime))})),this.emitter.on("context switch started",(()=>this.emit("context switch","started"))),this.emitter.on("needs user input",(t=>this.emit("needs user input",t))),this.emitter.on("event",(t=>{switch(t.type){case"metadata":this.emit("metadata",t);break;case"channel switch":this.emit("channel switch",{channelId:t.channelId});break;case"language switch":this.emit("language switch",{language:t.language})}})),this.emitter.on("buffer state event",this.onBufferEvent),this.emitter.on("playback state",(t=>this.emit("playback state",t))),this.emitter.on("rendition level changed",(({to:t})=>{t&&this.emit("rendition level",t)})),this.emitter.on("connection state",(t=>{this.emit("connection state",t)})),this.emitter.on("recovered from media error",(()=>{this.modules.adaptivity.reset(2*this.targetBufferTime)})),this.emitter.once("connect info",(t=>{var e,i,n;const s=(null!=(i=null==(e=t.telemetry)?void 0:e.probability)?i:1)>=Math.random();t.telemetry&&(null==(n=this.modules.telemetry)||n.unload(),this.modules.telemetry=fm.create(this.logger.createContext("TelemetryModule"),this.emitter,A(f({},t.telemetry),{enabled:this.options.get("telemetryEnabled")&&s}),this),this.modules.telemetry.load())})),this.emitter.on("adapt level",(t=>{var e,i,n,s,r;this.logger.debug("adapt level",{direction:t});const a=this.modules.renditions.getRenditionLevels(),o=this.modules.renditions.getRenditionLevel(),l=a.findIndex((t=>t===o)),h=a.length-1;let c=l;switch(t){case"upgrade":{const t=Math.min(l+1,h),o=a[t],d=null!=(e=this.modules.connection.estimatedBandwidth)?e:re(),u=(null!=(n=null==(i=null==o?void 0:o.audio)?void 0:i.bitRate)?n:0)+(null!=(r=null==(s=null==o?void 0:o.video)?void 0:s.bitRate)?r:0);o&&2*d>u&&this.modules.adaptivity.isQoSOk(o)&&(c=t)}break;case"downgrade":c=Math.max(l-1,0);break;case"double downgrade":c=Math.max(l-2,0);break;case"reconnect":if(0===l||this.modules.qualityOfService.timeSpentBufferingLast(6e3)>5e3){if(!this.modules.connection.lastConnectionTime||Date.now()-this.modules.connection.lastConnectionTime<this.modules.qualityOfService.fatalQosGraceTime()||"connected"!==this.modules.connection.getState())return;return this.modules.qualityOfService.incrementFatalQosCount(),this.logger.info("Reconnecting due to poor qos"),this.modules.connection.reconnect("Fatal QOS"),void this.emitter.emit("adapted level")}c=0}if(c===l)return;const d=a[c];this.alignSizeAndBitRate(A(f({},this.targetSubscription),{video:f(f({},this.targetSubscription.video),null==d?void 0:d.video),audio:f(f({},this.targetSubscription.audio),null==d?void 0:d.audio)})),this.emitter.emit("adapted level")})),this.emitter.on("text track data",(t=>{const e=M(this,ym).find((e=>e.language===t.language)),i=this.modules.sync.getTimeshiftOffset()/1e3,n=i-M(this,wm);if(R(this,wm,i),e){if(e.cues)for(const t of e.cues)t.startTime-=n,t.endTime-=n;for(const n of t.cues){const t=new VTTCue(n.startTime-i,n.endTime-i,n.text);e.addCue(t)}}})),this.emitter.on("received signal",(t=>{var e;const i=t,n=this.modules.subscription.getCurrentSubscription();switch(this.logger.debug("received",f({},i)),i.type){case"client ip":this.clientIp=i.ip;break;case"renditions":this.updateTextTracks(i.renditions),R(this,Sm,this.filterRenditions(i.renditions).then((t=>{this.emitter.emit("renditions",{renditions:t,channelId:this.currentSubscription.channelId}),this.emit("rendition levels",this.modules.renditions.getRenditionLevels()),this.emitLanguagesIfChanged()})).finally((()=>{R(this,Sm,void 0)})));break;case"subscription changed":try{(t=>{if("object"!=typeof t||null===t)throw new Error("not an object");if(!("video"in t))throw new Error("missing video in subscription");if(!("audio"in t))throw new Error("missing audio in subscription");if(!("channelId"in t))throw new Error("missing channelId")})(i.subscription)}catch(t){this.emitter.emit("error",new de("Subscription failed validation",{source:t instanceof Error?t:void 0,isFatal:!1,code:"subscription_failed_validation"}))}this.emitter.emit("subscription changed",{reset:i.reset,to:i.subscription,from:this.modules.subscription.getCurrentSubscription()}),i.reset&&n.channelId!==i.subscription.channelId&&(this.emit("error",ye(i.subscription.channelId)),this.emit("channel switch failed",{channelId:n.channelId})),this.modules.sync.timeshiftOnAudio=!(null!=(e=i.subscription.video)&&e.codec),this.modules.adaptivity.reset();break;case"timing info":this.modules.sync.updateChannelSyncInfo(i.timingInfo.channelId,i.timingInfo),this.emit("server wallclock time",i.timingInfo.wallclockTime)}})),this.emitter.on("channel switch timeout",(t=>{this.emit("error",ye(t)),this.emit("channel switch failed",{channelId:this.currentSubscription.channelId})})),this.emitter.on("received data",(t=>{const e=this.modules.subscription.getCurrentSubscription(),i=(t=>{const e=new DataView(t,0),i=e.getUint8(0),n=e.getUint16(1),s=e.getUint8(3),r=e.getUint8(4),a=mt(new Uint8Array(t),5,12),o=e.getUint32(13),l=(t=>!!(16&t))(s)?e.getInt16(17):void 0;return{version:i,renditionId:r,flags:s,timestamp:a,timescale:o,payload:t.slice(n),compositionTimeOffset:l}})(t);e?_(A(f({},i),{channelId:e.channelId})):this.logger.warn("Received unwanted message",f({},i))})),this.emitter.on("received moq data",(t=>{var e,i,n;const s=t.payload.mediaType(),r=t.channelId,a=t.renditionId,o=this.modules.sync.processFragment(r,t.payload);if(t.switchInfo.channelId&&(t.switchInfo.drmTransition&&this.emitter.emit("error",Se("Switching between DRM and non-DRM channels is not supported",!0)),this.encryptedMediaExtensions.onChannelSwitch(),this.emit("rendition levels",this.modules.renditions.getRenditionLevels()),this.modules.event.addEvent({type:"channel switch",channelId:t.switchInfo.channelId,timestamp:o.baseMediaDecodeTime()/o.timescale()*1e3})),t.switchInfo.language&&this.modules.event.addEvent({type:"language switch",language:t.switchInfo.language,timestamp:o.baseMediaDecodeTime()/o.timescale()*1e3}),this.modules.incomingData.add(s,t.payload.rawBytes().byteLength),o.fragment().emsgs.forEach((t=>{if(!t.presentationTime)return;const e=function(t){const e=new At(t),i=function(t){return{id:t.readBytes(3),majorVersion:t.readUint8(),minorVersion:t.readUint8(),flags:t.readUint8(),size:t.readUint32()}}(e);184549376&i.flags&&function(t){const e=t.readUint32();t.readBytes(e-4)}(e);const n=function(t){return{frameId:t.readBytes(4),size:t.readUint32(),flags:t.readUint16()}}(e);if("TXXX"===String.fromCharCode(...n.frameId))return{header:i,txx:fi(new At(e.readBytes(n.size)))}}(t.data);e&&this.modules.event.addEvent({id:t.id,timestamp:t.presentationTime/t.timescale*1e3-this.modules.sync.getTimeshiftOffset(),content:e.txx.value,type:"metadata"})})),this.modules.decoder){const t=null==(e=o.header().init().moov.traks[0])?void 0:e.mdia.minf.stbl.stsd,l=null==(i=null==t?void 0:t.avc1)?void 0:i.avcC.bytes,h=null!=(n=null==t?void 0:t.codec)?n:"h264";if(l){const t=l.buffer.slice(l.byteOffset,l.byteOffset+l.byteLength);if("text"===s)throw new Error("Subtitles are not supported");this.emitter.emit("init segment",{initSegment:{channelId:r,renditionId:a,data:t,timescale:1e3,type:s,codec:h},mimeType:s})}for(let t=0;t<o.samplesCount();t++){const e=o.sample(t);e&&this.emitter.emit("coded sample",A(f({},e),{renditionId:a,channelId:r,data:e.data.buffer.slice(e.data.byteOffset,e.data.byteOffset+e.data.byteLength)}))}}else this.emitter.emit("fragment",{mimeType:t.mimeType,codec:t.codec,fragment:o,channelId:r,renditionId:a})}));const P=this.options.get("container");P&&this.attach(P),this.logger.info("Created Vindral instance",{options:this.options});const _=t=>B(this,null,(function*(){const e=t.channelId;M(this,Sm)&&(yield M(this,Sm));const i=this.modules.renditions.getRendition(t.renditionId,e);if(!(t=>!!(4&t))(t.flags))if((t=>!!(8&t))(t.flags)){const e=(new TextDecoder).decode(t.payload),i=this.modules.sync.getTimeshiftOffset();if(0!==t.renditionId){const t=(0,s.t)(e);if(t&&void 0!==t.language){const e=(new as).parse(t.content||""),n=i/1e3,s=M(this,ym).find((e=>e.language===t.language)),r=n-M(this,wm);if(R(this,wm,n),s){if(s.cues)for(const t of s.cues)t.startTime-=r,t.endTime-=r;for(const t of e){const e=new VTTCue(t.startTime-n,t.endTime-n,t.text);s.addCue(e)}}}}else this.modules.event.addEvent({timestamp:t.timestamp/t.timescale*1e3-this.modules.sync.getTimeshiftOffset(),content:e,type:"metadata"})}else if(null!=i&&i.codec){const n=(0,s.e)(i.codec);if("text"===n)throw new Error("Subtitles are not supported");if(this.modules.incomingData.add(n,t.payload.byteLength),(t=>!!(2&t))(t.flags)){const s=A(f({type:n,data:t.payload,codec:i.codec},t),{channelId:e}),r=((t,e)=>{switch(t){case"h264":return jn(e);case"av1":return(t=>{const e=Xn(t);if(e)return{width:e.maxFrameWidth,height:e.maxFrameHeight}})(e)}})(s.codec,s.payload);r&&this.sizes.set(s.renditionId,r);const a=se({codec:i.codec,codecString:i.codecString});this.emitter.emit("init segment",{initSegment:s,mimeType:a}),this.emit("initialized media")}else{const e=((t,e,i)=>{if(ie(e))return f(A(f({},t),{type:"video",codec:e.codec,isSync:Zn(t.flags),data:t.payload,duration:0,width:e.width,height:e.height}),i);if("webvtt"===e.codec)throw new Error("WebVTT is not supported");return A(f({},t),{type:"audio",channels:e.channels,sampleRate:e.sampleRate,codec:e.codec,language:e.language,isSync:Zn(t.flags),data:t.payload,duration:0})})(t,i,this.sizes.get(t.renditionId));let s=this.sampleProcessingSesssions.get(n);if(s){const t=s(this.modules.sync.processSample(e),this.isSwitchingRenditionLevel&&"video"===e.type);let i=e;t.forEach((t=>{this.modules.event.extractEvent(t,i),this.emitter.emit("coded sample",t),i=t}))}else s=(t=>{let e=[t],i=0,n=0,s=!1;return(t,r=!1)=>{if(t.flags&&Zn(t.flags)&&r&&(s=!s),!(r&&e.length<6&&s)&&e.length>0){s=!1;let r=t;for(let t=e.length-1;t>0;t--){const i=e[t];if(!i||!r)break;i.timestamp>=r.timestamp?e.splice(t,1):r=i}const a=e.map(((s,r)=>((t,e)=>{var s,r,a;t.flags&&Zn(t.flags)&&(i=null!=(s=t.compositionTimeOffset)?s:0),t.timestamp+=i,t.compositionTimeOffset=(null!=(r=t.compositionTimeOffset)?r:0)-i;const o=t.timestamp/t.timescale,l=e.flags&&Zn(e.flags)?null!=(a=e.compositionTimeOffset)?a:0:i,h=(e.timestamp+l)/e.timescale,c=Math.max(0,Math.round((h-o)*t.timescale));return c>0&&(n=c),A(f({},t),{duration:c>0?c:n})})(s,e[r+1]||t)));return e=[t],a}return e.push(t),[]}})(this.modules.sync.processSample(e)),this.sampleProcessingSesssions.set(n,s)}}}));this.options.get("maxVideoBitRate")!==Number.MAX_SAFE_INTEGER&&(this.maxVideoBitRate=this.options.get("maxVideoBitRate")),this.options.get("maxAudioBitRate")!==Number.MAX_SAFE_INTEGER&&(this.maxAudioBitRate=this.options.get("maxAudioBitRate")),kt(this.options.get("maxSize"),ae())||(this.maxSize=this.options.get("maxSize")),this.options.get("burstEnabled")&&d.enableBurst(this.targetBufferTime)}set volume(t){this.playbackSource.volume=t}get volume(){return this.playbackSource.volume}set muted(t){if(t===this.muted)return;const e=this.playbackSource.muted;this.playbackSource.muted=t,!t&&e&&!this.playbackSource.isPaused&&this.playbackSource.play()}get muted(){return this.playbackSource.muted}get media(){return this.options.get("media")}get videoBitRate(){return this.modules.incomingData.averageBitRate("video")}get audioBitRate(){return this.modules.incomingData.averageBitRate("audio")}get connectionState(){return this.modules.connection.getState()}get playbackState(){return this.modules.playback.getState()}get bufferFullness(){return this.modules.playback.getBufferFullness()}get sizeBasedResolutionCapEnabled(){return this.modules.constraintCap.sizeBasedResolutionCapEnabled}set sizeBasedResolutionCapEnabled(t){this.modules.constraintCap.sizeBasedResolutionCapEnabled=t}get abrEnabled(){return this.modules.adaptivity.isEnabled}set abrEnabled(t){this.modules.constraintCap.sizeBasedResolutionCapEnabled=!!t&&this.options.get("sizeBasedResolutionCapEnabled"),this.modules.adaptivity.isEnabled=t,this.alignSizeAndBitRate(this.targetSubscription)}get serverEdgeTime(){return this.modules.sync.getLiveEdgeTimeLatencyAdjusted(this.currentSubscription.channelId)}get serverWallclockTime(){return this.modules.sync.getWallclockTimeLatencyAdjusted(this.currentSubscription.channelId)}get currentTime(){return this.modules.sync.serverCurrentTime}get channelCurrentTime(){return this.modules.sync.channelCurrentTime}get targetBufferTime(){return this.modules.playback.getTargetBufferTime()}set targetBufferTime(t){this.modules.playback.getTargetBufferTime()!==t&&(this.modules.playback.setTargetBufferTime(t),this.playbackSource.currentTime=this.modules.sync.serverCurrentTime,this.options.get("burstEnabled",this.channelId)?this.modules.subscription.enableBurst(this.targetBufferTime):this.modules.subscription.enableBurst(0))}get playbackLatency(){var t;if(0!==this.playbackSource.currentTime)return this.targetBufferTime+(null!=(t=this.modules.sync.drift)?t:0)+this.modules.connection.rtt/2}get playbackWallclockTime(){if(this.serverWallclockTime&&this.playbackLatency)return this.serverWallclockTime-this.playbackLatency}get channels(){return this._channels}get languages(){return this.modules.renditions.getLanguages()}get language(){return this.modules.subscription.getTargetSubscription().audio.language}set language(t){this.modules.subscription.setLanguage(t)}set textTrack(t){M(this,ym).forEach((e=>{e.label===t?e.mode="showing":e.mode="hidden"})),this.emitter.emit("text track",t)}get textTracks(){return M(this,ym).filter((t=>"disabled"!==t.mode)).map((t=>t.label))}get textTrack(){var t;return null==(t=M(this,ym).find((t=>"showing"===t.mode)))?void 0:t.label}get channelId(){var t,e;return null!=(e=null==(t=this.modules)?void 0:t.subscription.getTargetSubscription().channelId)?e:this.options.get("channelId")}set channelId(t){if(t===this.channelId)return;this.modules.subscription.setChannelId(t);const e="audio"===this.options.get("media")?[]:this.options.get("videoCodecs"),i=this.modules.renditions.getAudioRenditions(t),n=this.modules.renditions.getVideoRenditions(t),s=this.targetSubscription.audio.language,r=null==i?void 0:i.some((t=>t.language===s)),a=e.find((t=>void 0!==(null==n?void 0:n.find((e=>e.codec===t)))));a&&this.modules.subscription.setVideoCodec(a),this.logger.debug("Channel switch - started",{audioRenditions:i,targetSubscriptionLanguage:s,targetHasCurrentLanguage:r}),this.alignSizeAndBitRate(this.targetSubscription)}get maxSize(){var t,e;const{width:i,height:n}=null!=(e=null==(t=this.modules.constraintCap.getCurrentConstraintCap())?void 0:t.video)?e:ae();return{width:i,height:n}}set maxSize(t){this.modules.constraintCap.setUserSpecifiedCap({video:{width:t.width,height:t.height}}),this.alignSizeAndBitRate(this.targetSubscription)}get maxVideoBitRate(){var t,e;return null!=(e=null==(t=this.modules.constraintCap.getCurrentConstraintCap())?void 0:t.video.bitRate)?e:re()}set maxVideoBitRate(t){this.modules.constraintCap.setUserSpecifiedCap({video:{bitRate:t}}),this.alignSizeAndBitRate(this.targetSubscription)}get maxAudioBitRate(){var t,e;return null!=(e=null==(t=this.modules.constraintCap.getCurrentConstraintCap())?void 0:t.audio.bitRate)?e:re()}set maxAudioBitRate(t){this.modules.constraintCap.setUserSpecifiedCap({audio:{bitRate:t}}),this.alignSizeAndBitRate(this.targetSubscription)}get renditionLevels(){return this.modules.renditions.getRenditionLevels()}get currentRenditionLevel(){return this.modules.renditions.getRenditionLevel()}get targetRenditionLevel(){return this.modules.renditions.getRenditionLevel(this.modules.subscription.getTargetSubscription())}get isSwitchingRenditionLevel(){return this.modules.subscription.isSwitchingSubscription()}get videoBufferedRanges(){var t,e,i,n;return null!=(n=null!=(i=null==(t=this.modules.mseModule)?void 0:t.getBuffer("video"))?i:null==(e=this.modules.decoder)?void 0:e.getBuffer("video"))?n:[]}get audioBufferedRanges(){var t,e,i,n;return null!=(n=null!=(i=null==(t=this.modules.mseModule)?void 0:t.getBuffer("audio"))?i:null==(e=this.modules.decoder)?void 0:e.getBuffer("audio"))?n:[]}getApiClient(){return this.modules.connection.apiClient}get lastBufferEvent(){return this.modules.playback.getLastBufferStateEvent()}get activeRatios(){return this.modules.qualityOfService.activeRatios()}get bufferingRatios(){return this.modules.qualityOfService.bufferingRatios()}get timeSpentBuffering(){return this.modules.qualityOfService.timeSpentBuffering()}get timeActive(){return this.modules.qualityOfService.timeActive()}get mediaElement(){return this.element}get audioNode(){var t;return null!=(t=this.modules)&&t.canvasModule?this.modules.canvasModule.audioNode:void 0}get drmStatistics(){var t;return null==(t=this.encryptedMediaExtensions)?void 0:t.getStatistics()}get uptime(){return Date.now()-this.createdAt}suspend(){this.isSuspended||(Object.values(this.modules).forEach((t=>{t&&"suspend"in t&&t.suspend()})),this.isSuspended=!0)}unsuspend(){this.isSuspended&&(Object.values(this.modules).forEach((t=>{t&&"unsuspend"in t&&t.unsuspend()})),this.isSuspended=!1)}alignSizeAndBitRate(t){const e=this.modules.constraintCap.constrainSubscription(A(f({},t),{video:f({},t.video),audio:f({},t.audio)})),i=this.modules.constraintCap.getUserSpecifiedCap();!this.abrEnabled&&i&&(e.audio.bitRate=i.audio.bitRate,e.video.bitRate=i.video.bitRate,e.video.width=i.video.width,e.video.height=i.video.height);const n=this.modules.renditions.getRenditionLevel(e);if(n)if(n.video&&(this.modules.subscription.setVideoBitRate(n.video.bitRate),this.modules.subscription.setSize(n.video)),n.audio)this.modules.subscription.setAudioBitRate(n.audio.bitRate),this.modules.subscription.setLanguage(n.audio.language);else if(e.audio.language){let t=this.modules.renditions.getAudioRenditions(e.channelId);!this.abrEnabled&&i&&(t=null==t?void 0:t.filter((t=>t.bitRate<i.audio.bitRate)));const n=e.audio.language,s=null==t?void 0:t.some((t=>t.language===n)),r=null==t?void 0:t.find((t=>t.language)),a=(null==t?void 0:t.length)&&t[0]||void 0;s||(r?(this.logger.debug("Randomizing language since target did not have current language"),this.modules.subscription.setAudioBitRate(r.bitRate),this.modules.subscription.setLanguage(r.language)):(this.logger.debug("Randomizing audio rendition since target did not have current language"),null!=a&&a.bitRate&&this.modules.subscription.setAudioBitRate(a.bitRate),this.modules.subscription.setLanguage(null==a?void 0:a.language)))}}get currentSubscription(){return this.modules.subscription.getCurrentSubscription()}get targetSubscription(){return this.modules.subscription.getTargetSubscription()}willUseMediaSource(){return this.browser.supportsMediaSource&&this.options.get("mseEnabled")}};wm=new WeakMap,ym=new WeakMap,Sm=new WeakMap,I(km,"MAX_POOL_SIZE",10),I(km,"INITIAL_MAX_BIT_RATE",25e5),I(km,"DISCONNECT_TIMEOUT",15e3),I(km,"REMOVE_CUE_THRESHOLD",1e4);let Em=km},9633:(t,e,i)=>{i.d(e,{E:()=>s});var n=Object.defineProperty;class s{constructor(){((t,e,i)=>{((t,e,i)=>{e in t?n(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i})(t,"symbol"!=typeof e?e+"":e,i)})(this,"listeners",{})}emit(t,e){const i=this.listeners[t];i&&(this.listeners[t]=i.filter((t=>!t.once)),i.map((t=>t.fn(e))).map((t=>"function"==typeof t&&(null==t?void 0:t()))))}off(t,e){const i=this.listeners[t];i&&(this.listeners[t]=i.filter((t=>t.fn!==e)))}on(t,e){this.add(t,e,!1)}once(t,e){this.add(t,e,!0)}reset(){this.listeners={}}add(t,e,i){const n=this.listeners[t],s={fn:e,once:i};n?n.push(s):this.listeners[t]=[s]}}},3989:(t,e,i)=>{i.d(e,{A:()=>T,a:()=>g,b:()=>v,c:()=>b,d:()=>y,e:()=>p,i:()=>A,p:()=>E,t:()=>f});var n=Object.defineProperty,s=Object.defineProperties,r=Object.getOwnPropertyDescriptors,a=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,h=(t,e,i)=>e in t?n(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,c=(t,e)=>{for(var i in e||(e={}))o.call(e,i)&&h(t,i,e[i]);if(a)for(var i of a(e))l.call(e,i)&&h(t,i,e[i]);return t},d=(t,e)=>s(t,r(e)),u=(t,e,i)=>h(t,"symbol"!=typeof e?e+"":e,i),m=(t,e,i)=>new Promise(((n,s)=>{var r=t=>{try{o(i.next(t))}catch(t){s(t)}},a=t=>{try{o(i.throw(t))}catch(t){s(t)}},o=t=>t.done?n(t.value):Promise.resolve(t.value).then(r,a);o((i=i.apply(t,e)).next())}));const p=t=>{switch(t){case"h264":case"av1":return"video";case"aac":case"opus":case"mp3":return"audio";case"webvtt":return"text";default:throw new Error("Unknown codec")}};function g(t,e){if(!t)throw new Error(e)}const f=t=>{try{return JSON.parse(t)}catch(t){return}};function A(t){return!("string"==typeof t.edges[0]||t.channels[0]&&!("catalog"in t.channels[0]))}function v(t){return t.tracks.filter((t=>!!t.codec)).filter((t=>b(t.codec||""))).map(((t,e)=>{const i=t.codec,n=t.bitrate;g(i,"codec is required"),g(null!=n,"bitrate is required");const s=b(i);if(g(s,"codec is required"),"audio"===p(s)){const r=t.samplerate||0;return{track:t,id:e,codec:s,codecString:i,bitRate:n,channels:"stereo"===t.channelConfig?2:1,sampleRate:r,language:t.language}}return"text"===p(s)?{track:t,id:e,bitRate:0,codec:s,kind:"subtitles",codecString:i,label:t.label,language:t.language}:(g(t.width,"width is required"),g(t.height,"width is required"),g(t.framerate,"framerate is required"),{track:t,id:e,codec:s,bitRate:n,codecString:i,width:t.width,height:t.height,frameRate:t.framerate})})).sort(((t,e)=>t.bitRate-e.bitRate))}function b(t){return t.startsWith("opus")?"opus":t.startsWith("mp4a")?"aac":t.startsWith("avc1")?"h264":t.startsWith("av01")?"av1":t.startsWith("webvtt")?"webvtt":void 0}class w extends Error{constructor({status:t,url:e,body:i}){const n=f(i),s=(t=>"object"==typeof t&&null!==t&&"message"in t)(n)?n.message:`Url ${e.toString()}, Status code: ${t}, Body: ${i}`;super(s),u(this,"status"),u(this,"body"),u(this,"url"),this.status=t,this.body=i,this.url=e,Object.setPrototypeOf(this,new.target.prototype)}}const y=t=>"number"==typeof t.status,S=(t,e)=>m(void 0,null,(function*(){const i=yield fetch(t.toString(),c({mode:"cors"},e));if(!i.ok)throw new w({status:i.status,url:t,body:yield i.text()});return i})),k=(t,e)=>m(void 0,null,(function*(){return yield(yield S(t,c({},e))).json()})),E=(t,e)=>m(void 0,null,(function*(){return S(t,c({method:"POST"},e))}));class T{constructor(t){u(this,"baseUrl"),u(this,"tokenFactory"),this.baseUrl=new URL("/api/v4/",t.publicEndpoint).toString(),this.tokenFactory=t.tokenFactory}connect(t){return m(this,null,(function*(){const{channelId:e,channelGroupId:i}=t,n={channelId:e,channelGroupId:i},s=new URL((t=>t.channelGroupId?`connect?channelId=${t.channelId}&channelGroupId=${t.channelGroupId}`:`connect?channelId=${t.channelId}`)(t),this.baseUrl),r=this.getAuthToken(n),a=yield k(s,{headers:this.getHeaders(r)});if(function(t){var e;return!("string"==typeof t.edges[0]||t.channels[0]&&"catalog"in t.channels[0]&&void 0===(null==(e=t.channels[0])?void 0:e.catalog))}(a)){const t=a.channels.map((t=>{const e=this.toChannel(t,n),i=v(t.catalog);return d(c(c({},t),e),{renditions:i})}));return d(c({},a),{channels:t})}{const t=a.channels.map((t=>{const e=this.toChannel(t,n);return c(c({},t),e)}));return d(c({},a),{channels:t})}}))}getChannel(t){return m(this,null,(function*(){const e={channelId:t},i=new URL(`channel/${t}`,this.baseUrl),n=this.getAuthToken(e),s=yield k(i,{headers:this.getHeaders(n)});return this.toChannel(s,e,n)}))}getChannels(t){return m(this,null,(function*(){const e={channelGroupId:t},i=new URL(`channels/${t}`,this.baseUrl),n=this.getAuthToken(e),s=yield k(i,{headers:this.getHeaders(n)}),r=Array.isArray(s)?s:s.channels;return this.toChannels(r,e,n)}))}getHeaders(t){var e;return null!=(e=(t=>t?{Authorization:`Bearer ${t}`}:void 0)(t))?e:{}}getAuthToken(t){return this.tokenFactory?this.tokenFactory(t):void 0}toChannels(t,e,i){return t.map((t=>this.toChannel(t,e,i)))}toChannel(t,e,i){const{baseUrl:n,sizes:s}=t.thumbnail,r=n||new URL(((t,e)=>e?t.channelGroupId?`thumbnail/?channelGroupId=${t.channelGroupId}&auth.token=${e}&auth.type=jwt`:t.channelId?`thumbnail/?channelId=${t.channelId}&auth.token=${e}&auth.type=jwt`:"thumbnail":"thumbnail")(e,i),this.baseUrl),a=s.map((n=>new URL(`?channelId=${t.channelId}&width=${n.width}&height=${n.height}${I(e,i)}`,r).toString()));return{channelId:t.channelId,name:t.name,isLive:t.isLive,thumbnailUrls:a}}}const I=(t,e)=>e?t.channelGroupId?`&channelGroupId=${t.channelGroupId}&auth.token=${e}&auth.type=jwt`:`&auth.token=${e}&auth.type=jwt`:""}},n={};function s(t){var e=n[t];if(void 0!==e)return e.exports;var r=n[t]={exports:{}};return i[t](r,r.exports,s),r.exports}s.m=i,s.d=(t,e)=>{for(var i in e)s.o(e,i)&&!s.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},s.f={},s.e=t=>Promise.all(Object.keys(s.f).reduce(((e,i)=>(s.f[i](t,e),e)),[])),s.u=t=>t+"."+{597:"da4f3a832e118a71f92b",790:"d8a3e207eab581e130d5"}[t]+".bundle.js",s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),s.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),t={},e="vindral-examples:",s.l=(i,n,r,a)=>{if(t[i])t[i].push(n);else{var o,l;if(void 0!==r)for(var h=document.getElementsByTagName("script"),c=0;c<h.length;c++){var d=h[c];if(d.getAttribute("src")==i||d.getAttribute("data-webpack")==e+r){o=d;break}}o||(l=!0,(o=document.createElement("script")).charset="utf-8",o.timeout=120,s.nc&&o.setAttribute("nonce",s.nc),o.setAttribute("data-webpack",e+r),o.src=i),t[i]=[n];var u=(e,n)=>{o.onerror=o.onload=null,clearTimeout(m);var s=t[i];if(delete t[i],o.parentNode&&o.parentNode.removeChild(o),s&&s.forEach((t=>t(n))),e)return e(n)},m=setTimeout(u.bind(null,void 0,{type:"timeout",target:o}),12e4);o.onerror=u.bind(null,o.onerror),o.onload=u.bind(null,o.onload),l&&document.head.appendChild(o)}},s.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},(()=>{var t;s.g.importScripts&&(t=s.g.location+"");var e=s.g.document;if(!t&&e&&(e.currentScript&&(t=e.currentScript.src),!t)){var i=e.getElementsByTagName("script");if(i.length)for(var n=i.length-1;n>-1&&(!t||!/^http(s?):/.test(t));)t=i[n--].src}if(!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),s.p=t})(),(()=>{var t={508:0};s.f.j=(e,i)=>{var n=s.o(t,e)?t[e]:void 0;if(0!==n)if(n)i.push(n[2]);else{var r=new Promise(((i,s)=>n=t[e]=[i,s]));i.push(n[2]=r);var a=s.p+s.u(e),o=new Error;s.l(a,(i=>{if(s.o(t,e)&&(0!==(n=t[e])&&(t[e]=void 0),n)){var r=i&&("load"===i.type?"missing":i.type),a=i&&i.target&&i.target.src;o.message="Loading chunk "+e+" failed.\n("+r+": "+a+")",o.name="ChunkLoadError",o.type=r,o.request=a,n[1](o)}}),"chunk-"+e,e)}};var e=(e,i)=>{var n,r,[a,o,l]=i,h=0;if(a.some((e=>0!==t[e]))){for(n in o)s.o(o,n)&&(s.m[n]=o[n]);l&&l(s)}for(e&&e(i);h<a.length;h++)r=a[h],s.o(t,r)&&t[r]&&t[r][0](),t[r]=0},i=self.webpackChunkvindral_examples=self.webpackChunkvindral_examples||[];i.forEach(e.bind(null,0)),i.push=e.bind(null,i.push.bind(i))})();var r=s(2725),a=s(9633),o=Object.defineProperty,l=(t,e,i)=>((t,e,i)=>e in t?o(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i)(t,"symbol"!=typeof e?e+"":e,i),h=(t,e,i)=>new Promise(((n,s)=>{var r=t=>{try{o(i.next(t))}catch(t){s(t)}},a=t=>{try{o(i.throw(t))}catch(t){s(t)}},o=t=>t.done?n(t.value):Promise.resolve(t.value).then(r,a);o((i=i.apply(t,e)).next())}));class c extends a.E{constructor(t){super(),l(this,"state","not casting"),l(this,"config"),l(this,"unloaded",!1),l(this,"updateAuthenticationToken",(t=>{this.config&&(this.config.options.authenticationToken=t,this.send({type:"updateAuthToken",token:t}))})),l(this,"unload",(()=>{var t;this.unloaded=!0,null==(t=this.getSession())||t.removeMessageListener("urn:x-cast:com.vindral.castdata",this.onMessage)})),l(this,"init",(()=>h(this,null,(function*(){return new Promise(((t,e)=>{let i=!1;const n=setTimeout((()=>{i=!0,e()}),1e4);window.__onGCastApiAvailable=s=>{if(!i)return clearTimeout(n),s?void setTimeout((()=>{try{this.onGCastApiAvailable(),t()}catch(t){e()}}),1e3):e();i=!1},this.castLibrariesAdded()&&window.cast?window.__onGCastApiAvailable(!0):this.verifyCastLibraries()}))})))),l(this,"start",(()=>h(this,null,(function*(){var t;yield null==(t=this.getInstance())?void 0:t.requestSession()})))),l(this,"stop",(()=>{var t;null==(t=this.getSession())||t.endSession(!0)})),l(this,"getReceiverName",(()=>{var t,e;return(null==(e=null==(t=this.getSession())?void 0:t.getCastDevice())?void 0:e.friendlyName)||void 0})),l(this,"onGCastApiAvailable",(()=>{var t;const e=this.getInstance();if(!e)throw"cast context should exist";const i=e.getSessionState(),n=(null==(t=this.config)?void 0:t.receiverApplicationId)||"A5452297";e.setOptions({receiverApplicationId:n,autoJoinPolicy:chrome.cast.AutoJoinPolicy.TAB_AND_ORIGIN_SCOPED,resumeSavedSession:!0}),e.addEventListener(cast.framework.CastContextEventType.SESSION_STATE_CHANGED,this.onSessionStateChanged),i===cast.framework.SessionState.SESSION_STARTED&&setTimeout((()=>{this.state="casting",this.emit("resumed")}))})),l(this,"send",(t=>{var e;null==(e=this.getSession())||e.sendMessage("urn:x-cast:com.vindral.castdata",t)})),l(this,"onMessage",((t,e)=>{if("urn:x-cast:com.vindral.castdata"===t)try{const t=JSON.parse(e);switch(t.type){case"metadata":this.emit("metadata",t.metadata);break;case"serverWallclockTime":this.emit("server wallclock time",t.serverWallclockTime)}}catch(t){}})),l(this,"onSessionStarted",(()=>{var t;null==(t=this.getSession())||t.addMessageListener("urn:x-cast:com.vindral.castdata",this.onMessage),this.send({type:"start",config:this.config})})),l(this,"onSessionStateChanged",(t=>{if(!this.unloaded)switch(t.sessionState){case cast.framework.SessionState.SESSION_START_FAILED:this.state="not casting",this.emit("failed");break;case cast.framework.SessionState.SESSION_ENDED:this.state="not casting",this.emit("disconnected");break;case cast.framework.SessionState.SESSION_ENDING:break;case cast.framework.SessionState.SESSION_RESUMED:this.onSessionStarted(),this.state="casting",this.emit("resumed");break;case cast.framework.SessionState.SESSION_STARTED:this.onSessionStarted(),this.state="casting",this.emit("connected");case cast.framework.SessionState.SESSION_STARTING:}})),l(this,"getInstance",(()=>{var t;return null==(t=window.cast)?void 0:t.framework.CastContext.getInstance()})),l(this,"getSession",(()=>{var t;return null==(t=this.getInstance())?void 0:t.getCurrentSession()})),l(this,"castLibrariesAdded",(()=>!(!document.querySelector("#vindralCastFrameworkLib")||!document.querySelector("#vindralCastSenderLib")))),l(this,"verifyCastLibraries",(()=>{if(this.castLibrariesAdded())return;const t=document.createElement("script");t.type="text/javascript",t.id="vindralCastFrameworkLib",t.src="//www.gstatic.com/cast/sdk/libs/sender/1.0/cast_framework.js",document.head.appendChild(t);const e=document.createElement("script");e.type="text/javascript",e.id="vindralCastSenderLib",e.src="//www.gstatic.com/cv/js/sender/v1/cast_sender.js",document.head.appendChild(e)})),this.config=t}get casting(){return"casting"===this.state}get volume(){var t,e;return null!=(e=null==(t=this.getSession())?void 0:t.getVolume())?e:0}set volume(t){var e;null==(e=this.getSession())||e.setVolume(t)}get language(){var t,e;return null==(e=null==(t=this.config)?void 0:t.options)?void 0:e.language}set language(t){this.config&&(this.config.options.language=t,this.send({type:"setLanguage",language:t}))}get channelId(){var t;return(null==(t=this.config)?void 0:t.options.channelId)||""}set channelId(t){this.config&&(this.config.options.channelId=t,this.send({type:"setChannelId",channelId:t}))}}var d=s(3989),u=Object.defineProperty,m=Object.getPrototypeOf,p=Reflect.get,g=t=>{throw TypeError(t)},f=(t,e,i)=>((t,e,i)=>e in t?u(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i)(t,"symbol"!=typeof e?e+"":e,i),A=(t,e,i)=>e.has(t)||g("Cannot "+i),v=(t,e,i)=>(A(t,e,"read from private field"),i?i.call(t):e.get(t)),b=(t,e,i)=>e.has(t)?g("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),w=(t,e,i,n)=>(A(t,e,"write to private field"),n?n.call(t,i):e.set(t,i),i),y=(t,e,i)=>(A(t,e,"access private method"),i),S=(t,e,i)=>p(m(t),i,e),k=(t,e,i)=>new Promise(((n,s)=>{var r=t=>{try{o(i.next(t))}catch(t){s(t)}},a=t=>{try{o(i.throw(t))}catch(t){s(t)}},o=t=>t.done?n(t.value):Promise.resolve(t.value).then(r,a);o((i=i.apply(t,e)).next())}));const E=1e6,T=1e3*E,I=(t,e,i)=>t%e==0?t/e:(t/e).toFixed(i),C={PAUSED:"paused",MUTED:"muted",USER_INTERACTING:"user-interacting",IS_CASTING:"is-casting",CAST_AVAILABLE:"cast-available",CAST_RECEIVER_NAME:"cast-receiver-name",BUFFERING:"buffering",UI_LOCKED:"ui-locked",HIDE_UI_ON_PAUSE:"hide-ui-on-pause",FULLSCREEN:"is-fullscreen",FULLSCREEN_FALLBACK:"is-fullscreen-fallback",RENDITION_LEVELS:"rendition-levels",RENDITION_LEVEL:"rendition-level",MAX_VIDEO_BITRATE:"max-video-bit-rate",CHANNELS:"channels",CHANNEL_ID:"channel-id",CHANNEL_GROUP_ID:"channel-group-id",PIP_AVAILABLE:"pip-available",IS_PIP:"is-pip",AIRPLAY_AVAILABLE:"airplay-available",IS_AIRPLAYING:"is-airplaying",MEDIA:"media",LANGUAGES:"languages",LANGUAGE:"language",TEXT_TRACKS:"text-tracks",TEXT_TRACK:"text-track",NEEDS_USER_INPUT_VIDEO:"needs-user-input-video",NEEDS_USER_INPUT_AUDIO:"needs-user-input-audio",AUTHENTICATION_TOKEN:"authentication-token",VOLUME:"volume",VOLUME_LEVEL:"volume-level",CAST_ENABLED:"cast",AIRPLAY_ENABLED:"airplay",PIP_ENABLED:"pip",FULLSCREEN_ENABLED:"fullscreen",VU_METER_ENABLED:"vu-meter",POSTER_SRC:"poster-src"},x=Object.values(C),M={PLAY:"play",PAUSE:"pause",MUTE:"mute",UNMUTE:"unmute",LOCK_UI:"lock-ui",UNLOCK_UI:"unlock-ui",ENTER_FULLSCREEN:"enter-fullscreen",EXIT_FULLSCREEN:"exit-fullscreen",SET_RENDITION:"set-rendition",CHANNEL_GRID_OPENED:"channel-grid-opened",CHANNEL_GRID_CLOSED:"channel-grid-closed",ENTER_PIP:"enter-pip",EXIT_PIP:"exit-pip",REQUEST_AIRPLAY:"request-airplay",SET_LANGUAGE:"set-language",SET_TEXT_TRACK:"set-text-track",REQUEST_USER_INPUT:"request-user-input",SET_VOLUME:"set-volume"};function U(t){return"audio"===t||"video"===t||"audio+video"===t?t:"audio+video"}function R(t){return"trace"===t||"debug"===t||"info"===t||"warn"===t||"error"===t||"off"===t?t:"off"}function L(t){if(null!==t)return""===t||t}function P(t){if(null===t)return;const e=parseInt(t,10);return isNaN(e)?void 0:e}function B(t){return"string"==typeof t}function _(t,e){if(null===t)return null!=e?e:void 0;const i=t.toLowerCase();return"false"!==i&&("true"===i||""===i||null==e||e)}function D(t){if(null===t)return;const e={},i=t.split(",");for(const t of i){const[i,n]=t.split(":");i&&n&&(e[i.trim()]=n.trim())}return Object.keys(e).length>0?e:void 0}const N=document.createElement("template");var W,O,F,V;N.innerHTML="\n  <style>\n    :host {\n      cursor: pointer;\n      color: var(--fg-strong);\n      padding: var(--button-padding);\n      background: transparent;\n      transition: background 0.2s linear;\n      -webkit-tap-highlight-color: transparent;\n    }\n\n    :host(:focus-visible) {\n      box-shadow: inset 0 0 0 2px var(--fg-strong);\n      outline: 0;\n    }\n\n    :host(:where(:focus)) {\n      box-shadow: none;\n      outline: 0;\n    }\n\n    @media (hover: hover) and (pointer: fine) {\n      :host(:hover) {\n        background: rgba(255, 255, 255, 0.15);\n      }\n    }\n\n    :host(:active) {\n      background: rgba(255, 255, 255, 0.25);\n    }\n\n    :host(:active) svg {\n      scale: 0.9;\n    }\n\n    :host([disabled]) {\n      opacity: 0.5;\n      background: transparent;\n    }\n\n    slot > svg {\n      display: block;\n      width: var(--button-icon-size);\n      height: var(--button-icon-size);\n    }\n  </style>\n";class G extends HTMLElement{constructor(){super(),b(this,W,null),b(this,O,(t=>{this.handleClick(t)})),b(this,F,(t=>{const{key:e}=t;this.keysUsed.includes(e)?this.handleClick(t):this.removeEventListener("keyup",v(this,F))})),b(this,V,(t=>{const{metaKey:e,altKey:i,key:n}=t;e||i||!this.keysUsed.includes(n)?this.removeEventListener("keyup",v(this,F)):this.addEventListener("keyup",v(this,F),{once:!0})})),this.attachShadow({mode:"open"}).appendChild(N.content.cloneNode(!0))}get keysUsed(){return["Enter"," "]}connectedCallback(){var t;w(this,W,this.closest("vindral-controller")),null==(t=v(this,W))||t.connectListener(this),this.hasAttribute("disabled")||this.enable(),this.setAttribute("role","button")}enable(){this.addEventListener("click",v(this,O)),this.addEventListener("keydown",v(this,V)),this.tabIndex=0}disable(){this.removeEventListener("click",v(this,O)),this.removeEventListener("keydown",v(this,V)),this.removeEventListener("keyup",v(this,F)),this.tabIndex=-1}disconnectedCallback(){var t;null==(t=v(this,W))||t.disconnectListener(this)}attributeChangedCallback(t,e,i){"disabled"===t&&(B(i)?this.disable():this.enable())}}W=new WeakMap,O=new WeakMap,F=new WeakMap,V=new WeakMap,f(G,"observedAttributes",["disabled"]);const z=document.createElement("template"),H='\n    <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round" ><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18 18a3 3 0 0 0 3 -3v-8a3 3 0 0 0 -3 -3h-12a3 3 0 0 0 -3 3v8a3 3 0 0 0 3 3" /><path d="M9 20h6l-3 -5z" /></svg>\n';var j,X;z.innerHTML=`\n  <style>\n    :host {\n      display: var(--airplay-button-display);\n    }\n\n    :host(:not([${C.AIRPLAY_AVAILABLE}])) {\n      display: none !important;\n    }\n\n    :host([${C.IS_AIRPLAYING}]) slot[name="exit"] {\n      display: none !important;\n    }\n\n    :host(:not([${C.IS_AIRPLAYING}])) slot[name="enter"] {\n      display: none !important;\n    }\n  </style>\n\n  <slot name="icon">\n    <slot name="enter">${H}</slot>\n    <slot name="exit">${H}</slot>\n  </slot>\n`;const q=class extends G{constructor(){var t;super(),b(this,j),null==(t=this.shadowRoot)||t.appendChild(z.content.cloneNode(!0))}connectedCallback(){super.connectedCallback(),y(this,j,X).call(this)}disconnectedCallback(){super.disconnectedCallback()}attributeChangedCallback(t,e,i){super.attributeChangedCallback(t,e,i),t===C.IS_AIRPLAYING&&y(this,j,X).call(this)}set isAirPlaying(t){t?this.setAttribute(C.IS_AIRPLAYING,""):this.removeAttribute(C.IS_AIRPLAYING)}get isAirPlaying(){return this.hasAttribute(C.IS_AIRPLAYING)}handleClick(t){this.dispatchEvent(new CustomEvent(M.REQUEST_AIRPLAY,{bubbles:!0,composed:!0}))}};j=new WeakSet,X=function(){this.setAttribute("aria-label",this.isAirPlaying?"Exit airplay":"Enter airplay")},f(q,"observedAttributes",[...S(q,q,"observedAttributes"),C.AIRPLAY_AVAILABLE,C.IS_AIRPLAYING]);let Q=q;const $=document.createElement("template");var Z;$.innerHTML=`\n  <style>\n    :host {\n      color: var(--fg-strong);\n    }\n\n    slot > svg {\n      display: block;\n    }\n\n    :host(:not([${C.BUFFERING}])) {\n      visibility: hidden !important;\n    }\n  </style>\n\n  <slot name="icon">\n<svg width="24" height="24" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">\n  <style>\n    .spinner-container {\n      transform-origin: center;\n      animation: rotate 2s linear infinite;\n    }\n    .spinner-circle {\n      stroke-linecap: round;\n      animation: dash 1.5s ease-in-out infinite;\n    }\n    @keyframes rotate {\n      100% {\n        transform: rotate(360deg);\n      }\n    }\n    @keyframes dash {\n      0% {\n        stroke-dasharray: 0 150;\n        stroke-dashoffset: 0;\n      }\n      47.5% {\n        stroke-dasharray: 42 150;\n        stroke-dashoffset: -16;\n      }\n      95%, 100% {\n        stroke-dasharray: 42 150;\n        stroke-dashoffset: -59;\n      }\n    }\n  </style>\n  <g class="spinner-container">\n    <circle class="spinner-circle" cx="12" cy="12" r="9.5" fill="none" stroke-width="3"></circle>\n  </g>\n</svg>\n</slot>\n`;class K extends HTMLElement{constructor(){super(),b(this,Z,null),this.attachShadow({mode:"open"}).appendChild($.content.cloneNode(!0))}connectedCallback(){var t;w(this,Z,this.closest("vindral-controller")),null==(t=v(this,Z))||t.connectListener(this)}disconnectedCallback(){var t;null==(t=v(this,Z))||t.disconnectListener(this)}}Z=new WeakMap,f(K,"observedAttributes",[C.BUFFERING]);const J=document.createElement("template");var Y;J.innerHTML=`\n  <style>\n    :host {\n      display: var(--buffering-overlay-display);\n      align-items: center;\n      justify-content: center;\n      position: absolute;\n      top: 0;\n      bottom: 0;\n      left: 0;\n      right: 0;\n      background-color: rgba(0, 0, 0, 0.3);\n      transition: opacity 250ms;\n      transition-delay: 1s;\n      opacity: 1;\n      pointer-events: none;\n      z-index: 1;\n    }\n\n    #buffering-indicator {\n      width: 40px;\n      height: 40px;\n      border-radius: 40px;\n      background-color: var(--fg-strong);\n      animation: scaleout 1s infinite ease-in-out;\n    }\n\n    @-webkit-keyframes scaleout {\n      0% {\n        -webkit-transform: scale(0);\n      }\n      100% {\n        -webkit-transform: scale(1);\n        opacity: 0;\n      }\n    }\n\n    @keyframes scaleout {\n      0% {\n        -webkit-transform: scale(0);\n        transform: scale(0);\n      }\n      100% {\n        -webkit-transform: scale(1);\n        transform: scale(1);\n        opacity: 0;\n      }\n    }\n\n    :host(:not([${C.BUFFERING}])) {\n      transition-delay: 0s;\n      opacity: 0 !important;\n    }\n  </style>\n\n  <div id="buffering-indicator"></div>\n`;class tt extends HTMLElement{constructor(){super(),b(this,Y,null),this.attachShadow({mode:"open"}).appendChild(J.content.cloneNode(!0))}connectedCallback(){var t;w(this,Y,this.closest("vindral-controller")),null==(t=v(this,Y))||t.connectListener(this)}disconnectedCallback(){var t;null==(t=v(this,Y))||t.disconnectListener(this)}}Y=new WeakMap,f(tt,"observedAttributes",[C.BUFFERING]);const et=document.createElement("template");var it,nt,st;et.innerHTML=`\n  <style>\n    :host {\n      display: var(--cast-button-display);\n    }\n\n    google-cast-launcher {\n      display: block;\n      width: var(--button-icon-size);\n      height: var(--button-icon-size);\n      cursor: pointer;\n      --connected-color: var(--fg-strong);\n      --disconnected-color: var(--fg-strong);\n    }\n\n    :host(:active) google-cast-launcher {\n      transform: scale(0.9);\n    }\n\n    :host(:not([${C.CAST_AVAILABLE}])) {\n      display: none !important;\n    }\n  </style>\n`;const rt=class extends G{constructor(){var t;super(),b(this,it),null==(t=this.shadowRoot)||t.appendChild(et.content.cloneNode(!0))}connectedCallback(){super.connectedCallback(),y(this,it,nt).call(this)}disconnectedCallback(){super.disconnectedCallback()}attributeChangedCallback(t,e,i){super.attributeChangedCallback(t,e,i),t===C.CAST_AVAILABLE&&y(this,it,st).call(this),t===C.IS_CASTING&&y(this,it,nt).call(this)}set isCasting(t){t?this.setAttribute(C.IS_CASTING,""):this.removeAttribute(C.IS_CASTING)}get isCasting(){return this.hasAttribute(C.IS_CASTING)}handleClick(t){}};it=new WeakSet,nt=function(){this.setAttribute("aria-label",this.isCasting?"Exit cast":"Enter cast")},st=function(){var t,e;if(null==(t=this.shadowRoot)||!t.querySelector("google-cast-launcher")){const t=document.createElement("google-cast-launcher");null==(e=this.shadowRoot)||e.appendChild(t)}},f(rt,"observedAttributes",[...S(rt,rt,"observedAttributes"),C.CAST_AVAILABLE,C.IS_CASTING]);let at=rt;const ot=document.createElement("template");var lt,ht;ot.innerHTML=`\n  <style>\n    :host {\n      position: absolute;\n      top: 0;\n      left: 0;\n      width: 100%;\n      font-size: 20px;\n      text-align: center;\n      padding: 5% 0;\n      box-shadow: 0px 0px 20px black;\n      background: rgba(0, 0, 0, 0.5);\n      color: white;\n      pointer-events: none;\n      z-index: 1;\n      transition: opacity 0.3s ease-in-out;\n    }\n\n    @media only screen and (max-width: 600px) {\n      :host {\n        font-size: 14px;\n      }\n    }\n\n    :host(:not([${C.IS_CASTING}])) {\n      display: none;\n    }\n\n    #text {\n      margin: 0;\n      padding: 0;\n    }\n  </style>\n  <span id="text"></span>\n`;class ct extends HTMLElement{constructor(){super(),b(this,lt,null),b(this,ht,null),this.attachShadow({mode:"open"}).appendChild(ot.content.cloneNode(!0))}connectedCallback(){var t,e;w(this,lt,this.closest("vindral-controller")),null==(t=v(this,lt))||t.connectListener(this),w(this,ht,null==(e=this.shadowRoot)?void 0:e.querySelector("#text"))}disconnectedCallback(){var t;null==(t=v(this,lt))||t.disconnectListener(this)}attributeChangedCallback(t,e,i){e===i||!v(this,ht)||"cast-receiver-name"===t&&"string"==typeof i&&(v(this,ht).innerText=`Casting to ${i||"device"}`)}}function dt(t=document){const e=null==t?void 0:t.activeElement;if(!e)return null;if(e.shadowRoot){const t=dt(e.shadowRoot);return null!=t?t:e}return e}lt=new WeakMap,ht=new WeakMap,f(ct,"observedAttributes",[C.IS_CASTING,C.CAST_RECEIVER_NAME]);const ut=document.createElement("template");var mt;ut.innerHTML='\n  <style>\n    :host {\n      position: relative;\n      aspect-ratio: 16 / 9;\n      object-fit: cover;\n      cursor: pointer;\n      border-radius: 6px;\n      box-sizing: border-box;\n      margin: 2px;\n\n      background-size: cover;\n      background-position: center;\n\n      transition-property: background-image;\n      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);\n      transition-duration: 200ms;\n\n      background-color: rgba(0, 0, 0, 0.5);\n      background-blend-mode: multiply;\n    }\n\n    :host([aria-selected="true"]) {\n      outline: 2px solid var(--fg-strong);\n      background-color: rgba(0, 0, 0, 0);\n    }\n\n    :host([offline]) {\n      display: var(--grid-item-offline-display);\n      background-image: repeating-linear-gradient(-45deg, #3d3d3d 0, #3d3d3d 4px, #1c2024 4px, #1c2024 8px) !important;\n      pointer-events: none;\n    }\n\n    :host::before {\n      content: "";\n      position: absolute;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      background: rgba(255, 255, 255, 0);\n      transition: background 0.2s ease;\n    }\n\n    :host(:hover)::before {\n      background: rgba(255, 255, 255, 0.1);\n    }\n\n    .channel-title {\n      position: absolute;\n      bottom: var(--padding-2);\n      left: var(--padding-2);\n      padding: var(--padding-1) var(--padding-2);\n      color: white;\n      font-size: 15px;\n      font-weight: 500;\n      text-overflow: ellipsis;\n      border-radius: 4px;\n\n      @container (max-width: 480px) {\n        font-size: 13px;\n      }\n    }\n  </style>\n  <slot></slot>\n';class pt extends HTMLElement{constructor(){super(),b(this,mt),f(this,"lastThumbnailUpdate");const t=this.attachShadow({mode:"open"});w(this,mt,document.createElement("span")),v(this,mt).className="channel-title",t.appendChild(v(this,mt)),t.appendChild(ut.content.cloneNode(!0))}attributeChangedCallback(t,e,i){if(e!==i)switch(t){case"url":this.updateThumbnail();break;case"title":v(this,mt).textContent=i}}updateThumbnail(){const t=this.getAttribute("url"),e=this.hasAttribute("offline"),i=this.hasAttribute("visible");if(e||!t||!i||this.lastThumbnailUpdate&&Date.now()-this.lastThumbnailUpdate<1e4)return;const n=new URL(t),s=new Image,r=this.getAttribute("authentication-token");r&&n.searchParams.set("auth.token",r),n.searchParams.set("t",Date.now().toString()),s.src=n.toString(),s.onload=()=>this.style.backgroundImage=`url(${n.toString()})`}}mt=new WeakMap,f(pt,"observedAttributes",["url","title","offline","authentication-token","visible"]);const gt=document.createElement("template");var ft,At,vt,bt,wt,yt,St,kt,Et,Tt,It,Ct,xt,Mt,Ut,Rt,Lt,Pt,Bt,_t,Dt,Nt;gt.innerHTML='\n  <style>\n    :host {\n      cursor: default;\n      display: flex;\n      flex-direction: column;\n      box-sizing: border-box;\n      border-radius: 4px;\n      background-color: var(--bg-subtle);\n      padding: var(--padding-2);\n\n      position: absolute;\n      bottom: 0;\n      right: 0;\n\n      z-index: 5;\n      width: 100%;\n      max-height: 75%;\n    }\n\n    :host([hidden]) {\n      display: none;\n    }\n\n    .wrapper {\n      overflow: auto;\n      -ms-overflow-style: none;\n      scrollbar-width: none;\n      height: 100%;\n    }\n\n    .wrapper::-webkit-scrollbar {\n      display: none;\n    }\n\n    slot#grid {\n      display: grid;\n      gap: var(--padding-2);\n      grid-template-columns: repeat(4, minmax(0, 1fr));\n\n      @container (width < 768px) {\n        grid-template-columns: repeat(2, minmax(0, 1fr));\n      }\n      @container (width < 1024px) and (width >= 768px) {\n        grid-template-columns: repeat(3, minmax(0, 1fr));\n      }\n      @container (width >= 1024px) {\n        grid-template-columns: repeat(4, minmax(0, 1fr));\n      }\n    }\n\n    /* Smart TV */\n    @media (width < 1024px) and (width >= 768px) and (-webkit-min-device-pixel-ratio: 2) {\n      slot#grid {\n        grid-template-columns: repeat(4, minmax(0, 1fr)) !important;\n      }\n    }\n\n    :host([mode="list"]) slot#grid {\n      grid-template-columns: repeat(1, minmax(0, 1fr));\n    }\n  </style>\n\n  <div class="wrapper">\n    <slot name="grid" id="grid"></slot>\n  </div>\n';class Wt extends HTMLElement{constructor(){super(),b(this,Tt),b(this,ft,null),b(this,At,null),b(this,vt,[]),b(this,bt,[]),b(this,wt),b(this,yt),b(this,St),b(this,kt),b(this,Et),f(this,"handleEvent",(t=>{"keydown"===t.type&&y(this,Tt,_t).call(this,t)})),this.attachShadow({mode:"open"}).appendChild(gt.content.cloneNode(!0))}connectedCallback(){var t,e,i;w(this,At,this.closest("vindral-controller")),null==(t=v(this,At))||t.connectListener(this),y(this,Tt,It).call(this),null==(i=v(this,ft))||i.observe(null==(e=this.shadowRoot)?void 0:e.querySelector(".wrapper")),y(this,Tt,Mt).call(this),w(this,St,window.setInterval((()=>{y(this,Tt,Pt).call(this)}),1e4))}disconnectedCallback(){var t;clearInterval(v(this,St)),this.removeEventListener("keydown",this),null==(t=v(this,ft))||t.disconnect()}attributeChangedCallback(t,e,i){if(e!==i)switch(t){case C.CHANNEL_ID:y(this,Tt,Lt).call(this,i);break;case C.CHANNELS:w(this,vt,JSON.parse(i)),y(this,Tt,Mt).call(this);break;case"authentication-token":w(this,yt,i)}}get keysUsed(){return["Enter","Escape","Tab"," ","ArrowDown","ArrowUp","ArrowLeft","ArrowRight","Home","End"]}focus(){var t;w(this,kt,dt()),null==(t=v(this,wt))||t.focus()}}ft=new WeakMap,At=new WeakMap,vt=new WeakMap,bt=new WeakMap,wt=new WeakMap,yt=new WeakMap,St=new WeakMap,kt=new WeakMap,Et=new WeakMap,Tt=new WeakSet,It=function(){w(this,ft,new IntersectionObserver((t=>{t.forEach((t=>{const{target:e,isIntersecting:i}=t;e instanceof pt?y(this,Tt,xt).call(this,e,i):y(this,Tt,Ct).call(this,i)}))}),{root:v(this,At)}))},Ct=function(t){var e,i;if(t){this.dispatchEvent(new CustomEvent(M.CHANNEL_GRID_OPENED,{bubbles:!0,composed:!0}));const t=()=>{window.clearTimeout(v(this,Et)),w(this,Et,window.setTimeout((()=>{var e;this.focus(),null==(e=this.parentElement)||e.removeEventListener("scroll",t)}),100))};null==(e=this.parentElement)||e.addEventListener("scroll",t),this.addEventListener("keydown",this),v(this,wt)&&(v(this,wt).tabIndex=0)}else v(this,wt)&&(v(this,wt).tabIndex=-1),this.dispatchEvent(new CustomEvent(M.CHANNEL_GRID_CLOSED,{bubbles:!0,composed:!0})),null==(i=v(this,kt))||i.focus(),this.removeEventListener("keydown",this)},xt=function(t,e){e?(t.setAttribute("visible",""),(!t.lastThumbnailUpdate||Date.now()-t.lastThumbnailUpdate>=1e4)&&(t.updateThumbnail(),t.lastThumbnailUpdate=Date.now())):t.removeAttribute("visible")},Mt=function(){var t;const e=null==(t=this.shadowRoot)?void 0:t.querySelector("slot[name=grid]"),i=new Map(v(this,bt).map((t=>[t.id,t]))),n=this.getAttribute("channel-id");w(this,bt,v(this,vt).map((t=>{var s;const r=i.get(t.channelId);if(r)return y(this,Tt,Ut).call(this,r.element,t),r;const a=y(this,Tt,Rt).call(this,t,n);return null==(s=v(this,ft))||s.observe(a.element),e.contains(a.element)||e.appendChild(a.element),a}))),i.forEach(((t,e)=>{var i;v(this,vt).some((t=>t.channelId===e))||(null==(i=v(this,ft))||i.unobserve(t.element),t.element.remove())})),v(this,bt).sort(((t,e)=>t.element.hasAttribute("offline")&&!e.element.hasAttribute("offline")?1:-1)).forEach((t=>{e.contains(t.element)||e.appendChild(t.element)}))},Ut=function(t,e){e.isLive?t.removeAttribute("offline"):t.setAttribute("offline",""),t.setAttribute("url",e.thumbnailUrls[0]||""),t.setAttribute("title",e.name)},Rt=function(t,e){const i=document.createElement("vindral-channel-grid-item");return i.setAttribute("url",t.thumbnailUrls[0]||""),i.setAttribute("title",t.name),v(this,yt)&&i.setAttribute("authentication-token",v(this,yt)),t.isLive||i.setAttribute("offline",""),t.channelId===e&&(i.setAttribute("aria-selected","true"),w(this,wt,i)),i.tabIndex=-1,i.onclick=()=>y(this,Tt,Bt).call(this,t),{element:i,thumbnail:t.thumbnailUrls[0]||"",id:t.channelId}},Lt=function(t){v(this,bt).forEach((e=>{e.id===t?(e.element.setAttribute("aria-selected","true"),e.element.tabIndex=0,w(this,wt,e.element)):(e.element.tabIndex=-1,e.element.setAttribute("aria-selected","false"))}))},Pt=function(){this.hasAttribute("hidden")||v(this,bt).forEach((t=>t.element.updateThumbnail()))},Bt=function(t){var e;null==(e=v(this,At))||e.setAttribute("channel-id",t.channelId)},_t=function(t){var e,i,n;const{key:s,ctrlKey:r,altKey:a,metaKey:o}=t;r||a||o||this.keysUsed.includes(s)&&(t.preventDefault(),t.stopPropagation(),"Tab"===s||"Escape"===s?(null==(e=this.parentElement)||e.removeAttribute("open"),null==(i=v(this,At))||i.focus()):"Enter"===s||" "===s?null==(n=v(this,wt))||n.click():y(this,Tt,Dt).call(this,t))},Dt=function(t){var e;if(!v(this,wt))return;const{key:i}=t;let n=v(this,bt).findIndex((t=>t.element===v(this,wt)));const s=v(this,wt).getBoundingClientRect();switch(i){case"ArrowUp":if(n=y(this,Tt,Nt).call(this,s,-1,0),n<0)return void(null==(e=this.parentElement)||e.removeAttribute("open"));break;case"ArrowDown":n=y(this,Tt,Nt).call(this,s,1,0);break;case"ArrowLeft":n=y(this,Tt,Nt).call(this,s,0,-1);break;case"ArrowRight":n=y(this,Tt,Nt).call(this,s,0,1);break;case"Home":n=0;break;case"End":n=v(this,bt).length-1}if(n>=0&&n<v(this,bt).length){const t=v(this,bt)[n];if(!t)return;v(this,wt).setAttribute("aria-selected","false"),v(this,wt).tabIndex=-1,w(this,wt,t.element),v(this,wt).setAttribute("aria-selected","true"),v(this,wt).tabIndex=0,v(this,wt).focus()}},Nt=function(t,e,i){let n=-1,s=1/0;return v(this,bt).filter((t=>t.element.getBoundingClientRect().width>0)).forEach(((r,a)=>{const o=r.element.getBoundingClientRect(),l=0===e||e<0&&o.top<t.top||e>0&&o.top>t.top,h=0===i||i<0&&o.left<t.left||i>0&&o.left>t.left;if(l&&h){const e=Math.sqrt(Math.pow(o.top-t.top,2)+Math.pow(o.left-t.left,2));e<s&&(s=e,n=a)}})),n},f(Wt,"observedAttributes",[C.CHANNELS,C.CHANNEL_ID,C.AUTHENTICATION_TOKEN,"mode","hidden"]);const Ot=document.createElement("template");var Ft,Vt,Gt,zt,Ht,jt,Xt,qt,Qt,$t;Ot.innerHTML='\n  <style>\n    :host {\n      display: var(--grid-button-display);\n      cursor: pointer;\n      flex-shrink: 0.5;\n      color: var(--fg-strong);\n    }\n\n    :host([hidden]) {\n      display: none;\n    }\n  </style>\n  <slot name="button">\n<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-layout-grid" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="currentColor" stroke-linecap="round" stroke-linejoin="round">\n  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>\n  <path d="M4 4m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v4a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z" />\n  <path d="M14 4m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v4a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z" />\n  <path d="M4 14m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v4a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z" />\n  <path d="M14 14m0 1a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v4a1 1 0 0 1 -1 1h-4a1 1 0 0 1 -1 -1z" />\n</svg>\n</slot>\n';const Zt=class extends G{constructor(){var t,e;super(),b(this,Ht),b(this,Ft),b(this,Vt),b(this,Gt),b(this,zt,(t=>{t.composedPath().includes(this)||y(this,Ht,qt).call(this)})),null==(t=this.shadowRoot)||t.appendChild(Ot.content.cloneNode(!0)),w(this,Ft,null==(e=this.shadowRoot)?void 0:e.querySelector("slot[name=button]"))}connectedCallback(){var t;super.connectedCallback(),this.setAttribute("aria-haspopup","listbox"),this.enable(),y(this,Ht,Qt).call(this);const e=this.getRootNode();(e instanceof Document||e instanceof ShadowRoot)&&(w(this,Vt,e.querySelector("vindral-channel-grid")),"vindral-scroll-overlay"===(null==(t=v(this,Vt).parentElement)?void 0:t.localName)&&(v(this,Vt).hidden=!1,v(this,Vt).style.position="relative",w(this,Gt,v(this,Vt).parentElement))),y(this,Ht,$t).call(this)}disconnectedCallback(){}attributeChangedCallback(t,e,i){super.attributeChangedCallback(t,e,i),(t===C.CHANNEL_GROUP_ID||t===C.CHANNELS)&&y(this,Ht,Qt).call(this)}enable(){super.enable(),document.addEventListener("click",v(this,zt))}handleClick(t){y(this,Ht,jt).call(this)}get isOpen(){var t,e;return(null==(t=v(this,Gt))?void 0:t.hasAttribute("open"))||!(null!=(e=v(this,Vt))&&e.hidden)}};Ft=new WeakMap,Vt=new WeakMap,Gt=new WeakMap,zt=new WeakMap,Ht=new WeakSet,jt=function(){var t;v(this,Gt)?v(this,Gt).hasAttribute("open")?y(this,Ht,qt).call(this):y(this,Ht,Xt).call(this):null!=(t=v(this,Vt))&&t.hidden?y(this,Ht,Xt).call(this):y(this,Ht,qt).call(this),y(this,Ht,$t).call(this)},Xt=function(){var t;if(v(this,Gt))v(this,Gt).setAttribute("open","");else{if(null==(t=v(this,Vt))||!t.hidden)return;v(this,Vt).hidden=!1,v(this,Vt).focus()}v(this,Ft).setAttribute("aria-expanded","true")},qt=function(){if(v(this,Gt))v(this,Gt).removeAttribute("open");else{if(!v(this,Vt)||v(this,Vt).hidden)return;v(this,Vt).hidden=!0}v(this,Ft).setAttribute("aria-expanded","false")},Qt=function(){this.getAttribute(C.CHANNEL_GROUP_ID)?this.removeAttribute("hidden"):this.setAttribute("hidden",""),this.hasAttribute(C.CHANNELS)?this.removeAttribute("disabled"):this.setAttribute("disabled","")},$t=function(){this.setAttribute("aria-label",this.isOpen?"Exit grid":"Enter grid")},f(Zt,"observedAttributes",[...S(Zt,Zt,"observedAttributes"),C.CHANNEL_GROUP_ID,C.CHANNELS,"hidden"]);let Kt=Zt;const Jt=document.createElement("template");Jt.innerHTML='\n  <style>\n    :host {\n      display: flex;\n      width: 100%;\n      align-items: center;\n    }\n\n    slot {\n      display: flex;\n      flex-grow: 1;\n      align-items: center;\n    }\n\n    :host([content-center]) slot {\n      justify-content: center;\n    }\n\n    slot[name="right"] {\n      justify-content: flex-end;\n    }\n  </style>\n\n  <slot name="bar">\n    <slot></slot>\n    <slot name="right"></slot>\n  </slot>\n';class Yt extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}).appendChild(Jt.content.cloneNode(!0))}connectedCallback(){}disconnectedCallback(){}}f(Yt,"observedAttributes",[]);class te extends a.E{constructor(t){super(),f(this,"config"),f(this,"hlsUrl"),f(this,"element"),f(this,"connectingTimeout"),f(this,"updateAuthenticationToken",(t=>{})),f(this,"unload",(()=>{this.element&&(this.element.removeEventListener("webkitplaybacktargetavailabilitychanged",this.onAirPlayAvailable),this.element.removeEventListener("webkitcurrentplaybacktargetiswirelesschanged",this.onAirPlayPlaybackChanged),this.element.remove())})),f(this,"onAirPlayAvailable",(t=>{"available"===t.availability&&this.element.src!==this.hlsUrl&&this.checkHlsUrl(this.hlsUrl).then((t=>{t&&(this.element.src=this.hlsUrl,this.emit("available"))}))})),f(this,"onAirPlayPlaybackChanged",(()=>{window.clearTimeout(this.connectingTimeout),this.element.webkitCurrentPlaybackTargetIsWireless?(this.emit("connected"),this.element.style.display="block",this.element.paused&&this.element.play()):(this.emit("disconnected"),this.element.pause(),this.element.src="",this.element.src=this.hlsUrl,this.element.style.display="none")})),this.hlsUrl=new URL(`/api/hls?channelId=${t.channelId}`,t.url).toString(),this.config=t,this.element=document.createElement("video"),this.element.style.position="absolute",this.element.style.top="0",this.element.style.bottom="0",this.element.style.left="0",this.element.style.right="0",this.element.style.width="100%",this.element.style.height="100%",this.element.style.zIndex="1001",this.element.style.display="none",this.element.id="vindral-airplay-element",this.element.slot="overlay",this.element.playsInline=!0,this.element.controls=!0,this.element.preload="metadata",this.element.addEventListener("webkitplaybacktargetavailabilitychanged",this.onAirPlayAvailable),this.element.addEventListener("webkitcurrentplaybacktargetiswirelesschanged",this.onAirPlayPlaybackChanged),this.config.container.appendChild(this.element)}get casting(){return this.element.webkitCurrentPlaybackTargetIsWireless}set channelId(t){}showPlaybackTargetPicker(){this.element.paused&&(this.element.play(),this.connectingTimeout=window.setTimeout((()=>{this.element.webkitCurrentPlaybackTargetIsWireless||(this.element.pause(),this.element.src="",this.element.src=this.hlsUrl)}),3e4)),this.element.webkitShowPlaybackTargetPicker()}static isAirPlaySupported(){return!!window.WebKitPlaybackTargetAvailabilityEvent}checkHlsUrl(t){return k(this,null,(function*(){try{return(yield fetch(t,{method:"HEAD"})).ok}catch(t){return!1}}))}}const ee=class t extends a.E{constructor(e){super(),f(this,"container"),f(this,"unload",(()=>{document.removeEventListener("webkitfullscreenchange",this.onChange),document.removeEventListener("mozfullscreenchange",this.onChange),document.removeEventListener("fullscreenchange",this.onChange),this.container.removeEventListener("webkitendfullscreen",this.onChange)})),f(this,"request",(()=>k(this,null,(function*(){try{yield this.requestFn()}catch(t){throw this.onChange(),t}})))),f(this,"exit",(()=>k(this,null,(function*(){try{yield this.exitFn()}catch(t){throw this.onChange(),t}})))),f(this,"onChange",(()=>this.emit("on fullscreen change",this.isFullscreen()))),f(this,"isFullscreen",(()=>!!(document.fullScreen||document.mozFullScreen||document.webkitIsFullScreen))),f(this,"isSupported",(()=>t.isFullscreenApiSupported(this.container)||!this.isInIframe())),f(this,"isFullscreenApiSupported",(()=>t.isFullscreenApiSupported(this.container))),f(this,"isInIframe",(()=>window.location!==window.parent.location)),this.container=e,document.addEventListener("webkitfullscreenchange",this.onChange),document.addEventListener("mozfullscreenchange",this.onChange),document.addEventListener("fullscreenchange",this.onChange),this.container.addEventListener("webkitendfullscreen",this.onChange)}get requestFn(){return t.isFullscreenApiSupported(this.container)?(this.container.requestFullscreen||this.container.webkitRequestFullscreen||this.container.webkitEnterFullscreen||this.container.mozRequestFullScreen).bind(this.container):()=>new Promise((t=>{t()}))}get exitFn(){if(t.isFullscreenApiSupported(this.container)&&this.isFullscreen()){const t=document.exitFullscreen,e=document.webkitFullscreenElement&&document.webkitExitFullscreen,i=document.mozFullscreenElement&&document.mozCancelFullScreen,n=t||e||i;return n?n.bind(document):this.container.webkitExitFullscreen.bind(this.container)}return()=>new Promise((t=>{t()}))}};f(ee,"isFullscreenApiSupported",(t=>void 0!==(t.requestFullscreen||t.webkitRequestFullscreen||t.webkitEnterFullscreen||t.mozRequestFullScreen)));let ie=ee;var ne,se,re,ae,oe,le,he,ce,de;class ue extends a.E{constructor(t){super(),f(this,"unload",(()=>{this.element.removeEventListener("enterpictureinpicture",this.onChange),this.element.removeEventListener("leavepictureinpicture",this.onChange)})),f(this,"request",(()=>k(this,null,(function*(){try{return yield v(this,ne).call(this)}catch(t){throw this.onChange(),t}})))),f(this,"exit",(()=>k(this,null,(function*(){try{return yield v(this,se).call(this)}catch(t){throw this.onChange(),t}})))),f(this,"onChange",(()=>{this.emit("on picture in picture change",this.isPictureInPictureActive())})),f(this,"isPictureInPictureActive",(()=>v(this,he).call(this)||v(this,le).call(this))),f(this,"isSupported",(()=>v(this,de).call(this)||v(this,oe).call(this))),b(this,ne,(()=>v(this,oe).call(this)?v(this,re).call(this):v(this,de).call(this)?v(this,ce).call(this,"picture-in-picture"):Promise.resolve())),b(this,se,(()=>this.isPictureInPictureActive()?v(this,oe).call(this)?v(this,ae).call(this):v(this,de).call(this)?v(this,ce).call(this,"inline"):Promise.resolve():Promise.resolve())),b(this,re,(()=>k(this,null,(function*(){yield this.element.requestPictureInPicture()})))),b(this,ae,(()=>k(this,null,(function*(){yield document.exitPictureInPicture()})))),b(this,oe,(()=>!!this.element.requestPictureInPicture&&!!document.pictureInPictureEnabled)),b(this,le,(()=>!!document.pictureInPictureElement)),b(this,he,(()=>"picture-in-picture"===this.element.webkitPresentationMode)),b(this,ce,(t=>(this.element.webkitSetPresentationMode&&this.element.webkitSetPresentationMode(t),Promise.resolve()))),b(this,de,(()=>!!this.element.webkitSetPresentationMode)),this.element=t,this.element.addEventListener("enterpictureinpicture",this.onChange),this.element.addEventListener("leavepictureinpicture",this.onChange),this.element.setAttribute("autopictureinpicture","")}}ne=new WeakMap,se=new WeakMap,re=new WeakMap,ae=new WeakMap,oe=new WeakMap,le=new WeakMap,he=new WeakMap,ce=new WeakMap,de=new WeakMap;class me extends a.E{constructor(t){if(super(),f(this,"audioContext"),f(this,"audioNode"),f(this,"bufferLength"),f(this,"animationFrameId",null),f(this,"canUseFloatTimeDomainData"),f(this,"byteSampleBuffer",null),f(this,"floatSampleBuffer",null),f(this,"leftAnalyser"),f(this,"rightAnalyser"),f(this,"mediaElementSource",null),f(this,"update",(()=>{const t=this.getDecibel(this.leftAnalyser,this.floatSampleBuffer||this.byteSampleBuffer),e=this.getDecibel(this.rightAnalyser,this.floatSampleBuffer||this.byteSampleBuffer);this.emit("on decibel change",{left:t,right:e}),this.animationFrameId=requestAnimationFrame(this.update)})),this.source=t,t instanceof HTMLMediaElement){const e=new AudioContext;this.mediaElementSource=e.createMediaElementSource(t),this.audioNode=e.createChannelSplitter(2),this.mediaElementSource.connect(this.audioNode),this.audioContext=e,this.mediaElementSource.connect(this.audioContext.destination)}else this.audioNode=t,this.audioContext=this.audioNode.context;this.leftAnalyser=this.audioNode.context.createAnalyser(),this.rightAnalyser=this.audioNode.context.createAnalyser(),this.audioNode.connect(this.leftAnalyser,0),this.audioNode.connect(this.rightAnalyser,1),this.canUseFloatTimeDomainData="function"==typeof this.leftAnalyser.getFloatTimeDomainData,this.leftAnalyser.fftSize=1024,this.rightAnalyser.fftSize=1024,this.bufferLength=this.leftAnalyser.fftSize,this.canUseFloatTimeDomainData?this.floatSampleBuffer=new Float32Array(this.bufferLength):this.byteSampleBuffer=new Uint8Array(this.bufferLength)}getDecibel(t,e){let i=0;if(this.canUseFloatTimeDomainData){t.getFloatTimeDomainData(e);for(let t=0;t<e.length;t++){const n=e[t];if(n){const t=n**2;i=Math.max(t,i)}}}else{t.getByteTimeDomainData(e);for(let t=0;t<e.length;t++){const n=e[t];if(n){const t=(n/128-1)**2;i=Math.max(t,i)}}}return 10*Math.log10(i)}start(){null===this.animationFrameId&&(this.audioContext instanceof AudioContext&&"suspended"===this.audioContext.state?this.audioContext.resume().then((()=>{this.update()})):this.update())}stop(){null!==this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}unload(){var t;this.stop(),null==(t=this.mediaElementSource)||t.disconnect(),this.leftAnalyser.disconnect(),this.rightAnalyser.disconnect(),this.audioNode.disconnect()}get isMediaElementSource(){return this.source instanceof HTMLMediaElement}}const pe=t=>{var e;let i="observedAttributes"in t.constructor?t.constructor.observedAttributes:void 0;return!i&&null!=(e=t.nodeName)&&e.includes("-")&&(globalThis.customElements.upgrade(t),i="observedAttributes"in t.constructor?t.constructor.observedAttributes:void 0),Array.isArray(i)?i.filter((t=>x.includes(t))):[]},ge=document.createElement("template");var fe,Ae,ve,be,we,ye,Se,ke,Ee;ge.innerHTML="\n  <style>\n    :host {\n      position: relative;\n    }\n\n    :host([hidden]) {\n      display: none;\n    }\n  </style>\n";class Te extends G{constructor(){var t;super(),b(this,Se),b(this,fe),b(this,Ae),b(this,ve),b(this,be,null),b(this,we,(t=>{t.composedPath().includes(this)||this.hide()})),b(this,ye,(()=>{this.hide()})),null==(t=this.shadowRoot)||t.appendChild(ge.content.cloneNode(!0))}connectedCallback(){var t,e,i,n;super.connectedCallback(),this.setAttribute("role","button"),this.setAttribute("aria-haspopup","listbox");const s=null!=(t=this.getAttribute("list-position"))?t:"top";null==(e=v(this,Ae))||e.setAttribute("list-position",s);const r=this.getRootNode(),a=[...null!=(n=null==(i=this.shadowRoot)?void 0:i.querySelectorAll(":not(:defined)"))?n:[]].map((t=>customElements.whenDefined(t.localName)));Promise.all(a).then((()=>{var t;(r instanceof Document||r instanceof ShadowRoot)&&(w(this,be,r.querySelector("vindral-controller")),null==(t=v(this,be))||t.connectListener(this))}))}set button(t){w(this,fe,t)}set listbox(t){w(this,Ae,t)}set listboxSlot(t){w(this,ve,t)}enable(){super.enable(),this.addEventListener("change",v(this,ye)),document.addEventListener("click",v(this,we))}hide(){var t,e;!v(this,ve)||null!=(t=v(this,ve))&&t.hidden||(v(this,ve).hidden=!0,null==(e=v(this,fe))||e.setAttribute("aria-expanded","false"),this.dispatchEvent(new CustomEvent(M.UNLOCK_UI,{bubbles:!0,composed:!0})),this.focus())}handleClick(t){v(this,ve)&&!t.composedPath().includes(v(this,ve))&&y(this,Se,ke).call(this)}}fe=new WeakMap,Ae=new WeakMap,ve=new WeakMap,be=new WeakMap,we=new WeakMap,ye=new WeakMap,Se=new WeakSet,ke=function(){var t;null!=(t=v(this,ve))&&t.hidden?y(this,Se,Ee).call(this):this.hide()},Ee=function(){var t,e,i;null!=(t=v(this,ve))&&t.hidden&&(v(this,ve).hidden=!1,null==(e=v(this,fe))||e.setAttribute("aria-expanded","true"),null==(i=v(this,Ae))||i.focus(),this.dispatchEvent(new CustomEvent(M.LOCK_UI,{bubbles:!0,composed:!0})))};const Ie=document.createElement("template");var Ce,xe,Me,Ue;Ie.innerHTML='\n  <style>\n    :host {\n      --value: 0;\n      --_focus-box-shadow: none;\n      height: calc(var(--button-icon-size) + 2 * var(--button-padding));\n      width: 100%;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      padding: 0;\n      margin: 0;\n      position: relative;\n      cursor: pointer;\n      pointer-events: auto;\n      touch-action: none;\n      box-shadow: var(--_focus-visible-box-shadow, none);\n      outline: 0;\n      background: transparent;\n      transition: background 0.2s linear;\n    }\n\n    #range {\n      -webkit-appearance: none;\n      appearance: none;\n\n      height: 4px;\n      width: 100%;\n      margin: 0;\n      padding: 0;\n\n      background-color: #00000000;\n      outline: none;\n      z-index: 1;\n      cursor: pointer;\n    }\n\n    #range-track {\n      position: absolute;\n      top: calc(50% - 2px);\n      left: 1px;\n      width: calc(100% - 1px);\n      height: 4px;\n      background-color: rgb(255 255 255 / 0.2);\n      overflow: hidden;\n      cursor: pointer;\n    }\n\n    #range-track::before {\n      position: absolute;\n      content: "";\n      left: calc(-100%);\n      top: 0;\n      width: calc(100%);\n      height: 100%;\n      background-color: var(--fg-strong);\n      transition: background-color 300ms ease-out;\n      transform-origin: 100% 0%;\n      transform: translateX(calc(var(--value) * 100%)) scaleX(1.2);\n    }\n\n    #range::-webkit-slider-thumb {\n      -webkit-appearance: none;\n      appearance: none;\n      width: 12px;\n      height: 12px;\n      border-radius: 50%;\n      background-color: var(--fg-strong);\n      cursor: pointer;\n      z-index: 1;\n    }\n\n    #range::-moz-range-thumb {\n      -moz-appearance: none;\n      appearance: none;\n      width: 12px;\n      height: 12px;\n      border-radius: 50%;\n      background-color: var(--fg-strong);\n      cursor: pointer;\n      z-index: 1;\n    }\n\n    :host(:focus-visible) {\n      box-shadow: inset 0 0 0 2px var(--fg-strong);\n      outline: 0;\n    }\n\n    @media (hover: hover) and (pointer: fine) {\n      :host(:hover) {\n        background: rgba(255, 255, 255, 0.15);\n      }\n    }\n\n    :host(:active) {\n      background: rgba(255, 255, 255, 0.25);\n    }\n  </style>\n\n  <input type="range" id="range" min="0" max="1" step="any" value="0" />\n  <div id="range-track"></div>\n';class Re extends HTMLElement{constructor(){super(),b(this,Ce,null),b(this,xe),f(this,"range"),b(this,Me,(()=>{this.range.matches(":focus-visible")&&this.style.setProperty("--_focus-visible-box-shadow","inset 0 0 0 2px var(--fg-strong)")})),b(this,Ue,(()=>{this.style.removeProperty("--_focus-visible-box-shadow")})),w(this,xe,this.attachShadow({mode:"open"})),v(this,xe).appendChild(Ie.content.cloneNode(!0)),this.range=v(this,xe).getElementById("range")}connectedCallback(){var t;w(this,Ce,this.closest("vindral-controller")),null==(t=v(this,Ce))||t.connectListener(this),this.hasAttribute("disabled")||this.enable(),this.range.addEventListener("focusin",v(this,Me)),this.range.addEventListener("focusout",v(this,Ue))}disconnectedCallback(){var t;null==(t=v(this,Ce))||t.disconnectListener(this),this.range.removeEventListener("focusin",v(this,Me)),this.range.removeEventListener("focusout",v(this,Ue))}attributeChangedCallback(t,e,i){e!==i&&("disabled"===t&&i?this.disable():this.enable(),this.updateBar())}enable(){this.addEventListener("input",this)}disable(){this.range.removeEventListener("input",this)}handleEvent(t){"input"===t.type&&this.updateBar()}updateBar(){this.style.setProperty("--value",this.range.value)}get keysUsed(){return["ArrowUp","ArrowRight","ArrowDown","ArrowLeft"]}}Ce=new WeakMap,xe=new WeakMap,Me=new WeakMap,Ue=new WeakMap,f(Re,"observedAttributes",["disabled"]);const Le=document.createElement("template");Le.innerHTML=`\n  <style>\n    :host {\n      --fg-strong: var(--vindral-fg-strong, #eeeeee);\n      --fg-subtle: var(--vindral-fg-subtle, #b4b4b4);\n      --fg-extra-subtle: var(--vindral-fg-extra-subtle, #7b7b7b);\n      --bg-strong: var(--vindral-bg-strong, #111111);\n      --bg-subtle: var(--vindral-bg-subtle, #191919);\n      --bg-extra-subtle: var(--vindral-bg-extra-subtle, #222222);\n      --bg-component: var(--vindral-bg-component, #222222);\n      --bg-component-hover: var(--vindral-bg-component-hover, #2a2a2a);\n      --bg-component-active: var(--vindral-bg-component-active, #313131);\n\n      --padding-1: var(--vindral-padding-1, 4px);\n      --padding-2: var(--vindral-padding-2, 8px);\n      --padding-3: var(--vindral-padding-3, 16px);\n      --padding-4: var(--vindral-padding-4, 24px);\n      --padding-5: var(--vindral-padding-5, 32px);\n      --padding-6: var(--vindral-padding-6, 40px);\n      --control-padding: var(--vindral-control-padding, var(--padding-1));\n\n      --ui-font: var(\n        --vindral-ui-font,\n        -apple-system,\n        BlinkMacSystemFont,\n        "Segoe UI",\n        Roboto,\n        "Helvetica Neue",\n        Arial,\n        sans-serif\n      );\n\n      --button-padding: var(--vindral-button-padding, var(--padding-2));\n      --button-icon-size: var(--vindral-button-icon-size, 24px);\n      --play-overlay-icon-size: var(--vindral-play-overlay-icon-size, 72px);\n\n      --ui-display: var(--vindral-ui-display, flex);\n      --play-button-display: var(--vindral-play-button-display, flex);\n      --mute-button-display: var(--vindral-mute-button-display, flex);\n      --airplay-button-display: var(--vindral-airplay-button-display, flex);\n      --pip-button-display: var(--vindral-pip-button-display, flex);\n      --fullscreen-button-display: var(--vindral-fullscreen-button-display, flex);\n      --cast-button-display: var(--vindral-cast-button-display, flex);\n      --grid-button-display: var(--vindral-grid-button-display, flex);\n      --grid-item-offline-display: var(--vindral-grid-item-offline-display, flex);\n      --volume-range-display: var(--vindral-volume-range-display, flex);\n      --volume-meter-display: var(--vindral-volume-meter-display, flex);\n      --rendition-menu-display: var(--vindral-rendition-menu-display, flex);\n      --language-menu-display: var(--vindral-language-menu-display, flex);\n      --play-overlay-display: var(--vindral-play-overlay-display, flex);\n      --buffering-overlay-display: var(--vindral-buffering-overlay-display, flex);\n      --poster-overlay-display: var(--vindral-poster-overlay-display, flex);\n\n      position: relative;\n      display: flex;\n      background-color: var(--bg-strong);\n      width: 100%;\n      container-type: inline-size;\n      overflow: hidden;\n      font-family: var(--ui-font);\n    }\n\n    #ui {\n      position: absolute;\n      display: flex;\n      justify-content: space-between;\n      flex-direction: column;\n      top: 0;\n      bottom: 0;\n      left: 0;\n      right: 0;\n      transition: opacity 0.5s;\n      user-select: none;\n      pointer-events: auto;\n\n      // Ensure the #ui element is above the video element on Safari\n      z-index: 1;\n    }\n\n    #ui > * {\n      pointer-events: auto;\n      display: var(--ui-display);\n    }\n\n    #video {\n      cursor: none;\n      display: flex;\n      width: 100%;\n      z-index: 0;\n    }\n\n    #video > canvas {\n      object-fit: contain;\n    }\n\n    slot#middle {\n      align-items: center;\n      justify-content: center;\n      flex-grow: 1;\n    }\n\n    slot#top-bar {\n      background: linear-gradient(rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0));\n      padding: var(--control-padding);\n    }\n\n    slot#bottom-bar {\n      padding: var(--control-padding);\n      background: linear-gradient(rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.8));\n    }\n\n    :host(:focus-visible) {\n      outline: none;\n    }\n\n    :host(\n        :not([${C.USER_INTERACTING}]\n        ):not([${C.PAUSED}]:not([${C.HIDE_UI_ON_PAUSE}])\n        ):not([${C.IS_CASTING}]\n        ):not([${C.MEDIA}="audio"])\n      )\n      #ui {\n      opacity: 0;\n      cursor: none;\n      pointer-events: none;\n    }\n\n    :host(\n      :not([${C.USER_INTERACTING}]\n      ):not([${C.PAUSED}]:not([${C.HIDE_UI_ON_PAUSE}])\n      ):not([${C.IS_CASTING}]\n      ):not([${C.MEDIA}="audio"])\n    )\n    #ui > * {\n      pointer-events: none;\n    }\n\n    :host([${C.FULLSCREEN}][${C.FULLSCREEN_FALLBACK}]) {\n      position: fixed !important;\n      inset: 0 !important;\n      margin: 0 !important;\n      box-sizing: border-box !important;\n      min-width: 0 !important;\n      max-width: none !important;\n      min-height: 0 !important;\n      max-height: none !important;\n      width: 100% !important;\n      height: 100% !important;\n      transform: none !important;\n      z-index: 1000 !important;\n      background: black;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n\n      /* intentionally not !important */\n      object-fit: contain;\n    }\n\n    :host([${C.MEDIA}="audio"]) {\n      min-height: 100px;\n      overflow: visible;\n    }\n  </style>\n\n  <div id="video"></div>\n\n  <slot id="overlay" name="overlay"></slot>\n\n  <div id="ui">\n    <slot id="top-bar" name="top-bar"></slot>\n    <slot id="middle" name="middle"></slot>\n    <slot id="bottom-bar"></slot>\n    <slot id="overlay-interactive" name="overlay-interactive"></slot>\n  </div>\n`;const Pe=["ArrowDown","ArrowLeft","ArrowRight","Tab","Enter"," ","f","m"];var Be,_e,De,Ne,We,Oe,Fe,Ve,Ge,ze,He,je,Xe,qe,Qe,$e,Ze,Ke,Je,Ye,ti,ei,ii,ni,si,ri,ai,oi,li,hi,ci,di,ui,mi,pi,gi,fi,Ai,vi,bi,wi,yi,Si,ki,Ei,Ti,Ii,Ci,xi,Mi,Ui;const Ri=class t extends HTMLElement{constructor(){super(),b(this,Ye),b(this,_e,new Map),b(this,De,2e3),b(this,Ne,null),b(this,We,null),b(this,Oe),b(this,Fe,v(t,Be)),b(this,Ve),b(this,Ge),b(this,ze),b(this,He),b(this,je),b(this,Xe),b(this,qe),b(this,Qe),b(this,$e),b(this,Ze),b(this,Ke),b(this,Je,null),b(this,li,0),f(this,"handleEvent",(t=>{switch(t.type){case"pointerdown":w(this,li,t.timeStamp);break;case"pointermove":y(this,Ye,hi).call(this,t);break;case"pointerup":y(this,Ye,ci).call(this,t);break;case"mouseleave":y(this,Ye,yi).call(this);break;case"dblclick":y(this,Ye,di).call(this,t);break;case"mousemove":y(this,Ye,ui).call(this,t);break;case"keydown":v(this,gi).call(this,t);break;case"keyup":y(this,Ye,yi).call(this),v(this,pi).call(this,t)}})),b(this,mi,(t=>{var e;if(v(this,Oe)&&(v(this,Ke).debug("Vindral event",{type:t.type}),t instanceof CustomEvent))switch(t.type){case M.PLAY:this.removeAttribute(C.PAUSED);break;case M.PAUSE:this.setAttribute(C.PAUSED,"");break;case M.MUTE:this.setAttribute(C.MUTED,"");break;case M.UNMUTE:this.removeAttribute(C.MUTED);break;case M.LOCK_UI:this.setAttribute(C.UI_LOCKED,"");break;case M.UNLOCK_UI:this.removeAttribute(C.UI_LOCKED);break;case M.ENTER_FULLSCREEN:this.setAttribute(C.FULLSCREEN,"");break;case M.EXIT_FULLSCREEN:this.removeAttribute(C.FULLSCREEN);break;case M.SET_RENDITION:{const e=t.detail;e.audio&&(v(this,Oe).maxAudioBitRate=e.audio.bitRate),e.video&&(v(this,Oe).maxVideoBitRate=e.video.bitRate,v(this,Oe).maxSize=e.video,this.setAttribute(C.MAX_VIDEO_BITRATE,String(e.video.bitRate)))}break;case M.CHANNEL_GRID_OPENED:null===v(this,Je)&&y(this,Ye,vi).call(this);break;case M.CHANNEL_GRID_CLOSED:null!==v(this,Je)&&(clearTimeout(v(this,Je)),w(this,Je,null));break;case M.ENTER_PIP:this.setAttribute(C.IS_PIP,"");break;case M.EXIT_PIP:this.removeAttribute(C.IS_PIP);break;case M.REQUEST_AIRPLAY:null==(e=v(this,Xe))||e.showPlaybackTargetPicker();break;case M.SET_LANGUAGE:B(t.detail)?this.setAttribute(C.LANGUAGE,t.detail):this.removeAttribute(C.LANGUAGE);break;case M.SET_TEXT_TRACK:B(t.detail)?this.setAttribute(C.TEXT_TRACK,t.detail):this.removeAttribute(C.TEXT_TRACK);break;case M.REQUEST_USER_INPUT:v(this,Oe).play(),v(this,Oe).muted=!1;break;case M.SET_VOLUME:{const e=t.detail;v(this,Oe).muted&&e>0?v(this,Oe).muted=!1:0===e&&(v(this,Oe).muted=!0),this.setAttribute(C.VOLUME,e.toString())}}})),b(this,pi,(t=>{const{key:e}=t;Pe.includes(e)?y(this,Ye,fi).call(this,t):this.removeEventListener("keyup",this)})),b(this,gi,(t=>{const{metaKey:e,altKey:i,key:n}=t;e||i||!Pe.includes(n)||this.addEventListener("keyup",this,{once:!0})})),b(this,Ai,null),b(this,Ii,(()=>{var t,e,i;if(!("orientation"in screen)||!screen.orientation.lock)return;const n=null==(t=v(this,Oe))?void 0:t.currentRenditionLevel;null!=n&&n.video&&screen.orientation.lock((null==(e=null==n?void 0:n.video)?void 0:e.width)>(null==(i=null==n?void 0:n.video)?void 0:i.height)?"landscape-primary":"portrait-primary").catch((()=>{}))})),b(this,Ci,(()=>{!("orientation"in screen)||!screen.orientation.unlock||screen.orientation.unlock()})),this.attachShadow({mode:"open"}).appendChild(Le.content.cloneNode(!0));const e=R(this.getAttribute("log-level"));w(this,Ke,r.L.get().createContext("VindralController")),v(this,Ke).setLevel(e)}connectedCallback(){return k(this,null,(function*(){_(this.getAttribute("auto-instance-enabled"),!0)&&(yield y(this,Ye,ti).call(this));for(const t of Object.values(M))this.addEventListener(t,v(this,mi));window.PointerEvent?(this.addEventListener("pointerdown",this),this.addEventListener("pointermove",this),this.addEventListener("pointerup",this)):this.addEventListener("mousemove",this),this.addEventListener("mouseleave",this),this.addEventListener("keydown",this),this.addEventListener("resize",this),this.addEventListener("dblclick",this),this.connectListener(this)}))}disconnectedCallback(){var t,e,i,n;null==(t=v(this,Oe))||t.unload(),null==(e=v(this,He))||e.unload(),null==(i=v(this,je))||i.unload(),null==(n=v(this,qe))||n.unload();for(const t of Object.values(M))this.removeEventListener(t,v(this,mi));this.disconnectListener(this)}attributeChangedCallback(t,e,i){var n,s,r,a,o,l,h,c,d,u,m,p,g;if(e!=i)switch(v(this,Ke).debug("Attribute changed",{name:t,oldValue:e,newValue:i}),t){case"channel-id":w(this,Ve,i),v(this,Oe)&&i&&(v(this,Oe).channelId=i,v(this,Oe).play(),y(this,Ye,Mi).call(this,C.BUFFERING,""),y(this,Ye,Mi).call(this,C.CHANNEL_ID,i),y(this,Ye,Mi).call(this,C.POSTER_SRC,v(this,Oe).getThumbnailUrl()));break;case"channel-group-id":w(this,Ge,i);break;case"url":i&&w(this,Fe,i);break;case"paused":B(i)?null==(n=v(this,Oe))||n.pause():(y(this,Ye,Ui).call(this,C.NEEDS_USER_INPUT_VIDEO),null==(s=v(this,Oe))||s.play());break;case"target-buffer-time":if(v(this,Oe)&&i){const t=parseInt(i,10);Number.isNaN(t)||(v(this,Oe).targetBufferTime=t)}break;case"user-interacting":B(i)?y(this,Ye,Mi).call(this,C.USER_INTERACTING,""):y(this,Ye,Ui).call(this,C.USER_INTERACTING);break;case"muted":v(this,Oe)&&(B(i)?(v(this,Oe).muted=!0,y(this,Ye,Mi).call(this,C.MUTED,""),null!=(r=v(this,qe))&&r.isMediaElementSource&&(null==(a=v(this,qe))||a.stop(),y(this,Ye,Mi).call(this,C.VOLUME_LEVEL,JSON.stringify({left:null,right:null})))):(v(this,Oe).muted=!1,y(this,Ye,Ui).call(this,C.MUTED),y(this,Ye,Ui).call(this,C.NEEDS_USER_INPUT_AUDIO),0===v(this,Oe).volume&&(v(this,Oe).volume=.3),null==(o=v(this,qe))||o.start()));break;case"ui-locked":B(i)?y(this,Ye,wi).call(this):y(this,Ye,yi).call(this);break;case"is-fullscreen":B(i)?y(this,Ye,Ei).call(this):y(this,Ye,Ti).call(this);break;case"max-video-bit-rate":w(this,ze,i),B(i)?y(this,Ye,Mi).call(this,C.MAX_VIDEO_BITRATE,i):y(this,Ye,Ui).call(this,C.MAX_VIDEO_BITRATE);break;case"is-pip":B(i)?y(this,Ye,Si).call(this):y(this,Ye,ki).call(this);break;case"is-airplaying":B(i)?(null!=(l=v(this,Oe))&&l.mediaElement&&(v(this,Oe).mediaElement.style.display="hidden"),null==(h=v(this,Oe))||h.pause()):null!=(c=v(this,Oe))&&c.mediaElement&&(v(this,Oe).mediaElement.style.display="block");break;case"is-casting":B(i)?(null!=(d=v(this,je))&&d.isFullscreen()&&y(this,Ye,Ti).call(this),null==(u=v(this,Oe))||u.pause()):document.hidden||null==(m=v(this,Oe))||m.play();break;case"cast-receiver-id":w(this,$e,i);break;case"cast-background":w(this,Ze,i);break;case"language":v(this,Oe)&&(v(this,Oe).language=i,B(i)?y(this,Ye,Mi).call(this,C.LANGUAGE,i):y(this,Ye,Ui).call(this,C.LANGUAGE));break;case"text-track":v(this,Oe)&&(v(this,Oe).textTrack=i,B(i)?y(this,Ye,Mi).call(this,C.TEXT_TRACK,i):y(this,Ye,Ui).call(this,C.TEXT_TRACK));break;case"log-level":B(i)&&v(this,Ke).setLevel(R(i));break;case"authentication-token":B(i)?y(this,Ye,Mi).call(this,C.AUTHENTICATION_TOKEN,i):y(this,Ye,Ui).call(this,C.AUTHENTICATION_TOKEN);break;case"volume":if(v(this,Oe)&&B(i)){const t=parseFloat(i);v(this,Oe).volume=t}break;case"drm-headers":if(B(i)){const t=D(i);t?null==(p=v(this,Oe))||p.drm.setHeaders(t):v(this,Ke).warn("Invalid DRM headers format:",i)}break;case"drm-queryparams":if(B(i)){const t=D(i);t?null==(g=v(this,Oe))||g.drm.setQueryParams(t):v(this,Ke).warn("Invalid DRM query parameters format:",i)}}}connectListener(t){pe(t).forEach((e=>{var i,n;const s=v(this,_e).get(e);switch(s?s.push(t):v(this,_e).set(e,[t]),e){case C.PAUSED:("paused"===(null==(i=v(this,Oe))?void 0:i.playbackState)||this.hasAttribute(C.PAUSED))&&t.setAttribute(C.PAUSED,"");break;case C.MUTED:(null!=(n=v(this,Oe))&&n.muted||this.hasAttribute(C.MUTED))&&t.setAttribute(C.MUTED,"");break;case C.MAX_VIDEO_BITRATE:v(this,ze)&&t.setAttribute(C.MAX_VIDEO_BITRATE,v(this,ze));break;case C.CHANNEL_ID:v(this,Ve)&&t.setAttribute(C.CHANNEL_ID,v(this,Ve));break;case C.CHANNEL_GROUP_ID:v(this,Ge)&&t.setAttribute(C.CHANNEL_GROUP_ID,v(this,Ge));break;case C.AUTHENTICATION_TOKEN:{const e=this.getAttribute("authentication-token");e&&t.setAttribute(C.AUTHENTICATION_TOKEN,e);break}}}))}disconnectListener(t){pe(t).forEach((e=>{const i=v(this,_e).get(e);i&&v(this,_e).set(e,i.filter((e=>e!=t)))}))}get instance(){return v(this,Oe)}get airPlay(){return v(this,Xe)}connect(){y(this,Ye,ti).call(this)}};Be=new WeakMap,_e=new WeakMap,De=new WeakMap,Ne=new WeakMap,We=new WeakMap,Oe=new WeakMap,Fe=new WeakMap,Ve=new WeakMap,Ge=new WeakMap,ze=new WeakMap,He=new WeakMap,je=new WeakMap,Xe=new WeakMap,qe=new WeakMap,Qe=new WeakMap,$e=new WeakMap,Ze=new WeakMap,Ke=new WeakMap,Je=new WeakMap,Ye=new WeakSet,ti=function(){return k(this,null,(function*(){var t,e;if(!v(this,Ve))return;yield null==(t=v(this,Oe))?void 0:t.unload();const i=this.hasAttribute(C.PAUSED),n=this.hasAttribute(C.MUTED),s=U(this.getAttribute(C.MEDIA)),a=this.getAttribute(C.TEXT_TRACK)||void 0,o=this.getAttribute("edge-url")||void 0,l=this.getAttribute("authentication-token")||void 0,h=P(this.getAttribute("max-video-bit-rate")),c=function(t){if(null!==t)try{const e=JSON.parse(t);if("object"==typeof e&&null!==e){const t=e;if("number"==typeof t.width&&"number"==typeof t.height)return t}}catch(t){return}}(this.getAttribute("max-size")),d=P(this.getAttribute("min-buffer-time")),u=P(this.getAttribute("max-buffer-time")),m=_(this.getAttribute("burst-enabled")),p=_(this.getAttribute("mse-enabled")),g=_(this.getAttribute("mse-opus-enabled")),f=_(this.getAttribute("ios-background-play-enabled")),A=_(this.getAttribute("ios-wake-lock-enabled")),b=_(this.getAttribute("ios-media-element-enabled")),S=_(this.getAttribute("abr-enabled")),k=_(this.getAttribute("size-based-resolution-cap-enabled")),E=_(this.getAttribute("telemetry-enabled")),T=function(t){if(null===t)return;const e=t.split(",").map((t=>t.trim())).filter((t=>"h264"===t||"av1"===t));return 0!==e.length?e:void 0}(this.getAttribute("video-codecs")),I=L(this.getAttribute("poster")),x=function(t){if(null!==t)try{const e=JSON.parse(t);if("object"==typeof e&&null!==e){const t=e;if(t.wasmDecodingConstraint){const e=t.wasmDecodingConstraint;if("number"!=typeof e.width||"number"!=typeof e.height||"number"!=typeof e.bitRate)return}return t}}catch(t){return}}(this.getAttribute("advanced")),M=R(this.getAttribute("log-level")),N=D(this.getAttribute("drm-headers")),W=D(this.getAttribute("drm-queryparams")),O=_(this.getAttribute("webtransport-enabled")),F=P(this.getAttribute("reconnect-retries")),V=void 0!==F?t=>t.reconnectRetries<F:void 0,G=this.getAttribute("language")||void 0;w(this,Oe,new r.V({url:v(this,Fe),channelId:v(this,Ve),channelGroupId:v(this,Ge),edgeUrl:o,authenticationToken:l,muted:n,media:s,maxSize:c,maxVideoBitRate:h,minBufferTime:d,maxBufferTime:u,burstEnabled:m,mseEnabled:p,mseOpusEnabled:g,iosBackgroundPlayEnabled:f,iosWakeLockEnabled:A,iosMediaElementEnabled:b,abrEnabled:S,sizeBasedResolutionCapEnabled:k,telemetryEnabled:E,videoCodecs:T,poster:I,textTrack:a,advanced:x,logLevel:M,language:G,drm:{headers:N,queryParams:W},webtransportEnabled:O,reconnectHandler:V})),v(this,Oe).on("rendition levels",(t=>{const e=t.filter((t=>{var e;return null==(e=t.video)?void 0:e.width}));y(this,Ye,Mi).call(this,C.RENDITION_LEVELS,JSON.stringify(e))})),v(this,Oe).on("rendition level",(t=>{y(this,Ye,Mi).call(this,C.RENDITION_LEVEL,JSON.stringify(t))})),v(this,Oe).on("playback state",(t=>{switch(t){case"playing":y(this,Ye,Ui).call(this,C.PAUSED),y(this,Ye,Ui).call(this,C.BUFFERING);break;case"paused":y(this,Ye,Mi).call(this,C.PAUSED,""),y(this,Ye,Ui).call(this,C.BUFFERING);break;case"buffering":y(this,Ye,Ui).call(this,C.PAUSED),y(this,Ye,Mi).call(this,C.BUFFERING,"")}})),v(this,Oe).on("volume state",(t=>{y(this,Ye,Mi).call(this,C.VOLUME,t.volume.toString()),t.isMuted?y(this,Ye,Mi).call(this,C.MUTED,""):y(this,Ye,Ui).call(this,C.MUTED)})),v(this,Oe).on("channel switch failed",(({channelId:t})=>{var e;this.setAttribute(C.CHANNEL_ID,t),"buffering"!==(null==(e=v(this,Oe))?void 0:e.playbackState)&&y(this,Ye,Ui).call(this,C.BUFFERING)})),v(this,Oe).on("channel switch",(({channelId:t})=>{var e;v(this,Ve)!==t&&this.setAttribute(C.CHANNEL_ID,t),"buffering"!==(null==(e=v(this,Oe))?void 0:e.playbackState)&&y(this,Ye,Ui).call(this,C.BUFFERING)})),v(this,Oe).on("channels",(t=>{w(this,Ai,Date.now()),y(this,Ye,Mi).call(this,C.CHANNELS,JSON.stringify(t))})),v(this,Oe).on("languages",(t=>{var e;y(this,Ye,Mi).call(this,C.LANGUAGES,JSON.stringify(t)),null!=(e=v(this,Oe))&&e.language&&y(this,Ye,Mi).call(this,C.LANGUAGE,v(this,Oe).language)})),v(this,Oe).on("text tracks",(t=>{var e,i,n;y(this,Ye,Mi).call(this,C.TEXT_TRACKS,JSON.stringify(t)),null!=(e=v(this,Oe))&&e.textTrack&&y(this,Ye,Mi).call(this,C.TEXT_TRACK,null!=(n=null==(i=v(this,Oe))?void 0:i.textTrack)?n:"")})),v(this,Oe).on("needs user input",(t=>{null!=t&&t.forVideo?(y(this,Ye,Mi).call(this,C.NEEDS_USER_INPUT_VIDEO,""),y(this,Ye,Ui).call(this,C.NEEDS_USER_INPUT_AUDIO)):null!=t&&t.forAudio&&(y(this,Ye,Mi).call(this,C.NEEDS_USER_INPUT_AUDIO,""),y(this,Ye,Ui).call(this,C.NEEDS_USER_INPUT_VIDEO))})),v(this,Oe).on("is live",(t=>{t||y(this,Ye,Ui).call(this,C.BUFFERING)})),w(this,We,null==(e=this.shadowRoot)?void 0:e.querySelector("#video")),v(this,We)&&v(this,Oe).attach(v(this,We)),this.setAttribute(C.MEDIA,v(this,Oe).media),v(this,Oe).muted&&y(this,Ye,Mi).call(this,C.MUTED,""),y(this,Ye,Mi).call(this,C.VOLUME,v(this,Oe).volume.toString()),B(I)||y(this,Ye,Mi).call(this,C.POSTER_SRC,v(this,Oe).getThumbnailUrl());const z=_(this.getAttribute(C.AIRPLAY_ENABLED),!1),H=_(this.getAttribute(C.CAST_ENABLED),!0),j=_(this.getAttribute(C.FULLSCREEN_ENABLED),!0),X=_(this.getAttribute(C.PIP_ENABLED),!0),q=_(this.getAttribute(C.VU_METER_ENABLED),!1);z&&y(this,Ye,ai).call(this,v(this,Oe)),H&&y(this,Ye,ni).call(this,v(this,Oe)),j&&y(this,Ye,ii).call(this,v(this,Oe)),X&&y(this,Ye,ei).call(this,v(this,Oe)),i||v(this,Oe).play(),q&&y(this,Ye,oi).call(this,v(this,Oe)),this.dispatchEvent(new CustomEvent("vindral-instance-ready",{bubbles:!0,composed:!0,detail:v(this,Oe)}))}))},ei=function(t){t.mediaElement instanceof HTMLVideoElement&&(w(this,He,new ue(t.mediaElement)),v(this,He).isSupported()&&(v(this,Ke).debug("PIP is supported"),y(this,Ye,Mi).call(this,C.PIP_AVAILABLE,"")),v(this,He).on("on picture in picture change",(t=>{t?y(this,Ye,Mi).call(this,C.IS_PIP,""):y(this,Ye,Ui).call(this,C.IS_PIP)})))},ii=function(t){const e=!ie.isFullscreenApiSupported(this)&&ie.isFullscreenApiSupported(t.mediaElement)?t.mediaElement:this;w(this,je,new ie(e)),v(this,je).on("on fullscreen change",(t=>{t?y(this,Ye,Mi).call(this,C.FULLSCREEN,""):y(this,Ye,Ui).call(this,C.FULLSCREEN)}))},ni=function(t){w(this,Qe,new c({background:v(this,Ze),receiverApplicationId:v(this,$e),options:t.getCastOptions()})),v(this,Qe).init().then((()=>{var t,e,i;y(this,Ye,Mi).call(this,C.CAST_AVAILABLE,""),null==(t=v(this,Qe))||t.on("connected",y(this,Ye,si).bind(this)),null==(e=v(this,Qe))||e.on("resumed",y(this,Ye,si).bind(this)),null==(i=v(this,Qe))||i.on("disconnected",y(this,Ye,ri).bind(this))})).catch((t=>{v(this,Ke).warn("Failed to initialize CastSender",t)}))},si=function(){var t,e;y(this,Ye,Mi).call(this,C.IS_CASTING,"");const i=null!=(e=null==(t=v(this,Qe))?void 0:t.getReceiverName())?e:"device";y(this,Ye,Mi).call(this,C.CAST_RECEIVER_NAME,i)},ri=function(){y(this,Ye,Ui).call(this,C.IS_CASTING),y(this,Ye,Ui).call(this,C.CAST_RECEIVER_NAME)},ai=function(t){var e;null==(e=v(this,Xe))||e.unload();const i=t.getCastOptions();w(this,Xe,new te({url:i.url,channelId:i.channelId,authenticationToken:i.authenticationToken,container:this})),v(this,Xe).once("available",(()=>{y(this,Ye,Mi).call(this,C.AIRPLAY_AVAILABLE,"")})),v(this,Xe).on("connected",(()=>{y(this,Ye,Mi).call(this,C.IS_AIRPLAYING,"")})),v(this,Xe).on("disconnected",(()=>{y(this,Ye,Ui).call(this,C.IS_AIRPLAYING)}))},oi=function(t){var e;if(null==(e=v(this,qe))||e.unload(),!(0,r.i)()){if(t.audioNode)w(this,qe,new me(t.audioNode));else{if(!(t.mediaElement instanceof HTMLMediaElement))return;w(this,qe,new me(t.mediaElement))}v(this,qe).on("on decibel change",(t=>{y(this,Ye,Mi).call(this,C.VOLUME_LEVEL,JSON.stringify(t))})),y(this,Ye,Mi).call(this,C.VOLUME_LEVEL,JSON.stringify({left:null,right:null})),(!v(this,qe).isMediaElementSource||!this.hasAttribute(C.MUTED))&&v(this,qe).start()}},li=new WeakMap,hi=function(t){"mouse"!==t.pointerType&&t.timeStamp-v(this,li)<250||(y(this,Ye,wi).call(this),v(this,Ne)&&clearTimeout(v(this,Ne)),t.target instanceof HTMLElement&&([this,v(this,We)].includes(t.target)||"vindral-scroll-overlay"===t.target.localName)&&y(this,Ye,yi).call(this))},ci=function(t){const e=this.hasAttribute(C.USER_INTERACTING);"touch"===t.pointerType&&t.target instanceof HTMLElement?[this,v(this,We)].includes(t.target)&&e?y(this,Ye,bi).call(this):y(this,Ye,yi).call(this):t.composedPath().some((t=>t instanceof HTMLElement&&["vindral-play-button"].includes(null==t?void 0:t.localName)))&&y(this,Ye,yi).call(this)},di=function(t){!v(this,je)||t.target instanceof G||t.target instanceof Te||t.target instanceof Re||(this.hasAttribute(C.FULLSCREEN)?this.removeAttribute(C.FULLSCREEN):this.setAttribute(C.FULLSCREEN,""))},ui=function(t){this.hasAttribute(C.USER_INTERACTING)||y(this,Ye,yi).call(this)},mi=new WeakMap,pi=new WeakMap,gi=new WeakMap,fi=function(t){var e,i;const{metaKey:n,altKey:s,key:r}=t;if(!n&&!s&&Pe.includes(r)&&!((null==(e=t.target)?void 0:e.keysUsed)||[]).includes(r))switch(r){case"f":this.hasAttribute(C.FULLSCREEN)?this.removeAttribute(C.FULLSCREEN):this.setAttribute(C.FULLSCREEN,"");break;case"m":this.hasAttribute(C.MUTED)?this.removeAttribute(C.MUTED):this.setAttribute(C.MUTED,"");break;case"ArrowDown":null==(i=this.querySelector("vindral-scroll-overlay"))||i.setAttribute("open","")}},Ai=new WeakMap,vi=function(){return k(this,null,(function*(){if(!v(this,Oe)||!v(this,Ge))return;const t=Date.now();if(v(this,Ai)&&t-v(this,Ai)<1e4)v(this,Ke).debug("Skipping channel update, last update was less than 10 seconds ago.");else{w(this,Ai,t);const e=yield v(this,Oe).getApiClient().getChannels(v(this,Ge));y(this,Ye,Mi).call(this,C.CHANNELS,JSON.stringify(e))}w(this,Je,window.setTimeout((()=>{y(this,Ye,vi).call(this)}),1e4))}))},bi=function(){!this.hasAttribute(C.USER_INTERACTING)||this.hasAttribute(C.UI_LOCKED)||(this.dispatchEvent(new CustomEvent("user-interacting",{bubbles:!0,composed:!0,detail:{active:!1}})),this.removeAttribute(C.USER_INTERACTING))},wi=function(){this.hasAttribute(C.USER_INTERACTING)||requestAnimationFrame((()=>{this.setAttribute(C.USER_INTERACTING,""),this.dispatchEvent(new CustomEvent("user-interacting",{bubbles:!0,composed:!0,detail:{active:!0}}))}))},yi=function(){y(this,Ye,wi).call(this),v(this,Ne)&&clearTimeout(v(this,Ne)),v(this,De)&&w(this,Ne,self.setTimeout((()=>{y(this,Ye,bi).call(this)}),v(this,De)))},Si=function(){var t;y(this,Ye,xi).call(this),null==(t=v(this,He))||t.request().catch((t=>{v(this,Ke).warn("Failed to enter picture in picture:",t)}))},ki=function(){var t;null==(t=v(this,He))||t.exit().catch((t=>{v(this,Ke).warn("Failed to exit picture in picture:",t)}))},Ei=function(){var t,e;null!=(t=v(this,je))&&t.isFullscreenApiSupported()?(y(this,Ye,xi).call(this),null==(e=v(this,je))||e.request().then((()=>{v(this,Ii).call(this)})).catch((t=>{v(this,Ke).warn("Failed to enter fullscreen:",t)}))):(this.setAttribute(C.FULLSCREEN_FALLBACK,""),y(this,Ye,Mi).call(this,C.FULLSCREEN,""))},Ti=function(){var t,e;null!=(t=v(this,je))&&t.isFullscreenApiSupported()?null==(e=v(this,je))||e.exit().then((()=>{v(this,Ci).call(this)})).catch((t=>{v(this,Ke).warn("Failed to exit fullscreen:",t)})):(this.removeAttribute(C.FULLSCREEN_FALLBACK),y(this,Ye,Ui).call(this,C.FULLSCREEN))},Ii=new WeakMap,Ci=new WeakMap,xi=function(){v(this,Oe)&&v(this,Oe).emitter.emit("ios-hack: reset size")},Mi=function(t,e){var i;null==(i=v(this,_e).get(t))||i.forEach((i=>i.setAttribute(t,e)))},Ui=function(t){var e;null==(e=v(this,_e).get(t))||e.forEach((e=>e.removeAttribute(t)))},f(Ri,"observedAttributes",[...x,"url","edge-url","target-buffer-time","cast-receiver-id","cast-background","log-level","max-size","min-buffer-time","max-buffer-time","max-audio-bit-rate","burst-enabled","mse-enabled","mse-opus-enabled","ios-background-play-enabled","ios-wake-lock-enabled","ios-media-element-enabled","abr-enabled","size-based-resolution-cap-enabled","telemetry-enabled","video-codecs","poster","advanced","drm-headers","drm-queryparams","webtransport-enabled","reconnect-retries","auto-instance-enabled","language"]),b(Ri,Be,"https://lb.cdn.vindral.com");let Li=Ri;const Pi=document.createElement("template");Pi.innerHTML=`\n  <style>\n    :host {\n      display: var(--fullscreen-button-display);\n    }\n\n    :host([${C.FULLSCREEN}]) slot[name="enter"] {\n      display: none !important;\n    }\n\n    :host(:not([${C.FULLSCREEN}])) slot[name="exit"] {\n      display: none !important;\n    }\n  </style>\n\n  <slot name="icon">\n    <slot name="enter">\n  <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-maximize"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 8v-2a2 2 0 0 1 2 -2h2" /><path d="M4 16v2a2 2 0 0 0 2 2h2" /><path d="M16 4h2a2 2 0 0 1 2 2v2" /><path d="M16 20h2a2 2 0 0 0 2 -2v-2" /></svg>\n</slot>\n    <slot name="exit">\n  <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-minimize"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M15 19v-2a2 2 0 0 1 2 -2h2" /><path d="M15 5v2a2 2 0 0 0 2 2h2" /><path d="M5 15h2a2 2 0 0 1 2 2v2" /><path d="M5 9h2a2 2 0 0 0 2 -2v-2" /></svg>\n</slot>\n  </slot>\n`;const Bi=class extends G{constructor(){var t;super(),null==(t=this.shadowRoot)||t.appendChild(Pi.content.cloneNode(!0))}connectedCallback(){super.connectedCallback(),this.setAttribute("aria-label",this.isFullscreen?"Exit fullscreen":"Enter fullscreen")}disconnectedCallback(){super.disconnectedCallback()}attributeChangedCallback(t,e,i){super.attributeChangedCallback(t,e,i),t===C.FULLSCREEN&&this.setAttribute("aria-label",this.isFullscreen?"Exit fullscreen":"Enter fullscreen")}set isFullscreen(t){t?this.setAttribute(C.FULLSCREEN,""):this.removeAttribute(C.FULLSCREEN)}get isFullscreen(){return this.hasAttribute(C.FULLSCREEN)}handleClick(t){const e=this.isFullscreen?M.EXIT_FULLSCREEN:M.ENTER_FULLSCREEN;this.dispatchEvent(new CustomEvent(e,{bubbles:!0,composed:!0}))}};f(Bi,"observedAttributes",[...S(Bi,Bi,"observedAttributes"),C.FULLSCREEN]);let _i=Bi;const Di=document.createElement("template");var Ni,Wi;Di.innerHTML='\n  <style>\n    :host(:not([hidden])) {\n      display: var(--language-menu-display);\n    }\n  </style>\n\n  <slot name="button">\n    <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7" /><path d="M9 3v2c0 4.418 -2.239 8 -5 8" /><path d="M5 9c0 2.144 2.952 3.908 6.7 4" /><path d="M12 20l4 -9l4 9" /><path d="M19.1 18h-6.2" /></svg>\n</slot>\n  <slot name="listbox" hidden>\n    <vindral-language-menu-list id="listbox" part="listbox"></vindral-language-menu-list>\n  </slot>\n';const Oi=class extends Te{constructor(){var t,e,i,n;super(),b(this,Ni),null==(t=this.shadowRoot)||t.appendChild(Di.content.cloneNode(!0)),this.button=null==(e=this.shadowRoot)?void 0:e.querySelector("slot[name=button]"),this.listbox=null==(i=this.shadowRoot)?void 0:i.querySelector("[part=listbox]"),this.listboxSlot=null==(n=this.shadowRoot)?void 0:n.querySelector("slot[name=listbox]")}connectedCallback(){super.connectedCallback(),y(this,Ni,Wi).call(this),this.setAttribute("aria-label","Languages")}attributeChangedCallback(t,e,i){super.attributeChangedCallback(t,e,i),(t===C.LANGUAGES||t===C.TEXT_TRACKS)&&y(this,Ni,Wi).call(this)}};Ni=new WeakSet,Wi=function(){const t=t=>(t?JSON.parse(t):[]).length<2,e=t(this.getAttribute(C.LANGUAGES)),i=t(this.getAttribute(C.TEXT_TRACKS));e&&i?this.setAttribute("hidden",""):this.removeAttribute("hidden")},f(Oi,"observedAttributes",[...S(Oi,Oi,"observedAttributes"),C.LANGUAGES,C.TEXT_TRACKS]);let Fi=Oi;const Vi=document.createElement("template");var Gi,zi,Hi,ji,Xi,qi,Qi,$i,Zi,Ki,Ji,Yi,tn,en,nn,sn,rn,an,on,ln,hn,cn,dn,un,mn,pn;Vi.innerHTML=`\n  <style>\n    :host {\n      font: inherit;\n      cursor: default;\n      padding: var(--padding-2);\n      padding-top: var(--padding-3);\n      border-radius: 0.25em;\n      position: absolute;\n      min-width: 140px;\n      background: var(--bg-subtle);\n      z-index: 1;\n      overflow: auto;\n      display: flex;\n      flex-direction: row;\n      gap: var(--padding-3);\n    }\n\n    :host([list-position="top"]) {\n      bottom: calc(100% + 0.5em);\n      transform: translate(-50%);\n    }\n\n    :host([list-position="bottom"]) {\n      top: calc(100% + 0.5em);\n    }\n\n    :host::-webkit-scrollbar {\n      width: 5px;\n      padding-right: 5px;\n    }\n\n    :host::-webkit-scrollbar-thumb {\n      background-color: var(--fg-extra-subtle);\n      border-radius: 10px;\n      border: 0;\n    }\n\n    :host::-webkit-scrollbar-track {\n      border-radius: 10px;\n      background-color: transparent;\n    }\n\n    .menu {\n      display: grid;\n      gap: var(--padding-1);\n    }\n\n    .menu-container {\n      display: flex;\n      flex-direction: column;\n      flex: 1;\n    }\n\n    [role="menuitem"] {\n      position: relative;\n      cursor: pointer;\n      display: flex;\n      align-items: center;\n      height: 44px;\n      padding: 0 var(--padding-3);\n      padding-left: var(--padding-6);\n      border-radius: 4px;\n      font-size: 14px;\n    }\n\n    [role="menuitem"]:hover {\n      background: var(--bg-component-hover);\n    }\n\n    [role="menuitem"][aria-selected="true"] {\n      background: var(--bg-component-active);\n    }\n\n    [role="menuitem"][aria-selected="true"]::before {\n      content: url("data:image/svg+xml,${encodeURIComponent('\n  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="#fff" viewBox="0 0 78.369 78.369" xml:space="preserve"><path d="M78.049 19.015 29.458 67.606a1.094 1.094 0 0 1-1.548 0L.32 40.015a1.094 1.094 0 0 1 0-1.547l6.704-6.704a1.095 1.095 0 0 1 1.548 0l20.113 20.112 41.113-41.113a1.095 1.095 0 0 1 1.548 0l6.703 6.704a1.094 1.094 0 0 1 0 1.548z"/></svg>\n')}");\n      position: absolute;\n      left: var(--padding-3);\n      top: calc(50% - 8px);\n    }\n\n    [role="menuitem"]:focus-visible {\n      box-shadow: inset 0 0 0 2px var(--fg-strong);\n      outline: 0;\n    }\n\n    .heading {\n      text-transform: uppercase;\n      margin-bottom: var(--padding-2);\n      padding: 0 var(--padding-3);\n      font-size: 11px;\n      font-weight: bold;\n    }\n\n    :host([${C.LANGUAGES}="[]"]) #languages,\n    :host(:not([${C.LANGUAGES}])) #languages {\n      display: none;\n    }\n\n    :host([${C.TEXT_TRACKS}="[]"]) #text-tracks,\n    :host(:not([${C.TEXT_TRACKS}])) #text-tracks {\n      display: none;\n    }\n  </style>\n\n  <div id="languages" class="menu-container">\n    <div class="heading">Language</div>\n    <div class="menu"></div>\n  </div>\n  <div id="text-tracks" class="menu-container">\n    <div class="heading">Subtitles</div>\n    <div class="menu"></div>\n  </div>\n`;class gn extends HTMLElement{constructor(){super(),b(this,tn),b(this,Gi,[]),b(this,zi,[]),b(this,Hi),b(this,ji),b(this,Xi,[]),b(this,qi,[]),b(this,Qi,null),b(this,$i,null),b(this,Zi,null),b(this,Ki,null),b(this,Ji,null),b(this,Yi,null),f(this,"handleEvent",(t=>{"keydown"===t.type&&y(this,tn,cn).call(this,t)})),this.attachShadow({mode:"open"}).appendChild(Vi.content.cloneNode(!0))}connectedCallback(){var t,e,i;const n=this.getRootNode();n instanceof ShadowRoot&&(w(this,Zi,n.host.closest("vindral-controller")),null==(t=v(this,Zi))||t.connectListener(this),w(this,Qi,null==(e=this.shadowRoot)?void 0:e.querySelector("#languages .menu")),w(this,$i,null==(i=this.shadowRoot)?void 0:i.querySelector("#text-tracks .menu")),y(this,tn,en).call(this),y(this,tn,nn).call(this),w(this,Ki,n.host),this.addEventListener("keydown",this))}disconnectedCallback(){this.removeEventListener("keydown",this)}attributeChangedCallback(t,e,i){e!==i&&(t===C.LANGUAGES&&i&&(this.languages=JSON.parse(i)),t===C.TEXT_TRACKS&&i&&(this.textTracks=JSON.parse(i)),t===C.LANGUAGE&&(this.language=i),t===C.TEXT_TRACK&&(this.textTrack=i))}set languages(t){w(this,Gi,t),y(this,tn,rn).call(this),y(this,tn,on).call(this)}set textTracks(t){w(this,zi,t),y(this,tn,sn).call(this),y(this,tn,ln).call(this)}set language(t){w(this,Hi,t),y(this,tn,on).call(this)}set textTrack(t){w(this,ji,t),y(this,tn,ln).call(this)}get keysUsed(){return["Enter","Escape","Tab"," ","ArrowDown","ArrowUp","ArrowLeft","ArrowRight","Home","End"]}focus(){v(this,Ji)?v(this,Ji).focus():v(this,Yi)&&v(this,Yi).focus()}}Gi=new WeakMap,zi=new WeakMap,Hi=new WeakMap,ji=new WeakMap,Xi=new WeakMap,qi=new WeakMap,Qi=new WeakMap,$i=new WeakMap,Zi=new WeakMap,Ki=new WeakMap,Ji=new WeakMap,Yi=new WeakMap,tn=new WeakSet,en=function(){new IntersectionObserver((t=>{t.forEach((t=>{if(1!==t.intersectionRatio)if(t.intersectionRatio>0){const e=this.offsetHeight*t.intersectionRatio-24;this.style.height=`${e}px`}else this.style.height="auto"}))}),{root:v(this,Zi),threshold:0}).observe(this)},nn=function(){v(this,Qi)&&(y(this,tn,rn).call(this),y(this,tn,on).call(this)),v(this,$i)&&(y(this,tn,sn).call(this),y(this,tn,ln).call(this))},sn=function(){v(this,$i).innerHTML="",w(this,qi,[]);const t=y(this,tn,an).call(this,"Off","textTrack",void 0);v(this,$i).appendChild(t),v(this,qi).push({element:t,value:void 0}),v(this,zi).forEach((t=>{const e=y(this,tn,an).call(this,t,"textTrack",t);v(this,$i).appendChild(e),v(this,qi).push({element:e,value:t})})),y(this,tn,ln).call(this)},rn=function(){v(this,Qi).innerHTML="",w(this,Xi,[]),v(this,Gi).forEach((t=>{const e=y(this,tn,an).call(this,t,"language",t);v(this,Qi).appendChild(e),v(this,Xi).push({element:e,value:t})})),y(this,tn,on).call(this)},an=function(t,e,i){const n=document.createElement("div");return n.setAttribute("role","menuitem"),n.textContent=t,n.addEventListener("click",(()=>y(this,tn,hn).call(this,i,e))),n},on=function(){v(this,Ji)&&(v(this,Ji).removeAttribute("aria-selected"),v(this,Ji).tabIndex=-1);const t=v(this,Xi).find((t=>t.value===v(this,Hi)));t&&(t.element.setAttribute("aria-selected","true"),t.element.tabIndex=0,w(this,Ji,t.element))},ln=function(){v(this,Yi)&&(v(this,Yi).removeAttribute("aria-selected"),v(this,Yi).tabIndex=-1);const t=v(this,qi).find((t=>t.value===v(this,ji)));if(t)t.element.setAttribute("aria-selected","true"),t.element.tabIndex=0,w(this,Yi,t.element);else{const t=v(this,qi).find((t=>void 0===t.value));t&&(t.element.setAttribute("aria-selected","true"),t.element.tabIndex=0,w(this,Yi,t.element))}},hn=function(t,e){this.dispatchEvent(new Event("change",{bubbles:!0,composed:!0}));const i="language"===e?M.SET_LANGUAGE:M.SET_TEXT_TRACK;this.dispatchEvent(new CustomEvent(i,{bubbles:!0,composed:!0,detail:t}))},cn=function(t){var e,i,n;const{key:s,ctrlKey:r,altKey:a,metaKey:o}=t;r||a||o||this.keysUsed.includes(s)&&(t.preventDefault(),t.stopPropagation(),"Tab"===s||"Escape"===s?null==(e=v(this,Ki))||e.hide():"Enter"===s||" "===s?null==(n=null==(i=y(this,tn,mn).call(this))?void 0:i.element)||n.click():y(this,tn,dn).call(this,t))},dn=function(t){var e;const{key:i}=t,n=[...v(this,Xi),...v(this,qi)],s=null!=(e=y(this,tn,mn).call(this))?e:n[0];if(!s)return;const r=n.indexOf(s);let a=Math.max(0,r);"ArrowDown"===i?a++:"ArrowUp"===i?a--:"ArrowLeft"===i?a=y(this,tn,un).call(this,r,"left"):"ArrowRight"===i?a=y(this,tn,un).call(this,r,"right"):"Home"===t.key?a=0:"End"===t.key&&(a=n.length-1),a<0&&(a=n.length-1),a>n.length-1&&(a=0);const o=n[a];o&&(y(this,tn,pn).call(this,o.value),o.element.focus())},un=function(t,e){const i=v(this,Xi).length,n=v(this,qi).length;return"left"===e?t<i?i+n-1:t-i-1:t>=i?0:t+i},mn=function(){return[...v(this,Xi),...v(this,qi)].find((t=>0===t.element.tabIndex))},pn=function(t){for(const e of[...v(this,Xi),...v(this,qi)])e.element.tabIndex=e.value===t?0:-1},f(gn,"observedAttributes",[C.LANGUAGES,C.TEXT_TRACKS,C.LANGUAGE,C.TEXT_TRACK]);const fn=document.createElement("template");fn.innerHTML=`\n  <style>\n    :host {\n      display: var(--mute-button-display);\n    }\n\n    :host([${C.MUTED}]) slot[name="unmute"] {\n      display: none !important;\n    }\n\n    :host(:not([${C.MUTED}])) slot[name="mute"] {\n      display: none !important;\n    }\n  </style>\n\n  <slot name="icon">\n    <slot name="mute">\n<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  <g fill="none" stroke="currentColor">\n<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd" />\n<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />\n</g></svg>\n</slot>\n    <slot name="unmute">\n  <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  <g fill="none" stroke="currentColor">\n  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>\n</slot>\n  </slot>\n`;const An=class extends G{constructor(){var t;super(),null==(t=this.shadowRoot)||t.appendChild(fn.content.cloneNode(!0))}connectedCallback(){super.connectedCallback(),this.setAttribute("aria-label",this.muted?"UnMute":"Mute")}disconnectedCallback(){super.disconnectedCallback()}attributeChangedCallback(t,e,i){super.attributeChangedCallback(t,e,i),t===C.MUTED&&this.setAttribute("aria-label",this.muted?"UnMute":"Mute")}set muted(t){t?this.setAttribute(C.MUTED,""):this.removeAttribute(C.MUTED)}get muted(){return this.hasAttribute(C.MUTED)}handleClick(t){const e=this.muted?M.UNMUTE:M.MUTE;this.dispatchEvent(new CustomEvent(e,{bubbles:!0,composed:!0}))}};f(An,"observedAttributes",[...S(An,An,"observedAttributes"),C.MUTED]);let vn=An;const bn=document.createElement("template");bn.innerHTML=`\n  <style>\n    :host {\n      display: var(--pip-button-display);\n    }\n\n    :host(:not([${C.PIP_AVAILABLE}])) {\n      display: none !important;\n    }\n  </style>\n  <slot name="icon">\n    <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="currentColor"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M19 4a3 3 0 0 1 3 3v4a1 1 0 0 1 -2 0v-4a1 1 0 0 0 -1 -1h-14a1 1 0 0 0 -1 1v10a1 1 0 0 0 1 1h6a1 1 0 0 1 0 2h-6a3 3 0 0 1 -3 -3v-10a3 3 0 0 1 3 -3z" /><path d="M20 13a2 2 0 0 1 2 2v3a2 2 0 0 1 -2 2h-5a2 2 0 0 1 -2 -2v-3a2 2 0 0 1 2 -2z" /></svg>\n</slot>\n`;const wn=class extends G{constructor(){var t;super(),null==(t=this.shadowRoot)||t.appendChild(bn.content.cloneNode(!0))}connectedCallback(){super.connectedCallback(),this.setAttribute("aria-label",this.isPictureInPictureActive?"Exit picture in picture":"Enter picture in picture")}disconnectedCallback(){super.disconnectedCallback()}attributeChangedCallback(t,e,i){super.attributeChangedCallback(t,e,i),t===C.IS_PIP&&this.setAttribute("aria-label",this.isPictureInPictureActive?"Exit picture in picture":"Enter picture in picture")}set isPictureInPictureActive(t){t?this.setAttribute(C.IS_PIP,""):this.removeAttribute(C.IS_PIP)}get isPictureInPictureActive(){return this.hasAttribute(C.IS_PIP)}handleClick(t){const e=this.isPictureInPictureActive?M.EXIT_PIP:M.ENTER_PIP;this.dispatchEvent(new CustomEvent(e,{bubbles:!0,composed:!0}))}};f(wn,"observedAttributes",[...S(wn,wn,"observedAttributes"),C.IS_PIP,C.PIP_AVAILABLE]);let yn=wn;const Sn=document.createElement("template");Sn.innerHTML=`\n  <style>\n    :host {\n      display: var(--play-button-display);\n    }\n\n    :host([${C.PAUSED}]) slot[name="pause"] {\n      display: none !important;\n    }\n\n    :host(:not([${C.PAUSED}])) slot[name="play"] {\n      display: none !important;\n    }\n  </style>\n\n  <slot name="icon">\n    <slot name="play">\n  <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="currentColor"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 4v16a1 1 0 0 0 1.524 .852l13 -8a1 1 0 0 0 0 -1.704l-13 -8a1 1 0 0 0 -1.524 .852z" /></svg>\n</slot>\n    <slot name="pause">\n  <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="currentColor"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 4h-2a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h2a2 2 0 0 0 2 -2v-12a2 2 0 0 0 -2 -2z" /><path d="M17 4h-2a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h2a2 2 0 0 0 2 -2v-12a2 2 0 0 0 -2 -2z" /></svg>\n</slot>\n  </slot>\n`;const kn=class extends G{constructor(){var t;super(),null==(t=this.shadowRoot)||t.appendChild(Sn.content.cloneNode(!0))}connectedCallback(){super.connectedCallback(),this.setAttribute("aria-label",this.paused?"Play":"Pause")}disconnectedCallback(){super.disconnectedCallback()}attributeChangedCallback(t,e,i){super.attributeChangedCallback(t,e,i),t===C.PAUSED&&this.setAttribute("aria-label",this.paused?"Play":"Pause")}set paused(t){t?this.setAttribute(C.PAUSED,""):this.removeAttribute(C.PAUSED)}get paused(){return this.hasAttribute(C.PAUSED)}handleClick(t){const e=this.paused?M.PLAY:M.PAUSE;this.dispatchEvent(new CustomEvent(e,{bubbles:!0,composed:!0}))}};f(kn,"observedAttributes",[...S(kn,kn,"observedAttributes"),C.PAUSED]);let En=kn;const Tn={TITLE:"title",OFFLINE:"offline",REFRESH_POSTER_ENABLED:"refresh-poster-enabled",STREAM_POLL_ENABLED:"stream-poll-enabled"},In=Object.values(Tn);var Cn,xn,Mn,Un,Rn,Ln,Pn,Bn,_n,Dn,Nn,Wn;class On extends a.E{constructor(t){super(),b(this,Bn),b(this,Cn),b(this,xn),b(this,Mn,!1),b(this,Un,!1),b(this,Rn,!0),b(this,Ln,null),b(this,Pn,null),w(this,xn,t),w(this,Cn,new d.A({publicEndpoint:t.url,tokenFactory:()=>t.authenticationToken}))}start(t=5e3){v(this,Pn)&&clearInterval(v(this,Pn)),w(this,Mn,!1),w(this,Un,!1),y(this,Bn,Wn).call(this),y(this,Bn,_n).call(this),w(this,Pn,window.setInterval((()=>{!v(this,Un)&&!v(this,xn).infiniteReconnect&&!v(this,Ln)&&v(this,Rn)&&w(this,Ln,window.setTimeout((()=>y(this,Bn,Dn).call(this)),3e5)),!v(this,Un)&&v(this,Rn)&&y(this,Bn,_n).call(this)}),t))}stop(){y(this,Bn,Nn).call(this),v(this,Pn)&&(window.clearInterval(v(this,Pn)),w(this,Pn,null))}}Cn=new WeakMap,xn=new WeakMap,Mn=new WeakMap,Un=new WeakMap,Rn=new WeakMap,Ln=new WeakMap,Pn=new WeakMap,Bn=new WeakSet,_n=function(){return k(this,null,(function*(){if(v(this,Mn))return;w(this,Mn,!0);let t="Stream is offline",e="Please stand by";try{const t=yield v(this,Cn).getChannel(v(this,xn).channelId);if(t.isLive)return w(this,Un,!0),y(this,Bn,Wn).call(this),this.emit("live",t),void w(this,Mn,!1)}catch(i){(0,d.d)(i)&&(403===i.status||401===i.status)&&(t="Forbidden",e="You do not have permission to view this stream")}v(this,Rn)&&this.emit("error",{title:t,message:e}),w(this,Mn,!1)}))},Dn=function(){this.stop(),w(this,Rn,!1),this.emit("timeout")},Nn=function(){v(this,Ln)&&(window.clearTimeout(v(this,Ln)),w(this,Ln,null))},Wn=function(){y(this,Bn,Nn).call(this),w(this,Rn,!0)};const Fn=new RegExp("/Mobile|iP(hone|od|ad)|Android|BlackBerry|IEMobile|Kindle|NetFront|Silk-Accelerated|(hpw|web)OS|Fennec|Minimo|Opera M(obi|ini)|Blazer|Dolfin|Dolphin|Skyfire|Zune/","i"),Vn=navigator.userAgent.toLowerCase(),Gn=`\n  <style>\n    :host {\n      container-type: inline-size;\n      position: relative;\n      overflow: hidden;\n      width: 100%;\n      display: flex;\n      justify-content: center;\n\n      --vindral-volume-range-display: ${Fn.test(Vn)?"none":"flex"};\n      --vindral-airplay-button-display: none;\n      --vindral-play-overlay-display: none;\n      --vindral-grid-item-offline-display: none;\n    }\n\n    vindral-control-bar[slot="top-bar"] {\n      display: none;\n    }\n\n    @container (max-width: 320px) {\n      vindral-controller {\n        --vindral-volume-range-display: none;\n        --vindral-control-padding: 0px;\n        --vindral-button-padding: 4px;\n        --vindral-play-overlay-icon-size: 40px;\n      }\n\n      vindral-control-bar[slot="top-bar"] {\n        display: block;\n      }\n\n      vindral-control-bar:not([slot="top-bar"]) vindral-rendition-levels-menu,\n      vindral-control-bar:not([slot="top-bar"]) vindral-cast-button,\n      vindral-control-bar:not([slot="top-bar"]) vindral-airplay-button {\n        display: none;\n      }\n    }\n\n    :host([${Tn.OFFLINE}]) {\n      aspect-ratio: 16 / 9;\n      vindral-controller {\n        --vindral-ui-display: none;\n        --vindral-play-overlay-display: none;\n      }\n    }\n\n    :host([${C.AIRPLAY_ENABLED}="false"]) {\n      --vindral-airplay-button-display: none;\n    }\n\n    :host([${C.CAST_ENABLED}="false"]) {\n      --vindral-cast-button-display: none;\n    }\n\n    :host([${C.FULLSCREEN_ENABLED}="false"]) {\n      --vindral-fullscreen-button-display: none;\n    }\n\n    :host([${C.PIP_ENABLED}="false"]) {\n      --vindral-pip-button-display: none;\n    }\n\n    :host(:not([${C.CHANNEL_GROUP_ID}])) vindral-scroll-overlay {\n      display: none;\n    }\n\n    :host([${C.MEDIA}="video"]) vindral-mute-button,\n    :host([${C.MEDIA}="video"]) vindral-volume-range {\n      display: none;\n    }\n  </style>\n`,zn=`\n  ${Gn}\n\n  <vindral-controller>\n    <vindral-control-bar slot="top-bar">\n      <vindral-rendition-levels-menu list-position="bottom"></vindral-rendition-levels-menu>\n      <vindral-cast-button></vindral-cast-button>\n      <vindral-airplay-button></vindral-airplay-button>\n    </vindral-control-bar>\n    <vindral-control-bar>\n      <vindral-play-button></vindral-play-button>\n      <vindral-mute-button></vindral-mute-button>\n      <vindral-volume-range></vindral-volume-range>\n      <vindral-channel-grid-button slot="right"></vindral-channel-grid-button>\n      <vindral-language-menu slot="right"></vindral-language-menu>\n      <vindral-rendition-levels-menu slot="right"></vindral-rendition-levels-menu>\n      <vindral-pip-button slot="right"></vindral-pip-button>\n      <vindral-cast-button slot="right"></vindral-cast-button>\n      <vindral-airplay-button slot="right"></vindral-airplay-button>\n      <vindral-fullscreen-button slot="right"></vindral-fullscreen-button>\n    </vindral-control-bar>\n    <vindral-scroll-overlay slot="overlay">\n      <vindral-channel-grid id="listbox" part="listbox"></vindral-channel-grid>\n    </vindral-scroll-overlay>\n    <vindral-cast-overlay slot="overlay"></vindral-cast-overlay>\n    <vindral-buffering-overlay slot="overlay"></vindral-buffering-overlay>\n    <vindral-user-input-play-overlay slot="overlay"></vindral-user-input-play-overlay>\n    <vindral-poster-overlay slot="overlay" disabled></vindral-poster-overlay>\n\n    <vindral-play-overlay id="play-overlay" slot="overlay" hidden></vindral-play-overlay>\n    <vindral-message id="vindral-message" slot="overlay" hidden></vindral-message>\n  </vindral-controller>\n`,Hn=`\n  ${Gn}\n\n  <style>\n    #control-bar {\n      display: flex;\n      justify-content: center;\n      align-items: center;\n      gap: var(--padding-3);\n    }\n  </style>\n\n  <vindral-controller>\n    <div id="control-bar" slot="middle">\n      <vindral-play-button></vindral-play-button>\n      <vindral-mute-button></vindral-mute-button>\n      <vindral-volume-range></vindral-volume-range>\n      <vindral-buffering-icon></vindral-buffering-icon>\n    </div>\n\n    <vindral-play-overlay id="play-overlay" slot="overlay" hidden></vindral-play-overlay>\n    <vindral-message id="vindral-message" slot="overlay" hidden></vindral-message>\n  </vindral-controller>\n`,jn=document.createElement("template");var Xn,qn,Qn,$n,Zn,Kn,Jn,Yn,ts,es,is,ns,ss,rs;class as extends HTMLElement{constructor(){super(),b(this,ts),b(this,Xn),b(this,qn),b(this,Qn),b(this,$n),b(this,Zn),b(this,Kn,(()=>{Array.from(this.attributes).forEach((t=>{v(this,Jn).call(this,t.name,t.value)}))})),b(this,Jn,((t,e)=>{var i;i=t,Li.observedAttributes.includes(i)&&(B(e)?v(this,qn).setAttribute(t,e):v(this,qn).removeAttribute(t))})),b(this,Yn,(()=>"audio"===U(this.getAttribute(C.MEDIA))?Hn:zn)),b(this,ns,(()=>{const t=v(this,qn).instance;t&&(t.on("is live",(t=>{t?(this.removeAttribute(Tn.OFFLINE),v(this,Qn).setAttribute("hidden","")):(this.setAttribute(Tn.OFFLINE,""),v(this,Qn).removeAttribute("hidden"),y(this,ts,rs).call(this,"Stream is offline","Please stand by"))})),t.on("channels",(t=>{const e=v(this,qn).getAttribute("channel-id"),i=t.find((t=>t.channelId===e));i&&y(this,ts,ss).call(this,i.name)})),t.on("channel switch",(({channelId:e})=>{const i=t.channels.find((t=>t.channelId===e));i&&y(this,ts,ss).call(this,i.name)})),t.on("error",(t=>{let e="Stream is offline",i="Please stand by";t.isFatal()?(t.code()===r.A?(e="Forbidden",i="You do not have permission to view this stream",y(this,ts,rs).call(this,e,i)):y(this,ts,rs).call(this,"An error occurred",t.message),v(this,$n).removeAttribute("hidden"),this.setAttribute(Tn.OFFLINE,"")):t.code()===r.C&&y(this,ts,rs).call(this,e,i)})))})),w(this,Xn,this.attachShadow({mode:"open"})),y(this,ts,es).call(this),w(this,qn,v(this,Xn).querySelector("vindral-controller")),w(this,Qn,v(this,Xn).querySelector("#vindral-message")),w(this,$n,v(this,Xn).querySelector("#play-overlay"))}connectedCallback(){this.setAttribute(Tn.OFFLINE,""),v(this,qn).addEventListener("vindral-instance-ready",v(this,ns)),y(this,ts,is).call(this)}disconnectedCallback(){var t;v(this,qn).removeEventListener("vindral-instance-ready",v(this,ns)),null==(t=v(this,Zn))||t.stop()}attributeChangedCallback(t,e,i){if(e!==i)if(t===C.MEDIA)y(this,ts,es).call(this);else if(t===Tn.REFRESH_POSTER_ENABLED){const t=v(this,Xn).querySelector("vindral-poster-overlay");t&&(t.disabled=!1===_(this.getAttribute(Tn.REFRESH_POSTER_ENABLED),!1))}else v(this,Jn).call(this,t,i)}get instance(){return v(this,qn).instance}get airPlay(){return v(this,qn).airPlay}}Xn=new WeakMap,qn=new WeakMap,Qn=new WeakMap,$n=new WeakMap,Zn=new WeakMap,Kn=new WeakMap,Jn=new WeakMap,Yn=new WeakMap,ts=new WeakSet,es=function(){jn.innerHTML=v(this,Yn).call(this);const t=jn.content.cloneNode(!0);w(this,qn,t.querySelector("vindral-controller")),w(this,Qn,t.querySelector("#vindral-message")),w(this,$n,t.querySelector("#play-overlay")),this.children.length>0&&Array.from(this.children).forEach((t=>{v(this,qn).appendChild(t)})),v(this,Kn).call(this),v(this,Xn).innerHTML="",v(this,Xn).appendChild(t)},is=function(){var t;if(!1===_(this.getAttribute(Tn.STREAM_POLL_ENABLED),!0))return;const e=this.getAttribute("url"),i=this.getAttribute("channel-id"),n=null!=(t=this.getAttribute("authentication-token"))?t:void 0,s=this.hasAttribute("infinite-reconnect"),r=_(this.getAttribute("title"),!1);if(!e||!i)return this.setAttribute(Tn.OFFLINE,""),void y(this,ts,rs).call(this,"Invalid options","Please enter at least a channel id and url to start the stream");w(this,Zn,new On({url:e,channelId:i,authenticationToken:n,infiniteReconnect:s})),v(this,Zn).on("live",(t=>{v(this,qn).connect(),this.removeAttribute("offline"),v(this,Qn).setAttribute("hidden",""),r&&y(this,ts,ss).call(this,t.name)})),v(this,Zn).on("timeout",(()=>{v(this,Qn).setAttribute("hidden",""),v(this,$n).removeAttribute("hidden")})),v(this,Zn).on("error",(t=>{this.setAttribute(Tn.OFFLINE,""),y(this,ts,rs).call(this,t.title,t.message)})),v(this,$n).addEventListener("click",(()=>{v(this,qn).connect(),v(this,$n).setAttribute("hidden",""),v(this,Qn).setAttribute("hidden",""),v(this,qn).focus()})),this.hasAttribute("paused")&&v(this,Zn).start()},ns=new WeakMap,ss=function(t){if(!_(this.getAttribute("title"),!0))return;const e=L(this.getAttribute("poster"));(({title:t,subTitle:e="Live stream",poster:i})=>{document.title=t,"mediaSession"in navigator&&(navigator.mediaSession.metadata=new MediaMetadata({title:t,artist:e,artwork:i?[{src:i}]:[]}))})({title:t,poster:"string"==typeof e?e:void 0})},rs=function(t,e){v(this,Qn).setAttribute("title",t),v(this,Qn).setAttribute("description",e);const i=this.getAttribute("poster");i&&v(this,Qn).setAttribute("background-image",i),v(this,Qn).removeAttribute("hidden")},f(as,"observedAttributes",[...Li.observedAttributes,...In]);const os=document.createElement("template");var ls,hs,cs,ds,us,ms,ps,gs,fs;os.innerHTML=`\n  <style>\n    :host {\n      display: var(--poster-overlay-display);\n      position: absolute;\n      top: 0;\n      left: 0;\n      max-width: 100%;\n      max-height: 100%;\n      min-width: 100%;\n      min-height: 100%;\n      background-repeat: no-repeat;\n      background-position: 50% 50%;\n      background-size: contain;\n      transition-property: background-image;\n      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);\n      transition-duration: 200ms;\n    }\n\n    :host::before {\n      content: "";\n      position: absolute;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      background: rgba(255, 255, 255, 0);\n      transition: background 0.2s ease;\n    }\n\n    :host(:not([${C.PAUSED}])) {\n      display: none;\n    }\n  </style>\n`;class As extends HTMLElement{constructor(){super(),b(this,us),b(this,ls,null),b(this,hs,null),b(this,cs,null),b(this,ds,(()=>{!document.hidden&&this.hasAttribute("intersecting")&&this.paused&&!this.disabled?y(this,us,ms).call(this):y(this,us,ps).call(this)})),b(this,fs,(t=>{t.forEach((t=>{t.isIntersecting?this.setAttribute("intersecting",""):this.removeAttribute("intersecting")}))})),this.attachShadow({mode:"open"}).appendChild(os.content.cloneNode(!0))}connectedCallback(){var t;w(this,ls,this.closest("vindral-controller")),null==(t=v(this,ls))||t.connectListener(this),document.addEventListener("visibilitychange",v(this,ds)),w(this,cs,new IntersectionObserver(v(this,fs))),v(this,cs).observe(this)}disconnectedCallback(){var t,e;null==(t=v(this,ls))||t.disconnectListener(this),document.removeEventListener("visibilitychange",v(this,ds)),null==(e=v(this,cs))||e.disconnect(),w(this,cs,null),y(this,us,ps).call(this)}attributeChangedCallback(t,e,i){e!==i&&(t===C.POSTER_SRC&&this.paused&&!this.disabled&&y(this,us,gs).call(this),(t===C.PAUSED||"disabled"===t||"intersecting"===t)&&v(this,ds).call(this))}get disabled(){return this.hasAttribute("disabled")}set disabled(t){t?this.setAttribute("disabled",""):this.removeAttribute("disabled")}get posterSrc(){return this.getAttribute(C.POSTER_SRC)}get paused(){return this.hasAttribute(C.PAUSED)}}ls=new WeakMap,hs=new WeakMap,cs=new WeakMap,ds=new WeakMap,us=new WeakSet,ms=function(){null===v(this,hs)&&(y(this,us,ps).call(this),w(this,hs,window.setInterval((()=>y(this,us,gs).call(this)),6e3)))},ps=function(){null!==v(this,hs)&&(clearInterval(v(this,hs)),w(this,hs,null)),this.style.backgroundImage="url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAJCAQAAACRI2S5AAAAEElEQVR42mNkIAAYRxWAAQAG9gAKqv6+AwAAAABJRU5ErkJggg==')"},gs=function(){if(!this.posterSrc)return;const t=new URL(this.posterSrc),e=new Image;t.searchParams.set("t",Date.now().toString()),e.src=t.toString(),e.onload=()=>this.style.backgroundImage=`url(${t.toString()})`},fs=new WeakMap,f(As,"observedAttributes",[C.POSTER_SRC,C.PAUSED,"disabled","intersecting"]);const vs=document.createElement("template");var bs,ws;vs.innerHTML='\n  <style>\n    :host {\n      display: var(--rendition-menu-display);\n    }\n  </style>\n\n  <slot name="button">\n<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-settings-filled" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round">\n  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>\n  <path d="M14.647 4.081a.724 .724 0 0 0 1.08 .448c2.439 -1.485 5.23 1.305 3.745 3.744a.724 .724 0 0 0 .447 1.08c2.775 .673 2.775 4.62 0 5.294a.724 .724 0 0 0 -.448 1.08c1.485 2.439 -1.305 5.23 -3.744 3.745a.724 .724 0 0 0 -1.08 .447c-.673 2.775 -4.62 2.775 -5.294 0a.724 .724 0 0 0 -1.08 -.448c-2.439 1.485 -5.23 -1.305 -3.745 -3.744a.724 .724 0 0 0 -.447 -1.08c-2.775 -.673 -2.775 -4.62 0 -5.294a.724 .724 0 0 0 .448 -1.08c-1.485 -2.439 1.305 -5.23 3.744 -3.745a.722 .722 0 0 0 1.08 -.447c.673 -2.775 4.62 -2.775 5.294 0zm-2.647 4.919a3 3 0 1 0 0 6a3 3 0 0 0 0 -6z" stroke-width="0" fill="currentColor" />\n</svg>\n</slot>\n  <slot name="listbox" hidden>\n    <vindral-rendition-levels-menu-list id="listbox" part="listbox"></vindral-rendition-levels-menu-list>\n  </slot>\n';const ys=class extends Te{constructor(){var t,e,i,n;super(),b(this,bs),null==(t=this.shadowRoot)||t.appendChild(vs.content.cloneNode(!0)),this.button=null==(e=this.shadowRoot)?void 0:e.querySelector("slot[name=button]"),this.listbox=null==(i=this.shadowRoot)?void 0:i.querySelector("[part=listbox]"),this.listboxSlot=null==(n=this.shadowRoot)?void 0:n.querySelector("slot[name=listbox]")}connectedCallback(){super.connectedCallback(),y(this,bs,ws).call(this),this.setAttribute("aria-label","Rendition levels")}attributeChangedCallback(t,e,i){super.attributeChangedCallback(t,e,i),t===C.RENDITION_LEVELS&&y(this,bs,ws).call(this)}};bs=new WeakSet,ws=function(){const t=this.getAttribute(C.RENDITION_LEVELS);t&&"[]"!==t?this.removeAttribute("disabled"):this.setAttribute("disabled","")},f(ys,"observedAttributes",[...S(ys,ys,"observedAttributes"),C.RENDITION_LEVELS]);let Ss=ys;const ks=document.createElement("template");var Es,Ts,Is,Cs,xs,Ms,Us,Rs,Ls,Ps,Bs,_s,Ds,Ns,Ws,Os;ks.innerHTML=`\n  <style>\n    :host {\n      font: inherit;\n      cursor: default;\n      padding: var(--padding-2);\n      padding-top: var(--padding-3);\n      border-radius: 0.25em;\n      position: absolute;\n      min-width: 140px;\n      background: var(--bg-subtle);\n      z-index: 1;\n      overflow: auto;\n    }\n\n    :host([list-position="top"]) {\n      bottom: calc(100% + 0.5em);\n      transform: translate(-50%);\n    }\n\n    :host([list-position="bottom"]) {\n      top: calc(100% + 0.5em);\n    }\n\n    :host::-webkit-scrollbar {\n      width: 5px;\n      padding-right: 5px;\n    }\n\n    :host::-webkit-scrollbar-thumb {\n      background-color: var(--fg-extra-subtle);\n      border-radius: 10px;\n      border: 0;\n    }\n\n    :host::-webkit-scrollbar-track {\n      border-radius: 10px;\n      background-color: transparent;\n    }\n\n    .menu {\n      display: grid;\n      gap: var(--padding-1);\n    }\n\n    [role="menuitem"] {\n      flex: 1;\n      position: relative;\n      cursor: pointer;\n      display: flex;\n      flex-direction: column;\n      justify-content: center;\n      height: 44px;\n      padding: 0 var(--padding-5);\n      border-radius: 4px;\n      font-size: 14px;\n      font-style: normal;\n      font-weight: 500;\n      line-height: normal;\n      white-space: nowrap;\n      text-align: left;\n    }\n\n    [role="menuitem"]:hover {\n      background: var(--bg-component-hover);\n    }\n\n    [role="menuitem"][aria-selected="true"] {\n      background: var(--bg-component-active);\n    }\n\n    [role="menuitem"][aria-selected="true"]::before {\n      content: url("data:image/svg+xml,${encodeURIComponent('\n  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="#fff" viewBox="0 0 78.369 78.369" xml:space="preserve"><path d="M78.049 19.015 29.458 67.606a1.094 1.094 0 0 1-1.548 0L.32 40.015a1.094 1.094 0 0 1 0-1.547l6.704-6.704a1.095 1.095 0 0 1 1.548 0l20.113 20.112 41.113-41.113a1.095 1.095 0 0 1 1.548 0l6.703 6.704a1.094 1.094 0 0 1 0 1.548z"/></svg>\n')}");\n      position: absolute;\n      left: calc(var(--padding-3) - var(--padding-1));\n      top: calc(50% - 8px);\n    }\n\n    [role="menuitem"]:focus-visible {\n      box-shadow: inset 0 0 0 2px var(--fg-strong);\n      outline: 0;\n    }\n\n    .menu-item-subtitle {\n      font-size: 11px;\n      opacity: 0.6;\n    }\n\n    .heading {\n      text-transform: uppercase;\n      margin-bottom: var(--padding-2);\n      padding: 0 var(--padding-3);\n      font-size: 11px;\n      font-weight: bold;\n    }\n  </style>\n\n  <slot>\n    <div class="heading">Max quality</div>\n    <div class="menu"></div>\n  </slot>\n`;class Fs extends HTMLElement{constructor(){super(),b(this,Us),b(this,Es,[]),b(this,Ts,Number.MAX_SAFE_INTEGER),b(this,Is,null),b(this,Cs,[]),b(this,xs,null),b(this,Ms,null),f(this,"handleEvent",(t=>{"keydown"===t.type&&y(this,Us,Ds).call(this,t)})),this.attachShadow({mode:"open"}).appendChild(ks.content.cloneNode(!0))}connectedCallback(){var t;const e=this.getRootNode();e instanceof ShadowRoot&&(w(this,xs,e.host.closest("vindral-controller")),null==(t=v(this,xs))||t.connectListener(this),y(this,Us,Rs).call(this),y(this,Us,Ls).call(this),w(this,Ms,e.host),this.addEventListener("keydown",this))}disconnectedCallback(){var t;null==(t=v(this,xs))||t.disconnectListener(this),this.removeEventListener("keydown",this)}attributeChangedCallback(t,e,i){e!==i&&(t===C.RENDITION_LEVELS&&i&&(this.list=JSON.parse(i)),t===C.MAX_VIDEO_BITRATE&&i&&(this.maxVideoBitrate=i?parseInt(i):Number.MAX_SAFE_INTEGER))}set list(t){w(this,Es,t),y(this,Us,Ls).call(this)}set maxVideoBitrate(t){w(this,Ts,t),y(this,Us,Bs).call(this)}get keysUsed(){return["Enter","Escape","Tab"," ","ArrowDown","ArrowUp","Home","End"]}focus(){var t;null==(t=v(this,Is))||t.focus()}}Es=new WeakMap,Ts=new WeakMap,Is=new WeakMap,Cs=new WeakMap,xs=new WeakMap,Ms=new WeakMap,Us=new WeakSet,Rs=function(){new IntersectionObserver((t=>{t.forEach((t=>{if(1!==t.intersectionRatio)if(t.intersectionRatio>0){const e=this.offsetHeight*t.intersectionRatio-24;this.style.height=`${e}px`}else this.style.height="auto"}))}),{root:v(this,xs),threshold:0}).observe(this)},Ls=function(){var t;const e=null==(t=this.shadowRoot)?void 0:t.querySelector(".menu");e&&(w(this,Cs,[]),e.innerHTML="",v(this,Es).sort(((t,e)=>{var i,n;return null!=(i=t.video)&&i.bitRate&&null!=(n=e.video)&&n.bitRate?e.video.bitRate-t.video.bitRate:0})).forEach((t=>{var i,n,s,r,a,o,l,h;const c=document.createElement("div");c.setAttribute("role","menuitem"),c.setAttribute("value",String(null==(i=t.video)?void 0:i.height)),c.classList.add("menu-item"),c.tabIndex=-1;const d=y(this,Us,Ps).call(this,null==(n=t.video)?void 0:n.frameRate);c.textContent=t.video?(({width:t,height:e})=>`${t}x${e}`)(t.video):"";const u=document.createElement("span");u.classList.add("menu-item-subtitle"),u.textContent=`${((t,e=1)=>t>=T?`${I(t,T,e)} Gbit/s`:t>=E?`${I(t,E,e)} Mbit/s`:t>=1e3?`${I(t,1e3,e)} Kbit/s`:`${t} bit/s`)((null!=(r=null==(s=t.video)?void 0:s.bitRate)?r:0)+(null!=(o=null==(a=t.audio)?void 0:a.bitRate)?o:0))}, ${d}p`,c.appendChild(u),c.addEventListener("click",(()=>y(this,Us,_s).call(this,t))),v(this,Cs).push({el:c,id:null!=(h=null==(l=t.video)?void 0:l.id)?h:-1}),e.appendChild(c)})),y(this,Us,Bs).call(this))},Ps=function(t){return t?t[0]%t[1]==0?(t[0]/t[1]).toString():(t[0]/t[1]).toFixed(2):""},Bs=function(){v(this,Is)&&(v(this,Is).removeAttribute("aria-selected"),v(this,Is).tabIndex=-1);const t=v(this,Es).sort(((t,e)=>{var i,n;return null!=(i=t.video)&&i.bitRate&&null!=(n=e.video)&&n.bitRate?e.video.bitRate-t.video.bitRate:0})),e=v(this,Es).filter((t=>{var e;return(null==(e=t.video)?void 0:e.bitRate)&&t.video.bitRate<=v(this,Ts)}))[0]||t[t.length-1];if(e){const t=v(this,Cs).find((t=>{var i;return t.id===(null==(i=e.video)?void 0:i.id)}));t&&(t.el.tabIndex=0,t.el.setAttribute("aria-selected","true"),w(this,Is,t.el))}},_s=function(t){this.dispatchEvent(new Event("change",{bubbles:!0,composed:!0})),this.dispatchEvent(new CustomEvent(M.SET_RENDITION,{bubbles:!0,composed:!0,detail:t}))},Ds=function(t){var e,i,n;const{key:s,ctrlKey:r,altKey:a,metaKey:o}=t;r||a||o||this.keysUsed.includes(s)&&(t.preventDefault(),t.stopPropagation(),"Tab"===s||"Escape"===s?null==(e=v(this,Ms))||e.hide():"Enter"===s||" "===s?null==(n=null==(i=y(this,Us,Ws).call(this))?void 0:i.el)||n.click():y(this,Us,Ns).call(this,t))},Ns=function(t){var e;const{key:i}=t,n=v(this,Cs),s=null!=(e=y(this,Us,Ws).call(this))?e:n[0];if(!s)return;const r=n.indexOf(s);let a=Math.max(0,r);"ArrowDown"===i?a++:"ArrowUp"===i?a--:"Home"===t.key?a=0:"End"===t.key&&(a=n.length-1),a<0&&(a=n.length-1),a>n.length-1&&(a=0);const o=n[a];o&&(y(this,Us,Os).call(this,o.id),o.el.focus())},Ws=function(){return v(this,Cs).find((t=>0===t.el.tabIndex))},Os=function(t){for(const e of v(this,Cs))e.el.tabIndex=e.id===t?0:-1},f(Fs,"observedAttributes",[C.RENDITION_LEVELS,C.MAX_VIDEO_BITRATE]);const Vs=document.createElement("template");var Gs,zs,Hs,js,Xs,qs,Qs,$s,Zs,Ks,Js,Ys,tr,er,ir;Vs.innerHTML=`\n  <style>\n    :host {\n      --scroll-overlay-offset: var(--vindral-scroll-overlay-offset, 0px);\n\n      position: absolute;\n      top: 0;\n      width: 100%;\n      height: 100%;\n      overflow-y: scroll !important;\n      pointer-events: none !important;\n      display: block;\n      transition: background-color 0.5s ease-in-out;\n      -ms-overflow-style: none;\n      scrollbar-width: none;\n    }\n\n    :host([snap]) {\n      scroll-snap-type: y mandatory;\n      scroll-behavior: smooth;\n    }\n\n    :host([snap-touch]) {\n      scroll-snap-type: y mandatory;\n      scroll-behavior: smooth;\n      pointer-events: auto !important;\n    }\n\n    :host([open]) #scroll-area {\n      width: 100%;\n      cursor: pointer;\n    }\n\n    :host([open]) {\n      background-color: rgba(0, 0, 0, 0.5);\n    }\n\n    :host::-webkit-scrollbar {\n      display: none;\n    }\n\n    #scroll-area {\n      margin: 0 auto;\n      width: 1px;\n      height: calc(100% - var(--scroll-overlay-offset));\n      pointer-events: auto;\n      scroll-snap-align: start;\n      min-height: 1px;\n    }\n\n    slot#content {\n      display: flex;\n      margin: 0 auto;\n      width: 100%;\n      pointer-events: auto;\n      scroll-snap-align: start;\n      flex-direction: column;\n    }\n\n    :host(:not([${C.USER_INTERACTING}])) {\n      overflow: hidden !important;\n    }\n  </style>\n\n  <div id="scroll-area"></div>\n  <slot id="content"></slot>\n`;class nr extends HTMLElement{constructor(){super(),b(this,Xs),b(this,Gs,null),b(this,zs,null),b(this,Hs,null),b(this,js,0),f(this,"handleEvent",(t=>{switch(t.type){case"touchstart":y(this,Xs,qs).call(this,t);break;case"touchmove":y(this,Xs,Qs).call(this,t);break;case"touchend":y(this,Xs,$s).call(this,t)}})),b(this,Zs,(()=>{0===this.scrollTop?(this.open=!1,this.removeAttribute("snap-touch"),y(this,Xs,ir).call(this)):!this.visible&&this.scrollTop>0?y(this,Xs,er).call(this):!this.hasAttribute("snap-touch")&&y(this,Xs,tr).call(this)&&(this.open=!0,this.setAttribute("snap-touch",""))})),b(this,Ks,(()=>{const t=v(this,js);w(this,js,this.scrollTop),y(this,Xs,Js).call(this)?0===this.scrollTop?(this.open=!1,y(this,Xs,ir).call(this)):!this.visible&&this.scrollTop>0?y(this,Xs,er).call(this):y(this,Xs,tr).call(this)&&t<=this.scrollTop&&(this.open=!0):this.scrollTop=0})),this.attachShadow({mode:"open"}).appendChild(Vs.content.cloneNode(!0))}connectedCallback(){var t,e,i,n,s,a;const o=this.getRootNode();if(o instanceof Document||o instanceof ShadowRoot){w(this,Gs,o.querySelector("vindral-controller")),null==(t=v(this,Gs))||t.connectListener(this),w(this,zs,null==(e=this.shadowRoot)?void 0:e.querySelector("#scroll-area")),null==(i=v(this,zs))||i.addEventListener("click",(()=>{this.open&&(this.open=!1)}));const l=this.hasAttribute("touch-enabled");if(!(0,r.a)()||!l)return this.setAttribute("snap",""),void this.addEventListener("scroll",v(this,Ks));this.addEventListener("scroll",v(this,Zs)),null==(n=v(this,Gs))||n.addEventListener("touchstart",this,{passive:!0}),null==(s=v(this,Gs))||s.addEventListener("touchmove",this,{passive:!1}),null==(a=v(this,Gs))||a.addEventListener("touchend",this,{passive:!0})}}disconnectedCallback(){var t;null==(t=v(this,Gs))||t.disconnectListener(this)}attributeChangedCallback(t,e,i){var n;e!==i&&(t===C.USER_INTERACTING&&null===i&&y(this,Xs,Ys).call(this)&&setTimeout((()=>{this.open=!1}),300),"open"===t&&this.scrollTo({top:null===i?0:null==(n=v(this,zs))?void 0:n.clientHeight,behavior:"smooth"}))}set open(t){t?this.setAttribute("open",""):this.removeAttribute("open")}get open(){return this.hasAttribute("open")}set visible(t){t?this.setAttribute("visible",""):this.removeAttribute("visible")}get visible(){return this.hasAttribute("visible")}}Gs=new WeakMap,zs=new WeakMap,Hs=new WeakMap,js=new WeakMap,Xs=new WeakSet,qs=function(t){y(this,Xs,Js).call(this)&&t.touches[0]&&w(this,Hs,t.touches[0].clientY)},Qs=function(t){if(y(this,Xs,Js).call(this)&&v(this,Hs)&&!this.hasAttribute("snap-touch")&&(t.preventDefault(),t.touches[0])){const e=t.touches[0].clientY,i=v(this,Hs)-e;this.scrollTop=i}},$s=function(t){y(this,Xs,Ys).call(this)&&!this.hasAttribute("snap-touch")&&(this.open=!0)},Zs=new WeakMap,Ks=new WeakMap,Js=function(){return this.hasAttribute(C.USER_INTERACTING)},Ys=function(){return this.scrollTop>0},tr=function(){var t;return Math.round(this.scrollTop)===this.scrollHeight-this.clientHeight||Math.round(this.scrollTop)===(null==(t=v(this,zs))?void 0:t.clientHeight)},er=function(){this.visible=!0,this.dispatchEvent(new CustomEvent(M.LOCK_UI,{bubbles:!0,composed:!0}))},ir=function(){this.visible=!1,this.dispatchEvent(new CustomEvent(M.UNLOCK_UI,{bubbles:!0,composed:!0}))},f(nr,"observedAttributes",[C.USER_INTERACTING,"open","touch-enabled"]);const sr=document.createElement("template");var rr,ar,or,lr;sr.innerHTML=`\n  <style>\n    :host {\n      display: var(--play-overlay-display);\n      align-items: center;\n      justify-content: center;\n      position: absolute;\n      top: 0;\n      bottom: 0;\n      left: 0;\n      right: 0;\n      z-index: 1;\n      pointer-events: none;\n    }\n\n    :host([hidden]) {\n      display: none;\n    }\n\n    /* Make icon slots clickable */\n    slot[name="play"],\n    slot[name="unmute"] {\n      color: var(--fg-strong);\n      pointer-events: auto;\n      cursor: pointer;\n    }\n\n    :host(:focus-visible) svg {\n      box-shadow: inset 0 0 0 2px var(--fg-strong);\n      outline: 0;\n    }\n\n    :host(:active) svg {\n      scale: 0.9;\n    }\n\n    slot > svg {\n      width: var(--play-overlay-icon-size);\n      height: var(--play-overlay-icon-size);\n    }\n\n    :host(:not([${C.NEEDS_USER_INPUT_VIDEO}]):not([${C.PAUSED}])) slot[name="play"] {\n      display: none !important;\n    }\n\n    :host([${C.PAUSED}]) slot[name="unmute"],\n    :host(:not([${C.NEEDS_USER_INPUT_AUDIO}])) slot[name="unmute"] {\n      display: none !important;\n    }\n  </style>\n\n  <slot name="icon">\n    <slot name="play">\n  <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="currentColor"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 4v16a1 1 0 0 0 1.524 .852l13 -8a1 1 0 0 0 0 -1.704l-13 -8a1 1 0 0 0 -1.524 .852z" /></svg>\n</slot>\n    <slot name="unmute">\n<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><g fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" /></g></svg>\n</slot>\n  </slot>\n`;class hr extends HTMLElement{constructor(){super(),b(this,rr,null),b(this,ar,(()=>{this.dispatchEvent(new CustomEvent(M.REQUEST_USER_INPUT,{bubbles:!0,composed:!0}))})),b(this,or,(t=>{const{key:e}=t;this.keysUsed.includes(e)?this.dispatchEvent(new CustomEvent(M.REQUEST_USER_INPUT,{bubbles:!0,composed:!0})):this.removeEventListener("keyup",v(this,or))})),b(this,lr,(t=>{const{metaKey:e,altKey:i,key:n}=t;e||i||!this.keysUsed.includes(n)?this.removeEventListener("keyup",v(this,or)):this.addEventListener("keyup",v(this,or),{once:!0})})),this.attachShadow({mode:"open"}).appendChild(sr.content.cloneNode(!0))}get keysUsed(){return["Enter"," "]}connectedCallback(){var t;w(this,rr,this.closest("vindral-controller")),null==(t=v(this,rr))||t.connectListener(this),this.setAttribute("aria-label","Play"),this.setAttribute("role","button"),this.enable()}enable(){this.addEventListener("click",v(this,ar)),this.addEventListener("keydown",v(this,lr)),this.tabIndex=0}disable(){this.removeEventListener("click",v(this,ar)),this.removeEventListener("keydown",v(this,lr)),this.removeEventListener("keyup",v(this,or)),this.tabIndex=-1}disconnectedCallback(){var t;null==(t=v(this,rr))||t.disconnectListener(this),this.disable()}}rr=new WeakMap,ar=new WeakMap,or=new WeakMap,lr=new WeakMap,f(hr,"observedAttributes",["hidden",C.NEEDS_USER_INPUT_VIDEO,C.NEEDS_USER_INPUT_AUDIO,C.PAUSED]);const cr=document.createElement("template");var dr,ur,mr;cr.innerHTML='\n  <style>\n    :host,\n    #background {\n      position: absolute;\n      overflow: hidden;\n      display: flex;\n      flex-direction: column;\n      height: 100%;\n      width: 100%;\n      top: 0;\n      left: 0;\n      background-repeat: no-repeat;\n      background-position: 50% 50%;\n      background-size: contain;\n      font-size: 20px;\n      color: var(--fg-strong);\n      pointer-events: none;\n    }\n\n    :host([hidden]) {\n      display: none;\n    }\n\n    #background {\n      opacity: 0.7;\n    }\n\n    #message-container {\n      position: absolute;\n      left: 50%;\n      bottom: calc(50% + var(--play-overlay-icon-size));\n      transform: translateX(-50%);\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      width: max-content;\n      max-width: 90%;\n      pointer-events: none;\n    }\n\n    #title,\n    #description {\n      position: static;\n      width: 100%;\n      text-align: center;\n      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);\n      margin: 0;\n      pointer-events: none;\n    }\n\n    #title {\n      margin-bottom: var(--padding-2);\n    }\n\n    @container (max-width: 600px) {\n      :host {\n        font-size: 15px;\n      }\n      #message-container {\n        bottom: 0;\n        top: var(--padding-1);\n      }\n    }\n\n    @container (max-width: 400px) {\n      :host {\n        font-size: 12px;\n      }\n      #title {\n        margin-bottom: 0;\n      }\n    }\n\n    @container (max-width: 150px) {\n      :host {\n        font-size: 10px;\n      }\n      #title,\n      #description {\n        font-size: 1.2em;\n        margin: 0;\n      }\n    }\n  </style>\n\n  <div id="background"></div>\n  <div id="message-container">\n    <h1 id="title"></h1>\n    <p id="description"></p>\n  </div>\n';class pr extends HTMLElement{constructor(){super(),b(this,dr),b(this,ur),b(this,mr);const t=this.attachShadow({mode:"open"});t.appendChild(cr.content.cloneNode(!0)),w(this,dr,t.querySelector("#title")),w(this,ur,t.querySelector("#description")),w(this,mr,t.querySelector("#background"))}connectedCallback(){}disconnectedCallback(){}attributeChangedCallback(t,e,i){e!==i&&("title"===t?v(this,dr).textContent=i:"description"===t?v(this,ur).textContent=i:"background-image"===t&&(v(this,mr).style.backgroundImage=`url(${i})`))}}dr=new WeakMap,ur=new WeakMap,mr=new WeakMap,f(pr,"observedAttributes",["title","description","background-image","hidden"]);const gr=document.createElement("template");var fr;gr.innerHTML='\n  <style>\n    :host {\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      position: absolute;\n      top: 0;\n      bottom: 0;\n      left: 0;\n      right: 0;\n      z-index: 1;\n      pointer-events: none;\n    }\n\n    :host([hidden]) {\n      display: none;\n    }\n\n    :host(:focus-visible) {\n      outline: none;\n    }\n\n    :host(:focus-visible) svg {\n      box-shadow: inset 0 0 0 2px var(--fg-strong);\n      outline: 0;\n    }\n\n    :host(:active) svg {\n      scale: 0.9;\n    }\n\n    slot#play {\n      color: var(--fg-strong);\n      pointer-events: auto;\n      cursor: pointer;\n    }\n\n    slot#play > svg {\n      width: var(--play-overlay-icon-size);\n      height: var(--play-overlay-icon-size);\n    }\n  </style>\n\n  <slot id="play" name="icon">\n  <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="currentColor"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 4v16a1 1 0 0 0 1.524 .852l13 -8a1 1 0 0 0 0 -1.704l-13 -8a1 1 0 0 0 -1.524 .852z" /></svg>\n</slot>\n';class Ar extends HTMLElement{constructor(){super(),b(this,fr,null),this.attachShadow({mode:"open"}).appendChild(gr.content.cloneNode(!0))}connectedCallback(){var t;w(this,fr,this.closest("vindral-controller")),null==(t=v(this,fr))||t.connectListener(this),this.setAttribute("aria-label","Play"),this.setAttribute("role","button"),this.tabIndex=0}disconnectedCallback(){var t;null==(t=v(this,fr))||t.disconnectListener(this)}attributeChangedCallback(t,e,i){e!==i&&"hidden"===t&&!B(i)&&this.focus()}}fr=new WeakMap,f(Ar,"observedAttributes",["hidden"]);const vr=document.createElement("template");var br;vr.innerHTML="\n  <style>\n    :host {\n      display: var(--volume-range-display);\n      width: 80px;\n    }\n  </style>\n";const wr=class extends Re{constructor(){var t;super(),b(this,br,(()=>{const t=this.range.valueAsNumber;this.dispatchEvent(new CustomEvent(M.SET_VOLUME,{bubbles:!0,composed:!0,detail:t}))})),null==(t=this.shadowRoot)||t.appendChild(vr.content.cloneNode(!0))}connectedCallback(){super.connectedCallback(),this.range.addEventListener("input",v(this,br)),this.range.setAttribute("aria-label","volume")}disconnectedCallback(){super.disconnectedCallback(),this.range.removeEventListener("input",v(this,br))}attributeChangedCallback(t,e,i){var n;super.attributeChangedCallback(t,e,i),(t===C.MUTED||t===C.VOLUME)&&(this.range.valueAsNumber=this.muted?0:parseFloat(this.volume),this.range.setAttribute("aria-valuetext",(n=this.range.valueAsNumber,`${Math.round(100*n)}%`)),this.updateBar())}get volume(){var t;return null!=(t=this.getAttribute(C.VOLUME))?t:"1"}get muted(){return this.hasAttribute(C.MUTED)}};br=new WeakMap,f(wr,"observedAttributes",[...S(wr,wr,"observedAttributes"),C.MUTED,C.VOLUME]);let yr=wr;customElements.define("vindral-controller",Li),customElements.define("vindral-control-bar",Yt),customElements.define("vindral-play-button",En),customElements.define("vindral-mute-button",vn),customElements.define("vindral-buffering-overlay",tt),customElements.define("vindral-scroll-overlay",nr),customElements.define("vindral-play-overlay",Ar),customElements.define("vindral-user-input-play-overlay",hr),customElements.define("vindral-fullscreen-button",_i),customElements.define("vindral-rendition-levels-menu",Ss),customElements.define("vindral-rendition-levels-menu-list",Fs),customElements.define("vindral-channel-grid-button",Kt),customElements.define("vindral-channel-grid",Wt),customElements.define("vindral-channel-grid-item",pt),customElements.define("vindral-pip-button",yn),customElements.define("vindral-airplay-button",Q),customElements.define("vindral-cast-button",at),customElements.define("vindral-cast-overlay",ct),customElements.define("vindral-buffering-icon",K),customElements.define("vindral-language-menu",Fi),customElements.define("vindral-language-menu-list",gn),customElements.define("vindral-message",pr),customElements.define("vindral-volume-range",yr),customElements.define("vindral-poster-overlay",As),customElements.define("vindral-player",as)})();