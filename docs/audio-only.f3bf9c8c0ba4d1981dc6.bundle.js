(()=>{"use strict";var e,t,i={2725:(e,t,i)=>{i.d(t,{F:()=>z,V:()=>wm,d:()=>ht,n:()=>j});var s=i(9633),n=i(3989),r=Object.create,o=Object.defineProperty,a=Object.defineProperties,h=Object.getOwnPropertyDescriptor,c=Object.getOwnPropertyDescriptors,l=Object.getOwnPropertySymbols,u=Object.prototype.hasOwnProperty,d=Object.prototype.propertyIsEnumerable,m=(e,t)=>(t=Symbol[e])?t:Symbol.for("Symbol."+e),p=e=>{throw TypeError(e)},f=(e,t,i)=>t in e?o(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,g=(e,t)=>{for(var i in t||(t={}))u.call(t,i)&&f(e,i,t[i]);if(l)for(var i of l(t))d.call(t,i)&&f(e,i,t[i]);return e},A=(e,t)=>a(e,c(t)),w=(e,t)=>o(e,"name",{value:t,configurable:!0}),y=e=>{var t;return[,,,r(null!=(t=null==e?void 0:e[m("metadata")])?t:null)]},v=["class","method","getter","setter","accessor","field","value","get","set"],b=e=>void 0!==e&&"function"!=typeof e?p("Function expected"):e,S=(e,t,i,s,n)=>({kind:v[e],name:t,metadata:s,addInitializer:e=>i._?p("Already initialized"):n.push(b(e||null))}),k=(e,t)=>f(t,m("metadata"),e[3]),E=(e,t,i,s)=>{for(var n=0,r=e[t>>1],o=r&&r.length;n<o;n++)1&t?r[n].call(i):s=r[n].call(i,s);return s},T=(e,t,i,s,n,r)=>{var a,c,l,u,d,m=7&t,f=!!(8&t),g=!!(16&t),A=m>3?e.length+1:m?f?1:2:0,y=v[m+5],E=m>3&&(e[A-1]=[]),T=e[A]||(e[A]=[]),I=m&&(!g&&!f&&(n=n.prototype),m<5&&(m>3||!g)&&h(m<4?n:{get[i](){return M(this,r)},set[i](e){return U(this,r,e)}},i));m?g&&m<4&&w(r,(m>2?"set ":m>1?"get ":"")+i):w(n,i);for(var C=s.length-1;C>=0;C--)u=S(m,i,l={},e[3],T),m&&(u.static=f,u.private=g,d=u.access={has:g?e=>x(n,e):e=>i in e},3^m&&(d.get=g?e=>(1^m?M:R)(e,n,4^m?r:I.get):e=>e[i]),m>2&&(d.set=g?(e,t)=>U(e,n,t,4^m?r:I.set):(e,t)=>e[i]=t)),c=(0,s[C])(m?m<4?g?r:I[y]:m>4?void 0:{get:I.get,set:I.set}:n,u),l._=1,4^m||void 0===c?b(c)&&(m>4?E.unshift(c):m?g?r=c:I[y]=c:n=c):"object"!=typeof c||null===c?p("Object expected"):(b(a=c.get)&&(I.get=a),b(a=c.set)&&(I.set=a),b(a=c.init)&&E.unshift(a));return m||k(e,n),I&&o(n,i,I),g?4^m?r:I:n},I=(e,t,i)=>f(e,"symbol"!=typeof t?t+"":t,i),C=(e,t,i)=>t.has(e)||p("Cannot "+i),x=(e,t)=>Object(t)!==t?p('Cannot use the "in" operator on this value'):e.has(t),M=(e,t,i)=>(C(e,t,"read from private field"),i?i.call(e):t.get(e)),B=(e,t,i)=>t.has(e)?p("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,i),U=(e,t,i,s)=>(C(e,t,"write to private field"),s?s.call(e,i):t.set(e,i),i),R=(e,t,i)=>(C(e,t,"access private method"),i),P=(e,t,i,s)=>({set _(s){U(e,t,s,i)},get _(){return M(e,t,s)}}),L=(e,t,i)=>new Promise(((s,n)=>{var r=e=>{try{a(i.next(e))}catch(e){n(e)}},o=e=>{try{a(i.throw(e))}catch(e){n(e)}},a=e=>e.done?s(e.value):Promise.resolve(e.value).then(r,o);a((i=i.apply(e,t)).next())})),D=function(e,t){this[0]=e,this[1]=t},_=(e,t,i)=>{var s=(e,t,n,r)=>{try{var o=i[e](t),a=(t=o.value)instanceof D,h=o.done;Promise.resolve(a?t[0]:t).then((i=>a?s("return"===e?e:"next",t[1]?{done:i.done,value:i.value}:i,n,r):n({value:i,done:h}))).catch((e=>s("throw",e,n,r)))}catch(e){r(e)}},n=e=>r[e]=t=>new Promise(((i,n)=>s(e,t,i,n))),r={};return i=i.apply(e,t),r[m("asyncIterator")]=()=>r,n("next"),n("throw"),n("return"),r},W=e=>{var t,i=e[m("asyncIterator")],s=!1,n={};return null==i?(i=e[m("iterator")](),t=e=>n[e]=t=>i[e](t)):(i=i.call(e),t=e=>n[e]=t=>{if(s){if(s=!1,"throw"===e)throw t;return t}return s=!0,{done:!1,value:new D(new Promise((s=>{var n=i[e](t);n instanceof Object||p("Object expected"),s(n)})),1)}}),n[m("iterator")]=()=>n,t("next"),"throw"in i?t("throw"):n.throw=e=>{throw e},"return"in i&&t("return"),n},O=(e,t,i)=>(t=e[m("asyncIterator")])?t.call(e):(e=e[m("iterator")](),t={},(i=(i,s)=>(s=e[i])&&(t[i]=t=>new Promise(((i,n,r)=>(t=s.call(e,t),r=t.done,Promise.resolve(t.value).then((e=>i({value:e,done:r})),n))))))("next"),i("return"),t),F=(e,t,i)=>{var s;return null!=t?("object"!=typeof t&&"function"!=typeof t&&p("Object expected"),i&&(s=t[m("asyncDispose")]),void 0===s&&(s=t[m("dispose")]),"function"!=typeof s&&p("Object not disposable"),e.push([i,s,t])):i&&e.push([i]),t},V=(e,t,i)=>{var s="function"==typeof SuppressedError?SuppressedError:function(e,t,i,s){return(s=Error(i)).name="SuppressedError",s.error=e,s.suppressed=t,s},n=e=>t=i?new s(e,t,"An error was suppressed during disposal"):(i=!0,e),r=s=>{for(;s=e.pop();)try{var o=s[1]&&s[1].call(s[2]);if(s[0])return Promise.resolve(o).then(r,(e=>(n(e),r())))}catch(e){n(e)}if(i)throw t};return r()};class N{constructor(e){I(this,"maxSize",0),I(this,"size",0),I(this,"buffers",[]),I(this,"_borrowedBuffers",0),I(this,"get",(e=>{const t=this.buffers.shift();return this._borrowedBuffers++,this.size<e||!t?(this.buffers=[],this.size=e,new ArrayBuffer(e)):t})),I(this,"reclaim",(e=>{this._borrowedBuffers=Math.max(0,this._borrowedBuffers-1),!(e.byteLength<this.size)&&(this.buffers.length>=this.maxSize||this.buffers.push(e))})),this.maxSize=e}get bufferSize(){return this.size}get poolSize(){return this.buffers.length}get borrowedBuffers(){return this._borrowedBuffers}}const j=()=>{};class G{constructor(){I(this,"promise"),I(this,"resolved"),I(this,"resolve"),I(this,"reject"),I(this,"pending",!0),this.promise=new Promise(((e,t)=>{this.resolve=t=>{this.pending=!1,this.resolved=t,e(t)},this.reject=e=>{this.pending=!1,t(e)}})),this.promise.catch(j)}static resolved(e){const t=new G;return t.resolve(e),t}static fromPromise(e){const t=new G;return t.promise=e,e.then((e=>{t.pending=!1,t.resolved=e}),(e=>{t.pending=!1,t.reject(e)})),t}}class z{constructor(e=50){I(this,"maxSize"),I(this,"values",[]),I(this,"push",(e=>{this.isFull()&&this.pop(),this.values.push(e)})),I(this,"clear",(()=>{this.values=[]})),I(this,"pop",(()=>this.values.shift())),I(this,"peekFirst",(()=>this.values[0])),I(this,"peekLast",(()=>this.values[this.values.length-1])),I(this,"isFull",(()=>this.values.length>=this.maxSize)),I(this,"isEmpty",(()=>0===this.values.length)),I(this,"items",(()=>this.values)),I(this,"filterPop",(e=>{for(;this.peekFirst()&&!e(this.peekFirst());)this.pop()})),this.maxSize=e}}function Q(e){const t=new J(e);return[t,t]}var H,X,q,Z;class J{constructor(e){B(this,H),B(this,X,new G),B(this,q),B(this,Z,!1),U(this,H,new z(e))}isFull(){return M(this,H).isFull()}close(){var e;null==(e=M(this,q))||e.resolve(),U(this,Z,!0)}abort(e){var t,i;null==(t=M(this,q))||t.promise.catch(j),null==(i=M(this,q))||i.reject(e)}push(e){return L(this,null,(function*(){var t;M(this,H).isFull()&&(yield M(this,X).promise),M(this,H).push(e),null==(t=M(this,q))||t.resolve(),U(this,q,new G)}))}pop(){return L(this,null,(function*(){for(var e;!M(this,Z)||!M(this,H).isEmpty();){const t=M(this,H).pop();if(t)return M(this,X).resolve(),U(this,X,new G),t;M(this,q)||U(this,q,new G),yield null==(e=M(this,q))?void 0:e.promise}}))}start(e){}pull(e){return L(this,null,(function*(){const t=yield this.pop();t?e.enqueue(t):e.close()}))}cancel(e){this.abort(new Error(e))}next(){return L(this,null,(function*(){const e=yield this.pop().catch((()=>{}));return e?{done:!1,value:e}:{done:!0,value:void 0}}))}return(){return this.close(),Promise.resolve({done:!0,value:void 0})}[Symbol.asyncIterator](){return this}}function $(e){const t=atob(e),i=new Uint8Array(t.length);for(let e=0;e<t.length;e++)i[e]=t.charCodeAt(e);return i.buffer}function Y(e){return"function"==typeof BigInt?BigInt(e):e}H=new WeakMap,X=new WeakMap,q=new WeakMap,Z=new WeakMap;class K{constructor(e,t=0){I(this,"buffer"),I(this,"bytes"),I(this,"bitOffset"),I(this,"peekBit",(()=>this.getBit(this.bytes,this.bitOffset))),I(this,"readBit",(()=>{const e=this.peekBit();return this.bitOffset++,e})),I(this,"readBits",(e=>{let t=0;for(let i=0;i<e;i++)t=t<<1|(this.getBit(this.bytes,this.bitOffset++)?1:0);return t})),I(this,"readSignedExpGolomb",(()=>{const e=this.readUnsignedExpGolomb();return 1&e?(e+1)/2:-e/2})),I(this,"readUnsignedExpGolomb",(()=>{let e=0;for(;0===this.getBit(this.bytes,this.bitOffset++);)e++;let t=1<<e;for(let i=e-1;i>=0;i--)t|=this.getBit(this.bytes,this.bitOffset++)<<i;return t-1})),I(this,"getBit",((e,t)=>e[t>>3]>>7-(7&t)&1)),this.buffer=e,this.bytes=new Uint8Array(this.buffer),this.bitOffset=t}}function ee(){const e=self.MediaSource,t=self.ManagedMediaSource;return null!=e?e:t}const te=new RegExp("(android|bbd+|meego).+mobile|avantgo|bada/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)/|plucker|pocket|psp|series(4|6)0|symbian|treo|up.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw-(n|u)|c55/|capi|ccwa|cdm-|cell|chtm|cldc|cmd-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc-s|devi|dica|dmob|do(c|p)o|ds(12|-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(-|_)|g1 u|g560|gene|gf-5|g-mo|go(.w|od)|gr(ad|un)|haie|hcit|hd-(m|p|t)|hei-|hi(pt|ta)|hp( i|ip)|hs-c|ht(c(-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i-(20|go|ma)|i230|iac( |-|/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |/)|klon|kpt |kwc-|kyo(c|k)|le(no|xi)|lg( g|/(k|l|u)|50|54|-[a-w])|libw|lynx|m1-w|m3ga|m50/|ma(te|ui|xo)|mc(01|21|ca)|m-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|-([1-8]|c))|phil|pire|pl(ay|uc)|pn-2|po(ck|rt|se)|prox|psio|pt-g|qa-a|qc(07|12|21|32|60|-[2-7]|i-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55/|sa(ge|ma|mm|ms|ny|va)|sc(01|h-|oo|p-)|sdk/|se(c(-|0|1)|47|mc|nd|ri)|sgh-|shar|sie(-|m)|sk-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h-|v-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl-|tdg-|tel(i|m)|tim-|t-mo|to(pl|sh)|ts(70|m-|m3|m5)|tx-9|up(.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas-|your|zeto|zte-/","i"),ie=navigator.userAgent.toLowerCase(),se=te.test(ie),ne=()=>{const e=document.createElement("video");return""!==e.canPlayType("application/vnd.apple.mpegURL")||""!==e.canPlayType("audio/mpegurl")},re=()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){return!1}return!1},oe=()=>"MacIntel"===navigator.platform&&0===navigator.maxTouchPoints,ae=()=>"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1;function he(){var e,t;if(/(iPhone|iPod|iPad)/i.test(ie))return null==(t=null==(e=null==ie?void 0:ie.match(/OS [\d_]+/i))?void 0:e[0])?void 0:t.substring(3).split("_").map((e=>parseInt(e)))[0]}function ce(){var e,t;if(/^((?!chrome|android).)*safari/i.test(ie))return null==(t=null==(e=ie.match(/version\/([\d.]+)/))?void 0:e[1])?void 0:t.split(".").map((e=>parseInt(e)))[0]}const le=()=>{var e,t;const i=!!ee();let s=!1;return i&&(s=(()=>{var e,t;return!ae()&&null!=(t=null==(e=ee())?void 0:e.isTypeSupported('audio/mp4; codecs="opus"'))&&t})()),{isMobile:se,supportsMp4Opus:s,supportsMediaSource:i,supportsHls:ne(),supportsWebAssembly:re(),platform:{iosVersion:null!=(e=he())?e:Number.MAX_SAFE_INTEGER,safariVersion:null!=(t=ce())?t:Number.MAX_SAFE_INTEGER,isIpadOS:ae(),isMacOS:oe(),isIOS:ie.indexOf("iphone")>=0&&ie.indexOf("like iphone")<0||ie.indexOf("ipad")>=0&&ie.indexOf("like ipad")<0||ie.indexOf("ipod")>=0&&ie.indexOf("like ipod")<0||ae()}}},ue=(e,t,i)=>{let s=0;for(let n=t;n<=i;n++)if(n===t){const t=e[n];s+=127&t,128&t&&(s-=128)}else s=256*s+e[n];return s};var de,me,pe;class fe{constructor(e){B(this,de),B(this,me),B(this,pe),U(this,me,e),U(this,pe,new DataView(e.buffer,e.byteOffset,e.byteLength)),U(this,de,0)}position(){return M(this,de)}byteOffset(){return M(this,me).byteOffset+M(this,de)}buffer(){return M(this,me)}remaining(){return M(this,me).length-M(this,de)}readUint8(){const e=M(this,pe).getUint8(M(this,de));return U(this,de,M(this,de)+1),e}readUint24(){const e=M(this,pe).getUint32(M(this,de))>>8&16777215;return U(this,de,M(this,de)+3),e}readUint16(){const e=M(this,pe).getUint16(M(this,de));return U(this,de,M(this,de)+2),e}readUint32(){const e=M(this,pe).getUint32(M(this,de));return U(this,de,M(this,de)+4),e}readUint64(){const e=ue(M(this,me),M(this,de),M(this,de)+7);return U(this,de,M(this,de)+8),e}readBytes(e){const t=M(this,me).subarray(M(this,de),M(this,de)+e);return U(this,de,M(this,de)+e),t}readRemaining(){return this.readBytes(this.remaining())}readUtf8String(){const e=[];let t;for(;0!==(t=this.readUint8())&&(e.push(t),0!=this.remaining()););return(new TextDecoder).decode(new Uint8Array(e))}}de=new WeakMap,me=new WeakMap,pe=new WeakMap;class ge{constructor(e=100,t=100){I(this,"resizeSteps"),I(this,"internalBuffer"),I(this,"view"),I(this,"uint8"),I(this,"_position",0),I(this,"_end",0),this.resizeSteps=t,this.internalBuffer=new ArrayBuffer(e),this.view=new DataView(this.internalBuffer),this.uint8=new Uint8Array(this.internalBuffer)}position(){return this._position}seek(e){this._position=Math.max(0,Math.min(this._end,e))}seekToEnd(){this._position=this._end}writeUint8(e){this.writeAndMove(e,1)}writeUint16(e){this.writeAndMove(e,2)}writeUint24(e){this.writeAndMove(e,3)}writeUint32(e){this.writeAndMove(e,4)}writeUint32At(e,t){this.view.setUint32(e,t)}writeBytes(e){this.resizeIfNeeded(this.position()+e.byteLength),this.uint8.set(e,this.position()),this._position+=e.byteLength,this._end=Math.max(this._end,this._position)}buffer(){return this.internalBuffer.slice(0,this._end)}write(e,t){switch(this.resizeIfNeeded(this.position()+t),t){case 1:this.view.setUint8(this.position(),e);break;case 2:this.view.setUint16(this.position(),e);break;case 3:this.view.setUint8(this.position(),e>>16&255),this.view.setUint8(this.position()+1,e>>8&255),this.view.setUint8(this.position()+2,255&e);break;case 4:this.view.setUint32(this.position(),e)}}writeAndMove(e,t){this.write(e,t),this._position+=t,this._end=Math.max(this._end,this._position)}resizeIfNeeded(e){if(e>this.internalBuffer.byteLength){const t=new ArrayBuffer(e+this.resizeSteps),i=new Uint8Array(t);i.set(this.uint8),this.internalBuffer=t,this.view=new DataView(this.internalBuffer),this.uint8=i}}}class Ae{constructor(e,t,i){I(this,"onSuccess"),I(this,"onError"),I(this,"doExecute"),this.doExecute=e,this.onSuccess=t,this.onError=i}execute(e){try{this.doExecute(e),this.onSuccess()}catch(e){this.onError(e)}}}const we=e=>e.reduce(((e,t)=>e+t),0)/e.length,ye=e=>({last:e[e.length-1]||0,average:0===e.length?0:we(e),max:0===e.length?0:Math.max(...e),min:0===e.length?0:Math.min(...e)});class ve{constructor(e=10){I(this,"rates"),I(this,"_total",0),I(this,"accumulatedValues",0),I(this,"lastTickTime",Date.now()),I(this,"add",(e=>{this.accumulatedValues+=e,this._total+=e})),I(this,"tick",(()=>{const e=this.accumulatedValues/((Date.now()-this.lastTickTime)/1e3);this.rates.push(e),this.accumulatedValues=0,this.lastTickTime=Date.now()})),this.rates=new z(e)}get total(){return this._total}get average(){return this.rates.isEmpty()?0:we(this.rates.items())}get minMaxAverage(){return ye(this.rates.items())}}const be=(e,t)=>{if(e===t)return!0;if(null==e||"object"!=typeof e||null==t||"object"!=typeof t)return!1;let i=0,s=0;for(const t in e)i+=1;for(const i in t)if(s+=1,!(i in e)||!be(e[i],t[i]))return!1;return i==s},Se=["off","error","warn","info","debug","trace"];var ke,Ee,Te,Ie,Ce;const xe=class e{constructor({context:e,logLevel:t,debug:i}){B(this,ke,new Map),B(this,Ee,""),B(this,Te,!1),B(this,Ie,"off"),I(this,"trace",((...e)=>{})),I(this,"debug",((...e)=>{})),I(this,"info",((...e)=>{})),I(this,"warn",((...e)=>{})),I(this,"error",((...e)=>{})),I(this,"table",((...e)=>{})),I(this,"count",((...e)=>{})),U(this,Ee,e),U(this,Ie,t),U(this,Te,i||!1),this.setLevel(t),this.setDebug(M(this,Te))}setDebug(e){U(this,Te,e);for(const[t,i]of M(this,ke))i.setDebug(e);e?(this.table=console.table.bind(console),this.count=console.count.bind(console)):(this.table=()=>{},this.count=()=>{})}setLevel(e){U(this,Ie,e);for(const[t,i]of M(this,ke))i.setLevel(e);const t=Se.indexOf(e);for(const[e,i]of Se.entries())"off"!==i&&(this[i]=e<=t?console[i].bind(console,"%c%s %c%s","font-weight:bold;",i.toUpperCase(),"font-weight:normal;",M(this,Ee)):()=>{})}createContext(t){const i=M(this,ke).get(t);if(!i){const i=new e({context:`${t}`,logLevel:M(this,Ie),debug:M(this,Te)});return M(this,ke).set(t,i),i}return i}static get(){return M(e,Ce)||U(e,Ce,new e({context:"Vindral",logLevel:"off"})),M(e,Ce)}};ke=new WeakMap,Ee=new WeakMap,Te=new WeakMap,Ie=new WeakMap,Ce=new WeakMap,B(xe,Ce);let Me=xe;function Be(e){const t=Me.get().createContext(e.context);return function(i,s){const n=String(s.name);return function(...s){e.enter&&t[e.enter](`Enter '${n}'`,g({},s));try{const r=i.call(this,...s);return r instanceof Promise?r.then((i=>{e.return&&t[e.return](`Return '${n}'`,i)})).catch((i=>{e.error&&t[e.error](`Error '${n}'`,i)})):e.return&&t[e.return](`Return '${n}'`,r),r}catch(i){throw e.error&&t[e.error](`Error '${n}'`,i),i}}}}function Ue(){return"symbol"!=typeof Symbol.asyncDispose&&Object.defineProperty(Symbol,"asyncDispose",{value:Symbol.for("asyncDispose")}),Symbol.asyncDispose}function Re(){return"symbol"!=typeof Symbol.dispose&&Object.defineProperty(Symbol,"dispose",{value:Symbol.for("dispose")}),Symbol.dispose}var Pe,Le,De,_e,We,Oe;class Fe{constructor(e,t){B(this,Pe),I(this,"value"),I(this,"unlocker"),this.value=e,this.unlocker=t}unlocked(){var e;return null==(e=this.unlocker)?void 0:e.promise}[Re()](){R(this,Pe,Le).call(this)}[Symbol.dispose](){R(this,Pe,Le).call(this)}}Pe=new WeakSet,Le=function(){this.unlocker.resolve(this.value)};class Ve{constructor(e){B(this,De),B(this,_e,new G),U(this,De,e),M(this,_e).resolve(e)}unsafeValue(){return M(this,De)}isLocked(){return M(this,_e).pending}lock(){return L(this,null,(function*(){const e=new G;e.promise.then((e=>{U(this,De,e)})).catch(j);const t=M(this,_e).promise.then((()=>e));return U(this,_e,e),yield t,new Fe(M(this,De),e)}))}}De=new WeakMap,_e=new WeakMap;class Ne{constructor(e){B(this,We),B(this,Oe),U(this,We,e),U(this,Oe,new G)}isClosed(){var e;return!(null!=(e=M(this,Oe))&&e.pending)}current(){return M(this,We)}value(){var e;return[M(this,We),null==(e=M(this,Oe))?void 0:e.promise]}update(e){var t;if(null==(t=M(this,Oe))||!t.pending)throw new Error("ObservableValue is closed");U(this,We,e instanceof Function?e(M(this,We)):e),M(this,Oe).resolve(M(this,We)),U(this,Oe,new G)}close(){var e;null==(e=M(this,Oe))||e.resolve(M(this,We)),U(this,Oe,void 0)}waitFor(e){return L(this,null,(function*(){if(e(M(this,We)))return M(this,We);for(;;){const[t,i]=this.value();if(!i)throw new Error("ObservableValue was closed while waiting for condition");const s=yield i;if(e(s))return s}}))}[Symbol.asyncIterator](){return _(this,null,(function*(){for(;;){const[e,t]=this.value();if(yield e,!t)return;yield new D(t)}}))}}We=new WeakMap,Oe=new WeakMap;const je=(e,t)=>{const i=g({},e);return"object"!=typeof i||t.forEach((e=>{delete i[e]})),i},Ge=(e,t=Date.now())=>{const i=e.length;if(i>0){const s=e[i-1];s.end||(s.end=t)}},ze=(e,t=Date.now())=>{Ge(e),e.push({start:t})},Qe=e=>e.reduce(((e,t)=>{var i;return e+((null!=(i=t.end)?i:Date.now())-t.start)}),0),He=(e,t,i=Date.now())=>e.reduce(((e,s)=>{var n;const r=Math.max(i-t,s.start),o=null!=(n=s.end)?n:i;return Math.max(0,o-r)+e}),0),Xe=class{constructor(){I(this,"pendingTimeouts",new Set),I(this,"pendingIntervals",new Set),I(this,"clearTimeout",(e=>{this.pendingTimeouts.delete(e)&&window.clearTimeout(e)})),I(this,"clearInterval",(e=>{this.pendingIntervals.delete(e)&&window.clearInterval(e)})),I(this,"setTimeout",((e,t,...i)=>{const s=window.setTimeout((()=>{e(...i),this.clearTimeout(s)}),t);return this.pendingTimeouts.add(s),s})),I(this,"setInterval",((e,t,...i)=>{const s=window.setInterval((()=>{e(...i)}),t);return this.pendingIntervals.add(s),s})),I(this,"unload",(()=>{this.pendingIntervals.forEach(this.clearInterval),this.pendingTimeouts.forEach(this.clearTimeout)}))}};I(Xe,"create",(()=>new Xe));let qe=Xe;function Ze(e){try{return e()}catch(e){return e}}const Je=()=>{const e=[...Array(256).keys()].map((e=>e.toString(16).padStart(2,"0"))),t=crypto.getRandomValues(new Uint8Array(16));return t[6]=15&t[6]|64,t[8]=63&t[8]|128,[...t.entries()].map((([t,i])=>[4,6,8,10].includes(t)?`-${e[i]}`:e[i])).join("")},$e=e=>L(void 0,null,(function*(){return new Promise((t=>setTimeout(t,e)))})),Ye=(e,...t)=>L(void 0,[e,...t],(function*(e,t=new Error("Timeout")){return new Promise(((i,s)=>setTimeout((()=>s(t)),e)))})),Ke=(e,t)=>L(void 0,null,(function*(){throw yield e,new Error(t)})),et=e=>"width"in e&&"number"==typeof e.width,tt=e=>"sampleRate"in e&&"number"==typeof e.sampleRate,it=e=>{switch(e.codec){case"opus":return'audio/mp4; codecs="opus"';case"mp3":return"audio/mpeg";case"webvtt":return"text/vtt";case"aac":return e.codecString?`audio/mp4; codecs="${e.codecString}"`:"audio/mp4";case"h264":case"av1":return e.codecString?`video/mp4; codecs="${e.codecString}"`:"video/mp4"}},st=()=>Number.MAX_SAFE_INTEGER,nt=()=>({width:Number.MAX_SAFE_INTEGER,height:Number.MAX_SAFE_INTEGER}),rt=e=>!("object"!=typeof e||null===e||!("type"in e)),ot={sizeBasedResolutionCapEnabled:!0,pictureInPictureEnabled:!0,abrEnabled:!0,burstEnabled:!1,mseEnabled:!0,mseOpusEnabled:!1,muted:!1,minBufferTime:1500,maxBufferTime:1500,logLevel:"off",maxSize:nt(),maxVideoBitRate:st(),maxAudioBitRate:st(),tags:[],media:"audio+video",poster:!0,reconnectHandler:e=>e.reconnectRetries<30,iosWakeLockEnabled:!1,telemetryEnabled:!0,iosMediaElementEnabled:!1,pauseSupportEnabled:!0,advanced:{wasmDecodingConstraint:{bitRate:Number.MAX_SAFE_INTEGER,width:1280,height:1280}},videoCodecs:["av1","h264"],webtransportEnabled:!0};class at extends Error{constructor(e,t,i={}){super(e),I(this,"props"),I(this,"extra",{}),I(this,"code",(()=>this.props.code)),I(this,"isFatal",(()=>this.props.isFatal)),I(this,"source",(()=>this.props.source)),I(this,"type",(()=>{var e;return null!=(e=this.props.type)?e:"external"})),I(this,"toStringifiable",(()=>{var e;const t=this.source(),i=t instanceof Error?t.stack:this.stack;return A(g({},this.extra),{code:this.props.code,isFatal:this.props.isFatal,type:this.props.type,message:this.message,sourceMessage:null==(e=this.source())?void 0:e.message,stack:i})})),this.props=t,this.extra=i,Object.setPrototypeOf(this,new.target.prototype)}}const ht=(e,t)=>new at("Decoder Error",{isFatal:e,code:"decoder_error",source:t,type:"internal"}),ct=(e,t)=>new at("Audio Player Error",{isFatal:e,code:"audio_player_error",source:t,type:"internal"}),lt=(e,t,i,s)=>new at("MediaSource Error",{isFatal:e,code:"media_source_error",source:t,type:"internal"},{type:s,consecutiveErrorsCount:i}),ut=(e,t)=>new at(`No track context for ${e}${t?`, rendition id ${t}`:""}`,{isFatal:!1,code:"no_track_context",type:"internal"}),dt=e=>new at("Disconnected From Edge Server",{type:"external",source:e,isFatal:!1,code:"disconnected_by_edge"}),mt=e=>new at("Authentication Failed",{isFatal:!0,code:"authentication_error",source:e}),pt=(e,t)=>new at("Channel not found",{isFatal:!1,code:"channel_not_found",source:t,type:e}),ft=()=>new at("Connection failed - no more reconnect attempts",{isFatal:!0,code:"connection_failed_will_not_attempt_again"}),gt=e=>new at(e,{isFatal:!0,code:"access_forbidden"}),At=e=>new at(`Channel switch to '${e}' failed`,{isFatal:!1,code:"channel_switch_failed"}),wt=(e,t=!1,i)=>new at(e,{isFatal:t,code:"drm_error",source:i}),yt=(e,t)=>e&&"object"==typeof e&&t in e,vt={playready:["150","2000","3000"],widevine:["SW_SECURE_CRYPTO","SW_SECURE_DECODE","HW_SECURE_CRYPTO","HW_SECURE_DECODE","HW_SECURE_ALL"],fairplay:[""],clearkey:[""]},bt={initDataTypes:["cenc"],audioCapabilities:[{contentType:'audio/mp4; codecs="mp4a.40.2"'}],videoCapabilities:[{contentType:'video/mp4; codecs="avc1.42c01f"'}]},St={fairplay:{keySystem:"com.apple.fps",supportedConfig:{initDataTypes:["sinf"],videoCapabilities:[{contentType:'video/mp4; codecs="avc1.42c01f"'}]}},playready:{keySystem:"com.microsoft.playready",supportedConfig:bt},widevine:{keySystem:"com.widevine.alpha",supportedConfig:bt},clearkey:{keySystem:"org.w3.clearkey",supportedConfig:bt}},kt=(e,t)=>L(void 0,null,(function*(){return navigator.requestMediaKeySystemAccess(e,[t]).catch((()=>{}))})),Et=(e,t,i,s,n,r)=>L(void 0,null,(function*(){let o;for(const a of s){const s=null==i?void 0:i.map((e=>A(g({},e),{robustness:a,contentType:r?`${"audioCapabilities"===n?"audio/mp4":"video/mp4"}; codecs="${r}"`:e.contentType})));if(!(yield kt(e,{initDataTypes:t,[n]:s})))break;o=s}return o})),Tt=(e,t,i)=>L(void 0,null,(function*(){const{keySystem:s,supportedConfig:n}=St[e],{initDataTypes:r,videoCapabilities:o,audioCapabilities:a}=n,h=vt[e],[c,l]=yield Promise.all([Et(s,r,o,h,"videoCapabilities",t),Et(s,r,a,h,"audioCapabilities",i)]);return c||l?yield kt(s,{initDataTypes:r,videoCapabilities:c,audioCapabilities:l}):void 0}));var It,Ct,xt,Mt,Bt,Ut,Rt,Pt,Lt,Dt,_t,Wt,Ot,Ft,Vt,Nt,jt,Gt,zt,Qt,Ht,Xt,qt,Zt,Jt,$t,Yt,Kt;class ei{constructor(e,t,i,s){I(this,"keySystem"),I(this,"licenseServerUrl"),I(this,"certificate"),I(this,"headers",{}),I(this,"queryParams",{}),B(this,It),B(this,Ct),U(this,It,t),this.keySystem=e,this.licenseServerUrl=i,this.certificate=s}get statistics(){return{keySystem:M(this,It).keySystem,licenseServerUrl:this.licenseServerUrl,mediaKeySystemConfiguration:M(this,It).getConfiguration()}}getMediaKeys(){return L(this,null,(function*(){return M(this,Ct)||U(this,Ct,yield M(this,It).createMediaKeys()),M(this,Ct)}))}requestLicense(e){return L(this,null,(function*(){const t=new URL(this.licenseServerUrl);for(const[e,i]of Object.entries(this.queryParams))t.searchParams.append(e,i);const i=yield fetch(t,{method:"POST",body:e,headers:g({"Content-Type":"application/octet-stream"},this.headers)});if(!i.ok)throw new Error(`Failed to fetch license: ${i.statusText}`);return yield i.arrayBuffer()}))}}function ti(e){const t=window.atob(e.replace(/-/g,"+").replace(/_/g,"/"));let i="";for(let e=0;e<t.length;e++)i+=("0"+t.charCodeAt(e).toString(16)).substr(-2);return i}function ii(e){let t="";for(let i=0;i<e.length;i+=2)t+=String.fromCharCode(parseInt(e.substr(i,2),16));return window.btoa(t).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function si(e,t){if(e.byteLength!==t.byteLength)return!1;const i=new Uint8Array(e),s=new Uint8Array(t);for(let e=0;e<i.length;e++)if(i[e]!==s[e])return!1;return!0}It=new WeakMap,Ct=new WeakMap;class ni extends ei{constructor(e,t){super("clearkey",e,""),B(this,xt),U(this,xt,t)}handleLicenseRequest(e){const t=new Uint8Array(e),i=String.fromCharCode(...t),s=JSON.parse(i),n=[];for(let e=0;e<s.kids.length;e++){const t=s.kids[e];if(t){const e=ti(t).toLowerCase(),i=M(this,xt)[e];i&&n.push({kty:"oct",alg:"A128KW",kid:t,k:ii(i)})}}const r=JSON.stringify({keys:n,type:s.type});return(new TextEncoder).encode(r)}}xt=new WeakMap;class ri extends ei{constructor(e,t,i){super("fairplay",e,t,i)}}class oi extends ei{constructor(e,t){super("playready",e,t)}requestLicense(e){return L(this,null,(function*(){(0,n.a)(this.licenseServerUrl,"No license server URL set");const t=new URL(this.licenseServerUrl);for(const[e,i]of Object.entries(this.queryParams))t.searchParams.append(e,i);const i=(e=>{var t,i,s,n;const r=String.fromCharCode(...new Uint16Array(e)),o=(new window.DOMParser).parseFromString(r,"application/xml"),a=o.getElementsByTagName("HttpHeaders")[0];let h={};if(a){const e=a.getElementsByTagName("name"),s=a.getElementsByTagName("value");for(let n=0;n<e.length;n++){const r=null==(t=e[n])?void 0:t.childNodes[0],o=null==(i=s[n])?void 0:i.childNodes[0];null!=r&&r.nodeValue&&o&&o.nodeValue&&(h[r.nodeValue]=o.nodeValue)}}const c=o.getElementsByTagName("Challenge")[0];let l;return c&&null!=(s=c.childNodes[0])&&s.nodeValue&&(l=window.atob(null==(n=c.childNodes[0])?void 0:n.nodeValue)),o.querySelector("parsererror")&&(h={"Content-Type":"text/xml; charset=utf-8",SOAPAction:'"http://schemas.microsoft.com/DRM/2007/03/protocols/AcquireLicense"'},l=e),{headers:h,message:l}})(e),s=yield fetch(t,{method:"POST",headers:g(g({},i.headers),this.headers),body:i.message});if(!s.ok)throw new Error(`Failed to fetch license: ${s.statusText}`);return yield s.arrayBuffer()}))}}class ai extends ei{constructor(e,t){super("widevine",e,t)}}class hi{constructor(e,t,i,s){B(this,jt),B(this,Mt),B(this,Bt),B(this,Ut),B(this,Rt,new G),B(this,Pt,{}),B(this,Lt,{}),B(this,Dt),B(this,_t,new Map),B(this,Wt),B(this,Ot),B(this,Ft,le()),B(this,Vt,(e=>{if(M(this,Mt).info("Received DRM data",{options:e}),window.clearTimeout(M(this,Ot)),M(this,Dt)){const t=R(this,jt,Kt).call(this,e)[M(this,Dt).keySystem];t&&(M(this,Dt).licenseServerUrl=t)}M(this,Rt).resolve(e)})),B(this,Nt,(e=>{M(this,Mt).info("Encrypted event received",{event:e}),R(this,jt,Gt).call(this,e)})),B(this,Xt,(e=>{var t,i;M(this,Mt).debug("Session message received",{event:e});const s=e.target,n=e.message;M(this,_t).get(s)?(M(this,Mt).debug("Requesting license for session",{sessionId:s.sessionId,licenseServerUrl:null==(t=M(this,Dt))?void 0:t.licenseServerUrl}),null==(i=M(this,Dt))||i.requestLicense(n).then((e=>{M(this,Mt).debug("License received for session",{sessionId:s.sessionId}),s.update(e).catch((e=>{R(this,jt,Jt).call(this,{message:"Failed to update session with license",isFatal:!1,error:e})}))})).catch((e=>{R(this,jt,Jt).call(this,{message:"Failed to request license",isFatal:!1,error:e})}))):M(this,Mt).error("No active session found for event",{event:e})})),B(this,qt,(e=>{const t=e.target;M(this,Mt).debug("Key status changed for session",{sessionId:t.sessionId}),t.keyStatuses.forEach(((e,t)=>{const i=ti(window.btoa(String.fromCharCode(...new Uint8Array(t))));M(this,Mt).debug("Key status",{base64kid:i,status:e})}))})),B(this,$t,(e=>L(this,null,(function*(){const t=R(this,jt,Yt).call(this,e);M(this,Mt).debug("Prioritized key system list",{keySystemList:t});const i=yield((e,t,i)=>L(void 0,null,(function*(){let s;for(const n of e)if(s=yield Tt(n,t,i),s)return{keySystem:n,mediaKeySystemAccess:s}})))(t,e.videoCodec,e.audioCodec);if(!i)return M(this,Mt).warn("No supported key system found"),null;M(this,Mt).debug("Supported key system found",i.mediaKeySystemAccess.getConfiguration());const{keySystem:s,mediaKeySystemAccess:r}=i;let o=null;return"clearkey"===s?((0,n.a)(e.clearkeys,"No clearkeys found"),o=new ni(r,e.clearkeys)):"playready"===s?((0,n.a)(e.playreadyLicenseUrl,"No playreadyLicenseUrl found"),o=new oi(r,e.playreadyLicenseUrl)):"widevine"===s?((0,n.a)(e.widevineLicenseUrl,"No widevineLicenseUrl found"),o=new ai(r,e.widevineLicenseUrl)):"fairplay"===s&&((0,n.a)(e.fairplayLicenseUrl,"No fairplayLicenseUrl found"),(0,n.a)(e.fairplayCertificate,"No fairplayCertificate found"),o=new ri(r,e.fairplayLicenseUrl,e.fairplayCertificate)),o&&(o.headers=M(this,Pt),o.queryParams=M(this,Lt)),o})))),U(this,Bt,e),U(this,Mt,t),U(this,Pt,i||{}),U(this,Lt,s||{}),M(this,Bt).on("received drm data",M(this,Vt))}static isSupported(){return!!navigator.requestMediaKeySystemAccess}attach(e){U(this,Ut,e),M(this,Mt).info("Media element attached"),M(this,Ut).addEventListener("encrypted",M(this,Nt))}getStatistics(){var e,t;return M(this,Rt).resolved||null!=(e=M(this,Dt))&&e.statistics?g(g({},M(this,Rt).resolved),null==(t=M(this,Dt))?void 0:t.statistics):null}unload(){var e;M(this,Mt).info("Unloading EncryptedMediaExtensions"),M(this,Bt).off("received drm data",M(this,Vt)),null==(e=M(this,Ut))||e.removeEventListener("encrypted",M(this,Nt)),M(this,_t).forEach(((e,t)=>{t.close()})),M(this,_t).clear(),U(this,Wt,void 0),U(this,Dt,void 0)}set headers(e){U(this,Pt,e),M(this,Dt)&&(M(this,Dt).headers=e)}set queryParams(e){U(this,Lt,e),M(this,Dt)&&(M(this,Dt).queryParams=e)}onChannelSwitch(){if(!M(this,Rt).resolved)return void M(this,Mt).debug("DRM is not used, skipping channel switch handling");/^(?!.*chrome).*safari/i.test(ie)&&M(this,Ft).platform.safariVersion<18&&R(this,jt,Jt).call(this,{message:"DRM channel switch not supported on Safari < 18",isFatal:!0}),window.clearTimeout(M(this,Ot));const e=M(this,Rt).resolved;U(this,Rt,new G),U(this,Ot,window.setTimeout((()=>{M(this,Rt).resolve(e)}),5e3))}}Mt=new WeakMap,Bt=new WeakMap,Ut=new WeakMap,Rt=new WeakMap,Pt=new WeakMap,Lt=new WeakMap,Dt=new WeakMap,_t=new WeakMap,Wt=new WeakMap,Ot=new WeakMap,Ft=new WeakMap,Vt=new WeakMap,Nt=new WeakMap,jt=new WeakSet,Gt=function(e){return L(this,null,(function*(){try{yield R(this,jt,zt).call(this),M(this,Mt).debug("Media keys initialization completed"),yield R(this,jt,Qt).call(this,e.initData,e.initDataType)}catch(e){R(this,jt,Jt).call(this,{message:"Failed to handle encrypted event",isFatal:!0,error:e})}}))},zt=function(){return L(this,null,(function*(){var e;M(this,Mt).debug("Initializing media keys");const t=yield M(this,Rt).promise;if(null==(e=M(this,Ut))||!e.mediaKeys)return M(this,Wt)?(M(this,Mt).debug("Media keys initialization already in progress, waiting for completion"),void(yield M(this,Wt))):(U(this,Wt,L(this,null,(function*(){const e=yield M(this,$t).call(this,t);M(this,Mt).debug("CDM obtained",{cdm:e}),(0,n.a)(M(this,Ut),"No media element found"),(0,n.a)(e,"No CDM found");const i=yield e.getMediaKeys();e.certificate&&(yield R(this,jt,Zt).call(this,i,e.certificate)),M(this,Mt).debug("Setting media keys on media element"),yield M(this,Ut).setMediaKeys(i),U(this,Dt,e)}))),void(yield M(this,Wt)));M(this,Mt).debug("Media keys already set on media element")}))},Qt=function(e,t){return L(this,null,(function*(){(0,n.a)(M(this,Dt),"No CDM manager found");const i=yield M(this,Dt).getMediaKeys();if(!e||!R(this,jt,Ht).call(this,e))return void M(this,Mt).debug("Duplicate initData, no need to create new session",{initData:e});const s=i.createSession();M(this,Mt).debug("Creating new session",{session:s}),s.addEventListener("keystatuseschange",M(this,qt)),s.closed.then((e=>{M(this,Mt).info("Session is closed",{reason:e})})),s.addEventListener("message",M(this,Xt)),M(this,_t).set(s,e),M(this,Mt).debug("Generating request for session",{session:s,initDataType:t,initData:e}),yield s.generateRequest(t,e)}))},Ht=function(e){for(const[t,i]of M(this,_t))if(si(e,i))return!1;return!0},Xt=new WeakMap,qt=new WeakMap,Zt=function(e,t){return L(this,null,(function*(){try{M(this,Mt).debug("Setting server certificate",{certificate:t}),(yield e.setServerCertificate(t))||M(this,Mt).warn("Server certificates are not supported by the CDM.")}catch(e){M(this,Mt).error("Failed to set server certificate",{error:e})}}))},Jt=function(e){const{message:t,isFatal:i,error:s}=e;M(this,Mt).error(t,{error:s}),M(this,Bt).emit("error",wt(t,i,s))},$t=new WeakMap,Yt=function(e){const t=[];return e.clearkeys&&t.push("clearkey"),e.playreadyLicenseUrl&&t.push("playready"),e.widevineLicenseUrl&&t.push("widevine"),e.fairplayLicenseUrl&&e.fairplayCertificate&&t.push("fairplay"),t},Kt=function(e){return{fairplay:e.fairplayLicenseUrl,playready:e.playreadyLicenseUrl,widevine:e.widevineLicenseUrl,clearkey:void 0}};const ci=(e,t=0)=>{for(let i=t;i<e.byteLength-4;i++){const t=1===e.getUint32(i),s=1==(e.getUint8(i)<<16|e.getUint16(i+1));if(t||s)return{position:i,nalPrefixSize:t?4:3}}},li=e=>{const t=[],i=[];if(!(e=>0!==(e=>{const t=e.getUint32(0,!1);let i=0;return 1==(e.getUint8(0)<<16|e.getUint16(1,!1))?i+=3:1===t&&(i+=4),i})(new DataView(e,0)))(e)){const s=new DataView(e,0),n=31&s.getUint8(5);let r=6;for(let i=0;i<n;i++){const i=s.getUint16(r);t.push(e.slice(r+2,r+2+i)),r+=i+2}const o=s.getUint8(r);r+=1;for(let t=0;t<o;t++){const t=s.getUint16(r);i.push(e.slice(r+2,r+2+t)),r+=t+2}return{sequenceParameterSets:t,pictureParameterSets:i}}return((e,t)=>{const i=new DataView(e,0);let s=ci(i);for(;s;){const{position:n,nalPrefixSize:r}=s,o=ci(i,n+4),a=o?o.position-n-r:void 0;if(!t(new DataView(e,n+r,a)))return;s=o}})(e,(e=>{const s=e.byteOffset+e.byteLength;switch((e=>31&e)(e.getUint8(0))){case 8:i.push(e.buffer.slice(e.byteOffset,s));break;case 7:t.push(e.buffer.slice(e.byteOffset,s))}return!0})),{sequenceParameterSets:t,pictureParameterSets:i}},ui=[{numerator:0,denumerator:0},{numerator:1,denumerator:1},{numerator:12,denumerator:11},{numerator:10,denumerator:11},{numerator:16,denumerator:11},{numerator:40,denumerator:33},{numerator:24,denumerator:11},{numerator:20,denumerator:11},{numerator:32,denumerator:11},{numerator:80,denumerator:33},{numerator:18,denumerator:11},{numerator:15,denumerator:11},{numerator:64,denumerator:33},{numerator:160,denumerator:99},{numerator:4,denumerator:3},{numerator:3,denumerator:2},{numerator:2,denumerator:1}];function di(e){return{encoding:e.readUint8(),description:e.readUtf8String(),value:e.readUtf8String()}}function mi(e){let t=e.readUint32();const i=[e.readUint8(),e.readUint8(),e.readUint8(),e.readUint8()],s=String.fromCharCode.apply(null,i);return 1===t&&(t=e.readUint64()-8),{size:t-8,type:s}}function pi(e){return{version:e.readUint8(),flags:e.readUint24()}}const fi=class e{constructor({timescale:t,presentationTime:i,presentationTimeDelta:s,schemeIdUri:n,value:r,eventDuration:o,id:a,data:h}){I(this,"type",e.type),I(this,"timescale"),I(this,"presentationTime"),I(this,"presentationTimeDelta"),I(this,"schemeIdUri"),I(this,"value"),I(this,"eventDuration"),I(this,"id"),I(this,"data"),this.timescale=t,this.presentationTime=i,this.presentationTimeDelta=s,this.schemeIdUri=n,this.value=r,this.eventDuration=o,this.id=a,this.data=h}static decodeData(t){const{version:i}=pi(t);switch(i){case 1:{const i=t.readUint32(),s=t.readUint64(),n=t.readUint32(),r=t.readUint32(),o=t.readUtf8String(),a=t.readUtf8String(),h=t.remaining(),c=t.readBytes(h);return new e({timescale:i,presentationTime:s,eventDuration:n,id:r,schemeIdUri:o,value:a,data:c})}case 0:{const i=t.readUtf8String(),s=t.readUtf8String(),n=t.readUint32(),r=t.readUint32(),o=t.readUint32(),a=t.readUint32(),h=t.remaining(),c=t.readBytes(h);return new e({timescale:n,presentationTimeDelta:r,schemeIdUri:i,value:s,eventDuration:o,id:a,data:c})}default:throw new Error(`unsupported version ${i}`)}}};I(fi,"type","emsg");let gi=fi;const Ai=class e{constructor(t){I(this,"type",e.type),I(this,"data"),this.data=t}static decodeData(t){const i=t.readRemaining();return new e(i)}};I(Ai,"type","mdat");let wi=Ai;const yi=class e{constructor(t,i,s){I(this,"type",e.type),I(this,"extra"),I(this,"byteOffset"),I(this,"baseMediaDecodeTime"),this.extra=t,this.byteOffset=i,this.baseMediaDecodeTime=s}static decodeData(t){const i=pi(t),s=t.byteOffset();let n=0;return n=1===i.version?t.readUint64():t.readUint32(),new e(i,s,n)}};I(yi,"type","tfdt");let vi=yi;const bi=class e{constructor(t,i,s){I(this,"type",e.type),I(this,"dataOffset"),I(this,"firstSampleFlags"),I(this,"samplesCount"),I(this,"sampleDurations",[]),I(this,"sampleSizes",[]),I(this,"sampleFlags",[]),I(this,"sampleCts",[]),this.dataOffset=i,this.firstSampleFlags=s,this.samplesCount=t}is_sync_sample(t){const i=e.FLAG_SAMPLE_FLAG_IS_NON_SYNC|e.FLAG_SAMPLE_DEPENDS_YES,s=this.sampleFlags[t];return void 0!==s?!(s&i):0===t&&this.firstSampleFlags?!(this.firstSampleFlags&i):void 0}static decodeData(t){const{flags:i}=pi(t),s=t.readUint32();let n,r;i&e.TRUN_DATA_OFFSET&&(n=t.readUint32()),i&e.TRUN_FIRST_SAMPLE_FLAGS&&(r=t.readUint32());const o=new e(s,n,r);for(let n=0;n<s;n++)i&e.SAMPLE_DURATION&&o.sampleDurations.push(t.readUint32()),i&e.SAMPLE_SIZE&&o.sampleSizes.push(t.readUint32()),i&e.SAMPLE_FLAGS&&o.sampleFlags.push(t.readUint32()),i&e.SAMPLE_CTS&&o.sampleCts.push(t.readUint32());return o}};I(bi,"TRUN_DATA_OFFSET",1),I(bi,"TRUN_FIRST_SAMPLE_FLAGS",4),I(bi,"SAMPLE_DURATION",256),I(bi,"SAMPLE_SIZE",512),I(bi,"SAMPLE_FLAGS",1024),I(bi,"SAMPLE_CTS",2048),I(bi,"FLAG_SAMPLE_FLAG_IS_NON_SYNC",65536),I(bi,"FLAG_SAMPLE_DEPENDS_NO",33554432),I(bi,"FLAG_SAMPLE_DEPENDS_YES",16777216),I(bi,"type","trun");let Si=bi;const ki=class e{constructor(t,i){I(this,"type",e.type),I(this,"tfdt"),I(this,"trun"),this.tfdt=t,this.trun=i}static decodeData(t){let i,s;for(;t.remaining()>0;){const e=as(t);e instanceof vi&&(i=e),e instanceof Si&&(s=e)}return new e(i,s)}};I(ki,"type","traf");let Ei=ki;const Ti=class e{constructor(t){I(this,"type",e.type),I(this,"traf"),this.traf=t}static decodeData(t){let i;for(;t.remaining()>0;){const e=as(t);e instanceof Ei&&(i=e)}if(!i)throw new Error("No traf found");return new e(i)}};I(Ti,"type","moof");let Ii=Ti;const Ci=class e{constructor(){I(this,"type",e.type)}static decodeData(t){return new e}};I(Ci,"type","mvhd");let xi=Ci;const Mi=class e{constructor(t){I(this,"type",e.type),I(this,"fourCC"),this.fourCC=t}mediaType(){switch(this.fourCC){case"vide":return"video";case"soun":return"audio";case"sbtl":return"text";default:throw new Error("Unknown media type")}}static decodeData(t){pi(t),t.readUint32();const i=String.fromCharCode(...t.readBytes(4));return new e(i)}};I(Mi,"type","hdlr");let Bi=Mi;const Ui=class e{constructor(t,i,s,n){I(this,"type",e.type),I(this,"creationTime"),I(this,"modificationTime"),I(this,"timescale"),I(this,"duration"),this.creationTime=t,this.modificationTime=i,this.timescale=s,this.duration=n}static decodeData(t){const{version:i}=pi(t);if(1===i){const i=t.readUint64(),s=t.readUint64(),n=t.readUint32(),r=t.readUint64();return new e(i,s,n,r)}const s=t.readUint32(),n=t.readUint32(),r=t.readUint32(),o=t.readUint32();return new e(s,n,r,o)}};I(Ui,"type","mdhd");let Ri=Ui;const Pi=class e{constructor(t,i,s,n){I(this,"type",e.type),I(this,"av01"),I(this,"avc1"),I(this,"opus"),I(this,"codec"),this.avc1=t,this.av01=i,this.opus=s,this.codec=n}mediaType(){return this.avc1||this.av01?"video":"audio"}width(){var e;return null==(e=this.avc1)?void 0:e.width}height(){var e;return null==(e=this.avc1)?void 0:e.height}static decodeData(t){pi(t);const i=t.readUint32();let s,n,r,o;for(let e=0;e<i;e++)for(;t.remaining()>0;){const e=as(t);switch(e.type){case"avc1":s="h264",n=e;break;case"av01":s="av1",o=e;break;case"mp4a":s="aac";break;case"Opus":s="opus",r=e}}return new e(n,o,r,s)}};I(Pi,"type","stsd");let Li=Pi;const Di=class e{constructor(t){I(this,"type",e.type),I(this,"stsd"),this.stsd=t}static decodeData(t){let i;for(;t.remaining()>0;){const e=as(t);e instanceof Li&&(i=e)}if(!i)throw new Error("No stsd found");return new e(i)}};I(Di,"type","stbl");let _i=Di;const Wi=class e{constructor(t){I(this,"type",e.type),I(this,"stbl"),this.stbl=t}static decodeData(t){let i;for(;t.remaining()>0;){const e=as(t);e instanceof _i&&(i=e)}if(!i)throw new Error("No stbl found");return new e(i)}};I(Wi,"type","minf");let Oi=Wi;const Fi=class e{constructor(t,i,s){I(this,"type",e.type),I(this,"hdlr"),I(this,"minf"),I(this,"mdhd"),this.hdlr=t,this.minf=i,this.mdhd=s}static decodeData(t){let i,s,n;for(;t.remaining()>0;){const e=as(t);e instanceof Bi&&(i=e),e instanceof Oi&&(s=e),e instanceof Ri&&(n=e)}if(!i)throw new Error("No hdlr found");if(!s)throw new Error("No minf found");if(!n)throw new Error("No mdhd found");return new e(i,s,n)}};I(Fi,"type","mdia");let Vi=Fi;const Ni=class e{constructor(t,i,s,n,r,o,a,h){I(this,"type",e.type),I(this,"modificationTime"),I(this,"creationTime"),I(this,"trackId"),I(this,"duration"),I(this,"alternateGroup"),I(this,"volume"),I(this,"width"),I(this,"height"),this.modificationTime=t,this.creationTime=i,this.trackId=s,this.duration=n,this.alternateGroup=r,this.volume=o,this.width=a,this.height=h}static decodeData(t){let i=0,s=0;1===pi(t).version?(i=t.readUint64(),s=t.readUint64()):(i=t.readUint32(),s=t.readUint32());const n=t.readUint32();t.readUint32();const r=t.readUint32();t.readUint32(),t.readUint32(),t.readUint16();const o=t.readUint16(),a=t.readUint16();t.readUint16(),new Array(9).fill(0).map((()=>t.readUint32()));const h=t.readUint16();t.readUint16();const c=t.readUint16();return t.readUint16(),new e(i,s,n,r,o,a,h,c)}};I(Ni,"type","tkhd");let ji=Ni;const Gi=class e{constructor(t,i){I(this,"type",e.type),I(this,"tkhd"),I(this,"mdia"),this.tkhd=t,this.mdia=i}static decodeData(t){let i,s;for(;t.remaining()>0;){const e=as(t);e instanceof ji&&(i=e),e instanceof Vi&&(s=e)}if(!i)throw new Error("No tkhd found");if(!s)throw new Error("No mdia found");return new e(i,s)}};I(Gi,"type","trak");let zi=Gi;const Qi=class e{constructor(t,i){I(this,"type",e.type),I(this,"mvhd"),I(this,"traks"),this.mvhd=t,this.traks=i}static decodeData(t){let i;const s=[];for(;t.remaining()>0;){const e=as(t);e instanceof zi&&s.push(e),e instanceof xi&&(i=e)}if(!i)throw new Error("No mvhd found");return new e(i,s)}};I(Qi,"type","moov");let Hi=Qi;const Xi=class e{constructor(t,i,s,n,r,o,a,h){I(this,"type",e.type),I(this,"configurationVersion"),I(this,"avcProfileIndication"),I(this,"profileCompatibility"),I(this,"avcLevelIndication"),I(this,"lengthSizeMinusOne"),I(this,"sequenceParameterSets"),I(this,"pictureParameterSets"),I(this,"bytes"),this.configurationVersion=t,this.avcProfileIndication=i,this.profileCompatibility=s,this.avcLevelIndication=n,this.lengthSizeMinusOne=r,this.sequenceParameterSets=o,this.pictureParameterSets=a,this.bytes=h}static decodeData(t){const i=t.buffer(),s=t.readUint8(),n=t.readUint8(),r=t.readUint8(),o=t.readUint8(),a=3&t.readUint8(),h=31&t.readUint8(),c=[];for(let e=0;e<h;e++){const e=t.readBytes(t.readUint16());c.push(e)}const l=t.readUint8(),u=[];for(let e=0;e<l;e++){const e=t.readBytes(t.readUint16());u.push(e)}return new e(s,n,r,o,a,c,u,i)}};I(Xi,"type","avcC");let qi=Xi;const Zi=class e{constructor(t,i,s,n,r){I(this,"type",e.type),I(this,"avcC"),I(this,"width"),I(this,"height"),I(this,"horizontalResolution"),I(this,"verticalResolution"),this.avcC=t,this.width=i,this.height=s,this.horizontalResolution=n,this.verticalResolution=r}static decodeData(t){t.readUint32(),t.readUint16(),t.readUint16(),t.readUint32(),t.readUint64(),t.readUint32();const i=t.readUint16(),s=t.readUint16(),n=t.readUint32(),r=t.readUint32();let o;for(t.readUint32(),t.readUint16(),t.readBytes(32),t.readUint16(),t.readUint16();t.remaining()>0;){const e=as(t);"avcC"===e.type&&(o=e)}if(!o)throw new Error("no avcC");return new e(o,i,s,n,r)}};I(Zi,"type","avc1");let Ji=Zi;const $i=class e{constructor(){I(this,"type",e.type)}static decodeData(t){return new e}};I($i,"type","dOps");let Yi=$i;const Ki=class e{constructor(t,i,s){I(this,"type",e.type),I(this,"dops"),I(this,"channelCount"),I(this,"sampleRate"),this.dops=t,this.channelCount=i,this.sampleRate=s}static decodeData(t){t.readUint32(),t.readUint16(),t.readUint16();const i=t.readUint16();t.readUint16(),t.readUint32();const s=t.readUint16();t.readUint16(),t.readUint32();const n=t.readUint16();t.readUint16(),1===i&&(t.readUint64(),t.readUint64());const r=function(e,t){const i=mi(t),s=new fe(t.readBytes(i.size));if(i.type!==e.type)throw new Error(`invalid error type: ${i.type}, expected ${e.type}`);const n=e.decodeData(s);return s.readRemaining(),n}(Yi,t);return new e(r,s,n)}};I(Ki,"type","Opus");let es=Ki;const ts=class e{constructor(t,i){I(this,"type",e.type),I(this,"ntpTimestamp"),I(this,"mediaTime"),this.ntpTimestamp=t,this.mediaTime=i}static decodeData(t){const{version:i}=pi(t);t.readUint32();const s=t.readUint32(),n=t.readUint32();if(1===i){const i=t.readUint64();return new e([s,n],i)}const r=t.readUint32();return new e([s,n],r)}};I(ts,"type","prft");let is=ts;var ss,ns;class rs{constructor(e,t){B(this,ss),B(this,ns),U(this,ss,e),U(this,ns,t.readBytes(e.size))}data(){return M(this,ns)}get type(){return M(this,ss).type}}ss=new WeakMap,ns=new WeakMap;const os={moov:Hi,trak:zi,tkhd:ji,mvhd:xi,moof:Ii,traf:Ei,tfdt:vi,trun:Si,mdat:wi,mdia:Vi,hdlr:Bi,minf:Oi,stbl:_i,mdhd:Ri,stsd:Li,prft:is,avc1:Ji,avcC:qi,Opus:es,emsg:gi};function as(e){const t=mi(e),i=os[t.type],s=new fe(e.readBytes(t.size));if(!i){const e=new rs(t,s);return s.readRemaining(),e}const n=i.decodeData(s);return s.readRemaining(),n}var hs,cs,ls,us,ds;class ms{constructor(e){B(this,hs),B(this,cs),U(this,hs,e),U(this,cs,function(e){if(e.byteLength<8)throw new Error("Buffer too small");const t=new fe(e),i=new Map;for(;t.remaining()>0;){const e=as(t);i.set(e.type,e)}const s=i.get("ftyp"),n=i.get("moov");if(!s)throw new Error("ftyp atom not found");if(!(n&&n instanceof Hi))throw new Error("moov atom not found");return{ftyp:s,moov:n}}(e))}rawBytes(){return M(this,hs)}init(){return M(this,cs)}}hs=new WeakMap,cs=new WeakMap,ls=new WeakMap,us=new WeakMap,ds=new WeakMap;let ps=class e{constructor(e,t){B(this,ls),B(this,us),B(this,ds),U(this,ls,t),U(this,us,e),U(this,ds,function(e){if(e.byteLength<8)throw new Error("Buffer too small");const t=new fe(e),i=new Map,s=[];for(;t.remaining()>0;){const e=as(t);e instanceof gi&&s.push(e),i.set(e.type,e)}const n=i.get("moof"),r=i.get("mdat"),o=i.get("prft");if(!(n&&n instanceof Ii))throw new Error("moof atom not found");if(!(r&&r instanceof wi))throw new Error("mdat atom not found");if(o&&!(o instanceof is))throw new Error("invalid prft found");return{moof:n,mdat:r,prft:o,emsgs:s}}(t))}clone(){return new e(M(this,us),new Uint8Array(M(this,ls).buffer.slice(M(this,ls).byteOffset,M(this,ls).byteOffset+M(this,ls).byteLength)))}updateBaseMediaDecodeTime(e){const t=new DataView(M(this,ls).buffer,M(this,ls).byteOffset,M(this,ls).byteLength);if(M(this,ds).moof.traf.tfdt)if(M(this,ds).moof.traf.tfdt.baseMediaDecodeTime=e,1===M(this,ds).moof.traf.tfdt.extra.version){const i=Math.floor(e/4294967296),s=(4294967295&e)>>>0;t.setUint32(M(this,ds).moof.traf.tfdt.byteOffset-M(this,ls).byteOffset,i),t.setUint32(M(this,ds).moof.traf.tfdt.byteOffset-M(this,ls).byteOffset+4,s)}else t.setUint32(M(this,ds).moof.traf.tfdt.byteOffset-M(this,ls).byteOffset,e)}producerReferenceTime(){if(!M(this,ds).prft)return;const[e,t]=M(this,ds).prft.ntpTimestamp,i=1e3*e+t/2**32*1e3,s=new Date(Date.UTC(1900,0,1,0,0,0));return new Date(s.getTime()+i)}duration(){var e;return(null==(e=M(this,ds).moof.traf.trun)?void 0:e.sampleDurations.reduce(((e,t)=>e+t),0))||0}baseMediaDecodeTime(){var e;const t=null==(e=M(this,ds).moof.traf.tfdt)?void 0:e.baseMediaDecodeTime;if(!t)throw new Error("no baseMediaDecodeTime");return t}startsWithKeyframe(){const e=M(this,ds).moof.traf.trun,t=(null==e?void 0:e.firstSampleFlags)||(null==e?void 0:e.sampleFlags[0]);return!!t&&!!(t&Si.FLAG_SAMPLE_DEPENDS_NO)}compositionTimeOffset(e){var t;return null==(t=M(this,ds).moof.traf.trun)?void 0:t.sampleCts[e]}timescale(){const e=M(this,us).init().moov.traks[0];if(!e)throw new Error("no tracks");return e.mdia.mdhd.timescale}mediaType(){var e;const t=null==(e=M(this,us).init().moov.traks[0])?void 0:e.mdia.hdlr.mediaType();if(!t)throw new Error("no media type");return t}header(){return M(this,us)}fragment(){return M(this,ds)}samplesCount(){var e;return(null==(e=M(this,ds).moof.traf.trun)?void 0:e.samplesCount)||0}sample(e){var t,i,s,n,r,o,a,h,c,l,u,d,m,p,f;const g=null==(t=M(this,us).init().moov.traks[0])?void 0:t.mdia.minf.stbl.stsd.codec,A=(null==(i=M(this,ds).moof.traf.trun)?void 0:i.samplesCount)||0,w=null==(s=M(this,ds).moof.traf.tfdt)?void 0:s.baseMediaDecodeTime;if(e>=A||void 0===w||!g)return;const y=(null==(n=M(this,ds).moof.traf.trun)?void 0:n.sampleDurations[e])||0,v=w+((null==(r=M(this,ds).moof.traf.trun)?void 0:r.sampleDurations.slice(0,e).reduce(((e,t)=>e+t),0))||0),b=(null==(o=M(this,us).init().moov.traks[0])?void 0:o.mdia.mdhd.timescale)||1e3,S=(null==(a=M(this,ds).moof.traf.trun)?void 0:a.sampleSizes[e])||M(this,ds).mdat.data.byteLength,k=(null==(h=M(this,ds).moof.traf.trun)?void 0:h.sampleSizes.slice(0,e).reduce(((e,t)=>e+t),0))||0,E=M(this,ds).mdat.data.subarray(k,k+S),T=(null==(c=M(this,ds).moof.traf.trun)?void 0:c.is_sync_sample(e))||!1;return"video"===this.mediaType()?{type:"video",codec:g,width:(null==(l=M(this,us).init().moov.traks[0])?void 0:l.tkhd.width)||0,height:(null==(u=M(this,us).init().moov.traks[0])?void 0:u.tkhd.height)||0,duration:y,isSync:T,timescale:b,timestamp:v,data:E}:{type:"audio",codec:g,channels:(null==(m=null==(d=M(this,us).init().moov.traks[0])?void 0:d.mdia.minf.stbl.stsd.opus)?void 0:m.channelCount)||0,sampleRate:(null==(f=null==(p=M(this,us).init().moov.traks[0])?void 0:p.mdia.minf.stbl.stsd.opus)?void 0:f.sampleRate)||0,duration:y,isSync:T,timestamp:v,data:E,timescale:b}}rawBytes(){return M(this,ls)}};var fs;class gs{constructor(e){B(this,fs),U(this,fs,new ms(e))}header(){return M(this,fs)}createFragment(e){return new ps(M(this,fs),e)}}function As(e){const t=new ArrayBuffer(e.length),i=new Uint8Array(t);for(let t=0,s=e.length;t<s;t++)i[t]=e.charCodeAt(t);return new Uint8Array(t)}fs=new WeakMap;const ws={ftyp:As("ftyp"),mvhd:As("mvhd"),moov:As("moov"),trak:As("trak"),tkhd:As("tkhd"),mdia:As("mdia"),mdhd:As("mdhd"),hdlr:As("hdlr"),minf:As("minf"),vmhd:As("vmhd"),smhd:As("smhd"),dinf:As("dinf"),dref:As("dref"),stbl:As("stbl"),stsd:As("stsd"),avc1:As("avc1"),av01:As("av01"),av1C:As("av1C"),avcC:As("avcC"),esds:As("esds"),colr:As("colr"),nclx:As("nclx"),mvex:As("mvex"),trex:As("trex"),udta:As("udta"),meta:As("meta"),ilst:As("ilst"),moof:As("moof"),mfhd:As("mfhd"),traf:As("traf"),tfhd:As("tfhd"),tfdt:As("tfdt"),trun:As("trun"),mdat:As("mdat"),mp4a:As("mp4a"),Opus:As("Opus"),prft:As("prft"),dOps:As("dOps"),emsg:As("emsg")},ys=As("iso6"),vs=new Uint8Array([0,0,2,0]),bs=[ys,new Uint8Array([105,115,111,109]),new Uint8Array([105,115,111,50]),new Uint8Array([97,118,99,49]),new Uint8Array([109,112,52,49])],Ss=[ys,new Uint8Array([105,115,111,109]),new Uint8Array([105,115,111,50]),new Uint8Array([97,118,48,49]),new Uint8Array([109,112,52,49])],ks=[ys,new Uint8Array([105,115,111,109]),new Uint8Array([105,115,111,50]),new Uint8Array([109,112,52,49])];class Es{constructor(){I(this,"writer",new ge)}}const Ts=(e,t,i)=>{e.writer.writeUint32(i+8),e.writer.writeBytes(t)},Is=(e,t,i,s,n)=>{Ts(e,t,i+4),e.writer.writeUint8(s),e.writer.writeUint24(n)},Cs=(e,t)=>{Ts(e,ws.ftyp,ys.byteLength+vs.byteLength+t.reduce(((e,t)=>e+t.byteLength),0)),e.writer.writeBytes(ys),e.writer.writeBytes(vs),t.forEach((t=>e.writer.writeBytes(t)))},xs=e=>"sequenceParameterSets"in e,Ms=e=>"sequenceHeader"in e,Bs=e=>"video"==e.type,Us=e=>"audio"==e.type,Rs=(e,t,i)=>{let s=3;for(e.writer.writeUint8(t);s>0;s--)e.writer.writeUint8(i>>7*s|128);e.writer.writeUint8(127&i)},Ps=(e,t)=>{const i=e.writer.position();Ts(e,ws.minf,0),Bs(t)?(Is(e,ws.vmhd,8,0,1),e.writer.writeUint32(0),e.writer.writeUint32(0)):Us(t)&&(Is(e,ws.smhd,4,0,0),e.writer.writeUint16(0),e.writer.writeUint16(0)),(e=>{const t=e.writer.position();Ts(e,ws.dinf,0),Is(e,ws.dref,16,0,0),e.writer.writeUint32(1),Is(e,As("url "),0,0,1),e.writer.writeUint32At(t,e.writer.position()-t)})(e),((e,t)=>{const i=e.writer.position();Ts(e,ws.stbl,0);const s=e.writer.position();Is(e,ws.stsd,0,0,0),e.writer.writeUint32(1),Bs(t)?((e,t)=>{const i=e.writer.position(),s=Ms(t)?ws.av01:ws.avc1;Ts(e,s,0),e.writer.writeUint32(0),e.writer.writeUint16(0),e.writer.writeUint16(1),e.writer.writeUint16(0),e.writer.writeUint16(0),e.writer.writeUint32(0),e.writer.writeUint32(0),e.writer.writeUint32(0),e.writer.writeUint16(t.width),e.writer.writeUint16(t.height),e.writer.writeUint32(4718592),e.writer.writeUint32(4718592),e.writer.writeUint32(0),e.writer.writeUint16(1),e.writer.writeUint8(0),e.writer.writeBytes(new Uint8Array(31)),e.writer.writeUint16(24),e.writer.writeUint16(-1),xs(t)?((e,t)=>{const i=e.writer.position();Ts(e,ws.avcC,0),e.writer.writeUint8(1),e.writer.writeUint8(t.sequenceParameterSets[0][1]),e.writer.writeUint8(t.sequenceParameterSets[0][2]),e.writer.writeUint8(t.sequenceParameterSets[0][3]),e.writer.writeUint8(255),e.writer.writeUint8(224|t.sequenceParameterSets.length),t.sequenceParameterSets.forEach((t=>{e.writer.writeUint16(t.byteLength),e.writer.writeBytes(t)})),e.writer.writeUint8(t.pictureParameterSets.length),t.pictureParameterSets.forEach((t=>{e.writer.writeUint16(t.byteLength),e.writer.writeBytes(t)})),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t):Ms(t)&&(((e,t)=>{var i,s;const n=e.writer.position();Ts(e,ws.av1C,0);const{seqProfile:r,operatingPoints:o,colorConfig:a}=t.parsedSequenceHeader,h=o[0];e.writer.writeUint8(129),e.writer.writeUint8(r<<5|(null!=(i=null==h?void 0:h.seqLevelIdx)?i:0)),e.writer.writeUint8((null!=(s=null==h?void 0:h.tier)?s:0)|(a.highBitDepth?1:0)|(12===a.bitDepth?1:0)<<5|(a.monoChrome?1:0)<<4|a.subsamplingX<<3|a.subsamplingY<<2|65535&a.chromaSamplePosition),e.writer.writeUint8(0),e.writer.writeBytes(t.sequenceHeader),e.writer.writeUint32At(n,e.writer.position()-n)})(e,t),t.parsedSequenceHeader.colorConfig&&(Ts(e,As("colr"),11),e.writer.writeBytes(ws.nclx),e.writer.writeUint16(t.parsedSequenceHeader.colorConfig.colorPrimaries),e.writer.writeUint16(t.parsedSequenceHeader.colorConfig.transferCharacteristics),e.writer.writeUint16(t.parsedSequenceHeader.colorConfig.matrixCoefficients),e.writer.writeUint8(t.parsedSequenceHeader.colorConfig.colorRange?1:0))),t.pixelAspectRatio&&(Ts(e,As("pasp"),8),e.writer.writeUint32(t.pixelAspectRatio.numerator),e.writer.writeUint32(t.pixelAspectRatio.denumerator)),t.bitrate&&(Ts(e,As("btrt"),12),e.writer.writeUint32(0),e.writer.writeUint32(t.bitrate),e.writer.writeUint32(t.bitrate)),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t):Us(t)&&((e,t)=>{const i=e.writer.position();switch(Ts(e,As((e=>{switch(e){case"aac":case"mp3":return"mp4a";case"opus":return"Opus"}})(t.codec)),0),e.writer.writeUint32(0),e.writer.writeUint16(0),e.writer.writeUint16(1),e.writer.writeUint16(0),e.writer.writeUint16(0),e.writer.writeUint32(0),e.writer.writeUint16(t.channelCount),e.writer.writeUint16(16),e.writer.writeUint32(0),e.writer.writeUint16(t.sampleRate),e.writer.writeUint16(0),t.codec){case"aac":case"mp3":((e,t)=>{const i=t.decoderConfig.byteLength>0?t.decoderConfig.byteLength+5:0,s=e.writer.position();Is(e,ws.esds,0,0,0),Rs(e,3,21+i+5+1),e.writer.writeUint16(t.trackId),e.writer.writeUint8(0),Rs(e,4,13+i);const n="mp3"===t.codec&&t.sampleRate>24e3?107:64;e.writer.writeUint8(n),e.writer.writeUint8(21),e.writer.writeUint24(0),e.writer.writeUint32(t.bitrate||0),e.writer.writeUint32(t.bitrate||0),t.decoderConfig.byteLength>0&&(Rs(e,5,t.decoderConfig.byteLength),e.writer.writeBytes(t.decoderConfig)),Rs(e,6,1),e.writer.writeUint8(2),e.writer.writeUint32At(s,e.writer.position()-s)})(e,t);break;case"opus":((e,t)=>{const i=e.writer.position();Ts(e,As("dOps"),0),e.writer.writeUint8(0);const s=t.decoderConfig,n=new DataView(s.buffer,s.byteOffset,s.byteLength);e.writer.writeUint8(n.getUint8(9)),e.writer.writeUint16(n.getUint16(10,!0)),e.writer.writeUint32(n.getUint32(12,!0)),e.writer.writeUint16(n.getUint16(16,!0)),e.writer.writeBytes(t.decoderConfig.slice(18)),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t)}t.bitrate&&(Ts(e,As("btrt"),12),e.writer.writeUint32(0),e.writer.writeUint32(t.bitrate),e.writer.writeUint32(t.bitrate)),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t),e.writer.writeUint32At(s,e.writer.position()-s),Is(e,As("stts"),4,0,0),e.writer.writeUint32(0),Is(e,As("stsc"),4,0,0),e.writer.writeUint32(0),Is(e,As("stsz"),8,0,0),e.writer.writeUint32(0),e.writer.writeUint32(0),Is(e,As("stco"),4,0,0),e.writer.writeUint32(0),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t),e.writer.writeUint32At(i,e.writer.position()-i)},Ls=(e,t,i)=>{const s=e.writer.position();Ts(e,ws.trak,0),((e,t,i)=>{const s=e.writer.position();Is(e,ws.tkhd,0,0,3),e.writer.writeUint32(0),e.writer.writeUint32(0),e.writer.writeUint32(t.trackId),e.writer.writeUint32(0),e.writer.writeUint32(t.duration*i/t.timescale),e.writer.writeUint32(0),e.writer.writeUint32(0),e.writer.writeUint16(0),e.writer.writeUint16(Us(t)?1:0),e.writer.writeUint16(Us(t)?256:0),e.writer.writeUint16(0),e.writer.writeBytes(new Uint8Array([0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0])),Bs(t)?(e.writer.writeUint32(65536*t.width),e.writer.writeUint32(65536*t.height)):Us(t)&&(e.writer.writeUint32(0),e.writer.writeUint32(0)),e.writer.writeUint32At(s,e.writer.position()-s)})(e,t,i),((e,t)=>{const i=e.writer.position();Ts(e,ws.mdia,0),((e,t)=>{Is(e,ws.mdhd,20,0,0),e.writer.writeUint32(0),e.writer.writeUint32(0),e.writer.writeUint32(t.timescale),e.writer.writeUint32(t.duration);const i=t.lang||"und",s=(31&i.charCodeAt(0))<<10|(31&i.charCodeAt(1))<<5|31&i.charCodeAt(2);e.writer.writeUint16(s),e.writer.writeUint16(0)})(e,t),((e,t)=>{const i=e.writer.position();Is(e,ws.hdlr,0,0,0),e.writer.writeUint32(0),e.writer.writeBytes(As(Bs(t)?"vide":"soun")),e.writer.writeUint32(0),e.writer.writeUint32(0),e.writer.writeUint32(0),e.writer.writeBytes(As(Bs(t)?"VideoHandler\0":"SoundHandler\0")),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t),Ps(e,t),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t),e.writer.writeUint32At(s,e.writer.position()-s)},Ds=(e,t,i,s)=>{const n=e.writer.position();Ts(e,ws.moov,0),((e,t,i)=>{Is(e,ws.mvhd,96,0,0),e.writer.writeUint32(0),e.writer.writeUint32(0),e.writer.writeUint32(i),e.writer.writeUint32(0),e.writer.writeUint32(65536),e.writer.writeUint16(256),e.writer.writeBytes(new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0])),e.writer.writeUint32(2)})(e,0,i),t.forEach((t=>Ls(e,t,i))),((e,t)=>{const i=e.writer.position();Ts(e,ws.mvex,0),t.forEach((t=>((e,t)=>{Is(e,ws.trex,20,0,0),e.writer.writeUint32(t.trackId),e.writer.writeUint32(1),e.writer.writeUint32(0),e.writer.writeUint32(0),e.writer.writeUint32(0)})(e,t))),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t),e.writer.writeUint32At(n,e.writer.position()-n)},_s=e=>e.isSync?33554432:16842752,Ws=(e,t)=>{const i=e.writer.position();Ts(e,ws.moof,0),((e,t)=>{Is(e,ws.mfhd,4,0,0),e.writer.writeUint32(t)})(e,t.sequenceNumber),((e,t)=>{const i=e.writer.position();Ts(e,ws.traf,0),((e,t)=>{const i=e.writer.position();Is(e,ws.tfhd,16,0,56),e.writer.writeUint32(t.trackId),e.writer.writeUint32(t.defaultDuration||0),e.writer.writeUint32(t.defaultSize||0),e.writer.writeUint32(t.defaultFlags||0),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t),((e,t)=>{const i=e.writer.position();Is(e,ws.tfdt,8,1,0);const s=Math.floor(t.timestamp/4294967296),n=(4294967295&t.timestamp)>>>0;e.writer.writeUint32(s),e.writer.writeUint32(n),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t),((e,t)=>{if(!t.samples[0])throw new Error("At least one sample must be provided");const i=t.samples.some((e=>!!e.compositionTimeOffset)),s=_s(t.samples[0])!==t.defaultFlags,n=t.samples.length>1;let r=1;s&&(r|=4),i&&(r|=2048),n&&(r|=512,r|=256,r|=1024);const o=e.writer.position();Is(e,ws.trun,16,1,r),e.writer.writeUint32(t.samples.length);const a=e.writer.position();e.writer.writeUint32(0),s&&e.writer.writeUint32(_s(t.samples[0]));for(const s of t.samples)n&&(e.writer.writeUint32(s.duration),e.writer.writeUint32(s.data.byteLength),e.writer.writeUint32(_s(s))),i&&e.writer.writeUint32(s.compositionTimeOffset||0);e.writer.writeUint32At(a,e.writer.position()+8),e.writer.writeUint32At(o,e.writer.position()-o)})(e,t),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t),e.writer.writeUint32At(i,e.writer.position()-i)},Os=(e,t)=>{const i=new Es,s=e.filter((e=>Bs(e)&&xs(e))).length>0;return e.filter((e=>Bs(e)&&Ms(e))).length>0?Cs(i,Ss):Cs(i,s?bs:ks),Ds(i,e,1e3),i.writer.buffer()},Fs=e=>{const t=new Es;return Ws(t,e),((e,t)=>{const i=t.samples.reduce(((e,t)=>e+t.data.byteLength),0);Ts(e,ws.mdat,i),t.samples.forEach((t=>e.writer.writeBytes(t.data)))})(t,e),t.writer.buffer()},Vs=e=>{const{sequenceParameterSets:t,pictureParameterSets:i}=li(e),s=t[0],n=i[0];if(!s||!n)throw new Error("No sps or pps provided");return(e=>{var t;const i=new DataView(e),s=i.getUint8(1),n=i.getUint8(2),r=i.getUint8(3),o=new K(e,32);o.readUnsignedExpGolomb();let a=1;switch(s){case 100:case 110:case 122:case 244:case 44:case 83:case 86:case 118:case 128:case 138:case 144:if(a=o.readUnsignedExpGolomb(),3===a&&o.readBits(1),o.readUnsignedExpGolomb(),o.readUnsignedExpGolomb(),o.readBit(),o.readBit())for(let e=0;e<(3!=a?8:12);e++)if(o.readBit()){const t=e<6?16:64;let i=0,s=8,n=8;for(let e=0;e<t;e++)0!=n&&(i=o.readSignedExpGolomb(),n=(s+i+256)%256),s=0==n?s:n}}o.readUnsignedExpGolomb();const h=o.readUnsignedExpGolomb();if(0==h)o.readUnsignedExpGolomb();else if(1==h)throw new Error("Unhandled case");o.readUnsignedExpGolomb(),o.readBit();const c=o.readUnsignedExpGolomb(),l=o.readUnsignedExpGolomb(),u=o.readBit();0===u&&o.readBit(),o.readBit();let d=c+1,m=l+1;if(m*=2-u,m*=16,d*=16,o.readBit()){const e=1<<(1==a||2==a?1:0),t=2-u<<(1==a?1:0);d-=o.readUnsignedExpGolomb()*e+o.readUnsignedExpGolomb()*e,m-=o.readUnsignedExpGolomb()*t+o.readUnsignedExpGolomb()*t}let p={numerator:1,denumerator:1};return o.readBit()&&o.readBit()&&(p=null!=(t=ui[o.readBits(8)])?t:{numerator:0,denumerator:0}),{width:d,height:m,pixelAspectRatio:p,profileIdc:s,constraintFlags:n,levelIdc:r}})(s)},Ns=e=>{const t=new K(e);return 1===t.peekBit()&&t.readBits(32),js(t),Gs(t)},js=e=>{const t=e.readBits(8);if(t>>7&1)return;const i=t>>3&15,s=t>>2&1,n=t>>1&1;return 1==s&&e.readBits(8),1==n&&(e=>{let t=0;for(let i=0;i<8;i++){const s=e.readBits(8);if(t|=(127&s)<<7*i,128&~s)break}})(e),{headerLength:1+s,type:i}},Gs=e=>{const t=e.readBits(3),i=0!==e.readBit(),s=0!==e.readBit();let n,r=!1,o=!1,a=!1,h=0,c=0;const l=[];if(s)e.readBits(5);else{if(o=0!==e.readBit(),o&&(n=(e=>{const t=e.readBits(32),i=e.readBits(32),s=0!==e.readBit();let n=0;return s&&(n=(e=>{let t=0;for(;t<100&&0===e.readBit();)t++;return t>=32?0:e.readBits(t)+(1<<t)-1})(e)+1),{timescale:i,equalPictureInterval:s,numUnitsInDisplayTick:t,numTicksPerPicture:n}})(e),r=0!==e.readBit(),r))throw new Error("Not implemented");a=0!==e.readBit();const t=e.readBits(5)+1;for(let i=0;i<t;i++){const t=e.readBits(12),i=e.readBits(5);let s=0;if(i>7&&(s=e.readBit()),r)throw new Error("decoderModelInfoPresentFlag==1");a&&0!==e.readBit()&&e.readBits(4),l.push({tier:s,operatingPointIdc:t,seqLevelIdx:i})}}const u=e.readBits(4)+1,d=e.readBits(4)+1,m=e.readBits(u)+1,p=e.readBits(d)+1;let f=!1;f=!s&&0!==e.readBit(),f&&(h=e.readBits(4)+2,c=e.readBits(3)+1);const g=0!==e.readBit(),A=0!==e.readBit(),w=0!==e.readBit();let y=!1,v=!1,b=!1,S=!1,k=!1,E=!1,T=!1,I=2,C=2,x=0;return s||(y=0!==e.readBit(),v=0!==e.readBit(),b=0!==e.readBit(),S=0!==e.readBit(),k=0!==e.readBit(),k&&(E=0!==e.readBit(),T=0!==e.readBit()),I=0!==e.readBit()?2:e.readBit(),C=I>0?e.readBit()>0?2:e.readBit():2,x=k?e.readBits(3):0),{seqProfile:t,stillPicture:i,reducedStillPictureHeader:s,timingInfoPresentFlag:o,timingInfo:null!=n?n:{equalPictureInterval:!1,numUnitsInDisplayTick:0,timescale:0,numTicksPerPicture:0},decoderModelInfoPresentFlag:r,initialDisplayDelayPresentFlag:a,operatingPoints:l,frameWidthBits:u,frameHeightBits:d,maxFrameWidth:m,maxFrameHeight:p,frameIdNumbersPresentFlag:f,deltaFrameIdLength:h,additionalFrameIdLength:c,use_128x128Superblock:g,enableFilterIntra:A,enableIntraEdgeFilter:w,enableInterintraCompound:y,enableMaskedCompound:v,enableWarpedMotion:b,enableDualFilter:S,enableOrderHint:k,enableJntComp:E,enableRefFrameMvs:T,seqForceScreenContentTools:I,seqForceIntegerMv:C,orderHintBits:x,enableSuperres:0!==e.readBit(),enableCdef:0!==e.readBit(),enableRestoration:0!==e.readBit(),colorConfig:zs(e,t),filmGrainParamsPresent:0!==e.readBit()}},zs=(e,t)=>{const i=0!==e.readBit();let s=8,n=!1;2===t&&i?s=0!==e.readBit()?12:10:t<=2&&(s=i?10:8),n=1!==t&&0!==e.readBit();const r=n?1:3;let o=2,a=2,h=2,c=!1,l=0,u=0,d=0,m=!1;return 0!==e.readBit()&&(o=e.readBits(8),a=e.readBits(8),h=e.readBits(8)),n?(c=0!==e.readBit(),l=1,u=1,d=0,m=!1,{highBitDepth:i,bitDepth:s,monoChrome:n,chromaSamplePosition:d,colorPrimaries:o,colorRange:c,matrixCoefficients:h,numPlanes:r,separateUvDeltaQ:m,subsamplingX:l,subsamplingY:u,transferCharacteristics:a}):1===o&&13==a&&0==h?(c=!0,l=0,u=0,{highBitDepth:i,bitDepth:s,monoChrome:n,chromaSamplePosition:d,colorPrimaries:o,colorRange:c,matrixCoefficients:h,numPlanes:r,separateUvDeltaQ:m,subsamplingX:l,subsamplingY:u,transferCharacteristics:a}):(c=0!==e.readBit(),0===t?(l=1,u=1):1===t?(l=0,u=0):12===s?(l=e.readBit(),u=0!==l?e.readBit():0):(l=1,u=0),0!==l&&0!==u&&(d=e.readBits(2)),m=0!==e.readBit(),{highBitDepth:i,bitDepth:s,monoChrome:n,chromaSamplePosition:d,colorPrimaries:o,colorRange:c,matrixCoefficients:h,numPlanes:r,separateUvDeltaQ:m,subsamplingX:l,subsamplingY:u,transferCharacteristics:a})},Qs=e=>!!(1&e),Hs=()=>"wakeLock"in navigator&&-1===window.navigator.userAgent.indexOf("Samsung");class Xs{constructor(){I(this,"enabled",!1),I(this,"wakeLockVideo"),I(this,"_wakeLock",null),I(this,"handleVisibilityChange",(()=>{null!==this._wakeLock&&"visible"===document.visibilityState&&this.enable()})),Hs()&&(this._wakeLock=null,document.addEventListener("visibilitychange",this.handleVisibilityChange),document.addEventListener("fullscreenchange",this.handleVisibilityChange))}_addSourceToVideo(e,t,i){const s=document.createElement("source");s.src=i,s.type=`video/${t}`,e.appendChild(s)}get isEnabled(){return this.enabled}attach(e){if(!Hs()){if(!this.wakeLockVideo){const e=document.createElement("video");this.wakeLockVideo=e,this.wakeLockVideo.setAttribute("title","Live Stream"),this.wakeLockVideo.setAttribute("playsinline",""),this._addSourceToVideo(this.wakeLockVideo,"mp4","data:video/mp4;base64,AAAAHGZ0eXBNNFYgAAACAGlzb21pc28yYXZjMQAAAAhmcmVlAAAGF21kYXTeBAAAbGliZmFhYyAxLjI4AABCAJMgBDIARwAAArEGBf//rdxF6b3m2Ui3lizYINkj7u94MjY0IC0gY29yZSAxNDIgcjIgOTU2YzhkOCAtIEguMjY0L01QRUctNCBBVkMgY29kZWMgLSBDb3B5bGVmdCAyMDAzLTIwMTQgLSBodHRwOi8vd3d3LnZpZGVvbGFuLm9yZy94MjY0Lmh0bWwgLSBvcHRpb25zOiBjYWJhYz0wIHJlZj0zIGRlYmxvY2s9MTowOjAgYW5hbHlzZT0weDE6MHgxMTEgbWU9aGV4IHN1Ym1lPTcgcHN5PTEgcHN5X3JkPTEuMDA6MC4wMCBtaXhlZF9yZWY9MSBtZV9yYW5nZT0xNiBjaHJvbWFfbWU9MSB0cmVsbGlzPTEgOHg4ZGN0PTAgY3FtPTAgZGVhZHpvbmU9MjEsMTEgZmFzdF9wc2tpcD0xIGNocm9tYV9xcF9vZmZzZXQ9LTIgdGhyZWFkcz02IGxvb2thaGVhZF90aHJlYWRzPTEgc2xpY2VkX3RocmVhZHM9MCBucj0wIGRlY2ltYXRlPTEgaW50ZXJsYWNlZD0wIGJsdXJheV9jb21wYXQ9MCBjb25zdHJhaW5lZF9pbnRyYT0wIGJmcmFtZXM9MCB3ZWlnaHRwPTAga2V5aW50PTI1MCBrZXlpbnRfbWluPTI1IHNjZW5lY3V0PTQwIGludHJhX3JlZnJlc2g9MCByY19sb29rYWhlYWQ9NDAgcmM9Y3JmIG1idHJlZT0xIGNyZj0yMy4wIHFjb21wPTAuNjAgcXBtaW49MCBxcG1heD02OSBxcHN0ZXA9NCB2YnZfbWF4cmF0ZT03NjggdmJ2X2J1ZnNpemU9MzAwMCBjcmZfbWF4PTAuMCBuYWxfaHJkPW5vbmUgZmlsbGVyPTAgaXBfcmF0aW89MS40MCBhcT0xOjEuMDAAgAAAAFZliIQL8mKAAKvMnJycnJycnJycnXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXiEASZACGQAjgCEASZACGQAjgAAAAAdBmjgX4GSAIQBJkAIZACOAAAAAB0GaVAX4GSAhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZpgL8DJIQBJkAIZACOAIQBJkAIZACOAAAAABkGagC/AySEASZACGQAjgAAAAAZBmqAvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZrAL8DJIQBJkAIZACOAAAAABkGa4C/AySEASZACGQAjgCEASZACGQAjgAAAAAZBmwAvwMkhAEmQAhkAI4AAAAAGQZsgL8DJIQBJkAIZACOAIQBJkAIZACOAAAAABkGbQC/AySEASZACGQAjgCEASZACGQAjgAAAAAZBm2AvwMkhAEmQAhkAI4AAAAAGQZuAL8DJIQBJkAIZACOAIQBJkAIZACOAAAAABkGboC/AySEASZACGQAjgAAAAAZBm8AvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZvgL8DJIQBJkAIZACOAAAAABkGaAC/AySEASZACGQAjgCEASZACGQAjgAAAAAZBmiAvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZpAL8DJIQBJkAIZACOAAAAABkGaYC/AySEASZACGQAjgCEASZACGQAjgAAAAAZBmoAvwMkhAEmQAhkAI4AAAAAGQZqgL8DJIQBJkAIZACOAIQBJkAIZACOAAAAABkGawC/AySEASZACGQAjgAAAAAZBmuAvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZsAL8DJIQBJkAIZACOAAAAABkGbIC/AySEASZACGQAjgCEASZACGQAjgAAAAAZBm0AvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZtgL8DJIQBJkAIZACOAAAAABkGbgCvAySEASZACGQAjgCEASZACGQAjgAAAAAZBm6AnwMkhAEmQAhkAI4AhAEmQAhkAI4AhAEmQAhkAI4AhAEmQAhkAI4AAAAhubW9vdgAAAGxtdmhkAAAAAAAAAAAAAAAAAAAD6AAABDcAAQAAAQAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAwAAAzB0cmFrAAAAXHRraGQAAAADAAAAAAAAAAAAAAABAAAAAAAAA+kAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAALAAAACQAAAAAAAkZWR0cwAAABxlbHN0AAAAAAAAAAEAAAPpAAAAAAABAAAAAAKobWRpYQAAACBtZGhkAAAAAAAAAAAAAAAAAAB1MAAAdU5VxAAAAAAALWhkbHIAAAAAAAAAAHZpZGUAAAAAAAAAAAAAAABWaWRlb0hhbmRsZXIAAAACU21pbmYAAAAUdm1oZAAAAAEAAAAAAAAAAAAAACRkaW5mAAAAHGRyZWYAAAAAAAAAAQAAAAx1cmwgAAAAAQAAAhNzdGJsAAAAr3N0c2QAAAAAAAAAAQAAAJ9hdmMxAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAALAAkABIAAAASAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGP//AAAALWF2Y0MBQsAN/+EAFWdCwA3ZAsTsBEAAAPpAADqYA8UKkgEABWjLg8sgAAAAHHV1aWRraEDyXyRPxbo5pRvPAyPzAAAAAAAAABhzdHRzAAAAAAAAAAEAAAAeAAAD6QAAABRzdHNzAAAAAAAAAAEAAAABAAAAHHN0c2MAAAAAAAAAAQAAAAEAAAABAAAAAQAAAIxzdHN6AAAAAAAAAAAAAAAeAAADDwAAAAsAAAALAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAAiHN0Y28AAAAAAAAAHgAAAEYAAANnAAADewAAA5gAAAO0AAADxwAAA+MAAAP2AAAEEgAABCUAAARBAAAEXQAABHAAAASMAAAEnwAABLsAAATOAAAE6gAABQYAAAUZAAAFNQAABUgAAAVkAAAFdwAABZMAAAWmAAAFwgAABd4AAAXxAAAGDQAABGh0cmFrAAAAXHRraGQAAAADAAAAAAAAAAAAAAACAAAAAAAABDcAAAAAAAAAAAAAAAEBAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAkZWR0cwAAABxlbHN0AAAAAAAAAAEAAAQkAAADcAABAAAAAAPgbWRpYQAAACBtZGhkAAAAAAAAAAAAAAAAAAC7gAAAykBVxAAAAAAALWhkbHIAAAAAAAAAAHNvdW4AAAAAAAAAAAAAAABTb3VuZEhhbmRsZXIAAAADi21pbmYAAAAQc21oZAAAAAAAAAAAAAAAJGRpbmYAAAAcZHJlZgAAAAAAAAABAAAADHVybCAAAAABAAADT3N0YmwAAABnc3RzZAAAAAAAAAABAAAAV21wNGEAAAAAAAAAAQAAAAAAAAAAAAIAEAAAAAC7gAAAAAAAM2VzZHMAAAAAA4CAgCIAAgAEgICAFEAVBbjYAAu4AAAADcoFgICAAhGQBoCAgAECAAAAIHN0dHMAAAAAAAAAAgAAADIAAAQAAAAAAQAAAkAAAAFUc3RzYwAAAAAAAAAbAAAAAQAAAAEAAAABAAAAAgAAAAIAAAABAAAAAwAAAAEAAAABAAAABAAAAAIAAAABAAAABgAAAAEAAAABAAAABwAAAAIAAAABAAAACAAAAAEAAAABAAAACQAAAAIAAAABAAAACgAAAAEAAAABAAAACwAAAAIAAAABAAAADQAAAAEAAAABAAAADgAAAAIAAAABAAAADwAAAAEAAAABAAAAEAAAAAIAAAABAAAAEQAAAAEAAAABAAAAEgAAAAIAAAABAAAAFAAAAAEAAAABAAAAFQAAAAIAAAABAAAAFgAAAAEAAAABAAAAFwAAAAIAAAABAAAAGAAAAAEAAAABAAAAGQAAAAIAAAABAAAAGgAAAAEAAAABAAAAGwAAAAIAAAABAAAAHQAAAAEAAAABAAAAHgAAAAIAAAABAAAAHwAAAAQAAAABAAAA4HN0c3oAAAAAAAAAAAAAADMAAAAaAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAACMc3RjbwAAAAAAAAAfAAAALAAAA1UAAANyAAADhgAAA6IAAAO+AAAD0QAAA+0AAAQAAAAEHAAABC8AAARLAAAEZwAABHoAAASWAAAEqQAABMUAAATYAAAE9AAABRAAAAUjAAAFPwAABVIAAAVuAAAFgQAABZ0AAAWwAAAFzAAABegAAAX7AAAGFwAAAGJ1ZHRhAAAAWm1ldGEAAAAAAAAAIWhkbHIAAAAAAAAAAG1kaXJhcHBsAAAAAAAAAAAAAAAALWlsc3QAAAAlqXRvbwAAAB1kYXRhAAAAAQAAAABMYXZmNTUuMzMuMTAw"),Object.assign(this.wakeLockVideo.style,{position:"absolute",left:"-100%",top:"-100%"}),this.wakeLockVideo.addEventListener("loadedmetadata",(()=>{e.addEventListener("timeupdate",(()=>{e.currentTime>.5&&(e.currentTime=Math.random())}))}))}e&&e.appendChild(this.wakeLockVideo)}}enable(){return L(this,null,(function*(){var e,t;return Hs()?navigator.wakeLock.request("screen").then((e=>{this._wakeLock=e,this.enabled=!0,this._wakeLock.addEventListener("release",(()=>{}))})).catch((()=>{this.enabled=!1})):(null!=(t=null==(e=this.wakeLockVideo)?void 0:e.play())?t:Promise.resolve()).then((e=>(this.enabled=!0,e))).catch((()=>{this.enabled=!1}))}))}disable(){var e,t;Hs()?(this._wakeLock&&this._wakeLock.release(),this._wakeLock=null):(null==(e=this.wakeLockVideo)||e.pause(),null==(t=this.wakeLockVideo)||t.remove()),this.enabled=!1}unload(){document.removeEventListener("visibilitychange",this.handleVisibilityChange),document.removeEventListener("fullscreenchange",this.handleVisibilityChange),this.disable()}}const qs=/\r\n|\r|\n/;var Zs,Js,$s,Ys,Ks;class en{constructor(e){B(this,Zs),B(this,Js),U(this,Zs,e),U(this,Js,0)}skipEmptyLines(){let e=0;for(;""===M(this,Zs)[M(this,Js)];)P(this,Js)._++,e++;return e}readLine(){return M(this,Zs)[P(this,Js)._++]}takeUntilEmptyLine(){const e=[];for(;""!==M(this,Zs)[M(this,Js)];){const t=this.readLine();if(void 0===t)break;e.push(t)}return e}linesLeft(){return M(this,Zs).length-M(this,Js)}}Zs=new WeakMap,Js=new WeakMap;class tn{constructor(){B(this,$s)}parse(e){const t=[],i=e.split(qs),s=new en(i),n=s.readLine();if(!n||!n.startsWith("WEBVTT"))throw new Error("missing 'WEBVTT' signature");for(;""!==s.readLine(););for(;s.linesLeft()>0;){const e=R(this,$s,Ys).call(this,s);t.push(e),s.skipEmptyLines()}return t}}$s=new WeakSet,Ys=function(e){e.skipEmptyLines();const t=e.takeUntilEmptyLine(),i=new en(t);let s,n=i.readLine();if(null!=n&&n.includes("--\x3e")||(s=n,n=i.readLine()),void 0===n)throw new Error("expected cue line");const[r,o]=n.split("--\x3e").map((e=>e.trim()));if(!r||!o)throw new Error(`a cue needs both start and end time start: ${r} end: ${o}`);const[a,h]=o.split(" ",1).map((e=>e.trim()));if(!a)throw new Error(`missing end time: ${a}`);const c=i.readLine();if(!c)throw new Error("missing text");return{id:s,startTime:R(this,$s,Ks).call(this,r),endTime:R(this,$s,Ks).call(this,a),text:c}},Ks=function(e){const t=e.split(":");if(2==t.length){const[e=0,i=0]=t.map((e=>parseFloat(e)));return 60*e+i}const[i=0,s=0,n=0]=t.map((e=>parseFloat(e)));return 60*i*60+60*s+n};class sn extends s.E{constructor({type:e,autoplay:t,muted:i,logger:s,poster:n}){super(),I(this,"element"),I(this,"logger"),I(this,"seekTimes",new z(10)),I(this,"seekStartTime"),I(this,"_userProvidedMuted"),I(this,"timers",new qe),I(this,"_userHasProvidedInput",!1),I(this,"_isPaused",!0),I(this,"isActivated",!1),I(this,"dummy"),I(this,"_iosHackEnterPiPMode",(()=>{const e=this.element.parentElement,t=this.element.clientWidth/this.element.clientHeight;this.element.style.position="fixed",this.element.style.opacity="0",this.element.style.pointerEvents="none",e&&(this.dummy=document.createElement("video"),this.dummy.style.paddingBottom="calc(100% / "+t+")",this.dummy.style.width="100%",this.dummy.style.height="0px",e.appendChild(this.dummy))})),I(this,"_iosHackExitPiPMode",(()=>{this.element.style.position="relative",this.element.style.opacity="1",this.element.style.pointerEvents="auto",this.dummy&&(this.dummy.remove(),this.dummy=void 0)})),I(this,"attach",(e=>{this.element.remove(),e.appendChild(this.element)})),I(this,"load",(()=>{this.timers.setInterval(this.onPlayPause,500),this.timers.setTimeout((()=>{this.timers.setInterval(this.onBufferStateChange,500)}),1e4)})),I(this,"unload",(()=>{this.timers.unload()})),I(this,"getPlaybackRate",(()=>this.element.playbackRate)),I(this,"getPlaybackState",(()=>this.element.readyState>=this.element.HAVE_FUTURE_DATA?"playing":"buffering")),I(this,"setPlaybackRate",(e=>{this.element.playbackRate=e})),I(this,"getBuffer",(()=>{const e=[],t=this.element.buffered;if(!t)return[];for(let i=0;i<t.length;i++)e.push({start:1e3*t.start(i),end:1e3*t.end(i)});return e})),I(this,"pause",(()=>{this._isPaused=!1,this.element.pause()})),I(this,"tryPlay",(()=>{this.element.muted=this._userProvidedMuted,this._play().catch(j)})),I(this,"play",(()=>{this.element.muted=this._userProvidedMuted,this._play().catch((e=>{if(e instanceof Error){const t=new at("Media Play Error",{source:e,isFatal:!1,code:"media_play_error"});this.emit("error",t)}}))})),I(this,"_play",(()=>L(this,null,(function*(){try{yield this.element.play(),this._userHasProvidedInput=!this.muted||this._userProvidedMuted}catch(e){if(!(e instanceof Error&&"NotAllowedError"===e.name))throw e;if(this._userHasProvidedInput=!1,!this.element.muted)return this.element.muted=!0,this.emit("needs user input",{forAudio:!0,forVideo:!1}),this._play();this.emit("needs user input",{forAudio:!0,forVideo:!0})}})))),I(this,"onEvent",(e=>{this.logger.trace(e.type,{state:this.element.readyState,event:e,playbackState:this.getPlaybackState()})})),I(this,"onVolumeChange",(()=>{this.logger.info("volume state",{isMuted:this.element.muted,volume:this.element.volume}),this.emit("volume state",{isMuted:this.element.muted,volume:this.element.volume})})),I(this,"onPlayPause",(()=>{this._isPaused!==this.element.paused&&(this._isPaused=this.element.paused,this.logger.info("player pause change",{paused:this.element.paused}),this.emit("media element state",this.element.paused?"paused":"playing"))})),I(this,"onBufferStateChange",(()=>{this.emit("buffer state",{isPaused:this.element.paused,buffered:this.getBuffer(),currentTime:this.currentTime,playbackState:this.getPlaybackState()})})),I(this,"onSeekStart",(()=>{this.seekStartTime=Date.now()})),I(this,"onSeekEnd",(()=>{this.seekStartTime&&(this.seekTimes.push(Date.now()-this.seekStartTime),this.seekStartTime=void 0)})),this.logger=s,this._userProvidedMuted=i,this.element=document.createElement(e),this.element instanceof HTMLVideoElement&&(this.element.playsInline=!0),this.element.controls=!1,this.element.autoplay=t,this.element.muted=i,this.element.style.display="block",this.element.style.width="100%",this.element.disableRemotePlayback=!0,this.element.setAttribute("poster","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAJCAQAAACRI2S5AAAAEElEQVR42mNkIAAYRxWAAQAG9gAKqv6+AwAAAABJRU5ErkJggg=="),this.onPlayPause(),setTimeout((()=>{!this.element||!n||this.element.setAttribute("poster",n)}),0),this.element.addEventListener("stalled",this.onEvent),this.element.addEventListener("canplay",this.onEvent),this.element.addEventListener("loadeddata",this.onEvent),this.element.addEventListener("loadedmetadata",this.onEvent),this.element.addEventListener("canplaythrough",this.onEvent),this.element.addEventListener("waiting",this.onEvent),this.element.addEventListener("playing",this.onPlayPause),this.element.addEventListener("pause",this.onPlayPause),this.element.addEventListener("seeked",this.onSeekEnd),this.element.addEventListener("seeking",this.onSeekStart),this.element.addEventListener("volumechange",this.onVolumeChange),this.element.addEventListener("timeupdate",this.onBufferStateChange),this.element.addEventListener("progress",this.onBufferStateChange)}get seekTime(){return this.seekTimes.isEmpty()?0:we(this.seekTimes.items())}get isSeeking(){return this.element.seeking}get currentTime(){return isNaN(this.element.currentTime)?0:1e3*this.element.currentTime}set currentTime(e){Number.isFinite(e)&&(this.element.currentTime=e/1e3)}get playbackRate(){return this.element.playbackRate}set playbackRate(e){this.element.playbackRate=e}get volume(){return this.element.volume}set volume(e){this.element.volume=e}get muted(){return this.element.muted}set muted(e){this._userProvidedMuted=e,this.element.muted=e}get userHasProvidedInput(){return this._userHasProvidedInput}get isPaused(){return this._isPaused}}const nn=["minBufferTime","maxBufferTime","burstEnabled","sizeBasedResolutionCapEnabled","separateVideoSocketEnabled","videoCodecs"];class rn{constructor(e){I(this,"options"),I(this,"overrides",new Map),this.options=e}getOptions(){return this.options}addOverrides(e,t){this.overrides.set(e,t)}set(e,t){this.options[e]=t}get(e,t){var i,s;if(t&&(s=e,nn.includes(s))){const s=null==(i=this.overrides.get(t))?void 0:i[e];if(void 0!==s)return s}return this.options[e]}getOverride(e,t){var i;return null==(i=this.overrides.get(t))?void 0:i[e]}}const on={cooldownTime:3e3,maxBufferingEvents:{last10Seconds:0},maxBufferingRatio:{last10Seconds:0},maxRecentDowngradesCount:3,maxDowngradeLookbackMs:6e4,minTimeSpentPlaying:{factor:.5,ratio:.1},maxCooldownRatio:2},an=e=>t=>t>e,hn=class{constructor(e,t,i,s){I(this,"qualityOfServiceSource"),I(this,"config"),I(this,"emitter"),I(this,"logger"),I(this,"isSuspended",!1),I(this,"lastAdaptTime",Date.now()),I(this,"isEnabled",!0),I(this,"load",(()=>{this.emitter.on("buffer state",this.onBufferState),this.emitter.on("adapted level",this.onAdaptedLevel)})),I(this,"unload",(()=>{this.emitter.off("buffer state",this.onBufferState),this.emitter.off("adapted level",this.onAdaptedLevel)})),I(this,"suspend",(()=>{this.isSuspended=!0})),I(this,"unsuspend",(()=>{this.reset(),this.isSuspended=!1})),I(this,"reset",((e=0)=>{this.lastAdaptTime=Date.now()+e})),I(this,"getStatistics",(()=>({isAbrEnabled:this.isEnabled}))),I(this,"isQoSOk",(e=>{const t=this.qualityOfServiceSource.getLevelStats(e),{upgradesFromLevel:i,downgradesFromLevel:s}=null!=t?t:{upgradesFromLevel:[],downgradesFromLevel:[]},n=Date.now()-this.config.maxDowngradeLookbackMs,r=s.filter(an(n)).length,o=i.filter(an(n)).length;if(r-o>this.config.maxRecentDowngradesCount)return this.logger.debug("Recent downgrades count is over maximum",{downgrades:r-o,maxRecentDowngradesCount:this.config.maxRecentDowngradesCount}),!1;const a=this.qualityOfServiceSource.timeSpentPlayingInAtLeastLevelRatio(e),h=a*(this.qualityOfServiceSource.timeActive()-this.qualityOfServiceSource.timeSpentBuffering())/this.config.maxDowngradeLookbackMs;if(r>1&&h<this.config.minTimeSpentPlaying.factor)return this.logger.debug("Time spent playing is too low",{recentDowngrades:r,timeSpentPlayingInAtLeastLevelRatio:a}),!1;if(r>1&&a<this.config.minTimeSpentPlaying.ratio)return this.logger.debug("Time spent playing in at least this level is too low",{recentDowngrades:r,timeSpentPlayingInAtLeastLevelRatio:a}),!1;const c=Math.max(0,s.length-i.length-h),l=Date.now()-this.config.maxDowngradeLookbackMs*c,u=s.filter(an(l)).length;return!(u&&c>this.config.maxCooldownRatio&&(this.logger.debug("Too many downgrades compared to time spent playing",{downgradesWithinCooldownTime:u,cooldownRatio:c}),1))})),I(this,"onBufferState",(e=>{if(!this.isEnabled||this.isSuspended||this.lastAdaptTime+this.config.cooldownTime>Date.now())return;const{bufferFullness:t,general:i}=this.qualityOfServiceSource.getMetrics(),s=this.qualityOfServiceSource.getBufferFullnessRegression();if(!s)return;const{slope:n}=s,r=s.predict(15),o=n<0,a=s.predict(15)<.4&&s.slope<0,h=s.predict(15)>.6,c=this.qualityOfServiceSource.timeSpentBufferingLast(3e4),l=this.qualityOfServiceSource.timeSpentActiveLast(3e4);t<.15&&c/l>.8?this.adaptLevel("reconnect"):i.decodeRate<=1?this.adaptLevel("downgrade"):a||t<.15?o&&t<.4&&r<.2&&this.adaptLevel("buffering"===e.playbackState?"double downgrade":"downgrade"):t>.5&&h&&!this.tooMuchTimeBuffering(1e4)&&!this.tooManyBufferingEvents(1e4)&&this.adaptLevel("upgrade")})),I(this,"onAdaptedLevel",(()=>{this.reset()})),I(this,"adaptLevel",(e=>this.emitter.emit("adapt level",e))),this.qualityOfServiceSource=i,this.config=g(g({},on),s),this.emitter=e,this.logger=t}tooMuchTimeBuffering(e){return this.qualityOfServiceSource.timeSpentBufferingLast(e)/this.qualityOfServiceSource.timeSpentActiveLast(e)>this.config.maxBufferingRatio.last10Seconds}tooManyBufferingEvents(e){return this.qualityOfServiceSource.timeSpentBufferingLast(e)>this.config.maxBufferingEvents.last10Seconds}};I(hn,"create",((e,t,i,s={})=>new hn(e,t,i,s)));let cn=hn;const ln={minBufferTime:1500,maxBufferTime:1500,cooldownTime:3e4,maxBufferingEvents:{last30Seconds:3},maxBufferingRatio:{last30Seconds:.15}},un=class e{constructor(t,i,s,n,r){I(this,"qualityOfServiceSource"),I(this,"targetBufferTimeTarget"),I(this,"config"),I(this,"emitter"),I(this,"logger"),I(this,"isSuspended",!1),I(this,"lastIncreaseTime",Date.now()),I(this,"bufferTimeAdjustmentCount",0),I(this,"load",(()=>{this.emitter.on("buffer state",this.onBufferState)})),I(this,"unload",(()=>{this.emitter.off("buffer state",this.onBufferState)})),I(this,"suspend",(()=>{this.isSuspended=!0})),I(this,"unsuspend",(()=>{this.reset(),this.isSuspended=!1})),I(this,"reset",(()=>{this.lastIncreaseTime=Date.now()})),I(this,"getStatistics",(()=>({bufferTimeAdjustmentCount:this.bufferTimeAdjustmentCount}))),I(this,"onBufferState",(t=>{const{minBufferTime:i,maxBufferTime:s,cooldownTime:n}=this.config;if(this.isSuspended||this.lastIncreaseTime+n>Date.now()||this.targetBufferTimeTarget.targetBufferTime>=s)return;const r=this.qualityOfServiceSource.timeSpentBufferingLast(3e4),o=this.qualityOfServiceSource.bufferingEventsLast(3e4),a=r/this.qualityOfServiceSource.timeSpentActiveLast(3e4),h=Math.ceil(Math.max((s-i)/(e.BUFFER_TIME_MAX_STEPS-1),e.BUFFER_TIME_STEP_SIZE));(a>this.config.maxBufferingRatio.last30Seconds||o>this.config.maxBufferingEvents.last30Seconds)&&(this.targetBufferTimeTarget.targetBufferTime=Math.min(s,this.targetBufferTimeTarget.targetBufferTime+h),this.bufferTimeAdjustmentCount++,this.reset())})),this.qualityOfServiceSource=s,this.targetBufferTimeTarget=n,this.config=g(g({},ln),r),this.emitter=t,this.logger=i}updateConfig(e){this.config=g(g({},this.config),e)}};I(un,"BUFFER_TIME_STEP_SIZE",500),I(un,"BUFFER_TIME_MAX_STEPS",3),I(un,"create",((e,t,i,s,n={})=>new un(e,t,i,s,n)));let dn=un;var mn=(e=>(e[e.StreamHeaderGroup=4]="StreamHeaderGroup",e[e.FetchHeader=5]="FetchHeader",e[e.StreamHeaderTrack=60]="StreamHeaderTrack",e))(mn||{});function pn(e){switch(e){case 0:case 1:case 2:case 3:case 4:return}throw new Error("Unknown object status "+e)}var fn,gn,An,wn,yn,vn,bn,Sn,kn,En,Tn,In,Cn,xn,Mn,Bn,Un,Rn,Pn,Ln,Dn,_n,Wn,On,Fn,Vn,Nn,jn,Gn,zn,Qn,Hn,Xn,qn,Zn,Jn,$n,Yn,Kn,er,tr,ir,sr,nr,rr,or,ar,hr,cr;class lr{constructor(e,t,i,s,n,r){B(this,fn),B(this,gn),B(this,An),B(this,wn),B(this,yn),B(this,vn,new G),B(this,bn,0),B(this,Sn),U(this,fn,e),U(this,gn,t),U(this,An,i),U(this,wn,s),U(this,yn,n),U(this,Sn,r)}endStatus(){return M(this,vn).promise}groupId(){return M(this,gn)}subscribeId(){return M(this,An)}next(){return L(this,null,(function*(){if(!M(this,vn).pending)return{done:!0,value:void 0};if(yield M(this,fn).isDone())return{done:!0,value:void 0};const e=0===M(this,bn)?M(this,gn):yield M(this,fn).readBigVarInt(),t=yield M(this,fn).readBigVarInt(),i=yield M(this,fn).readVarInt();let s=0,n=new Uint8Array;return i>0?n=yield M(this,fn).read(i):s=yield M(this,fn).readVarInt(),pn(s),(4===s||3===s)&&M(this,vn).resolve(s),P(this,bn)._++,{done:!1,value:{subscribeId:M(this,An),trackAlias:M(this,wn),groupId:e,subGroupId:Y(0),objectId:t,subscriberPriority:M(this,yn),streamId:M(this,Sn),objectStatus:s,payload:n}}}))}return(){return L(this,null,(function*(){for(;!(yield this.next()).done;);return{done:!0,value:void 0}}))}[Symbol.asyncIterator](){return this}[Ue()](){return Promise.resolve()}[Symbol.asyncDispose](){return Promise.resolve()}}fn=new WeakMap,gn=new WeakMap,An=new WeakMap,wn=new WeakMap,yn=new WeakMap,vn=new WeakMap,bn=new WeakMap,Sn=new WeakMap;class ur{constructor(e,t,i,s,n){B(this,xn),B(this,kn),B(this,En),B(this,Tn),B(this,In),B(this,Cn),U(this,kn,e),U(this,En,t),U(this,Tn,i),U(this,In,s),U(this,Cn,n)}streamId(){return M(this,Cn)}groups(){return R(this,xn,Mn).call(this)}subscribeId(){return M(this,En)}return(){return L(this,null,(function*(){return yield M(this,kn).close(),{done:!0,value:void 0}}))}[Symbol.asyncIterator](){return this}[Ue()](){return R(this,xn,Bn).call(this)}[Symbol.asyncDispose](){return R(this,xn,Bn).call(this)}}kn=new WeakMap,En=new WeakMap,Tn=new WeakMap,In=new WeakMap,Cn=new WeakMap,xn=new WeakSet,Mn=function(){return _(this,null,(function*(){for(;!(yield new D(M(this,kn).isDone()));){const e=yield new D(M(this,kn).readBigVarInt()),t=new lr(M(this,kn),e,M(this,En),M(this,Tn),M(this,In),M(this,Cn));if(yield t,4===(yield new D(Promise.race([t.endStatus(),M(this,kn).closed()]))))return}}))},Bn=function(){return M(this,kn).close().catch((()=>{}))};class dr{constructor(e,t,i,s,n,r,o){B(this,Vn),B(this,Un),B(this,Rn),B(this,Pn),B(this,Ln),B(this,Dn),B(this,_n),B(this,Wn,!1),B(this,On),B(this,Fn,Me.get().createContext("GroupReader")),U(this,Un,e),U(this,Rn,t),U(this,Pn,i),U(this,Ln,s),U(this,Dn,n),U(this,_n,r),U(this,On,o)}streamId(){return M(this,On)}groupId(){return M(this,Ln)}subscribeId(){return M(this,Rn)}next(){return L(this,null,(function*(){try{if((yield M(this,Un).isDone())||M(this,Wn))return{done:!0,value:void 0};const e=yield M(this,Un).readBigVarInt(),t=yield M(this,Un).readVarInt();let i=0,s=new Uint8Array;return t>0?s=yield M(this,Un).read(t):i=yield M(this,Un).readVarInt(),pn(i),3===i&&U(this,Wn,!0),{done:!1,value:{subscribeId:M(this,Rn),trackAlias:M(this,Pn),groupId:M(this,Ln),subGroupId:M(this,Dn),subscriberPriority:M(this,_n),streamId:M(this,On),objectId:e,objectStatus:i,payload:s}}}catch(e){return M(this,Fn).info("Error reading object",{error:e}),{done:!0,value:void 0}}}))}return(){return L(this,null,(function*(){return yield M(this,Un).close().catch((()=>{})),{done:!0,value:void 0}}))}groups(){return R(this,Vn,Nn).call(this)}[Symbol.asyncIterator](){return this}[Ue()](){return R(this,Vn,jn).call(this)}[Symbol.asyncDispose](){return R(this,Vn,jn).call(this)}}function mr(e,t){return L(this,null,(function*(){const i=yield e.readVarInt();switch(i){case mn.StreamHeaderGroup:{const i=yield e.readBigVarInt(),s=yield e.readBigVarInt(),n=yield e.readBigVarInt(),r=yield e.readBigVarInt(),o=yield e.readUnsigned8();return new dr(e,i,s,n,r,o,t)}case mn.StreamHeaderTrack:{const i=yield e.readBigVarInt(),s=yield e.readBigVarInt(),n=yield e.readUnsigned8();return new ur(e,i,s,n,t)}default:throw new Error("Unexpected message type "+i)}}))}Un=new WeakMap,Rn=new WeakMap,Pn=new WeakMap,Ln=new WeakMap,Dn=new WeakMap,_n=new WeakMap,Wn=new WeakMap,On=new WeakMap,Fn=new WeakMap,Vn=new WeakSet,Nn=function(){return _(this,null,(function*(){yield this}))},jn=function(){return M(this,Un).close().catch((()=>{}))};class pr{constructor(e,t){B(this,Gn),B(this,zn),U(this,Gn,e),U(this,zn,t)}start(e){M(this,Gn).addEventListener("message",(t=>{if("object"==typeof t.data&&t.data instanceof ArrayBuffer){const i=new Uint8Array(t.data);i[0]==M(this,zn)&&e.enqueue(i.subarray(1))}})),M(this,Gn).addEventListener("error",(()=>e.error(new Error("WebSocket error")))),M(this,Gn).addEventListener("close",(()=>Ze((()=>e.close()))))}cancel(e){M(this,Gn).close(void 0,e)}}Gn=new WeakMap,zn=new WeakMap;class fr{constructor(e){B(this,Qn),B(this,Hn,null),B(this,Xn,null),B(this,qn,null),U(this,Qn,e)}start(e){U(this,Hn,(t=>{if("object"==typeof t.data&&t.data instanceof ArrayBuffer){const i=new Uint8Array(t.data),s=i[0]||0,n=127&s,r=(s>>7&1)>0;if(n&&0!==n){const t=i.subarray(1);e.enqueue([r,n,t])}}})),U(this,Xn,(()=>Ze((()=>e.close())))),U(this,qn,(()=>e.error(new Error("WebSocket error")))),M(this,Qn).addEventListener("message",M(this,Hn)),M(this,Qn).addEventListener("error",M(this,qn)),M(this,Qn).addEventListener("close",M(this,Xn))}cancel(e){M(this,Hn)&&M(this,Qn).removeEventListener("message",M(this,Hn)),M(this,qn)&&M(this,Qn).removeEventListener("error",M(this,qn)),M(this,Xn)&&M(this,Qn).removeEventListener("close",M(this,Xn))}}Qn=new WeakMap,Hn=new WeakMap,Xn=new WeakMap,qn=new WeakMap;class gr{constructor(e,t){B(this,er),B(this,Zn),B(this,Jn),B(this,$n),B(this,Yn,0),B(this,Kn,new TextDecoder),U(this,Zn,e),U(this,Jn,t),U(this,$n,t.getReader())}readUnsigned8(){return L(this,null,(function*(){return yield R(this,er,sr).call(this,1),R(this,er,rr).call(this,1)[0]}))}readString(){return L(this,null,(function*(){const e=yield this.readVarInt(),t=yield this.read(e);return M(this,Kn).decode(t)}))}readVarInt(){return L(this,null,(function*(){const e=yield this.readBigVarInt();if(e>Number.MAX_SAFE_INTEGER)throw new Error("VarInt is too large");return Number(e)}))}readBigVarInt(){return L(this,null,(function*(){yield R(this,er,sr).call(this,1);const e=(192&R(this,er,nr).call(this,1)[0])>>6;switch(M(this,Zn)[M(this,Yn)]=63&R(this,er,nr).call(this,1)[0],e){case 0:return Y(R(this,er,rr).call(this,1)[0]);case 1:{yield R(this,er,sr).call(this,2);const e=R(this,er,rr).call(this,2);return Y(new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0))}case 2:{yield R(this,er,sr).call(this,4);const e=R(this,er,rr).call(this,4);return Y(new DataView(e.buffer,e.byteOffset,e.byteLength).getUint32(0))}case 3:{yield R(this,er,sr).call(this,8);const e=R(this,er,rr).call(this,8),t=new DataView(e.buffer,e.byteOffset,e.byteLength);return void 0!==t.getBigUint64?Y(t.getBigUint64(0)):Y(ue(e,0,7))}default:throw new Error("Invalid VarInt size")}}))}read(e){return L(this,null,(function*(){return yield R(this,er,sr).call(this,e),R(this,er,rr).call(this,e)}))}readAll(){return L(this,null,(function*(){for(;yield R(this,er,ir).call(this););return R(this,er,rr).call(this,R(this,er,tr).call(this))}))}isDone(){return L(this,null,(function*(){return!(R(this,er,tr).call(this)>0)&&0==(yield R(this,er,ir).call(this))}))}closed(){return L(this,null,(function*(){return M(this,$n).closed}))}close(){return L(this,null,(function*(){return M(this,$n).releaseLock(),M(this,Jn).cancel()}))}}Zn=new WeakMap,Jn=new WeakMap,$n=new WeakMap,Yn=new WeakMap,Kn=new WeakMap,er=new WeakSet,tr=function(){return M(this,Zn).length-M(this,Yn)},ir=function(){return L(this,null,(function*(){const{value:e,done:t}=yield M(this,$n).read();if(t)return Promise.resolve(0);if(0===R(this,er,tr).call(this))U(this,Zn,e);else{const t=M(this,Zn).subarray(M(this,Yn)),i=new Uint8Array(t.length+e.length);i.set(t),i.set(e,t.byteLength),U(this,Zn,i)}return U(this,Yn,0),Promise.resolve(e.length)}))},sr=function(e){return L(this,null,(function*(){for(;R(this,er,tr).call(this)<e;)if(0===(yield R(this,er,ir).call(this)))throw new Error("Read failed")}))},nr=function(e){return M(this,Zn).subarray(M(this,Yn),M(this,Yn)+e)},rr=function(e){const t=R(this,er,nr).call(this,e);return U(this,Yn,M(this,Yn)+t.length),t};class Ar{constructor(e){B(this,or,new Uint8Array(8)),B(this,ar),B(this,hr),B(this,cr,new TextEncoder),U(this,ar,e),U(this,hr,M(this,ar).getWriter())}writeString(e){return L(this,null,(function*(){const t=M(this,cr).encode(e);return yield this.writeVarInt(t.length),this.write(t)}))}write(e){return M(this,hr).write(e)}writeUnsigned8(e){return M(this,hr).write(Mr(e,M(this,or)))}writeVarInt(e){return M(this,hr).write(Lr(e,M(this,or)))}writeBigVarInt(e){return M(this,hr).write(Dr(e,M(this,or)))}flush(){return L(this,null,(function*(){}))}close(){return L(this,null,(function*(){M(this,hr).releaseLock(),yield M(this,ar).close()}))}}or=new WeakMap,ar=new WeakMap,hr=new WeakMap,cr=new WeakMap;var wr,yr,vr,br;const Sr=class e{constructor(t){B(this,wr,0),B(this,yr,new Uint8Array(e.DEFAULT_BUFFER_SIZE)),B(this,vr),B(this,br,new TextEncoder),U(this,vr,t)}writeString(e){return L(this,null,(function*(){const t=M(this,br).encode(e);return yield this.writeVarInt(t.length),this.write(t)}))}ensureBufferSpace(e){if(M(this,yr).length-M(this,wr)>=e)return;const t=new Uint8Array(M(this,yr).length+e);t.set(M(this,yr)),U(this,yr,t)}write(e){return this.ensureBufferSpace(e.length),M(this,yr).set(e,M(this,wr)),U(this,wr,M(this,wr)+e.byteLength),Promise.resolve()}writeUnsigned8(e){return this.ensureBufferSpace(1),Mr(e,M(this,yr).subarray(M(this,wr))),U(this,wr,M(this,wr)+1),Promise.resolve()}writeVarInt(e){if(e<0)throw new Error(`VarInt can not be negative: ${e}`);return this.ensureBufferSpace(8),U(this,wr,M(this,wr)+Lr(e,M(this,yr).subarray(M(this,wr))).byteLength),Promise.resolve()}writeBigVarInt(e){if(e<0)throw new Error(`VarInt can not be negative: ${e}`);return this.ensureBufferSpace(8),U(this,wr,M(this,wr)+Dr(e,M(this,yr).subarray(M(this,wr))).byteLength),Promise.resolve()}flush(){if(1!==M(this,vr).readyState)throw new Error("Writer is not open");return M(this,vr).send(M(this,yr).subarray(0,M(this,wr))),U(this,wr,0),U(this,yr,new Uint8Array(e.DEFAULT_BUFFER_SIZE)),Promise.resolve()}close(){return M(this,vr).close(),Promise.resolve()}};wr=new WeakMap,yr=new WeakMap,vr=new WeakMap,br=new WeakMap,I(Sr,"DEFAULT_BUFFER_SIZE",1024);let kr=Sr;const Er=Math.pow(2,6)-1,Tr=Math.pow(2,14)-1,Ir=Math.pow(2,30)-1,Cr=Number.MAX_SAFE_INTEGER,xr="function"==typeof BigInt?Y(2)**Y(62)-Y(1):Y(Number.MAX_SAFE_INTEGER);function Mr(e,t){return t[0]=e,t.subarray(0,1)}function Br(e,t){const i=new DataView(t.buffer,t.byteOffset,2);return i.setUint16(0,e),new Uint8Array(i.buffer,i.byteOffset,i.byteLength)}function Ur(e,t){const i=new DataView(t.buffer,t.byteOffset,4);return i.setUint32(0,e),new Uint8Array(i.buffer,i.byteOffset,i.byteLength)}function Rr(e,t){const i=new DataView(t.buffer,t.byteOffset,8);return i.setBigUint64(0,e),new Uint8Array(i.buffer,i.byteOffset,i.byteLength)}function Pr(e,t){const i=new DataView(t.buffer,t.byteOffset,8);return i.setUint32(0,e/4294967296),i.setUint32(4,4294967295&e),t.set([192],0),new Uint8Array(i.buffer,i.byteOffset,i.byteLength)}function Lr(e,t){if(e<=Er)return Mr(e,t);if(e<=Tr)return Br(16384|e,t);if(e<=Ir)return Ur(2147483648|e,t);if(e<=Cr)return"function"==typeof BigInt?Rr(BigInt(e)|BigInt(3221225472)<<BigInt(32),t):Pr(Number(e),t);throw new Error(`overflow, value larger than 53-bits: ${e}`)}function Dr(e,t){if(e<Er)return Mr(Number(e),t);if(e<Tr)return Br(16384|Number(e),t);if(e<=Ir)return Ur(2147483648|Number(e),t);if(e<=xr)return"function"==typeof BigInt?Rr(BigInt(e)|BigInt(3221225472)<<BigInt(32),t):Pr(Number(e),t);throw new Error(`overflow, value larger than 62-bits: ${e}`)}var _r=(e=>(e[e.SubscribeUpdate=2]="SubscribeUpdate",e[e.Subscribe=3]="Subscribe",e[e.SubscribeOk=4]="SubscribeOk",e[e.SubscribeError=5]="SubscribeError",e[e.Announce=6]="Announce",e[e.AnnounceOk=7]="AnnounceOk",e[e.AnnounceError=8]="AnnounceError",e[e.Unannounce=9]="Unannounce",e[e.Unsubscribe=10]="Unsubscribe",e[e.SubscribeDone=11]="SubscribeDone",e[e.AnnounceCancel=12]="AnnounceCancel",e[e.TrackStatusRequest=13]="TrackStatusRequest",e[e.TrackStatus=14]="TrackStatus",e[e.Goaway=16]="Goaway",e[e.ClientSetup=64]="ClientSetup",e[e.ServerSetup=65]="ServerSetup",e[e.Unknown=255]="Unknown",e))(_r||{});function Wr(e){return L(this,null,(function*(){const t=yield e.readVarInt();if(t<1||t>32)throw new Error(`namespace must be between 1 and 32, got ${t}`);const i=[];for(let s=0;s<t;s++)i.push(yield e.readString());return i}))}function Or(e,t){return L(this,null,(function*(){yield e.writeVarInt(t.length);for(const i of t)yield e.writeString(i)}))}const Fr=Y(2);function Vr(e){return L(this,null,(function*(){const t=yield e.readVarInt(),i=new Map;for(let s=0;s<t;s++){const t=yield e.readBigVarInt(),s=yield e.read(yield e.readVarInt());i.set(t,{type:t,payload:s})}return i}))}function Nr(e,t){return L(this,null,(function*(){yield e.writeVarInt(t.size);for(const[i,s]of t)yield e.writeBigVarInt(i),yield e.writeVarInt(s.payload.length),yield e.write(s.payload)}))}const jr={Role:Y(0)},Gr={Draft07:4278190087};function zr(e){return L(this,null,(function*(){const t=yield e.readVarInt();return t===Gr.Draft07?{type:"known",value:t}:{type:"unknown",value:t}}))}const Qr={"latest-group":1,"latest-object":2,"absolute-start":3,"absolute-range":4};function Hr(e){return L(this,null,(function*(){const t=yield e.readUnsigned8();switch(t){case 0:return"inherit-publisher";case 1:return"ascending";case 2:return"descending";default:throw new Error(`Invalid location type ${t}`)}}))}function Xr(e,t){return L(this,null,(function*(){switch(t){case"inherit-publisher":yield e.writeUnsigned8(0);break;case"ascending":yield e.writeUnsigned8(1);break;case"descending":yield e.writeUnsigned8(2)}}))}var qr,Zr,Jr,$r,Yr,Kr,eo,to,io,so,no,ro,oo,ao,ho,co,lo,uo,mo,po,fo,go,Ao,wo;class yo{constructor(e){B(this,Jr),B(this,qr),B(this,Zr,new Uint8Array),U(this,qr,e)}write(e){return L(this,null,(function*(){yield M(this,qr).writeVarInt(e.type);const t=new kr({close:()=>{},readyState:1,send:e=>{U(this,Zr,new Uint8Array(e))}});switch(e.type){case _r.Subscribe:yield R(this,Jr,Kr).call(this,t,e);break;case _r.Announce:yield R(this,Jr,ro).call(this,t,e);break;case _r.SubscribeOk:yield R(this,Jr,eo).call(this,t,e);break;case _r.SubscribeUpdate:yield R(this,Jr,io).call(this,t,e);break;case _r.SubscribeError:yield R(this,Jr,to).call(this,t,e);break;case _r.SubscribeDone:yield R(this,Jr,so).call(this,t,e);break;case _r.Unsubscribe:yield R(this,Jr,no).call(this,t,e);break;case _r.ClientSetup:yield R(this,Jr,$r).call(this,t,e);break;case _r.ServerSetup:yield R(this,Jr,Yr).call(this,t,e);break;case _r.AnnounceOk:yield R(this,Jr,oo).call(this,t,e);break;default:throw new Error(`Unknown message type: ${e.type}`)}yield t.flush(),yield M(this,qr).writeVarInt(M(this,Zr).byteLength),yield M(this,qr).write(M(this,Zr)),yield M(this,qr).flush()}))}close(){return L(this,null,(function*(){return M(this,qr).close()}))}}qr=new WeakMap,Zr=new WeakMap,Jr=new WeakSet,$r=function(e,t){return L(this,null,(function*(){yield function(e,t){return L(this,null,(function*(){yield e.writeVarInt(t.supportedVersions.length);for(const i of t.supportedVersions)yield e.writeVarInt(i.value);yield Nr(e,t.parameters)}))}(e,t)}))},Yr=function(e,t){return L(this,null,(function*(){yield function(e,t){return L(this,null,(function*(){yield e.writeVarInt(t.selectedVersion.value),yield Nr(e,t.parameters)}))}(e,t)}))},Kr=function(e,t){return L(this,null,(function*(){yield function(e,t){return L(this,null,(function*(){yield e.writeBigVarInt(t.id),yield e.writeBigVarInt(t.trackAlias),yield Or(e,t.namespace),yield e.writeString(t.name),yield e.writeUnsigned8(t.subscriberPriority),yield Xr(e,t.groupOrder),yield function(e,t){return L(this,null,(function*(){const i=Qr[t.type];switch(yield e.writeVarInt(i),t.type){case"absolute-range":yield e.writeBigVarInt(t.start.group),yield e.writeBigVarInt(t.start.object),yield e.writeBigVarInt(t.end.group),yield e.writeBigVarInt(t.end.object);break;case"absolute-start":yield e.writeBigVarInt(t.start.group),yield e.writeBigVarInt(t.start.object);break;case"latest-object":case"latest-group":break;default:throw new Error(`Invalid location type ${i}`)}}))}(e,t.filterType),yield Nr(e,t.params)}))}(e,t)}))},eo=function(e,t){return L(this,null,(function*(){yield function(e,t){return L(this,null,(function*(){yield e.writeBigVarInt(t.id),yield e.writeBigVarInt(t.expires),yield Xr(e,t.groupOrder),yield e.writeUnsigned8(t.largestInfo?1:0),t.largestInfo&&(yield e.writeBigVarInt(t.largestInfo.group),yield e.writeBigVarInt(t.largestInfo.object)),yield Nr(e,t.params)}))}(e,t)}))},to=function(e,t){return L(this,null,(function*(){yield function(e,t){return L(this,null,(function*(){yield e.writeBigVarInt(t.id),yield e.writeBigVarInt(t.errorCode),yield e.writeString(t.reason),yield e.writeBigVarInt(t.trackAlias)}))}(e,t)}))},io=function(e,t){return L(this,null,(function*(){yield function(e,t){return L(this,null,(function*(){yield e.writeBigVarInt(t.id),yield e.writeBigVarInt(t.start.group),yield e.writeBigVarInt(t.start.object),yield e.writeBigVarInt(t.end.group),yield e.writeBigVarInt(t.end.object),yield e.writeUnsigned8(t.subscriberPriority),yield Nr(e,t.params)}))}(e,t)}))},so=function(e,t){return L(this,null,(function*(){yield function(e,t){return L(this,null,(function*(){yield e.writeBigVarInt(t.id),yield e.writeVarInt(t.errorCode),yield e.writeString(t.reason),yield e.writeUnsigned8(t.finalInfo?1:0),t.finalInfo&&(yield e.writeBigVarInt(t.finalInfo.group),yield e.writeBigVarInt(t.finalInfo.object))}))}(e,t)}))},no=function(e,t){return L(this,null,(function*(){yield function(e,t){return L(this,null,(function*(){yield e.writeBigVarInt(t.id)}))}(e,t)}))},ro=function(e,t){return L(this,null,(function*(){yield function(e,t){return L(this,null,(function*(){yield Or(e,t.namespace),yield Nr(e,t.params)}))}(e,t)}))},oo=function(e,t){return L(this,null,(function*(){yield function(e,t){return L(this,null,(function*(){yield Or(e,t.namespace)}))}(e,t)}))};class vo{constructor(e,t){B(this,ao),B(this,ho),B(this,co),U(this,ao,e),U(this,ho,new yo(e)),U(this,co,t)}write(e){return L(this,null,(function*(){yield M(this,ao).write(M(this,co)),yield M(this,ho).write(e)}))}close(){return M(this,ao).close()}}ao=new WeakMap,ho=new WeakMap,co=new WeakMap;class bo{constructor(e){B(this,lo),U(this,lo,e)}cancel(){return M(this,lo).close()}read(){return L(this,null,(function*(){const e=yield M(this,lo).readVarInt(),t=yield M(this,lo).readVarInt();switch(e){case _r.ServerSetup:return function(e){return L(this,null,(function*(){const t=yield zr(e);if("known"!==t.type)throw new Error("Expected known version");const i=yield Vr(e);if(!i.has(jr.Role))throw new Error("Role parameter is required");return{type:_r.ServerSetup,selectedVersion:t,parameters:i}}))}(M(this,lo));case _r.ClientSetup:return function(e){return L(this,null,(function*(){const t=[],i=yield e.readVarInt();for(let s=0;s<i;s++)t.push(yield zr(e));const s=yield Vr(e);if(!s.has(jr.Role))throw new Error("Role parameter is required");return{type:_r.ClientSetup,supportedVersions:t,parameters:s}}))}(M(this,lo));case _r.Subscribe:return function(e){return L(this,null,(function*(){const t=yield e.readBigVarInt(),i=yield e.readBigVarInt(),s=yield Wr(e),n=yield e.readString(),r=yield e.readUnsigned8(),o=yield Hr(e),a=yield function(e){return L(this,null,(function*(){const t=yield e.readVarInt();switch(t){case 1:return{type:"latest-group"};case 2:return{type:"latest-object"};case 3:return{type:"absolute-start",start:{group:yield e.readBigVarInt(),object:yield e.readBigVarInt()}};case 4:return{type:"absolute-range",start:{group:yield e.readBigVarInt(),object:yield e.readBigVarInt()},end:{group:yield e.readBigVarInt(),object:yield e.readBigVarInt()}};default:throw new Error(`Invalid location type ${t}`)}}))}(e),h=yield Vr(e);if("absolute-range"===a.type){const e=a.start.group>a.end.group,t=a.start.group===a.end.group&&a.start.object>a.end.object;if(e||t)throw new Error("Invalid filter range")}return{type:_r.Subscribe,id:t,trackAlias:i,namespace:s,name:n,subscriberPriority:r,groupOrder:o,filterType:a,params:h}}))}(M(this,lo));case _r.SubscribeOk:return function(e){return L(this,null,(function*(){const t=yield e.readBigVarInt(),i=yield e.readBigVarInt(),s=yield Hr(e),n=1==(yield e.readUnsigned8());let r;if("inherit-publisher"==s)throw new Error("SusbcribeOk cannot have inherit publisher group order");n&&(r={group:yield e.readBigVarInt(),object:yield e.readBigVarInt()});const o=yield Vr(e);return{type:_r.SubscribeOk,id:t,groupOrder:s,expires:i,largestInfo:r,params:o}}))}(M(this,lo));case _r.SubscribeDone:return function(e){return L(this,null,(function*(){const t=yield e.readBigVarInt(),i=yield e.readVarInt(),s=yield e.readString();let n;return 1==(yield e.readUnsigned8())&&(n={group:yield e.readBigVarInt(),object:yield e.readBigVarInt()}),{type:_r.SubscribeDone,id:t,errorCode:i,reason:s,finalInfo:n}}))}(M(this,lo));case _r.SubscribeError:return function(e){return L(this,null,(function*(){return{type:_r.SubscribeError,id:yield e.readBigVarInt(),errorCode:yield e.readBigVarInt(),reason:yield e.readString(),trackAlias:yield e.readBigVarInt()}}))}(M(this,lo));case _r.SubscribeUpdate:return function(e){return L(this,null,(function*(){const t=yield e.readBigVarInt(),i=yield e.readBigVarInt(),s=yield e.readBigVarInt(),n=yield e.readBigVarInt(),r=yield e.readBigVarInt(),o=yield e.readUnsigned8(),a=yield Vr(e);if(i>n||i===n&&s>r)throw new Error("Invalid filter range");return{type:_r.SubscribeUpdate,id:t,start:{group:i,object:s},end:{group:n,object:r},subscriberPriority:o,params:a}}))}(M(this,lo));case _r.Unsubscribe:return function(e){return L(this,null,(function*(){return{type:_r.Unsubscribe,id:yield e.readBigVarInt()}}))}(M(this,lo));case _r.Announce:return function(e){return L(this,null,(function*(){return{type:_r.Announce,namespace:yield Wr(e),params:yield Vr(e)}}))}(M(this,lo));case _r.AnnounceOk:return function(e){return L(this,null,(function*(){return{type:_r.AnnounceOk,namespace:yield Wr(e)}}))}(M(this,lo));case _r.AnnounceError:return function(e){return L(this,null,(function*(){return{type:_r.AnnounceError,namespace:yield Wr(e),errorCode:yield e.readBigVarInt(),reason:yield e.readString()}}))}(M(this,lo))}return function(e,t,i){return L(this,null,(function*(){return{type:_r.Unknown,messageType:t,payload:yield e.read(i)}}))}(M(this,lo),Y(e),t)}))}}lo=new WeakMap;const So=class e{constructor(e,t){B(this,go),B(this,uo),B(this,mo),B(this,po,new G),B(this,fo,new G),U(this,uo,e),U(this,mo,t),M(this,po).resolve()}write(e){return L(this,null,(function*(){const t=yield R(this,go,Ao).call(this);try{yield M(this,uo).write(e)}finally{t.resolve()}}))}markPostHandshake(){M(this,fo).resolve()}postHandshake(){return M(this,fo).promise}read(){return L(this,null,(function*(){return M(this,mo).read()}))}cancel(){return M(this,mo).cancel()}static wrapWebsocket(t){const i=new ReadableStream(new pr(t,M(e,wo))),s=new bo(new gr(new Uint8Array([]),i)),n=new vo(new kr(t),new Uint8Array([0]));return new e(n,s)}static wrapWebTransport(t){const i=t.writable,s=t.readable;return new e(new yo(new Ar(i)),new bo(new gr(new Uint8Array,s)))}};uo=new WeakMap,mo=new WeakMap,po=new WeakMap,fo=new WeakMap,go=new WeakSet,Ao=function(){const e=new G,t=M(this,po).promise.then((()=>e));return U(this,po,e),t},wo=new WeakMap,B(So,wo,0);let ko=So;function Eo(e,t){return L(this,null,(function*(){yield e.write({type:_r.ClientSetup,supportedVersions:[{type:"known",value:Gr.Draft07}],parameters:new Map([[jr.Role,{type:jr.Role,payload:new Uint8Array([t])}]])});const i=yield e.read();if(e.markPostHandshake(),i.type!==_r.ServerSetup)throw new Error("Expected server setup message");if("known"!==i.selectedVersion.type)throw new Error("Expected known version")}))}var To,Io,Co,xo,Mo,Bo,Uo;class Ro{constructor(e){I(this,"announce"),B(this,To,new G),this.announce=e}onOk(e){M(this,To).resolve(e)}onError(e){const t=new Error(e.reason);return M(this,To).reject(t),t}ok(){return M(this,To).promise}}To=new WeakMap;class Po{constructor(e){I(this,"state"),this.state=e}}const Lo=class e{constructor(e){switch(I(this,"subscribe"),B(this,Io,new G),B(this,Co,new G),B(this,xo,new G),B(this,Mo,Date.now()),B(this,Bo,new G),B(this,Uo),this.subscribe=e,e.filterType.type){case"absolute-start":U(this,Uo,{startGroup:e.filterType.start.group});break;case"absolute-range":U(this,Uo,{startGroup:e.filterType.start.group,endGroup:e.filterType.end.group})}}onUpdate(e){U(this,Uo,{startGroup:e.start.group}),e.end.group>Y(0)&&(M(this,Uo).endGroup=e.end.group-Y(1))}onError(e){const t=new Error(e.reason);return M(this,Io).reject(t),M(this,Co).reject(t),t}onDone(e){e.finalInfo&&(M(this,Uo)||U(this,Uo,{startGroup:Y(0)}),M(this,Uo).endGroup=e.finalInfo.group),M(this,Co).resolve(e)}onUnsubscribe(e){M(this,xo).resolve(e)}onOk(t){const i=Math.max(0,Date.now()-M(this,Mo)),s=Number(t.expires);if(s>0){const t=Math.max(e.minGraceTime,Math.min(s/10,e.maxGraceTime));Promise.race([$e(s-t-i),this.done().catch(j)]).then((()=>M(this,Bo).resolve(this.expiryState()))).catch(j)}M(this,Io).resolve(t)}done(){return M(this,Co).promise}ok(){return M(this,Io).promise}range(){return M(this,Uo)}close(){M(this,Bo).promise.catch(j),M(this,Bo).reject(new Error("Subscription closed"))}expiryState(){return M(this,Co).resolved&&6!==M(this,Co).resolved.errorCode?"done":M(this,xo).pending?"active":"unsubscribed"}unsubscribed(){return M(this,xo).promise}isUnsubscribed(){return M(this,xo).resolved}expiryNotification(){return M(this,Bo).promise}};Io=new WeakMap,Co=new WeakMap,xo=new WeakMap,Mo=new WeakMap,Bo=new WeakMap,Uo=new WeakMap,I(Lo,"maxGraceTime",15e3),I(Lo,"minGraceTime",3e3);let Do=Lo;var _o,Wo,Oo,Fo,Vo,No,jo,Go,zo,Qo,Ho,Xo,qo,Zo,Jo,$o,Yo,Ko,ea,ta,ia,sa,na,ra,oa,aa,ha,ca,la,ua,da,ma,pa,fa,ga,Aa,wa,ya,va,ba,Sa,ka,Ea,Ta,Ia,Ca,xa,Ma,Ba,Ua,Ra,Pa,La,Da,_a,Wa,Oa,Fa,Va,Na,ja,Ga,za,Qa,Ha,Xa,qa,Za,Ja,$a,Ya,Ka,eh,th,ih,sh,nh,rh,oh,ah,hh,ch,lh,uh,dh,mh,ph,fh,gh,Ah,wh,yh,vh,bh,Sh,kh,Eh,Th,Ih,Ch,xh,Mh;class Bh{constructor(e){B(this,_o),B(this,Wo,!1),U(this,_o,e)}write(e){return L(this,null,(function*(){M(this,Wo)||(yield M(this,_o).writeVarInt(mn.StreamHeaderGroup),yield M(this,_o).writeBigVarInt(e.subscribeId),yield M(this,_o).writeBigVarInt(e.trackAlias),yield M(this,_o).writeBigVarInt(e.groupId),yield M(this,_o).writeBigVarInt(e.subGroupId),yield M(this,_o).writeUnsigned8(e.subscriberPriority),U(this,Wo,!0)),yield M(this,_o).writeBigVarInt(e.objectId),yield M(this,_o).writeVarInt(e.payload.length),e.payload.length>0?yield M(this,_o).write(e.payload):yield M(this,_o).writeVarInt(e.objectStatus),yield M(this,_o).flush()}))}close(){return L(this,null,(function*(){yield M(this,_o).close()}))}}_o=new WeakMap,Wo=new WeakMap;class Uh{constructor(e,t,i,s){B(this,zo),B(this,Oo),B(this,Fo),B(this,Vo),B(this,No),B(this,jo),B(this,Go),U(this,Oo,t),U(this,Fo,e),U(this,Vo,i),U(this,No,s),U(this,Go,Me.get().createContext(`SubscriptionWriter:${e.subscribe.name}`))}finalInfo(){return M(this,jo)}run(){return L(this,null,(function*(){yield Promise.race([R(this,zo,Qo).call(this).catch((e=>M(this,Go).error("error writing subscription",e))),M(this,Fo).unsubscribed(),M(this,Fo).done(),M(this,Fo).expiryNotification().catch(j)])}))}done(e,t){return L(this,null,(function*(){if(M(this,Fo).isUnsubscribed())return;const i={type:_r.SubscribeDone,id:M(this,Fo).subscribe.id,errorCode:e,reason:t,finalInfo:M(this,jo)};M(this,Fo).onDone(i),yield M(this,No).push(i)}))}[Ue()](){return this.done(3,"Track ended")}[Symbol.asyncDispose](){return this.done(3,"Track ended")}}Oo=new WeakMap,Fo=new WeakMap,Vo=new WeakMap,No=new WeakMap,jo=new WeakMap,Go=new WeakMap,zo=new WeakSet,Qo=function(){return L(this,null,(function*(){try{for(var e,t,i,s=O(M(this,Oo));e=!(t=yield s.next()).done;e=!1){const e=t.value;var n=[];try{const t=M(this,Fo).range();if(t&&(t.startGroup>e.id||t.endGroup&&t.endGroup<e.id))break;const i=yield M(this,Vo).openSendStream(),s=new Bh(i),r=F(n,new Rh(s,e.consume(),M(this,Fo)),!0);yield r.run(),U(this,jo,r.finalGroup())}catch(e){var r=e,o=!0}finally{var a=V(n,r,o);a&&(yield a)}}}catch(t){i=[t]}finally{try{e&&(t=s.return)&&(yield t.call(s))}finally{if(i)throw i[0]}}}))};class Rh{constructor(e,t,i){B(this,Ho),B(this,Xo),B(this,qo),B(this,Zo),B(this,Jo),U(this,Ho,e),U(this,Xo,t),U(this,qo,i),U(this,Jo,Me.get().createContext(`GroupSubscriptionWriter:${i.subscribe.name}`))}finalGroup(){return M(this,Zo)}run(){return L(this,null,(function*(){M(this,Jo).debug("write group");try{for(var e,t,i,s=O(M(this,Xo));e=!(t=yield s.next()).done;e=!1){const e=t.value;yield M(this,Ho).write({subscribeId:M(this,qo).subscribe.id,trackAlias:M(this,qo).subscribe.trackAlias,subGroupId:Y(0),subscriberPriority:0,groupId:e.groupId,objectId:e.objectId,objectStatus:e.objectStatus,payload:e.payload}),U(this,Zo,{group:e.groupId,object:e.objectId})}}catch(t){i=[t]}finally{try{e&&(t=s.return)&&(yield t.call(s))}finally{if(i)throw i[0]}}M(this,Jo).debug("write group done")}))}[Ue()](){return M(this,Ho).close().catch(j)}[Symbol.asyncDispose](){return M(this,Ho).close().catch(j)}}Ho=new WeakMap,Xo=new WeakMap,qo=new WeakMap,Zo=new WeakMap,Jo=new WeakMap;class Ph{constructor(e,t,i){B(this,Ko),I(this,"state"),B(this,$o),B(this,Yo),this.state=e,U(this,$o,t),U(this,Yo,i)}ok(e){return L(this,null,(function*(){var t,i,s;const n=null==(t=this.state.range())?void 0:t.startGroup,r=e.latest(),o=null==r?void 0:r.id,a=null!=(s=null==(i=null==r?void 0:r.latest())?void 0:i.objectId)?s:Y(0),h=e.consume(null!=n?n:o),c={type:_r.SubscribeOk,id:this.state.subscribe.id,expires:Y(0),groupOrder:"ascending",params:new Map,largestInfo:o?{group:o,object:a}:void 0};return yield M(this,Yo).push(c),new Uh(this.state,h,M(this,$o),M(this,Yo))}))}invalidRange(){return R(this,Ko,ea).call(this,Y(1),"Invalid range")}retryTrackAlias(){return R(this,Ko,ea).call(this,Y(2),"Retry track alias")}trackDoesNotExist(){return R(this,Ko,ea).call(this,Y(3),"Track does not exist")}unauthorized(){return R(this,Ko,ea).call(this,Y(4),"Unauthorized")}timeout(){return R(this,Ko,ea).call(this,Y(5),"Timeout")}[Ue()](){return this.trackDoesNotExist()}[Symbol.asyncDispose](){return this.trackDoesNotExist()}}$o=new WeakMap,Yo=new WeakMap,Ko=new WeakSet,ea=function(e,t){const i={type:_r.SubscribeError,id:this.state.subscribe.id,errorCode:e,reason:t,trackAlias:this.state.subscribe.trackAlias};return M(this,Yo).push(i)},ta=[Be({context:"Session",enter:"info",error:"error"})];class Lh{constructor(e,t,i){E(ca,5,this),B(this,ia),B(this,sa),B(this,na),B(this,ra,Me.get().createContext("Publisher")),B(this,oa,new Ne(new Map)),B(this,aa,new Ne(new Map)),B(this,ha,new J(10)),U(this,ia,e),U(this,sa,t),U(this,na,i)}announce(e){return L(this,null,(function*(){if(M(this,oa).current().has(e.join("/")))throw new Error("Duplicate announcement");const t=new Map,i=M(this,ia).authToken();i&&t.set(Fr,{type:Fr,payload:(new TextEncoder).encode(i)});const s={type:_r.Announce,namespace:e,params:t},n=function(e){const t=new Ro(e);return new Po(t)}(s);if(M(this,oa).update((e=>e.set(s.namespace.join("/"),n))),yield M(this,na).push(s),!(yield Promise.race([n.state.ok(),M(this,ia).closed()])))throw new Error("Session closed")}))}close(){M(this,aa).current().forEach((e=>e.close())),M(this,aa).close(),M(this,oa).close(),M(this,ha).close()}incomingSubscriptions(){return M(this,ha)}onMessage(e){return L(this,null,(function*(){switch(e.type){case _r.Subscribe:{const t=new Do(e);if(M(this,aa).update((i=>(i.set(e.id,t),i))),M(this,ha).isFull()){const e=yield M(this,ha).pop();yield null==e?void 0:e.timeout()}yield M(this,ha).push(new Ph(t,M(this,sa),M(this,na)))}break;case _r.SubscribeUpdate:{const t=M(this,aa).current().get(e.id);t||M(this,ra).debug("No subscription found",e),null==t||t.onUpdate(e)}break;case _r.Unsubscribe:{const t=M(this,aa).current().get(e.id);t||M(this,ra).debug("No subscription found",e),null==t||t.onUnsubscribe(e)}break;case _r.AnnounceOk:{const t=M(this,oa).current().get(e.namespace.join("/"));t||M(this,ra).debug("No announcement found",e),null==t||t.state.onOk(e)}break;case _r.AnnounceError:{const t=M(this,oa).current().get(e.namespace.join("/"));t||M(this,ra).debug("No announcement found",e),null==t||t.state.onError(e)}}}))}}ca=y(null),ia=new WeakMap,sa=new WeakMap,na=new WeakMap,ra=new WeakMap,oa=new WeakMap,aa=new WeakMap,ha=new WeakMap,T(ca,1,"announce",ta,Lh),k(ca,Lh);class Dh{constructor(e,t){I(this,"state"),B(this,la),this.state=e,U(this,la,t)}onDone(e){this.state.onDone(e)}onData(e){return M(this,la).push(e)}onError(e){const t=this.state.onError(e);M(this,la).abort(t)}close(){this.state.close(),M(this,la).close()}}la=new WeakMap;class _h{constructor(e,t,i){E(ga,5,this),B(this,Aa),B(this,da),B(this,ma),B(this,pa),B(this,fa,new G),U(this,da,e),U(this,ma,t),U(this,pa,i)}get id(){return M(this,ma).subscribe.id}get trackAlias(){return M(this,ma).subscribe.trackAlias}get name(){return M(this,ma).subscribe.name}range(){return M(this,ma).range()}expiryNotification(){return M(this,ma).expiryNotification()}update(e,t){return L(this,null,(function*(){const i={type:_r.SubscribeUpdate,id:M(this,ma).subscribe.id,start:{group:e,object:Y(0)},end:{group:t+Y(1),object:Y(0)},params:new Map,subscriberPriority:0};M(this,ma).onUpdate(i),yield M(this,da).push(i)}))}unsubscribe(){return L(this,null,(function*(){const e={type:_r.Unsubscribe,id:M(this,ma).subscribe.id};M(this,ma).onUnsubscribe(e),yield M(this,da).push(e)}))}close(){var e,t;return M(this,fa).resolve(),null==(t=(e=M(this,pa)).return)?void 0:t.call(e)}closed(){return M(this,fa).promise}done(){return M(this,ma).done()}expiryState(){return M(this,ma).expiryState()}unsubscribed(){return M(this,ma).isUnsubscribed()}return(){return L(this,null,(function*(){return M(this,fa).resolve(),yield this.unsubscribe(),{done:!0,value:void 0}}))}groups(){return _(this,null,(function*(){var e,t;try{for(var i,s,n,r=O(M(this,pa));i=!(s=yield new D(r.next())).done;i=!1){var o=s.value,a=[];try{const i=F(a,o,!0);try{for(var h,c,l,u=O(i.groups());h=!(c=yield new D(u.next())).done;h=!1){const i=c.value,s=null==(e=M(this,ma).range())?void 0:e.startGroup,n=null==(t=M(this,ma).range())?void 0:t.endGroup;if(s&&i.groupId()<s)return{done:!0,value:void 0};if(n&&i.groupId()>n)return{done:!0,value:void 0};yield i}}catch(c){l=[c]}finally{try{h&&(c=u.return)&&(yield new D(c.call(u)))}finally{if(l)throw l[0]}}}catch(e){var d=e,m=!0}finally{var p=V(a,d,m);p&&(yield new D(p))}}}catch(s){n=[s]}finally{try{i&&(s=r.return)&&(yield new D(s.call(r)))}finally{if(n)throw n[0]}}}))}[Symbol.asyncIterator](){return this.groups()}objects(){return _(this,null,(function*(){try{for(var e,t,i,s=O(this.groups());e=!(t=yield new D(s.next())).done;e=!1){const e=t.value;try{for(var n,r,o,a=O(e);n=!(r=yield new D(a.next())).done;n=!1){const e=r.value;yield e}}catch(r){o=[r]}finally{try{n&&(r=a.return)&&(yield new D(r.call(a)))}finally{if(o)throw o[0]}}}}catch(t){i=[t]}finally{try{e&&(t=s.return)&&(yield new D(t.call(s)))}finally{if(i)throw i[0]}}}))}[(ua=[Be({context:"SubscriptionConsumer",enter:"info"})],Ue())](){return R(this,Aa,wa).call(this)}[Symbol.asyncDispose](){return R(this,Aa,wa).call(this)}}ga=y(null),da=new WeakMap,ma=new WeakMap,pa=new WeakMap,fa=new WeakMap,Aa=new WeakSet,wa=T(ga,17,"#dispose",ua,Aa,wa=function(){return L(this,null,(function*(){return yield this.close(),this.unsubscribe()}))}),k(ga,_h),Sa=[Be({context:"Session",return:"debug"})],ba=[Be({context:"Session",enter:"info",error:"error"})],va=[Be({context:"Session",enter:"debug"})],ya=[Be({context:"Session",enter:"debug"})];class Wh{constructor(e,t){E(Ca,5,this),B(this,xa),B(this,ka),I(this,"nextSubscribeId",Y(0)),B(this,Ea,new Ne(new Map)),B(this,Ta),B(this,Ia,Me.get().createContext("Subscriber")),U(this,ka,e),U(this,Ta,t),R(this,xa,Ma).call(this).catch(j)}subscribe(e,t){return L(this,null,(function*(){const i=this.nextSubscribeId++,s=new Map,n=M(this,ka).authToken();n&&s.set(Fr,{type:Fr,payload:(new TextEncoder).encode(n)});const r={type:_r.Subscribe,namespace:e,name:t.name,id:i,trackAlias:i,groupOrder:t.groupOrder,subscriberPriority:t.priority,filterType:t.filterType,params:s},[o,a]=function(e,t){const i=new Do(t),[s,n]=Q(100);return[new Dh(i,s),new _h(e,i,n)]}(M(this,Ta),r);if(M(this,Ea).update((e=>e.set(i,o))),yield M(this,Ta).push(r),!(yield Promise.race([o.state.ok(),M(this,ka).closed()])))throw new Error("Session closed");return a.closed().then((()=>Promise.race([$e(2e3),this.closed()]))).then((()=>R(this,xa,Ba).call(this,a.id))).catch((()=>R(this,xa,Ba).call(this,a.id))),a}))}closed(){return M(this,ka).closed()}transportType(){return M(this,ka).transportType()}url(){return M(this,ka).url()}onMessage(e){return L(this,null,(function*(){switch(e.type){case _r.Announce:yield M(this,Ta).push({type:_r.AnnounceOk,namespace:e.namespace});break;case _r.SubscribeOk:{const t=M(this,Ea).current().get(e.id);t&&t.state.onOk(e)}break;case _r.SubscribeError:{const t=M(this,Ea).current().get(e.id);t||M(this,Ia).debug("No subscription found",e),null==t||t.onError(e),R(this,xa,Ba).call(this,e.id)}break;case _r.SubscribeDone:{const t=M(this,Ea).current().get(e.id);t||M(this,Ia).debug("No subscription found",e),null==t||t.onDone(e)}}}))}onObjectReader(e){return L(this,null,(function*(){const t=M(this,Ea).current().get(e.subscribeId());t?yield t.onData(e):M(this,Ia).warn("No subscription found",e.subscribeId())}))}close(){M(this,Ea).current().forEach((e=>e.close())),M(this,Ea).close()}}Ca=y(null),ka=new WeakMap,Ea=new WeakMap,Ta=new WeakMap,Ia=new WeakMap,xa=new WeakSet,Ba=function(e){M(this,Ea).isClosed()||M(this,Ea).update((t=>(t.delete(e),t)))},Ma=T(Ca,17,"#observeChanges",Sa,xa,Ma=function(){return L(this,null,(function*(){try{for(var e,t,i,s=O(M(this,Ea));e=!(t=yield s.next()).done;e=!1){const e=[...t.value.values()].map((e=>e.state.subscribe));M(this,Ia).debug("current subscriptions",e)}}catch(t){i=[t]}finally{try{e&&(t=s.return)&&(yield t.call(s))}finally{if(i)throw i[0]}}}))}),T(Ca,1,"subscribe",ba,Wh),T(Ca,1,"close",va,Wh),Ba=T(Ca,17,"#deleteSubscription",ya,xa,Ba),k(Ca,Wh);class Oh{constructor(e,t){E(Ga,5,this),B(this,Va),B(this,Da),B(this,_a),B(this,Wa),B(this,Oa,Me.get().createContext("Session")),I(this,"subscriber"),I(this,"publisher"),B(this,Fa);const[i,s]=Q(100);U(this,Da,e),U(this,Wa,s),this.subscriber=new Wh(this,i),this.publisher=new Lh(this,e,i),U(this,_a,R(this,Va,ja).call(this)),U(this,Fa,new Ne(t)),this.closed().then((()=>this.close())).catch(j)}updateAuthToken(e){M(this,Fa).update(e)}authToken(){return M(this,Fa).current()}transportType(){return M(this,Da).transportType()}url(){return M(this,Da).url()}closed(){return M(this,_a)}close(){try{this.subscriber.close(),this.publisher.close(),M(this,Wa).cancel("closing"),M(this,Da).close()}catch(e){M(this,Oa).warn("Error closing session",e)}}[(La=[Be({context:"Session",return:"info",error:"error"})],Pa=[Be({context:"Session",return:"info",error:"error"})],Ra=[Be({context:"Session",return:"info",error:"error"})],Ua=[Be({context:"Session",enter:"debug"})],Re())](){R(this,Va,Xa).call(this)}[Symbol.dispose](){R(this,Va,Xa).call(this)}}Ga=y(null),Da=new WeakMap,_a=new WeakMap,Wa=new WeakMap,Oa=new WeakMap,Fa=new WeakMap,Va=new WeakSet,Na=function(e){return L(this,null,(function*(){var t,i;M(this,Oa).debug("received message",e),yield null==(t=this.subscriber)?void 0:t.onMessage(e),yield null==(i=this.publisher)?void 0:i.onMessage(e),e.type,_r.Goaway}))},ja=function(){return L(this,null,(function*(){return(yield Promise.all([R(this,Va,Qa).call(this),R(this,Va,Ha).call(this),R(this,Va,za).call(this)])).find((e=>e instanceof Error))}))},Qa=function(){return L(this,null,(function*(){try{for(yield M(this,Da).afterHandshake();;){const e=yield M(this,Da).readMessage().catch((()=>{}));if(!e)break;yield R(this,Va,Na).call(this,e)}}catch(e){return e}finally{M(this,Wa).cancel("closing")}}))},Ha=function(){return L(this,null,(function*(){var e;try{for(;;){const t=yield M(this,Da).objectStream();if(!t)break;yield null==(e=this.subscriber)?void 0:e.onObjectReader(t)}}catch(e){return e}}))},Xa=function(){this.close()},za=T(Ga,17,"#runOutgoingMessages",La,Va,za=function(){return L(this,null,(function*(){try{try{for(var e,t,i,s=O(M(this,Wa));e=!(t=yield s.next()).done;e=!1){const e=t.value;M(this,Oa).debug("sending message",e),yield M(this,Da).writeMessage(e)}}catch(t){i=[t]}finally{try{e&&(t=s.return)&&(yield t.call(s))}finally{if(i)throw i[0]}}}catch(e){return e}}))}),Qa=T(Ga,17,"#runControl",Pa,Va,Qa),Ha=T(Ga,17,"#runObjects",Ra,Va,Ha),Xa=T(Ga,17,"#dispose",Ua,Va,Xa),k(Ga,Oh);class Fh{constructor(e,t,i){B(this,Ka),B(this,qa),B(this,Za),B(this,Ja,!0),B(this,$a,!1),B(this,Ya),U(this,qa,e),U(this,Za,t),U(this,Ya,i)}writeUnsigned8(e){return L(this,null,(function*(){return R(this,Ka,eh).call(this),yield R(this,Ka,th).call(this),M(this,qa).writeUnsigned8(e)}))}writeVarInt(e){return L(this,null,(function*(){return R(this,Ka,eh).call(this),yield R(this,Ka,th).call(this),M(this,qa).writeVarInt(e)}))}writeBigVarInt(e){return L(this,null,(function*(){return R(this,Ka,eh).call(this),yield R(this,Ka,th).call(this),M(this,qa).writeBigVarInt(e)}))}write(e){return L(this,null,(function*(){return R(this,Ka,eh).call(this),yield R(this,Ka,th).call(this),M(this,qa).write(e)}))}writeString(e){return L(this,null,(function*(){return R(this,Ka,eh).call(this),yield R(this,Ka,th).call(this),M(this,qa).writeString(e)}))}flush(){return L(this,null,(function*(){R(this,Ka,eh).call(this),U(this,Ja,!0),yield M(this,qa).flush()}))}close(){return L(this,null,(function*(){M(this,$a)||(U(this,Ja,!0),yield R(this,Ka,th).call(this,!1),yield M(this,qa).flush(),U(this,$a,!0),M(this,Ya).call(this))}))}}qa=new WeakMap,Za=new WeakMap,Ja=new WeakMap,$a=new WeakMap,Ya=new WeakMap,Ka=new WeakSet,eh=function(){if(M(this,$a))throw new Error("Stream is closed")},th=function(e=!0){if(M(this,Ja))return U(this,Ja,!1),M(this,qa).writeUnsigned8(M(this,Za)|(e?128:0))};class Vh{constructor(e,t){B(this,ch),B(this,ih),B(this,sh),B(this,nh),B(this,rh),B(this,oh,new Map),B(this,ah,Me.get().createContext("WebSocketConnection")),B(this,hh,new Set(new Array(128).fill(0).map(((e,t)=>t+1)))),U(this,ih,e),U(this,sh,t),U(this,nh,new ReadableStream(new fr(e))),M(this,ih).addEventListener("close",(()=>{M(this,sh).markPostHandshake(),M(this,oh).forEach((e=>e.close()))}))}openSendStream(){const e=M(this,hh).values().next().value;if(!e)throw new Error("No stream IDs available");return M(this,hh).delete(e),Promise.resolve(new Fh(new kr(M(this,ih)),e,(()=>R(this,ch,lh).call(this,e))))}transportType(){return"websocket"}url(){return M(this,ih).url}afterHandshake(){return M(this,sh).postHandshake()}objectStream(){return L(this,null,(function*(){for(var e;;){U(this,rh,M(this,nh).getReader());try{const{value:e,done:t}=yield M(this,rh).read();if(t)return;const[i,s,n]=e;if(M(this,oh).has(Y(s))){const e=M(this,oh).get(Y(s));if(!e)throw new Error("Stream not found");n.length>0&&(yield e.push(n)),i||(M(this,ah).debug("Closing stream",{streamId:s}),e.close(),M(this,oh).delete(Y(s)))}else{M(this,ah).debug("Creating new stream",{streamId:s});const[e,t]=Q(1e3),r=new ReadableStream({pull(e){return L(this,null,(function*(){const i=yield t.pop();i?e.enqueue(i):e.close()}))}});if(M(this,oh).set(Y(s),e),i||(M(this,ah).debug("Closing new stream",{streamId:s}),yield r.cancel(),M(this,oh).delete(Y(s))),n.length>0)return yield mr(new gr(n,r),s)}}finally{null==(e=M(this,rh))||e.releaseLock()}}}))}close(){var e;return M(this,sh).cancel().catch(j),M(this,nh).cancel("closing").catch(j),null==(e=M(this,rh))||e.cancel("closing").catch(j),M(this,ih).close()}closed(){return Promise.resolve()}writeMessage(e){return L(this,null,(function*(){yield M(this,sh).write(e)}))}readMessage(){return L(this,null,(function*(){return M(this,sh).read()}))}}ih=new WeakMap,sh=new WeakMap,nh=new WeakMap,rh=new WeakMap,oh=new WeakMap,ah=new WeakMap,hh=new WeakMap,ch=new WeakSet,lh=function(e){M(this,hh).add(e)};class Nh{constructor(e,t,i){B(this,Ah),B(this,uh),B(this,dh),B(this,mh,new J(100)),B(this,ph),B(this,fh,0),B(this,gh,Me.get().createContext("WebTransportConnection")),U(this,ph,i),U(this,uh,e),U(this,dh,t),R(this,Ah,wh).call(this).catch((e=>{M(this,gh).debug("Incoming streams handling ended with error",e),M(this,dh).markPostHandshake(),M(this,mh).close()}))}openSendStream(){return L(this,null,(function*(){const e=yield M(this,uh).createUnidirectionalStream();return new Ar(e)}))}transportType(){return"webtransport"}url(){return M(this,ph)}afterHandshake(){return M(this,dh).postHandshake()}closed(){return L(this,null,(function*(){yield M(this,uh).closed}))}close(){M(this,uh).close()}writeMessage(e){return L(this,null,(function*(){yield M(this,dh).write(e)}))}readMessage(){return L(this,null,(function*(){return M(this,dh).read()}))}objectStream(){return L(this,null,(function*(){return M(this,mh).pop()}))}}function jh(e){return L(this,null,(function*(){const t=new WebSocket(e.wsUrl||e.url);t.binaryType="arraybuffer",yield new Promise(((e,i)=>{t.addEventListener("error",(()=>i(new Error("WebSocket error"))),{once:!0}),t.addEventListener("open",e,{once:!0})}));const i=ko.wrapWebsocket(t);Eo(i,e.role).catch((()=>{t.close()}));const s=new Vh(t,i);return new Oh(s,e.authToken)}))}uh=new WeakMap,dh=new WeakMap,mh=new WeakMap,ph=new WeakMap,fh=new WeakMap,gh=new WeakMap,Ah=new WeakSet,wh=function(){return L(this,null,(function*(){const e=M(this,uh).incomingUnidirectionalStreams.getReader();for(;;){const{value:t,done:i}=yield e.read();if(i)return void M(this,mh).close();const s=new gr(new Uint8Array,t);yield M(this,mh).push(mr(s,M(this,fh))),P(this,fh)._++}}))};class Gh{constructor(){B(this,yh,{name:"",priority:0,groupOrder:"descending",filterType:{type:"latest-group"}})}name(e){return M(this,yh).name=e,this}priority(e){return M(this,yh).priority=e,this}groupOrder(e){return M(this,yh).groupOrder=e,this}startGroup(e){return M(this,yh).filterType={type:"absolute-start",start:{group:e,object:Y(0)}},this}range(e,t){return M(this,yh).filterType={type:"absolute-range",start:{group:e,object:Y(0)},end:{group:t,object:Y(0)}},this}build(){return M(this,yh)}}yh=new WeakMap;class zh{constructor(e,t){B(this,vh),B(this,bh),U(this,vh,e),U(this,bh,t)}subscribe(e){return M(this,vh).subscribe(this.namespace(),e)}closed(){return M(this,vh).closed()}namespace(){return M(this,bh).namespace}}function Qh(e){const t=e[1];if(!t)throw new Error("namespace must contain a channel ID");return t}vh=new WeakMap,bh=new WeakMap;const Hh=class e{constructor(e,t){B(this,xh),B(this,Sh),B(this,kh),B(this,Eh,new z(100)),B(this,Th),B(this,Ih),B(this,Ch,(e=>L(this,null,(function*(){if(!e)return M(this,Sh).close();if(M(this,Th))return;const t=M(this,Eh).items().reduce(((e,t)=>e<t?e:t),e);U(this,Th,R(this,xh,Mh).call(this,t,e)),0===M(this,Th).size&&(yield M(this,Sh).close())})))),U(this,Sh,e),U(this,kh,t),e.done().then((e=>L(this,null,(function*(){var t;return M(this,Ch).call(this,null==(t=e.finalInfo)?void 0:t.group)})))).catch(j),U(this,Ih,e.groups())}static subscribe(t,i){return L(this,null,(function*(){const s=yield t.subscribe(i);return new e(s,void 0)}))}subscribeId(){return M(this,Sh).id}name(){return M(this,Sh).name}largestGroupId(){return M(this,kh)}needsRenewal(){return"active"===M(this,Sh).expiryState()&&void 0===M(this,Th)}endOfTrack(e){const t=M(this,Eh).items().reduce(((e,t)=>e<t?e:t),e);return this.update(t,e)}update(e,t){return L(this,null,(function*(){return U(this,Th,R(this,xh,Mh).call(this,e,t)),0===M(this,Th).size&&(yield M(this,Sh).close()),M(this,Sh).update(e,t)}))}unsubscribe(){return M(this,Sh).unsubscribe()}next(){return L(this,null,(function*(){var e;if(M(this,Th)&&0===M(this,Th).size)return{done:!0,value:void 0};const t=yield M(this,Ih).next();if(t.done)return t;const i=t.value.groupId();return null==(e=M(this,Th))||e.delete(i),M(this,Eh).push(i),M(this,kh)||U(this,kh,i),U(this,kh,M(this,kh)<i?i:M(this,kh)),t}))}return(){return M(this,Sh).return()}[Symbol.asyncIterator](){return this}};Sh=new WeakMap,kh=new WeakMap,Eh=new WeakMap,Th=new WeakMap,Ih=new WeakMap,Ch=new WeakMap,xh=new WeakSet,Mh=function(e,t){const i=new Set;for(let s=e;s<=t;s++)null==i||i.add(s);return M(this,Eh).items().forEach((e=>{null==i||i.delete(e)})),i};let Xh=Hh;var qh,Zh,Jh,$h,Yh,Kh,ec;const tc=class e{constructor(e){B(this,Yh),B(this,qh),B(this,Zh),B(this,Jh,new J(10)),B(this,$h),B(this,ec,((e,t)=>L(this,null,(function*(){var i=[];try{const s=F(i,yield M(this,qh).lock()),n={subscribeId:s.value.subscribeId()};if(!s.value.needsRenewal())return void M(this,$h).debug("Subscription does not need renewal",n);const r=s.value.largestGroupId(),o=void 0!==r,a=(new Gh).name(t.name).priority(t.priority).groupOrder(t.groupOrder);switch(n.largestGroupId=r,M(this,$h).debug("Renewing subscription",n),t.filterType.type){case"absolute-range":return void M(this,$h).debug("Absolute range is not renewed",n);case"absolute-start":case"latest-group":case"latest-object":o&&a.startGroup(r+Y(1))}const h=a.build();n.newTrack=h;const[c]=yield Promise.all([e.subscribe(h),o?s.value.update(r,r):s.value.unsubscribe()]);c.done().then((()=>R(this,Yh,Kh).call(this,c))).catch(j),c.expiryNotification().then((()=>M(this,ec).call(this,e,h))).catch(j);const l=new Xh(c,r);s.value=l,yield M(this,Jh).push(l),M(this,$h).info("Subscription renewed",n)}catch(e){var s=e,n=!0}finally{V(i,s,n)}})))),U(this,qh,new Ve(e)),U(this,Zh,e),U(this,$h,Me.get().createContext(`Renewable '${e.name()}'`))}static subscribe(t,i,s){return L(this,null,(function*(){const n=yield t.subscribe(i),r=new e(new Xh(n,s));return n.done().then((()=>{var e;return R(e=r,Yh,Kh).call(e,n)})).catch(j),n.expiryNotification().then((()=>{var e;return M(e=r,ec).call(e,t,i)})).catch(j),r}))}largestGroupId(){return M(this,qh).unsafeValue().largestGroupId()}update(e,t){return L(this,null,(function*(){var i=[];try{const s=F(i,yield M(this,qh).lock());return M(this,Jh).close(),s.value.update(e,t)}catch(e){var s=e,n=!0}finally{V(i,s,n)}}))}endOfTrack(e){return L(this,null,(function*(){var t=[];try{const i=F(t,yield M(this,qh).lock());return M(this,Jh).close(),i.value.endOfTrack(e)}catch(e){var i=e,s=!0}finally{V(t,i,s)}}))}unsubscribe(){return L(this,null,(function*(){var e=[];try{const t=F(e,yield M(this,qh).lock());return M(this,Jh).close(),t.value.unsubscribe()}catch(e){var t=e,i=!0}finally{V(e,t,i)}}))}return(){return L(this,null,(function*(){var e=[];try{const t=F(e,yield M(this,qh).lock());return M(this,Jh).close(),t.value.return()}catch(e){var t=e,i=!0}finally{V(e,t,i)}}))}next(){return L(this,null,(function*(){var e,t;const i=yield M(this,Zh).next();if(i.done){yield null==(t=(e=M(this,Zh)).return)?void 0:t.call(e);const i=yield M(this,Jh).pop();if(i)return U(this,Zh,i),this.next()}return i}))}[Symbol.asyncIterator](){return this}objects(){return _(this,null,(function*(){try{for(var e,t,i,s=O(this);e=!(t=yield new D(s.next())).done;e=!1){var n=t.value,r=[];try{const e=F(r,n,!0);yield*W(e)}catch(e){var o=e,a=!0}finally{var h=V(r,o,a);h&&(yield new D(h))}}}catch(t){i=[t]}finally{try{e&&(t=s.return)&&(yield new D(t.call(s)))}finally{if(i)throw i[0]}}}))}};qh=new WeakMap,Zh=new WeakMap,Jh=new WeakMap,$h=new WeakMap,Yh=new WeakSet,Kh=function(e){return L(this,null,(function*(){var t;if(e.unsubscribed()||null!=(t=e.range())&&t.endGroup)M(this,$h).info("Server initiated subscribe done but the subscription is already closing");else{if(M(this,qh).unsafeValue().subscribeId()===e.id)return this.return();M(this,$h).info("subscribeId mismatch - the subscription already has been renewed")}}))},ec=new WeakMap;let ic=tc;function sc(e){const t=function(e){const t=(new TextDecoder).decode(e);return JSON.parse(t)}(e.payload);if(!function(e){return"tracks"in e}(t))throw new Error("unexpected catalog type");return t}var nc,rc,oc,ac,hc,cc;nc=new WeakMap,rc=new WeakMap,oc=new WeakMap,ac=new WeakMap,hc=new WeakSet,cc=function(){return L(this,null,(function*(){const e=yield M(this,oc).promise;try{for(var t,i,s,n=O(e);t=!(i=yield n.next()).done;t=!1){const e=i.value;if(0!==e.objectStatus)continue;const t=sc(e);M(this,nc).update(t)}}catch(i){s=[i]}finally{try{t&&(i=n.return)&&(yield i.call(n))}finally{if(s)throw s[0]}}}))};let lc=class e{constructor(e,t,i){B(this,hc),B(this,nc),B(this,rc),B(this,oc),B(this,ac),U(this,rc,e),U(this,nc,t),U(this,oc,i),U(this,ac,R(this,hc,cc).call(this)),this.closed().finally((()=>M(this,nc).close())).catch(j)}catalog(){return M(this,nc)}closed(){return M(this,ac)}close(){return L(this,null,(function*(){return M(this,nc).close(),(yield M(this,rc).promise).unsubscribe()}))}static start(t,i){return L(this,null,(function*(){const s=G.fromPromise(ic.subscribe(t,(new Gh).name(i.catalogName||"catalog").groupOrder("ascending").build())),n=G.fromPromise(s.promise.then((e=>e.objects())));if(i.catalog)return new e(s,new Ne(i.catalog),n);const r=yield(yield n.promise).next();if(!r.value)throw new Error("No catalog found");const o=sc(r.value);return new e(s,new Ne(o),n)}))}};var uc,dc,mc,pc,fc,gc,Ac,wc,yc,vc,bc,Sc;class kc{constructor(e,t,i,s){B(this,fc),B(this,uc),B(this,dc),B(this,mc),I(this,"track"),B(this,pc,Me.get().createContext("CmafGroup")),this.track=s,U(this,uc,i),U(this,dc,e),U(this,mc,t)}[Symbol.asyncIterator](){return _(this,null,(function*(){const e={name:this.track.trackObject.name,namespace:this.track.namespace};M(this,pc).debug("start",g({},e));try{for(var t,i,s,n=O(M(this,dc));t=!(i=yield new D(n.next())).done;t=!1){const t=i.value;if(4===t.objectStatus&&(yield new D(this.track.endOfTrack(t.groupId))),0!==t.objectStatus)continue;const s=M(this,mc).createFragment(t.payload),n=s.timescale(),r=s.baseMediaDecodeTime()/n*1e3,o=r+s.duration()/n*1e3,a=M(this,uc)/1e3*n;s.updateBaseMediaDecodeTime(s.baseMediaDecodeTime()-a);const h=this.track.timestampRange();if(h&&r>=h[1])break;M(this,pc).debug("fragment",A(g({},e),{startTime:r,endTime:o,subscribeId:t.subscribeId,groupId:t.groupId,objectId:t.objectId,streamId:t.streamId})),yield[t.groupId,s]}}catch(i){s=[i]}finally{try{t&&(i=n.return)&&(yield new D(i.call(n)))}finally{if(s)throw s[0]}}M(this,pc).debug("end",g({},e))}))}[Ue()](){return R(this,fc,gc).call(this)}[Symbol.asyncDispose](){return R(this,fc,gc).call(this)}}uc=new WeakMap,dc=new WeakMap,mc=new WeakMap,pc=new WeakMap,fc=new WeakSet,gc=function(){return L(this,null,(function*(){var e,t;return yield null==(t=(e=M(this,dc)).return)?void 0:t.call(e),Promise.resolve()}))};const Ec=class e{constructor(e,t,i,s,n){B(this,Ac),B(this,wc),B(this,yc),B(this,vc),I(this,"trackObject"),I(this,"namespace"),this.trackObject=e,this.namespace=t,U(this,wc,i),U(this,Ac,s),U(this,yc,n)}static subscribe(t,i,s,r){return L(this,null,(function*(){var o;if("cmaf"!==i.format)throw new Error("format must be cmaf");const a=(new Gh).name(i.name);r&&a.startGroup(r);const h=a.build();if(i.initTrack){const n=(new Gh).name(i.initTrack).build(),[a,c]=yield Promise.all([R(o=e,bc,Sc).call(o,t,n),ic.subscribe(t,h,r?r-Y(1):void 0)]),l=new gs(a);return new e(i,t.namespace(),c,l,s)}(0,n.a)(i.initData,"no init data found on track");const c=$(i.initData),l=new gs(new Uint8Array(c)),u=yield ic.subscribe(t,h,r?r-Y(1):void 0);return new e(i,t.namespace(),u,l,s)}))}largestGroupId(){return M(this,wc).largestGroupId()}stopAfterTimestampReached(e){U(this,vc,[0,e])}timestampRange(){return M(this,vc)}endOfTrack(e){return M(this,wc).endOfTrack(e)}update(e,t){return M(this,wc).update(e,t)}unsubscribe(){return L(this,null,(function*(){return M(this,wc).unsubscribe()}))}next(){return L(this,null,(function*(){const e=yield M(this,wc).next();return e.done?e:{done:!1,value:new kc(e.value,M(this,Ac),M(this,yc),this)}}))}return(){return L(this,null,(function*(){return yield M(this,wc).return(),{done:!0,value:void 0}}))}[Symbol.asyncIterator](){return this}[Ue()](){return this.unsubscribe()}[Symbol.asyncDispose](){return L(this,null,(function*(){return this.unsubscribe()}))}};Ac=new WeakMap,wc=new WeakMap,yc=new WeakMap,vc=new WeakMap,bc=new WeakSet,Sc=function(e,t){return L(this,null,(function*(){var i=[];try{const s=F(i,yield e.subscribe(t),!0),n=yield s.objects().next();if(n.done)throw new Error("No init object");return yield s.close(),n.value.payload}catch(e){var s=e,n=!0}finally{var r=V(i,s,n);r&&(yield r)}}))},B(Ec,bc);let Tc=Ec;var Ic,Cc,xc,Mc,Bc,Uc,Rc,Pc,Lc;Ic=new WeakMap,Cc=new WeakMap,xc=new WeakMap,Mc=new WeakMap,Bc=new WeakMap,Uc=new WeakMap,Rc=new WeakSet,Pc=function(e){return L(this,null,(function*(){const t=yield e.promise;try{for(var i,s,n,r=O(t);i=!(s=yield r.next()).done;i=!1){var o=s.value,a=[];try{const e=F(a,o,!0);try{for(var h,c,l,u=O(e);h=!(c=yield u.next()).done;h=!1){const e=c.value;if(0!==e.objectStatus)continue;const i=_c(e.payload);M(this,Cc).update((e=>{var t,s;for(e.push(...i),e.sort(((e,t)=>e.wallclock-t.wallclock));e[0]&&(null!=(s=null==(t=e[e.length-1])?void 0:t.wallclock)?s:0)-e[0].wallclock>3e4;)e.shift();return e})),t===M(this,xc).resolved&&e.groupId>Y(0)&&e.objectId==Y(0)&&R(this,Rc,Lc).call(this,e.groupId).catch((e=>{M(this,Ic).warn("backfill failed",e)}))}}catch(c){l=[c]}finally{try{h&&(c=u.return)&&(yield c.call(u))}finally{if(l)throw l[0]}}}catch(e){var d=e,m=!0}finally{var p=V(a,d,m);p&&(yield p)}}}catch(s){n=[s]}finally{try{i&&(s=r.return)&&(yield s.call(r))}finally{if(n)throw n[0]}}}))},Lc=function(e){return L(this,null,(function*(){const t=e-Y(1),i=this.timeline(),s=i[0],n=i[i.length-1];if(!s||!n||n.wallclock-s.wallclock>1e4)return;const r=G.fromPromise(ic.subscribe(M(this,Mc),(new Gh).name(M(this,Bc)).groupOrder("ascending").range(t,t).build()));return R(this,Rc,Pc).call(this,r)}))};let Dc=class e{constructor(e,t,i){B(this,Rc),B(this,Ic,Me.get().createContext("Timeline")),B(this,Cc,new Ne([])),B(this,xc),B(this,Mc),B(this,Bc),B(this,Uc),U(this,Mc,e),U(this,Bc,i),U(this,xc,t),U(this,Uc,R(this,Rc,Pc).call(this,M(this,xc))),this.closed().finally((()=>M(this,Cc).close())).catch(j)}closed(){return M(this,Uc)}close(){return L(this,null,(function*(){return(yield M(this,xc).promise).unsubscribe()}))}timeline(){const[e,t]=M(this,Cc).value();return e}timestampWallclockOffset(){return we(this.timeline().map((e=>e.mediaPts-e.wallclock)))}static start(t,i){const s=G.fromPromise(ic.subscribe(t,(new Gh).name(i).groupOrder("ascending").build()));return new e(t,s,i)}waitForWallclockTime(e){return L(this,null,(function*(){return yield M(this,Cc).waitFor((t=>!!t.find((t=>t.wallclock>=e)))),this.timeline()}))}waitForTimelineToHaveMinDuration(){return L(this,null,(function*(){return yield M(this,Cc).waitFor((e=>{const t=e[0],i=e[e.length-1];return!(!t||!i)&&i.wallclock-t.wallclock>1e4})),this.timeline()}))}};function _c(e){var t;const i=new TextDecoder("utf-8").decode(e).split("\n");return null!=(t=i[0])&&t.startsWith("MEDIA_PTS")&&i.shift(),i.filter((e=>e.length>0)).map((e=>{const[t,i,s,n,r]=e.split(",");if(!t||!n)throw new Error(`invalid timeline row: ${e}`);return{mediaPts:parseInt(t),groupId:i?parseInt(i):void 0,objectId:s?parseInt(s):void 0,wallclock:parseInt(n),metadata:r}}))}var Wc,Oc,Fc,Vc;const Nc=class e{constructor(e,t,i,s,n){B(this,Wc,new tn),B(this,Oc),B(this,Fc),B(this,Vc,0),I(this,"trackObject"),I(this,"namespace"),U(this,Fc,e),U(this,Oc,t),this.trackObject=i,this.namespace=s,U(this,Vc,n)}static subscribe(t,i,s){return L(this,null,(function*(){if("string"!=typeof i.language)throw new Error("track object language is required");const n=(new Gh).name(i.name).build(),r=yield ic.subscribe(t,n),o=r.objects();return new e(r,o,i,t.namespace(),s)}))}largestGroupId(){return M(this,Fc).largestGroupId()}update(e,t){return M(this,Fc).update(e,t)}unsubscribe(){return M(this,Fc).unsubscribe()}next(){return L(this,null,(function*(){for(;;){const e=yield M(this,Oc).next();if(e.done)return e;if(0!==e.value.objectStatus)continue;const t=(new TextDecoder).decode(e.value.payload),i=M(this,Wc).parse(t).map((e=>(e.startTime-=M(this,Vc)/1e3,e.endTime-=M(this,Vc)/1e3,e)));return{done:!1,value:{language:this.trackObject.language,cues:i}}}}))}return(){return L(this,null,(function*(){return yield M(this,Fc).return(),{done:!0,value:void 0}}))}[Symbol.asyncIterator](){return this}[Ue()](){return this.unsubscribe()}[Symbol.asyncDispose](){return this.unsubscribe()}};Wc=new WeakMap,Oc=new WeakMap,Fc=new WeakMap,Vc=new WeakMap;let jc=Nc;var Gc,zc,Qc,Hc,Xc,qc,Zc,Jc;Gc=[Be({context:"Channel",enter:"info"})];const $c=class e{constructor(e,t,i,s,n){B(this,Zc),I(this,"namespace"),B(this,zc),B(this,Qc),B(this,Hc),B(this,Xc),this.namespace=s,U(this,zc,e),U(this,Qc,t),U(this,Hc,i),U(this,Xc,n)}static start(t,i){return L(this,null,(function*(){const s=new zh(t,{namespace:i.namespace}),[n,r]=yield Promise.all([Dc.start(s,"timeline"),lc.start(s,{catalog:i.catalog,namespace:i.namespace})]);return new e(s,n,r,i.namespace,0)}))}closed(){return M(this,Hc).closed()}catalog(){return M(this,Hc).catalog()}timestampWallclockOffset(){return M(this,Qc).timestampWallclockOffset()}timestampOffsetMs(){return M(this,Xc)}setTimestampOffsetMs(e){U(this,Xc,e)}waitForWallclockTime(e){return M(this,Qc).waitForWallclockTime(e)}subscribeCmafTrack(e,t){const i=this.catalog().current().tracks,s=void 0!==e["com.vindral.variant_uid"]?i.find((t=>t["com.vindral.variant_uid"]===e["com.vindral.variant_uid"])):void 0;return R(this,Zc,Jc).call(this,(()=>Tc.subscribe(M(this,zc),null!=s?s:e,M(this,Xc),t)))}subscribeWebVttTrack(e){return R(this,Zc,Jc).call(this,(()=>jc.subscribe(M(this,zc),e,M(this,Xc))))}subscribeTrack(e){return R(this,Zc,Jc).call(this,(()=>M(this,zc).subscribe(e)))}close(){return Promise.all([M(this,Hc).close(),M(this,Qc).close()])}};qc=y(null),zc=new WeakMap,Qc=new WeakMap,Hc=new WeakMap,Xc=new WeakMap,Zc=new WeakSet,Jc=function(e){return L(this,null,(function*(){const[t,i]=this.catalog().value();try{return yield e()}catch(s){if(t===this.catalog().current()&&i&&(yield Promise.race([i,$e(500)])),t!==this.catalog().current())return e();throw s}}))},T(qc,9,"start",Gc,$c),k(qc,$c),E(qc,3,$c);let Yc=$c;var Kc,el,tl,il;Kc=new WeakMap,el=new WeakMap,tl=new WeakSet,il=function(e){return L(this,null,(function*(){try{for(var t,i,s,n=O(e.value);t=!(i=yield n.next()).done;t=!1){const e=i.value;U(this,Kc,{createdAt:new Date,wallclock:new Date(e.ntpTimestamp),rtt:e.rtt})}}catch(i){s=[i]}finally{try{t&&(i=n.return)&&(yield i.call(n))}finally{if(s)throw s[0]}}}))};let sl=class e{constructor(e){B(this,tl),B(this,Kc),B(this,el);const[t,i]=e.value.value();U(this,Kc,{createdAt:new Date,wallclock:new Date(t.ntpTimestamp),rtt:t.rtt}),U(this,el,R(this,tl,il).call(this,e))}wallclock(){const e=Date.now()-M(this,Kc).createdAt.getTime();return M(this,Kc).wallclock.getTime()+e}closed(){return M(this,el)}static start(t){return new e(t)}};function nl(e){return"string"==typeof e||null==e}function rl(e){try{return $(e)}catch(e){throw new Error("Failed to convert fairplayCertificate")}}class ol{constructor(e){I(this,"value"),this.value=e}static create(e,t,i){return L(this,null,(function*(){var s=[];try{const n=F(s,yield e.subscribeTrack((new Gh).name("drm").build()),!0).objects(),r=yield n.next();if(r.done)throw new Error("No drm object received");const o=function(e){const t=(new TextDecoder).decode(e),i=JSON.parse(t);if(!function(e){return"provider"in e&&"string"==typeof e.provider&&(!("widevineLicenseUrl"in e)||nl(e.widevineLicenseUrl))&&(!("playreadyLicenseUrl"in e)||nl(e.playreadyLicenseUrl))&&(!("fairplayLicenseUrl"in e)||nl(e.fairplayLicenseUrl))&&(!("fairplayCertificate"in e)||nl(e.fairplayCertificate))}(i))throw new Error("Invalid drm object");const s=i,{fairplayCertificate:n}=s,r=((e,t)=>{var i={};for(var s in e)u.call(e,s)&&t.indexOf(s)<0&&(i[s]=e[s]);if(null!=e&&l)for(var s of l(e))t.indexOf(s)<0&&d.call(e,s)&&(i[s]=e[s]);return i})(s,["fairplayCertificate"]);return A(g({},r),{fairplayCertificate:n?rl(n):void 0})}(r.value.payload);return new ol(A(g({},o),{videoCodec:t,audioCodec:i}))}catch(e){var n=e,r=!0}finally{var o=V(s,n,r);o&&(yield o)}}))}}function al(e){const t=(new TextDecoder).decode(e),i=JSON.parse(t);if(!function(e){return"rtt"in e&&"number"==typeof e.rtt&&"ntpTimestamp"in e&&"number"==typeof e.ntpTimestamp&&"estimatedBandwidth"in e&&"number"==typeof e.estimatedBandwidth}(i))throw new Error("Invalid stats object");return i}var hl,cl,ll;hl=new WeakMap,cl=new WeakSet,ll=function(e){return L(this,null,(function*(){try{for(var t,i,s,n=O(e);t=!(i=yield n.next()).done;t=!1){const e=i.value;if(0!==e.objectStatus)continue;const t=al(e.payload);this.value.update(t)}}catch(i){s=[i]}finally{try{t&&(i=n.return)&&(yield i.call(n))}finally{if(s)throw s[0]}}}))};let ul=class e{constructor(e,t,i){B(this,cl),I(this,"ip"),I(this,"value"),B(this,hl),this.ip=i,this.value=new Ne(t),U(this,hl,R(this,cl,ll).call(this,e))}closed(){return M(this,hl)}idleTimeout(){return L(this,null,(function*(){for(;;){const[e,t]=this.value.value();try{yield Promise.race([Ye(1e4,new Error("Idle timeout")),t])}catch(e){return e}}}))}static start(t){return L(this,null,(function*(){const i=(yield t.subscribe((new Gh).name("stats").groupOrder("ascending").build())).objects(),s=yield i.next();if(s.done)throw new Error("No stats object received");const n=al(s.value.payload);if(!n.ip)throw new Error("Expected IP in initial stats object");return new e(i,n,n.ip)}))}};var dl,ml,pl,fl,gl,Al,wl,yl,vl,bl,Sl,kl,El,Tl,Il,Cl,xl,Ml,Bl,Ul,Rl,Pl,Ll;class Dl{constructor(e){B(this,dl,Me.get().createContext("UpstreamWatcher")),B(this,ml),U(this,ml,new Ne(G.fromPromise(e.closed())))}update(e){M(this,ml).update(G.fromPromise(e.closed()))}closed(){return L(this,null,(function*(){try{for(;;){const[e,t]=M(this,ml).value();let i=!1;yield Promise.race([null==t?void 0:t.then((()=>i=!0)),e.promise.then((()=>{if(!i)throw M(this,dl).warn("Upstream closed"),new Error("Upstream closed")}))])}}catch(e){return e}}))}}dl=new WeakMap,ml=new WeakMap;class _l{constructor(e,t){B(this,pl,Me.get().createContext("TracksIterator")),B(this,fl),B(this,gl),U(this,fl,e),U(this,gl,t)}[Symbol.asyncIterator](){return _(this,null,(function*(){const e=M(this,gl);try{for(var t,i,s,n=O(M(this,fl));t=!(i=yield new D(n.next())).done;t=!1){const t=i.value;if(!t)continue;const s={name:t.trackObject.name,namespace:t.namespace};M(this,pl).debug("track start",g({mediaType:e},s)),yield*W(t),M(this,pl).debug("track end",g({mediaType:e},s))}}catch(i){s=[i]}finally{try{t&&(i=n.return)&&(yield new D(i.call(n)))}finally{if(s)throw s[0]}}M(this,pl).debug("tracks ended",{mediaType:e})}))}}pl=new WeakMap,fl=new WeakMap,gl=new WeakMap,yl=[Be({context:"Player",enter:"info"})],wl=[Be({context:"Player",enter:"info",return:"info"})],Al=[Be({context:"Player",enter:"info"})];const Wl=class e{constructor(e,t,i){E(Ml,5,this),B(this,Bl),B(this,vl),B(this,bl),B(this,Sl),B(this,kl),B(this,El,new Ne(void 0)),B(this,Tl,new Ne(void 0)),B(this,Il,new Ne(void 0)),B(this,Cl),B(this,xl),I(this,"subtitles",new _l(M(this,Il),"subtitles")),I(this,"video",new _l(M(this,Tl),"video")),I(this,"audio",new _l(M(this,El),"audio")),U(this,vl,e),U(this,bl,sl.start(i)),U(this,Sl,i),U(this,kl,new Ne(t)),U(this,Cl,new Dl(t)),U(this,xl,Promise.race([i.idleTimeout(),R(this,Bl,Pl).call(this),M(this,Cl).closed()])),M(this,vl).closed().then((()=>this.close())).catch(j)}closed(){return M(this,xl)}static start(t,i){return L(this,null,(function*(){const s=new zh(t,{namespace:("auxiliary",["com.vindral.moq","auxiliary"])}),[[n,r,o],a]=yield Promise.all([Yc.start(t,i).then((e=>Promise.all([Promise.resolve(e),i.videoTrack?e.subscribeCmafTrack(i.videoTrack):void 0,i.audioTrack?e.subscribeCmafTrack(i.audioTrack):void 0]))),ul.start(s)]),h=new e(t,n,a);return o&&M(h,El).update(o),r&&M(h,Tl).update(r),h}))}connectionInfo(){const e=M(this,Sl).value.current();return{ip:M(this,Sl).ip,rtt:e.rtt,estimatedBandwidth:e.estimatedBandwidth}}stats(){return M(this,Sl).value}catalog(){return M(this,kl).current().catalog()}namespace(){return M(this,kl).current().namespace}videoTrack(){var e;return null==(e=M(this,Tl).current())?void 0:e.trackObject}audioTrack(){var e;return null==(e=M(this,El).current())?void 0:e.trackObject}referenceClock(){return M(this,bl)}drm(){return L(this,null,(function*(){var e,t;if(this.catalog().current().tracks.find((({name:e})=>"drm"===e)))return ol.create(M(this,kl).current(),null==(e=this.videoTrack())?void 0:e.codec,null==(t=this.audioTrack())?void 0:t.codec)}))}close(){return Promise.all([M(this,kl).current().close(),M(this,kl).close(),R(this,Bl,Ul).call(this,M(this,El)),R(this,Bl,Ul).call(this,M(this,Tl)),R(this,Bl,Ul).call(this,M(this,Il))])}zap(e,t){return L(this,null,(function*(){var i,s;const n=yield Yc.start(M(this,vl),e),r=M(this,bl).wallclock()-t,o=M(this,kl).current(),a=o.timestampWallclockOffset(),h=yield n.waitForWallclockTime(r);M(this,Cl).update(n),yield M(this,kl).current().close();const c=h.toReversed().find((e=>e.wallclock<=r)),l=null!=c&&c.mediaPts?c.mediaPts-o.timestampOffsetMs():void 0,u=n.timestampWallclockOffset()-a+o.timestampOffsetMs();n.setTimestampOffsetMs(u);const d=null!=c&&c.groupId?Y(c.groupId):void 0;l&&(null==(i=M(this,Tl).current())||i.stopAfterTimestampReached(l),null==(s=M(this,El).current())||s.stopAfterTimestampReached(l)),M(this,kl).update(n),yield Promise.all([e.videoTrack?this.setVideoTrack(e.videoTrack,d):void 0,e.audioTrack?this.setAudioTrack(e.audioTrack,d):void 0])}))}setSubtitleTrack(e){return L(this,null,(function*(){var t,i;if(!e)return void(yield null==(t=M(this,Il).current())?void 0:t.unsubscribe());const[s]=yield Promise.all([M(this,kl).current().subscribeWebVttTrack(e),null==(i=M(this,Il).current())?void 0:i.unsubscribe()]);M(this,Il).update(s)}))}setVideoTrack(e,t){return L(this,null,(function*(){const i=yield R(this,Bl,Rl).call(this,M(this,kl).current(),e,M(this,Tl).current(),t);M(this,Tl).update(i)}))}setAudioTrack(e,t){return L(this,null,(function*(){const i=yield R(this,Bl,Rl).call(this,M(this,kl).current(),e,M(this,El).current(),t);M(this,El).update(i)}))}};Ml=y(null),vl=new WeakMap,bl=new WeakMap,Sl=new WeakMap,kl=new WeakMap,El=new WeakMap,Tl=new WeakMap,Il=new WeakMap,Cl=new WeakMap,xl=new WeakMap,Bl=new WeakSet,Ul=function(e){const t=e.current(),i=null==t?void 0:t.largestGroupId();return e.isClosed()||e.update(void 0),e.close(),i?null==t?void 0:t.update(i,i):null==t?void 0:t.unsubscribe()},Rl=function(e,t,i,s){return L(this,null,(function*(){const n=null==i?void 0:i.largestGroupId(),[r,o]=yield Promise.all([e.subscribeCmafTrack(t,s||(n?n+Y(1):void 0)),n?null==i?void 0:i.update(n,n):null==i?void 0:i.unsubscribe()]);return r}))},Pl=function(){return L(this,null,(function*(){try{for(var e,t,i,s=O(M(this,kl));e=!(t=yield s.next()).done;e=!1){const e=t.value;try{for(var n,r,o,a=O(e.catalog());n=!(r=yield a.next()).done;n=!1){const e=r.value;yield Promise.all([R(this,Bl,Ll).call(this,e,M(this,Tl)),R(this,Bl,Ll).call(this,e,M(this,El))])}}catch(r){o=[r]}finally{try{n&&(r=a.return)&&(yield r.call(a))}finally{if(o)throw o[0]}}}}catch(t){i=[t]}finally{try{e&&(t=s.return)&&(yield t.call(s))}finally{if(i)throw i[0]}}}))},Ll=function(e,t){return L(this,null,(function*(){const i=t.current();if(!i)return;const s=i.trackObject.name,n=i.trackObject["com.vindral.variant_uid"],r=e.tracks.find((e=>e.name===s)),o=e.tracks.find((e=>e["com.vindral.variant_uid"]===n));if(!r){if(!o)return void t.update(void 0);t.update(yield M(this,kl).current().subscribeCmafTrack(o))}}))},T(Ml,1,"close",yl,Wl),T(Ml,1,"zap",wl,Wl),Rl=T(Ml,17,"#replaceTrack",Al,Bl,Rl),k(Ml,Wl);let Ol=Wl;function Fl(e,t,i){const s=new URL("/voq/subscribe",e);return s.searchParams.set("sessionId",t.sessionId),s.searchParams.set("clientId",t.clientId),s.searchParams.set("channelId",t.channelId),i&&s.searchParams.set("authToken",i),s}var Vl,Nl,jl,Gl,zl,Ql,Hl,Xl,ql,Zl,Jl,$l,Yl,Kl,eu,tu,iu,su,nu,ru;Vl=new WeakMap,Nl=new WeakMap,jl=new WeakMap,Gl=new WeakMap,zl=new WeakMap,Ql=new WeakMap,Hl=new WeakMap,Xl=new WeakMap,ql=new WeakMap,Zl=new WeakMap,Jl=new WeakSet,$l=function(){return L(this,null,(function*(){try{for(var e,t,i,s=O(M(this,zl).stats());e=!(t=yield s.next()).done;e=!1){const{rtt:e}=t.value;M(this,Xl).push(e)}}catch(t){i=[t]}finally{try{e&&(t=s.return)&&(yield t.call(s))}finally{if(i)throw i[0]}}}))},Yl=new WeakMap,Kl=new WeakMap,eu=new WeakMap,tu=function(e){return L(this,null,(function*(){var t;const i=yield M(this,Hl).connect({channelId:e});if(!(0,n.i)(i))throw new Error("no moq connect info found");const s=null==(t=i.channels.find((t=>t.channelId===e)))?void 0:t.catalog;if(!s)throw new Error("no catalog found");return s}))},iu=function(e){return L(this,null,(function*(){var t,i,s;M(this,Nl).info("handle subscription",e);const n=M(this,zl);let r=M(this,Ql).get(e.channelId);if(r||(r=new uu(new Ne(yield R(this,Jl,tu).call(this,e.channelId))),M(this,Ql).set(e.channelId,r)),n.namespace().join("/")!==r.namespace().join("/")){M(this,Nl).info("changing channel",e.channelId);const i=r.getVideoTrack(e.video),s=r.getAudioTrack(e.audio);return yield n.zap({namespace:r.namespace(),catalog:r.catalog(),videoTrack:null==i?void 0:i.track,audioTrack:null==s?void 0:s.track},500),n.drm().then((e=>{e&&M(this,Vl).emit("received drm data",e.value)})).catch((e=>{M(this,Nl).error("Error getting DRM data",e)})),M(this,Nl).info("switched channel",e.channelId),null==(t=M(this,Ql).get(Qh(n.namespace())))||t.updateCatalog(n.catalog()),void M(this,Vl).emit("received signal",{type:"subscription changed",subscription:e})}const o=r.getVideoTrack(e.video),a=r.getAudioTrack(e.audio);yield Promise.all([o&&o.track.name!==(null==(i=M(this,zl).videoTrack())?void 0:i.name)?M(this,zl).setVideoTrack(o.track):void 0,a&&a.track.name!==(null==(s=M(this,zl).audioTrack())?void 0:s.name)?M(this,zl).setAudioTrack(a.track):void 0]),M(this,Vl).emit("received signal",{type:"subscription changed",subscription:e})}))},su=function(){return L(this,null,(function*(){try{U(this,Gl,"connecting"),M(this,Nl).info("Connecting..."),U(this,Gl,"connected"),yield Promise.all([R(this,Jl,ru).call(this,M(this,zl).referenceClock(),M(this,zl).audio),R(this,Jl,ru).call(this,M(this,zl).referenceClock(),M(this,zl).video),R(this,Jl,nu).call(this,M(this,zl).subtitles)]),yield M(this,zl).closed(),M(this,jl).close(),M(this,Nl).info("Session closed")}catch(e){M(this,Nl).warn("Session error",e)}}))},nu=function(e){return L(this,null,(function*(){try{for(var t,i,s,n=O(e);t=!(i=yield n.next()).done;t=!1){const e=i.value;M(this,Vl).emit("text track data",e)}}catch(i){s=[i]}finally{try{t&&(i=n.return)&&(yield i.call(n))}finally{if(s)throw s[0]}}}))},ru=function(e,t){return L(this,null,(function*(){var i;let s,r="",o="";const a=void 0===M(this,zl).videoTrack();try{for(var h,c,l,u=O(t);h=!(c=yield u.next()).done;h=!1){const t=c.value,h=Qh(t.track.namespace),l=t.track.trackObject.language,u=(0,n.c)(null!=(i=t.track.trackObject.codec)?i:""),A=t.track.trackObject.codec,w=u?it({codec:u,codecString:A}):void 0,y=!!t.track.trackObject["com.vindral.drm"];try{for(var d,m,p,f=O(t);d=!(m=yield f.next()).done;d=!1){const[i,n]=m.value,c={channelId:""===r||!a&&"video"!==n.mediaType()||r===h?void 0:h,language:"audio"===n.mediaType()&&o!==l?l:void 0,drmTransition:void 0!==s&&s!==y};r=h,o=l,s=y;const d=n.producerReferenceTime(),p=M(this,Zl).get(t.track.namespace)||0;if(d&&Date.now()-p>1e3){M(this,Zl).set(t.track.namespace,Date.now());const s=e.wallclock()-d.getTime();M(this,Nl).debug("timing-info",{mediaType:n.mediaType(),referenceClock:e,delta:s,groupId:i,timestamp:n.baseMediaDecodeTime()/n.timescale()*1e3+s,wallclockTime:d.getTime()}),M(this,Vl).emit("received signal",{type:"timing info",timingInfo:{channelId:h,timestamp:n.baseMediaDecodeTime()/n.timescale()*1e3+s,wallclockTime:d.getTime()}})}M(this,Vl).emit("received moq data",{payload:n,channelId:h,groupId:i,mimeType:w,codec:u,switchInfo:c,renditionId:(g=t.track.trackObject.name,g.split("").reduce(((e,t)=>t.charCodeAt(0)+(e<<6)+(e<<16)-e),0))})}}catch(m){p=[m]}finally{try{d&&(m=f.return)&&(yield m.call(f))}finally{if(p)throw p[0]}}}}catch(c){l=[c]}finally{try{h&&(c=u.return)&&(yield c.call(u))}finally{if(l)throw l[0]}}var g}))};let ou=class e{constructor(e,t,i,s,r,o){B(this,Jl),B(this,Vl),B(this,Nl),B(this,jl),B(this,Gl,"disconnected"),B(this,zl),B(this,Ql,new Map),B(this,Hl),B(this,Xl,new z(10)),B(this,ql,Number.MAX_SAFE_INTEGER),B(this,Zl,new Map),B(this,Yl,(e=>{if(!e)return void M(this,zl).setSubtitleTrack(void 0).catch(j);const t=M(this,Ql).get(Qh(M(this,zl).namespace())),i=null==t?void 0:t.getTextTrack(e);i&&M(this,zl).setSubtitleTrack(i).catch(j)})),B(this,Kl,(e=>{switch(e.type){case"subscribe":if(M(this,eu))return void M(this,Nl).info("Ignoring  - we are already switching");U(this,eu,!0),R(this,Jl,iu).call(this,e.subscription).catch((t=>{M(this,Nl).error("error handling subscription",t),M(this,Vl).emit("received signal",{type:"subscription changed",subscription:e.subscription,reset:!0})})).finally((()=>U(this,eu,!1)));break;case"telemetry":(0,n.p)(new URL("/api/telemetry",M(this,jl).url().replace("wss://","https://")),{body:e.body,headers:{"Content-Type":"text/plain"}}).catch(j);break;case"refresh auth":M(this,jl).updateAuthToken(e.token)}})),B(this,eu,!1),I(this,"disconnect",((e="Disconnect Requested")=>{M(this,Nl).info("Disconnecting",e),M(this,jl).close(),M(this,zl).close().catch(j),U(this,Zl,new Map),U(this,Gl,"disconnected")})),U(this,Vl,e),U(this,Nl,t),U(this,jl,i),U(this,zl,s),U(this,Ql,r),U(this,Hl,o),M(this,Vl).on("send signal",M(this,Kl)),M(this,Vl).on("disconnect",this.disconnect),M(this,Vl).on("text track",M(this,Yl)),R(this,Jl,$l).call(this).catch(j),R(this,Jl,su).call(this).catch(j)}get estimatedBandwidth(){return M(this,ql)}unload(){M(this,Vl).off("send signal",M(this,Kl)),M(this,Vl).off("disconnect",this.disconnect),M(this,Vl).off("text track",M(this,Yl)),this.disconnect()}suspend(){}unsuspend(){}getStatistics(){const e=M(this,zl).connectionInfo().estimatedBandwidth;return{rtt:ye(M(this,Xl).items()),estimatedBandwidth:e,connectCount:0,connectionAttemptCount:0,edgeUrl:M(this,jl).url(),connectionProtocol:"moq"}}static start(t,i,s,r){return L(this,null,(function*(){var o,a,h,c;const l=new Map(r.connectInfo.channels.map((e=>[Qh(e.catalog.namespace),new uu(new Ne(e.catalog))]))),u=yield r.onConnectInfo(r.connectInfo),d=r.options.get("authenticationToken");let m,p;"string"==typeof r.edgeUrl?m=Fl(r.edgeUrl,u,d):(m=Fl(r.edgeUrl.moqUrl||r.edgeUrl.moqWsUrl,u,d),p=Fl(r.edgeUrl.moqWsUrl,u,d));const f=null==(o=r.connectInfo.channels.find((e=>e.channelId===u.channelId)))?void 0:o.catalog;i.debug("Resolved edge url",{edgeUrl:m,edgeWsUrl:p}),(0,n.a)(f,"no catalog found");const g=null==(a=l.get(Qh(f.namespace)))?void 0:a.getVideoTrack(u.video),A=null==(h=l.get(Qh(f.namespace)))?void 0:h.getAudioTrack(u.audio),w=yield function(e){return L(this,null,(function*(){if(self.WebTransport&&"websocket"!==(null==e?void 0:e.preferredTransport)&&e.url.protocol.startsWith("https")){const t=function(e){return L(this,null,(function*(){const t=new Uint8Array(32);for(let e=0;e<t.length;e+=1)t[e]=parseInt("60b82e8021689e163c1041b4475ef9c86e7565bc45d1a0aa43f5148769f461c7".slice(2*e,2*e+2),16);const i=new WebTransport(e.url,{congestionControl:"low-latency"});yield Promise.race([i.ready,i.closed.then((()=>Promise.reject(new Error("WebTransport closed"))))]);const s=yield i.createBidirectionalStream(),n=ko.wrapWebTransport(s);Eo(n,e.role).catch((()=>{i.close()}));const r=new Nh(i,n,e.url.toString());return new Oh(r,e.authToken)}))}(e).catch((()=>jh(e)));return(yield Promise.race([t,$e(e.websocketFallbackTimeoutMs)]))||jh(e)}return jh(e)}))}({url:m,wsUrl:p,authToken:r.options.get("authenticationToken"),preferredTransport:r.options.get("webtransportEnabled")?"webtransport":"websocket",role:2,websocketFallbackTimeoutMs:2e3}),y=yield Promise.race([Ol.start(w.subscriber,{namespace:f.namespace,catalog:f,videoTrack:null==g?void 0:g.track,audioTrack:null==A?void 0:A.track}),Ye(1e4,new Error("Timeout waiting for player to start")),Ke(w.closed(),"Session closed before player started")]),v=new uu(y.catalog());l.set(Qh(f.namespace),v),t.emit("received signal",{type:"client ip",ip:y.connectionInfo().ip}),y.drm().then((e=>{e&&t.emit("received drm data",e.value)})).catch((e=>{i.error("Error getting DRM data",e)}));const b=new e(t,i,w,y,l,s);return u.textTrack&&M(c=b,Yl).call(c,u.textTrack),b}))}getState(){return M(this,Gl)}get rtt(){return M(this,zl).connectionInfo().rtt}close(){M(this,jl).close()}closed(){return Promise.race([M(this,jl).closed(),M(this,zl).closed()])}};var au,hu,cu,lu;class uu{constructor(e){B(this,cu),B(this,au),B(this,hu),U(this,au,e),U(this,hu,R(this,cu,lu).call(this))}catalog(){return M(this,au).current()}namespace(){return M(this,au).current().namespace}updateCatalog(e){U(this,au,e)}getTextTrack(e){return M(this,au).current().tracks.find((t=>t.label===e))}getAudioTrack(e){if(!e.codec)return;const t=M(this,hu).filter((t=>!(!tt(t)||t.bitRate>e.bitRate||e.codec&&t.codec!==e.codec||e.language&&t.language!==e.language)));return t[t.length-1]}getVideoTrack(e){if(!e.codec)return;const t=M(this,hu).filter((t=>!(!et(t)||t.bitRate>e.bitRate||e.codec&&t.codec!==e.codec)));return t[t.length-1]}renditions(){return M(this,hu)}}au=new WeakMap,hu=new WeakMap,cu=new WeakSet,lu=function(){const[e,t]=M(this,au).value();return(0,n.b)(e)};class du extends s.E{constructor(e,t){super(),I(this,"options"),I(this,"websockets",[]),I(this,"logger"),I(this,"reconnectState",{reconnectRetries:0}),I(this,"isSuspended",!1),I(this,"_connectionAttemptCount",0),I(this,"connectStartTime",0),I(this,"_connectTime"),I(this,"shouldContinueConnecting",!1),I(this,"_isConnectInProgress",!1),I(this,"readyState",(()=>{if(0===this.websockets.length)return WebSocket.CLOSED;const e=this.websockets.map((e=>e.readyState));for(const t of e)if(t!==WebSocket.OPEN)return t;return WebSocket.OPEN})),I(this,"url",(()=>{var e;return null==(e=this.websockets[0])?void 0:e.url})),I(this,"send",(e=>{var t;this.websockets.length&&(null==(t=this.websockets[0])||t.send(e))})),I(this,"close",(e=>{var t;let i=!1;return null==(t=this.websockets)||t.forEach((t=>{t.onmessage=j,t.removeEventListener("error",this.onError),t.removeEventListener("close",this.onClose),t.removeEventListener("open",this.onOpen),t.close(1e3,e),i=!0})),this.websockets=[],this.shouldContinueConnecting=!1,this._isConnectInProgress=!1,this.logger.info("Closed websocket",{reason:e}),i})),I(this,"suspend",(()=>{this.isSuspended=!0})),I(this,"unsuspend",(()=>{this.isSuspended=!1,this.readyState()!==WebSocket.OPEN&&!this.isConnectInProgress&&this.connect()})),I(this,"onMessage",((e,t)=>{0!==this.websockets.length&&this.options.onMessage(e,t.data)})),I(this,"onError",(()=>{this.logger.info("On error",g({},this.options)),this.close("one websocket had an error"),this.emit("error",new at("WebSocket error",{code:"websocket_error",isFatal:!1}))})),I(this,"onClose",(e=>{switch(this.logger.info("Closed",A(g({},this.options),{reason:e.reason,code:e.code,isSuspended:this.isSuspended})),this.close("one websocket was closed"),e.code){case 4e3:case 4001:this.emit("error",mt(dt()));break;case 4002:this.emit("error",(i=dt(),new at("Authentication Expired",{isFatal:!0,code:"authentication_expired",source:i})));break;case 4003:this.emit("error",pt("internal",dt()));break;case 4010:this.emit("error",(t=dt(),new at("Connection closed due to inactivity",{isFatal:!1,code:"connection_inactivity",source:t,type:"internal"})))}var t,i;this.emit("close",this)})),I(this,"onOpen",(()=>{this.logger.info("Opened",g({},this.options)),this.readyState()===WebSocket.OPEN&&(this._connectTime=Date.now()-this.connectStartTime,this.reconnectState.reconnectRetries=0,this._isConnectInProgress=!1,this.emit("open",this))})),I(this,"connect",((e=!1)=>L(this,null,(function*(){if(this.isConnectInProgress)return this.logger.info("Connect already in progress"),!1;if(this.isSuspended)return!1;if(this.readyState()!==WebSocket.CLOSED&&this.close("new connection in progress"),this.shouldContinueConnecting=!0,this._isConnectInProgress=!0,e&&this.options.reconnectDelay>0){this.logger.info("Waiting for reconnect delay",g({},this.options)),yield $e(this.options.reconnectDelay);const e=yield this.options.reconnectHandler(this.reconnectState);if(this.reconnectState.reconnectRetries++,!e)return this._isConnectInProgress=!1,this.emit("error",ft()),!1}this._connectionAttemptCount++;try{if(!this.shouldContinueConnecting)return this._isConnectInProgress=!1,this.logger.info("Connection aborted"),!1;const{url:e,connectionCount:t}=yield this.options.connectHandler();if(this.connectStartTime=Date.now(),!this.shouldContinueConnecting)return this._isConnectInProgress=!1,this.logger.info("Connection aborted"),!1;this.logger.info("Connecting websockets",A(g({},this.options),{url:e}));for(let i=0;i<t;i++){const t=new WebSocket(e);t.binaryType="arraybuffer",t.onmessage=e=>this.onMessage(i,e),t.addEventListener("error",this.onError),t.addEventListener("close",this.onClose),t.addEventListener("open",this.onOpen),this.websockets.push(t)}return!0}catch(e){return this._isConnectInProgress=!1,e instanceof at&&(this.logger.error("Failed to connect",e.toStringifiable()),e.isFatal())||this.shouldContinueConnecting&&(this.logger.info("Connection aborted",{error:e}),this.emit("error",new at("Failed to connect",{code:"failed_to_connect",isFatal:!1,source:e,type:"internal"}))),!1}})))),this.options=e,this.logger=t}get isConnectInProgress(){return this._isConnectInProgress}get connectionCount(){return this.websockets.length}get connectionAttemptCount(){return this._connectionAttemptCount}get connectTime(){return this._connectTime}}const mu=e=>471859200/e,pu=class e{constructor(t,i,s){I(this,"emitter"),I(this,"transport"),I(this,"logger"),I(this,"config"),I(this,"rtts",new z(10)),I(this,"lastPingSentTime",Date.now()),I(this,"isPingInFlight",!1),I(this,"connectCount",0),I(this,"missedPings",0),I(this,"_estimatedPingBandwidth"),I(this,"contextSwitchesInProgress",new Set),I(this,"contextSwitchesCompleted",new Set),I(this,"buffer",[]),I(this,"disconnected",new G),I(this,"unload",(()=>{this.logger.debug("Unloading module..."),this.close("Unloading"),this.emitter.off("send signal",this.sendSignal),this.emitter.off("disconnect",this.close),this.emitter.off("reconnect",this.reconnect),this.logger.debug("Unloaded module")})),I(this,"suspend",(()=>{this.resetPingState(),this.transport.suspend()})),I(this,"unsuspend",(()=>{this.transport.unsuspend()})),I(this,"getState",(()=>{switch(this.transport.readyState()){case WebSocket.OPEN:return"connected";case WebSocket.CONNECTING:return"connecting";default:return"disconnected"}})),I(this,"sendSignal",(e=>{this.logger.debug("sending signal",{signal:e}),this.transport.readyState()===WebSocket.OPEN?this.transport.send(JSON.stringify(e)):this.logger.debug("transport is closed")})),I(this,"getStatistics",(()=>{var e;const t=ye(this.rtts.items());return{rtt:t,estimatedBandwidth:mu(t.average),edgeUrl:null==(e=this.transport)?void 0:e.url(),connectionProtocol:"vindral_ws"}})),I(this,"onMessage",((e,t)=>{var i;if(this.pingCooldownExpired()&&this.sendPing(),this.contextSwitchesCompleted.size===(null==(i=this.transport)?void 0:i.connectionCount)){this.logger.info("Completing context switch"),this.contextSwitchesInProgress.clear(),this.contextSwitchesCompleted.clear();const e=this.buffer.filter((([e,t])=>!(t instanceof ArrayBuffer))),t=this.buffer.filter((([e,t])=>t instanceof ArrayBuffer));e.map((e=>this.handleMessage(e[0],e[1]))),t.map((e=>this.handleMessage(e[0],e[1]))),this.buffer=[]}if(this.contextSwitchesInProgress.has(e)){if(!(t instanceof ArrayBuffer)){const i=JSON.parse(t);if(rt(i)&&"context switch complete"===i.type)return this.logger.info("context switch completed",{socketId:e}),this.emitter.emit("context switch complete"),void this.contextSwitchesCompleted.add(e)}this.buffer.push([e,t])}else this.handleMessage(e,t)})),I(this,"resolveEdgeUrl",(()=>L(this,null,(function*(){const e=this.config.connectInfo,t=yield this.config.onConnectInfo(e),i=this.config.options.getOverride("separateVideoSocketEnabled",t.channelId);let s=1;"audio+video"===this.config.options.get("media")&&(s=!1!==i?2:1);const n=((e,t)=>{const i=new URL("/subscribe",e);return i.searchParams.append("channelId",t.channelId),i.searchParams.append("sessionId",t.sessionId),i.searchParams.append("clientId",t.clientId),t.audio&&t.audio.codec&&(i.searchParams.append("audio.bitRate",Math.round(t.audio.bitRate).toString()),i.searchParams.append("audio.codec",t.audio.codec),t.audio.language&&i.searchParams.append("audio.language",t.audio.language)),t.video&&t.video.codec&&(i.searchParams.append("video.width",t.video.width.toString()),i.searchParams.append("video.height",t.video.height.toString()),i.searchParams.append("video.bitRate",Math.round(t.video.bitRate).toString()),i.searchParams.append("video.codec",t.video.codec)),t.expectAdditionalConnection&&i.searchParams.append("expectAdditionalConnection",t.expectAdditionalConnection.toString()),t.burstMs&&i.searchParams.append("burstMs",t.burstMs.toString()),t.channelGroupId&&i.searchParams.append("channelGroupId",t.channelGroupId),t.authToken&&(i.searchParams.append("auth.token",t.authToken),i.searchParams.append("auth.type","jwt")),i.toString()})(this.config.edgeUrl,{video:t.video,audio:t.audio,burstMs:t.burstMs,sessionId:t.sessionId,clientId:t.clientId,channelId:t.channelId,channelGroupId:t.channelGroupId,expectAdditionalConnection:s>1,authToken:this.config.options.get("authenticationToken")});return this.logger.debug("Resolved edge url",{edgeUrl:n}),{url:n,connectionCount:s}})))),I(this,"handleMessage",((e,t)=>{if(t instanceof ArrayBuffer)this.emitter.emit("received data",t);else{const i=JSON.parse(t);if(!rt(i))return;switch(i.type){case"pong":this.lastPingSentTime&&(this.rtts.push(Date.now()-this.lastPingSentTime),this.isPingInFlight=!1,this.emitter.emit("rtt",this.rtt));break;case"context switch":this.logger.info("Starting context switch",{socketId:e}),this.emitter.emit("context switch started"),this.contextSwitchesInProgress.add(e);break;default:this.emitter.emit("received signal",i)}}})),I(this,"connectWebSocketTransport",(()=>{const e=new du({reconnectDelay:1e3,onMessage:this.onMessage,reconnectHandler:this.config.reconnectHandler,connectHandler:this.resolveEdgeUrl},this.logger.createContext("Transport"));return e.on("open",this.onTransportChange),e.on("close",this.onTransportChange),e.on("error",(e=>this.disconnected.reject(e))),e.connect(),e})),I(this,"close",((e="Disconnect Requested")=>{var t;this.contextSwitchesCompleted.clear(),this.contextSwitchesInProgress.clear(),this.buffer=[],this.resetPingState(),this.disconnected.resolve(),null==(t=this.transport)||t.close(e)})),I(this,"onTransportChange",(()=>{var t;"connected"===this.getState()?(null!=(t=this.transport)&&t.connectTime&&(this.rtts.push(this.transport.connectTime/e.TLS_ROUNDTRIPS/this.transport.connectionCount),this.emitter.emit("rtt",this.rtt)),this.connectCount++,this.resetPingState()):(this.contextSwitchesCompleted.clear(),this.contextSwitchesInProgress.clear(),this.buffer=[],this.resetPingState(),this.disconnected.resolve()),this.emitter.emit("connection state",this.getState())})),I(this,"reconnect",(e=>{this.transport.isConnectInProgress?this.logger.debug("Stopping reconnect, already mid-connection"):this.close(e)})),I(this,"resetPingState",(()=>{this.missedPings=0,this.isPingInFlight=!1})),I(this,"pingCooldownExpired",(()=>Date.now()-this.lastPingSentTime>e.PING_INTERVAL)),I(this,"sendPing",(()=>{if(this.isPingInFlight)return this.missedPings++,void(this.missedPings>e.MAX_MISSED_PINGS&&this.reconnect("missed pings"));this.isPingInFlight=!0,this.lastPingSentTime=Date.now(),this.missedPings=0,this.sendSignal({type:"ping"})})),this._estimatedPingBandwidth=mu(s.estimatedRtt),this.logger=i,this.emitter=t,this.config=s,this.emitter.on("send signal",this.sendSignal),this.emitter.on("disconnect",this.close),this.emitter.on("reconnect",this.reconnect),this.disconnected.promise.catch(j),this.transport=this.connectWebSocketTransport()}get rtt(){return this.rtts.items().length>0?we(this.rtts.items()):0}get estimatedBandwidth(){return this.rtt>0?mu(this.rtt):this._estimatedPingBandwidth}closed(){return this.disconnected.promise}};I(pu,"PING_INTERVAL",5e3),I(pu,"MAX_MISSED_PINGS",4),I(pu,"TLS_ROUNDTRIPS",3),I(pu,"start",((e,t,i)=>new Promise(((s,n)=>{const r=new pu(e,t,i);r.transport.once("error",(e=>n(e))),r.transport.once("open",(()=>s(r)))}))));let fu=pu;var gu,Au,wu,yu,vu,bu,Su,ku,Eu,Tu,Iu,Cu,xu;class Mu{constructor(e){B(this,gu),B(this,Au,[]),B(this,wu),U(this,gu,e)}select(e){if(M(this,gu).edgeUrl)return M(this,gu).edgeUrl;0===M(this,Au).length&&U(this,Au,M(this,Au).concat(e));const t=M(this,Au).shift();return U(this,wu,t),t||void 0}shiftedEdge(){return M(this,wu)}reset(){U(this,wu,void 0),U(this,Au,[])}}gu=new WeakMap,Au=new WeakMap,wu=new WeakMap;const Bu=class e{constructor(t,i,s){B(this,Cu),I(this,"emitter"),I(this,"logger"),I(this,"config"),I(this,"apiClient"),I(this,"connectionImpl"),B(this,yu,!0),B(this,vu),B(this,bu,0),B(this,Su,0),B(this,ku),B(this,Eu),I(this,"unload",(()=>{var e;this.logger.debug("Unloading module..."),this.disconnect("Unloading"),null==(e=this.connectionImpl)||e.unload(),this.logger.debug("Unloaded module")})),I(this,"suspend",(()=>{var e;U(this,yu,!1),null==(e=this.connectionImpl)||e.suspend()})),I(this,"unsuspend",(()=>{var e;U(this,yu,!0),null==(e=this.connectionImpl)||e.unsuspend(),this.connect()})),I(this,"getState",(()=>this.connectionImpl?this.connectionImpl.getState():"disconnected")),I(this,"getStatistics",(()=>this.connectionImpl?A(g({},this.connectionImpl.getStatistics()),{connectCount:M(this,Su),connectionAttemptCount:M(this,bu)}):{rtt:{min:0,max:0,average:0,last:0},estimatedBandwidth:0,connectCount:M(this,Su),connectionAttemptCount:M(this,bu),connectionProtocol:void 0})),I(this,"connect",(()=>{U(this,yu,!0),!M(this,vu)&&U(this,vu,R(this,Cu,xu).call(this))})),I(this,"disconnect",((e="Disconnect Requested")=>{var t;U(this,yu,!1),null==(t=this.connectionImpl)||t.close(e)})),I(this,"reconnect",(e=>{this.disconnect(e),this.connect()})),B(this,Tu,(()=>L(this,null,(function*(){try{return yield this.apiClient.connect(this.config.options.getOptions())}catch(t){if((0,n.d)(t))switch(t.status){case 401:throw this.emitter.emit("error",mt(t)),mt(t);case 403:throw this.emitter.emit("error",gt(t.message)),gt(t.message)}throw this.emitter.emit("error",(e=t instanceof Error?t:void 0,new at("Connection attempt failed",{isFatal:!1,code:"connection_failed",source:e}))),t}var e})))),B(this,Iu,(()=>L(this,null,(function*(){const t=Date.now(),i=()=>Date.now()-t;return Promise.race([$e(e.PING_TIMEOUT),fetch(new URL("/api/v4/connect/ping",this.config.options.get("url")).toString(),{method:"HEAD"})]).then(i,i)})))),this.logger=i,this.emitter=t,this.config=s,this.apiClient=new n.A({publicEndpoint:this.config.options.get("url").toString(),tokenFactory:()=>this.config.options.get("authenticationToken")})}get rtt(){var e,t;return null!=(t=null==(e=this.connectionImpl)?void 0:e.rtt)?t:0}get estimatedBandwidth(){var e;return(null==(e=this.connectionImpl)?void 0:e.estimatedBandwidth)||Number.MAX_SAFE_INTEGER}get firstConnectionTime(){return M(this,ku)}get lastConnectionTime(){return M(this,Eu)}};yu=new WeakMap,vu=new WeakMap,bu=new WeakMap,Su=new WeakMap,ku=new WeakMap,Eu=new WeakMap,Tu=new WeakMap,Iu=new WeakMap,Cu=new WeakSet,xu=function(){return L(this,null,(function*(){var e;const t=new Mu({edgeUrl:this.config.options.get("edgeUrl")});for(U(this,bu,0);;){P(this,bu)._++;try{const[e,i]=yield Promise.all([M(this,Tu).call(this),M(this,Iu).call(this)]),s=i/2;if(!M(this,yu))break;const r=t.select(e.edges);if(!r)throw new at("Failed to resolve edge url",{isFatal:!0,code:"failed_to_resolve_edge_url"});(0,n.i)(e)?this.connectionImpl=yield ou.start(this.emitter,this.logger,this.apiClient,A(g({},this.config),{connectInfo:e,estimatedRtt:s,edgeUrl:r})):((0,n.a)("string"==typeof r,"Edge URL is expected to be a string"),this.connectionImpl=yield fu.start(this.emitter,this.logger,A(g({},this.config),{connectInfo:e,estimatedRtt:s,edgeUrl:r}))),t.reset(),P(this,Su)._++,U(this,bu,0),U(this,Eu,Date.now()),M(this,ku)||U(this,ku,M(this,Eu)),yield this.connectionImpl.closed()}catch(e){this.logger.info("Failed to connect",e);const i=t.shiftedEdge();i&&this.emitter.emit("telemetry event",{code:"shifted_edge",edgeUrl:"string"==typeof i?i:i.moqUrl||i.moqWsUrl}),e instanceof at?this.emitter.emit("error",e):e instanceof Error&&this.emitter.emit("error",new at(e.message,{code:"start_failed",isFatal:!1}))}if(null==(e=this.connectionImpl)||e.unload(),this.connectionImpl=void 0,!M(this,yu))break;if(!(yield this.config.reconnectHandler({reconnectRetries:M(this,bu)}))){this.emitter.emit("error",ft());break}if(yield $e(1e3),!M(this,yu))break}U(this,vu,void 0)}))},I(Bu,"PING_TIMEOUT",1e3),I(Bu,"create",((e,t,i)=>new Bu(e,t,i)));let Uu=Bu;const Ru=()=>({video:A(g({},nt()),{bitRate:st()}),audio:{bitRate:st()}}),Pu=class e{constructor(t,i,s,n){I(this,"emitter"),I(this,"timers",new qe),I(this,"pictureInPictureSource"),I(this,"element"),I(this,"currentCap"),I(this,"userSpecifiedCap"),I(this,"renditionLevelSource"),I(this,"resizeObserver"),I(this,"elementSize"),I(this,"_sizeBasedResolutionCapEnabled"),I(this,"unload",(()=>{var e;this.emitter.off("enter picture in picture",this.enterPictureInPicture),this.emitter.off("exit picture in picture",this.exitPictureInPicture),null==(e=this.resizeObserver)||e.disconnect(),this.suspend()})),I(this,"load",(()=>{window.ResizeObserver&&(this.resizeObserver=new ResizeObserver(this.onResize),this.resizeObserver.observe(this.element)),this.evaluateConstraintCap()})),I(this,"unsuspend",(()=>{this.timers.setInterval(this.evaluateConstraintCap,e.CHECK_SIZE_INTERVAL),this.evaluateConstraintCap()})),I(this,"suspend",(()=>{this.timers.unload()})),I(this,"setUserSpecifiedCap",(e=>{var t;const i=null!=(t=this.getUserSpecifiedCap())?t:Ru();this.userSpecifiedCap=A(g({},i),{video:g(g({},i.video),e.video),audio:g(g({},i.audio),e.audio)}),this.evaluateConstraintCap()})),I(this,"getUserSpecifiedCap",(()=>this.userSpecifiedCap)),I(this,"getCurrentConstraintCap",(()=>this.currentCap)),I(this,"getStatistics",(()=>({constraintCap:this.getUserSpecifiedCap(),windowInnerWidth:window.innerWidth,windowInnerHeight:window.innerHeight,elementWidth:this.elementSize.width,elementHeight:this.elementSize.height,pixelRatio:window.devicePixelRatio}))),I(this,"constrainSubscription",(e=>{const t=this.getCurrentConstraintCap();return t&&(e.video.codec&&(e.video.bitRate=Math.min(t.video.bitRate,e.video.bitRate),e.video.width=Math.min(t.video.width,e.video.width),e.video.height=Math.min(t.video.height,e.video.height)),e.audio.codec&&(e.audio.bitRate=Math.min(t.audio.bitRate,e.audio.bitRate))),e})),I(this,"onResize",(e=>{e.forEach((e=>{this.elementSize={width:e.contentRect.width,height:e.contentRect.height}}))})),I(this,"evaluateConstraintCap",(()=>{var e,t,i,s,n;const r=this.sizeBasedResolutionCapEnabled?A(g({},Ru()),{video:{width:window.innerWidth,height:window.innerHeight,bitRate:st()}}):Ru();if(!this.resizeObserver){const e=this.element.getBoundingClientRect();this.elementSize={width:e.width,height:e.height}}if(this.sizeBasedResolutionCapEnabled){const t=window.devicePixelRatio,i=null==(e=this.pictureInPictureSource)?void 0:e.getPictureInPictureSize();this.elementSize.width>0&&this.elementSize.height>0&&(r.video.width=this.elementSize.width,r.video.height=this.elementSize.height),i&&(r.video.width=i.width,r.video.height=i.height),r.video.width*=t,r.video.height*=t}const o=this.renditionLevelSource.getRenditionLevels().find((e=>{if(e.video)return e.video.width/e.video.height>r.video.width/r.video.height?e.video.width>r.video.width:e.video.height>r.video.height}));o&&o.video&&(r.video.width=o.video.width,r.video.height=o.video.height);const a=null==(t=this.userSpecifiedCap)?void 0:t.video,h=null==(i=this.userSpecifiedCap)?void 0:i.audio;a&&(r.video.width>a.width&&(r.video.width=a.width),r.video.height>a.height&&(r.video.height=a.height)),r.video.bitRate=null!=(s=null==a?void 0:a.bitRate)?s:r.video.bitRate,r.audio.bitRate=null!=(n=null==h?void 0:h.bitRate)?n:r.audio.bitRate,be(r,this.currentCap)?this.currentCap=g({},r):(this.currentCap=g({},r),this.emitter.emit("constraint cap changed",r))})),I(this,"enterPictureInPicture",(e=>{this.pictureInPictureSource=e,this.evaluateConstraintCap()})),I(this,"exitPictureInPicture",(()=>{this.pictureInPictureSource=void 0,this.evaluateConstraintCap()})),this.element=i;const r=this.element.getBoundingClientRect();this.elementSize={width:r.width,height:r.height},this.emitter=t,this.renditionLevelSource=s,this._sizeBasedResolutionCapEnabled=n,this.emitter.on("enter picture in picture",this.enterPictureInPicture),this.emitter.on("exit picture in picture",this.exitPictureInPicture)}get sizeBasedResolutionCapEnabled(){return this._sizeBasedResolutionCapEnabled}set sizeBasedResolutionCapEnabled(e){this._sizeBasedResolutionCapEnabled=e,this.evaluateConstraintCap()}};I(Pu,"CHECK_SIZE_INTERVAL",1e3),I(Pu,"create",((e,t,i,s)=>new Pu(e,t,i,s)));let Lu=Pu;class Du{constructor(e,t,i,s){I(this,"timers",qe.create()),I(this,"logger"),I(this,"emitter"),I(this,"trackContexts"),I(this,"playbackSource"),I(this,"isSuspended",!1),I(this,"load",(()=>{this.timers.setInterval(this.emitDecodedFrames,100),this.timers.setInterval(this.emitDecodeRate,1e3),this.emitter.on("init segment",this.onInitSegment),this.emitter.on("coded sample",this.decode)})),I(this,"unload",(()=>{this.trackContexts.forEach((({decoderContext:e})=>e.unload())),this.timers.unload(),this.emitter.off("init segment",this.onInitSegment),this.emitter.off("coded sample",this.decode)})),I(this,"suspend",(()=>{this.isSuspended=!0})),I(this,"unsuspend",(()=>{this.isSuspended=!1})),I(this,"getBuffer",(e=>{var t;return null==(t=this.trackContexts.get(e))?void 0:t.buffer})),I(this,"videoDecodeRate",(()=>{var e,t,i;const s=this.trackContexts.get("video"),n=null!=(e=null==s?void 0:s.sampleDuration)?e:40,r=ye(null!=(t=null==s?void 0:s.decodeTime.items())?t:[]),o=ye(null!=(i=null==s?void 0:s.transportTime.items())?i:[]);return n/(r.average+o.average)})),I(this,"getStatistics",(()=>{var e,t,i,s;const n=this.trackContexts.get("video"),r=ye(null!=(e=null==n?void 0:n.decodeTime.items())?e:[]),o=ye(null!=(t=null==n?void 0:n.transportTime.items())?t:[]),a=ye(null!=(s=null==(i=this.trackContexts.get("audio"))?void 0:i.decodeTime.items())?s:[]);return{videoDecodeRate:this.videoDecodeRate(),videoDecodeTime:r,audioDecodeTime:a,videoTransportTime:o}})),I(this,"onInitSegment",(({initSegment:e})=>{var t;const i=null==(t=this.trackContexts.get(e.type))?void 0:t.decoderContext;if(!i)throw new at("No known decoder context",{code:"no_known_decoder_context",isFatal:!1});i.initSegment(e)})),I(this,"decode",(e=>{const t=this.trackContexts.get(e.type);if(!t)throw new at("No known decoder context",{code:"no_known_decoder_context",isFatal:!1});if(this.isSuspended)return;t.sampleDuration=e.duration/e.timescale*1e3;const{decoderContext:i,buffer:s}=t,n=e.timestamp/e.timescale*1e3,r=e.duration/e.timescale*1e3,o=s[s.length-1];!o||n-5>o.end?s.push({start:n,end:n+r}):n+5*r<o.end?t.buffer=[{start:n,end:n+r}]:o.end=n+r,i.enqueue(e),this.emitDecodedFrames()})),I(this,"emitDecodedFrames",(()=>{let e;this.updateBufferState(),this.trackContexts.forEach((t=>{var i,s;let n;for(;void 0!==(n=null==(s=(i=t.decoderContext).error)?void 0:s.call(i));)this.emitter.emit("error",ht(!1,n));for(;void 0!==(e=t.decoderContext.take());){const{statistics:i}=e;i&&(t.decodeTime.push(i.decodeTime),t.transportTime.push((i.transportTimeToWorker+i.transportTimeFromWorker)/i.samplesInBatch)),this.emitter.emit("decoded frame",e)}}))})),I(this,"emitDecodeRate",(()=>{this.emitter.emit("video decode rate",this.videoDecodeRate())})),I(this,"updateBufferState",(()=>{var e,t;let i;if(this.trackContexts.forEach((e=>{var t,s,n,r;if(i){const o=null!=(s=null==(t=e.buffer[e.buffer.length-1])?void 0:t.end)?s:0;(null!=(r=null==(n=i[i.length-1])?void 0:n.end)?r:0)>o&&(i=e.buffer)}else i=e.buffer})),!i)return;const s=this.playbackSource.currentTime<(null!=(t=null==(e=i[i.length-1])?void 0:e.end)?t:0)?"playing":"buffering";this.emitter.emit("buffer state",{buffered:i,currentTime:this.playbackSource.currentTime,isPaused:this.playbackSource.isPaused,playbackState:s})})),this.logger=t,this.emitter=e,this.trackContexts=i,this.playbackSource=s}static create(e,t,s,n,r){return L(this,null,(function*(){const o=new Map;for(const e of s)switch(e.type){case"audio":{const{OpusDecoderContext:t}=yield i.e(597).then(i.bind(i,8597));o.set(e.type,{buffer:[],decoderContext:yield t.create(48e3,2),decodeTime:new z(100),transportTime:new z(100),sampleDuration:40});break}case"video":{const{H264DecoderWorkerContext:t}=yield i.e(790).then(i.bind(i,2790));o.set(e.type,{buffer:[],decoderContext:yield t.create(r),decodeTime:new z(100),transportTime:new z(100),sampleDuration:40});break}}return new Du(e,t,o,n)}))}}const _u=class{constructor(e){I(this,"emitter"),I(this,"isVisibleCount",0),I(this,"isHiddenCount",0),I(this,"isOnlineCount",0),I(this,"isOfflineCount",0),I(this,"isActive","visible"===document.visibilityState),I(this,"unload",(()=>{document.removeEventListener("visibilitychange",this.onVisibilityChanged),window.removeEventListener("pagehide",this.onPageHide),window.removeEventListener("online",this.onOnline),window.removeEventListener("offline",this.onOffline)})),I(this,"load",(()=>{document.addEventListener("visibilitychange",this.onVisibilityChanged),window.addEventListener("pagehide",this.onPageHide),window.addEventListener("online",this.onOnline),window.addEventListener("offline",this.onOffline)})),I(this,"unsuspend",(()=>{})),I(this,"getStatistics",(()=>{var e,t,i,s,n;return{isVisible:this.isVisible,isOnline:this.isOnline,isVisibleCount:this.isVisibleCount,isHiddenCount:this.isHiddenCount,isOnlineCount:this.isOnlineCount,isOfflineCount:this.isOfflineCount,navigatorRtt:null==(e=navigator.connection)?void 0:e.rtt,navigatorEffectiveType:null==(t=navigator.connection)?void 0:t.effectiveType,navigatorConnectionType:null==(i=navigator.connection)?void 0:i.type,navigatorSaveData:null==(s=navigator.connection)?void 0:s.saveData,navigatorDownlink:null==(n=navigator.connection)?void 0:n.downlink}})),I(this,"onOnline",(()=>this.isOnlineCount++)),I(this,"onOffline",(()=>this.isOfflineCount++)),I(this,"onPageHide",(e=>this.emitter.emit("pagehide",e))),I(this,"onVisibilityChanged",(()=>{this.setIsActive("visible"===document.visibilityState)})),I(this,"setIsActive",(e=>{e!==this.isActive&&(this.emitter.emit("page active",e),e?this.isVisibleCount++:this.isHiddenCount++),this.isActive=e})),this.emitter=e}get isOnline(){return navigator.onLine}get isVisible(){return"visible"===document.visibilityState}};I(_u,"create",(e=>new _u(e)));let Wu=_u;const Ou=class e{constructor(t,i,s){var n;I(this,"logger"),I(this,"emitter"),I(this,"waitingEvents",[]),I(this,"isTriggered",(n=e.EVENT_TIMEOUT,(e,t,i)=>e.timestamp<=t||e.timestampAdded<=i-n)),I(this,"timeSource"),I(this,"timers",new qe),I(this,"load",(()=>{this.timers.setInterval(this.onBufferedStateChanged,e.EVENT_CHECK_INTERVAL),this.emitter.on("add event",this.addEvent)})),I(this,"unload",(()=>{this.timers.unload(),this.emitter.off("add event",this.addEvent)})),I(this,"addEvent",(e=>{this.logger.debug("Adding event",{event:e}),!this.waitingEvents.some((t=>void 0!==t.id&&t.id===e.id))&&this.waitingEvents.push(A(g({},e),{timestampAdded:Date.now()}))})),I(this,"extractEvent",((e,t)=>{"video"===t.type&&e.channelId!==t.channelId&&this.addEvent({type:"channel switch",channelId:t.channelId,timestamp:t.timestamp/t.timescale*1e3}),"audio"===t.type&&"audio"===e.type&&void 0!==t.language&&t.language!==e.language&&this.addEvent({type:"language switch",language:t.language,timestamp:t.timestamp/t.timescale*1e3})})),I(this,"onBufferedStateChanged",(()=>{var e;const t=Date.now(),i=null!=(e=this.timeSource.drift)?e:0,s=this.timeSource.serverCurrentTime-i;if(0===this.waitingEvents.length)return;const n=this.waitingEvents.filter((e=>this.isTriggered(e,s,t)));this.waitingEvents=this.waitingEvents.filter((e=>!this.isTriggered(e,s,t))),n.forEach((e=>{this.logger.debug("Emitting event",{event:e}),this.emitter.emit("event",e)}))})),this.logger=i,this.emitter=t,this.timeSource=s}};I(Ou,"EVENT_TIMEOUT",5e3),I(Ou,"EVENT_CHECK_INTERVAL",20),I(Ou,"create",((e,t,i)=>new Ou(e,t,i)));let Fu=Ou;const Vu=class e{constructor(t){I(this,"emitter"),I(this,"timers",qe.create()),I(this,"bytesReceived",new Map),I(this,"timeoutInterval"),I(this,"lastBytesUpdated",Date.now()),I(this,"load",(()=>{this.emitter.on("connection state",this.onConnectionState),this.timers.setInterval((()=>this.bytesReceived.forEach((e=>e.tick()))),100)})),I(this,"unload",(()=>{this.emitter.off("connection state",this.onConnectionState),this.timers.unload()})),I(this,"averageBitRate",(e=>{var t,i;return 8*(null!=(i=null==(t=this.bytesReceived.get(e))?void 0:t.average)?i:0)})),I(this,"totalBytesReceived",(()=>{let e=0;return this.bytesReceived.forEach((t=>{e+=t.total})),e})),I(this,"add",((t,i)=>{let s=this.bytesReceived.get(t);s||(s=new ve(20),this.bytesReceived.set(t,s)),i>0&&(this.lastBytesUpdated=Date.now(),this.timeoutInterval||(this.timeoutInterval=this.timers.setInterval(this.checkTimeout,e.UPDATE_RECEIVED_BYTES_INTERVAL))),s.add(i)})),I(this,"getStatistics",(()=>({bytesReceived:this.totalBytesReceived(),videoBitRate:this.averageBitRate("video"),audioBitRate:this.averageBitRate("audio")}))),I(this,"onConnectionState",(t=>{this.clearTimeoutInterval(),"connected"===t&&(this.lastBytesUpdated=Date.now(),this.timeoutInterval=this.timers.setInterval(this.checkTimeout,e.UPDATE_RECEIVED_BYTES_INTERVAL))})),I(this,"checkTimeout",(()=>{const t=Date.now()-this.lastBytesUpdated;if(0===this.totalBytesReceived()&&t>e.NO_DATA_ERROR_TIMEOUT)return this.emitter.emit("error",new at("No Incoming Data",{isFatal:!1,code:"no_incoming_data_error",source:undefined})),this.emitter.emit("reconnect","no incoming data"),void this.clearTimeoutInterval();t>e.NO_DATA_TIMEOUT&&this.totalBytesReceived()>0&&(this.emitter.emit("no data timeout",this.totalBytesReceived()),this.clearTimeoutInterval())})),I(this,"clearTimeoutInterval",(()=>{this.timeoutInterval&&(this.timers.clearInterval(this.timeoutInterval),this.timeoutInterval=void 0)})),this.emitter=t}};I(Vu,"NO_DATA_ERROR_TIMEOUT",2e4),I(Vu,"NO_DATA_TIMEOUT",5e3),I(Vu,"UPDATE_RECEIVED_BYTES_INTERVAL",1e3),I(Vu,"create",(e=>new Vu(e)));let Nu=Vu;const ju=class e extends s.E{constructor(){super(),I(this,"context",new(window.AudioContext||window.webkitAudioContext)),I(this,"timers",qe.create()),I(this,"previousCurrentTime",0),I(this,"_isStuck",!1),I(this,"mediaStreamDestination"),I(this,"unload",(()=>(this.timers.unload(),this.context.removeEventListener("statechange",this.onStateChange),"closed"!==this.context.state?this.context.close():Promise.resolve()))),I(this,"createGain",(()=>this.context.createGain())),I(this,"createBuffer",((e,t,i)=>this.context.createBuffer(e,t,i))),I(this,"createBufferSource",(()=>this.context.createBufferSource())),I(this,"getMediaStreamDestination",(()=>(this.mediaStreamDestination||(this.mediaStreamDestination=this.context.createMediaStreamDestination()),this.mediaStreamDestination))),I(this,"getDefaultDestination",(()=>this.context.destination)),I(this,"createSplitter",(()=>this.context.createChannelSplitter(2))),I(this,"resume",(()=>L(this,null,(function*(){try{return yield Promise.race([this.context.resume(),Ye(1e3,new at("Web Audio Context resume timeout",{isFatal:!1,code:"web_audio_context_resume_timeout"}))])}catch(e){throw this.suspend().catch(j),e}})))),I(this,"suspend",(()=>L(this,null,(function*(){var e;yield null!=(e=this.context.suspend())?e:Promise.resolve()})))),I(this,"onStateChange",(()=>this.emit("state",this.state))),this.context.addEventListener("statechange",this.onStateChange),this.timers.setInterval((()=>{this._isStuck=this.isRunning&&this.context.currentTime===this.previousCurrentTime,this._isStuck&&this.emit("stuck"),this.previousCurrentTime=this.context.currentTime}),e.CHECK_INTERVAL)}get isStuck(){return this._isStuck}get isRunning(){return"running"===this.state}get currentTime(){return this.context.currentTime}get sampleRate(){return this.context.sampleRate}get state(){return this.context.state}};I(ju,"CHECK_INTERVAL",1e3);let Gu=ju;const zu=class extends s.E{constructor(e,t,{muted:i,reInitWhenStuck:s}){super(),I(this,"logger"),I(this,"audio"),I(this,"gainNode"),I(this,"splitter"),I(this,"_volume",1),I(this,"_userProvidedMuted",!1),I(this,"_muted",!1),I(this,"startTime",0),I(this,"samples",new Float32Array(new ArrayBuffer(38400))),I(this,"preInitSampleQueue",new z(500)),I(this,"unplayedBufferSources",new z(100)),I(this,"sampleRate",48e3),I(this,"channels",2),I(this,"index",0),I(this,"clockSource"),I(this,"clockDelta"),I(this,"startTimeIsInvalidated",!0),I(this,"lastSampleTimestamp",0),I(this,"reInitWhenStuck"),I(this,"ignoreSuspendCalls",!1),I(this,"isActivated",!1),I(this,"unload",(()=>L(this,null,(function*(){var e,t;null==(e=this.gainNode)||e.disconnect(),yield null==(t=this.audio)?void 0:t.unload(),this.reset(),this.audio=void 0,this.gainNode=void 0})))),I(this,"suspend",(()=>{this.setGain(0)})),I(this,"unsuspend",(()=>{var e;this.setGain(this._volume),this.ignoreSuspendCalls=!!this.audio,null==(e=this.audio)||e.suspend().then((()=>L(this,null,(function*(){yield this.resume(),this.ignoreSuspendCalls=!1})))).catch((()=>{this.ignoreSuspendCalls=!1,this.emit("state change","suspended")}))})),I(this,"flush",(()=>{if(!this.audio||!this.gainNode)throw new at("AudioContext must be initialized to flush",{isFatal:!1,code:"audiocontext_must_be_initialized"});const e=this.samples.length/this.channels,t=this.audio.createBufferSource(),i=this.audio.createBuffer(this.channels,e,this.sampleRate);let s=0;for(let t=0;t<this.channels;t++){s=t;const n=i.getChannelData(t);for(let t=0;t<e;t++)n[t]=this.samples[s],s+=this.channels}const n=Math.max(this.startTime,0);t.buffer=i,t.connect(this.gainNode),this.splitter&&t.connect(this.splitter),t.start(n),this.unplayedBufferSources.push([n,t]),this.startTime+=i.duration})),I(this,"onDecodedFrame",(e=>{if(this.gainNode&&this.audio&&this.audio.isRunning){for(;!this.preInitSampleQueue.isEmpty();){const e=this.preInitSampleQueue.items();this.preInitSampleQueue.clear(),e.forEach(this.onDecodedFrame)}if(this.unplayedBufferSources.filterPop((([e,t])=>{var i,s;return(null!=(s=null==(i=this.audio)?void 0:i.currentTime)?s:0)<e})),"audio"===e.type){const t=e.timestamp/e.timescale*1e3;if(t<this.lastSampleTimestamp&&(this.logger.info("Unordered timestamp - invalidating start time"),this.startTimeIsInvalidated=!0),this.lastSampleTimestamp=t,this.startTimeIsInvalidated){const e=1e3*this.audio.currentTime,i=this.clockSource.currentTime,s=(e+t-i)/1e3;this.clockDelta=i-e,this.startTime=s,this.startTimeIsInvalidated=!1,this.unplayedBufferSources.items().forEach((([e,t])=>{s<=e&&t.stop()}))}this.samples.set(e.data,this.index),this.index+=e.data.length,this.channels=e.channels,this.sampleRate=e.sampleRate,this.samples.length<=this.index&&(this.index=0,this.flush())}}else if("audio"===e.type){this.preInitSampleQueue.push(A(g({},e),{data:e.data.slice(0,e.data.length)}));const t=this.clockSource.currentTime;this.preInitSampleQueue.filterPop((({timestamp:e,timescale:i})=>e/i*1e3>t))}})),I(this,"play",(()=>L(this,null,(function*(){this.audio=this.getAudioContext(),yield this.resume()})))),I(this,"pause",(()=>{})),I(this,"flushBuffer",(()=>{this.unplayedBufferSources.items().forEach((([e,t])=>t.stop())),this.index=0})),I(this,"resume",(()=>L(this,null,(function*(){var e;if(!this._userProvidedMuted)try{yield null==(e=this.audio)?void 0:e.resume(),this._muted=this._userProvidedMuted,this.startTimeIsInvalidated=!0}catch(e){throw this._muted=!0,e}})))),I(this,"getAudioContext",(()=>this.audio?this.audio:this.setupContext())),I(this,"setupContext",(()=>{var e,t,i;return null==(e=this.audio)||e.unload(),this.audio=new Gu,this.audio.on("state",(e=>{this.logger.info("AudioContext state change",{state:e}),"running"===e&&(this._muted=this._userProvidedMuted,this.setGain(this._volume)),!this.ignoreSuspendCalls&&this.emit("state change",e)})),this.audio.on("stuck",(()=>{this.reInitWhenStuck&&(this.logger.info("Re-init audio context"),this.setupContext(),this.resume().catch(j),this.emit("stuck"))})),null==(t=this.gainNode)||t.disconnect(),this.gainNode=this.audio.createGain(),this.setGain(this._volume),this.startTime=this.audio.currentTime,null==(i=this.splitter)||i.disconnect(),this.splitter=this.audio.createSplitter(),this.audio})),I(this,"setGain",(e=>{this.gainNode&&(this.gainNode.gain.value=this._muted?0:e)})),this._muted=i,this._userProvidedMuted=i,this.logger=e,this.clockSource=t,this.reInitWhenStuck=s}get isContextRunning(){var e;return"running"===(null==(e=this.audio)?void 0:e.state)}get volume(){return this._volume}set volume(e){this._volume=e,this.muted||this.setGain(e)}get seekTime(){return 0}get isSeeking(){return!1}get muted(){var e;return this._muted||!(null!=(e=this.audio)&&e.isRunning)}set muted(e){this._userProvidedMuted=e,this._muted=e,this.setGain(this._volume)}get isPaused(){return!1}get currentTime(){var e;return this.audio&&this.audio.isRunning&&!this.audio.isStuck?1e3*this.audio.currentTime+(null!=(e=this.clockDelta)?e:0):this.clockSource.currentTime}set currentTime(e){this.logger.debug("setting current time to",{currentTime:e}),this.startTimeIsInvalidated=!0}get audioNode(){return this.splitter}useMediaStreamDestination(){var e;const t=this.getAudioContext().getMediaStreamDestination();return null==(e=this.gainNode)||e.connect(t),t}useDefaultDestination(){var e;const t=this.getAudioContext().getDefaultDestination();return null==(e=this.gainNode)||e.connect(t),t}};I(zu,"create",((e,t,i)=>new zu(e,t,i)));let Qu=zu;var Hu;class Xu{constructor(){B(this,Hu,[]),U(this,Hu,[])}addTextTrack(e,t,i){const s=[],n={kind:e,label:t,language:i,mode:"disabled",cues:s,addCue:e=>{s.push(e)},removeCue:e=>{const t=s.findIndex((t=>t===e));-1!==t&&s.splice(t,1)}};return M(this,Hu).push(n),n}set language(e){M(this,Hu).forEach((t=>{t.language===e?t.mode="showing":t.mode="hidden"}))}get language(){var e;return null==(e=M(this,Hu).find((e=>"showing"===e.mode)))?void 0:e.language}getActiveCues(e){const t=M(this,Hu).find((e=>"showing"===e.mode));return t?t.cues.filter((({startTime:t,endTime:i})=>e>=t&&e<=i)):[]}}Hu=new WeakMap;const qu=(e,t)=>{let i;for(i=t;e>1;e--)i+=t;return i};class Zu{constructor(){I(this,"audio"),I(this,"unmute",(()=>this.audio.play().catch(j)));const e=document.createElement("div");e.innerHTML="<audio x-webkit-airplay='deny'></audio>";const t=e.children.item(0);if(!(t instanceof HTMLAudioElement))throw new Error("Failed to create audio tag");this.audio=t,this.audio.controls=!1,this.audio.disableRemotePlayback=!0,this.audio.preload="auto",this.audio.src="data:audio/mpeg;base64,//uQx"+qu(23,"A")+"WGluZwAAAA8AAAACAAACcQCA"+qu(16,"gICA")+qu(66,"/")+"8AAABhTEFNRTMuMTAwA8MAAAAAAAAAABQgJAUHQQAB9AAAAnGMHkkI"+qu(320,"A")+"//sQxAADgnABGiAAQBCqgCRMAAgEAH"+qu(15,"/")+"7+n/9FTuQsQH//////2NG0jWUGlio5gLQTOtIoeR2WX////X4s9Atb/JRVCbBUpeRUq"+qu(18,"/")+"9RUi0f2jn/+xDECgPCjAEQAABN4AAANIAAAAQVTEFNRTMuMTAw"+qu(97,"V")+"Q==",this.audio.loop=!1,this.audio.load()}}var Ju,$u,Yu,Ku,ed,td,id,sd;class nd{constructor(){B(this,ed),B(this,Ju,[]),B(this,$u,document.createElement("canvas")),B(this,Yu),B(this,Ku,window.devicePixelRatio||1),I(this,"config",{backgroundColor:"rgba(0,0,0,0.6)",textPadding:8,fontSize:"28px",lineGap:16});const e=M(this,$u).getContext("2d",{alpha:!0});if(!e)throw new Error("Failed to create 2d context");U(this,Yu,e),R(this,ed,id).call(this)}get canvas(){return M(this,$u)}setActiveCues(e){U(this,Ju,e)}render(e,t=!1){const i=M(this,Ju).flatMap((t=>t.text.split("\n").flatMap((t=>R(this,ed,sd).call(this,t,e.width))).map((e=>{R(this,ed,id).call(this);const t=M(this,Yu).measureText(e);return{text:e,measurement:t,size:{height:t.fontBoundingBoxAscent+t.fontBoundingBoxDescent+2*this.config.textPadding,width:t.width+2*this.config.textPadding}}})))),s=Math.max(...i.map((e=>e.size.width))),n=i.reduce(((e,{size:t})=>e+t.height),0)+(i.length-1)*this.config.lineGap;let r=0;R(this,ed,td).call(this,s,n),M(this,Yu).clearRect(0,0,M(this,$u).width,M(this,$u).height);for(const{size:e,text:t}of i)R(this,ed,id).call(this),M(this,Yu).fillStyle=this.config.backgroundColor,M(this,Yu).fillRect(0,r,e.width,e.height),R(this,ed,id).call(this),M(this,Yu).fillText(t,this.config.textPadding,r+this.config.textPadding),r+=e.height+this.config.lineGap;t&&(M(this,Yu).strokeStyle="red",M(this,Yu).strokeRect(0,0,e.width,M(this,$u).height))}}Ju=new WeakMap,$u=new WeakMap,Yu=new WeakMap,Ku=new WeakMap,ed=new WeakSet,td=function(e,t){M(this,$u).width=e*M(this,Ku),M(this,$u).height=t*M(this,Ku),M(this,Yu).scale(M(this,Ku),M(this,Ku)),this.canvas.style.width=`${e}px`,this.canvas.style.height=`${t}px`},id=function(){M(this,Yu).fillStyle="white",M(this,Yu).textAlign="left",M(this,Yu).textBaseline="top",M(this,Yu).font=`${this.config.fontSize} sans-serif`},sd=function(e,t){const i=[],s=e.split(" ");let n="";for(;s.length>0;){R(this,ed,id).call(this);let e=0;for(;M(this,Yu).measureText(n+(n.length>0?" ":"")+s[0]).width+2*this.config.textPadding<=t&&s.length>0;)e++,n+=(n.length>0?" ":"")+s.shift();0!=e?(i.push(n),n=""):(i.push(s.shift()||""),n="")}return i};const rd=(e,t)=>{let i=e.getContext("webgl",t);if(i||(i=e.getContext("experimental-webgl",t)),!i)throw new at("Failed to create webgl context",{isFatal:!0,code:"failed_to_create_web_gl_context"});return i},od=(e,t,i)=>{const s=e.createShader(t);if(!s)throw new at("Failed to create shader",{isFatal:!0,code:"failed_to_create_shader"});if(e.shaderSource(s,i),e.compileShader(s),!e.getShaderParameter(s,e.COMPILE_STATUS)){const t=e.getShaderInfoLog(s);throw new at(`Failed to compile shader: ${null!=t?t:""}`,{isFatal:!0,code:"failed_to_compile_shader"})}return s},ad=e=>{const t=e.createTexture();if(!t)throw new at("Failed to create texture",{isFatal:!0,code:"failed_to_create_texture"});return e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),t},hd=(e,t)=>{const i=e.createBuffer();if(!i)throw new at("Failed to create buffer",{isFatal:!0,code:"failed_to_create_buffer"});return e.bindBuffer(e.ARRAY_BUFFER,i),e.bufferData(e.ARRAY_BUFFER,t.buffer,e.STATIC_DRAW),i},cd=(e,t,i)=>{const s=e.createProgram();if(!s)throw new at("Failed to create program",{isFatal:!0,code:"failed_to_create_program"});if(e.attachShader(s,i),e.attachShader(s,t),e.linkProgram(s),!e.getProgramParameter(s,e.LINK_STATUS)){const t=e.getShaderInfoLog(s);throw new at(`Failed to link program: ${null!=t?t:""}`,{isFatal:!0,code:"failed_to_link_program"})}return s};var ld,ud,dd,md,pd,fd,gd,Ad,wd,yd;class vd{constructor(e){B(this,gd),B(this,ld,96),B(this,ud),B(this,dd),B(this,md),B(this,pd),B(this,fd),I(this,"subtitleRenderer",new nd),B(this,yd,((e,t,i,s)=>[e,0,0,0,0,-t,0,0,0,0,1,0,i,s,0,1])),U(this,ud,e),U(this,dd,ad(e)),U(this,md,od(e,e.FRAGMENT_SHADER,"\nprecision mediump float;\nuniform sampler2D texture;\n\nvarying vec2 texture_coordinate;\n\nvoid main() {\n  float y = texture2D(texture, texture_coordinate).r;\n  float a = texture2D(texture, texture_coordinate).a;\n\n  gl_FragColor = vec4(y, y, y, a);\n}\n")),U(this,pd,od(e,e.VERTEX_SHADER,"\n  attribute vec2 position;\n  varying vec2 texture_coordinate;\n  uniform mat4 model;\n\n  void main() {\n    texture_coordinate = position;\n    gl_Position = model * vec4(position, 0.0, 1.0);\n  }\n")),U(this,fd,cd(e,M(this,pd),M(this,md))),this.subtitleRenderer.config.fontSize="64px"}setActiveCues(e,t){this.subtitleRenderer.setActiveCues(e),this.subtitleRenderer.render(t)}render(e){const t=this.subtitleRenderer.canvas,i=(e.padding+M(this,ld))*window.devicePixelRatio;0!==t.width&&(M(this,ud).useProgram(M(this,fd)),R(this,gd,Ad).call(this),R(this,gd,wd).call(this,this.subtitleRenderer.canvas.width/e.width,this.subtitleRenderer.canvas.height/e.height,-this.subtitleRenderer.canvas.width/e.width/2,-(1-(this.subtitleRenderer.canvas.height+i)/e.height)),M(this,ud).uniform1i(M(this,ud).getUniformLocation(M(this,fd),"texture"),4),M(this,ud).activeTexture(M(this,ud).TEXTURE4),M(this,ud).bindTexture(M(this,ud).TEXTURE_2D,M(this,dd)),M(this,ud).enable(M(this,ud).BLEND),M(this,ud).blendFunc(M(this,ud).SRC_ALPHA,M(this,ud).ONE_MINUS_SRC_ALPHA),M(this,ud).texImage2D(M(this,ud).TEXTURE_2D,0,M(this,ud).RGBA,M(this,ud).RGBA,M(this,ud).UNSIGNED_BYTE,t),M(this,ud).texParameteri(M(this,ud).TEXTURE_2D,M(this,ud).TEXTURE_MAG_FILTER,M(this,ud).LINEAR),M(this,ud).drawArrays(M(this,ud).TRIANGLE_STRIP,0,4))}}ld=new WeakMap,ud=new WeakMap,dd=new WeakMap,md=new WeakMap,pd=new WeakMap,fd=new WeakMap,gd=new WeakSet,Ad=function(){const e=M(this,ud).getAttribLocation(M(this,fd),"position");M(this,ud).enableVertexAttribArray(e),M(this,ud).vertexAttribPointer(e,2,M(this,ud).FLOAT,!1,0,0)},wd=function(e,t,i,s){const n=M(this,ud).getUniformLocation(M(this,fd),"model");M(this,ud).uniformMatrix4fv(n,!1,M(this,yd).call(this,e,t,i,s))},yd=new WeakMap;const bd="\nprecision mediump float;\nuniform sampler2D y_texture;\nuniform sampler2D u_texture;\nuniform sampler2D v_texture;\nuniform mat4 conversion;\n\nvarying vec2 texture_coordinate;\n\nvoid main() {\n  float y = texture2D(y_texture, texture_coordinate).r;\n  float u = texture2D(u_texture, texture_coordinate).r;\n  float v = texture2D(v_texture, texture_coordinate).r;\n\n  gl_FragColor = vec4(y, u, v, 1) * conversion;\n}\n",Sd="\n  attribute vec2 position;\n  varying vec2 texture_coordinate;\n  uniform mat4 model;\n\n  void main() {\n    texture_coordinate = position;\n    gl_Position = model * vec4(position, 0.0, 1.0);\n  }\n",kd={width:256,codedWidth:256,height:144,codedHeight:144},Ed={preserveDrawingBuffer:!1,alpha:!1,depth:!1,stencil:!1,antialias:!1,premultipliedAlpha:!1},Td=class e extends s.E{constructor(){super(),I(this,"canvas",document.createElement("canvas")),I(this,"context",rd(this.canvas,Ed)),I(this,"pixelShader",od(this.context,this.context.FRAGMENT_SHADER,bd)),I(this,"vertexShader",od(this.context,this.context.VERTEX_SHADER,Sd)),I(this,"buffer",hd(this.context,e.SQUARE_VERTICES)),I(this,"program",cd(this.context,this.vertexShader,this.pixelShader)),I(this,"textures",{y:ad(this.context),u:ad(this.context),v:ad(this.context)}),I(this,"textRenderer"),I(this,"size",kd),I(this,"onContextLost",(e=>{this.textRenderer=void 0;const t=new Error(e instanceof WebGLContextEvent?e.statusMessage:"webgl context lost");this.emit("context lost",new at("WebGL Context Lost",{isFatal:!1,code:"webgl_context_lost_error",source:t,type:"internal"})),e.preventDefault()})),I(this,"onContextRestored",(()=>{this.emit("context restored"),this.context=rd(this.canvas,Ed),this.pixelShader=od(this.context,this.context.FRAGMENT_SHADER,bd),this.vertexShader=od(this.context,this.context.VERTEX_SHADER,Sd),this.buffer=hd(this.context,e.SQUARE_VERTICES),this.program=cd(this.context,this.vertexShader,this.pixelShader),this.textures={y:ad(this.context),u:ad(this.context),v:ad(this.context)},this.load()})),I(this,"load",(()=>{this.context.useProgram(this.program),this.setupPositionVertexAttributes(),this.setSize(kd),this.context.uniform1i(this.context.getUniformLocation(this.program,"y_texture"),0),this.context.uniform1i(this.context.getUniformLocation(this.program,"u_texture"),1),this.context.uniform1i(this.context.getUniformLocation(this.program,"v_texture"),2),this.setConversionMatrix(this.rec709())})),I(this,"unload",(()=>{var e;this.setSize({width:1,height:1,codedHeight:1,codedWidth:1}),[this.textures.y,this.textures.u,this.textures.v].forEach((e=>this.context.deleteTexture(e))),this.context.deleteShader(this.pixelShader),this.context.deleteShader(this.vertexShader),this.context.deleteProgram(this.program),this.context.deleteBuffer(this.buffer),this.canvas.removeEventListener("webglcontextlost",this.onContextLost),this.canvas.removeEventListener("webglcontextrestored",this.onContextRestored),null==(e=this.context.getExtension("WEBGL_lose_context"))||e.loseContext()})),I(this,"resetSize",(()=>{this.setSize({width:this.size.width/2,height:this.size.height/2,codedHeight:this.size.codedHeight/2,codedWidth:this.size.codedWidth/2})})),I(this,"render",((e,t)=>{var i;this.context.useProgram(this.program),this.setSize({width:e.width,height:e.height,codedWidth:e.codedWidth,codedHeight:e.codedHeight}),this.setConversionMatrix(this.rec709()),this.setModelMatrix(this.size.width/this.size.codedWidth,this.size.height/this.size.codedHeight),this.context.activeTexture(this.context.TEXTURE0),this.updateTexture(this.textures.y,this.size.codedWidth,this.size.codedHeight,e.data[0]),this.context.activeTexture(this.context.TEXTURE1),this.updateTexture(this.textures.u,this.size.codedWidth/2,this.size.codedHeight/2,e.data[1]),this.context.activeTexture(this.context.TEXTURE2),this.updateTexture(this.textures.v,this.size.codedWidth/2,this.size.codedHeight/2,e.data[2]),this.context.drawArrays(this.context.TRIANGLE_STRIP,0,4),this.textRenderer&&this.textRenderer.render({width:Math.max(t.clientWidth,960)*window.devicePixelRatio,height:Math.max(t.clientHeight,540)*window.devicePixelRatio,padding:-parseInt(null!=(i=t.style.getPropertyValue("--vindral-control-bar-offset"))?i:"0",10)})})),I(this,"updateTexture",((e,t,i,s)=>{const n=this.context.LUMINANCE,r=this.context.UNSIGNED_BYTE;this.context.bindTexture(this.context.TEXTURE_2D,e),this.context.texImage2D(this.context.TEXTURE_2D,0,n,t,i,0,n,r,s)})),I(this,"setupPositionVertexAttributes",(()=>{const e=this.context.getAttribLocation(this.program,"position");this.context.enableVertexAttribArray(e),this.context.vertexAttribPointer(e,2,this.context.FLOAT,!1,0,0)})),I(this,"setSize",(e=>{be(e,this.size)||(this.size=e,this.canvas.setAttribute("width",e.width.toString()),this.canvas.setAttribute("height",e.height.toString()),this.context.viewport(0,0,e.width,e.height),this.setModelMatrix(e.width/e.codedWidth,e.height/e.codedHeight))})),I(this,"setModelMatrix",((e,t)=>{const i=this.context.getUniformLocation(this.program,"model");this.context.uniformMatrix4fv(i,!1,this.transformMatrix(e,t))})),I(this,"setConversionMatrix",(e=>{const t=this.context.getUniformLocation(this.program,"conversion");this.context.uniformMatrix4fv(t,!1,e)})),I(this,"transformMatrix",((e,t)=>[2/e,0,0,0,0,-2/t,0,0,0,0,2,0,-1,1,0,1])),I(this,"rec709",(()=>[1.16438,0,1.79274,-.97295,1.16438,-.21325,-.53291,.30148,1.16438,2.1124,0,-1.1334,0,0,0,1])),I(this,"rec601",(()=>[1.16438,0,1.59603,-.87079,1.16438,-.39176,-.81297,.52959,1.16438,2.01723,0,-1.08139,0,0,0,1])),this.canvas.addEventListener("webglcontextlost",this.onContextLost),this.canvas.addEventListener("webglcontextrestored",this.onContextRestored,!1),this.canvas.style.width="100%",this.canvas.style.position="relative"}getTextRenderer(){return this.textRenderer||(this.textRenderer=new vd(this.context)),this.textRenderer}};I(Td,"SQUARE_VERTICES",new Float32Array([0,0,0,1,1,0,1,1]));let Id=Td;const Cd=class{constructor(e,t,i,s){I(this,"oldTimestampLimit",400),I(this,"pool"),I(this,"logger"),I(this,"videoRenderer",new Id),I(this,"renderQueue",[]),I(this,"clockSource"),I(this,"isFirstFrame",!0),I(this,"animationFrameRequest"),I(this,"renderedFrameCount",0),I(this,"rendererDroppedFrameCount",0),I(this,"renderTargetSize"),I(this,"load",(()=>{this.videoRenderer.load()})),I(this,"unload",(()=>(this.stopRender(),this.videoRenderer.unload(),Promise.resolve()))),I(this,"suspend",(()=>{this.renderQueue=[],this.stopRender()})),I(this,"unsuspend",(()=>{this.animationFrameRequest=requestAnimationFrame(this.render)})),I(this,"element",(()=>this.videoRenderer.canvas)),I(this,"getStatistics",(()=>({renderedFrameCount:this.renderedFrameCount,rendererDroppedFrameCount:this.rendererDroppedFrameCount,contextLostCount:0,contextRestoredCount:0}))),I(this,"resetSize",(()=>{this.videoRenderer.resetSize()})),I(this,"setActiveCues",((e,t)=>{this.videoRenderer.getTextRenderer().setActiveCues(e,t)})),I(this,"onDecodedFrame",(e=>{if("video"===e.type)if(this.isFirstFrame)this.isFirstFrame=!1,requestAnimationFrame((()=>{this.renderSample(e)}));else{const t=(this.clockSource.currentTime-this.oldTimestampLimit)/1e3;this.renderQueue=this.renderQueue.filter((i=>{const s=i.timestamp/i.timescale,n=e.timestamp/e.timescale,r=s>t&&s<=n;return r||this.pool.reclaim(i.buffer),r})),this.renderQueue.push(e)}})),I(this,"render",(()=>{const e=this.clockSource.currentTime;let t,i=this.renderQueue[0],s=0;for(;i&&i.timestamp/i.timescale*1e3<=e;)i=this.renderQueue.shift(),i&&(s++,t&&this.pool.reclaim(t.buffer),t=i),i=this.renderQueue[0];t&&this.renderSample(t),this.rendererDroppedFrameCount+=Math.max(s-1,0),this.animationFrameRequest=requestAnimationFrame(this.render)})),I(this,"renderSample",(e=>{this.renderedFrameCount++,this.videoRenderer.render(e,this.renderTargetSize),this.pool.reclaim(e.buffer)})),I(this,"stopRender",(()=>{this.animationFrameRequest&&cancelAnimationFrame(this.animationFrameRequest)})),this.logger=e,this.clockSource=t,this.pool=i,this.renderTargetSize=s||this.videoRenderer.canvas}};I(Cd,"create",((e,t,i,s)=>new Cd(e,t,i,s)));let xd=Cd;const Md=class{constructor(e,t,i,s,n){I(this,"logger"),I(this,"emitter"),I(this,"audioPlayer"),I(this,"videoPlayer"),I(this,"pool"),I(this,"unmuter",new Zu),I(this,"_isPaused",!1),I(this,"isDisconnected",!1),I(this,"timers",new qe),I(this,"textTracks",new Xu),I(this,"playbackRate"),I(this,"reset",(()=>{})),I(this,"load",(()=>{this.audioPlayer.useDefaultDestination(),this.emitter.on("decoded frame",this.onDecodedFrame),this.emitter.on("flush buffers",this.flushBuffers),this.videoPlayer.load(),this.timers.setInterval((()=>{if(!this.textTracks.language)return;const e=this.textTracks.getActiveCues(this.currentTime/1e3);this.videoPlayer.setActiveCues(e,{width:this.videoPlayer.element().clientWidth,height:this.videoPlayer.element().clientHeight})}),100)})),I(this,"unload",(()=>{this.emitter.off("decoded frame",this.onDecodedFrame),this.emitter.off("flush buffers",this.flushBuffers),this.audioPlayer.unload(),this.videoPlayer.unload(),this.timers.unload()})),I(this,"suspend",(()=>{this.videoPlayer.suspend(),this.audioPlayer.suspend()})),I(this,"unsuspend",(()=>{this.videoPlayer.unsuspend(),this.audioPlayer.unsuspend()})),I(this,"element",(()=>this.videoPlayer.element())),I(this,"getStatistics",(()=>this.videoPlayer.getStatistics())),I(this,"flushBuffers",(()=>{this.audioPlayer.flushBuffer()})),I(this,"activateAudioPlayer",(()=>(this.isDisconnected&&(this.isDisconnected=!1,this.audioPlayer.useDefaultDestination()),this._isPaused=!1,this.unmuter.unmute(),this.audioPlayer.play()))),I(this,"onDecodedFrame",(e=>{try{this.audioPlayer.onDecodedFrame(e)}catch(e){e instanceof Error&&this.emitter.emit("error",ct(!1,e))}this.videoPlayer.onDecodedFrame(e)})),this.logger=t,this.emitter=e,this.pool=i,this.audioPlayer=Qu.create(this.logger.createContext("AudioPlayerModule"),s,{muted:n,reInitWhenStuck:!0}),this.audioPlayer.on("stuck",(()=>{this.isDisconnected=!0})),this.audioPlayer.on("state change",(()=>{this.emitter.emit("volume state",{volume:this.volume,isMuted:this.muted})})),this.videoPlayer=xd.create(this.logger.createContext("VideoPlayerModule"),this.audioPlayer,this.pool)}get volume(){return this.audioPlayer.volume}set volume(e){this.audioPlayer.volume=e}get muted(){return this.audioPlayer.muted}set muted(e){const t=this.muted;this.audioPlayer.muted=e,!e&&t&&this.activateAudioPlayer().catch(j)}get currentTime(){return this.audioPlayer.currentTime}set currentTime(e){this.audioPlayer.currentTime=e}get isActivated(){return this.audioPlayer.isActivated}set isActivated(e){this.audioPlayer.isActivated=e}get seekTime(){return this.audioPlayer.seekTime}get isPaused(){return this._isPaused}get isSeeking(){return this.audioPlayer.isSeeking}get audioNode(){return this.audioPlayer.audioNode}play(){this.activateAudioPlayer().then((()=>{this.emitter.emit("media element state","playing")})).catch((()=>{this.emitter.emit("needs user input",{forAudio:!0,forVideo:!1})}))}pause(){this._isPaused=!0,this.audioPlayer.pause(),this.emitter.emit("media element state","paused")}};I(Md,"create",((e,t,i,s,n)=>new Md(e,t,i,s,n)));let Bd=Md;const Ud=class{constructor(e,t,i,s,{muted:n,type:r,poster:o}){I(this,"logger"),I(this,"emitter"),I(this,"mediaElement"),I(this,"audioPlayer"),I(this,"videoPlayer"),I(this,"pool"),I(this,"isDisconnected",!0),I(this,"_userProvidedMuted",!1),I(this,"timers",new qe),I(this,"volumeState"),I(this,"textTracks",new Xu),I(this,"reset",(()=>{})),I(this,"load",(()=>{this.mediaElement.load(),this.emitter.on("decoded frame",this.onDecodedFrame),this.emitter.on("flush buffers",this.flushBuffers),this.emitter.on("ios-hack: reset size",this.resetCanvasSize),this.emitter.on("enter picture in picture",this.onEnterIOSHack),this.emitter.on("exit picture in picture",this.onExitIOSHack),this.element().element.addEventListener("webkitendfullscreen",this.onExitIOSHack),this.element().element.addEventListener("webkitbeginfullscreen",this.onEnterIOSHack),this.videoPlayer.load(),this.timers.setInterval((()=>{if(!this.textTracks.language)return;const e=this.textTracks.getActiveCues(this.currentTime/1e3);this.videoPlayer.setActiveCues(e,{width:this.mediaElement.element.clientWidth,height:this.mediaElement.element.clientHeight})}),100)})),I(this,"unload",(()=>{this.emitter.off("decoded frame",this.onDecodedFrame),this.emitter.off("flush buffers",this.flushBuffers),this.emitter.off("ios-hack: reset size",this.resetCanvasSize),this.emitter.off("enter picture in picture",this.onEnterIOSHack),this.emitter.off("exit picture in picture",this.onExitIOSHack),this.element().element.removeEventListener("webkitendfullscreen",this.onExitIOSHack),this.element().element.removeEventListener("webkitbeginfullscreen",this.onEnterIOSHack),this.mediaElement.unload(),this.timers.unload(),this.audioPlayer.unload(),this.videoPlayer.unload()})),I(this,"suspend",(()=>{this.videoPlayer.suspend(),this.audioPlayer.suspend()})),I(this,"unsuspend",(()=>{this.videoPlayer.unsuspend(),this.audioPlayer.unsuspend()})),I(this,"element",(()=>this.mediaElement)),I(this,"getStatistics",(()=>this.videoPlayer.getStatistics())),I(this,"activateAudioPlayer",(()=>(this.isDisconnected&&this.connectStreams(),this.audioPlayer.play()))),I(this,"flushBuffers",(()=>{this.audioPlayer.flushBuffer()})),I(this,"resetCanvasSize",(()=>{this.videoPlayer.resetSize()})),I(this,"onEnterIOSHack",(()=>{this.mediaElement._iosHackEnterPiPMode()})),I(this,"onExitIOSHack",(()=>{this.mediaElement._iosHackExitPiPMode()})),I(this,"onDecodedFrame",(e=>{try{this.audioPlayer.onDecodedFrame(e)}catch(e){e instanceof Error&&this.emitter.emit("error",ct(!1,e))}this.videoPlayer.onDecodedFrame(e)})),I(this,"connectStreams",(()=>{const e=this.videoPlayer.element().captureStream(),t=this.audioPlayer.useMediaStreamDestination().stream,i=[];i.push(...e.getTracks(),...t.getTracks()),this.mediaElement.element.srcObject=new MediaStream(i),this.isDisconnected=!1})),I(this,"updateVolumeState",(()=>{const e={isMuted:this.muted,volume:this.volume};be(e,this.volumeState)||(this.volumeState=e,this.emitter.emit("volume state",this.volumeState))})),this.logger=t,this.emitter=e,this.pool=i,this._userProvidedMuted=n,this.mediaElement=new sn({poster:o,type:r,muted:n,autoplay:!1,logger:this.logger.createContext("MediaElement")}),this.mediaElement.on("volume state",(e=>{this.updateVolumeState(),!e.isMuted&&!this.audioPlayer.isContextRunning&&this.activateAudioPlayer().catch(j),e.isMuted||(this._userProvidedMuted=!1)})),this.mediaElement.on("media element state",(e=>{"paused"===e&&this.audioPlayer.flushBuffer(),this.emitter.emit("media element state",e)})),this.audioPlayer=Qu.create(this.logger.createContext("AudioPlayerModule"),s,{muted:!1,reInitWhenStuck:!1}),this.audioPlayer.on("stuck",(()=>{this.isDisconnected=!0})),this.audioPlayer.on("state change",(e=>{"suspended"===e||"interrupted"===e?this.mediaElement.muted=!0:"running"===e&&(this.mediaElement.muted=this._userProvidedMuted||"hidden"===document.visibilityState),this.updateVolumeState()})),this.videoPlayer=xd.create(this.logger.createContext("VideoPlayerModule"),this.audioPlayer,this.pool,this.mediaElement.element),this.volumeState={volume:this.volume,isMuted:this.muted}}get volume(){return this.mediaElement.volume}set volume(e){this.mediaElement.volume=e}get muted(){return this.mediaElement.muted||this.audioPlayer.muted}set muted(e){const t=this.muted;this._userProvidedMuted=e,this.mediaElement.muted=e,!e&&t&&this.activateAudioPlayer().catch(j)}get currentTime(){return this.audioPlayer.currentTime}set currentTime(e){this.audioPlayer.currentTime=e}get isActivated(){return this.mediaElement.isActivated}set isActivated(e){this.mediaElement.isActivated=e}get seekTime(){return this.mediaElement.seekTime}get isPaused(){return this.mediaElement.isPaused}get isSeeking(){return this.mediaElement.isSeeking}get audioNode(){return this.audioPlayer.audioNode}play(){const e=this._userProvidedMuted;return this.activateAudioPlayer().catch((()=>{e||this.emitter.emit("needs user input",{forAudio:!0,forVideo:!1})})),this.mediaElement.play()}pause(){this.mediaElement.pause()}};I(Ud,"create",((e,t,i,s,n)=>new Ud(e,t,i,s,n)));let Rd=Ud;const Pd=()=>e=>Ld(e.buffered.start(0),e.buffered.end(e.buffered.length-1)),Ld=(e,t)=>i=>i.remove(Math.max(0,e),Math.min(Number.POSITIVE_INFINITY,t)),Dd=e=>t=>t.appendBuffer(e);class _d{constructor(e){I(this,"commandQueue",[]),I(this,"sourceBuffer"),I(this,"currentInit"),I(this,"handleQueue",(()=>{var e;this.sourceBuffer.updating||null==(e=this.commandQueue.shift())||e.execute(this.sourceBuffer)})),I(this,"appendBuffer",((e,t)=>new Promise(((i,s)=>{if(t&&this.currentInit!==t){const e=new Ae(Dd(t),i,s);this.commandQueue.push(e),this.currentInit=t}const n=new Ae(Dd(e),i,s);this.commandQueue.push(n),this.handleQueue()})))),I(this,"execute",(e=>new Promise(((t,i)=>{const s=new Ae((n=e,e=>n(e)),t,i);var n;this.commandQueue.push(s),this.handleQueue()})))),I(this,"buffered",(()=>this.sourceBuffer.buffered)),I(this,"removeFromMediaSource",(e=>{e.removeSourceBuffer(this.sourceBuffer)})),I(this,"changeType",(e=>new Promise(((t,i)=>{const s=new Ae((n=e,e=>e.changeType(n)),t,i);var n;this.commandQueue.push(s),this.handleQueue()})))),I(this,"removeBuffer",((e,t)=>new Promise(((i,s)=>{const n=new Ae(Ld(e,t),i,s);this.commandQueue.push(n),this.handleQueue()})))),I(this,"flush",(()=>new Promise(((e,t)=>{const i=new Ae(Pd,e,t);this.commandQueue.push(i),this.handleQueue()})))),this.sourceBuffer=e,this.sourceBuffer.addEventListener("updateend",this.handleQueue)}}class Wd extends s.E{constructor(){super(),I(this,"MediaSource",ee()),I(this,"mediaSource",new this.MediaSource),I(this,"isOpen",(()=>"open"===this.mediaSource.readyState)),I(this,"isClosed",(()=>"closed"===this.mediaSource.readyState)),I(this,"isEnded",(()=>"ended"===this.mediaSource.readyState)),I(this,"createObjectURL",(()=>URL.createObjectURL(this.mediaSource))),I(this,"attach",(e=>{const t=e;if("srcObject"in t)try{t.srcObject=this.mediaSource}catch(e){if(e instanceof Error&&"TypeError"!==e.name)throw e;t.src=this.createObjectURL()}else e.src=this.createObjectURL()})),I(this,"detach",(e=>{if(this.mediaSource&&"open"===this.mediaSource.readyState)try{this.mediaSource.endOfStream()}catch(e){}e.srcObject&&(e.srcObject=null),""!==e.src&&(URL.revokeObjectURL(e.src),e.removeAttribute("src")),e.load()})),I(this,"addSourceBuffer",(e=>{const t=this.mediaSource.addSourceBuffer(e);return new _d(t)})),I(this,"removeSourceBuffer",(e=>{e.removeFromMediaSource(this.mediaSource)})),I(this,"endOfStream",(e=>{this.mediaSource.endOfStream(e)})),I(this,"onSourceOpen",(()=>{this.setDurationIfNeeded(),this.emit("source open")})),I(this,"onSourceEnded",(()=>this.emit("source ended"))),I(this,"onSourceClosed",(()=>this.emit("source close"))),I(this,"setDurationIfNeeded",(()=>{if(Number.isNaN(this.mediaSource.duration)&&"open"===this.mediaSource.readyState){for(let e=0;e<this.mediaSource.sourceBuffers.length;e++){const t=this.mediaSource.sourceBuffers[e];if(null!=t&&t.updating)return}this.mediaSource.duration=Number.POSITIVE_INFINITY}})),this.mediaSource.addEventListener("sourceopen",this.onSourceOpen),this.mediaSource.addEventListener("sourceclose",this.onSourceClosed),this.mediaSource.addEventListener("sourceended",this.onSourceEnded)}}I(Wd,"isTypeSupported",(e=>{var t,i;return null!=(i=null==(t=ee())?void 0:t.isTypeSupported(e))&&i}));class Od{constructor(){I(this,"initSegments",new Map),I(this,"set",((e,t,i)=>{var s;const n=null!=(s=this.initSegments.get(e))?s:new Map;n.set(t,i),this.initSegments.set(e,n)})),I(this,"get",((e,t)=>{var i;return null==(i=this.initSegments.get(e))?void 0:i.get(t)}))}}function Fd(e,{mediaSource:t,mimeType:i,codec:s}){return A(g({},e),{state:"initialized",mimeType:i,codec:s,sourceBuffer:t.addSourceBuffer(i),isWorkingOnPendingSamples:!1,sequenceNumber:0,lastBufferCleanupTime:Date.now()})}function Vd({initSegments:e,pendingSamples:t}){return{state:"uninitialized",initSegments:null!=e?e:new Od,sequenceNumber:0,isWorkingOnPendingSamples:!1,hasFirstSync:!!t,pendingSamples:null!=t?t:[],consecutiveQuotaExceededErrorCount:0,successfulAppendCalls:0}}const Nd=class{constructor(e,t,i){I(this,"maxChunkSize",20),I(this,"minConsecutiveErrorsBeforeEmit",5),I(this,"maxSecondsInBuffer",60),I(this,"logger"),I(this,"timers",qe.create()),I(this,"emitter"),I(this,"mediaElement"),I(this,"mediaSource",new Wd),I(this,"trackContexts",new Map),I(this,"autoRecoverFromMediaErrors",!0),I(this,"quotaErrorCount",0),I(this,"recoveredFromErrorCount",0),I(this,"sourceOpenStartTime",Date.now()),I(this,"sourceOpenEndTime",Date.now()),I(this,"pendingTracksToAddSourceBuffers"),I(this,"hasAddedInitialPosterFrame",!0),I(this,"load",(()=>{this.emitter.on("init segment",this.init),this.emitter.on("coded sample",this.onCodedSample),this.emitter.on("flush buffers",this.flushBuffers),this.emitter.on("fragment",this.onFragment)})),I(this,"unload",(()=>{this.logger.debug("Unloading module..."),this.emitter.off("init segment",this.init),this.emitter.off("coded sample",this.onCodedSample),this.emitter.off("flush buffers",this.flushBuffers),this.emitter.off("fragment",this.onFragment),this.mediaSource.off("source ended",this.onSourceEnded),this.mediaSource.off("source open",this.onSourceOpen),this.mediaSource.detach(this.mediaElement),this.trackContexts.forEach((e=>e.pendingSamples=[])),this.timers.unload(),this.logger.debug("Unloaded module")})),I(this,"getStatistics",(()=>{var e,t,i,s;const n={quotaErrorCount:this.quotaErrorCount,mediaSourceOpenTime:this.sourceOpenEndTime-this.sourceOpenStartTime,successfulAudioAppendsCalls:null==(e=this.trackContexts.get("audio"))?void 0:e.successfulAppendCalls,successfulVideoAppendCalls:null==(t=this.trackContexts.get("video"))?void 0:t.successfulAppendCalls};if(this.mediaElement instanceof HTMLVideoElement){const e=null==(s=(i=this.mediaElement).getVideoPlaybackQuality)?void 0:s.call(i);n.totalVideoFrames=null==e?void 0:e.totalVideoFrames,n.droppedVideoFrames=null==e?void 0:e.droppedVideoFrames}return n})),I(this,"flushBuffers",(()=>{this.trackContexts.forEach((e=>{e.pendingSamples=[],e.hasFirstSync=!1,"uninitialized"!==e.state&&this.mediaSource.isOpen()&&e.sourceBuffer.removeBuffer(0,Number.POSITIVE_INFINITY).catch((e=>{this.logger.error("Failed to remove buffer",e)}))}))})),I(this,"setTrackContexts",((e=new Map)=>{this.logger.debug("setTrackContexts"),["audio","video"].forEach((t=>{var i,s,n,r;const o=null!=(s=null==(i=e.get(t))?void 0:i.pendingSamples)?s:[],a=null==(n=e.get(t))?void 0:n.initSegments;for(;o.length>0&&(null==(r=o[0])||!r.isSync);)o.shift();this.trackContexts.set(t,Vd({pendingSamples:o,initSegments:a}))}))})),I(this,"setSourceBuffers",(e=>L(this,null,(function*(){if(this.mediaSource.isClosed())return void(this.pendingTracksToAddSourceBuffers=e);let t=!0;for(const i of e){const e=this.trackContexts.get(i.type);if(!e||"uninitialized"===e.state||e.mimeType!==i.mimeType){t=!1;break}}if(t)this.logger.debug("Already setup with the correct mime types");else for(const t of e){let e=this.trackContexts.get(t.type);e||(e=Vd({pendingSamples:[],initSegments:new Od}),this.trackContexts.set(t.type,e)),"initialized"===e.state?t.mimeType!==e.mimeType&&(yield e.sourceBuffer.changeType(t.mimeType)):this.trackContexts.set(t.type,Fd(e,{mimeType:t.mimeType,mediaSource:this.mediaSource,codec:t.codec}))}})))),I(this,"getBuffer",(e=>{const t=[];if(this.mediaSource.isClosed())return[];const i=this.trackContexts.get(e);if(!i||"uninitialized"===i.state)return[];try{const e=i.sourceBuffer.buffered();if(!e)return[];for(let i=0;i<e.length;i++)t.push({start:1e3*e.start(i),end:1e3*e.end(i)});return t}catch(e){return[]}})),I(this,"init",(({initSegment:e,mimeType:t})=>{this.logger.debug("Added init segment",{channel:e.channelId,renditionId:e.renditionId});const i=this.trackContexts.get(e.type);if(!i)throw ut(e.type,e.renditionId);"initialized"===i.state&&(i.mimeType=t);const s=((e,t,i)=>{switch(e){case"h264":return((e,t)=>((e,t)=>{const{sequenceParameterSets:i,pictureParameterSets:s}=li(e),n=Vs(e);return Os([{type:"video",sequenceParameterSets:i.map((e=>new Uint8Array(e))),pictureParameterSets:s.map((e=>new Uint8Array(e))),width:n.width,height:n.height,timescale:t,duration:0,trackId:1}])})(e,t))(t,i);case"av1":return((e,t)=>((e,t)=>{const i=Ns(e);if(!i)throw new Error("Failed to parse sequence header");return Os([{type:"video",parsedSequenceHeader:i,sequenceHeader:new Uint8Array(e),width:i.maxFrameWidth,height:i.maxFrameHeight,timescale:t,duration:0,trackId:1}])})(e,t))(t,i);case"opus":return((e,t)=>((e,t,i)=>Os([{type:"audio",trackId:1,channelCount:2,timescale:i,codec:"opus",decoderConfig:e,duration:0,sampleRate:48e3}]))(new Uint8Array(e),0,t))(t,i);case"aac":return((e,t)=>((e,t,i,s)=>Os([{type:"audio",codec:"aac",decoderConfig:e,channelCount:2,sampleRate:i,timescale:s,duration:0,trackId:1}]))(new Uint8Array(e),0,t,t))(t,i);default:throw new Error(`Failed to initialize ${e} segment`)}})(e.codec,e.data,e.timescale);s&&i.initSegments.set(e.channelId,e.renditionId,new Uint8Array(s))})),I(this,"append",((e,t)=>L(this,null,(function*(){var i;const s=e[0];if(!s)return;const n=this.trackContexts.get(s.type),r=null==n?void 0:n.initSegments.get(s.channelId,s.renditionId);if(this.mediaSource.isClosed())return;if(!r)throw((e,t)=>new at(`No init segment for rendition id ${e} for channel ${t}`,{isFatal:!1,code:"missing_init_segment",type:"internal"}))(s.renditionId,s.channelId);if(!n)throw ut(s.type,s.renditionId);if("uninitialized"===n.state)throw((e,t)=>new at(`Track context is in an invalid state for ${e}${t?`, rendition id ${t}`:""}`,{isFatal:!1,code:"invalid_track_context_state",type:"internal"}))(s.type,s.renditionId);if(t){const e=(s.timestamp+(null!=(i=s.compositionTimeOffset)?i:0))/s.timescale;yield n.sourceBuffer.removeBuffer(e,Number.POSITIVE_INFINITY);const t=n.previousSample;if(t&&t.codec!==s.codec&&n.sourceBuffer.changeType)try{yield n.sourceBuffer.changeType(n.mimeType)}catch(e){}"fragmented"in s||(yield n.sourceBuffer.appendBuffer(r))}const o=Math.max(0,s.timestamp/s.timescale-this.maxSecondsInBuffer);o>0&&Date.now()-n.lastBufferCleanupTime>1e4&&(n.lastBufferCleanupTime=Date.now(),yield n.sourceBuffer.removeBuffer(0,o+10));try{let t=n.sequenceNumber;if("fragmented"in s)for(const t of e)"initData"in t&&(yield n.sourceBuffer.appendBuffer(t.data,t.initData));else{const i=((e,t)=>{if(!e[0])throw new Error("At least one sample must be provided");switch(e[0].codec){case"h264":return((e,t)=>{const i=e.map((e=>A(g({},e),{data:new Uint8Array(e.data)})));if(!i[0])throw new Error("At least one sample must be provided");const{isSync:s,timestamp:n,data:r,duration:o}=i[0];return Fs({trackId:1,timestamp:n,sequenceNumber:t,defaultSize:r.byteLength,defaultFlags:s?33554432:16842752,defaultDuration:o,samples:i})})(e,t);case"opus":return((e,t)=>{const i=e.map((e=>A(g({},e),{data:new Uint8Array(e.data)})));if(!i[0])throw new Error("At least one sample must be provided");const{timestamp:s,data:n,duration:r}=i[0];return Fs({trackId:1,timestamp:s,sequenceNumber:t,defaultSize:n.byteLength,defaultFlags:33554432,defaultDuration:r,samples:i})})(e,t);case"aac":return((e,t)=>{const i=e.map((e=>A(g({},e),{data:new Uint8Array(e.data)})));if(!i[0])throw new Error("At least one sample must be provided");const{timestamp:s,data:n,duration:r}=i[0];return Fs({trackId:1,timestamp:s,sequenceNumber:t,defaultSize:n.byteLength,defaultFlags:33554432,defaultDuration:r,samples:i})})(e,t);case"av1":return((e,t)=>{const i=e.map((e=>A(g({},e),{data:new Uint8Array(e.data)})));if(!i[0])throw new Error("At least one sample must be provided");const{isSync:s,timestamp:n,data:r,duration:o}=i[0];return Fs({trackId:1,timestamp:n,sequenceNumber:t,defaultSize:r.byteLength,defaultFlags:s?33554432:16842752,defaultDuration:o,samples:i})})(e,t);default:throw new Error(`Unsupported codec ${e[0].codec}`)}})(e,t++);yield n.sourceBuffer.appendBuffer(i)}n.sequenceNumber=t,n.consecutiveQuotaExceededErrorCount=0,n.successfulAppendCalls++}catch(t){throw t instanceof DOMException&&(t.code===DOMException.QUOTA_EXCEEDED_ERR?(this.quotaErrorCount++,n.consecutiveQuotaExceededErrorCount++,this.logger.error("quota exceeded error",{error:t}),n.pendingSamples.unshift(...e)):this.mediaElement.error&&n.pendingSamples.unshift(...e)),t}})))),I(this,"onFragment",(({fragment:e,mimeType:t,codec:i,channelId:s,renditionId:n})=>{const r=e.mediaType(),o=e.rawBytes(),a=e.header().rawBytes(),h=e.baseMediaDecodeTime(),c=e.timescale(),l=e.duration(),u="video"!==r||e.startsWithKeyframe(),d=e.compositionTimeOffset(0);if("text"===r)return void this.logger.warn("Skipping unexpected text fragment");if(!i)return void this.logger.warn("Skipping fragment with no codec");const m=this.trackContexts.get(r);if(!m)throw ut(r);"initialized"===m.state&&t&&(m.mimeType=t,m.initSegments.set(s,n,a));const p={fragmented:!0,type:r,data:o,initData:a,timestamp:h,duration:l,timescale:c,channelId:s,renditionId:n,isSync:u,codec:i,fragment:e,compositionTimeOffset:d};this.onCodedSample(p)})),I(this,"onCodedSample",(e=>{if(0===e.duration)return;const t=this.trackContexts.get(e.type);if(!t)throw ut(e.type,e.renditionId);if(t.hasFirstSync||e.isSync){if(this.hasAddedInitialPosterFrame&&e.isSync&&"video"===e.type){this.hasAddedInitialPosterFrame=!1;const i=g({},e);"fragment"in i?(i.fragment=i.fragment.clone(),i.fragment.updateBaseMediaDecodeTime(0),i.data=i.fragment.rawBytes()):i.timestamp=0,t.pendingSamples.push(i)}t.hasFirstSync=!0,t.pendingSamples.push(e),"uninitialized"!==t.state&&(t.isWorkingOnPendingSamples||zd(t,this.append,this.maxChunkSize).catch((i=>{if(t.isWorkingOnPendingSamples=!1,i instanceof Error){if(this.logger.error("append failed",{message:i.message,name:i.name}),i instanceof DOMException&&i.code===DOMException.QUOTA_EXCEEDED_ERR){if(t.consecutiveQuotaExceededErrorCount>=this.minConsecutiveErrorsBeforeEmit){const s=lt(!1,i,t.consecutiveQuotaExceededErrorCount,e.type);this.emitter.emit("error",s)}}else{const s=lt(!1,i,t.consecutiveQuotaExceededErrorCount,e.type);this.emitter.emit("error",s)}this.mediaElement.error&&this.onSourceEnded()}})))}})),I(this,"onSourceOpen",(()=>{this.logger.debug("source opened"),this.sourceOpenEndTime=Date.now(),this.pendingTracksToAddSourceBuffers&&(this.setSourceBuffers(this.pendingTracksToAddSourceBuffers),this.pendingTracksToAddSourceBuffers=void 0)})),I(this,"onSourceEnded",(()=>{const{error:e}=this.mediaElement;if(e){const t=((e,t)=>new at("MediaElement Error",{isFatal:e,code:"media_element_error",source:t},{mediaErrorCode:t.code}))(/AUDIO_RENDERER/.test(e.message)||!this.autoRecoverFromMediaErrors,e);if(this.logger.error("MediaElement error",{error:t}),this.emitter.emit("error",t),!t.isFatal()){this.logger.info("Re-opening MediaSource"),this.emitter.emit("recovered from media error",{error:t,count:this.recoveredFromErrorCount}),this.recoveredFromErrorCount++;const e=!this.mediaElement.paused,i=[];this.trackContexts.forEach(((e,t)=>{"initialized"===e.state&&i.push({type:t,mimeType:e.mimeType,codec:e.codec})})),this.sourceOpenStartTime=Date.now(),this.pendingTracksToAddSourceBuffers=i,this.mediaElement.src="",this.setTrackContexts(this.trackContexts),this.mediaSource.attach(this.mediaElement),e&&this.mediaElement.play().catch(j)}}this.logger.debug("source ended")})),this.logger=e,this.mediaElement=i,this.emitter=t}};I(Nd,"create",((e,t,i)=>{const s=new Nd(e,t,i);return s.setTrackContexts(),s.mediaSource.on("source ended",s.onSourceEnded),s.mediaSource.on("source open",s.onSourceOpen),s.mediaSource.attach(i),s}));let jd=Nd;const Gd=(e,t)=>{var i;const s=e.renditionId!==t.renditionId,n=e.channelId!==t.channelId,r=(null!=(i=e.timestamp)?i:0)>t.timestamp,o="video"===e.type&&"video"===t.type&&"levelIdc"in e&&"levelIdc"in t&&e.levelIdc!==t.levelIdc;let a=!1;return"video"===e.type&&"video"===t.type&&"width"in e&&"width"in t&&(a=t.width!==e.width||t.height!==e.height),n||s||r||a||o},zd=(e,t,i)=>L(void 0,null,(function*(){for(e.isWorkingOnPendingSamples=!0;e.pendingSamples.length>0;){const s=[];let n=0;for(let t=0;t<e.pendingSamples.length;t++){n=t;const r=e.pendingSamples[t],o=e.pendingSamples[t+1];if(r&&(s.push(r),o)){if(Gd(r,o))break;const e=(r.timestamp+r.duration)/r.timescale;if(o.timestamp/o.timescale-e>.1)break}if(t===i-1)break}const r=s[0];if(!r)break;const o=!e.previousSample||Gd(e.previousSample,r);yield t(s,o),e.pendingSamples=e.pendingSamples.slice(n+1),e.previousSample=s[s.length-1]}e.isWorkingOnPendingSamples=!1})),Qd=class{constructor(e,t){I(this,"logger"),I(this,"emitter"),I(this,"element"),I(this,"pictureInPictureWindow"),I(this,"unload",(()=>{this.emitter.off("add picture in picture listener",this.onEnablePictureInPicture)})),I(this,"onEnablePictureInPicture",(e=>{this.element=e.element,e.element.addEventListener("leavepictureinpicture",(()=>{this.pictureInPictureWindow=void 0,this.logger.debug("Leave picture in picture"),this.emitter.emit("exit picture in picture")})),e.element.addEventListener("enterpictureinpicture",(e=>{this.pictureInPictureWindow=e.pictureInPictureWindow,this.logger.debug("Enter picture in picture"),this.emitter.emit("enter picture in picture",this)})),e.element.autopictureinpicture=!0})),I(this,"getPictureInPictureSize",(()=>this.pictureInPictureWindow)),I(this,"isPictureInPictureActive",(()=>this.isWebkitPresentationModeActive()||this.isStandardPictureInPictureActive())),I(this,"isPictureInPictureSupported",(()=>this.isWebkitPresentationModeSupported()||this.isStandardPictureInPictureSupported())),I(this,"requestPictureInPicture",(()=>(this.emitter.emit("ios-hack: reset size"),this.isStandardPictureInPictureSupported()?this.requestStandardPictureInPicture():this.isWebkitPresentationModeSupported()?this.requestWebkitPresentationMode("picture-in-picture"):Promise.reject(new Error("Picture in picture is not supported"))))),I(this,"exitPictureInPicture",(()=>this.isStandardPictureInPictureSupported()?this.exitStandardPictureInPicture():this.isWebkitPresentationModeSupported()?this.requestWebkitPresentationMode("inline"):Promise.reject(new Error("Picture in picture is not supported")))),I(this,"getStatistics",(()=>({isPictureInPictureActive:this.isPictureInPictureActive()}))),I(this,"requestStandardPictureInPicture",(()=>L(this,null,(function*(){return yield this.element.requestPictureInPicture()})))),I(this,"exitStandardPictureInPicture",(()=>L(this,null,(function*(){return yield document.exitPictureInPicture()})))),I(this,"isStandardPictureInPictureSupported",(()=>!!this.element&&!!this.element.requestPictureInPicture&&!!document.pictureInPictureEnabled)),I(this,"isStandardPictureInPictureActive",(()=>!!this.element&&!!document.pictureInPictureElement)),I(this,"isWebkitPresentationModeActive",(()=>!!this.element&&"picture-in-picture"===this.element.webkitPresentationMode)),I(this,"requestWebkitPresentationMode",(e=>L(this,null,(function*(){return this.element.webkitSetPresentationMode(e),Promise.resolve()})))),I(this,"isWebkitPresentationModeSupported",(()=>!!this.element&&!!this.element.webkitSetPresentationMode)),this.emitter=e,this.logger=t,this.emitter.on("add picture in picture listener",this.onEnablePictureInPicture)}};I(Qd,"create",((e,t)=>new Qd(e,t)));let Hd=Qd;const Xd=class{constructor(e,t,i,s){I(this,"emitter"),I(this,"logger"),I(this,"clockSource"),I(this,"state","buffering"),I(this,"bufferFullness",0),I(this,"targetBufferTime"),I(this,"lastBufferStateEvent","drained"),I(this,"firstFrameTime"),I(this,"currentTimeIsInRange",!1),I(this,"needsInputForAudioCount",0),I(this,"needsInputForVideoCount",0),I(this,"unload",(()=>{this.emitter.off("buffer state",this.onBufferedStateChanged),this.emitter.off("needs user input",this.onNeedsUserInput)})),I(this,"setTargetBufferTime",(e=>{this.targetBufferTime=e})),I(this,"getTargetBufferTime",(()=>this.targetBufferTime)),I(this,"getBufferFullness",(()=>this.bufferFullness)),I(this,"getLastBufferStateEvent",(()=>this.lastBufferStateEvent)),I(this,"getState",(()=>this.state)),I(this,"getFirstFrameTime",(()=>this.firstFrameTime)),I(this,"getStatistics",(()=>({bufferTime:this.targetBufferTime,needsInputForAudioCount:this.needsInputForAudioCount,needsInputForVideoCount:this.needsInputForVideoCount}))),I(this,"onBufferedStateChanged",(({buffered:e,isPaused:t})=>{const i=this.clockSource.currentTime,s=e.some((e=>e.start<i&&i<e.end)),n=e[e.length-1],r=!!n&&n.end-n.start>=this.targetBufferTime,o=n?Math.max(0,n.end-i)/this.targetBufferTime:0,a=t?"paused":s?"playing":"buffering",h=this.state;this.currentTimeIsInRange===s||s?s&&r&&"drained"===this.lastBufferStateEvent&&(this.lastBufferStateEvent="filled",this.emitter.emit("buffer state event",this.lastBufferStateEvent)):(this.lastBufferStateEvent="drained",this.emitter.emit("buffer state event",this.lastBufferStateEvent)),"playing"===a&&!this.firstFrameTime&&(this.firstFrameTime=Date.now()),this.currentTimeIsInRange=s,this.state=a,this.bufferFullness=s?o:0,h!==a&&this.emitter.emit("playback state",a),this.emitter.emit("buffer fullness",this.bufferFullness)})),I(this,"onNeedsUserInput",(({forAudio:e,forVideo:t})=>{e&&this.needsInputForAudioCount++,t&&this.needsInputForVideoCount++})),this.emitter=e,this.logger=t,this.clockSource=i,this.targetBufferTime=s,this.emitter.on("buffer state",this.onBufferedStateChanged),this.emitter.on("needs user input",this.onNeedsUserInput)}};I(Xd,"create",((e,t,i,s)=>new Xd(e,t,i,s)));let qd=Xd;const Zd=()=>({upgradesFromLevel:[],downgradesFromLevel:[],bufferingRanges:[],activeRanges:[],decodeRate:Number.MAX_SAFE_INTEGER}),Jd=class{constructor(e,t){I(this,"minBufferFullnessLengthForRegression",6),I(this,"logger"),I(this,"emitter"),I(this,"timers",qe.create()),I(this,"metrics",{levels:{},levelDowngrades:[],levelUpgrades:[],bufferFullness:0,general:Zd()}),I(this,"bufferFullness",new z(30)),I(this,"bufferFullnessRegression"),I(this,"currentLevel"),I(this,"isSuspended",!1),I(this,"_fatalQosCount",0),I(this,"hasAsserted",!1),I(this,"load",(()=>{this.emitter.on("playback state",this.onPlaybackState),this.emitter.on("buffer fullness",this.onBufferFullness),this.emitter.on("rendition level changed",this.onRenditionLevelChanged),this.emitter.on("video decode rate",this.onVideoDecodeRate)})),I(this,"unload",(()=>{this.emitter.off("playback state",this.onPlaybackState),this.emitter.off("buffer fullness",this.onBufferFullness),this.emitter.off("rendition level changed",this.onRenditionLevelChanged),this.emitter.off("video decode rate",this.onVideoDecodeRate),this.suspend()})),I(this,"suspend",(()=>{this.isSuspended=!0,this.timers.unload(),this.stopBuffering(),this.unsetActive()})),I(this,"unsuspend",(()=>{this.isSuspended=!1,this.currentLevel&&this.setActive()})),I(this,"fatalQosGraceTime",(()=>1e4*(this.fatalQosCount+1))),I(this,"incrementFatalQosCount",(()=>{this._fatalQosCount++})),I(this,"getMetrics",(()=>this.metrics)),I(this,"getLevelStats",(e=>{var t,i,s,n;const r=(null!=(i=null==(t=e.video)?void 0:t.bitRate)?i:0)+(null!=(n=null==(s=e.audio)?void 0:s.bitRate)?n:0);return this.metrics.levels[r]})),I(this,"getBufferFullnessRegression",(()=>this.bufferFullnessRegression)),I(this,"activeRatios",(()=>{const e=new Map,t=Qe(this.metrics.general.activeRanges);if(Object.entries(this.metrics.levels).forEach((([i,s])=>{e.set(i,t?Qe(s.activeRanges)/t:0)})),!this.hasAsserted){const t=!e.size||Math.abs(Array.from(e.values()).reduce(((e,t)=>e+t),0)-1)<=.02;t||(this.hasAsserted=!0,console.assert(t,`Active ratios should be close to 1 - actual: ${Array.from(e.values()).reduce(((e,t)=>e+t),0)}`))}return e})),I(this,"bufferingRatios",(()=>{const e=new Map,t=Qe(this.metrics.general.bufferingRanges);if(Object.entries(this.metrics.levels).forEach((([i,s])=>{e.set(i,t?Qe(s.bufferingRanges)/t:0)})),!this.hasAsserted){const t=Array.from(e.values()).reduce(((e,t)=>e+t),0)<=1;t||(this.hasAsserted=!0,console.assert(t,`Buffering ratios should be less than 1 - actual: ${Array.from(e.values()).reduce(((e,t)=>e+t),0)}`))}return e})),I(this,"bufferingEventsLast",(e=>this.metrics.general.bufferingRanges.filter((t=>t.start>=Date.now()-e)).length)),I(this,"timeSpentBufferingLast",(e=>He(this.metrics.general.bufferingRanges,e))),I(this,"timeSpentActiveLast",(e=>He(this.metrics.general.activeRanges,e))),I(this,"timeSpentPlayingInAtLeastLevelRatio",(e=>{var t,i,s,n;const r=this.timeSpentBuffering(),o=this.timeActive(),a=this.bufferingRatios(),h=this.activeRatios(),c=(null!=(i=null==(t=e.video)?void 0:t.bitRate)?i:0)+(null!=(n=null==(s=e.audio)?void 0:s.bitRate)?n:0),l=r/o;return Object.keys(this.metrics.levels).map((e=>parseInt(e,10))).filter((e=>e>=c)).reduce(((e,t)=>{var i,s;return(null!=(i=h.get(t.toString()))?i:0)-(null!=(s=a.get(t.toString()))?s:0)*l+e}),0)})),I(this,"timeSpentBuffering",(()=>Qe(this.metrics.general.bufferingRanges))),I(this,"timeActive",(()=>Qe(this.metrics.general.activeRanges))),I(this,"getStatistics",(()=>({timeSpentBuffering:this.timeSpentBuffering(),bufferingEventsCount:this.metrics.general.bufferingRanges.length,timeSpentRatio:[...this.activeRatios()].reduce(((e,[t,i])=>(e[t]=i,e)),{}),fatalQosCount:this.fatalQosCount}))),I(this,"onRenditionLevelChanged",(e=>{var t,i,s,n,r,o,a,h,c,l,u,d,m,p;const f=(null!=(s=null==(i=null==(t=e.from)?void 0:t.video)?void 0:i.bitRate)?s:0)+(null!=(o=null==(r=null==(n=e.from)?void 0:n.audio)?void 0:r.bitRate)?o:0),g=(null!=(c=null==(h=null==(a=e.to)?void 0:a.video)?void 0:h.bitRate)?c:0)+(null!=(d=null==(u=null==(l=e.to)?void 0:l.audio)?void 0:u.bitRate)?d:0);this.logger.info("rendition level changed",{fromLevel:f,toLevel:g}),0===this.metrics.general.activeRanges.length&&this.setActive(),e.from&&e.to&&(f<g?this.metrics.general.upgradesFromLevel.push(Date.now()):this.metrics.general.downgradesFromLevel.push(Date.now()));let A=!1;if(e.from){const e=null!=(m=this.metrics.levels[f])?m:Zd();f<g?e.upgradesFromLevel.push(Date.now()):e.downgradesFromLevel.push(Date.now()),Ge(e.activeRanges);const t=e.bufferingRanges[e.bufferingRanges.length-1];A=!!t&&!t.end,Ge(e.bufferingRanges),this.metrics.levels[f]=e}if(e.to){const e=null!=(p=this.metrics.levels[g])?p:Zd();ze(e.activeRanges),A&&ze(e.bufferingRanges),this.metrics.levels[g]=e,this.currentLevel=g}})),I(this,"onBufferFullness",(e=>{this.bufferFullness.push(e),this.metrics.bufferFullness=e,this.bufferFullness.items().length>=this.minBufferFullnessLengthForRegression&&(this.bufferFullnessRegression=this.calculateLinearRegression())})),I(this,"onPlaybackState",(e=>{switch(this.logger.info("Playback state",{state:e,currentLevel:this.currentLevel}),e){case"playing":this.stopBuffering();break;case"buffering":this.isSuspended||this.startBuffering()}})),I(this,"onVideoDecodeRate",(e=>{var t;if(this.metrics.general.decodeRate=e,!this.currentLevel)return;const i=this.metrics.levels[null!=(t=this.currentLevel)?t:0];i&&(i.decodeRate=e)})),I(this,"calculateLinearRegression",(()=>(e=>{let t=0,i=0,s=0,n=0,r=0;for(let o=0;o<e.length;o++){const{x:a,y:h}=e[o];t+=a,i+=h,s+=a*h,n+=a*a,r+=h*h}const o=(e.length*s-t*i)/(e.length*n-t*t),a=(i-o*t)/e.length,h=Math.pow((e.length*s-t*i)/Math.sqrt((e.length*n-t*t)*(e.length*r-i*i)),2);return{slope:o,intercept:a,r2:h,predict:t=>o*(e.length+t)+a}})(this.bufferFullness.items().map(((e,t)=>({x:t,y:e})))))),I(this,"stopBuffering",(()=>{if(this.currentLevel){const e=this.metrics.levels[this.currentLevel];e&&Ge(e.bufferingRanges)}Ge(this.metrics.general.bufferingRanges)})),I(this,"startBuffering",(()=>{if(this.currentLevel){const e=this.metrics.levels[this.currentLevel];e&&ze(e.bufferingRanges)}ze(this.metrics.general.bufferingRanges)})),I(this,"unsetActive",(()=>{if(this.currentLevel){const e=this.metrics.levels[this.currentLevel];e&&Ge(e.activeRanges)}Ge(this.metrics.general.activeRanges)})),this.logger=t,this.emitter=e}get fatalQosCount(){return this._fatalQosCount}setActive(){if(this.currentLevel){const e=this.metrics.levels[this.currentLevel];e&&ze(e.activeRanges)}ze(this.metrics.general.activeRanges)}};I(Jd,"create",((e,t)=>new Jd(e,t)));let $d=Jd;const Yd=class{constructor(e,t){I(this,"renditions",new Map),I(this,"renditionLevels",[]),I(this,"languages",[]),I(this,"emitter"),I(this,"subscriptionSource"),I(this,"renditionLevelChangeCount",0),I(this,"unload",(()=>{this.emitter.off("renditions",this.onRenditions),this.emitter.off("subscription changed",this.onSubscriptionChanged)})),I(this,"getRenditionLevels",(e=>e?this.createRenditionLevels(e):this.renditionLevels)),I(this,"getRenditionLevel",(e=>{var t;const i=null!=e?e:this.getCurrentSubscription(),s=e?this.createRenditionLevels(e):this.renditionLevels;if(!i.video)return s.length?s[0]:void 0;const n=i.video.bitRate||Number.MAX_SAFE_INTEGER,r=i.video.width||Number.MAX_SAFE_INTEGER,o=i.video.height||Number.MAX_SAFE_INTEGER;return null!=(t=s.filter((e=>!e.video||!i.video||e.video.bitRate<=n&&e.video.width<=r&&e.video.height<=o)).pop())?t:s[0]})),I(this,"setRenditions",((e,t)=>{this.renditions.set(e,t)})),I(this,"getLanguages",(()=>this.languages)),I(this,"getVideoRendition",((e,t=this.getCurrentSubscription().channelId)=>{const i=this.getRendition(e,t);if(i&&et(i))return i})),I(this,"getAudioRenditions",(e=>{const t=this.renditions.get(e);return null==t?void 0:t.filter((e=>tt(e)))})),I(this,"getVideoRenditions",(e=>{const t=this.renditions.get(e);return null==t?void 0:t.filter((e=>et(e)))})),I(this,"getAudioRendition",((e,t=this.getCurrentSubscription().channelId)=>{const i=this.getRendition(e,t);if(i&&tt(i))return i})),I(this,"getRendition",((e,t=this.getCurrentSubscription().channelId)=>{var i;return null==(i=this.renditions.get(t))?void 0:i.find((t=>t.id===e))})),I(this,"getStatistics",(()=>{var e,t,i,s,n,r,o,a,h,c;const l=this.getRenditionLevel();return{videoCodec:null==(e=null==l?void 0:l.video)?void 0:e.codec,audioCodec:null==(t=null==l?void 0:l.audio)?void 0:t.codec,videoRenditionId:null==(i=null==l?void 0:l.video)?void 0:i.id,audioRenditionId:null==(s=null==l?void 0:l.audio)?void 0:s.id,videoWidth:null==(n=null==l?void 0:l.video)?void 0:n.width,videoHeight:null==(r=null==l?void 0:l.video)?void 0:r.height,expectedVideoBitRate:null==(o=null==l?void 0:l.video)?void 0:o.bitRate,expectedAudioBitRate:null==(a=null==l?void 0:l.audio)?void 0:a.bitRate,frameRate:null==(h=null==l?void 0:l.video)?void 0:h.frameRate,language:null==(c=null==l?void 0:l.audio)?void 0:c.language,renditionLevelChangeCount:this.renditionLevelChangeCount}})),I(this,"onRenditions",(e=>{const t=this.subscriptionSource.getCurrentSubscription();this.renditions.set(e.channelId,e.renditions),this.updateRenditionLevels({to:t,from:t})})),I(this,"onSubscriptionChanged",(e=>{this.updateRenditionLevels(e)})),I(this,"updateRenditionLevels",(({to:e,from:t})=>{var i;const{channelId:s,initiator:n}=e,r=this.getRenditionLevel(t),o=new Set;(null!=(i=this.renditions.get(s))?i:[]).filter((e=>"webvtt"!==e.codec)).forEach((e=>e.language?o.add(e.language):void 0)),this.languages=Array.from(o),this.renditionLevels=this.createRenditionLevels(e);const a=this.getRenditionLevel(e);be(r,a)||(this.renditionLevelChangeCount++,this.emitter.emit("rendition level changed",{to:a,from:r,reason:n?"manual":"abr"}))})),I(this,"createRenditionLevels",(e=>{var t;const{video:i,audio:s,channelId:n}=e,r=null!=(t=this.renditions.get(n))?t:[],o=r.filter(et).filter((e=>i&&e.codec===i.codec)),a=r.filter(tt).filter((e=>s&&e.codec===s.codec&&e.language===s.language)),h=Math.max(o.length,a.length),c=[];for(let e=0;e<h;e++){const t=o[Math.min(o.length-1,e)],i=a[Math.min(a.length-1,e)];c.push({audio:i,video:t})}return c})),I(this,"getCurrentSubscription",(()=>this.subscriptionSource.getCurrentSubscription())),this.subscriptionSource=t,this.emitter=e,this.emitter.on("renditions",this.onRenditions),this.emitter.on("subscription changed",this.onSubscriptionChanged)}};I(Yd,"create",((e,t)=>new Yd(e,t)));let Kd=Yd;const em=e=>JSON.parse(JSON.stringify(e)),tm=class{constructor(e,t,i){I(this,"logger"),I(this,"timers",new qe),I(this,"emitter"),I(this,"targetSubscription"),I(this,"currentSubscription"),I(this,"_isSwitchingSubscription",!1),I(this,"pendingSubscriptionTimeoutId"),I(this,"burstMs",0),I(this,"unload",(()=>{this.logger.debug("Unloading module..."),this.timers.unload(),this.emitter.off("subscription changed",this.onSubscriptionChanged),this.logger.debug("Unloaded module")})),I(this,"isSwitchingSubscription",(()=>this._isSwitchingSubscription)),I(this,"getTargetSubscription",(()=>this.targetSubscription)),I(this,"getCurrentSubscription",(()=>this.currentSubscription)),I(this,"enableBurst",(e=>{this.burstMs=e})),I(this,"setSize",(e=>{this.targetSubscription.video.width=e.width,this.targetSubscription.video.height=e.height,this.scheduleSubscriptionChange()})),I(this,"setVideoConstraint",(e=>{this.targetSubscription.video=e,this.scheduleSubscriptionChange()})),I(this,"setAudioConstraint",(e=>{this.targetSubscription.audio=e,this.scheduleSubscriptionChange()})),I(this,"setVideoBitRate",(e=>{this.targetSubscription.video.bitRate=e,this.scheduleSubscriptionChange()})),I(this,"setAudioBitRate",(e=>{this.targetSubscription.audio.bitRate=e,this.scheduleSubscriptionChange()})),I(this,"setChannelId",(e=>{this.targetSubscription.channelId=e,this.scheduleSubscriptionChange()})),I(this,"setLanguage",(e=>{this.targetSubscription.audio.language=e,this.scheduleSubscriptionChange()})),I(this,"setVideoCodec",(e=>{this.targetSubscription.video.codec=e,this.scheduleSubscriptionChange()})),I(this,"setAudioCodec",(e=>{this.targetSubscription.audio.codec=e,this.scheduleSubscriptionChange()})),I(this,"setBurst",(e=>{e?this.targetSubscription.burstMs=e:delete this.targetSubscription.burstMs})),I(this,"isNewSubscription",(()=>{const e=["burstMs","meta","initiator","channelGroupId"];return!be(je(this.currentSubscription,e),je(this.targetSubscription,e))})),I(this,"onSubscriptionChanged",(({to:e,reset:t})=>{this.logger.debug("onSubscriptionChanged",{to:e,reset:t}),t?this.targetSubscription=em(this.currentSubscription):this.currentSubscription=em(e),this._isSwitchingSubscription=this.isNewSubscription()})),I(this,"scheduleSubscriptionChange",(()=>{this.targetSubscription=em(this.targetSubscription),this._isSwitchingSubscription=this.isNewSubscription();const e=this.currentSubscription.channelId,t=this.targetSubscription.channelId,i=e!==t;this._isSwitchingSubscription&&(i&&this.burstMs?this.setBurst(this.burstMs):this.setBurst(0),this.pendingSubscriptionTimeoutId&&(this.timers.clearTimeout(this.pendingSubscriptionTimeoutId),this.pendingSubscriptionTimeoutId=void 0),i&&this.timers.setTimeout((()=>{this.currentSubscription.channelId===e&&this.targetSubscription.channelId===t&&(this.logger.warn("Channel switch timeout",t),this.targetSubscription=em(this.currentSubscription),this.emitter.emit("channel switch timeout",t))}),1e4),this.pendingSubscriptionTimeoutId=this.timers.setTimeout((()=>this.emitter.emit("send signal",{type:"subscribe",subscription:this.getTargetSubscription()})),0))})),this.logger=e,this.targetSubscription=t,this.currentSubscription=em(t),this.emitter=i,this.emitter.on("subscription changed",this.onSubscriptionChanged)}};I(tm,"create",((e,t,i)=>new tm(e,i,t)));let im=tm;const sm=()=>oe()||ae()||-1!==ie.indexOf("CrKey")?100:0,nm=e=>t=>t>e,rm=class{constructor(e,t,i,s,n){I(this,"emitter"),I(this,"logger"),I(this,"playbackSource"),I(this,"bufferSource"),I(this,"keyframeTimestamps",new z(10)),I(this,"lastSeekTime",Date.now()),I(this,"seekCooldownTime",1e3),I(this,"seekTimeoutTime",5e3),I(this,"seekKeyframeOvershoot",50),I(this,"syncMaxBehind"),I(this,"syncMaxBehindMultiplierStep",1),I(this,"syncMaxBehindIncreaseEvery",2),I(this,"syncMaxBehindMaximumAllowed",2e3),I(this,"syncMaxBehindMultiplier",1),I(this,"timeshiftOnAudio",!1),I(this,"syncMaxAhead",150),I(this,"timeshiftSync",{enabled:!1,maxBehind:50,multiplier:1,maxBehindAllowed:600,overshoot:sm(),minOvershootAllowed:sm(),maxOvershootAllowed:500}),I(this,"maxTimeSyncDifferenceTolerance",150),I(this,"timers",qe.create()),I(this,"rtt",0),I(this,"channelSyncInfo",new Map),I(this,"driftAdjustmentsCount",0),I(this,"timeshiftDriftAdjustmentCount",0),I(this,"driftAdjustments",[]),I(this,"timeShiftAdjustments",[]),I(this,"timestampOffset"),I(this,"currentChannelId"),I(this,"highestSeenTimestamps",new Map),I(this,"isSuspended",!1),I(this,"isSyncAdjustmentActivated",!1),I(this,"load",(()=>{this.timers.setInterval(this.onSync,100)})),I(this,"unload",(()=>{this.logger.debug("Unloading module..."),this.emitter.off("rtt",this.updateRtt),this.timers.unload(),this.logger.debug("Unloaded module")})),I(this,"suspend",(()=>{this.isSuspended=!0})),I(this,"unsuspend",(()=>{this.resetSyncState(),this.isSuspended=!1})),I(this,"deactivateSyncAdjustments",(()=>{this.isSyncAdjustmentActivated=!1})),I(this,"activateSyncAdjustments",(()=>{this.tryApplySyncInfo(0),this.lastSeekTime=Date.now(),this.isSyncAdjustmentActivated=!0})),I(this,"reset",(()=>{this.logger.info("Reset sync state"),this.currentChannelId=void 0,this.timestampOffset=void 0,this.resetSyncState(),this.highestSeenTimestamps.clear()})),I(this,"getTimeshiftOffset",(()=>{var e;return null!=(e=this.timestampOffset)?e:0})),I(this,"getCurrentChannelId",(()=>this.currentChannelId)),I(this,"resetSyncState",(()=>{this.timeshiftSync.multiplier=1,this.syncMaxBehindMultiplier=1,this.driftAdjustments=[],this.timeShiftAdjustments=[]})),I(this,"getLiveEdgeTime",(e=>{const t=this.channelSyncInfo.get(e);if(!t)return;const i=Date.now()-t.localTimestamp;return t.timestamp+i})),I(this,"getLiveEdgeTimeLatencyAdjusted",(e=>{const t=this.getLiveEdgeTime(e);if(t)return t+this.rtt/2})),I(this,"getWallclockTime",(e=>{const t=this.channelSyncInfo.get(e);if(!t)return;const i=Date.now()-t.localTimestamp;return t.wallclockTime+i})),I(this,"getWallclockTimeLatencyAdjusted",(e=>{const t=this.getWallclockTime(e);if(t)return t+this.rtt/2})),I(this,"processSample",(e=>{var t;if(!e.channelId)throw new Error("Sample must be assigned to a channel");this.currentChannelId||(this.currentChannelId=e.channelId),this.timestampOffset||(this.timestampOffset=e.timestamp/e.timescale*1e3-5e3);const i="video"===e.type&&e.isSync;if(this.currentChannelId!==e.channelId){let t=Number.MAX_SAFE_INTEGER;console.assert(0!==this.highestSeenTimestamps.size,"no known timestamps"),this.highestSeenTimestamps.forEach((e=>{t=Math.min(t,e)}));const i=e.timestamp/e.timescale*1e3;this.currentChannelId=e.channelId,this.timestampOffset=i-t}else(i||this.timeshiftOnAudio)&&this.tryTimeshiftSync();const s=this.timestampOffset*e.timescale/1e3;return e.timestamp-=s,i&&this.keyframeTimestamps.push(e.timestamp/e.timescale*1e3),this.highestSeenTimestamps.set(e.type,Math.max(null!=(t=this.highestSeenTimestamps.get(e.type))?t:0,e.timestamp/e.timescale*1e3)),e})),I(this,"processFragment",((e,t)=>{var i;this.currentChannelId||(this.currentChannelId=e);const s=t.mediaType();if(!s)throw new Error("Fragment must have a media type");this.timestampOffset||(this.timestampOffset=t.baseMediaDecodeTime()/t.timescale()*1e3-5e3);const n="video"===t.mediaType()&&t.startsWithKeyframe();this.currentChannelId!==e?(console.assert(0!==this.highestSeenTimestamps.size,"no known timestamps"),this.highestSeenTimestamps.forEach((e=>{})),this.currentChannelId=e):(n||this.timeshiftOnAudio)&&this.tryTimeshiftSync();const r=this.timestampOffset*t.timescale()/1e3;return t.updateBaseMediaDecodeTime(t.baseMediaDecodeTime()-r),n&&this.keyframeTimestamps.push(t.baseMediaDecodeTime()/t.timescale()*1e3),this.highestSeenTimestamps.set(s,Math.max(null!=(i=this.highestSeenTimestamps.get(s))?i:0,t.baseMediaDecodeTime()/t.timescale()*1e3)),t})),I(this,"getStatistics",(()=>({drift:this.drift,driftAdjustmentCount:this.driftAdjustmentsCount,timeshiftDriftAdjustmentCount:this.timeshiftDriftAdjustmentCount,seekTime:this.playbackSource.seekTime}))),I(this,"updateRtt",(e=>{this.rtt=e})),I(this,"isPlaybackSourceReadyToSeek",(()=>!this.isSeeking()&&this.isSeekCooldownExpired()&&this.isSyncAdjustmentActivated)),I(this,"isSeeking",(()=>!!this.playbackSource.isSeeking&&!this.isSeekTimeoutExpired())),I(this,"isAllowedToSync",(()=>this.isPlaybackSourceReadyToSeek()&&!!this.currentChannelId&&!this.isSuspended&&!this.playbackSource.isPaused)),I(this,"isSeekCooldownExpired",(()=>Date.now()-this.lastSeekTime>this.seekCooldownTime)),I(this,"isSeekTimeoutExpired",(()=>Date.now()-this.lastSeekTime>this.seekTimeoutTime)),I(this,"currentTimeshiftMaxBehind",(()=>Math.min(this.timeshiftSync.maxBehind*this.timeshiftSync.multiplier,this.timeshiftSync.maxBehindAllowed))),I(this,"currentSyncMaxBehind",(()=>Math.min(this.syncMaxBehindMultiplier*this.syncMaxBehind,this.syncMaxBehindMaximumAllowed))),I(this,"currentSyncMaxAhead",(()=>this.playbackSource.seekTime>500?Math.max(this.syncMaxAhead*this.syncMaxBehindMultiplier,300):this.syncMaxAhead)),I(this,"tryTimeshiftSync",(()=>{var e;if(!this.timeshiftSync.enabled||!this.isAllowedToSync())return;const t=null!=(e=this.drift)?e:0;if(t>=this.syncMaxBehind)return;if(t<this.currentTimeshiftMaxBehind())return void(this.timeshiftSync.overshoot=0);if(!this.timestampOffset)return;const i=Date.now()-this.seekTimeoutTime*this.timeshiftSync.multiplier,s=this.timeShiftAdjustments.filter(nm(i)).length;if(s&&this.timeshiftSync.multiplier>2)return this.logger.debug("Too many diff timeShifts within sliding window",{timeShiftsCooldownMs:i,timeShiftsWithinCooldownTime:s}),!1;const n=t+this.timeshiftSync.overshoot;this.logger.info("Adjusting for drift using timeshift",{drift:t,syncAmount:n,currentTime:this.playbackSource.currentTime,rtt:this.rtt,overshoot:this.timeshiftSync.overshoot}),this.timestampOffset+=n,this.lastSeekTime=Date.now(),!this.playbackSource.isPaused&&(this.timeShiftAdjustments.push(this.lastSeekTime),this.timeshiftDriftAdjustmentCount++,this.timeshiftSync.multiplier++,this.timeshiftSync.overshoot=Math.max(this.timeshiftSync.minOvershootAllowed,Math.min(this.timeshiftSync.multiplier*t/2,this.timeshiftSync.maxOvershootAllowed)))})),I(this,"onSync",(()=>{var e;if(!this.isAllowedToSync())return;const t=null!=(e=this.drift)?e:0;if(t<0&&-t<this.currentSyncMaxAhead()||t>0&&t<this.currentSyncMaxBehind()||Math.abs(t)<1||!this.isSeekCooldownExpired())return;const i=Date.now()-this.seekTimeoutTime*this.syncMaxBehindMultiplier,s=this.driftAdjustments.filter(nm(i)).length;if(s&&this.syncMaxBehindMultiplier>2)return this.logger.debug("Too many diff adjustments within sliding window",{adjustmentsCooldownMs:i,adjustmentsWithinCooldownTime:s}),!1;const n=this.playbackSource.seekTime,r=this.playbackSource.currentTime+t,o=this.findKeyframeCloseToTimestamp(r);if(o||this.keyframeTimestamps.isEmpty()){const e=o?o+this.seekKeyframeOvershoot:r;if(this.logger.info("Adjusting for drift using seek",{drift:t,currentTime:this.playbackSource.currentTime,targetCurrentTime:e,seekTime:n,rtt:this.rtt}),this.lastSeekTime=Date.now(),this.driftAdjustments.push(this.lastSeekTime),this.driftAdjustmentsCount++,this.playbackSource.currentTime=e+n,this.timeshiftSync.overshoot=Math.max(this.timeshiftSync.minOvershootAllowed,this.timeshiftSync.overshoot/2),this.driftAdjustmentsCount%this.syncMaxBehindIncreaseEvery==0&&!this.playbackSource.isPaused){const e=this.currentSyncMaxBehind;this.syncMaxBehindMultiplier+=this.syncMaxBehindMultiplierStep,e!==this.currentSyncMaxBehind&&this.logger.info("Increasing max drift behind allowed",{from:e,to:this.currentSyncMaxBehind})}}})),I(this,"findKeyframeCloseToTimestamp",(e=>{const t=this.keyframeTimestamps.items();for(const i of t)if(i>=e&&i<=e+200)return i})),this.logger=t,this.emitter=e,this.playbackSource=i,this.bufferSource=s,this.timeshiftSync.enabled=n,this.syncMaxBehind=this.timeshiftSync.enabled?1e3:200,this.emitter.on("rtt",this.updateRtt)}updateChannelSyncInfo(e,t){const i=Date.now(),s=this.channelSyncInfo.get(e),n=this.getLiveEdgeTime(e);if(this.isSuspended)return;if(!s||!n)return this.logger.info("Initial timing info",{syncInfo:t}),void this.channelSyncInfo.set(e,A(g({},t),{localTimestamp:i,timeDifferences:new z(12)}));const r=t.wallclockTime-s.wallclockTime,o=t.timestamp-s.timestamp,a=i-s.localTimestamp,h=o-a;if(s.timeDifferences.push(h),this.logger.debug("Timing info",{rtt:this.rtt,channelId:e,syncInfo:t,localTimestamp:i,diffFromEstimated:h,timestampDelta:o,wallclockDelta:r,localWallclockDelta:a}),Math.abs(h)>=2*this.bufferSource.getTargetBufferTime())return this.logger.info("Resetting sync info",{diffFromEstimated:h}),this.channelSyncInfo.set(e,A(g({},t),{localTimestamp:i,timeDifferences:new z(s.timeDifferences.maxSize+1)})),void(this.currentChannelId&&this.currentChannelId===e&&(this.reset(),this.emitter.emit("channel reset")));s.timeDifferences.isFull()&&this.tryApplySyncInfo(this.maxTimeSyncDifferenceTolerance)}tryApplySyncInfo(e){const t=this.getCurrentChannelId();if(!t)return;const i=this.channelSyncInfo.get(t);if(!i)return;const s=we(i.timeDifferences.items());Math.abs(s)>e&&(this.logger.info("Adjusting sync info",{averageDifference:s}),i.timestamp+=s,i.timeDifferences.clear())}get serverCurrentTime(){return this.channelCurrentTime-this.getTimeshiftOffset()}get channelCurrentTime(){const e=this.getCurrentChannelId();if(!e)return 0;const t=this.getLiveEdgeTime(e);return t?t-this.bufferSource.getTargetBufferTime():0}get drift(){return this.serverCurrentTime-this.playbackSource.currentTime}};I(rm,"create",((e,t,i,s,n)=>new rm(e,t,i,s,n)));let om=rm;const am={enabled:!0,interval:3e4,includeErrors:!0,includeEvents:!0,includeStats:!0,maxRetries:10,maxErrorReports:50,maxEvents:50},hm=(e,t)=>A(g({},t),{type:e,timestamp:(new Date).toISOString(),discriminator:"web"}),cm=class{constructor(e,t,i,s){I(this,"logger"),I(this,"timers",new qe),I(this,"emitter"),I(this,"options"),I(this,"parentContext"),I(this,"unsentLines",new z(100)),I(this,"retries",0),I(this,"errorCount",0),I(this,"eventCount",0),I(this,"statsCount",0),I(this,"unload",(()=>{this.logger.debug("Unloading module..."),window.removeEventListener("error",this.onError),window.removeEventListener("unhandledrejection",this.onRejection),this.timers.unload(),this.emitter.off("error",this.addError),this.emitter.off("visibilitystate",this.onVisibilityChange),this.emitter.off("pagehide",this.onPageHide),this.emitter.off("telemetry event",this.addEvent),this.addStats({isFinal:!0,initiator:"unload"}),this.send("beacon"),this.logger.debug("Unloaded module")})),I(this,"load",(()=>{window.addEventListener("error",this.onError),window.addEventListener("unhandledrejection",this.onRejection),this.emitter.on("error",this.addError),this.emitter.on("visibilitystate",this.onVisibilityChange),this.emitter.on("pagehide",this.onPageHide),this.emitter.on("telemetry event",this.addEvent),this.timers.setInterval((()=>{this.addStats(),this.send("fetch")}),this.options.interval)})),I(this,"addStats",(({isFinal:e,initiator:t}={isFinal:!1,initiator:"interval"},i={})=>{if(!this.options.includeStats)return;const s=this.parentContext.getStatistics(),n=hm("stats",A(g(g({},i),s),{isFinal:e,initiator:t,count:this.statsCount++}));this.unsentLines.push(n)})),I(this,"addEvent",(e=>{if(!this.options.includeEvents||this.eventCount>this.options.maxEvents)return;const t=this.parentContext.getStatistics(),i=hm("event",g(g({},t),e));this.eventCount++,this.unsentLines.push(i)})),I(this,"getStatistics",(()=>({errorCount:this.errorCount}))),I(this,"send",(e=>L(this,null,(function*(){if(this.options.enabled&&!(this.retries>=this.options.maxRetries)&&!this.unsentLines.isEmpty()){this.logger.debug("Sending telemetry",{lines:this.unsentLines.items()});try{const t=this.unsentLines.items().map((e=>JSON.stringify(e))).reverse().join("\n");"beacon"===e?navigator.sendBeacon(this.options.url,t):"connected"===this.parentContext.connectionState?this.emitter.emit("send signal",{type:"telemetry",body:t}):yield(0,n.p)(new URL(this.options.url),{body:t,headers:{"Content-Type":"text/plain"}}),this.retries=0,this.unsentLines.clear()}catch(e){this.retries++}}})))),I(this,"onVisibilityChange",(e=>{"hidden"===e&&(this.addStats({isFinal:!0,initiator:"visibilitychange"}),this.send("beacon"))})),I(this,"onPageHide",(e=>{this.addStats({isFinal:!0,initiator:"pagehide"},{persisted:e.persisted}),this.send("beacon")})),I(this,"onRejection",(e=>this.addError(e.reason))),I(this,"onError",(e=>this.addError(e.error))),I(this,"addError",(e=>{const{includeErrors:t,maxErrorReports:i}=this.options;if(t&&e instanceof at){if(this.errorCount++,this.errorCount>i)return;const t=this.parentContext.getStatistics();this.unsentLines.push(hm("error",g(g({},t),e.toStringifiable())))}})),this.logger=e,this.emitter=t,this.options=g(g({},am),i),this.parentContext=s}};I(cm,"create",((e,t,i,s)=>new cm(e,t,i,s)));let lm=cm;const um=class{constructor(e,t,i){I(this,"logger"),I(this,"element"),I(this,"documentState"),I(this,"timers",new qe),I(this,"unload",(()=>{this.timers.unload()})),I(this,"unpause",(()=>{this.element.userHasProvidedInput&&this.element.isPaused&&this.documentState.isVisible&&this.documentState.isOnline&&(this.logger.debug("Unpause video"),this.element.tryPlay())})),this.logger=e,this.element=t,this.documentState=i,this.timers.setInterval(this.unpause,100)}};I(um,"create",((e,t,i)=>new um(e,t,i)));let dm=um;class mm{constructor(){var e;I(this,"highEntropyValues"),null==(e=self.navigator.userAgentData)||e.getHighEntropyValues(["architecture","model","platformVersion","fullVersionList"]).then((e=>{this.highEntropyValues=e}))}getUserAgentInformation(){var e,t,i,s,n,r;const o=window.location.origin,a=o&&"null"!=o?`${window.location.pathname}${window.location.search}`.substring(0,1e3):"",h={locationOrigin:window.location.origin,locationPath:a,ancestorOrigins:(null==(e=window.location.ancestorOrigins)?void 0:e.length)>0?Array.from(window.location.ancestorOrigins):void 0,hardwareConcurrency:navigator.hardwareConcurrency,deviceMemory:navigator.deviceMemory};if(self.navigator.userAgentData&&this.highEntropyValues){const e="1",o=[...null!=(t=this.highEntropyValues.brands)?t:[]];o.sort(((e,t)=>e.brand.localeCompare(t.brand)));const a=[...null!=(i=this.highEntropyValues.fullVersionList)?i:[]];a.sort(((e,t)=>e.brand.localeCompare(t.brand)));const c=a.map((e=>e.version)),l=o.map((e=>e.brand)),u=o.map((e=>e.version)),d=parseInt(null!=(n=null==(s=this.highEntropyValues.platformVersion)?void 0:s.split(".")[0])?n:e);return g({userAgentLegacy:window.navigator.userAgent,ua:{browser:{brands:l,fullVersionBrands:c,majorVersions:u},device:this.highEntropyValues.model||"Other",os:{family:this.highEntropyValues.platform||"Other",version:null!=(r=this.highEntropyValues.platformVersion)?r:e,major_version:Number.isFinite(d)?d:0}}},h)}return g({userAgent:window.navigator.userAgent},h)}}var pm,fm,gm;const Am=class e extends s.E{constructor(t){var i,r;super(),I(this,"pictureInPicture"),I(this,"drm"),I(this,"browser",le()),I(this,"options"),I(this,"element"),I(this,"playbackSource"),I(this,"emitter",new s.E),I(this,"logger"),I(this,"modules"),I(this,"clientIp"),I(this,"sessionId"),I(this,"clientId",Je()),I(this,"_channels",[]),I(this,"createdAt",Date.now()),I(this,"hasCalledConnect",!1),I(this,"latestEmittedLanguages",[]),I(this,"wakeLock"),I(this,"pool",new N(e.MAX_POOL_SIZE)),I(this,"userAgentInformation",new mm),I(this,"encryptedMediaExtensions"),B(this,pm,0),B(this,fm,[]),I(this,"sampleProcessingSesssions",new Map),I(this,"sizes",new Map),I(this,"isSuspended",!0),I(this,"disconnectTimeout"),B(this,gm),I(this,"attach",(e=>{var t;null==(t=this.wakeLock)||t.attach(e),e.appendChild(this.element)})),I(this,"getOptions",(()=>this.options.getOptions())),I(this,"getThumbnailUrl",(()=>{let e=this.options.get("edgeUrl")||this.options.get("url");e=e.replace("wss://","https://"),e=e.replace("ws://","http://"),e=e.endsWith("/")?e.slice(0,-1):e;const t=window.devicePixelRatio||1,i=Math.round(window.innerWidth*t),s=Math.round(window.innerHeight*t),n=this.options.get("authenticationToken"),r=n?`&auth.token=${n}`:"";return`${e}/api/thumbnail?channelId=${this.channelId}${r}&width=${i}&height=${s}`})),I(this,"updateAuthenticationToken",(e=>{this.logger.debug("Got new auth token",{token:e}),this.options.set("authenticationToken",e),this.emitter.emit("send signal",{type:"refresh auth",token:e})})),I(this,"connect",(()=>{this.hasCalledConnect||(this.play(),this._connect())})),I(this,"_connect",(()=>{var e,t;this.hasCalledConnect||(this.hasCalledConnect=!0,Object.values(this.modules).forEach((e=>{e&&"load"in e&&e.load()})),this.unsuspend(),this.playbackSource instanceof sn&&(null==(t=(e=this.playbackSource).load)||t.call(e)),this.modules.connection.connect())})),I(this,"getCastOptions",(()=>({url:this.options.get("url"),channelId:this.options.get("channelId"),channelGroupId:this.options.get("channelGroupId"),authenticationToken:this.options.get("authenticationToken"),language:this.options.get("language"),logLevel:this.options.get("logLevel"),minBufferTime:this.options.get("minBufferTime"),tags:this.options.get("tags"),ownerSessionId:this.sessionId,edgeUrl:this.options.get("edgeUrl"),media:this.options.get("media"),drm:this.options.get("drm")}))),I(this,"onConnectInfo",(e=>L(this,null,(function*(){var t;this.sessionId=Je();const i=this.modules.subscription.getTargetSubscription(),s=e.channels.find((e=>e.channelId===i.channelId));if(this.emitter.emit("connect info",e),this._channels=e.channels,this.updateTextTracks(null!=(t=null==s?void 0:s.renditions)?t:[]),!this.textTrack&&this.options.get("textTrack")&&(this.textTrack=this.options.get("textTrack")),yield Promise.all(e.channels.map((e=>L(this,null,(function*(){e.overrides&&this.options.addOverrides(e.channelId,e.overrides),e.renditions=yield this.filterRenditions(e.renditions),this.modules.renditions.setRenditions(e.channelId,e.renditions)}))))),!s)throw pt("external");const n=this.options.getOverride("sizeBasedResolutionCapEnabled",this.channelId);void 0!==n&&(this.modules.constraintCap.sizeBasedResolutionCapEnabled=n);const r=this.options.getOverride("minBufferTime",this.channelId),o=this.options.getOverride("maxBufferTime",this.channelId);if((r||o)&&(this.modules.bufferTime.updateConfig({minBufferTime:this.options.get("minBufferTime",this.channelId),maxBufferTime:this.options.get("maxBufferTime",this.channelId)}),this.targetBufferTime=this.options.get("minBufferTime",this.channelId)),this.options.get("burstEnabled",this.channelId)&&this.modules.subscription.enableBurst(this.targetBufferTime),this.emit("is live",s.isLive),!s.isLive)throw new Error("Waiting for channel to go live");this.patchSubscription(s,this.modules.connection.estimatedBandwidth),yield this.initializeDecodingModule(),this.resetModules(),this.emit("rendition levels",this.modules.renditions.getRenditionLevels()),this.emit("channels",this.channels),this.emitLanguagesIfChanged(),this.sampleProcessingSesssions.clear();const a=this.options.get("burstEnabled",this.channelId);return{video:this.targetSubscription.video,audio:this.targetSubscription.audio,burstMs:a?this.targetBufferTime:void 0,sessionId:this.sessionId,clientId:this.clientId,channelId:this.channelId,channelGroupId:this.options.get("channelGroupId"),authToken:this.options.get("authenticationToken"),textTrack:this.textTrack}})))),I(this,"emitLanguagesIfChanged",(()=>{const e=this.modules.renditions.getLanguages(),t=this.latestEmittedLanguages;e.length==t.length&&e.every((e=>t.includes(e)))||(this.logger.debug("Emitting new languages",{currentLanguages:e}),this.latestEmittedLanguages=e,this.emit("languages",this.latestEmittedLanguages))})),I(this,"updateTextTracks",(e=>{const t=e.filter((e=>"webvtt"===e.codec));t.forEach((e=>{if(!M(this,fm).find((t=>t.language===e.language)))if(this.modules.canvasModule){const t=this.modules.canvasModule.textTracks.addTextTrack(e.kind,e.label||e.language||"",e.language||"");M(this,fm).push(t)}else if(this.mediaElement instanceof HTMLVideoElement){const t=this.mediaElement.addTextTrack(e.kind,e.label||e.language,e.language);M(this,fm).push(t)}}));for(const e of M(this,fm))t.find((t=>t.language===e.language))?"disabled"===e.mode&&(e.mode="hidden"):e.mode="disabled";this.emit("text tracks",this.textTracks)})),I(this,"cleanupTextTracks",((e=this.currentTime-2e4)=>{M(this,fm).forEach((t=>{if(t.cues)for(const i of t.cues)1e3*i.endTime<e-2e3&&t.removeCue(i)}))})),I(this,"filterRenditions",(e=>L(this,null,(function*(){const t=yield Promise.all(e.map((e=>L(this,null,(function*(){var t,i,s;if(tt(e))return!0;if(!et(e)||!this.isSupportedVideoCodecProfile(e.codec,e.codecString))return!1;if(!this.willUseMediaSource()){const n=this.options.get("advanced"),r=null!=(t=n.wasmDecodingConstraint.bitRate)?t:Number.MAX_SAFE_INTEGER,o=null!=(i=n.wasmDecodingConstraint.width)?i:Number.MAX_SAFE_INTEGER,a=null!=(s=n.wasmDecodingConstraint.height)?s:Number.MAX_SAFE_INTEGER;return e.bitRate<=r&&e.width<=o&&e.height<=a}const n=yield(e=>{if(!navigator.mediaCapabilities)return Promise.resolve({smooth:!0,supported:!0,powerEfficient:!0,failedToQuery:!0});if("webvtt"===e.codec)throw new Error("WebVTT is not supported");let t;return t=tt(e)?{type:"media-source",audio:{contentType:it(e),bitrate:e.bitRate,channels:e.channels.toString(),samplerate:e.sampleRate}}:{type:"media-source",video:{contentType:it(e),bitrate:e.bitRate,width:e.width,height:e.height,framerate:e.frameRate[0]/e.frameRate[1]}},navigator.mediaCapabilities.decodingInfo(t)})(e);if(!n.supported||"av1"==e.codec&&!n.smooth&&!n.powerEfficient)return!1;const r=this.options.getOverride("maxVideoBitRate",this.channelId);return!r||r>=e.bitRate})))));let i=e.filter(((e,i)=>t[i]));const s=i.filter((e=>"h264"===e.codec)).reverse()[0],n=i.filter((e=>"av1"===e.codec)).reverse()[0];return s&&n&&s.width>n.width&&s.height>n.height&&(i=i.filter((e=>"av1"!==e.codec))),i})))),I(this,"patchSubscription",((t,i)=>{const s=Math.min(this.options.get("maxVideoBitRate"),e.INITIAL_MAX_BIT_RATE,i,this.targetSubscription.video.bitRate),n=Math.min(this.options.get("maxAudioBitRate"),e.INITIAL_MAX_BIT_RATE,i,this.targetSubscription.audio.bitRate),r="audio"===this.options.get("media")?[]:this.options.get("videoCodecs",this.channelId),o=this.supportedAudioCodecs(),a=t.renditions.filter(tt),h=t.renditions.filter(et),c=o.find((e=>void 0!==a.find((t=>t.codec===e)))),l=r.find((e=>void 0!==h.find((t=>t.codec===e)))),u=a.map((e=>e.language));if(this.logger.debug("supported and selected codecs",{audioCodecs:o,videoCodecs:r,audioCodec:c,videoCodec:l}),l){const e=this.options.get("maxSize");this.modules.subscription.setVideoConstraint(g({codec:l,bitRate:this.abrEnabled?s:this.options.get("maxVideoBitRate")},e))}c&&(this.modules.subscription.setAudioConstraint({codec:c,bitRate:this.abrEnabled?n:this.options.get("maxAudioBitRate"),language:this.options.get("language")}),(!u.includes(this.options.get("language"))||void 0===this.language)&&this.modules.subscription.setLanguage(u[0])),this.alignSizeAndBitRate(this.targetSubscription);const d=this.modules.subscription.getTargetSubscription();this.emitter.emit("subscription changed",{to:d,from:this.modules.subscription.getCurrentSubscription()})})),I(this,"isSupportedVideoCodecProfile",((e,t)=>{if(this.willUseMediaSource()){const i=ee();return!i||i.isTypeSupported(it({codec:e,codecString:t}))}if("h264"===e){const e=!(null==t||!t.startsWith("avc1.42")),i=!(null==t||!t.startsWith("avc1.66."));return e||i}return"av1"!==e})),I(this,"supportedAudioCodecs",(()=>{if("video"===this.options.get("media"))return[];const e=[];return(this.browser.supportsMp4Opus&&this.options.get("mseOpusEnabled")||!this.willUseMediaSource())&&e.push("opus"),this.willUseMediaSource()&&e.push("aac"),e})),I(this,"initializeDecodingModule",(()=>L(this,null,(function*(){var e,t;const i=this.currentRenditionLevel,s=[];if(!i)throw new at("No currentRenditionLevel",{code:"no_current_rendition_level",isFatal:!1});if(null!=i&&i.video&&s.push({type:"video",mimeType:it(i.video),codec:i.video.codec}),null!=i&&i.audio&&s.push({type:"audio",codec:i.audio.codec,mimeType:it(i.audio)}),0===s.length)throw new at("Can't initialize decoding module without tracks",{code:"no_tracks",isFatal:!1});if(this.willUseMediaSource()&&this.element instanceof HTMLMediaElement)this.emitter.emit("flush buffers"),yield null==(e=this.modules.mseModule)?void 0:e.setSourceBuffers(s);else{const e=yield Du.create(this.emitter,this.logger.createContext("DecoderModule"),s,this.playbackSource,this.pool);null==(t=this.modules.decoder)||t.unload(),this.modules.decoder=e,this.modules.decoder.load()}})))),I(this,"unload",(()=>L(this,null,(function*(){var t,i,s;this.logger.debug("Unloading modules..."),yield Promise.all(Object.values(this.modules).map((e=>null==e?void 0:e.unload()))),null==(t=this.wakeLock)||t.unload(),this.pool=new N(e.MAX_POOL_SIZE),null==(s=(i=this.playbackSource).unload)||s.call(i),this.element.remove(),this.emitter.reset(),this.encryptedMediaExtensions.unload(),this.reset(),this.logger.debug("Unloaded modules")})))),I(this,"userInput",(()=>{this.play()})),I(this,"pause",(()=>{this.options.get("pauseSupportEnabled")&&"paused"!==this.playbackState&&(this.playbackSource.pause(),this.hasCalledConnect&&this.suspend())})),I(this,"registerDebugInstance",(()=>{(e=>{const t=window;t.vindralInstances=t.vindralInstances||{},t.vindralInstances[e.getStatistics().clientId.substring(0,8)]=e})(this)})),I(this,"play",(()=>{var t;this.hasCalledConnect?this.unsuspend():"playing"!==this.playbackState&&(this._connect(),self.addEventListener("__vindral_register_debug__",this.registerDebugInstance),this.modules.timer.setInterval((()=>this.cleanupTextTracks()),e.REMOVE_CUE_THRESHOLD)),null==(t=this.wakeLock)||t.enable(),"paused"===this.playbackState&&(this.resetModules(),this.emitter.emit("flush buffers"),this.cleanupTextTracks(Number.MAX_SAFE_INTEGER)),this.playbackSource.play()})),I(this,"getStatistics",(()=>Object.values(this.modules).reduce(((e,t)=>t&&"getStatistics"in t?g(g({},e),t.getStatistics()):e),this.getRuntimeInfo()))),I(this,"resetModules",(()=>{Object.values(this.modules).forEach((e=>{e&&"reset"in e&&e.reset()})),this.sampleProcessingSesssions.clear(),this.playbackSource.currentTime=0,this.playbackSource.isActivated=!1})),I(this,"getRuntimeInfo",(()=>{const e=this.modules.canvasModule?this.options.get("iosMediaElementEnabled"):void 0;return g({uptime:Date.now()-this.createdAt,version:"4.1.1",clientId:this.clientId,sessionId:this.sessionId,channelId:this.channelId,channelGroupId:this.options.get("channelGroupId"),ip:this.clientIp,url:this.options.get("url"),timeToFirstFrame:this.timeToFirstFrame(),iosMediaElementEnabled:e},this.userAgentInformation.getUserAgentInformation())})),I(this,"onMediaElementState",(e=>{this.logger.info("media element state",{state:e}),this.options.get("pauseSupportEnabled")&&("paused"===e?this.modules.documentState.isVisible&&(this.suspend(),this.modules.connection.disconnect()):(this.unsuspend(),"disconnected"===this.modules.connection.getState()&&this.modules.connection.unsuspend()))})),I(this,"onBufferEvent",(e=>{var t,i,s,n;this.emit("buffer state event",e);const r=!this.playbackSource.isActivated||this.playbackSource.isPaused;if("filled"===e&&r){const e=Math.max(this.currentTime,null!=(i=null==(t=this.videoBufferedRanges[0])?void 0:t.start)?i:0,null!=(n=null==(s=this.audioBufferedRanges[0])?void 0:s.start)?n:0);this.logger.info("Buffer filled - starting playback",{currentTime:e}),this.playbackSource.currentTime=e,this.modules.sync.activateSyncAdjustments(),this.playbackSource.isActivated=!0}else"drained"===e&&this.playbackSource.isPaused&&(this.playbackSource.isActivated=!1,this.modules.sync.deactivateSyncAdjustments())})),I(this,"timeToFirstFrame",(()=>{const e=this.modules.playback.getFirstFrameTime(),t=this.modules.connection.firstConnectionTime;if(t&&e)return e-t})),this.options=new rn(g(g({},ot),(e=>{if(!(e=>!("object"!=typeof e||!yt(e,"channelId")||"string"!=typeof e.channelId||!yt(e,"url")||"string"!=typeof e.url||0===e.channelId.length||0===e.url.length))(e))throw new at("Invalid options",{isFatal:!0,code:"invalid_options"});const t=g({},e);return Object.keys(t).forEach((e=>{const i=t;void 0===i[e]&&delete i[e]})),t})(t))),void 0===t.telemetryEnabled&&["localhost","127.0.0.1"].includes(location.hostname)&&this.options.set("telemetryEnabled",!1);const o={channelId:this.options.get("channelId"),audio:{language:this.options.get("language"),bitRate:this.options.get("maxAudioBitRate")},video:{bitRate:this.options.get("maxVideoBitRate"),width:this.options.get("maxSize").width,height:this.options.get("maxSize").height}},a=Me.get();a.setLevel(this.options.get("logLevel")),a.setDebug(!1),this.logger=a;const h=Hd.create(this.emitter,this.logger.createContext("PictureInPictureModule")),c=qe.create(),l=Uu.create(this.emitter,this.logger.createContext("ConnectionModule"),{reconnectHandler:this.options.get("reconnectHandler"),options:this.options,onConnectInfo:this.onConnectInfo}),u=im.create(this.logger.createContext("SubscriptionModule"),this.emitter,o),d=Kd.create(this.emitter,u),m=$d.create(this.emitter,this.logger.createContext("QualityOfServiceModule")),p=qd.create(this.emitter,this.logger.createContext("PlaybackModule"),this,this.options.get("minBufferTime"));this.encryptedMediaExtensions=new hi(this.emitter,this.logger.createContext("EncryptedMediaExtensions"),null==(i=t.drm)?void 0:i.headers,null==(r=t.drm)?void 0:r.queryParams),this.drm={setHeaders:e=>{this.encryptedMediaExtensions.headers=e},setQueryParams:e=>{this.encryptedMediaExtensions.queryParams=e}};const f=Wu.create(this.emitter),w=this.options.get("poster"),y=!0===w?this.getThumbnailUrl():w||void 0;let v,b,S;if(this.willUseMediaSource()){const e=new sn({type:"audio"==this.options.get("media")?"audio":"video",autoplay:!1,muted:this.options.get("muted")||"video"===this.options.get("media"),logger:this.logger.createContext("MediaElement"),poster:y});e.on("buffer state",(e=>this.emitter.emit("buffer state",e))),e.on("needs user input",(e=>this.emitter.emit("needs user input",e))),e.on("volume state",(e=>this.emit("volume state",e))),e.on("media element state",(e=>this.onMediaElementState(e))),this.element=e.element,this.playbackSource=e,hi.isSupported()&&this.encryptedMediaExtensions.attach(e.element),v=jd.create(this.logger.createContext("MseModule"),this.emitter,this.element),this.options.get("pauseSupportEnabled")||(b=dm.create(this.logger.createContext("UnpauseModule"),e,f)),this.options.get("pictureInPictureEnabled")&&this.emitter.emit("add picture in picture listener",{element:e.element})}else if(this.browser.platform.iosVersion>=15&&this.options.get("iosMediaElementEnabled")){const e=Rd.create(this.emitter,this.logger.createContext("ModernCanvasModule"),this.pool,this,{type:"audio"==this.options.get("media")?"audio":"video",muted:this.options.get("muted")||"video"===this.options.get("media"),poster:y}),t=e.element();this.element=t.element,this.playbackSource=e,S=e,this.options.get("pictureInPictureEnabled")&&this.browser.platform.iosVersion>15&&this.emitter.emit("add picture in picture listener",{element:this.element}),this.options.get("pauseSupportEnabled")||(b=dm.create(this.logger.createContext("UnpauseModule"),t,f))}else{const e=Bd.create(this.emitter,this.logger.createContext("LegacyCanvasModule"),this.pool,this,this.options.get("muted")||"video"===this.options.get("media"));this.element=e.element(),this.playbackSource=e,S=e,this.options.get("iosWakeLockEnabled")&&(this.wakeLock=new Xs)}this.emitter.on("channel reset",this.resetModules),this.emitter.on("no data timeout",this.resetModules),this.emitter.on("media element state",(e=>this.onMediaElementState(e))),this.emitter.on("volume state",(e=>this.emit("volume state",e))),this.options.get("pauseSupportEnabled")||this.emitter.on("exit picture in picture",(()=>c.setTimeout((()=>this.play()),0))),this.emitter.on("constraint cap changed",(e=>{this.logger.info("new cap set",{cap:e}),this.alignSizeAndBitRate(this.targetSubscription)})),this.pictureInPicture={enter:()=>h.requestPictureInPicture(),exit:()=>h.exitPictureInPicture(),isActive:()=>h.isPictureInPictureActive(),isSupported:()=>h.isPictureInPictureSupported()},this.emitter.on("error",(e=>{if("external"===e.type()&&this.emit("error",e),e.isFatal())return()=>{this.unload()}}));const k=this.browser.platform.isIOS&&!this.browser.platform.isIpadOS,E=om.create(this.emitter,this.logger.createContext("SyncModule"),this.playbackSource,p,this.willUseMediaSource()&&!k),T=(this.options.get("edgeUrl")||this.options.get("url")).replace("wss://","https://").replace("ws://","http://").replace("//lb.","//errors."),C=new URL("/telemetry",T).toString(),x=lm.create(this.logger.createContext("TelemetryModule"),this.emitter,{url:C,enabled:this.options.get("telemetryEnabled"),includeStats:!1,interval:5e3},this);let R;this.modules={telemetry:x,bufferTime:dn.create(this.emitter,this.logger.createContext("BufferTimeModule"),m,this,{maxBufferTime:this.options.get("maxBufferTime"),minBufferTime:this.options.get("minBufferTime")}),incomingData:Nu.create(this.emitter),adaptivity:cn.create(this.emitter,this.logger.createContext("AdaptivityModule"),m,{cooldownTime:Math.max(this.options.get("minBufferTime"),2e3)}),constraintCap:Lu.create(this.emitter,this.element,d,!!this.options.get("abrEnabled")&&this.options.get("sizeBasedResolutionCapEnabled")),event:Fu.create(this.emitter,this.logger.createContext("EventModule"),E),sync:E,documentState:f,connection:l,playback:p,pictureInPicture:h,timer:c,subscription:u,renditions:d,qualityOfService:m,mseModule:v,unpause:b,canvasModule:S},this.modules.adaptivity.isEnabled=this.options.get("abrEnabled"),this.emitter.on("page active",(t=>{var i;t&&"number"==typeof this.disconnectTimeout&&(this.modules.timer.clearInterval(this.disconnectTimeout),this.disconnectTimeout=void 0),t?this.playbackSource.isPaused||(this.logger.debug("Unsuspending"),this.unsuspend()):(this.logger.debug("Suspending"),this.suspend(),this.modules.decoder?this.options.get("iosBackgroundPlayEnabled")?(this.modules.decoder.unsuspend(),null==(i=this.modules.canvasModule)||i.unsuspend()):this.modules.connection.disconnect():(this.disconnectTimeout&&this.modules.timer.clearInterval(this.disconnectTimeout),this.disconnectTimeout=this.modules.timer.setInterval((()=>{const e="paused"===this.playbackState||this.muted;"connected"===this.connectionState&&e&&(this.emitter.emit("flush buffers"),this.modules.connection.disconnect("Page inactive timeout"))}),e.DISCONNECT_TIMEOUT)))})),this.emitter.on("context switch complete",(()=>{R||(R=window.setTimeout((()=>{window.clearTimeout(R),R=void 0,this.emit("context switch","completed"),this.emitLanguagesIfChanged()}),this.targetBufferTime))})),this.emitter.on("context switch started",(()=>this.emit("context switch","started"))),this.emitter.on("needs user input",(e=>this.emit("needs user input",e))),this.emitter.on("event",(e=>{switch(e.type){case"metadata":this.emit("metadata",e);break;case"channel switch":this.emit("channel switch",{channelId:e.channelId});break;case"language switch":this.emit("language switch",{language:e.language})}})),this.emitter.on("buffer state event",this.onBufferEvent),this.emitter.on("playback state",(e=>this.emit("playback state",e))),this.emitter.on("rendition level changed",(({to:e})=>{e&&this.emit("rendition level",e)})),this.emitter.on("connection state",(e=>{this.emit("connection state",e)})),this.emitter.on("recovered from media error",(()=>{this.modules.adaptivity.reset(2*this.targetBufferTime)})),this.emitter.once("connect info",(e=>{var t,i,s;const n=(null!=(i=null==(t=e.telemetry)?void 0:t.probability)?i:1)>=Math.random();e.telemetry&&(null==(s=this.modules.telemetry)||s.unload(),this.modules.telemetry=lm.create(this.logger.createContext("TelemetryModule"),this.emitter,A(g({},e.telemetry),{enabled:this.options.get("telemetryEnabled")&&n}),this),this.modules.telemetry.load())})),this.emitter.on("adapt level",(e=>{var t,i,s,n,r;this.logger.debug("adapt level",{direction:e});const o=this.modules.renditions.getRenditionLevels(),a=this.modules.renditions.getRenditionLevel(),h=o.findIndex((e=>e===a)),c=o.length-1;let l=h;switch(e){case"upgrade":{const e=Math.min(h+1,c),a=o[e],u=null!=(t=this.modules.connection.estimatedBandwidth)?t:st(),d=(null!=(s=null==(i=null==a?void 0:a.audio)?void 0:i.bitRate)?s:0)+(null!=(r=null==(n=null==a?void 0:a.video)?void 0:n.bitRate)?r:0);a&&2*u>d&&this.modules.adaptivity.isQoSOk(a)&&(l=e)}break;case"downgrade":l=Math.max(h-1,0);break;case"double downgrade":l=Math.max(h-2,0);break;case"reconnect":if(0===h||this.modules.qualityOfService.timeSpentBufferingLast(6e3)>5e3){if(!this.modules.connection.lastConnectionTime||Date.now()-this.modules.connection.lastConnectionTime<this.modules.qualityOfService.fatalQosGraceTime()||"connected"!==this.modules.connection.getState())return;return this.modules.qualityOfService.incrementFatalQosCount(),this.logger.info("Reconnecting due to poor qos"),this.modules.connection.reconnect("Fatal QOS"),void this.emitter.emit("adapted level")}l=0}if(l===h)return;const u=o[l];this.alignSizeAndBitRate(A(g({},this.targetSubscription),{video:g(g({},this.targetSubscription.video),null==u?void 0:u.video),audio:g(g({},this.targetSubscription.audio),null==u?void 0:u.audio)})),this.emitter.emit("adapted level")})),this.emitter.on("text track data",(e=>{const t=M(this,fm).find((t=>t.language===e.language)),i=this.modules.sync.getTimeshiftOffset()/1e3,s=i-M(this,pm);if(U(this,pm,i),t){if(t.cues)for(const e of t.cues)e.startTime-=s,e.endTime-=s;for(const s of e.cues){const e=new VTTCue(s.startTime-i,s.endTime-i,s.text);t.addCue(e)}}})),this.emitter.on("received signal",(e=>{var t;const i=e,s=this.modules.subscription.getCurrentSubscription();switch(this.logger.debug("received",g({},i)),i.type){case"client ip":this.clientIp=i.ip;break;case"renditions":this.updateTextTracks(i.renditions),U(this,gm,this.filterRenditions(i.renditions).then((e=>{this.emitter.emit("renditions",{renditions:e,channelId:this.currentSubscription.channelId}),this.emit("rendition levels",this.modules.renditions.getRenditionLevels()),this.emitLanguagesIfChanged()})).finally((()=>{U(this,gm,void 0)})));break;case"subscription changed":try{(e=>{if("object"!=typeof e||null===e)throw new Error("not an object");if(!("video"in e))throw new Error("missing video in subscription");if(!("audio"in e))throw new Error("missing audio in subscription");if(!("channelId"in e))throw new Error("missing channelId")})(i.subscription)}catch(e){this.emitter.emit("error",new at("Subscription failed validation",{source:e instanceof Error?e:void 0,isFatal:!1,code:"subscription_failed_validation"}))}this.emitter.emit("subscription changed",{reset:i.reset,to:i.subscription,from:this.modules.subscription.getCurrentSubscription()}),i.reset&&s.channelId!==i.subscription.channelId&&(this.emit("error",At(i.subscription.channelId)),this.emit("channel switch failed",{channelId:s.channelId})),this.modules.sync.timeshiftOnAudio=!(null!=(t=i.subscription.video)&&t.codec),this.modules.adaptivity.reset();break;case"timing info":this.modules.sync.updateChannelSyncInfo(i.timingInfo.channelId,i.timingInfo),this.emit("server wallclock time",i.timingInfo.wallclockTime)}})),this.emitter.on("channel switch timeout",(e=>{this.emit("error",At(e)),this.emit("channel switch failed",{channelId:this.currentSubscription.channelId})})),this.emitter.on("received data",(e=>{const t=this.modules.subscription.getCurrentSubscription(),i=(e=>{const t=new DataView(e,0),i=t.getUint8(0),s=t.getUint16(1),n=t.getUint8(3),r=t.getUint8(4),o=ue(new Uint8Array(e),5,12),a=t.getUint32(13),h=(e=>!!(16&e))(n)?t.getInt16(17):void 0;return{version:i,renditionId:r,flags:n,timestamp:o,timescale:a,payload:e.slice(s),compositionTimeOffset:h}})(e);t?D(A(g({},i),{channelId:t.channelId})):this.logger.warn("Received unwanted message",g({},i))})),this.emitter.on("received moq data",(e=>{var t,i,s;const n=e.payload.mediaType(),r=e.channelId,o=e.renditionId,a=this.modules.sync.processFragment(r,e.payload);if(e.switchInfo.channelId&&(e.switchInfo.drmTransition&&this.emitter.emit("error",wt("Switching between DRM and non-DRM channels is not supported",!0)),this.encryptedMediaExtensions.onChannelSwitch(),this.emit("rendition levels",this.modules.renditions.getRenditionLevels()),this.modules.event.addEvent({type:"channel switch",channelId:e.switchInfo.channelId,timestamp:a.baseMediaDecodeTime()/a.timescale()*1e3})),e.switchInfo.language&&this.modules.event.addEvent({type:"language switch",language:e.switchInfo.language,timestamp:a.baseMediaDecodeTime()/a.timescale()*1e3}),this.modules.incomingData.add(n,e.payload.rawBytes().byteLength),a.fragment().emsgs.forEach((e=>{if(!e.presentationTime)return;const t=function(e){const t=new fe(e),i=function(e){return{id:e.readBytes(3),majorVersion:e.readUint8(),minorVersion:e.readUint8(),flags:e.readUint8(),size:e.readUint32()}}(t);184549376&i.flags&&function(e){const t=e.readUint32();e.readBytes(t-4)}(t);const s=function(e){return{frameId:e.readBytes(4),size:e.readUint32(),flags:e.readUint16()}}(t);if("TXXX"===String.fromCharCode(...s.frameId))return{header:i,txx:di(new fe(t.readBytes(s.size)))}}(e.data);t&&this.modules.event.addEvent({id:e.id,timestamp:e.presentationTime/e.timescale*1e3-this.modules.sync.getTimeshiftOffset(),content:t.txx.value,type:"metadata"})})),this.modules.decoder){const e=null==(t=a.header().init().moov.traks[0])?void 0:t.mdia.minf.stbl.stsd,h=null==(i=null==e?void 0:e.avc1)?void 0:i.avcC.bytes,c=null!=(s=null==e?void 0:e.codec)?s:"h264";if(h){const e=h.buffer.slice(h.byteOffset,h.byteOffset+h.byteLength);if("text"===n)throw new Error("Subtitles are not supported");this.emitter.emit("init segment",{initSegment:{channelId:r,renditionId:o,data:e,timescale:1e3,type:n,codec:c},mimeType:n})}for(let e=0;e<a.samplesCount();e++){const t=a.sample(e);t&&this.emitter.emit("coded sample",A(g({},t),{renditionId:o,channelId:r,data:t.data.buffer.slice(t.data.byteOffset,t.data.byteOffset+t.data.byteLength)}))}}else this.emitter.emit("fragment",{mimeType:e.mimeType,codec:e.codec,fragment:a,channelId:r,renditionId:o})}));const P=this.options.get("container");P&&this.attach(P),this.logger.info("Created Vindral instance",{options:this.options});const D=e=>L(this,null,(function*(){const t=e.channelId;M(this,gm)&&(yield M(this,gm));const i=this.modules.renditions.getRendition(e.renditionId,t);if(!(4&e.flags))if(8&e.flags){const t=(new TextDecoder).decode(e.payload),i=this.modules.sync.getTimeshiftOffset();if(0!==e.renditionId){const e=(0,n.t)(t);if(e&&void 0!==e.language){const t=(new tn).parse(e.content||""),s=i/1e3,n=M(this,fm).find((t=>t.language===e.language)),r=s-M(this,pm);if(U(this,pm,s),n){if(n.cues)for(const e of n.cues)e.startTime-=r,e.endTime-=r;for(const e of t){const t=new VTTCue(e.startTime-s,e.endTime-s,e.text);n.addCue(t)}}}}else this.modules.event.addEvent({timestamp:e.timestamp/e.timescale*1e3-this.modules.sync.getTimeshiftOffset(),content:t,type:"metadata"})}else if(null!=i&&i.codec){const s=(0,n.e)(i.codec);if("text"===s)throw new Error("Subtitles are not supported");if(this.modules.incomingData.add(s,e.payload.byteLength),(e=>!!(2&e))(e.flags)){const n=A(g({type:s,data:e.payload,codec:i.codec},e),{channelId:t}),r=((e,t)=>{switch(e){case"h264":return Vs(t);case"av1":return(e=>{const t=Ns(e);if(t)return{width:t.maxFrameWidth,height:t.maxFrameHeight}})(t)}})(n.codec,n.payload);r&&this.sizes.set(n.renditionId,r);const o=it({codec:i.codec,codecString:i.codecString});this.emitter.emit("init segment",{initSegment:n,mimeType:o}),this.emit("initialized media")}else{const t=((e,t,i)=>{if(et(t))return g(A(g({},e),{type:"video",codec:t.codec,isSync:Qs(e.flags),data:e.payload,duration:0,width:t.width,height:t.height}),i);if("webvtt"===t.codec)throw new Error("WebVTT is not supported");return A(g({},e),{type:"audio",channels:t.channels,sampleRate:t.sampleRate,codec:t.codec,language:t.language,isSync:Qs(e.flags),data:e.payload,duration:0})})(e,i,this.sizes.get(e.renditionId));let n=this.sampleProcessingSesssions.get(s);if(n){const e=n(this.modules.sync.processSample(t),this.isSwitchingRenditionLevel&&"video"===t.type);let i=t;e.forEach((e=>{this.modules.event.extractEvent(e,i),this.emitter.emit("coded sample",e),i=e}))}else n=(e=>{let t=[e],i=0,s=0,n=!1;return(e,r=!1)=>{if(e.flags&&Qs(e.flags)&&r&&(n=!n),!(r&&t.length<6&&n)&&t.length>0){n=!1;let r=e;for(let e=t.length-1;e>0;e--){const i=t[e];if(!i||!r)break;i.timestamp>=r.timestamp?t.splice(e,1):r=i}const o=t.map(((n,r)=>((e,t)=>{var n,r,o;e.flags&&Qs(e.flags)&&(i=null!=(n=e.compositionTimeOffset)?n:0),e.timestamp+=i,e.compositionTimeOffset=(null!=(r=e.compositionTimeOffset)?r:0)-i;const a=e.timestamp/e.timescale,h=t.flags&&Qs(t.flags)?null!=(o=t.compositionTimeOffset)?o:0:i,c=(t.timestamp+h)/t.timescale,l=Math.max(0,Math.round((c-a)*e.timescale));return l>0&&(s=l),A(g({},e),{duration:l>0?l:s})})(n,t[r+1]||e)));return t=[e],o}return t.push(e),[]}})(this.modules.sync.processSample(t)),this.sampleProcessingSesssions.set(s,n)}}}));this.options.get("maxVideoBitRate")!==Number.MAX_SAFE_INTEGER&&(this.maxVideoBitRate=this.options.get("maxVideoBitRate")),this.options.get("maxAudioBitRate")!==Number.MAX_SAFE_INTEGER&&(this.maxAudioBitRate=this.options.get("maxAudioBitRate")),be(this.options.get("maxSize"),nt())||(this.maxSize=this.options.get("maxSize")),this.options.get("burstEnabled")&&u.enableBurst(this.targetBufferTime)}set volume(e){this.playbackSource.volume=e}get volume(){return this.playbackSource.volume}set muted(e){if(e===this.muted)return;const t=this.playbackSource.muted;this.playbackSource.muted=e,!e&&t&&!this.playbackSource.isPaused&&this.playbackSource.play()}get muted(){return this.playbackSource.muted}get media(){return this.options.get("media")}get videoBitRate(){return this.modules.incomingData.averageBitRate("video")}get audioBitRate(){return this.modules.incomingData.averageBitRate("audio")}get connectionState(){return this.modules.connection.getState()}get playbackState(){return this.modules.playback.getState()}get bufferFullness(){return this.modules.playback.getBufferFullness()}get sizeBasedResolutionCapEnabled(){return this.modules.constraintCap.sizeBasedResolutionCapEnabled}set sizeBasedResolutionCapEnabled(e){this.modules.constraintCap.sizeBasedResolutionCapEnabled=e}get abrEnabled(){return this.modules.adaptivity.isEnabled}set abrEnabled(e){this.modules.constraintCap.sizeBasedResolutionCapEnabled=!!e&&this.options.get("sizeBasedResolutionCapEnabled"),this.modules.adaptivity.isEnabled=e,this.alignSizeAndBitRate(this.targetSubscription)}get serverEdgeTime(){return this.modules.sync.getLiveEdgeTimeLatencyAdjusted(this.currentSubscription.channelId)}get serverWallclockTime(){return this.modules.sync.getWallclockTimeLatencyAdjusted(this.currentSubscription.channelId)}get currentTime(){return this.modules.sync.serverCurrentTime}get channelCurrentTime(){return this.modules.sync.channelCurrentTime}get targetBufferTime(){return this.modules.playback.getTargetBufferTime()}set targetBufferTime(e){this.modules.playback.getTargetBufferTime()!==e&&(this.modules.playback.setTargetBufferTime(e),this.playbackSource.currentTime=this.modules.sync.serverCurrentTime,this.options.get("burstEnabled",this.channelId)?this.modules.subscription.enableBurst(this.targetBufferTime):this.modules.subscription.enableBurst(0))}get playbackLatency(){var e;if(0!==this.playbackSource.currentTime)return this.targetBufferTime+(null!=(e=this.modules.sync.drift)?e:0)+this.modules.connection.rtt/2}get playbackWallclockTime(){if(this.serverWallclockTime&&this.playbackLatency)return this.serverWallclockTime-this.playbackLatency}get channels(){return this._channels}get languages(){return this.modules.renditions.getLanguages()}get language(){return this.modules.subscription.getTargetSubscription().audio.language}set language(e){this.modules.subscription.setLanguage(e)}set textTrack(e){M(this,fm).forEach((t=>{t.label===e?t.mode="showing":t.mode="hidden"})),this.emitter.emit("text track",e)}get textTracks(){return M(this,fm).filter((e=>"disabled"!==e.mode)).map((e=>e.label))}get textTrack(){var e;return null==(e=M(this,fm).find((e=>"showing"===e.mode)))?void 0:e.label}get channelId(){var e,t;return null!=(t=null==(e=this.modules)?void 0:e.subscription.getTargetSubscription().channelId)?t:this.options.get("channelId")}set channelId(e){if(e===this.channelId)return;this.modules.subscription.setChannelId(e);const t="audio"===this.options.get("media")?[]:this.options.get("videoCodecs"),i=this.modules.renditions.getAudioRenditions(e),s=this.modules.renditions.getVideoRenditions(e),n=this.targetSubscription.audio.language,r=null==i?void 0:i.some((e=>e.language===n)),o=t.find((e=>void 0!==(null==s?void 0:s.find((t=>t.codec===e)))));o&&this.modules.subscription.setVideoCodec(o),this.logger.debug("Channel switch - started",{audioRenditions:i,targetSubscriptionLanguage:n,targetHasCurrentLanguage:r}),this.alignSizeAndBitRate(this.targetSubscription)}get maxSize(){var e,t;const{width:i,height:s}=null!=(t=null==(e=this.modules.constraintCap.getCurrentConstraintCap())?void 0:e.video)?t:nt();return{width:i,height:s}}set maxSize(e){this.modules.constraintCap.setUserSpecifiedCap({video:{width:e.width,height:e.height}}),this.alignSizeAndBitRate(this.targetSubscription)}get maxVideoBitRate(){var e,t;return null!=(t=null==(e=this.modules.constraintCap.getCurrentConstraintCap())?void 0:e.video.bitRate)?t:st()}set maxVideoBitRate(e){this.modules.constraintCap.setUserSpecifiedCap({video:{bitRate:e}}),this.alignSizeAndBitRate(this.targetSubscription)}get maxAudioBitRate(){var e,t;return null!=(t=null==(e=this.modules.constraintCap.getCurrentConstraintCap())?void 0:e.audio.bitRate)?t:st()}set maxAudioBitRate(e){this.modules.constraintCap.setUserSpecifiedCap({audio:{bitRate:e}}),this.alignSizeAndBitRate(this.targetSubscription)}get renditionLevels(){return this.modules.renditions.getRenditionLevels()}get currentRenditionLevel(){return this.modules.renditions.getRenditionLevel()}get targetRenditionLevel(){return this.modules.renditions.getRenditionLevel(this.modules.subscription.getTargetSubscription())}get isSwitchingRenditionLevel(){return this.modules.subscription.isSwitchingSubscription()}get videoBufferedRanges(){var e,t,i,s;return null!=(s=null!=(i=null==(e=this.modules.mseModule)?void 0:e.getBuffer("video"))?i:null==(t=this.modules.decoder)?void 0:t.getBuffer("video"))?s:[]}get audioBufferedRanges(){var e,t,i,s;return null!=(s=null!=(i=null==(e=this.modules.mseModule)?void 0:e.getBuffer("audio"))?i:null==(t=this.modules.decoder)?void 0:t.getBuffer("audio"))?s:[]}getApiClient(){return this.modules.connection.apiClient}get lastBufferEvent(){return this.modules.playback.getLastBufferStateEvent()}get activeRatios(){return this.modules.qualityOfService.activeRatios()}get bufferingRatios(){return this.modules.qualityOfService.bufferingRatios()}get timeSpentBuffering(){return this.modules.qualityOfService.timeSpentBuffering()}get timeActive(){return this.modules.qualityOfService.timeActive()}get mediaElement(){return this.element}get audioNode(){var e;return null!=(e=this.modules)&&e.canvasModule?this.modules.canvasModule.audioNode:void 0}get drmStatistics(){var e;return null==(e=this.encryptedMediaExtensions)?void 0:e.getStatistics()}get uptime(){return Date.now()-this.createdAt}suspend(){this.isSuspended||(Object.values(this.modules).forEach((e=>{e&&"suspend"in e&&e.suspend()})),this.isSuspended=!0)}unsuspend(){this.isSuspended&&(Object.values(this.modules).forEach((e=>{e&&"unsuspend"in e&&e.unsuspend()})),this.isSuspended=!1)}alignSizeAndBitRate(e){const t=this.modules.constraintCap.constrainSubscription(A(g({},e),{video:g({},e.video),audio:g({},e.audio)})),i=this.modules.constraintCap.getUserSpecifiedCap();!this.abrEnabled&&i&&(t.audio.bitRate=i.audio.bitRate,t.video.bitRate=i.video.bitRate,t.video.width=i.video.width,t.video.height=i.video.height);const s=this.modules.renditions.getRenditionLevel(t);if(s)if(s.video&&(this.modules.subscription.setVideoBitRate(s.video.bitRate),this.modules.subscription.setSize(s.video)),s.audio)this.modules.subscription.setAudioBitRate(s.audio.bitRate),this.modules.subscription.setLanguage(s.audio.language);else if(t.audio.language){let e=this.modules.renditions.getAudioRenditions(t.channelId);!this.abrEnabled&&i&&(e=null==e?void 0:e.filter((e=>e.bitRate<i.audio.bitRate)));const s=t.audio.language,n=null==e?void 0:e.some((e=>e.language===s)),r=null==e?void 0:e.find((e=>e.language)),o=(null==e?void 0:e.length)&&e[0]||void 0;n||(r?(this.logger.debug("Randomizing language since target did not have current language"),this.modules.subscription.setAudioBitRate(r.bitRate),this.modules.subscription.setLanguage(r.language)):(this.logger.debug("Randomizing audio rendition since target did not have current language"),null!=o&&o.bitRate&&this.modules.subscription.setAudioBitRate(o.bitRate),this.modules.subscription.setLanguage(null==o?void 0:o.language)))}}get currentSubscription(){return this.modules.subscription.getCurrentSubscription()}get targetSubscription(){return this.modules.subscription.getTargetSubscription()}willUseMediaSource(){return this.browser.supportsMediaSource&&this.options.get("mseEnabled")}};pm=new WeakMap,fm=new WeakMap,gm=new WeakMap,I(Am,"MAX_POOL_SIZE",10),I(Am,"INITIAL_MAX_BIT_RATE",25e5),I(Am,"DISCONNECT_TIMEOUT",15e3),I(Am,"REMOVE_CUE_THRESHOLD",1e4);let wm=Am},9633:(e,t,i)=>{i.d(t,{E:()=>n});var s=Object.defineProperty;class n{constructor(){var e;((e,t,i)=>{t in e?s(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(this,"symbol"!=typeof(e="listeners")?e+"":e,{})}emit(e,t){const i=this.listeners[e];i&&(this.listeners[e]=i.filter((e=>!e.once)),i.map((e=>e.fn(t))).map((e=>"function"==typeof e&&(null==e?void 0:e()))))}off(e,t){const i=this.listeners[e];i&&(this.listeners[e]=i.filter((e=>e.fn!==t)))}on(e,t){this.add(e,t,!1)}once(e,t){this.add(e,t,!0)}reset(){this.listeners={}}add(e,t,i){const s=this.listeners[e],n={fn:t,once:i};s?s.push(n):this.listeners[e]=[n]}}},3989:(e,t,i)=>{i.d(t,{A:()=>T,a:()=>f,b:()=>w,c:()=>y,d:()=>b,e:()=>p,i:()=>A,p:()=>E,t:()=>g});var s=Object.defineProperty,n=Object.defineProperties,r=Object.getOwnPropertyDescriptors,o=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,h=Object.prototype.propertyIsEnumerable,c=(e,t,i)=>t in e?s(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,l=(e,t)=>{for(var i in t||(t={}))a.call(t,i)&&c(e,i,t[i]);if(o)for(var i of o(t))h.call(t,i)&&c(e,i,t[i]);return e},u=(e,t)=>n(e,r(t)),d=(e,t,i)=>c(e,"symbol"!=typeof t?t+"":t,i),m=(e,t,i)=>new Promise(((s,n)=>{var r=e=>{try{a(i.next(e))}catch(e){n(e)}},o=e=>{try{a(i.throw(e))}catch(e){n(e)}},a=e=>e.done?s(e.value):Promise.resolve(e.value).then(r,o);a((i=i.apply(e,t)).next())}));const p=e=>{switch(e){case"h264":case"av1":return"video";case"aac":case"opus":case"mp3":return"audio";case"webvtt":return"text";default:throw new Error("Unknown codec")}};function f(e,t){if(!e)throw new Error(t)}const g=e=>{try{return JSON.parse(e)}catch(e){return}};function A(e){return!("string"==typeof e.edges[0]||e.channels[0]&&!("catalog"in e.channels[0]))}function w(e){return e.tracks.filter((e=>!!e.codec)).filter((e=>y(e.codec||""))).map(((e,t)=>{const i=e.codec,s=e.bitrate;f(i,"codec is required"),f(null!=s,"bitrate is required");const n=y(i);if(f(n,"codec is required"),"audio"===p(n)){const r=e.samplerate||0;return{track:e,id:t,codec:n,codecString:i,bitRate:s,channels:"stereo"===e.channelConfig?2:1,sampleRate:r,language:e.language}}return"text"===p(n)?{track:e,id:t,bitRate:0,codec:n,kind:"subtitles",codecString:i,label:e.label,language:e.language}:(f(e.width,"width is required"),f(e.height,"width is required"),f(e.framerate,"framerate is required"),{track:e,id:t,codec:n,bitRate:s,codecString:i,width:e.width,height:e.height,frameRate:e.framerate})})).sort(((e,t)=>e.bitRate-t.bitRate))}function y(e){return e.startsWith("opus")?"opus":e.startsWith("mp4a")?"aac":e.startsWith("avc1")?"h264":e.startsWith("av01")?"av1":e.startsWith("webvtt")?"webvtt":void 0}class v extends Error{constructor({status:e,url:t,body:i}){const s=g(i);var n;super("object"==typeof(n=s)&&null!==n&&"message"in n?s.message:`Url ${t.toString()}, Status code: ${e}, Body: ${i}`),d(this,"status"),d(this,"body"),d(this,"url"),this.status=e,this.body=i,this.url=t,Object.setPrototypeOf(this,new.target.prototype)}}const b=e=>"number"==typeof e.status,S=(e,t)=>m(void 0,null,(function*(){const i=yield fetch(e.toString(),l({mode:"cors"},t));if(!i.ok)throw new v({status:i.status,url:e,body:yield i.text()});return i})),k=(e,t)=>m(void 0,null,(function*(){return yield(yield S(e,l({},t))).json()})),E=(e,t)=>m(void 0,null,(function*(){return S(e,l({method:"POST"},t))}));class T{constructor(e){d(this,"baseUrl"),d(this,"tokenFactory"),this.baseUrl=new URL("/api/v4/",e.publicEndpoint).toString(),this.tokenFactory=e.tokenFactory}connect(e){return m(this,null,(function*(){const{channelId:t,channelGroupId:i}=e,s={channelId:t,channelGroupId:i},n=new URL((a=e).channelGroupId?`connect?channelId=${a.channelId}&channelGroupId=${a.channelGroupId}`:`connect?channelId=${a.channelId}`,this.baseUrl),r=this.getAuthToken(s),o=yield k(n,{headers:this.getHeaders(r)});var a;if(function(e){var t;return!("string"==typeof e.edges[0]||e.channels[0]&&"catalog"in e.channels[0]&&void 0===(null==(t=e.channels[0])?void 0:t.catalog))}(o)){const e=o.channels.map((e=>{const t=this.toChannel(e,s),i=w(e.catalog);return u(l(l({},e),t),{renditions:i})}));return u(l({},o),{channels:e})}{const e=o.channels.map((e=>{const t=this.toChannel(e,s);return l(l({},e),t)}));return u(l({},o),{channels:e})}}))}getChannel(e){return m(this,null,(function*(){const t={channelId:e},i=new URL(`channel/${e}`,this.baseUrl),s=this.getAuthToken(t),n=yield k(i,{headers:this.getHeaders(s)});return this.toChannel(n,t,s)}))}getChannels(e){return m(this,null,(function*(){const t={channelGroupId:e},i=new URL(`channels/${e}`,this.baseUrl),s=this.getAuthToken(t),n=yield k(i,{headers:this.getHeaders(s)}),r=Array.isArray(n)?n:n.channels;return this.toChannels(r,t,s)}))}getHeaders(e){var t,i;return null!=(t=(i=e)?{Authorization:`Bearer ${i}`}:void 0)?t:{}}getAuthToken(e){return this.tokenFactory?this.tokenFactory(e):void 0}toChannels(e,t,i){return e.map((e=>this.toChannel(e,t,i)))}toChannel(e,t,i){const{baseUrl:s,sizes:n}=e.thumbnail,r=s||new URL(((e,t)=>t?e.channelGroupId?`thumbnail/?channelGroupId=${e.channelGroupId}&auth.token=${t}&auth.type=jwt`:e.channelId?`thumbnail/?channelId=${e.channelId}&auth.token=${t}&auth.type=jwt`:"thumbnail":"thumbnail")(t,i),this.baseUrl),o=n.map((s=>new URL(`?channelId=${e.channelId}&width=${s.width}&height=${s.height}${I(t,i)}`,r).toString()));return{channelId:e.channelId,name:e.name,isLive:e.isLive,thumbnailUrls:o}}}const I=(e,t)=>t?e.channelGroupId?`&channelGroupId=${e.channelGroupId}&auth.token=${t}&auth.type=jwt`:`&auth.token=${t}&auth.type=jwt`:""}},s={};function n(e){var t=s[e];if(void 0!==t)return t.exports;var r=s[e]={exports:{}};return i[e](r,r.exports,n),r.exports}n.m=i,n.d=(e,t)=>{for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},n.f={},n.e=e=>Promise.all(Object.keys(n.f).reduce(((t,i)=>(n.f[i](e,t),t)),[])),n.u=e=>e+"."+{597:"da4f3a832e118a71f92b",790:"d8a3e207eab581e130d5"}[e]+".bundle.js",n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},t="vindral-examples:",n.l=(i,s,r,o)=>{if(e[i])e[i].push(s);else{var a,h;if(void 0!==r)for(var c=document.getElementsByTagName("script"),l=0;l<c.length;l++){var u=c[l];if(u.getAttribute("src")==i||u.getAttribute("data-webpack")==t+r){a=u;break}}a||(h=!0,(a=document.createElement("script")).charset="utf-8",a.timeout=120,n.nc&&a.setAttribute("nonce",n.nc),a.setAttribute("data-webpack",t+r),a.src=i),e[i]=[s];var d=(t,s)=>{a.onerror=a.onload=null,clearTimeout(m);var n=e[i];if(delete e[i],a.parentNode&&a.parentNode.removeChild(a),n&&n.forEach((e=>e(s))),t)return t(s)},m=setTimeout(d.bind(null,void 0,{type:"timeout",target:a}),12e4);a.onerror=d.bind(null,a.onerror),a.onload=d.bind(null,a.onload),h&&document.head.appendChild(a)}},n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;n.g.importScripts&&(e=n.g.location+"");var t=n.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var i=t.getElementsByTagName("script");if(i.length)for(var s=i.length-1;s>-1&&(!e||!/^http(s?):/.test(e));)e=i[s--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),n.p=e})(),(()=>{var e={714:0};n.f.j=(t,i)=>{var s=n.o(e,t)?e[t]:void 0;if(0!==s)if(s)i.push(s[2]);else{var r=new Promise(((i,n)=>s=e[t]=[i,n]));i.push(s[2]=r);var o=n.p+n.u(t),a=new Error;n.l(o,(i=>{if(n.o(e,t)&&(0!==(s=e[t])&&(e[t]=void 0),s)){var r=i&&("load"===i.type?"missing":i.type),o=i&&i.target&&i.target.src;a.message="Loading chunk "+t+" failed.\n("+r+": "+o+")",a.name="ChunkLoadError",a.type=r,a.request=o,s[1](a)}}),"chunk-"+t,t)}};var t=(t,i)=>{var s,r,[o,a,h]=i,c=0;if(o.some((t=>0!==e[t]))){for(s in a)n.o(a,s)&&(n.m[s]=a[s]);h&&h(n)}for(t&&t(i);c<o.length;c++)r=o[c],n.o(e,r)&&e[r]&&e[r][0](),e[r]=0},i=self.webpackChunkvindral_examples=self.webpackChunkvindral_examples||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))})();var r=n(2725);const o=document.querySelector("#activate-audio-button"),a=document.querySelector("#playback-state");o.style.display="none";const h=new r.V({url:"https://lb.cdn.vindral.com",channelId:"vindral_demo1_ci_099ee1fa-80f3-455e-aa23-3d184e93e04f",media:"audio"});h.on("error",(e=>{e.isFatal()&&console.log("fatal error: ",e.message)})),h.on("playback state",(e=>a.textContent=e)),h.on("metadata",(e=>console.log("metadata: ",e.content))),h.on("needs user input",(()=>o.style.display="block")),h.play(),o.addEventListener("click",(()=>{o.style.display="none",h.play()}))})();