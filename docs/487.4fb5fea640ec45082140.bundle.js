"use strict";(self.webpackChunkvindral_examples=self.webpackChunkvindral_examples||[]).push([[487],{4487:(t,e,i)=>{i.r(e),i.d(e,{CatalogObserver:()=>pc,MoqConnectionAdapter:()=>cc});var n,r,s,a,o,c,l,u,h,d,p=i(4903),f=i(119),y=Object.create,w=Object.defineProperty,b=Object.defineProperties,m=Object.getOwnPropertyDescriptor,g=Object.getOwnPropertyDescriptors,v=Object.getOwnPropertySymbols,k=Object.prototype.hasOwnProperty,I=Object.prototype.propertyIsEnumerable,S=(t,e)=>(e=Symbol[t])?e:Symbol.for("Symbol."+t),M=t=>{throw TypeError(t)},W=(t,e,i)=>e in t?w(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,T=(t,e)=>{for(var i in e||(e={}))k.call(e,i)&&W(t,i,e[i]);if(v)for(var i of v(e))I.call(e,i)&&W(t,i,e[i]);return t},U=(t,e)=>b(t,g(e)),E=(t,e)=>w(t,"name",{value:e,configurable:!0}),D=t=>{var e;return[,,,y(null!=(e=null==t?void 0:t[S("metadata")])?e:null)]},V=["class","method","getter","setter","accessor","field","value","get","set"],x=t=>void 0!==t&&"function"!=typeof t?M("Function expected"):t,O=(t,e,i,n,r)=>({kind:V[t],name:e,metadata:n,addInitializer:t=>i._?M("Already initialized"):r.push(x(t||null))}),A=(t,e)=>W(e,S("metadata"),t[3]),B=(t,e,i,n)=>{for(var r=0,s=t[e>>1],a=s&&s.length;r<a;r++)1&e?s[r].call(i):n=s[r].call(i,n);return n},P=(t,e,i,n,r,s)=>{var a,o,c,l,u,h=7&e,d=!!(8&e),p=!!(16&e),f=h>3?t.length+1:h?d?1:2:0,y=V[h+5],b=h>3&&(t[f-1]=[]),g=t[f]||(t[f]=[]),v=h&&(!p&&!d&&(r=r.prototype),h<5&&(h>3||!p)&&m(h<4?r:{get[i](){return _(this,s)},set[i](t){return N(this,s,t)}},i));h?p&&h<4&&E(s,(h>2?"set ":h>1?"get ":"")+i):E(r,i);for(var k=n.length-1;k>=0;k--)l=O(h,i,c={},t[3],g),h&&(l.static=d,l.private=p,u=l.access={has:p?t=>L(r,t):t=>i in t},3^h&&(u.get=p?t=>(1^h?_:G)(t,r,4^h?s:v.get):t=>t[i]),h>2&&(u.set=p?(t,e)=>N(t,r,e,4^h?s:v.set):(t,e)=>t[i]=e)),o=(0,n[k])(h?h<4?p?s:v[y]:h>4?void 0:{get:v.get,set:v.set}:r,l),c._=1,4^h||void 0===o?x(o)&&(h>4?b.unshift(o):h?p?s=o:v[y]=o:r=o):"object"!=typeof o||null===o?M("Object expected"):(x(a=o.get)&&(v.get=a),x(a=o.set)&&(v.set=a),x(a=o.init)&&b.unshift(a));return h||A(t,r),v&&w(r,i,v),p?4^h?s:v:r},j=(t,e,i)=>W(t,"symbol"!=typeof e?e+"":e,i),C=(t,e,i)=>e.has(t)||M("Cannot "+i),L=(t,e)=>Object(e)!==e?M('Cannot use the "in" operator on this value'):t.has(e),_=(t,e,i)=>(C(t,e,"read from private field"),i?i.call(t):e.get(t)),R=(t,e,i)=>e.has(t)?M("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),N=(t,e,i,n)=>(C(t,e,"write to private field"),n?n.call(t,i):e.set(t,i),i),G=(t,e,i)=>(C(t,e,"access private method"),i),F=(t,e,i,n)=>({set _(n){N(t,e,n,i)},get _(){return _(t,e,n)}}),z=(t,e,i)=>new Promise(((n,r)=>{var s=t=>{try{o(i.next(t))}catch(t){r(t)}},a=t=>{try{o(i.throw(t))}catch(t){r(t)}},o=t=>t.done?n(t.value):Promise.resolve(t.value).then(s,a);o((i=i.apply(t,e)).next())})),q=function(t,e){this[0]=t,this[1]=e},H=(t,e,i)=>{var n=(t,e,r,s)=>{try{var a=i[t](e),o=(e=a.value)instanceof q,c=a.done;Promise.resolve(o?e[0]:e).then((i=>o?n("return"===t?t:"next",e[1]?{done:i.done,value:i.value}:i,r,s):r({value:i,done:c}))).catch((t=>n("throw",t,r,s)))}catch(t){s(t)}},r=t=>s[t]=e=>new Promise(((i,r)=>n(t,e,i,r))),s={};return i=i.apply(t,e),s[S("asyncIterator")]=()=>s,r("next"),r("throw"),r("return"),s},$=t=>{var e,i=t[S("asyncIterator")],n=!1,r={};return null==i?(i=t[S("iterator")](),e=t=>r[t]=e=>i[t](e)):(i=i.call(t),e=t=>r[t]=e=>{if(n){if(n=!1,"throw"===t)throw e;return e}return n=!0,{done:!1,value:new q(new Promise((n=>{var r=i[t](e);r instanceof Object||M("Object expected"),n(r)})),1)}}),r[S("iterator")]=()=>r,e("next"),"throw"in i?e("throw"):r.throw=t=>{throw t},"return"in i&&e("return"),r},Z=(t,e,i)=>(e=t[S("asyncIterator")])?e.call(t):(t=t[S("iterator")](),e={},(i=(i,n)=>(n=t[i])&&(e[i]=e=>new Promise(((i,r,s)=>(e=n.call(t,e),s=e.done,Promise.resolve(e.value).then((t=>i({value:t,done:s})),r))))))("next"),i("return"),e),X=(t,e,i)=>{var n;return null!=e?("object"!=typeof e&&"function"!=typeof e&&M("Object expected"),i&&(n=e[S("asyncDispose")]),void 0===n&&(n=e[S("dispose")]),"function"!=typeof n&&M("Object not disposable"),t.push([i,n,e])):i&&t.push([i]),e},Y=(t,e,i)=>{var n="function"==typeof SuppressedError?SuppressedError:function(t,e,i,n){return(n=Error(i)).name="SuppressedError",n.error=t,n.suppressed=e,n},r=t=>e=i?new n(t,e,"An error was suppressed during disposal"):(i=!0,t),s=n=>{for(;n=t.pop();)try{var a=n[1]&&n[1].call(n[2]);if(n[0])return Promise.resolve(a).then(s,(t=>(r(t),s())))}catch(t){r(t)}if(i)throw e};return s()};function J(t){const e=new K(t);return[e,e]}class K{constructor(t){R(this,n),R(this,r,new p.D),R(this,s),R(this,a,!1),N(this,n,new p.F(t))}isFull(){return _(this,n).isFull()}close(){var t;null==(t=_(this,s))||t.resolve(),N(this,a,!0)}abort(t){var e,i;null==(e=_(this,s))||e.promise.catch(p.n),null==(i=_(this,s))||i.reject(t)}push(t){return z(this,null,(function*(){var e;_(this,n).isFull()&&(yield _(this,r).promise),_(this,n).push(t),null==(e=_(this,s))||e.resolve(),N(this,s,new p.D)}))}pop(){return z(this,null,(function*(){for(var t;!_(this,a)||!_(this,n).isEmpty();){const e=_(this,n).pop();if(e)return _(this,r).resolve(),N(this,r,new p.D),e;_(this,s)||N(this,s,new p.D),yield null==(t=_(this,s))?void 0:t.promise}}))}start(t){}pull(t){return z(this,null,(function*(){const e=yield this.pop();e?t.enqueue(e):t.close()}))}cancel(t){this.abort(new Error(t))}next(){return z(this,null,(function*(){const t=yield this.pop().catch((()=>{}));return t?{done:!1,value:t}:{done:!0,value:void 0}}))}return(){return this.close(),Promise.resolve({done:!0,value:void 0})}[Symbol.asyncIterator](){return this}}function Q(t){const e=atob(t),i=new Uint8Array(e.length);for(let t=0;t<e.length;t++)i[t]=e.charCodeAt(t);return i.buffer}function tt(t){return"function"==typeof BigInt?BigInt(t):t}function et(){return"symbol"!=typeof Symbol.asyncDispose&&Object.defineProperty(Symbol,"asyncDispose",{value:Symbol.for("asyncDispose")}),Symbol.asyncDispose}function it(){return"symbol"!=typeof Symbol.dispose&&Object.defineProperty(Symbol,"dispose",{value:Symbol.for("dispose")}),Symbol.dispose}n=new WeakMap,r=new WeakMap,s=new WeakMap,a=new WeakMap;class nt{constructor(t,e){R(this,o),j(this,"value"),j(this,"unlocker"),this.value=t,this.unlocker=e}unlocked(){var t;return null==(t=this.unlocker)?void 0:t.promise}[it()](){G(this,o,c).call(this)}[Symbol.dispose](){G(this,o,c).call(this)}}o=new WeakSet,c=function(){this.unlocker.resolve(this.value)};class rt{constructor(t){R(this,l),R(this,u,new p.D),N(this,l,t),_(this,u).resolve(t)}unsafeValue(){return _(this,l)}isLocked(){return _(this,u).pending}lock(){return z(this,null,(function*(){const t=new p.D;t.promise.then((t=>{N(this,l,t)})).catch(p.n);const e=_(this,u).promise.then((()=>t));return N(this,u,t),yield e,new nt(_(this,l),t)}))}}l=new WeakMap,u=new WeakMap;class st{constructor(t){R(this,h),R(this,d),N(this,h,t),N(this,d,new p.D)}isClosed(){var t;return!(null!=(t=_(this,d))&&t.pending)}current(){return _(this,h)}value(){var t;return[_(this,h),null==(t=_(this,d))?void 0:t.promise]}update(t){var e;if(null==(e=_(this,d))||!e.pending)throw new Error("ObservableValue is closed");N(this,h,t instanceof Function?t(_(this,h)):t),_(this,d).resolve(_(this,h)),N(this,d,new p.D)}close(){var t;null==(t=_(this,d))||t.resolve(_(this,h)),N(this,d,void 0)}waitFor(t){return z(this,null,(function*(){if(t(_(this,h)))return _(this,h);for(;;){const[e,i]=this.value();if(!i)throw new Error("ObservableValue was closed while waiting for condition");const n=yield i;if(t(n))return n}}))}[Symbol.asyncIterator](){return H(this,null,(function*(){for(;;){const[t,e]=this.value();if(yield t,!e)return;yield new q(e)}}))}}function at(t){try{return t()}catch(t){return t}}function ot(t){let e=t.readUint32();const i=[t.readUint8(),t.readUint8(),t.readUint8(),t.readUint8()],n=String.fromCharCode.apply(null,i);return 1===e&&(e=t.readUint64()-8),{size:e-8,type:n}}function ct(t){return{version:t.readUint8(),flags:t.readUint24()}}h=new WeakMap,d=new WeakMap;const lt=class t{constructor({timescale:e,presentationTime:i,presentationTimeDelta:n,schemeIdUri:r,value:s,eventDuration:a,id:o,data:c}){j(this,"type",t.type),j(this,"timescale"),j(this,"presentationTime"),j(this,"presentationTimeDelta"),j(this,"schemeIdUri"),j(this,"value"),j(this,"eventDuration"),j(this,"id"),j(this,"data"),this.timescale=e,this.presentationTime=i,this.presentationTimeDelta=n,this.schemeIdUri=r,this.value=s,this.eventDuration=a,this.id=o,this.data=c}static decodeData(e){const{version:i}=ct(e);switch(i){case 1:{const i=e.readUint32(),n=e.readUint64(),r=e.readUint32(),s=e.readUint32(),a=e.readUtf8String(),o=e.readUtf8String(),c=e.remaining(),l=e.readBytes(c);return new t({timescale:i,presentationTime:n,eventDuration:r,id:s,schemeIdUri:a,value:o,data:l})}case 0:{const i=e.readUtf8String(),n=e.readUtf8String(),r=e.readUint32(),s=e.readUint32(),a=e.readUint32(),o=e.readUint32(),c=e.remaining(),l=e.readBytes(c);return new t({timescale:r,presentationTimeDelta:s,schemeIdUri:i,value:n,eventDuration:a,id:o,data:l})}default:throw new Error(`unsupported version ${i}`)}}};j(lt,"type","emsg");let ut=lt;const ht=class t{constructor(e){j(this,"type",t.type),j(this,"data"),this.data=e}static decodeData(e){const i=e.readRemaining();return new t(i)}};j(ht,"type","mdat");let dt=ht;const pt=class t{constructor(e,i,n){j(this,"type",t.type),j(this,"extra"),j(this,"byteOffset"),j(this,"baseMediaDecodeTime"),this.extra=e,this.byteOffset=i,this.baseMediaDecodeTime=n}static decodeData(e){const i=ct(e),n=e.byteOffset();let r=0;return r=1===i.version?e.readUint64():e.readUint32(),new t(i,n,r)}};j(pt,"type","tfdt");let ft=pt;const yt=class t{constructor(e,i,n){j(this,"type",t.type),j(this,"dataOffset"),j(this,"firstSampleFlags"),j(this,"samplesCount"),j(this,"sampleDurations",[]),j(this,"sampleSizes",[]),j(this,"sampleFlags",[]),j(this,"sampleCts",[]),this.dataOffset=i,this.firstSampleFlags=n,this.samplesCount=e}is_sync_sample(e){const i=t.FLAG_SAMPLE_FLAG_IS_NON_SYNC|t.FLAG_SAMPLE_DEPENDS_YES,n=this.sampleFlags[e];return void 0!==n?!(n&i):0===e&&this.firstSampleFlags?!(this.firstSampleFlags&i):void 0}static decodeData(e){const{flags:i}=ct(e),n=e.readUint32();let r,s;i&t.TRUN_DATA_OFFSET&&(r=e.readUint32()),i&t.TRUN_FIRST_SAMPLE_FLAGS&&(s=e.readUint32());const a=new t(n,r,s);for(let r=0;r<n;r++)i&t.SAMPLE_DURATION&&a.sampleDurations.push(e.readUint32()),i&t.SAMPLE_SIZE&&a.sampleSizes.push(e.readUint32()),i&t.SAMPLE_FLAGS&&a.sampleFlags.push(e.readUint32()),i&t.SAMPLE_CTS&&a.sampleCts.push(e.readUint32());return a}};j(yt,"TRUN_DATA_OFFSET",1),j(yt,"TRUN_FIRST_SAMPLE_FLAGS",4),j(yt,"SAMPLE_DURATION",256),j(yt,"SAMPLE_SIZE",512),j(yt,"SAMPLE_FLAGS",1024),j(yt,"SAMPLE_CTS",2048),j(yt,"FLAG_SAMPLE_FLAG_IS_NON_SYNC",65536),j(yt,"FLAG_SAMPLE_DEPENDS_NO",33554432),j(yt,"FLAG_SAMPLE_DEPENDS_YES",16777216),j(yt,"type","trun");let wt=yt;const bt=class t{constructor(e,i){j(this,"type",t.type),j(this,"tfdt"),j(this,"trun"),this.tfdt=e,this.trun=i}static decodeData(e){let i,n;for(;e.remaining()>0;){const t=ee(e);t instanceof ft&&(i=t),t instanceof wt&&(n=t)}return new t(i,n)}};j(bt,"type","traf");let mt=bt;const gt=class t{constructor(e){j(this,"type",t.type),j(this,"traf"),this.traf=e}static decodeData(e){let i;for(;e.remaining()>0;){const t=ee(e);t instanceof mt&&(i=t)}if(!i)throw new Error("No traf found");return new t(i)}};j(gt,"type","moof");let vt=gt;const kt=class t{constructor(){j(this,"type",t.type)}static decodeData(e){return new t}};j(kt,"type","mvhd");let It=kt;const St=class t{constructor(e){j(this,"type",t.type),j(this,"fourCC"),this.fourCC=e}mediaType(){switch(this.fourCC){case"vide":return"video";case"soun":return"audio";case"sbtl":return"text";default:throw new Error("Unknown media type")}}static decodeData(e){ct(e),e.readUint32();const i=String.fromCharCode(...e.readBytes(4));return new t(i)}};j(St,"type","hdlr");let Mt=St;const Wt=class t{constructor(e,i,n,r){j(this,"type",t.type),j(this,"creationTime"),j(this,"modificationTime"),j(this,"timescale"),j(this,"duration"),this.creationTime=e,this.modificationTime=i,this.timescale=n,this.duration=r}static decodeData(e){const{version:i}=ct(e);if(1===i){const i=e.readUint64(),n=e.readUint64(),r=e.readUint32(),s=e.readUint64();return new t(i,n,r,s)}const n=e.readUint32(),r=e.readUint32(),s=e.readUint32(),a=e.readUint32();return new t(n,r,s,a)}};j(Wt,"type","mdhd");let Tt=Wt;const Ut=class t{constructor(e,i,n,r){j(this,"type",t.type),j(this,"av01"),j(this,"avc1"),j(this,"opus"),j(this,"codec"),this.avc1=e,this.av01=i,this.opus=n,this.codec=r}mediaType(){return this.avc1||this.av01?"video":"audio"}width(){var t;return null==(t=this.avc1)?void 0:t.width}height(){var t;return null==(t=this.avc1)?void 0:t.height}static decodeData(e){ct(e);const i=e.readUint32();let n,r,s,a;for(let t=0;t<i;t++)for(;e.remaining()>0;){const t=ee(e);switch(t.type){case"avc1":n="h264",r=t;break;case"av01":n="av1",a=t;break;case"mp4a":n="aac";break;case"Opus":n="opus",s=t}}return new t(r,a,s,n)}};j(Ut,"type","stsd");let Et=Ut;const Dt=class t{constructor(e){j(this,"type",t.type),j(this,"stsd"),this.stsd=e}static decodeData(e){let i;for(;e.remaining()>0;){const t=ee(e);t instanceof Et&&(i=t)}if(!i)throw new Error("No stsd found");return new t(i)}};j(Dt,"type","stbl");let Vt=Dt;const xt=class t{constructor(e){j(this,"type",t.type),j(this,"stbl"),this.stbl=e}static decodeData(e){let i;for(;e.remaining()>0;){const t=ee(e);t instanceof Vt&&(i=t)}if(!i)throw new Error("No stbl found");return new t(i)}};j(xt,"type","minf");let Ot=xt;const At=class t{constructor(e,i,n){j(this,"type",t.type),j(this,"hdlr"),j(this,"minf"),j(this,"mdhd"),this.hdlr=e,this.minf=i,this.mdhd=n}static decodeData(e){let i,n,r;for(;e.remaining()>0;){const t=ee(e);t instanceof Mt&&(i=t),t instanceof Ot&&(n=t),t instanceof Tt&&(r=t)}if(!i)throw new Error("No hdlr found");if(!n)throw new Error("No minf found");if(!r)throw new Error("No mdhd found");return new t(i,n,r)}};j(At,"type","mdia");let Bt=At;const Pt=class t{constructor(e,i,n,r,s,a,o,c){j(this,"type",t.type),j(this,"modificationTime"),j(this,"creationTime"),j(this,"trackId"),j(this,"duration"),j(this,"alternateGroup"),j(this,"volume"),j(this,"width"),j(this,"height"),this.modificationTime=e,this.creationTime=i,this.trackId=n,this.duration=r,this.alternateGroup=s,this.volume=a,this.width=o,this.height=c}static decodeData(e){let i=0,n=0;1===ct(e).version?(i=e.readUint64(),n=e.readUint64()):(i=e.readUint32(),n=e.readUint32());const r=e.readUint32();e.readUint32();const s=e.readUint32();e.readUint32(),e.readUint32(),e.readUint16();const a=e.readUint16(),o=e.readUint16();e.readUint16(),new Array(9).fill(0).map((()=>e.readUint32()));const c=e.readUint16();e.readUint16();const l=e.readUint16();return e.readUint16(),new t(i,n,r,s,a,o,c,l)}};j(Pt,"type","tkhd");let jt=Pt;const Ct=class t{constructor(e,i){j(this,"type",t.type),j(this,"tkhd"),j(this,"mdia"),this.tkhd=e,this.mdia=i}static decodeData(e){let i,n;for(;e.remaining()>0;){const t=ee(e);t instanceof jt&&(i=t),t instanceof Bt&&(n=t)}if(!i)throw new Error("No tkhd found");if(!n)throw new Error("No mdia found");return new t(i,n)}};j(Ct,"type","trak");let Lt=Ct;const _t=class t{constructor(e,i){j(this,"type",t.type),j(this,"mvhd"),j(this,"traks"),this.mvhd=e,this.traks=i}static decodeData(e){let i;const n=[];for(;e.remaining()>0;){const t=ee(e);t instanceof Lt&&n.push(t),t instanceof It&&(i=t)}if(!i)throw new Error("No mvhd found");return new t(i,n)}};j(_t,"type","moov");let Rt=_t;const Nt=class t{constructor(e,i,n,r,s,a,o,c){j(this,"type",t.type),j(this,"configurationVersion"),j(this,"avcProfileIndication"),j(this,"profileCompatibility"),j(this,"avcLevelIndication"),j(this,"lengthSizeMinusOne"),j(this,"sequenceParameterSets"),j(this,"pictureParameterSets"),j(this,"bytes"),this.configurationVersion=e,this.avcProfileIndication=i,this.profileCompatibility=n,this.avcLevelIndication=r,this.lengthSizeMinusOne=s,this.sequenceParameterSets=a,this.pictureParameterSets=o,this.bytes=c}static decodeData(e){const i=e.buffer(),n=e.readUint8(),r=e.readUint8(),s=e.readUint8(),a=e.readUint8(),o=3&e.readUint8(),c=31&e.readUint8(),l=[];for(let t=0;t<c;t++){const t=e.readBytes(e.readUint16());l.push(t)}const u=e.readUint8(),h=[];for(let t=0;t<u;t++){const t=e.readBytes(e.readUint16());h.push(t)}return new t(n,r,s,a,o,l,h,i)}};j(Nt,"type","avcC");let Gt=Nt;const Ft=class t{constructor(e,i,n,r,s){j(this,"type",t.type),j(this,"avcC"),j(this,"width"),j(this,"height"),j(this,"horizontalResolution"),j(this,"verticalResolution"),this.avcC=e,this.width=i,this.height=n,this.horizontalResolution=r,this.verticalResolution=s}static decodeData(e){e.readUint32(),e.readUint16(),e.readUint16(),e.readUint32(),e.readUint64(),e.readUint32();const i=e.readUint16(),n=e.readUint16(),r=e.readUint32(),s=e.readUint32();let a;for(e.readUint32(),e.readUint16(),e.readBytes(32),e.readUint16(),e.readUint16();e.remaining()>0;){const t=ee(e);"avcC"===t.type&&(a=t)}if(!a)throw new Error("no avcC");return new t(a,i,n,r,s)}};j(Ft,"type","avc1");let zt=Ft;const qt=class t{constructor(){j(this,"type",t.type)}static decodeData(e){return new t}};j(qt,"type","dOps");let Ht=qt;const $t=class t{constructor(e,i,n){j(this,"type",t.type),j(this,"dops"),j(this,"channelCount"),j(this,"sampleRate"),this.dops=e,this.channelCount=i,this.sampleRate=n}static decodeData(e){e.readUint32(),e.readUint16(),e.readUint16();const i=e.readUint16();e.readUint16(),e.readUint32();const n=e.readUint16();e.readUint16(),e.readUint32();const r=e.readUint16();e.readUint16(),1===i&&(e.readUint64(),e.readUint64());const s=function(t,e){const i=ot(e),n=new p.B(e.readBytes(i.size));if(i.type!==t.type)throw new Error(`invalid error type: ${i.type}, expected ${t.type}`);const r=t.decodeData(n);return n.readRemaining(),r}(Ht,e);return new t(s,n,r)}};j($t,"type","Opus");let Zt=$t;const Xt=class t{constructor(e,i){j(this,"type",t.type),j(this,"ntpTimestamp"),j(this,"mediaTime"),this.ntpTimestamp=e,this.mediaTime=i}static decodeData(e){const{version:i}=ct(e);e.readUint32();const n=e.readUint32(),r=e.readUint32();if(1===i){const i=e.readUint64();return new t([n,r],i)}const s=e.readUint32();return new t([n,r],s)}};j(Xt,"type","prft");let Yt=Xt;var Jt,Kt;class Qt{constructor(t,e){R(this,Jt),R(this,Kt),N(this,Jt,t),N(this,Kt,e.readBytes(t.size))}data(){return _(this,Kt)}get type(){return _(this,Jt).type}}Jt=new WeakMap,Kt=new WeakMap;const te={moov:Rt,trak:Lt,tkhd:jt,mvhd:It,moof:vt,traf:mt,tfdt:ft,trun:wt,mdat:dt,mdia:Bt,hdlr:Mt,minf:Ot,stbl:Vt,mdhd:Tt,stsd:Et,prft:Yt,avc1:zt,avcC:Gt,Opus:Zt,emsg:ut};function ee(t){const e=ot(t),i=te[e.type],n=new p.B(t.readBytes(e.size));if(!i){const t=new Qt(e,n);return n.readRemaining(),t}const r=i.decodeData(n);return n.readRemaining(),r}var ie,ne,re,se,ae,oe;class ce{constructor(t){R(this,ie),R(this,ne),N(this,ie,t),N(this,ne,function(t){if(t.byteLength<8)throw new Error("Buffer too small");const e=new p.B(t),i=new Map;for(;e.remaining()>0;){const t=ee(e);i.set(t.type,t)}const n=i.get("ftyp"),r=i.get("moov");if(!n)throw new Error("ftyp atom not found");if(!(r&&r instanceof Rt))throw new Error("moov atom not found");return{ftyp:n,moov:r}}(t))}rawBytes(){return _(this,ie)}init(){return _(this,ne)}}ie=new WeakMap,ne=new WeakMap;class le{constructor(t,e){R(this,re),R(this,se),R(this,ae),N(this,re,e),N(this,se,t),N(this,ae,function(t){if(t.byteLength<8)throw new Error("Buffer too small");const e=new p.B(t),i=new Map,n=[];for(;e.remaining()>0;){const t=ee(e);t instanceof ut&&n.push(t),i.set(t.type,t)}const r=i.get("moof"),s=i.get("mdat"),a=i.get("prft");if(!(r&&r instanceof vt))throw new Error("moof atom not found");if(!(s&&s instanceof dt))throw new Error("mdat atom not found");if(a&&!(a instanceof Yt))throw new Error("invalid prft found");return{moof:r,mdat:s,prft:a,emsgs:n}}(e))}updateBaseMediaDecodeTime(t){const e=new DataView(_(this,re).buffer,_(this,re).byteOffset,_(this,re).byteLength);if(_(this,ae).moof.traf.tfdt)if(_(this,ae).moof.traf.tfdt.baseMediaDecodeTime=t,1===_(this,ae).moof.traf.tfdt.extra.version){const i=Math.floor(t/4294967296),n=(4294967295&t)>>>0;e.setUint32(_(this,ae).moof.traf.tfdt.byteOffset-_(this,re).byteOffset,i),e.setUint32(_(this,ae).moof.traf.tfdt.byteOffset-_(this,re).byteOffset+4,n)}else e.setUint32(_(this,ae).moof.traf.tfdt.byteOffset-_(this,re).byteOffset,t)}producerReferenceTime(){if(!_(this,ae).prft)return;const[t,e]=_(this,ae).prft.ntpTimestamp,i=1e3*t+e/2**32*1e3,n=new Date(Date.UTC(1900,0,1,0,0,0));return new Date(n.getTime()+i)}duration(){var t;return(null==(t=_(this,ae).moof.traf.trun)?void 0:t.sampleDurations.reduce(((t,e)=>t+e),0))||0}baseMediaDecodeTime(){var t;const e=null==(t=_(this,ae).moof.traf.tfdt)?void 0:t.baseMediaDecodeTime;if(!e)throw new Error("no baseMediaDecodeTime");return e}startsWithKeyframe(){const t=_(this,ae).moof.traf.trun,e=(null==t?void 0:t.firstSampleFlags)||(null==t?void 0:t.sampleFlags[0]);return!!e&&!!(e&wt.FLAG_SAMPLE_DEPENDS_NO)}timescale(){const t=_(this,se).init().moov.traks[0];if(!t)throw new Error("no tracks");return t.mdia.mdhd.timescale}mediaType(){var t;const e=null==(t=_(this,se).init().moov.traks[0])?void 0:t.mdia.hdlr.mediaType();if(!e)throw new Error("no media type");return e}header(){return _(this,se)}fragment(){return _(this,ae)}samplesCount(){var t;return(null==(t=_(this,ae).moof.traf.trun)?void 0:t.samplesCount)||0}sample(t){var e,i,n,r,s,a,o,c,l,u,h,d,p,f,y;const w=null==(e=_(this,se).init().moov.traks[0])?void 0:e.mdia.minf.stbl.stsd.codec,b=(null==(i=_(this,ae).moof.traf.trun)?void 0:i.samplesCount)||0,m=null==(n=_(this,ae).moof.traf.tfdt)?void 0:n.baseMediaDecodeTime;if(t>=b||void 0===m||!w)return;const g=(null==(r=_(this,ae).moof.traf.trun)?void 0:r.sampleDurations[t])||0,v=m+((null==(s=_(this,ae).moof.traf.trun)?void 0:s.sampleDurations.slice(0,t).reduce(((t,e)=>t+e),0))||0),k=(null==(a=_(this,se).init().moov.traks[0])?void 0:a.mdia.mdhd.timescale)||1e3,I=(null==(o=_(this,ae).moof.traf.trun)?void 0:o.sampleSizes[t])||_(this,ae).mdat.data.byteLength,S=(null==(c=_(this,ae).moof.traf.trun)?void 0:c.sampleSizes.slice(0,t).reduce(((t,e)=>t+e),0))||0,M=_(this,ae).mdat.data.subarray(S,S+I),W=(null==(l=_(this,ae).moof.traf.trun)?void 0:l.is_sync_sample(t))||!1;return"video"===this.mediaType()?{type:"video",codec:w,width:(null==(u=_(this,se).init().moov.traks[0])?void 0:u.tkhd.width)||0,height:(null==(h=_(this,se).init().moov.traks[0])?void 0:h.tkhd.height)||0,duration:g,isSync:W,timescale:k,timestamp:v,data:M}:{type:"audio",codec:w,channels:(null==(p=null==(d=_(this,se).init().moov.traks[0])?void 0:d.mdia.minf.stbl.stsd.opus)?void 0:p.channelCount)||0,sampleRate:(null==(y=null==(f=_(this,se).init().moov.traks[0])?void 0:f.mdia.minf.stbl.stsd.opus)?void 0:y.sampleRate)||0,duration:g,isSync:W,timestamp:v,data:M,timescale:k}}rawBytes(){return _(this,re)}}re=new WeakMap,se=new WeakMap,ae=new WeakMap;class ue{constructor(t){R(this,oe),N(this,oe,new ce(t))}header(){return _(this,oe)}createFragment(t){return new le(_(this,oe),t)}}oe=new WeakMap;var he=(t=>(t[t.StreamHeaderGroup=4]="StreamHeaderGroup",t[t.FetchHeader=5]="FetchHeader",t[t.StreamHeaderTrack=60]="StreamHeaderTrack",t))(he||{});function de(t){switch(t){case 0:case 1:case 2:case 3:case 4:return}throw new Error("Unknown object status "+t)}var pe,fe,ye,we,be,me,ge,ve,ke,Ie,Se,Me,We,Te,Ue,Ee,De,Ve,xe,Oe,Ae,Be,Pe,je,Ce,Le,_e,Re,Ne,Ge,Fe,ze,qe,He,$e,Ze,Xe,Ye,Je,Ke,Qe,ti,ei,ii,ni,ri,si,ai,oi;class ci{constructor(t,e,i,n,r,s){R(this,pe),R(this,fe),R(this,ye),R(this,we),R(this,be),R(this,me,new p.D),R(this,ge,0),R(this,ve),N(this,pe,t),N(this,fe,e),N(this,ye,i),N(this,we,n),N(this,be,r),N(this,ve,s)}endStatus(){return _(this,me).promise}groupId(){return _(this,fe)}subscribeId(){return _(this,ye)}next(){return z(this,null,(function*(){if(!_(this,me).pending)return{done:!0,value:void 0};if(yield _(this,pe).isDone())return{done:!0,value:void 0};const t=0===_(this,ge)?_(this,fe):yield _(this,pe).readBigVarInt(),e=yield _(this,pe).readBigVarInt(),i=yield _(this,pe).readVarInt();let n=0,r=new Uint8Array;return i>0?r=yield _(this,pe).read(i):n=yield _(this,pe).readVarInt(),de(n),(4===n||3===n)&&_(this,me).resolve(n),F(this,ge)._++,{done:!1,value:{subscribeId:_(this,ye),trackAlias:_(this,we),groupId:t,subGroupId:tt(0),objectId:e,subscriberPriority:_(this,be),streamId:_(this,ve),objectStatus:n,payload:r}}}))}return(){return z(this,null,(function*(){for(;!(yield this.next()).done;);return{done:!0,value:void 0}}))}[Symbol.asyncIterator](){return this}[et()](){return Promise.resolve()}[Symbol.asyncDispose](){return Promise.resolve()}}pe=new WeakMap,fe=new WeakMap,ye=new WeakMap,we=new WeakMap,be=new WeakMap,me=new WeakMap,ge=new WeakMap,ve=new WeakMap;class li{constructor(t,e,i,n,r){R(this,Te),R(this,ke),R(this,Ie),R(this,Se),R(this,Me),R(this,We),N(this,ke,t),N(this,Ie,e),N(this,Se,i),N(this,Me,n),N(this,We,r)}streamId(){return _(this,We)}groups(){return G(this,Te,Ue).call(this)}subscribeId(){return _(this,Ie)}return(){return z(this,null,(function*(){return yield _(this,ke).close(),{done:!0,value:void 0}}))}[Symbol.asyncIterator](){return this}[et()](){return G(this,Te,Ee).call(this)}[Symbol.asyncDispose](){return G(this,Te,Ee).call(this)}}ke=new WeakMap,Ie=new WeakMap,Se=new WeakMap,Me=new WeakMap,We=new WeakMap,Te=new WeakSet,Ue=function(){return H(this,null,(function*(){for(;!(yield new q(_(this,ke).isDone()));){const t=yield new q(_(this,ke).readBigVarInt()),e=new ci(_(this,ke),t,_(this,Ie),_(this,Se),_(this,Me),_(this,We));if(yield e,4===(yield new q(Promise.race([e.endStatus(),_(this,ke).closed()]))))return}}))},Ee=function(){return _(this,ke).close().catch((()=>{}))};class ui{constructor(t,e,i,n,r,s,a){R(this,Le),R(this,De),R(this,Ve),R(this,xe),R(this,Oe),R(this,Ae),R(this,Be),R(this,Pe,!1),R(this,je),R(this,Ce,p.L.get().createContext("GroupReader")),N(this,De,t),N(this,Ve,e),N(this,xe,i),N(this,Oe,n),N(this,Ae,r),N(this,Be,s),N(this,je,a)}streamId(){return _(this,je)}groupId(){return _(this,Oe)}subscribeId(){return _(this,Ve)}next(){return z(this,null,(function*(){try{if((yield _(this,De).isDone())||_(this,Pe))return{done:!0,value:void 0};const t=yield _(this,De).readBigVarInt(),e=yield _(this,De).readVarInt();let i=0,n=new Uint8Array;return e>0?n=yield _(this,De).read(e):i=yield _(this,De).readVarInt(),de(i),3===i&&N(this,Pe,!0),{done:!1,value:{subscribeId:_(this,Ve),trackAlias:_(this,xe),groupId:_(this,Oe),subGroupId:_(this,Ae),subscriberPriority:_(this,Be),streamId:_(this,je),objectId:t,objectStatus:i,payload:n}}}catch(t){return _(this,Ce).info("Error reading object",{error:t}),{done:!0,value:void 0}}}))}return(){return z(this,null,(function*(){return yield _(this,De).close().catch((()=>{})),{done:!0,value:void 0}}))}groups(){return G(this,Le,_e).call(this)}[Symbol.asyncIterator](){return this}[et()](){return G(this,Le,Re).call(this)}[Symbol.asyncDispose](){return G(this,Le,Re).call(this)}}function hi(t,e){return z(this,null,(function*(){const i=yield t.readVarInt();switch(i){case he.StreamHeaderGroup:{const i=yield t.readBigVarInt(),n=yield t.readBigVarInt(),r=yield t.readBigVarInt(),s=yield t.readBigVarInt(),a=yield t.readUnsigned8();return new ui(t,i,n,r,s,a,e)}case he.StreamHeaderTrack:{const i=yield t.readBigVarInt(),n=yield t.readBigVarInt(),r=yield t.readUnsigned8();return new li(t,i,n,r,e)}default:throw new Error("Unexpected message type "+i)}}))}De=new WeakMap,Ve=new WeakMap,xe=new WeakMap,Oe=new WeakMap,Ae=new WeakMap,Be=new WeakMap,Pe=new WeakMap,je=new WeakMap,Ce=new WeakMap,Le=new WeakSet,_e=function(){return H(this,null,(function*(){yield this}))},Re=function(){return _(this,De).close().catch((()=>{}))};class di{constructor(t,e){R(this,Ne),R(this,Ge),N(this,Ne,t),N(this,Ge,e)}start(t){_(this,Ne).addEventListener("message",(e=>{if("object"==typeof e.data&&e.data instanceof ArrayBuffer){const i=new Uint8Array(e.data);i[0]==_(this,Ge)&&t.enqueue(i.subarray(1))}})),_(this,Ne).addEventListener("error",(e=>t.error(e))),_(this,Ne).addEventListener("close",(()=>at((()=>t.close()))))}cancel(t){_(this,Ne).close(void 0,t)}}Ne=new WeakMap,Ge=new WeakMap;class pi{constructor(t){R(this,Fe),R(this,ze,null),R(this,qe,null),R(this,He,null),N(this,Fe,t)}start(t){N(this,ze,(e=>{if("object"==typeof e.data&&e.data instanceof ArrayBuffer){const i=new Uint8Array(e.data),n=i[0]||0,r=127&n,s=(n>>7&1)>0;if(r&&0!==r){const e=i.subarray(1);t.enqueue([s,r,e])}}})),N(this,qe,(()=>at((()=>t.close())))),N(this,He,(e=>t.error(e))),_(this,Fe).addEventListener("message",_(this,ze)),_(this,Fe).addEventListener("error",_(this,He)),_(this,Fe).addEventListener("close",_(this,qe))}cancel(t){_(this,ze)&&_(this,Fe).removeEventListener("message",_(this,ze)),_(this,He)&&_(this,Fe).removeEventListener("error",_(this,He)),_(this,qe)&&_(this,Fe).removeEventListener("close",_(this,qe))}}Fe=new WeakMap,ze=new WeakMap,qe=new WeakMap,He=new WeakMap;class fi{constructor(t,e){R(this,Ke),R(this,$e),R(this,Ze),R(this,Xe),R(this,Ye,0),R(this,Je,new TextDecoder),N(this,$e,t),N(this,Ze,e),N(this,Xe,e.getReader())}readUnsigned8(){return z(this,null,(function*(){return yield G(this,Ke,ei).call(this,1),G(this,Ke,ni).call(this,1)[0]}))}readString(){return z(this,null,(function*(){const t=yield this.readVarInt(),e=yield this.read(t);return _(this,Je).decode(e)}))}readVarInt(){return z(this,null,(function*(){const t=yield this.readBigVarInt();if(t>Number.MAX_SAFE_INTEGER)throw new Error("VarInt is too large");return Number(t)}))}readBigVarInt(){return z(this,null,(function*(){yield G(this,Ke,ei).call(this,1);const t=(192&G(this,Ke,ii).call(this,1)[0])>>6;switch(_(this,$e)[_(this,Ye)]=63&G(this,Ke,ii).call(this,1)[0],t){case 0:return tt(G(this,Ke,ni).call(this,1)[0]);case 1:{yield G(this,Ke,ei).call(this,2);const t=G(this,Ke,ni).call(this,2);return tt(new DataView(t.buffer,t.byteOffset,t.byteLength).getUint16(0))}case 2:{yield G(this,Ke,ei).call(this,4);const t=G(this,Ke,ni).call(this,4);return tt(new DataView(t.buffer,t.byteOffset,t.byteLength).getUint32(0))}case 3:{yield G(this,Ke,ei).call(this,8);const t=G(this,Ke,ni).call(this,8),e=new DataView(t.buffer,t.byteOffset,t.byteLength);return void 0!==e.getBigUint64?tt(e.getBigUint64(0)):tt((0,p.b)(t,0,7))}default:throw new Error("Invalid VarInt size")}}))}read(t){return z(this,null,(function*(){return yield G(this,Ke,ei).call(this,t),G(this,Ke,ni).call(this,t)}))}readAll(){return z(this,null,(function*(){for(;yield G(this,Ke,ti).call(this););return G(this,Ke,ni).call(this,G(this,Ke,Qe).call(this))}))}isDone(){return z(this,null,(function*(){return!(G(this,Ke,Qe).call(this)>0)&&0==(yield G(this,Ke,ti).call(this))}))}closed(){return z(this,null,(function*(){return _(this,Xe).closed}))}close(){return z(this,null,(function*(){return _(this,Xe).releaseLock(),_(this,Ze).cancel()}))}}$e=new WeakMap,Ze=new WeakMap,Xe=new WeakMap,Ye=new WeakMap,Je=new WeakMap,Ke=new WeakSet,Qe=function(){return _(this,$e).length-_(this,Ye)},ti=function(){return z(this,null,(function*(){const{value:t,done:e}=yield _(this,Xe).read();if(e)return Promise.resolve(0);if(0===G(this,Ke,Qe).call(this))N(this,$e,t);else{const e=_(this,$e).subarray(_(this,Ye)),i=new Uint8Array(e.length+t.length);i.set(e),i.set(t,e.byteLength),N(this,$e,i)}return N(this,Ye,0),Promise.resolve(t.length)}))},ei=function(t){return z(this,null,(function*(){for(;G(this,Ke,Qe).call(this)<t;)if(0===(yield G(this,Ke,ti).call(this)))throw new Error("Read failed")}))},ii=function(t){return _(this,$e).subarray(_(this,Ye),_(this,Ye)+t)},ni=function(t){const e=G(this,Ke,ii).call(this,t);return N(this,Ye,_(this,Ye)+e.length),e};class yi{constructor(t){R(this,ri,new Uint8Array(8)),R(this,si),R(this,ai),R(this,oi,new TextEncoder),N(this,si,t),N(this,ai,_(this,si).getWriter())}writeString(t){return z(this,null,(function*(){const e=_(this,oi).encode(t);return yield this.writeVarInt(e.length),this.write(e)}))}write(t){return _(this,ai).write(t)}writeUnsigned8(t){return _(this,ai).write(Ui(t,_(this,ri)))}writeVarInt(t){return _(this,ai).write(Oi(t,_(this,ri)))}writeBigVarInt(t){return _(this,ai).write(Ai(t,_(this,ri)))}flush(){return z(this,null,(function*(){}))}close(){return z(this,null,(function*(){_(this,ai).releaseLock(),yield _(this,si).close()}))}}ri=new WeakMap,si=new WeakMap,ai=new WeakMap,oi=new WeakMap;var wi,bi,mi,gi;const vi=class t{constructor(e){R(this,wi,0),R(this,bi,new Uint8Array(t.DEFAULT_BUFFER_SIZE)),R(this,mi),R(this,gi,new TextEncoder),N(this,mi,e)}writeString(t){return z(this,null,(function*(){const e=_(this,gi).encode(t);return yield this.writeVarInt(e.length),this.write(e)}))}ensureBufferSpace(t){if(_(this,bi).length-_(this,wi)>=t)return;const e=new Uint8Array(_(this,bi).length+t);e.set(_(this,bi)),N(this,bi,e)}write(t){return this.ensureBufferSpace(t.length),_(this,bi).set(t,_(this,wi)),N(this,wi,_(this,wi)+t.byteLength),Promise.resolve()}writeUnsigned8(t){return this.ensureBufferSpace(1),Ui(t,_(this,bi).subarray(_(this,wi))),N(this,wi,_(this,wi)+1),Promise.resolve()}writeVarInt(t){if(t<0)throw new Error(`VarInt can not be negative: ${t}`);return this.ensureBufferSpace(8),N(this,wi,_(this,wi)+Oi(t,_(this,bi).subarray(_(this,wi))).byteLength),Promise.resolve()}writeBigVarInt(t){if(t<0)throw new Error(`VarInt can not be negative: ${t}`);return this.ensureBufferSpace(8),N(this,wi,_(this,wi)+Ai(t,_(this,bi).subarray(_(this,wi))).byteLength),Promise.resolve()}flush(){if(1!==_(this,mi).readyState)throw new Error("Writer is not open");return _(this,mi).send(_(this,bi).subarray(0,_(this,wi))),N(this,wi,0),N(this,bi,new Uint8Array(t.DEFAULT_BUFFER_SIZE)),Promise.resolve()}close(){return _(this,mi).close(),Promise.resolve()}};wi=new WeakMap,bi=new WeakMap,mi=new WeakMap,gi=new WeakMap,j(vi,"DEFAULT_BUFFER_SIZE",1024);let ki=vi;const Ii=Math.pow(2,6)-1,Si=Math.pow(2,14)-1,Mi=Math.pow(2,30)-1,Wi=Number.MAX_SAFE_INTEGER,Ti="function"==typeof BigInt?tt(2)**tt(62)-tt(1):tt(Number.MAX_SAFE_INTEGER);function Ui(t,e){return e[0]=t,e.subarray(0,1)}function Ei(t,e){const i=new DataView(e.buffer,e.byteOffset,2);return i.setUint16(0,t),new Uint8Array(i.buffer,i.byteOffset,i.byteLength)}function Di(t,e){const i=new DataView(e.buffer,e.byteOffset,4);return i.setUint32(0,t),new Uint8Array(i.buffer,i.byteOffset,i.byteLength)}function Vi(t,e){const i=new DataView(e.buffer,e.byteOffset,8);return i.setBigUint64(0,t),new Uint8Array(i.buffer,i.byteOffset,i.byteLength)}function xi(t,e){const i=new DataView(e.buffer,e.byteOffset,8);return i.setUint32(0,t/4294967296),i.setUint32(4,4294967295&t),e.set([192],0),new Uint8Array(i.buffer,i.byteOffset,i.byteLength)}function Oi(t,e){if(t<=Ii)return Ui(t,e);if(t<=Si)return Ei(16384|t,e);if(t<=Mi)return Di(2147483648|t,e);if(t<=Wi)return"function"==typeof BigInt?Vi(BigInt(t)|BigInt(3221225472)<<BigInt(32),e):xi(Number(t),e);throw new Error(`overflow, value larger than 53-bits: ${t}`)}function Ai(t,e){if(t<Ii)return Ui(Number(t),e);if(t<Si)return Ei(16384|Number(t),e);if(t<=Mi)return Di(2147483648|Number(t),e);if(t<=Ti)return"function"==typeof BigInt?Vi(BigInt(t)|BigInt(3221225472)<<BigInt(32),e):xi(Number(t),e);throw new Error(`overflow, value larger than 62-bits: ${t}`)}var Bi=(t=>(t[t.SubscribeUpdate=2]="SubscribeUpdate",t[t.Subscribe=3]="Subscribe",t[t.SubscribeOk=4]="SubscribeOk",t[t.SubscribeError=5]="SubscribeError",t[t.Announce=6]="Announce",t[t.AnnounceOk=7]="AnnounceOk",t[t.AnnounceError=8]="AnnounceError",t[t.Unannounce=9]="Unannounce",t[t.Unsubscribe=10]="Unsubscribe",t[t.SubscribeDone=11]="SubscribeDone",t[t.AnnounceCancel=12]="AnnounceCancel",t[t.TrackStatusRequest=13]="TrackStatusRequest",t[t.TrackStatus=14]="TrackStatus",t[t.Goaway=16]="Goaway",t[t.ClientSetup=64]="ClientSetup",t[t.ServerSetup=65]="ServerSetup",t[t.Unknown=255]="Unknown",t))(Bi||{});function Pi(t){return z(this,null,(function*(){const e=yield t.readVarInt();if(e<1||e>32)throw new Error(`namespace must be between 1 and 32, got ${e}`);const i=[];for(let n=0;n<e;n++)i.push(yield t.readString());return i}))}function ji(t,e){return z(this,null,(function*(){yield t.writeVarInt(e.length);for(const i of e)yield t.writeString(i)}))}const Ci=tt(2);function Li(t){return z(this,null,(function*(){const e=yield t.readVarInt(),i=new Map;for(let n=0;n<e;n++){const e=yield t.readBigVarInt(),n=yield t.read(yield t.readVarInt());i.set(e,{type:e,payload:n})}return i}))}function _i(t,e){return z(this,null,(function*(){yield t.writeVarInt(e.size);for(const[i,n]of e)yield t.writeBigVarInt(i),yield t.writeVarInt(n.payload.length),yield t.write(n.payload)}))}const Ri={Role:tt(0)},Ni={Draft07:4278190087};function Gi(t){return z(this,null,(function*(){const e=yield t.readVarInt();return e===Ni.Draft07?{type:"known",value:e}:{type:"unknown",value:e}}))}const Fi={"latest-group":1,"latest-object":2,"absolute-start":3,"absolute-range":4};function zi(t){return z(this,null,(function*(){const e=yield t.readUnsigned8();switch(e){case 0:return"inherit-publisher";case 1:return"ascending";case 2:return"descending";default:throw new Error(`Invalid location type ${e}`)}}))}function qi(t,e){return z(this,null,(function*(){switch(e){case"inherit-publisher":yield t.writeUnsigned8(0);break;case"ascending":yield t.writeUnsigned8(1);break;case"descending":yield t.writeUnsigned8(2)}}))}var Hi,$i,Zi,Xi,Yi,Ji,Ki,Qi,tn,en,nn,rn,sn,an,on,cn,ln,un,hn,dn,pn,fn,yn,wn;class bn{constructor(t){R(this,Zi),R(this,Hi),R(this,$i,new Uint8Array),N(this,Hi,t)}write(t){return z(this,null,(function*(){yield _(this,Hi).writeVarInt(t.type);const e=new ki({close:()=>{},readyState:1,send:t=>{N(this,$i,new Uint8Array(t))}});switch(t.type){case Bi.Subscribe:yield G(this,Zi,Ji).call(this,e,t);break;case Bi.Announce:yield G(this,Zi,rn).call(this,e,t);break;case Bi.SubscribeOk:yield G(this,Zi,Ki).call(this,e,t);break;case Bi.SubscribeUpdate:yield G(this,Zi,tn).call(this,e,t);break;case Bi.SubscribeError:yield G(this,Zi,Qi).call(this,e,t);break;case Bi.SubscribeDone:yield G(this,Zi,en).call(this,e,t);break;case Bi.Unsubscribe:yield G(this,Zi,nn).call(this,e,t);break;case Bi.ClientSetup:yield G(this,Zi,Xi).call(this,e,t);break;case Bi.ServerSetup:yield G(this,Zi,Yi).call(this,e,t);break;case Bi.AnnounceOk:yield G(this,Zi,sn).call(this,e,t);break;default:throw new Error(`Unknown message type: ${t.type}`)}yield e.flush(),yield _(this,Hi).writeVarInt(_(this,$i).byteLength),yield _(this,Hi).write(_(this,$i)),yield _(this,Hi).flush()}))}close(){return z(this,null,(function*(){return _(this,Hi).close()}))}}Hi=new WeakMap,$i=new WeakMap,Zi=new WeakSet,Xi=function(t,e){return z(this,null,(function*(){yield function(t,e){return z(this,null,(function*(){yield t.writeVarInt(e.supportedVersions.length);for(const i of e.supportedVersions)yield t.writeVarInt(i.value);yield _i(t,e.parameters)}))}(t,e)}))},Yi=function(t,e){return z(this,null,(function*(){yield function(t,e){return z(this,null,(function*(){yield t.writeVarInt(e.selectedVersion.value),yield _i(t,e.parameters)}))}(t,e)}))},Ji=function(t,e){return z(this,null,(function*(){yield function(t,e){return z(this,null,(function*(){yield t.writeBigVarInt(e.id),yield t.writeBigVarInt(e.trackAlias),yield ji(t,e.namespace),yield t.writeString(e.name),yield t.writeUnsigned8(e.subscriberPriority),yield qi(t,e.groupOrder),yield function(t,e){return z(this,null,(function*(){const i=Fi[e.type];switch(yield t.writeVarInt(i),e.type){case"absolute-range":yield t.writeBigVarInt(e.start.group),yield t.writeBigVarInt(e.start.object),yield t.writeBigVarInt(e.end.group),yield t.writeBigVarInt(e.end.object);break;case"absolute-start":yield t.writeBigVarInt(e.start.group),yield t.writeBigVarInt(e.start.object);break;case"latest-object":case"latest-group":break;default:throw new Error(`Invalid location type ${i}`)}}))}(t,e.filterType),yield _i(t,e.params)}))}(t,e)}))},Ki=function(t,e){return z(this,null,(function*(){yield function(t,e){return z(this,null,(function*(){yield t.writeBigVarInt(e.id),yield t.writeBigVarInt(e.expires),yield qi(t,e.groupOrder),yield t.writeUnsigned8(e.largestInfo?1:0),e.largestInfo&&(yield t.writeBigVarInt(e.largestInfo.group),yield t.writeBigVarInt(e.largestInfo.object)),yield _i(t,e.params)}))}(t,e)}))},Qi=function(t,e){return z(this,null,(function*(){yield function(t,e){return z(this,null,(function*(){yield t.writeBigVarInt(e.id),yield t.writeBigVarInt(e.errorCode),yield t.writeString(e.reason),yield t.writeBigVarInt(e.trackAlias)}))}(t,e)}))},tn=function(t,e){return z(this,null,(function*(){yield function(t,e){return z(this,null,(function*(){yield t.writeBigVarInt(e.id),yield t.writeBigVarInt(e.start.group),yield t.writeBigVarInt(e.start.object),yield t.writeBigVarInt(e.end.group),yield t.writeBigVarInt(e.end.object),yield t.writeUnsigned8(e.subscriberPriority),yield _i(t,e.params)}))}(t,e)}))},en=function(t,e){return z(this,null,(function*(){yield function(t,e){return z(this,null,(function*(){yield t.writeBigVarInt(e.id),yield t.writeVarInt(e.errorCode),yield t.writeString(e.reason),yield t.writeUnsigned8(e.finalInfo?1:0),e.finalInfo&&(yield t.writeBigVarInt(e.finalInfo.group),yield t.writeBigVarInt(e.finalInfo.object))}))}(t,e)}))},nn=function(t,e){return z(this,null,(function*(){yield function(t,e){return z(this,null,(function*(){yield t.writeBigVarInt(e.id)}))}(t,e)}))},rn=function(t,e){return z(this,null,(function*(){yield function(t,e){return z(this,null,(function*(){yield ji(t,e.namespace),yield _i(t,e.params)}))}(t,e)}))},sn=function(t,e){return z(this,null,(function*(){yield function(t,e){return z(this,null,(function*(){yield ji(t,e.namespace)}))}(t,e)}))};class mn{constructor(t,e){R(this,an),R(this,on),R(this,cn),N(this,an,t),N(this,on,new bn(t)),N(this,cn,e)}write(t){return z(this,null,(function*(){yield _(this,an).write(_(this,cn)),yield _(this,on).write(t)}))}close(){return _(this,an).close()}}an=new WeakMap,on=new WeakMap,cn=new WeakMap;class gn{constructor(t){R(this,ln),N(this,ln,t)}cancel(){return _(this,ln).close()}read(){return z(this,null,(function*(){const t=yield _(this,ln).readVarInt(),e=yield _(this,ln).readVarInt();switch(t){case Bi.ServerSetup:return function(t){return z(this,null,(function*(){const e=yield Gi(t);if("known"!==e.type)throw new Error("Expected known version");const i=yield Li(t);if(!i.has(Ri.Role))throw new Error("Role parameter is required");return{type:Bi.ServerSetup,selectedVersion:e,parameters:i}}))}(_(this,ln));case Bi.ClientSetup:return function(t){return z(this,null,(function*(){const e=[],i=yield t.readVarInt();for(let n=0;n<i;n++)e.push(yield Gi(t));const n=yield Li(t);if(!n.has(Ri.Role))throw new Error("Role parameter is required");return{type:Bi.ClientSetup,supportedVersions:e,parameters:n}}))}(_(this,ln));case Bi.Subscribe:return function(t){return z(this,null,(function*(){const e=yield t.readBigVarInt(),i=yield t.readBigVarInt(),n=yield Pi(t),r=yield t.readString(),s=yield t.readUnsigned8(),a=yield zi(t),o=yield function(t){return z(this,null,(function*(){const e=yield t.readVarInt();switch(e){case 1:return{type:"latest-group"};case 2:return{type:"latest-object"};case 3:return{type:"absolute-start",start:{group:yield t.readBigVarInt(),object:yield t.readBigVarInt()}};case 4:return{type:"absolute-range",start:{group:yield t.readBigVarInt(),object:yield t.readBigVarInt()},end:{group:yield t.readBigVarInt(),object:yield t.readBigVarInt()}};default:throw new Error(`Invalid location type ${e}`)}}))}(t),c=yield Li(t);if("absolute-range"===o.type){const t=o.start.group>o.end.group,e=o.start.group===o.end.group&&o.start.object>o.end.object;if(t||e)throw new Error("Invalid filter range")}return{type:Bi.Subscribe,id:e,trackAlias:i,namespace:n,name:r,subscriberPriority:s,groupOrder:a,filterType:o,params:c}}))}(_(this,ln));case Bi.SubscribeOk:return function(t){return z(this,null,(function*(){const e=yield t.readBigVarInt(),i=yield t.readBigVarInt(),n=yield zi(t),r=1==(yield t.readUnsigned8());let s;if("inherit-publisher"==n)throw new Error("SusbcribeOk cannot have inherit publisher group order");r&&(s={group:yield t.readBigVarInt(),object:yield t.readBigVarInt()});const a=yield Li(t);return{type:Bi.SubscribeOk,id:e,groupOrder:n,expires:i,largestInfo:s,params:a}}))}(_(this,ln));case Bi.SubscribeDone:return function(t){return z(this,null,(function*(){const e=yield t.readBigVarInt(),i=yield t.readVarInt(),n=yield t.readString();let r;return 1==(yield t.readUnsigned8())&&(r={group:yield t.readBigVarInt(),object:yield t.readBigVarInt()}),{type:Bi.SubscribeDone,id:e,errorCode:i,reason:n,finalInfo:r}}))}(_(this,ln));case Bi.SubscribeError:return function(t){return z(this,null,(function*(){return{type:Bi.SubscribeError,id:yield t.readBigVarInt(),errorCode:yield t.readBigVarInt(),reason:yield t.readString(),trackAlias:yield t.readBigVarInt()}}))}(_(this,ln));case Bi.SubscribeUpdate:return function(t){return z(this,null,(function*(){const e=yield t.readBigVarInt(),i=yield t.readBigVarInt(),n=yield t.readBigVarInt(),r=yield t.readBigVarInt(),s=yield t.readBigVarInt(),a=yield t.readUnsigned8(),o=yield Li(t);if(i>r||i===r&&n>s)throw new Error("Invalid filter range");return{type:Bi.SubscribeUpdate,id:e,start:{group:i,object:n},end:{group:r,object:s},subscriberPriority:a,params:o}}))}(_(this,ln));case Bi.Unsubscribe:return function(t){return z(this,null,(function*(){return{type:Bi.Unsubscribe,id:yield t.readBigVarInt()}}))}(_(this,ln));case Bi.Announce:return function(t){return z(this,null,(function*(){return{type:Bi.Announce,namespace:yield Pi(t),params:yield Li(t)}}))}(_(this,ln));case Bi.AnnounceOk:return function(t){return z(this,null,(function*(){return{type:Bi.AnnounceOk,namespace:yield Pi(t)}}))}(_(this,ln));case Bi.AnnounceError:return function(t){return z(this,null,(function*(){return{type:Bi.AnnounceError,namespace:yield Pi(t),errorCode:yield t.readBigVarInt(),reason:yield t.readString()}}))}(_(this,ln))}return function(t,e,i){return z(this,null,(function*(){return{type:Bi.Unknown,messageType:e,payload:yield t.read(i)}}))}(_(this,ln),tt(t),e)}))}}ln=new WeakMap;const vn=class t{constructor(t,e){R(this,fn),R(this,un),R(this,hn),R(this,dn,new p.D),R(this,pn,new p.D),N(this,un,t),N(this,hn,e),_(this,dn).resolve()}write(t){return z(this,null,(function*(){const e=yield G(this,fn,yn).call(this);try{yield _(this,un).write(t)}finally{e.resolve()}}))}markPostHandshake(){_(this,pn).resolve()}postHandshake(){return _(this,pn).promise}read(){return z(this,null,(function*(){return _(this,hn).read()}))}cancel(){return _(this,hn).cancel()}static wrapWebsocket(e){const i=new ReadableStream(new di(e,_(t,wn))),n=new gn(new fi(new Uint8Array([]),i)),r=new mn(new ki(e),new Uint8Array([0]));return new t(r,n)}static wrapWebTransport(e){const i=e.writable,n=e.readable;return new t(new bn(new yi(i)),new gn(new fi(new Uint8Array,n)))}};un=new WeakMap,hn=new WeakMap,dn=new WeakMap,pn=new WeakMap,fn=new WeakSet,yn=function(){const t=new p.D,e=_(this,dn).promise.then((()=>t));return N(this,dn,t),e},wn=new WeakMap,R(vn,wn,0);let kn=vn;function In(t,e){return z(this,null,(function*(){yield t.write({type:Bi.ClientSetup,supportedVersions:[{type:"known",value:Ni.Draft07}],parameters:new Map([[Ri.Role,{type:Ri.Role,payload:new Uint8Array([e])}]])});const i=yield t.read();if(t.markPostHandshake(),i.type!==Bi.ServerSetup)throw new Error("Expected server setup message");if("known"!==i.selectedVersion.type)throw new Error("Expected known version")}))}var Sn,Mn,Wn,Tn,Un,En,Dn;class Vn{constructor(t){j(this,"announce"),R(this,Sn,new p.D),this.announce=t}onOk(t){_(this,Sn).resolve(t)}onError(t){const e=new Error(t.reason);return _(this,Sn).reject(e),e}ok(){return _(this,Sn).promise}}Sn=new WeakMap;class xn{constructor(t){j(this,"state"),this.state=t}}const On=class t{constructor(t){switch(j(this,"subscribe"),R(this,Mn,new p.D),R(this,Wn,new p.D),R(this,Tn,new p.D),R(this,Un,Date.now()),R(this,En,new p.D),R(this,Dn),this.subscribe=t,t.filterType.type){case"absolute-start":N(this,Dn,{startGroup:t.filterType.start.group});break;case"absolute-range":N(this,Dn,{startGroup:t.filterType.start.group,endGroup:t.filterType.end.group})}}onUpdate(t){N(this,Dn,{startGroup:t.start.group}),t.end.group>tt(0)&&(_(this,Dn).endGroup=t.end.group-tt(1))}onError(t){const e=new Error(t.reason);return _(this,Mn).reject(e),_(this,Wn).reject(e),e}onDone(t){t.finalInfo&&(_(this,Dn)||N(this,Dn,{startGroup:tt(0)}),_(this,Dn).endGroup=t.finalInfo.group),_(this,Wn).resolve(t)}onUnsubscribe(t){_(this,Tn).resolve(t)}onOk(e){const i=Math.max(0,Date.now()-_(this,Un)),n=Number(e.expires);if(n>0){const e=Math.max(t.minGraceTime,Math.min(n/10,t.maxGraceTime));Promise.race([(0,p.w)(n-e-i),this.done().catch(p.n)]).then((()=>_(this,En).resolve(this.expiryState()))).catch(p.n)}_(this,Mn).resolve(e)}done(){return _(this,Wn).promise}ok(){return _(this,Mn).promise}range(){return _(this,Dn)}close(){_(this,En).promise.catch(p.n),_(this,En).reject(new Error("Subscription closed"))}expiryState(){return _(this,Wn).resolved&&6!==_(this,Wn).resolved.errorCode?"done":_(this,Tn).pending?"active":"unsubscribed"}unsubscribed(){return _(this,Tn).promise}isUnsubscribed(){return _(this,Tn).resolved}expiryNotification(){return _(this,En).promise}};Mn=new WeakMap,Wn=new WeakMap,Tn=new WeakMap,Un=new WeakMap,En=new WeakMap,Dn=new WeakMap,j(On,"maxGraceTime",15e3),j(On,"minGraceTime",3e3);let An=On;var Bn,Pn,jn,Cn,Ln,_n,Rn,Nn,Gn,Fn,zn,qn,Hn,$n,Zn,Xn,Yn,Jn,Kn,Qn,tr,er,ir,nr,rr,sr,ar,or,cr,lr,ur,hr,dr,pr,fr,yr,wr,br,mr,gr,vr,kr,Ir,Sr,Mr,Wr,Tr,Ur,Er,Dr,Vr,xr,Or,Ar,Br,Pr,jr,Cr,Lr,_r,Rr,Nr,Gr,Fr,zr,qr,Hr,$r,Zr,Xr,Yr,Jr,Kr,Qr,ts,es,is,ns,rs,ss,as,os,cs,ls,us,hs,ds,ps,fs,ys,ws,bs,ms,gs,vs,ks,Is,Ss,Ms,Ws,Ts,Us;class Es{constructor(t){R(this,Bn),R(this,Pn,!1),N(this,Bn,t)}write(t){return z(this,null,(function*(){_(this,Pn)||(yield _(this,Bn).writeVarInt(he.StreamHeaderGroup),yield _(this,Bn).writeBigVarInt(t.subscribeId),yield _(this,Bn).writeBigVarInt(t.trackAlias),yield _(this,Bn).writeBigVarInt(t.groupId),yield _(this,Bn).writeBigVarInt(t.subGroupId),yield _(this,Bn).writeUnsigned8(t.subscriberPriority),N(this,Pn,!0)),yield _(this,Bn).writeBigVarInt(t.objectId),yield _(this,Bn).writeVarInt(t.payload.length),t.payload.length>0?yield _(this,Bn).write(t.payload):yield _(this,Bn).writeVarInt(t.objectStatus),yield _(this,Bn).flush()}))}close(){return z(this,null,(function*(){yield _(this,Bn).close()}))}}Bn=new WeakMap,Pn=new WeakMap;class Ds{constructor(t,e,i,n){R(this,Gn),R(this,jn),R(this,Cn),R(this,Ln),R(this,_n),R(this,Rn),R(this,Nn),N(this,jn,e),N(this,Cn,t),N(this,Ln,i),N(this,_n,n),N(this,Nn,p.L.get().createContext(`SubscriptionWriter:${t.subscribe.name}`))}finalInfo(){return _(this,Rn)}run(){return z(this,null,(function*(){yield Promise.race([G(this,Gn,Fn).call(this).catch((t=>_(this,Nn).error("error writing subscription",t))),_(this,Cn).unsubscribed(),_(this,Cn).done(),_(this,Cn).expiryNotification().catch(p.n)])}))}done(t,e){return z(this,null,(function*(){if(_(this,Cn).isUnsubscribed())return;const i={type:Bi.SubscribeDone,id:_(this,Cn).subscribe.id,errorCode:t,reason:e,finalInfo:_(this,Rn)};_(this,Cn).onDone(i),yield _(this,_n).push(i)}))}[et()](){return this.done(3,"Track ended")}[Symbol.asyncDispose](){return this.done(3,"Track ended")}}jn=new WeakMap,Cn=new WeakMap,Ln=new WeakMap,_n=new WeakMap,Rn=new WeakMap,Nn=new WeakMap,Gn=new WeakSet,Fn=function(){return z(this,null,(function*(){try{for(var t,e,i,n=Z(_(this,jn));t=!(e=yield n.next()).done;t=!1){const t=e.value;var r=[];try{const e=_(this,Cn).range();if(e&&(e.startGroup>t.id||e.endGroup&&e.endGroup<t.id))break;const i=yield _(this,Ln).openSendStream(),n=new Es(i),s=X(r,new Vs(n,t.consume(),_(this,Cn)),!0);yield s.run(),N(this,Rn,s.finalGroup())}catch(t){var s=t,a=!0}finally{var o=Y(r,s,a);o&&(yield o)}}}catch(e){i=[e]}finally{try{t&&(e=n.return)&&(yield e.call(n))}finally{if(i)throw i[0]}}}))};class Vs{constructor(t,e,i){R(this,zn),R(this,qn),R(this,Hn),R(this,$n),R(this,Zn),N(this,zn,t),N(this,qn,e),N(this,Hn,i),N(this,Zn,p.L.get().createContext(`GroupSubscriptionWriter:${i.subscribe.name}`))}finalGroup(){return _(this,$n)}run(){return z(this,null,(function*(){_(this,Zn).debug("write group");try{for(var t,e,i,n=Z(_(this,qn));t=!(e=yield n.next()).done;t=!1){const t=e.value;yield _(this,zn).write({subscribeId:_(this,Hn).subscribe.id,trackAlias:_(this,Hn).subscribe.trackAlias,subGroupId:tt(0),subscriberPriority:0,groupId:t.groupId,objectId:t.objectId,objectStatus:t.objectStatus,payload:t.payload}),N(this,$n,{group:t.groupId,object:t.objectId})}}catch(e){i=[e]}finally{try{t&&(e=n.return)&&(yield e.call(n))}finally{if(i)throw i[0]}}_(this,Zn).debug("write group done")}))}[et()](){return _(this,zn).close().catch(p.n)}[Symbol.asyncDispose](){return _(this,zn).close().catch(p.n)}}zn=new WeakMap,qn=new WeakMap,Hn=new WeakMap,$n=new WeakMap,Zn=new WeakMap;class xs{constructor(t,e,i){R(this,Jn),j(this,"state"),R(this,Xn),R(this,Yn),this.state=t,N(this,Xn,e),N(this,Yn,i)}ok(t){return z(this,null,(function*(){var e,i,n;const r=null==(e=this.state.range())?void 0:e.startGroup,s=t.latest(),a=null==s?void 0:s.id,o=null!=(n=null==(i=null==s?void 0:s.latest())?void 0:i.objectId)?n:tt(0),c=t.consume(null!=r?r:a),l={type:Bi.SubscribeOk,id:this.state.subscribe.id,expires:tt(0),groupOrder:"ascending",params:new Map,largestInfo:a?{group:a,object:o}:void 0};return yield _(this,Yn).push(l),new Ds(this.state,c,_(this,Xn),_(this,Yn))}))}invalidRange(){return G(this,Jn,Kn).call(this,tt(1),"Invalid range")}retryTrackAlias(){return G(this,Jn,Kn).call(this,tt(2),"Retry track alias")}trackDoesNotExist(){return G(this,Jn,Kn).call(this,tt(3),"Track does not exist")}unauthorized(){return G(this,Jn,Kn).call(this,tt(4),"Unauthorized")}timeout(){return G(this,Jn,Kn).call(this,tt(5),"Timeout")}[et()](){return this.trackDoesNotExist()}[Symbol.asyncDispose](){return this.trackDoesNotExist()}}Xn=new WeakMap,Yn=new WeakMap,Jn=new WeakSet,Kn=function(t,e){const i={type:Bi.SubscribeError,id:this.state.subscribe.id,errorCode:t,reason:e,trackAlias:this.state.subscribe.trackAlias};return _(this,Yn).push(i)},Qn=[(0,p.i)({context:"Session",enter:"info",error:"error"})];class Os{constructor(t,e,i){B(or,5,this),R(this,tr),R(this,er),R(this,ir),R(this,nr,p.L.get().createContext("Publisher")),R(this,rr,new st(new Map)),R(this,sr,new st(new Map)),R(this,ar,new K(10)),N(this,tr,t),N(this,er,e),N(this,ir,i)}announce(t){return z(this,null,(function*(){if(_(this,rr).current().has(t.join("/")))throw new Error("Duplicate announcement");const e=new Map,i=_(this,tr).authToken();i&&e.set(Ci,{type:Ci,payload:(new TextEncoder).encode(i)});const n={type:Bi.Announce,namespace:t,params:e},r=function(t){const e=new Vn(t);return new xn(e)}(n);if(_(this,rr).update((t=>t.set(n.namespace.join("/"),r))),yield _(this,ir).push(n),!(yield Promise.race([r.state.ok(),_(this,tr).closed()])))throw new Error("Session closed")}))}close(){_(this,sr).current().forEach((t=>t.close())),_(this,sr).close(),_(this,rr).close(),_(this,ar).close()}incomingSubscriptions(){return _(this,ar)}onMessage(t){return z(this,null,(function*(){switch(t.type){case Bi.Subscribe:{const e=new An(t);if(_(this,sr).update((i=>(i.set(t.id,e),i))),_(this,ar).isFull()){const t=yield _(this,ar).pop();yield null==t?void 0:t.timeout()}yield _(this,ar).push(new xs(e,_(this,er),_(this,ir)))}break;case Bi.SubscribeUpdate:{const e=_(this,sr).current().get(t.id);e||_(this,nr).debug("No subscription found",t),null==e||e.onUpdate(t)}break;case Bi.Unsubscribe:{const e=_(this,sr).current().get(t.id);e||_(this,nr).debug("No subscription found",t),null==e||e.onUnsubscribe(t)}break;case Bi.AnnounceOk:{const e=_(this,rr).current().get(t.namespace.join("/"));e||_(this,nr).debug("No announcement found",t),null==e||e.state.onOk(t)}break;case Bi.AnnounceError:{const e=_(this,rr).current().get(t.namespace.join("/"));e||_(this,nr).debug("No announcement found",t),null==e||e.state.onError(t)}}}))}}or=D(null),tr=new WeakMap,er=new WeakMap,ir=new WeakMap,nr=new WeakMap,rr=new WeakMap,sr=new WeakMap,ar=new WeakMap,P(or,1,"announce",Qn,Os),A(or,Os);class As{constructor(t,e){j(this,"state"),R(this,cr),this.state=t,N(this,cr,e)}onDone(t){this.state.onDone(t)}onData(t){return _(this,cr).push(t)}onError(t){const e=this.state.onError(t);_(this,cr).abort(e)}close(){this.state.close(),_(this,cr).close()}}cr=new WeakMap;class Bs{constructor(t,e,i){B(fr,5,this),R(this,yr),R(this,ur),R(this,hr),R(this,dr),R(this,pr,new p.D),N(this,ur,t),N(this,hr,e),N(this,dr,i)}get id(){return _(this,hr).subscribe.id}get trackAlias(){return _(this,hr).subscribe.trackAlias}get name(){return _(this,hr).subscribe.name}range(){return _(this,hr).range()}expiryNotification(){return _(this,hr).expiryNotification()}update(t,e){return z(this,null,(function*(){const i={type:Bi.SubscribeUpdate,id:_(this,hr).subscribe.id,start:{group:t,object:tt(0)},end:{group:e+tt(1),object:tt(0)},params:new Map,subscriberPriority:0};_(this,hr).onUpdate(i),yield _(this,ur).push(i)}))}unsubscribe(){return z(this,null,(function*(){const t={type:Bi.Unsubscribe,id:_(this,hr).subscribe.id};_(this,hr).onUnsubscribe(t),yield _(this,ur).push(t)}))}close(){var t,e;return _(this,pr).resolve(),null==(e=(t=_(this,dr)).return)?void 0:e.call(t)}closed(){return _(this,pr).promise}done(){return _(this,hr).done()}expiryState(){return _(this,hr).expiryState()}unsubscribed(){return _(this,hr).isUnsubscribed()}return(){return z(this,null,(function*(){return _(this,pr).resolve(),yield this.unsubscribe(),{done:!0,value:void 0}}))}groups(){return H(this,null,(function*(){var t,e;try{for(var i,n,r,s=Z(_(this,dr));i=!(n=yield new q(s.next())).done;i=!1){var a=n.value,o=[];try{const i=X(o,a,!0);try{for(var c,l,u,h=Z(i.groups());c=!(l=yield new q(h.next())).done;c=!1){const i=l.value,n=null==(t=_(this,hr).range())?void 0:t.startGroup,r=null==(e=_(this,hr).range())?void 0:e.endGroup;if(n&&i.groupId()<n)return{done:!0,value:void 0};if(r&&i.groupId()>r)return{done:!0,value:void 0};yield i}}catch(l){u=[l]}finally{try{c&&(l=h.return)&&(yield new q(l.call(h)))}finally{if(u)throw u[0]}}}catch(t){var d=t,p=!0}finally{var f=Y(o,d,p);f&&(yield new q(f))}}}catch(n){r=[n]}finally{try{i&&(n=s.return)&&(yield new q(n.call(s)))}finally{if(r)throw r[0]}}}))}[Symbol.asyncIterator](){return this.groups()}objects(){return H(this,null,(function*(){try{for(var t,e,i,n=Z(this.groups());t=!(e=yield new q(n.next())).done;t=!1){const t=e.value;try{for(var r,s,a,o=Z(t);r=!(s=yield new q(o.next())).done;r=!1){const t=s.value;yield t}}catch(s){a=[s]}finally{try{r&&(s=o.return)&&(yield new q(s.call(o)))}finally{if(a)throw a[0]}}}}catch(e){i=[e]}finally{try{t&&(e=n.return)&&(yield new q(e.call(n)))}finally{if(i)throw i[0]}}}))}[(lr=[(0,p.i)({context:"SubscriptionConsumer",enter:"info"})],et())](){return G(this,yr,wr).call(this)}[Symbol.asyncDispose](){return G(this,yr,wr).call(this)}}fr=D(null),ur=new WeakMap,hr=new WeakMap,dr=new WeakMap,pr=new WeakMap,yr=new WeakSet,wr=P(fr,17,"#dispose",lr,yr,wr=function(){return z(this,null,(function*(){return yield this.close(),this.unsubscribe()}))}),A(fr,Bs),vr=[(0,p.i)({context:"Session",return:"debug"})],gr=[(0,p.i)({context:"Session",enter:"info",error:"error"})],mr=[(0,p.i)({context:"Session",enter:"debug"})],br=[(0,p.i)({context:"Session",enter:"debug"})];class Ps{constructor(t,e){B(Wr,5,this),R(this,Tr),R(this,kr),j(this,"nextSubscribeId",tt(0)),R(this,Ir,new st(new Map)),R(this,Sr),R(this,Mr,p.L.get().createContext("Subscriber")),N(this,kr,t),N(this,Sr,e),G(this,Tr,Ur).call(this).catch(p.n)}subscribe(t,e){return z(this,null,(function*(){const i=this.nextSubscribeId++,n=new Map,r=_(this,kr).authToken();r&&n.set(Ci,{type:Ci,payload:(new TextEncoder).encode(r)});const s={type:Bi.Subscribe,namespace:t,name:e.name,id:i,trackAlias:i,groupOrder:e.groupOrder,subscriberPriority:e.priority,filterType:e.filterType,params:n},[a,o]=function(t,e){const i=new An(e),[n,r]=J(100);return[new As(i,n),new Bs(t,i,r)]}(_(this,Sr),s);if(_(this,Ir).update((t=>t.set(i,a))),yield _(this,Sr).push(s),!(yield Promise.race([a.state.ok(),_(this,kr).closed()])))throw new Error("Session closed");return o.closed().then((()=>Promise.race([(0,p.w)(2e3),this.closed()]))).then((()=>G(this,Tr,Er).call(this,o.id))).catch((()=>G(this,Tr,Er).call(this,o.id))),o}))}closed(){return _(this,kr).closed()}transportType(){return _(this,kr).transportType()}url(){return _(this,kr).url()}onMessage(t){return z(this,null,(function*(){switch(t.type){case Bi.Announce:yield _(this,Sr).push({type:Bi.AnnounceOk,namespace:t.namespace});break;case Bi.SubscribeOk:{const e=_(this,Ir).current().get(t.id);e&&e.state.onOk(t)}break;case Bi.SubscribeError:{const e=_(this,Ir).current().get(t.id);e||_(this,Mr).debug("No subscription found",t),null==e||e.onError(t),G(this,Tr,Er).call(this,t.id)}break;case Bi.SubscribeDone:{const e=_(this,Ir).current().get(t.id);e||_(this,Mr).debug("No subscription found",t),null==e||e.onDone(t)}}}))}onObjectReader(t){return z(this,null,(function*(){const e=_(this,Ir).current().get(t.subscribeId());e?yield e.onData(t):_(this,Mr).warn("No subscription found",t.subscribeId())}))}close(){_(this,Ir).current().forEach((t=>t.close())),_(this,Ir).close()}}Wr=D(null),kr=new WeakMap,Ir=new WeakMap,Sr=new WeakMap,Mr=new WeakMap,Tr=new WeakSet,Er=function(t){_(this,Ir).isClosed()||_(this,Ir).update((e=>(e.delete(t),e)))},Ur=P(Wr,17,"#observeChanges",vr,Tr,Ur=function(){return z(this,null,(function*(){try{for(var t,e,i,n=Z(_(this,Ir));t=!(e=yield n.next()).done;t=!1){const t=[...e.value.values()].map((t=>t.state.subscribe));_(this,Mr).debug("current subscriptions",t)}}catch(e){i=[e]}finally{try{t&&(e=n.return)&&(yield e.call(n))}finally{if(i)throw i[0]}}}))}),P(Wr,1,"subscribe",gr,Ps),P(Wr,1,"close",mr,Ps),Er=P(Wr,17,"#deleteSubscription",br,Tr,Er),A(Wr,Ps);class js{constructor(t,e){B(Nr,5,this),R(this,Lr),R(this,Ar),R(this,Br),R(this,Pr),R(this,jr,p.L.get().createContext("Session")),j(this,"subscriber"),j(this,"publisher"),R(this,Cr);const[i,n]=J(100);N(this,Ar,t),N(this,Pr,n),this.subscriber=new Ps(this,i),this.publisher=new Os(this,t,i),N(this,Br,G(this,Lr,Rr).call(this)),N(this,Cr,new st(e)),this.closed().then((()=>this.close())).catch(p.n)}updateAuthToken(t){_(this,Cr).update(t)}authToken(){return _(this,Cr).current()}transportType(){return _(this,Ar).transportType()}url(){return _(this,Ar).url()}closed(){return _(this,Br)}close(){try{this.subscriber.close(),this.publisher.close(),_(this,Pr).cancel("closing"),_(this,Ar).close()}catch(t){_(this,jr).warn("Error closing session",t)}}[(Or=[(0,p.i)({context:"Session",return:"info",error:"error"})],xr=[(0,p.i)({context:"Session",return:"info",error:"error"})],Vr=[(0,p.i)({context:"Session",return:"info",error:"error"})],Dr=[(0,p.i)({context:"Session",enter:"debug"})],it())](){G(this,Lr,qr).call(this)}[Symbol.dispose](){G(this,Lr,qr).call(this)}}Nr=D(null),Ar=new WeakMap,Br=new WeakMap,Pr=new WeakMap,jr=new WeakMap,Cr=new WeakMap,Lr=new WeakSet,_r=function(t){return z(this,null,(function*(){var e,i;_(this,jr).debug("received message",t),yield null==(e=this.subscriber)?void 0:e.onMessage(t),yield null==(i=this.publisher)?void 0:i.onMessage(t),t.type,Bi.Goaway}))},Rr=function(){return z(this,null,(function*(){return(yield Promise.all([G(this,Lr,Fr).call(this),G(this,Lr,zr).call(this),G(this,Lr,Gr).call(this)])).find((t=>t instanceof Error))}))},Fr=function(){return z(this,null,(function*(){yield _(this,Ar).afterHandshake();try{for(;;){const t=yield _(this,Ar).readMessage().catch((()=>{}));if(!t)break;yield G(this,Lr,_r).call(this,t)}}catch(t){return t}finally{_(this,Pr).cancel("closing")}}))},zr=function(){return z(this,null,(function*(){var t;try{for(;;){const e=yield _(this,Ar).objectStream();if(!e)break;yield null==(t=this.subscriber)?void 0:t.onObjectReader(e)}}catch(t){return t}}))},qr=function(){this.close()},Gr=P(Nr,17,"#runOutgoingMessages",Or,Lr,Gr=function(){return z(this,null,(function*(){try{try{for(var t,e,i,n=Z(_(this,Pr));t=!(e=yield n.next()).done;t=!1){const t=e.value;_(this,jr).debug("sending message",t),yield _(this,Ar).writeMessage(t)}}catch(e){i=[e]}finally{try{t&&(e=n.return)&&(yield e.call(n))}finally{if(i)throw i[0]}}}catch(t){return t}}))}),Fr=P(Nr,17,"#runControl",xr,Lr,Fr),zr=P(Nr,17,"#runObjects",Vr,Lr,zr),qr=P(Nr,17,"#dispose",Dr,Lr,qr),A(Nr,js);class Cs{constructor(t,e,i){R(this,Jr),R(this,Hr),R(this,$r),R(this,Zr,!0),R(this,Xr,!1),R(this,Yr),N(this,Hr,t),N(this,$r,e),N(this,Yr,i)}writeUnsigned8(t){return z(this,null,(function*(){return G(this,Jr,Kr).call(this),yield G(this,Jr,Qr).call(this),_(this,Hr).writeUnsigned8(t)}))}writeVarInt(t){return z(this,null,(function*(){return G(this,Jr,Kr).call(this),yield G(this,Jr,Qr).call(this),_(this,Hr).writeVarInt(t)}))}writeBigVarInt(t){return z(this,null,(function*(){return G(this,Jr,Kr).call(this),yield G(this,Jr,Qr).call(this),_(this,Hr).writeBigVarInt(t)}))}write(t){return z(this,null,(function*(){return G(this,Jr,Kr).call(this),yield G(this,Jr,Qr).call(this),_(this,Hr).write(t)}))}writeString(t){return z(this,null,(function*(){return G(this,Jr,Kr).call(this),yield G(this,Jr,Qr).call(this),_(this,Hr).writeString(t)}))}flush(){return z(this,null,(function*(){G(this,Jr,Kr).call(this),N(this,Zr,!0),yield _(this,Hr).flush()}))}close(){return z(this,null,(function*(){_(this,Xr)||(N(this,Zr,!0),yield G(this,Jr,Qr).call(this,!1),yield _(this,Hr).flush(),N(this,Xr,!0),_(this,Yr).call(this))}))}}Hr=new WeakMap,$r=new WeakMap,Zr=new WeakMap,Xr=new WeakMap,Yr=new WeakMap,Jr=new WeakSet,Kr=function(){if(_(this,Xr))throw new Error("Stream is closed")},Qr=function(t=!0){if(_(this,Zr))return N(this,Zr,!1),_(this,Hr).writeUnsigned8(_(this,$r)|(t?128:0))};class Ls{constructor(t,e){R(this,os),R(this,ts),R(this,es),R(this,is),R(this,ns),R(this,rs,new Map),R(this,ss,p.L.get().createContext("WebSocketConnection")),R(this,as,new Set(new Array(128).fill(0).map(((t,e)=>e+1)))),N(this,ts,t),N(this,es,e),N(this,is,new ReadableStream(new pi(t))),_(this,ts).addEventListener("close",(()=>{_(this,rs).forEach((t=>t.close()))}))}openSendStream(){const t=_(this,as).values().next().value;if(!t)throw new Error("No stream IDs available");return _(this,as).delete(t),Promise.resolve(new Cs(new ki(_(this,ts)),t,(()=>G(this,os,cs).call(this,t))))}transportType(){return"websocket"}url(){return _(this,ts).url}afterHandshake(){return _(this,es).postHandshake()}objectStream(){return z(this,null,(function*(){for(var t;;){N(this,ns,_(this,is).getReader());try{const{value:t,done:e}=yield _(this,ns).read();if(e)return;const[i,n,r]=t;if(_(this,rs).has(tt(n))){const t=_(this,rs).get(tt(n));if(!t)throw new Error("Stream not found");r.length>0&&(yield t.push(r)),i||(_(this,ss).debug("Closing stream",{streamId:n}),t.close(),_(this,rs).delete(tt(n)))}else{_(this,ss).debug("Creating new stream",{streamId:n});const[t,e]=J(1e3),s=new ReadableStream({pull(t){return z(this,null,(function*(){const i=yield e.pop();i?t.enqueue(i):t.close()}))}});if(_(this,rs).set(tt(n),t),i||(_(this,ss).debug("Closing new stream",{streamId:n}),yield s.cancel(),_(this,rs).delete(tt(n))),r.length>0)return yield hi(new fi(r,s),n)}}finally{null==(t=_(this,ns))||t.releaseLock()}}}))}close(){var t;return _(this,es).cancel().catch(p.n),_(this,is).cancel("closing").catch(p.n),null==(t=_(this,ns))||t.cancel("closing").catch(p.n),_(this,ts).close()}closed(){return Promise.resolve()}writeMessage(t){return z(this,null,(function*(){yield _(this,es).write(t)}))}readMessage(){return z(this,null,(function*(){return _(this,es).read()}))}}ts=new WeakMap,es=new WeakMap,is=new WeakMap,ns=new WeakMap,rs=new WeakMap,ss=new WeakMap,as=new WeakMap,os=new WeakSet,cs=function(t){_(this,as).add(t)};class _s{constructor(t,e,i){R(this,ys),R(this,ls),R(this,us),R(this,hs,new K(100)),R(this,ds),R(this,ps,0),R(this,fs,p.L.get().createContext("WebTransportConnection")),N(this,ds,i),N(this,ls,t),N(this,us,e),G(this,ys,ws).call(this).catch((t=>{_(this,fs).debug("Incoming streams handling ended with error",t),_(this,hs).close()}))}openSendStream(){return z(this,null,(function*(){const t=yield _(this,ls).createUnidirectionalStream();return new yi(t)}))}transportType(){return"webtransport"}url(){return _(this,ds)}afterHandshake(){return _(this,us).postHandshake()}closed(){return z(this,null,(function*(){yield _(this,ls).closed}))}close(){_(this,ls).close()}writeMessage(t){return z(this,null,(function*(){yield _(this,us).write(t)}))}readMessage(){return z(this,null,(function*(){return _(this,us).read()}))}objectStream(){return z(this,null,(function*(){return _(this,hs).pop()}))}}function Rs(t){return z(this,null,(function*(){const e=new WebSocket(t.wsUrl||t.url);e.binaryType="arraybuffer",yield new Promise(((t,i)=>{e.addEventListener("error",i,{once:!0}),e.addEventListener("open",t,{once:!0})}));const i=kn.wrapWebsocket(e);In(i,t.role).catch((()=>{e.close()}));const n=new Ls(e,i);return new js(n,t.authToken)}))}function Ns(t){return z(this,null,(function*(){const e=new Uint8Array(32);for(let t=0;t<e.length;t+=1)e[t]=parseInt("60b82e8021689e163c1041b4475ef9c86e7565bc45d1a0aa43f5148769f461c7".slice(2*t,2*t+2),16);const i=new WebTransport(t.url,{congestionControl:"low-latency"});yield Promise.race([i.ready,i.closed.then((()=>Promise.reject(new Error("WebTransport closed"))))]);const n=yield i.createBidirectionalStream(),r=kn.wrapWebTransport(n);In(r,t.role).catch((()=>{i.close()}));const s=new _s(i,r,t.url.toString());return new js(s,t.authToken)}))}ls=new WeakMap,us=new WeakMap,hs=new WeakMap,ds=new WeakMap,ps=new WeakMap,fs=new WeakMap,ys=new WeakSet,ws=function(){return z(this,null,(function*(){const t=_(this,ls).incomingUnidirectionalStreams.getReader();for(;;){const{value:e,done:i}=yield t.read();if(i)return void _(this,hs).close();const n=new fi(new Uint8Array,e);yield _(this,hs).push(hi(n,_(this,ps))),F(this,ps)._++}}))};class Gs{constructor(){R(this,bs,{name:"",priority:0,groupOrder:"descending",filterType:{type:"latest-group"}})}name(t){return _(this,bs).name=t,this}priority(t){return _(this,bs).priority=t,this}groupOrder(t){return _(this,bs).groupOrder=t,this}startGroup(t){return _(this,bs).filterType={type:"absolute-start",start:{group:t,object:tt(0)}},this}range(t,e){return _(this,bs).filterType={type:"absolute-range",start:{group:t,object:tt(0)},end:{group:e,object:tt(0)}},this}build(){return _(this,bs)}}bs=new WeakMap;class Fs{constructor(t,e){R(this,ms),R(this,gs),N(this,ms,t),N(this,gs,e)}subscribe(t){return _(this,ms).subscribe(this.namespace(),t)}closed(){return _(this,ms).closed()}namespace(){return _(this,gs).namespace}}function zs(t){const e=t.at(1);if(!e)throw new Error("namespace must contain a channel ID");return e}ms=new WeakMap,gs=new WeakMap;const qs=class t{constructor(t,e){R(this,Ts),R(this,vs),R(this,ks),R(this,Is,new p.F(100)),R(this,Ss),R(this,Ms),R(this,Ws,(t=>z(this,null,(function*(){if(!t)return _(this,vs).close();if(_(this,Ss))return;const e=_(this,Is).items().reduce(((t,e)=>t<e?t:e),t);N(this,Ss,G(this,Ts,Us).call(this,e,t)),0===_(this,Ss).size&&(yield _(this,vs).close())})))),N(this,vs,t),N(this,ks,e),t.done().then((t=>z(this,null,(function*(){var e;return _(this,Ws).call(this,null==(e=t.finalInfo)?void 0:e.group)})))).catch(p.n),N(this,Ms,t.groups())}static subscribe(e,i){return z(this,null,(function*(){const n=yield e.subscribe(i);return new t(n,void 0)}))}subscribeId(){return _(this,vs).id}name(){return _(this,vs).name}largestGroupId(){return _(this,ks)}needsRenewal(){return"active"===_(this,vs).expiryState()&&void 0===_(this,Ss)}endOfTrack(t){const e=_(this,Is).items().reduce(((t,e)=>t<e?t:e),t);return this.update(e,t)}update(t,e){return z(this,null,(function*(){return N(this,Ss,G(this,Ts,Us).call(this,t,e)),0===_(this,Ss).size&&(yield _(this,vs).close()),_(this,vs).update(t,e)}))}unsubscribe(){return _(this,vs).unsubscribe()}next(){return z(this,null,(function*(){var t;if(_(this,Ss)&&0===_(this,Ss).size)return{done:!0,value:void 0};const e=yield _(this,Ms).next();if(e.done)return e;const i=e.value.groupId();return null==(t=_(this,Ss))||t.delete(i),_(this,Is).push(i),_(this,ks)||N(this,ks,i),N(this,ks,_(this,ks)<i?i:_(this,ks)),e}))}return(){return _(this,vs).return()}[Symbol.asyncIterator](){return this}};vs=new WeakMap,ks=new WeakMap,Is=new WeakMap,Ss=new WeakMap,Ms=new WeakMap,Ws=new WeakMap,Ts=new WeakSet,Us=function(t,e){const i=new Set;for(let n=t;n<=e;n++)null==i||i.add(n);return _(this,Is).items().forEach((t=>{null==i||i.delete(t)})),i};let Hs=qs;var $s,Zs,Xs,Ys,Js,Ks,Qs;const ta=class t{constructor(t){R(this,Js),R(this,$s),R(this,Zs),R(this,Xs,new K(10)),R(this,Ys),R(this,Qs,((t,e)=>z(this,null,(function*(){var i=[];try{const n=X(i,yield _(this,$s).lock()),r={subscribeId:n.value.subscribeId()};if(!n.value.needsRenewal())return void _(this,Ys).debug("Subscription does not need renewal",r);const s=n.value.largestGroupId(),a=void 0!==s,o=(new Gs).name(e.name).priority(e.priority).groupOrder(e.groupOrder);switch(r.largestGroupId=s,_(this,Ys).debug("Renewing subscription",r),e.filterType.type){case"absolute-range":return void _(this,Ys).debug("Absolute range is not renewed",r);case"absolute-start":case"latest-group":case"latest-object":a&&o.startGroup(s+tt(1))}const c=o.build();r.newTrack=c;const[l]=yield Promise.all([t.subscribe(c),a?n.value.update(s,s):n.value.unsubscribe()]);l.done().then((()=>G(this,Js,Ks).call(this,l))).catch(p.n),l.expiryNotification().then((()=>_(this,Qs).call(this,t,c))).catch(p.n);const u=new Hs(l,s);n.value=u,yield _(this,Xs).push(u),_(this,Ys).info("Subscription renewed",r)}catch(t){var n=t,r=!0}finally{Y(i,n,r)}})))),N(this,$s,new rt(t)),N(this,Zs,t),N(this,Ys,p.L.get().createContext(`Renewable '${t.name()}'`))}static subscribe(e,i,n){return z(this,null,(function*(){const r=yield e.subscribe(i),s=new t(new Hs(r,n));return r.done().then((()=>{var t;return G(t=s,Js,Ks).call(t,r)})).catch(p.n),r.expiryNotification().then((()=>{var t;return _(t=s,Qs).call(t,e,i)})).catch(p.n),s}))}largestGroupId(){return _(this,$s).unsafeValue().largestGroupId()}update(t,e){return z(this,null,(function*(){var i=[];try{const n=X(i,yield _(this,$s).lock());return _(this,Xs).close(),n.value.update(t,e)}catch(t){var n=t,r=!0}finally{Y(i,n,r)}}))}endOfTrack(t){return z(this,null,(function*(){var e=[];try{const i=X(e,yield _(this,$s).lock());return _(this,Xs).close(),i.value.endOfTrack(t)}catch(t){var i=t,n=!0}finally{Y(e,i,n)}}))}unsubscribe(){return z(this,null,(function*(){var t=[];try{const e=X(t,yield _(this,$s).lock());return _(this,Xs).close(),e.value.unsubscribe()}catch(t){var e=t,i=!0}finally{Y(t,e,i)}}))}return(){return z(this,null,(function*(){var t=[];try{const e=X(t,yield _(this,$s).lock());return _(this,Xs).close(),e.value.return()}catch(t){var e=t,i=!0}finally{Y(t,e,i)}}))}next(){return z(this,null,(function*(){var t,e;const i=yield _(this,Zs).next();if(i.done){yield null==(e=(t=_(this,Zs)).return)?void 0:e.call(t);const i=yield _(this,Xs).pop();if(i)return N(this,Zs,i),this.next()}return i}))}[Symbol.asyncIterator](){return this}objects(){return H(this,null,(function*(){try{for(var t,e,i,n=Z(this);t=!(e=yield new q(n.next())).done;t=!1){var r=e.value,s=[];try{const t=X(s,r,!0);yield*$(t)}catch(t){var a=t,o=!0}finally{var c=Y(s,a,o);c&&(yield new q(c))}}}catch(e){i=[e]}finally{try{t&&(e=n.return)&&(yield new q(e.call(n)))}finally{if(i)throw i[0]}}}))}};$s=new WeakMap,Zs=new WeakMap,Xs=new WeakMap,Ys=new WeakMap,Js=new WeakSet,Ks=function(t){return z(this,null,(function*(){var e;if(t.unsubscribed()||null!=(e=t.range())&&e.endGroup)_(this,Ys).info("Server initiated subscribe done but the subscription is already closing");else{if(_(this,$s).unsafeValue().subscribeId()===t.id)return this.return();_(this,Ys).info("subscribeId mismatch - the subscription already has been renewed")}}))},Qs=new WeakMap;let ea=ta;function ia(t){const e=function(t){const e=(new TextDecoder).decode(t);return JSON.parse(e)}(t.payload);if(!function(t){return"tracks"in t}(e))throw new Error("unexpected catalog type");return e}var na,ra,sa,aa,oa,ca;na=new WeakMap,ra=new WeakMap,sa=new WeakMap,aa=new WeakMap,oa=new WeakSet,ca=function(){return z(this,null,(function*(){const t=yield _(this,sa).promise;try{for(var e,i,n,r=Z(t);e=!(i=yield r.next()).done;e=!1){const t=i.value;if(0!==t.objectStatus)continue;const e=ia(t);_(this,na).update(e)}}catch(i){n=[i]}finally{try{e&&(i=r.return)&&(yield i.call(r))}finally{if(n)throw n[0]}}}))};let la=class t{constructor(t,e,i){R(this,oa),R(this,na),R(this,ra),R(this,sa),R(this,aa),N(this,ra,t),N(this,na,e),N(this,sa,i),N(this,aa,G(this,oa,ca).call(this))}catalog(){return _(this,na)}closed(){return _(this,aa)}close(){return z(this,null,(function*(){return _(this,na).close(),(yield _(this,ra).promise).unsubscribe()}))}static start(e,i){return z(this,null,(function*(){const n=p.D.fromPromise(ea.subscribe(e,(new Gs).name(i.catalogName||"catalog").groupOrder("ascending").build())),r=p.D.fromPromise(n.promise.then((t=>t.objects())));if(i.catalog)return new t(n,new st(i.catalog),r);const s=yield(yield r.promise).next();if(!s.value)throw new Error("No catalog found");const a=ia(s.value);return new t(n,new st(a),r)}))}};var ua,ha,da,pa,fa,ya,wa,ba,ma,ga,va,ka;class Ia{constructor(t,e,i,n){R(this,fa),R(this,ua),R(this,ha),R(this,da),j(this,"track"),R(this,pa,p.L.get().createContext("CmafGroup")),this.track=n,N(this,ua,i),N(this,ha,t),N(this,da,e)}[Symbol.asyncIterator](){return H(this,null,(function*(){const t={name:this.track.trackObject.name,namespace:this.track.namespace};_(this,pa).debug("start",T({},t));try{for(var e,i,n,r=Z(_(this,ha));e=!(i=yield new q(r.next())).done;e=!1){const e=i.value;if(4===e.objectStatus&&(yield new q(this.track.endOfTrack(e.groupId))),0!==e.objectStatus)continue;const n=_(this,da).createFragment(e.payload),r=n.timescale(),s=n.baseMediaDecodeTime()/r*1e3,a=s+n.duration()/r*1e3,o=_(this,ua)/1e3*r;n.updateBaseMediaDecodeTime(n.baseMediaDecodeTime()-o);const c=this.track.timestampRange();if(c&&s>=c[1])break;_(this,pa).debug("fragment",U(T({},t),{startTime:s,endTime:a,subscribeId:e.subscribeId,groupId:e.groupId,objectId:e.objectId,streamId:e.streamId})),yield[e.groupId,n]}}catch(i){n=[i]}finally{try{e&&(i=r.return)&&(yield new q(i.call(r)))}finally{if(n)throw n[0]}}_(this,pa).debug("end",T({},t))}))}[et()](){return G(this,fa,ya).call(this)}[Symbol.asyncDispose](){return G(this,fa,ya).call(this)}}ua=new WeakMap,ha=new WeakMap,da=new WeakMap,pa=new WeakMap,fa=new WeakSet,ya=function(){return z(this,null,(function*(){var t,e;return yield null==(e=(t=_(this,ha)).return)?void 0:e.call(t),Promise.resolve()}))};const Sa=class t{constructor(t,e,i,n,r){R(this,wa),R(this,ba),R(this,ma),R(this,ga),j(this,"trackObject"),j(this,"namespace"),this.trackObject=t,this.namespace=e,N(this,ba,i),N(this,wa,n),N(this,ma,r)}static subscribe(e,i,n,r){return z(this,null,(function*(){var s;if("cmaf"!==i.format)throw new Error("format must be cmaf");const a=(new Gs).name(i.name);r&&a.startGroup(r);const o=a.build();if(i.initTrack){const a=(new Gs).name(i.initTrack).build(),[c,l]=yield Promise.all([G(s=t,va,ka).call(s,e,a),ea.subscribe(e,o,r?r-tt(1):void 0)]),u=new ue(c);return new t(i,e.namespace(),l,u,n)}(0,f.a)(i.initData,"no init data found on track");const c=Q(i.initData),l=new ue(new Uint8Array(c)),u=yield ea.subscribe(e,o,r?r-tt(1):void 0);return new t(i,e.namespace(),u,l,n)}))}largestGroupId(){return _(this,ba).largestGroupId()}stopAfterTimestampReached(t){N(this,ga,[0,t])}timestampRange(){return _(this,ga)}endOfTrack(t){return _(this,ba).endOfTrack(t)}update(t,e){return _(this,ba).update(t,e)}unsubscribe(){return z(this,null,(function*(){return _(this,ba).unsubscribe()}))}next(){return z(this,null,(function*(){const t=yield _(this,ba).next();return t.done?t:{done:!1,value:new Ia(t.value,_(this,wa),_(this,ma),this)}}))}return(){return z(this,null,(function*(){return yield _(this,ba).return(),{done:!0,value:void 0}}))}[Symbol.asyncIterator](){return this}[et()](){return this.unsubscribe()}[Symbol.asyncDispose](){return z(this,null,(function*(){return this.unsubscribe()}))}};wa=new WeakMap,ba=new WeakMap,ma=new WeakMap,ga=new WeakMap,va=new WeakSet,ka=function(t,e){return z(this,null,(function*(){var i=[];try{const n=X(i,yield t.subscribe(e),!0),r=yield n.objects().next();if(r.done)throw new Error("No init object");return yield n.close(),r.value.payload}catch(t){var n=t,r=!0}finally{var s=Y(i,n,r);s&&(yield s)}}))},R(Sa,va);let Ma=Sa;var Wa,Ta,Ua,Ea,Da,Va,xa,Oa,Aa;Wa=new WeakMap,Ta=new WeakMap,Ua=new WeakMap,Ea=new WeakMap,Da=new WeakMap,Va=new WeakMap,xa=new WeakSet,Oa=function(t){return z(this,null,(function*(){const e=yield t.promise;try{for(var i,n,r,s=Z(e);i=!(n=yield s.next()).done;i=!1){var a=n.value,o=[];try{const t=X(o,a,!0);try{for(var c,l,u,h=Z(t);c=!(l=yield h.next()).done;c=!1){const t=l.value;if(0!==t.objectStatus)continue;const i=Pa(t.payload);_(this,Ta).update((t=>{var e,n;for(t.push(...i),t.sort(((t,e)=>t.wallclock-e.wallclock));t[0]&&(null!=(n=null==(e=t[t.length-1])?void 0:e.wallclock)?n:0)-t[0].wallclock>3e4;)t.shift();return t})),e===_(this,Ua).resolved&&t.groupId>tt(0)&&t.objectId==tt(0)&&G(this,xa,Aa).call(this,t.groupId).catch((t=>{_(this,Wa).warn("backfill failed",t)}))}}catch(l){u=[l]}finally{try{c&&(l=h.return)&&(yield l.call(h))}finally{if(u)throw u[0]}}}catch(t){var d=t,p=!0}finally{var f=Y(o,d,p);f&&(yield f)}}}catch(n){r=[n]}finally{try{i&&(n=s.return)&&(yield n.call(s))}finally{if(r)throw r[0]}}}))},Aa=function(t){return z(this,null,(function*(){const e=t-tt(1),i=this.timeline(),n=i[0],r=i[i.length-1];if(!n||!r||r.wallclock-n.wallclock>1e4)return;const s=p.D.fromPromise(ea.subscribe(_(this,Ea),(new Gs).name(_(this,Da)).groupOrder("ascending").range(e,e).build()));return G(this,xa,Oa).call(this,s)}))};let Ba=class t{constructor(t,e,i){R(this,xa),R(this,Wa,p.L.get().createContext("Timeline")),R(this,Ta,new st([])),R(this,Ua),R(this,Ea),R(this,Da),R(this,Va),N(this,Ea,t),N(this,Da,i),N(this,Ua,e),N(this,Va,G(this,xa,Oa).call(this,_(this,Ua))),this.closed().finally((()=>_(this,Ta).close())).catch(p.n)}closed(){return _(this,Va)}close(){return z(this,null,(function*(){return(yield _(this,Ua).promise).unsubscribe()}))}timeline(){const[t,e]=_(this,Ta).value();return t}timestampWallclockOffset(){return(0,p.a)(this.timeline().map((t=>t.mediaPts-t.wallclock)))}static start(e,i){const n=p.D.fromPromise(ea.subscribe(e,(new Gs).name(i).groupOrder("ascending").build()));return new t(e,n,i)}waitForWallclockTime(t){return z(this,null,(function*(){return yield _(this,Ta).waitFor((e=>!!e.find((e=>e.wallclock>=t)))),this.timeline()}))}waitForTimelineToHaveMinDuration(){return z(this,null,(function*(){return yield _(this,Ta).waitFor((t=>{const e=t[0],i=t[t.length-1];return!(!e||!i)&&i.wallclock-e.wallclock>1e4})),this.timeline()}))}};function Pa(t){var e;const i=new TextDecoder("utf-8").decode(t).split("\n");return null!=(e=i[0])&&e.startsWith("MEDIA_PTS")&&i.shift(),i.filter((t=>t.length>0)).map((t=>{const[e,i,n,r,s]=t.split(",");if(!e||!r)throw new Error(`invalid timeline row: ${t}`);return{mediaPts:parseInt(e),groupId:i?parseInt(i):void 0,objectId:n?parseInt(n):void 0,wallclock:parseInt(r),metadata:s}}))}var ja,Ca,La,_a;const Ra=class t{constructor(t,e,i,n,r){R(this,ja,new p.W),R(this,Ca),R(this,La),R(this,_a,0),j(this,"trackObject"),j(this,"namespace"),N(this,La,t),N(this,Ca,e),this.trackObject=i,this.namespace=n,N(this,_a,r)}static subscribe(e,i,n){return z(this,null,(function*(){if("string"!=typeof i.language)throw new Error("track object language is required");const r=(new Gs).name(i.name).build(),s=yield ea.subscribe(e,r),a=s.objects();return new t(s,a,i,e.namespace(),n)}))}largestGroupId(){return _(this,La).largestGroupId()}update(t,e){return _(this,La).update(t,e)}unsubscribe(){return _(this,La).unsubscribe()}next(){return z(this,null,(function*(){for(;;){const t=yield _(this,Ca).next();if(t.done)return t;if(0!==t.value.objectStatus)continue;const e=(new TextDecoder).decode(t.value.payload),i=_(this,ja).parse(e).map((t=>(t.startTime-=_(this,_a)/1e3,t.endTime-=_(this,_a)/1e3,t)));return{done:!1,value:{language:this.trackObject.language,cues:i}}}}))}return(){return z(this,null,(function*(){return yield _(this,La).return(),{done:!0,value:void 0}}))}[Symbol.asyncIterator](){return this}[et()](){return this.unsubscribe()}[Symbol.asyncDispose](){return this.unsubscribe()}};ja=new WeakMap,Ca=new WeakMap,La=new WeakMap,_a=new WeakMap;let Na=Ra;var Ga,Fa,za,qa,Ha,$a,Za,Xa;Ga=[(0,p.i)({context:"Channel",enter:"info"})];const Ya=class t{constructor(t,e,i,n,r){R(this,Za),j(this,"namespace"),R(this,Fa),R(this,za),R(this,qa),R(this,Ha),this.namespace=n,N(this,Fa,t),N(this,za,e),N(this,qa,i),N(this,Ha,r)}static start(e,i){return z(this,null,(function*(){const n=new Fs(e,{namespace:i.namespace}),[r,s]=yield Promise.all([Ba.start(n,"timeline"),la.start(n,{catalog:i.catalog,namespace:i.namespace})]);return new t(n,r,s,i.namespace,0)}))}closed(){return _(this,qa).closed()}catalog(){return _(this,qa).catalog()}timestampWallclockOffset(){return _(this,za).timestampWallclockOffset()}timestampOffsetMs(){return _(this,Ha)}setTimestampOffsetMs(t){N(this,Ha,t)}waitForWallclockTime(t){return _(this,za).waitForWallclockTime(t)}subscribeCmafTrack(t,e){const i=this.catalog().current().tracks.find((e=>e["com.vindral.variant_uid"]===t["com.vindral.variant_uid"]));return G(this,Za,Xa).call(this,(()=>Ma.subscribe(_(this,Fa),null!=i?i:t,_(this,Ha),e)))}subscribeWebVttTrack(t){return G(this,Za,Xa).call(this,(()=>Na.subscribe(_(this,Fa),t,_(this,Ha))))}subscribeTrack(t){return G(this,Za,Xa).call(this,(()=>_(this,Fa).subscribe(t)))}close(){return Promise.all([_(this,qa).close(),_(this,za).close()])}};$a=D(null),Fa=new WeakMap,za=new WeakMap,qa=new WeakMap,Ha=new WeakMap,Za=new WeakSet,Xa=function(t){return z(this,null,(function*(){const[e,i]=this.catalog().value();try{return yield t()}catch(n){if(e===this.catalog().current()&&i&&(yield Promise.race([i,(0,p.w)(500)])),e!==this.catalog().current())return t();throw n}}))},P($a,9,"start",Ga,Ya),A($a,Ya),B($a,3,Ya);let Ja=Ya;var Ka,Qa,to,eo;Ka=new WeakMap,Qa=new WeakMap,to=new WeakSet,eo=function(t){return z(this,null,(function*(){try{for(var e,i,n,r=Z(t.value);e=!(i=yield r.next()).done;e=!1){const t=i.value;N(this,Ka,{createdAt:new Date,wallclock:new Date(t.ntpTimestamp),rtt:t.rtt})}}catch(i){n=[i]}finally{try{e&&(i=r.return)&&(yield i.call(r))}finally{if(n)throw n[0]}}}))};let io=class t{constructor(t){R(this,to),R(this,Ka),R(this,Qa);const[e,i]=t.value.value();N(this,Ka,{createdAt:new Date,wallclock:new Date(e.ntpTimestamp),rtt:e.rtt}),N(this,Qa,G(this,to,eo).call(this,t))}wallclock(){const t=Date.now()-_(this,Ka).createdAt.getTime();return _(this,Ka).wallclock.getTime()+t}closed(){return _(this,Qa)}static start(e){return new t(e)}};function no(t){return"string"==typeof t||null==t}function ro(t){try{return Q(t)}catch(t){throw new Error("Failed to convert fairplayCertificate")}}class so{constructor(t){j(this,"value"),this.value=t}static create(t,e,i){return z(this,null,(function*(){var n=[];try{const r=X(n,yield t.subscribeTrack((new Gs).name("drm").build()),!0).objects(),s=yield r.next();if(s.done)throw new Error("No drm object received");const a=function(t){const e=(new TextDecoder).decode(t),i=JSON.parse(e);if(!function(t){return"provider"in t&&"string"==typeof t.provider&&(!("widevineLicenseUrl"in t)||no(t.widevineLicenseUrl))&&(!("playreadyLicenseUrl"in t)||no(t.playreadyLicenseUrl))&&(!("fairplayLicenseUrl"in t)||no(t.fairplayLicenseUrl))&&(!("fairplayCertificate"in t)||no(t.fairplayCertificate))}(i))throw new Error("Invalid drm object");const n=i,{fairplayCertificate:r}=n,s=((t,e)=>{var i={};for(var n in t)k.call(t,n)&&e.indexOf(n)<0&&(i[n]=t[n]);if(null!=t&&v)for(var n of v(t))e.indexOf(n)<0&&I.call(t,n)&&(i[n]=t[n]);return i})(n,["fairplayCertificate"]);return U(T({},s),{fairplayCertificate:r?ro(r):void 0})}(s.value.payload);return new so(U(T({},a),{videoCodec:e,audioCodec:i}))}catch(t){var r=t,s=!0}finally{var a=Y(n,r,s);a&&(yield a)}}))}}function ao(t){const e=(new TextDecoder).decode(t),i=JSON.parse(e);if(!function(t){return"rtt"in t&&"number"==typeof t.rtt&&"ntpTimestamp"in t&&"number"==typeof t.ntpTimestamp&&"estimatedBandwidth"in t&&"number"==typeof t.estimatedBandwidth}(i))throw new Error("Invalid stats object");return i}var oo,co,lo;oo=new WeakMap,co=new WeakSet,lo=function(t){return z(this,null,(function*(){try{for(var e,i,n,r=Z(t);e=!(i=yield r.next()).done;e=!1){const t=i.value;if(0!==t.objectStatus)continue;const e=ao(t.payload);this.value.update(e)}}catch(i){n=[i]}finally{try{e&&(i=r.return)&&(yield i.call(r))}finally{if(n)throw n[0]}}}))};let uo=class t{constructor(t,e,i){R(this,co),j(this,"ip"),j(this,"value"),R(this,oo),this.ip=i,this.value=new st(e),N(this,oo,G(this,co,lo).call(this,t))}closed(){return _(this,oo)}idleTimeout(){return z(this,null,(function*(){for(;;){const[t,e]=this.value.value();try{yield Promise.race([(0,p.t)(1e4,new Error("Idle timeout")),e])}catch(t){return t}}}))}static start(e){return z(this,null,(function*(){const i=(yield e.subscribe((new Gs).name("stats").groupOrder("ascending").build())).objects(),n=yield i.next();if(n.done)throw new Error("No stats object received");const r=ao(n.value.payload);if(!r.ip)throw new Error("Expected IP in initial stats object");return new t(i,r,r.ip)}))}};var ho,po,fo,yo,wo,bo,mo,go,vo,ko,Io,So,Mo,Wo,To,Uo,Eo,Do,Vo,xo,Oo,Ao,Bo;class Po{constructor(t){R(this,ho,p.L.get().createContext("UpstreamWatcher")),R(this,po),N(this,po,new st(p.D.fromPromise(t.closed())))}update(t){_(this,po).update(p.D.fromPromise(t.closed()))}closed(){return z(this,null,(function*(){try{for(;;){const[t,e]=_(this,po).value();let i=!1;yield Promise.race([null==e?void 0:e.then((()=>i=!0)),t.promise.then((()=>{if(!i)throw _(this,ho).warn("Upstream closed"),new Error("Upstream closed")}))])}}catch(t){return t}}))}}ho=new WeakMap,po=new WeakMap;class jo{constructor(t,e){R(this,fo,p.L.get().createContext("TracksIterator")),R(this,yo),R(this,wo),N(this,yo,t),N(this,wo,e)}[Symbol.asyncIterator](){return H(this,null,(function*(){const t=_(this,wo);try{for(var e,i,n,r=Z(_(this,yo));e=!(i=yield new q(r.next())).done;e=!1){const e=i.value;if(!e)continue;const n={name:e.trackObject.name,namespace:e.namespace};_(this,fo).debug("track start",T({mediaType:t},n)),yield*$(e),_(this,fo).debug("track end",T({mediaType:t},n))}}catch(i){n=[i]}finally{try{e&&(i=r.return)&&(yield new q(i.call(r)))}finally{if(n)throw n[0]}}_(this,fo).debug("tracks ended",{mediaType:t})}))}}fo=new WeakMap,yo=new WeakMap,wo=new WeakMap,go=[(0,p.i)({context:"Player",enter:"info"})],mo=[(0,p.i)({context:"Player",enter:"info",return:"info"})],bo=[(0,p.i)({context:"Player",enter:"info"})];const Co=class t{constructor(t,e,i){B(Do,5,this),R(this,Vo),R(this,vo),R(this,ko),R(this,Io),R(this,So),R(this,Mo,new st(void 0)),R(this,Wo,new st(void 0)),R(this,To,new st(void 0)),R(this,Uo),R(this,Eo),j(this,"subtitles",new jo(_(this,To),"subtitles")),j(this,"video",new jo(_(this,Wo),"video")),j(this,"audio",new jo(_(this,Mo),"audio")),N(this,vo,t),N(this,ko,io.start(i)),N(this,Io,i),N(this,So,new st(e)),N(this,Uo,new Po(e)),N(this,Eo,Promise.race([i.idleTimeout(),G(this,Vo,Ao).call(this),_(this,Uo).closed()])),_(this,vo).closed().then((()=>this.close())).catch(p.n)}closed(){return _(this,Eo)}static start(e,i){return z(this,null,(function*(){const n=new Fs(e,{namespace:("auxiliary",["com.vindral.moq","auxiliary"])}),[[r,s,a],o]=yield Promise.all([Ja.start(e,i).then((t=>Promise.all([Promise.resolve(t),i.videoTrack?t.subscribeCmafTrack(i.videoTrack):void 0,i.audioTrack?t.subscribeCmafTrack(i.audioTrack):void 0]))),uo.start(n)]),c=new t(e,r,o);return a&&_(c,Mo).update(a),s&&_(c,Wo).update(s),c}))}connectionInfo(){const t=_(this,Io).value.current();return{ip:_(this,Io).ip,rtt:t.rtt,estimatedBandwidth:t.estimatedBandwidth}}stats(){return _(this,Io).value}catalog(){return _(this,So).current().catalog()}namespace(){return _(this,So).current().namespace}videoTrack(){var t;return null==(t=_(this,Wo).current())?void 0:t.trackObject}audioTrack(){var t;return null==(t=_(this,Mo).current())?void 0:t.trackObject}referenceClock(){return _(this,ko)}drm(){return z(this,null,(function*(){var t,e;if(this.catalog().current().tracks.find((({name:t})=>"drm"===t)))return so.create(_(this,So).current(),null==(t=this.videoTrack())?void 0:t.codec,null==(e=this.audioTrack())?void 0:e.codec)}))}close(){return Promise.all([_(this,So).current().close(),_(this,So).close(),G(this,Vo,xo).call(this,_(this,Mo)),G(this,Vo,xo).call(this,_(this,Wo)),G(this,Vo,xo).call(this,_(this,To))])}zap(t,e){return z(this,null,(function*(){var i,n;const r=yield Ja.start(_(this,vo),t),s=_(this,ko).wallclock()-e,a=_(this,So).current(),o=a.timestampWallclockOffset(),c=yield r.waitForWallclockTime(s);_(this,Uo).update(r),yield _(this,So).current().close();const l=c.toReversed().find((t=>t.wallclock<=s)),u=null!=l&&l.mediaPts?l.mediaPts-a.timestampOffsetMs():void 0,h=r.timestampWallclockOffset()-o+a.timestampOffsetMs();r.setTimestampOffsetMs(h);const d=null!=l&&l.groupId?tt(l.groupId):void 0;u&&(null==(i=_(this,Wo).current())||i.stopAfterTimestampReached(u),null==(n=_(this,Mo).current())||n.stopAfterTimestampReached(u)),_(this,So).update(r),yield Promise.all([t.videoTrack?this.setVideoTrack(t.videoTrack,d):void 0,t.audioTrack?this.setAudioTrack(t.audioTrack,d):void 0])}))}setSubtitleTrack(t){return z(this,null,(function*(){var e,i;if(!t)return void(yield null==(e=_(this,To).current())?void 0:e.unsubscribe());const[n]=yield Promise.all([_(this,So).current().subscribeWebVttTrack(t),null==(i=_(this,To).current())?void 0:i.unsubscribe()]);_(this,To).update(n)}))}setVideoTrack(t,e){return z(this,null,(function*(){const i=yield G(this,Vo,Oo).call(this,_(this,So).current(),t,_(this,Wo).current(),e);_(this,Wo).update(i)}))}setAudioTrack(t,e){return z(this,null,(function*(){const i=yield G(this,Vo,Oo).call(this,_(this,So).current(),t,_(this,Mo).current(),e);_(this,Mo).update(i)}))}};Do=D(null),vo=new WeakMap,ko=new WeakMap,Io=new WeakMap,So=new WeakMap,Mo=new WeakMap,Wo=new WeakMap,To=new WeakMap,Uo=new WeakMap,Eo=new WeakMap,Vo=new WeakSet,xo=function(t){const e=t.current(),i=null==e?void 0:e.largestGroupId();return t.isClosed()||t.update(void 0),t.close(),i?null==e?void 0:e.update(i,i):null==e?void 0:e.unsubscribe()},Oo=function(t,e,i,n){return z(this,null,(function*(){const r=null==i?void 0:i.largestGroupId(),[s,a]=yield Promise.all([t.subscribeCmafTrack(e,n||(r?r+tt(1):void 0)),r?null==i?void 0:i.update(r,r):null==i?void 0:i.unsubscribe()]);return s}))},Ao=function(){return z(this,null,(function*(){try{for(var t,e,i,n=Z(_(this,So));t=!(e=yield n.next()).done;t=!1){const t=e.value;try{for(var r,s,a,o=Z(t.catalog());r=!(s=yield o.next()).done;r=!1){const t=s.value;yield Promise.all([G(this,Vo,Bo).call(this,t,_(this,Wo)),G(this,Vo,Bo).call(this,t,_(this,Mo))])}}catch(s){a=[s]}finally{try{r&&(s=o.return)&&(yield s.call(o))}finally{if(a)throw a[0]}}}}catch(e){i=[e]}finally{try{t&&(e=n.return)&&(yield e.call(n))}finally{if(i)throw i[0]}}}))},Bo=function(t,e){return z(this,null,(function*(){const i=e.current();if(!i)return;const n=i.trackObject.name,r=i.trackObject["com.vindral.variant_uid"],s=t.tracks.find((t=>t.name===n)),a=t.tracks.find((t=>t["com.vindral.variant_uid"]===r));if(!s){if(!a)return void e.update(void 0);e.update(yield _(this,So).current().subscribeCmafTrack(a))}}))},P(Do,1,"close",go,Co),P(Do,1,"zap",mo,Co),Oo=P(Do,17,"#replaceTrack",bo,Vo,Oo),A(Do,Co);let Lo=Co;function _o(t,e,i){const n=new URL("/voq/subscribe",t);return n.searchParams.set("sessionId",e.sessionId),n.searchParams.set("clientId",e.clientId),n.searchParams.set("channelId",e.channelId),i&&n.searchParams.set("authToken",i),n}var Ro,No,Go,Fo,zo,qo,Ho,$o,Zo,Xo,Yo,Jo,Ko,Qo,tc,ec,ic,nc,rc,sc,ac,oc;Ro=new WeakMap,No=new WeakMap,Go=new WeakMap,Fo=new WeakMap,zo=new WeakMap,qo=new WeakMap,Ho=new WeakMap,$o=new WeakMap,Zo=new WeakMap,Xo=new WeakMap,Yo=new WeakMap,Jo=new WeakMap,Ko=new WeakSet,Qo=function(){return z(this,null,(function*(){try{for(var t,e,i,n=Z(_(this,Ho).stats());t=!(e=yield n.next()).done;t=!1){const{rtt:t}=e.value;_(this,Xo).push(t)}}catch(e){i=[e]}finally{try{t&&(e=n.return)&&(yield e.call(n))}finally{if(i)throw i[0]}}}))},tc=new WeakMap,ec=new WeakMap,ic=new WeakMap,nc=function(t){return z(this,null,(function*(){var e;const i=yield _(this,Zo).connect({channelId:t});if(!(0,f.i)(i))throw new Error("no moq connect info found");const n=null==(e=i.channels.find((e=>e.channelId===t)))?void 0:e.catalog;if(!n)throw new Error("no catalog found");return n}))},rc=function(t){return z(this,null,(function*(){var e,i,n;_(this,No).info("handle subscription",t);const r=_(this,Ho);let s=_(this,$o).get(t.channelId);if(s||(s=new pc(new st(yield G(this,Ko,nc).call(this,t.channelId))),_(this,$o).set(t.channelId,s)),r.namespace().join("/")!==s.namespace().join("/")){_(this,No).info("changing channel",t.channelId);const i=s.getVideoTrack(t.video),n=s.getAudioTrack(t.audio);return yield r.zap({namespace:s.namespace(),catalog:s.catalog(),videoTrack:null==i?void 0:i.track,audioTrack:null==n?void 0:n.track},500),_(this,No).info("switched channel",t.channelId),null==(e=_(this,$o).get(zs(r.namespace())))||e.updateCatalog(r.catalog()),void _(this,Ro).emit("received signal",{type:"subscription changed",subscription:t})}const a=s.getVideoTrack(t.video),o=s.getAudioTrack(t.audio);yield Promise.all([a&&a.track.name!==(null==(i=_(this,Ho).videoTrack())?void 0:i.name)?_(this,Ho).setVideoTrack(a.track):void 0,o&&o.track.name!==(null==(n=_(this,Ho).audioTrack())?void 0:n.name)?_(this,Ho).setAudioTrack(o.track):void 0]),_(this,Ro).emit("received signal",{type:"subscription changed",subscription:t})}))},sc=function(){return z(this,null,(function*(){try{N(this,Fo,"connecting"),_(this,No).info("Connecting..."),N(this,qo,Date.now()),_(this,zo)||N(this,zo,_(this,qo)),N(this,Fo,"connected"),yield Promise.all([G(this,Ko,oc).call(this,_(this,Ho).referenceClock(),_(this,Ho).audio),G(this,Ko,oc).call(this,_(this,Ho).referenceClock(),_(this,Ho).video),G(this,Ko,ac).call(this,_(this,Ho).subtitles)]),yield _(this,Ho).closed(),_(this,Go).close(),_(this,No).info("Session closed")}catch(t){_(this,No).warn("Session error",t)}}))},ac=function(t){return z(this,null,(function*(){try{for(var e,i,n,r=Z(t);e=!(i=yield r.next()).done;e=!1){const t=i.value;_(this,Ro).emit("text track data",t)}}catch(i){n=[i]}finally{try{e&&(i=r.return)&&(yield i.call(r))}finally{if(n)throw n[0]}}}))},oc=function(t,e){return z(this,null,(function*(){let i="",n="";try{for(var r,s,a,o=Z(e);r=!(s=yield o.next()).done;r=!1){const e=s.value,r=zs(e.track.namespace),a=e.track.trackObject.language;try{for(var c,l,u,h=Z(e);c=!(l=yield h.next()).done;c=!1){const[s,o]=l.value;""!==i&&i!==r&&"video"===o.mediaType()&&_(this,Ro).emit("add event",{type:"channel switch",channelId:r,timestamp:o.baseMediaDecodeTime()/o.timescale()*1e3}),i=r,""!==n&&a&&n!==a&&"audio"===o.mediaType()&&_(this,Ro).emit("add event",{type:"language switch",language:a,timestamp:o.baseMediaDecodeTime()/o.timescale()*1e3}),n=a;const c=o.producerReferenceTime(),u=_(this,Jo).get(e.track.namespace)||0;if(c&&Date.now()-u>1e3){_(this,Jo).set(e.track.namespace,Date.now());const i=t.wallclock()-c.getTime();_(this,No).info("ti",{medaiType:o.mediaType(),referenceClock:t,delta:i,groupId:s,timestamp:o.baseMediaDecodeTime()/o.timescale()*1e3+i,wallclockTime:c.getTime()}),_(this,Ro).emit("received signal",{type:"timing info",timingInfo:{channelId:r,timestamp:o.baseMediaDecodeTime()/o.timescale()*1e3+i,wallclockTime:c.getTime()}})}_(this,Ro).emit("received moq data",{payload:o,channelId:r,groupId:s,renditionId:(d=e.track.trackObject.name,d.split("").reduce(((t,e)=>e.charCodeAt(0)+(t<<6)+(t<<16)-t),0))})}}catch(l){u=[l]}finally{try{c&&(l=h.return)&&(yield l.call(h))}finally{if(u)throw u[0]}}}}catch(s){a=[s]}finally{try{r&&(s=o.return)&&(yield s.call(o))}finally{if(a)throw a[0]}}var d}))};let cc=class t{constructor(t,e,i,n,r,s){R(this,Ko),R(this,Ro),R(this,No),R(this,Go),R(this,Fo,"disconnected"),R(this,zo),R(this,qo),R(this,Ho),R(this,$o,new Map),R(this,Zo),R(this,Xo,new p.F(10)),R(this,Yo,Number.MAX_SAFE_INTEGER),R(this,Jo,new Map),R(this,tc,(t=>{if(!t)return void _(this,Ho).setSubtitleTrack(void 0).catch(p.n);const e=_(this,$o).get(zs(_(this,Ho).namespace())),i=null==e?void 0:e.getTextTrack(t);i&&_(this,Ho).setSubtitleTrack(i).catch(p.n)})),R(this,ec,(t=>{switch(t.type){case"subscribe":if(_(this,ic))return void _(this,No).info("Ignoring  - we are already switching");N(this,ic,!0),G(this,Ko,rc).call(this,t.subscription).catch((e=>{_(this,No).error("error handling subscription",e),_(this,Ro).emit("received signal",{type:"subscription changed",subscription:t.subscription,reset:!0})})).finally((()=>N(this,ic,!1)));break;case"telemetry":(0,f.p)(new URL("/api/telemetry",_(this,Go).url().replace("wss://","https://")),{body:t.body,headers:{"Content-Type":"text/plain"}}).catch(p.n);break;case"refresh auth":_(this,Go).updateAuthToken(t.token)}})),R(this,ic,!1),j(this,"disconnect",((t="Disconnect Requested")=>{_(this,No).info("Disconnecting",t),_(this,Go).close(),_(this,Ho).close().catch(p.n),N(this,Jo,new Map),N(this,Fo,"disconnected")})),N(this,Ro,t),N(this,No,e),N(this,Go,i),N(this,Ho,n),N(this,$o,r),N(this,Zo,s),_(this,Ro).on("send signal",_(this,ec)),_(this,Ro).on("disconnect",this.disconnect),_(this,Ro).on("text track",_(this,tc)),G(this,Ko,Qo).call(this).catch(p.n),G(this,Ko,sc).call(this).catch(p.n)}get estimatedBandwidth(){return _(this,Yo)}get firstConnectionTime(){return _(this,zo)}get lastConnectionTime(){return _(this,qo)}unload(){_(this,Ro).off("send signal",_(this,ec)),_(this,Ro).off("disconnect",this.disconnect),_(this,Ro).off("text track",_(this,tc)),this.disconnect()}suspend(){}unsuspend(){}getStatistics(){const t=_(this,Ho).connectionInfo().estimatedBandwidth;return{rtt:(0,p.m)(_(this,Xo).items()),estimatedBandwidth:t,connectCount:0,connectionAttemptCount:0,edgeUrl:_(this,Go).url(),connectionProtocol:"moq"}}static start(e,i,n,r){return z(this,null,(function*(){var s,a,o,c;const l=new Map(r.connectInfo.channels.map((t=>[zs(t.catalog.namespace),new pc(new st(t.catalog))]))),u=yield r.onConnectInfo(r.connectInfo),h=r.options.get("authenticationToken");let d,y;"string"==typeof r.edgeUrl?d=_o(r.edgeUrl,u,h):(d=_o(r.edgeUrl.moqUrl||r.edgeUrl.moqWsUrl,u,h),y=_o(r.edgeUrl.moqWsUrl,u,h));const w=null==(s=r.connectInfo.channels.find((t=>t.channelId===u.channelId)))?void 0:s.catalog;i.debug("Resolved edge url",{edgeUrl:d,edgeWsUrl:y}),(0,f.a)(w,"no catalog found");const b=null==(a=l.get(zs(w.namespace)))?void 0:a.getVideoTrack(u.video),m=null==(o=l.get(zs(w.namespace)))?void 0:o.getAudioTrack(u.audio),g=yield function(t){return z(this,null,(function*(){if(self.WebTransport&&"websocket"!==(null==t?void 0:t.preferredTransport)&&t.url.protocol.startsWith("https")){if(!t.websocketFallbackTimeoutMs)return Ns(t);const e=Ns(t).catch((()=>Rs(t)));return(yield Promise.race([e,(0,p.w)(t.websocketFallbackTimeoutMs)]))||Rs(t)}return Rs(t)}))}({url:d,wsUrl:y,handshakePipelining:!0,authToken:r.options.get("authenticationToken"),preferredTransport:r.options.get("webtransportEnabled")?"webtransport":"websocket",role:2}),v=yield Promise.race([Lo.start(g.subscriber,{namespace:w.namespace,catalog:w,videoTrack:null==b?void 0:b.track,audioTrack:null==m?void 0:m.track}),(0,p.t)(1e4,new Error("Timeout waiting for player to start"))]),k=new pc(v.catalog());l.set(zs(w.namespace),k),e.emit("received signal",{type:"client ip",ip:v.connectionInfo().ip}),v.drm().then((t=>{t&&e.emit("received drm data",t.value)})).catch((t=>{i.error("Error getting DRM data",t)}));const I=new t(e,i,g,v,l,n);return u.textTrack&&_(c=I,tc).call(c,u.textTrack),I}))}getState(){return _(this,Fo)}get rtt(){return _(this,Ho).connectionInfo().rtt}close(){_(this,Go).close()}closed(){return Promise.race([_(this,Go).closed(),_(this,Ho).closed()])}};var lc,uc,hc,dc;class pc{constructor(t){R(this,hc),R(this,lc),R(this,uc),N(this,lc,t),N(this,uc,G(this,hc,dc).call(this))}catalog(){return _(this,lc).current()}namespace(){return _(this,lc).current().namespace}updateCatalog(t){N(this,lc,t)}getTextTrack(t){return _(this,lc).current().tracks.find((e=>e.label===t))}getAudioTrack(t){return t.codec?_(this,uc).filter((e=>!(!(0,p.c)(e)||e.bitRate>t.bitRate||t.codec&&e.codec!==t.codec||t.language&&e.language!==t.language))).at(-1):void 0}getVideoTrack(t){return t.codec?_(this,uc).filter((e=>!(!(0,p.e)(e)||e.bitRate>t.bitRate||t.codec&&e.codec!==t.codec))).at(-1):void 0}renditions(){return _(this,uc)}}lc=new WeakMap,uc=new WeakMap,hc=new WeakSet,dc=function(){const[t,e]=_(this,lc).value();return(0,f.c)(t)}}}]);