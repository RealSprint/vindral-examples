(()=>{"use strict";var e,t,i={9633:(e,t,i)=>{i.d(t,{E:()=>n});var s=Object.defineProperty;class n{constructor(){var e;((e,t,i)=>{t in e?s(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(this,"symbol"!=typeof(e="listeners")?e+"":e,{})}emit(e,t){const i=this.listeners[e];i&&(this.listeners[e]=i.filter((e=>!e.once)),i.map((e=>e.fn(t))).map((e=>"function"==typeof e&&(null==e?void 0:e()))))}off(e,t){const i=this.listeners[e];i&&(this.listeners[e]=i.filter((e=>e.fn!==t)))}on(e,t){this.add(e,t,!1)}once(e,t){this.add(e,t,!0)}reset(){this.listeners={}}add(e,t,i){const s=this.listeners[e],n={fn:t,once:i};s?s.push(n):this.listeners[e]=[n]}}},119:(e,t,i)=>{i.d(t,{A:()=>T,a:()=>g,b:()=>y,c:()=>v,d:()=>A,i:()=>f,p:()=>C,t:()=>p});var s=Object.defineProperty,n=Object.defineProperties,r=Object.getOwnPropertyDescriptors,o=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,h=Object.prototype.propertyIsEnumerable,d=(e,t,i)=>t in e?s(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,c=(e,t)=>{for(var i in t||(t={}))a.call(t,i)&&d(e,i,t[i]);if(o)for(var i of o(t))h.call(t,i)&&d(e,i,t[i]);return e},l=(e,t)=>n(e,r(t)),u=(e,t,i)=>d(e,"symbol"!=typeof t?t+"":t,i),m=(e,t,i)=>new Promise(((s,n)=>{var r=e=>{try{a(i.next(e))}catch(e){n(e)}},o=e=>{try{a(i.throw(e))}catch(e){n(e)}},a=e=>e.done?s(e.value):Promise.resolve(e.value).then(r,o);a((i=i.apply(e,t)).next())}));const A=e=>{switch(e){case"h264":case"av1":return"video";case"aac":case"opus":case"mp3":return"audio";case"webvtt":return"text";default:throw new Error("Unknown codec")}};function g(e,t){if(!e)throw new Error(t)}const p=e=>{try{return JSON.parse(e)}catch(e){return}};function f(e){return!("string"==typeof e.edges[0]||e.channels[0]&&!("catalog"in e.channels[0]))}function v(e){return e.tracks.filter((e=>!!e.codec)).filter((e=>w(e.codec||""))).map(((e,t)=>{const i=e.codec,s=e.bitrate;g(i,"codec is required"),g(null!=s,"bitrate is required");const n=w(i);if(g(n,"codec is required"),"audio"===A(n)){const r=e.samplerate||0;return{track:e,id:t,codec:n,codecString:i,bitRate:s,channels:"stereo"===e.channelConfig?2:1,sampleRate:r,language:e.language}}return"text"===A(n)?{track:e,id:t,bitRate:0,codec:n,kind:"subtitles",codecString:i,label:e.label,language:e.language}:(g(e.width,"width is required"),g(e.height,"width is required"),g(e.framerate,"framerate is required"),{track:e,id:t,codec:n,bitRate:s,codecString:i,width:e.width,height:e.height,frameRate:e.framerate})})).sort(((e,t)=>e.bitRate-t.bitRate))}function w(e){return e.startsWith("opus")?"opus":e.startsWith("mp4a")?"aac":e.startsWith("avc1")?"h264":e.startsWith("av01")?"av1":e.startsWith("webvtt")?"webvtt":void 0}class b extends Error{constructor({status:e,url:t,body:i}){const s=p(i);var n;super("object"==typeof(n=s)&&null!==n&&"message"in n?s.message:`Url ${t.toString()}, Status code: ${e}, Body: ${i}`),u(this,"status"),u(this,"body"),u(this,"url"),this.status=e,this.body=i,this.url=t,Object.setPrototypeOf(this,new.target.prototype)}}const y=e=>"number"==typeof e.status,S=(e,t)=>m(void 0,null,(function*(){const i=yield fetch(e.toString(),c({mode:"cors"},t));if(!i.ok)throw new b({status:i.status,url:e,body:yield i.text()});return i})),E=(e,t)=>m(void 0,null,(function*(){return yield(yield S(e,c({},t))).json()})),C=(e,t)=>m(void 0,null,(function*(){return S(e,c({method:"POST"},t))}));class T{constructor(e){u(this,"baseUrl"),u(this,"tokenFactory"),this.baseUrl=new URL("/api/v4/",e.publicEndpoint).toString(),this.tokenFactory=e.tokenFactory}connect(e){return m(this,null,(function*(){const{channelId:t,channelGroupId:i}=e,s={channelId:t,channelGroupId:i},n=new URL((a=e).channelGroupId?`connect?channelId=${a.channelId}&channelGroupId=${a.channelGroupId}`:`connect?channelId=${a.channelId}`,this.baseUrl),r=this.getAuthToken(s),o=yield E(n,{headers:this.getHeaders(r)});var a;if(function(e){var t;return!("string"==typeof e.edges[0]||e.channels[0]&&"catalog"in e.channels[0]&&void 0===(null==(t=e.channels[0])?void 0:t.catalog))}(o)){const e=o.channels.map((e=>{const t=this.toChannel(e,s),i=v(e.catalog);return l(c(c({},e),t),{renditions:i})}));return l(c({},o),{channels:e})}{const e=o.channels.map((e=>{const t=this.toChannel(e,s);return c(c({},e),t)}));return l(c({},o),{channels:e})}}))}getChannel(e){return m(this,null,(function*(){const t={channelId:e},i=new URL(`channel/${e}`,this.baseUrl),s=this.getAuthToken(t),n=yield E(i,{headers:this.getHeaders(s)});return this.toChannel(n,t,s)}))}getChannels(e){return m(this,null,(function*(){const t={channelGroupId:e},i=new URL(`channels/${e}`,this.baseUrl),s=this.getAuthToken(t),n=yield E(i,{headers:this.getHeaders(s)}),r=Array.isArray(n)?n:n.channels;return this.toChannels(r,t,s)}))}getHeaders(e){var t,i;return null!=(t=(i=e)?{Authorization:`Bearer ${i}`}:void 0)?t:{}}getAuthToken(e){return this.tokenFactory?this.tokenFactory(e):void 0}toChannels(e,t,i){return e.map((e=>this.toChannel(e,t,i)))}toChannel(e,t,i){const{baseUrl:s,sizes:n}=e.thumbnail,r=s||new URL(((e,t)=>t?e.channelGroupId?`thumbnail/?channelGroupId=${e.channelGroupId}&auth.token=${t}&auth.type=jwt`:e.channelId?`thumbnail/?channelId=${e.channelId}&auth.token=${t}&auth.type=jwt`:"thumbnail":"thumbnail")(t,i),this.baseUrl),o=n.map((s=>new URL(`?channelId=${e.channelId}&width=${s.width}&height=${s.height}${k(t,i)}`,r).toString()));return{channelId:e.channelId,name:e.name,isLive:e.isLive,thumbnailUrls:o}}}const k=(e,t)=>t?e.channelGroupId?`&channelGroupId=${e.channelGroupId}&auth.token=${t}&auth.type=jwt`:`&auth.token=${t}&auth.type=jwt`:""},4903:(e,t,i)=>{i.d(t,{B:()=>V,D:()=>C,F:()=>T,L:()=>te,V:()=>En,W:()=>ai,a:()=>G,b:()=>O,c:()=>Ae,d:()=>ye,e:()=>me,i:()=>ie,m:()=>X,n:()=>k,t:()=>ue,w:()=>le});var s=i(9633),n=i(119),r=Object.defineProperty,o=Object.defineProperties,a=Object.getOwnPropertyDescriptors,h=Object.getOwnPropertySymbols,d=Object.prototype.hasOwnProperty,c=Object.prototype.propertyIsEnumerable,l=e=>{throw TypeError(e)},u=(e,t,i)=>t in e?r(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,m=(e,t)=>{for(var i in t||(t={}))d.call(t,i)&&u(e,i,t[i]);if(h)for(var i of h(t))c.call(t,i)&&u(e,i,t[i]);return e},A=(e,t)=>o(e,a(t)),g=(e,t,i)=>u(e,"symbol"!=typeof t?t+"":t,i),p=(e,t,i)=>t.has(e)||l("Cannot "+i),f=(e,t,i)=>(p(e,t,"read from private field"),i?i.call(e):t.get(e)),v=(e,t,i)=>t.has(e)?l("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,i),w=(e,t,i,s)=>(p(e,t,"write to private field"),s?s.call(e,i):t.set(e,i),i),b=(e,t,i)=>(p(e,t,"access private method"),i),y=(e,t,i,s)=>({set _(s){w(e,t,s,i)},get _(){return f(e,t,s)}}),S=(e,t,i)=>new Promise(((s,n)=>{var r=e=>{try{a(i.next(e))}catch(e){n(e)}},o=e=>{try{a(i.throw(e))}catch(e){n(e)}},a=e=>e.done?s(e.value):Promise.resolve(e.value).then(r,o);a((i=i.apply(e,t)).next())}));class E{constructor(e){g(this,"maxSize",0),g(this,"size",0),g(this,"buffers",[]),g(this,"_borrowedBuffers",0),g(this,"get",(e=>{const t=this.buffers.shift();return this._borrowedBuffers++,this.size<e||!t?(this.buffers=[],this.size=e,new ArrayBuffer(e)):t})),g(this,"reclaim",(e=>{this._borrowedBuffers=Math.max(0,this._borrowedBuffers-1),!(e.byteLength<this.size)&&(this.buffers.length>=this.maxSize||this.buffers.push(e))})),this.maxSize=e}get bufferSize(){return this.size}get poolSize(){return this.buffers.length}get borrowedBuffers(){return this._borrowedBuffers}}class C{constructor(){g(this,"promise"),g(this,"resolved"),g(this,"resolve"),g(this,"reject"),g(this,"pending",!0),this.promise=new Promise(((e,t)=>{this.resolve=t=>{this.pending=!1,this.resolved=t,e(t)},this.reject=e=>{this.pending=!1,t(e)}}))}static resolved(e){const t=new C;return t.resolve(e),t}static fromPromise(e){const t=new C;return t.promise=e,e.then((e=>{t.pending=!1,t.resolved=e}),(e=>{t.pending=!1,t.reject(e)})),t}}class T{constructor(e=50){g(this,"maxSize"),g(this,"values",[]),g(this,"push",(e=>{this.isFull()&&this.pop(),this.values.push(e)})),g(this,"clear",(()=>{this.values=[]})),g(this,"pop",(()=>this.values.shift())),g(this,"peekFirst",(()=>this.values[0])),g(this,"peekLast",(()=>this.values[this.values.length-1])),g(this,"isFull",(()=>this.values.length>=this.maxSize)),g(this,"isEmpty",(()=>0===this.values.length)),g(this,"items",(()=>this.values)),g(this,"filterPop",(e=>{for(;this.peekFirst()&&!e(this.peekFirst());)this.pop()})),this.maxSize=e}}const k=()=>{};class x{constructor(e,t=0){g(this,"buffer"),g(this,"bytes"),g(this,"bitOffset"),g(this,"peekBit",(()=>this.getBit(this.bytes,this.bitOffset))),g(this,"readBit",(()=>{const e=this.peekBit();return this.bitOffset++,e})),g(this,"readBits",(e=>{let t=0;for(let i=0;i<e;i++)t=t<<1|(this.getBit(this.bytes,this.bitOffset++)?1:0);return t})),g(this,"readSignedExpGolomb",(()=>{const e=this.readUnsignedExpGolomb();return 1&e?(e+1)/2:-e/2})),g(this,"readUnsignedExpGolomb",(()=>{let e=0;for(;0===this.getBit(this.bytes,this.bitOffset++);)e++;let t=1<<e;for(let i=e-1;i>=0;i--)t|=this.getBit(this.bytes,this.bitOffset++)<<i;return t-1})),g(this,"getBit",((e,t)=>e[t>>3]>>7-(7&t)&1)),this.buffer=e,this.bytes=new Uint8Array(this.buffer),this.bitOffset=t}}function I(){const e=self.MediaSource,t=self.ManagedMediaSource;return null!=e?e:t}const B=new RegExp("(android|bbd+|meego).+mobile|avantgo|bada/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)/|plucker|pocket|psp|series(4|6)0|symbian|treo|up.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw-(n|u)|c55/|capi|ccwa|cdm-|cell|chtm|cldc|cmd-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc-s|devi|dica|dmob|do(c|p)o|ds(12|-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(-|_)|g1 u|g560|gene|gf-5|g-mo|go(.w|od)|gr(ad|un)|haie|hcit|hd-(m|p|t)|hei-|hi(pt|ta)|hp( i|ip)|hs-c|ht(c(-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i-(20|go|ma)|i230|iac( |-|/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |/)|klon|kpt |kwc-|kyo(c|k)|le(no|xi)|lg( g|/(k|l|u)|50|54|-[a-w])|libw|lynx|m1-w|m3ga|m50/|ma(te|ui|xo)|mc(01|21|ca)|m-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|-([1-8]|c))|phil|pire|pl(ay|uc)|pn-2|po(ck|rt|se)|prox|psio|pt-g|qa-a|qc(07|12|21|32|60|-[2-7]|i-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55/|sa(ge|ma|mm|ms|ny|va)|sc(01|h-|oo|p-)|sdk/|se(c(-|0|1)|47|mc|nd|ri)|sgh-|shar|sie(-|m)|sk-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h-|v-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl-|tdg-|tel(i|m)|tim-|t-mo|to(pl|sh)|ts(70|m-|m3|m5)|tx-9|up(.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas-|your|zeto|zte-/","i"),R=navigator.userAgent.toLowerCase(),P=B.test(R),M=()=>{const e=document.createElement("video");return""!==e.canPlayType("application/vnd.apple.mpegURL")||""!==e.canPlayType("audio/mpegurl")},U=()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){return!1}return!1},L=()=>"MacIntel"===navigator.platform&&0===navigator.maxTouchPoints,_=()=>"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1;function D(){var e,t;if(/(iPhone|iPod|iPad)/i.test(R))return null==(t=null==(e=null==R?void 0:R.match(/OS [\d_]+/i))?void 0:e[0])?void 0:t.substring(3).split("_").map((e=>parseInt(e)))[0]}const O=(e,t,i)=>{let s=0;for(let n=t;n<=i;n++)if(n===t){const t=e[n];s+=127&t,128&t&&(s-=128)}else s=256*s+e[n];return s};var F,N,W;class V{constructor(e){v(this,F),v(this,N),v(this,W),w(this,N,e),w(this,W,new DataView(e.buffer,e.byteOffset,e.byteLength)),w(this,F,0)}position(){return f(this,F)}byteOffset(){return f(this,N).byteOffset+f(this,F)}buffer(){return f(this,N)}remaining(){return f(this,N).length-f(this,F)}readUint8(){const e=f(this,W).getUint8(f(this,F));return w(this,F,f(this,F)+1),e}readUint24(){const e=f(this,W).getUint32(f(this,F))>>8&16777215;return w(this,F,f(this,F)+3),e}readUint16(){const e=f(this,W).getUint16(f(this,F));return w(this,F,f(this,F)+2),e}readUint32(){const e=f(this,W).getUint32(f(this,F));return w(this,F,f(this,F)+4),e}readUint64(){const e=O(f(this,N),f(this,F),f(this,F)+7);return w(this,F,f(this,F)+8),e}readBytes(e){const t=f(this,N).subarray(f(this,F),f(this,F)+e);return w(this,F,f(this,F)+e),t}readRemaining(){return this.readBytes(this.remaining())}readUtf8String(){const e=[];let t;for(;0!==(t=this.readUint8())&&(e.push(t),0!=this.remaining()););return(new TextDecoder).decode(new Uint8Array(e))}}F=new WeakMap,N=new WeakMap,W=new WeakMap;class z{constructor(e=100,t=100){g(this,"resizeSteps"),g(this,"internalBuffer"),g(this,"view"),g(this,"uint8"),g(this,"_position",0),g(this,"_end",0),this.resizeSteps=t,this.internalBuffer=new ArrayBuffer(e),this.view=new DataView(this.internalBuffer),this.uint8=new Uint8Array(this.internalBuffer)}position(){return this._position}seek(e){this._position=Math.max(0,Math.min(this._end,e))}seekToEnd(){this._position=this._end}writeUint8(e){this.writeAndMove(e,1)}writeUint16(e){this.writeAndMove(e,2)}writeUint24(e){this.writeAndMove(e,3)}writeUint32(e){this.writeAndMove(e,4)}writeUint32At(e,t){this.view.setUint32(e,t)}writeBytes(e){this.resizeIfNeeded(this.position()+e.byteLength),this.uint8.set(e,this.position()),this._position+=e.byteLength,this._end=Math.max(this._end,this._position)}buffer(){return this.internalBuffer.slice(0,this._end)}write(e,t){switch(this.resizeIfNeeded(this.position()+t),t){case 1:this.view.setUint8(this.position(),e);break;case 2:this.view.setUint16(this.position(),e);break;case 3:this.view.setUint8(this.position(),e>>16&255),this.view.setUint8(this.position()+1,e>>8&255),this.view.setUint8(this.position()+2,255&e);break;case 4:this.view.setUint32(this.position(),e)}}writeAndMove(e,t){this.write(e,t),this._position+=t,this._end=Math.max(this._end,this._position)}resizeIfNeeded(e){if(e>this.internalBuffer.byteLength){const t=new ArrayBuffer(e+this.resizeSteps),i=new Uint8Array(t);i.set(this.uint8),this.internalBuffer=t,this.view=new DataView(this.internalBuffer),this.uint8=i}}}class Q{constructor(e,t,i){g(this,"onSuccess"),g(this,"onError"),g(this,"doExecute"),this.doExecute=e,this.onSuccess=t,this.onError=i}execute(e){try{this.doExecute(e),this.onSuccess()}catch(e){this.onError(e)}}}const G=e=>e.reduce(((e,t)=>e+t),0)/e.length,X=e=>({last:e[e.length-1]||0,average:0===e.length?0:G(e),max:0===e.length?0:Math.max(...e),min:0===e.length?0:Math.min(...e)});class H{constructor(e=10){g(this,"rates"),g(this,"_total",0),g(this,"accumulatedValues",0),g(this,"lastTickTime",Date.now()),g(this,"add",(e=>{this.accumulatedValues+=e,this._total+=e})),g(this,"tick",(()=>{const e=this.accumulatedValues/((Date.now()-this.lastTickTime)/1e3);this.rates.push(e),this.accumulatedValues=0,this.lastTickTime=Date.now()})),this.rates=new T(e)}get total(){return this._total}get average(){return this.rates.isEmpty()?0:G(this.rates.items())}}const j=(e,t)=>{if(e===t)return!0;if(null==e||"object"!=typeof e||null==t||"object"!=typeof t)return!1;let i=0,s=0;for(const t in e)i+=1;for(const i in t)if(s+=1,!(i in e)||!j(e[i],t[i]))return!1;return i==s},q=["off","error","warn","info","debug","trace"];var Z,J,Y,$,K;const ee=class e{constructor({context:e,logLevel:t,debug:i}){v(this,Z,new Map),v(this,J,""),v(this,Y,!1),v(this,$,"off"),g(this,"trace",((...e)=>{})),g(this,"debug",((...e)=>{})),g(this,"info",((...e)=>{})),g(this,"warn",((...e)=>{})),g(this,"error",((...e)=>{})),g(this,"table",((...e)=>{})),g(this,"count",((...e)=>{})),w(this,J,e),w(this,$,t),w(this,Y,i||!1),this.setLevel(t),this.setDebug(f(this,Y))}setDebug(e){w(this,Y,e);for(const[t,i]of f(this,Z))i.setDebug(e);e?(this.table=console.table.bind(console),this.count=console.count.bind(console)):(this.table=()=>{},this.count=()=>{})}setLevel(e){w(this,$,e);for(const[t,i]of f(this,Z))i.setLevel(e);const t=q.indexOf(e);for(const[e,i]of q.entries())"off"!==i&&(this[i]=e<=t?console[i].bind(console,"%c%s %c%s","font-weight:bold;",i.toUpperCase(),"font-weight:normal;",f(this,J)):()=>{})}createContext(t){const i=f(this,Z).get(t);if(!i){const i=new e({context:`${t}`,logLevel:f(this,$),debug:f(this,Y)});return f(this,Z).set(t,i),i}return i}static get(){return f(e,K)||w(e,K,new e({context:"Vindral",logLevel:"off"})),f(e,K)}};Z=new WeakMap,J=new WeakMap,Y=new WeakMap,$=new WeakMap,K=new WeakMap,v(ee,K);let te=ee;function ie(e){const t=te.get().createContext(e.context);return function(i,s){const n=String(s.name);return function(...s){e.enter&&t[e.enter](`Enter '${n}'`,m({},s));try{const r=i.call(this,...s);return r instanceof Promise?r.then((i=>{e.return&&t[e.return](`Return '${n}'`,i)})).catch((i=>{e.error&&t[e.error](`Error '${n}'`,i)})):e.return&&t[e.return](`Return '${n}'`,r),r}catch(i){throw e.error&&t[e.error](`Error '${n}'`,i),i}}}}const se=(e,t)=>{const i=m({},e);return"object"!=typeof i||t.forEach((e=>{delete i[e]})),i},ne=(e,t=Date.now())=>{const i=e.length;if(i>0){const s=e[i-1];s.end||(s.end=t)}},re=(e,t=Date.now())=>{ne(e),e.push({start:t})},oe=e=>e.reduce(((e,t)=>{var i;return e+((null!=(i=t.end)?i:Date.now())-t.start)}),0),ae=(e,t,i=Date.now())=>e.reduce(((e,s)=>{var n;const r=Math.max(i-t,s.start),o=null!=(n=s.end)?n:i;return Math.max(0,o-r)+e}),0),he=class{constructor(){g(this,"pendingTimeouts",new Set),g(this,"pendingIntervals",new Set),g(this,"clearTimeout",(e=>{this.pendingTimeouts.delete(e)&&window.clearTimeout(e)})),g(this,"clearInterval",(e=>{this.pendingIntervals.delete(e)&&window.clearInterval(e)})),g(this,"setTimeout",((e,t,...i)=>{const s=window.setTimeout((()=>{e(...i),this.clearTimeout(s)}),t);return this.pendingTimeouts.add(s),s})),g(this,"setInterval",((e,t,...i)=>{const s=window.setInterval((()=>{e(...i)}),t);return this.pendingIntervals.add(s),s})),g(this,"unload",(()=>{this.pendingIntervals.forEach(this.clearInterval),this.pendingTimeouts.forEach(this.clearTimeout)}))}};g(he,"create",(()=>new he));let de=he;const ce=()=>{const e=[...Array(256).keys()].map((e=>e.toString(16).padStart(2,"0"))),t=crypto.getRandomValues(new Uint8Array(16));return t[6]=15&t[6]|64,t[8]=63&t[8]|128,[...t.entries()].map((([t,i])=>[4,6,8,10].includes(t)?`-${e[i]}`:e[i])).join("")},le=e=>S(void 0,null,(function*(){return new Promise((t=>setTimeout(t,e)))})),ue=(e,...t)=>S(void 0,[e,...t],(function*(e,t=new Error("Timeout")){return new Promise(((i,s)=>setTimeout((()=>s(t)),e)))})),me=e=>"width"in e&&"number"==typeof e.width,Ae=e=>"sampleRate"in e&&"number"==typeof e.sampleRate,ge=e=>{switch(e.codec){case"opus":return'audio/mp4; codecs="opus"';case"mp3":return"audio/mpeg";case"webvtt":return"text/vtt";case"aac":return e.codecString?`audio/mp4; codecs="${e.codecString}"`:"audio/mp4";case"h264":case"av1":return e.codecString?`video/mp4; codecs="${e.codecString}"`:"video/mp4"}},pe=()=>Number.MAX_SAFE_INTEGER,fe=()=>({width:Number.MAX_SAFE_INTEGER,height:Number.MAX_SAFE_INTEGER}),ve=e=>!("object"!=typeof e||null===e||!("type"in e)),we={sizeBasedResolutionCapEnabled:!0,pictureInPictureEnabled:!0,abrEnabled:!0,burstEnabled:!1,mseEnabled:!0,mseOpusEnabled:!1,muted:!1,minBufferTime:1500,maxBufferTime:1500,logLevel:"off",maxSize:fe(),maxVideoBitRate:pe(),maxAudioBitRate:pe(),tags:[],media:"audio+video",poster:!0,reconnectHandler:e=>e.reconnectRetries<30,iosWakeLockEnabled:!1,telemetryEnabled:!0,iosMediaElementEnabled:!1,pauseSupportEnabled:!0,advanced:{wasmDecodingConstraint:{bitRate:Number.MAX_SAFE_INTEGER,width:1280,height:1280}},videoCodecs:["av1","h264"],webtransportEnabled:!0};class be extends Error{constructor(e,t,i={}){super(e),g(this,"props"),g(this,"extra",{}),g(this,"code",(()=>this.props.code)),g(this,"isFatal",(()=>this.props.isFatal)),g(this,"source",(()=>this.props.source)),g(this,"type",(()=>{var e;return null!=(e=this.props.type)?e:"external"})),g(this,"toStringifiable",(()=>{var e;const t=this.source(),i=t instanceof Error?t.stack:this.stack;return A(m({},this.extra),{code:this.props.code,isFatal:this.props.isFatal,type:this.props.type,message:this.message,sourceMessage:null==(e=this.source())?void 0:e.message,stack:i})})),this.props=t,this.extra=i,Object.setPrototypeOf(this,new.target.prototype)}}const ye=(e,t)=>new be("Decoder Error",{isFatal:e,code:"decoder_error",source:t,type:"internal"}),Se=(e,t)=>new be("Audio Player Error",{isFatal:e,code:"audio_player_error",source:t,type:"internal"}),Ee=(e,t,i,s)=>new be("MediaSource Error",{isFatal:e,code:"media_source_error",source:t,type:"internal"},{type:s,consecutiveErrorsCount:i}),Ce=(e,t)=>new be(`No track context for ${e}${t?`, rendition id ${t}`:""}`,{isFatal:!1,code:"no_track_context",type:"internal"}),Te=(e,t)=>new be(`Track context is in an invalid state for ${e}${t?`, rendition id ${t}`:""}`,{isFatal:!1,code:"invalid_track_context_state",type:"internal"}),ke=e=>new be("Disconnected From Edge Server",{type:"external",source:e,isFatal:!1,code:"disconnected_by_edge"}),xe=e=>new be("Authentication Failed",{isFatal:!0,code:"authentication_error",source:e}),Ie=(e,t)=>new be("Channel not found",{isFatal:!1,code:"channel_not_found",source:t,type:e}),Be=()=>new be("Connection failed - no more reconnect attempts",{isFatal:!0,code:"connection_failed_will_not_attempt_again"}),Re=e=>new be(e,{isFatal:!0,code:"access_forbidden"}),Pe=e=>new be(`Channel switch to '${e}' failed`,{isFatal:!1,code:"channel_switch_failed"}),Me=(e,t)=>e&&"object"==typeof e&&t in e,Ue={playready:["150","2000","3000"],widevine:["SW_SECURE_CRYPTO","SW_SECURE_DECODE","HW_SECURE_CRYPTO","HW_SECURE_DECODE","HW_SECURE_ALL"],fairplay:[""],clearkey:[""]},Le={initDataTypes:["cenc"],audioCapabilities:[{contentType:'audio/mp4; codecs="mp4a.40.2"'}],videoCapabilities:[{contentType:'video/mp4; codecs="avc1.42c01f"'}]},_e={fairplay:{keySystem:"com.apple.fps",supportedConfig:{initDataTypes:["sinf"],videoCapabilities:[{contentType:'video/mp4; codecs="avc1.42c01f"'}]}},playready:{keySystem:"com.microsoft.playready",supportedConfig:Le},widevine:{keySystem:"com.widevine.alpha",supportedConfig:Le},clearkey:{keySystem:"org.w3.clearkey",supportedConfig:Le}},De=(e,t)=>S(void 0,null,(function*(){return navigator.requestMediaKeySystemAccess(e,[t]).catch((()=>{}))})),Oe=(e,t,i,s,n,r)=>S(void 0,null,(function*(){let o;for(const a of s){const s=null==i?void 0:i.map((e=>A(m({},e),{robustness:a,contentType:r?`${"audioCapabilities"===n?"audio/mp4":"video/mp4"}; codecs="${r}"`:e.contentType})));if(!(yield De(e,{initDataTypes:t,[n]:s})))break;o=s}return o})),Fe=(e,t,i)=>S(void 0,null,(function*(){const{keySystem:s,supportedConfig:n}=_e[e],{initDataTypes:r,videoCapabilities:o,audioCapabilities:a}=n,h=Ue[e],[d,c]=yield Promise.all([Oe(s,r,o,h,"videoCapabilities",t),Oe(s,r,a,h,"audioCapabilities",i)]);return d||c?yield De(s,{initDataTypes:r,videoCapabilities:d,audioCapabilities:c}):void 0}));var Ne,We,Ve,ze,Qe,Ge,Xe,He,je,qe,Ze,Je,Ye,$e,Ke,et,tt,it,st,nt,rt,ot,at,ht,dt;class ct{constructor(e,t,i,s){g(this,"keySystem"),g(this,"licenseServerUrl"),g(this,"certificate"),g(this,"headers",{}),g(this,"queryParams",{}),v(this,Ne),v(this,We),w(this,Ne,t),this.keySystem=e,this.licenseServerUrl=i,this.certificate=s}get statistics(){return{keySystem:f(this,Ne).keySystem,licenseServerUrl:this.licenseServerUrl,mediaKeySystemConfiguration:f(this,Ne).getConfiguration()}}getMediaKeys(){return S(this,null,(function*(){return f(this,We)||w(this,We,yield f(this,Ne).createMediaKeys()),f(this,We)}))}requestLicense(e){return S(this,null,(function*(){const t=new URL(this.licenseServerUrl);for(const[e,i]of Object.entries(this.queryParams))t.searchParams.append(e,i);const i=yield fetch(t,{method:"POST",body:e,headers:m({"Content-Type":"application/octet-stream"},this.headers)});if(!i.ok)throw new Error(`Failed to fetch license: ${i.statusText}`);return yield i.arrayBuffer()}))}}function lt(e){const t=window.atob(e.replace(/-/g,"+").replace(/_/g,"/"));let i="";for(let e=0;e<t.length;e++)i+=("0"+t.charCodeAt(e).toString(16)).substr(-2);return i}function ut(e){let t="";for(let i=0;i<e.length;i+=2)t+=String.fromCharCode(parseInt(e.substr(i,2),16));return window.btoa(t).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function mt(e,t){if(e.byteLength!==t.byteLength)return!1;const i=new Uint8Array(e),s=new Uint8Array(t);for(let e=0;e<i.length;e++)if(i[e]!==s[e])return!1;return!0}Ne=new WeakMap,We=new WeakMap;class At extends ct{constructor(e,t){super("clearkey",e,""),v(this,Ve),w(this,Ve,t)}handleLicenseRequest(e){const t=new Uint8Array(e),i=String.fromCharCode(...t),s=JSON.parse(i),n=[];for(let e=0;e<s.kids.length;e++){const t=s.kids[e];if(t){const e=lt(t).toLowerCase(),i=f(this,Ve)[e];i&&n.push({kty:"oct",alg:"A128KW",kid:t,k:ut(i)})}}const r=JSON.stringify({keys:n,type:s.type});return(new TextEncoder).encode(r)}}Ve=new WeakMap;class gt extends ct{constructor(e,t,i){super("fairplay",e,t,i)}}class pt extends ct{constructor(e,t){super("playready",e,t)}requestLicense(e){return S(this,null,(function*(){(0,n.a)(this.licenseServerUrl,"No license server URL set");const t=new URL(this.licenseServerUrl);for(const[e,i]of Object.entries(this.queryParams))t.searchParams.append(e,i);const i=(e=>{var t,i,s,n;const r=String.fromCharCode(...new Uint16Array(e)),o=(new window.DOMParser).parseFromString(r,"application/xml"),a=o.getElementsByTagName("HttpHeaders")[0];let h={};if(a){const e=a.getElementsByTagName("name"),s=a.getElementsByTagName("value");for(let n=0;n<e.length;n++){const r=null==(t=e[n])?void 0:t.childNodes[0],o=null==(i=s[n])?void 0:i.childNodes[0];null!=r&&r.nodeValue&&o&&o.nodeValue&&(h[r.nodeValue]=o.nodeValue)}}const d=o.getElementsByTagName("Challenge")[0];let c;return d&&null!=(s=d.childNodes[0])&&s.nodeValue&&(c=window.atob(null==(n=d.childNodes[0])?void 0:n.nodeValue)),o.querySelector("parsererror")&&(h={"Content-Type":"text/xml; charset=utf-8",SOAPAction:'"http://schemas.microsoft.com/DRM/2007/03/protocols/AcquireLicense"'},c=e),{headers:h,message:c}})(e),s=yield fetch(t,{method:"POST",headers:m(m({},i.headers),this.headers),body:i.message});if(!s.ok)throw new Error(`Failed to fetch license: ${s.statusText}`);return yield s.arrayBuffer()}))}}class ft extends ct{constructor(e,t){super("widevine",e,t)}}class vt{constructor(e,t,i,s){v(this,Ke),v(this,ze),v(this,Qe),v(this,Ge),v(this,Xe,new C),v(this,He,{}),v(this,je,{}),v(this,qe,null),v(this,Ze,new Map),v(this,Je,null),v(this,Ye,(e=>{f(this,ze).debug("Received DRM data",{options:e}),f(this,Xe).resolve(e)})),v(this,$e,(e=>{f(this,ze).info("Encrypted event received",{event:e}),b(this,Ke,et).call(this,e)})),v(this,nt,(e=>{var t;f(this,ze).debug("Session message received",{event:e});const i=e.target,s=e.message;f(this,Ze).get(i)?(f(this,ze).debug("Requesting license for session",{sessionId:i.sessionId}),null==(t=f(this,qe))||t.requestLicense(s).then((e=>{f(this,ze).debug("License received for session",{sessionId:i.sessionId}),i.update(e).catch((e=>{b(this,Ke,at).call(this,{message:"Failed to update session with license",code:"eme",isFatal:!1,error:e})}))})).catch((e=>{b(this,Ke,at).call(this,{message:"Failed to request license",code:"eme",isFatal:!1,error:e})}))):f(this,ze).error("No active session found for event",{event:e})})),v(this,rt,(e=>{const t=e.target;f(this,ze).debug("Key status changed for session",{sessionId:t.sessionId}),t.keyStatuses.forEach(((e,t)=>{const i=lt(window.btoa(String.fromCharCode(...new Uint8Array(t))));f(this,ze).debug("Key status",{base64kid:i,status:e})}))})),v(this,ht,(e=>S(this,null,(function*(){const t=b(this,Ke,dt).call(this,e);f(this,ze).debug("Prioritized key system list",{keySystemList:t});const i=yield((e,t,i)=>S(void 0,null,(function*(){let s;for(const n of e)if(s=yield Fe(n,t,i),s)return{keySystem:n,mediaKeySystemAccess:s}})))(t,e.videoCodec,e.audioCodec);if(!i)return f(this,ze).debug("No supported key system found"),null;f(this,ze).debug("Supported key system found",i.mediaKeySystemAccess.getConfiguration());const{keySystem:s,mediaKeySystemAccess:r}=i;let o=null;return"clearkey"===s?((0,n.a)(e.clearkeys,"No clearkeys found"),o=new At(r,e.clearkeys)):"playready"===s?((0,n.a)(e.playreadyLicenseUrl,"No playreadyLicenseUrl found"),o=new pt(r,e.playreadyLicenseUrl)):"widevine"===s?((0,n.a)(e.widevineLicenseUrl,"No widevineLicenseUrl found"),o=new ft(r,e.widevineLicenseUrl)):"fairplay"===s&&((0,n.a)(e.fairplayLicenseUrl,"No fairplayLicenseUrl found"),(0,n.a)(e.fairplayCertificate,"No fairplayCertificate found"),o=new gt(r,e.fairplayLicenseUrl,e.fairplayCertificate)),o&&(o.headers=f(this,He),o.queryParams=f(this,je)),o})))),w(this,Qe,e),w(this,ze,t),w(this,He,i||{}),w(this,je,s||{}),f(this,Qe).on("received drm data",f(this,Ye))}static isSupported(){return!!navigator.requestMediaKeySystemAccess}attach(e){w(this,Ge,e),f(this,ze).info("Media element attached"),f(this,Ge).addEventListener("encrypted",f(this,$e))}getStatistics(){var e,t;return f(this,Xe).resolved||null!=(e=f(this,qe))&&e.statistics?m(m({},f(this,Xe).resolved),null==(t=f(this,qe))?void 0:t.statistics):null}unload(){var e;f(this,ze).info("Unloading EncryptedMediaExtensions"),f(this,Qe).off("received drm data",f(this,Ye)),null==(e=f(this,Ge))||e.removeEventListener("encrypted",f(this,$e)),f(this,Ze).forEach(((e,t)=>{t.close()})),f(this,Ze).clear(),w(this,Je,null),w(this,qe,null)}}ze=new WeakMap,Qe=new WeakMap,Ge=new WeakMap,Xe=new WeakMap,He=new WeakMap,je=new WeakMap,qe=new WeakMap,Ze=new WeakMap,Je=new WeakMap,Ye=new WeakMap,$e=new WeakMap,Ke=new WeakSet,et=function(e){return S(this,null,(function*(){try{yield b(this,Ke,tt).call(this),f(this,ze).debug("Media keys initialization completed"),yield b(this,Ke,it).call(this,e.initData,e.initDataType)}catch(e){b(this,Ke,at).call(this,{message:"Failed to handle encrypted event",code:"eme",isFatal:!0,error:e})}}))},tt=function(){return S(this,null,(function*(){var e;if(f(this,ze).debug("Initializing media keys"),null==(e=f(this,Ge))||!e.mediaKeys)return f(this,Je)?(f(this,ze).debug("Media keys initialization already in progress, waiting for completion"),void(yield f(this,Je))):(w(this,Je,S(this,null,(function*(){const e=yield f(this,Xe).promise,t=yield f(this,ht).call(this,e);f(this,ze).debug("CDM obtained",{cdm:t}),(0,n.a)(f(this,Ge),"No media element found"),(0,n.a)(t,"No CDM found");const i=yield t.getMediaKeys();t.certificate&&(yield b(this,Ke,ot).call(this,i,t.certificate)),f(this,ze).debug("Setting media keys on media element"),yield f(this,Ge).setMediaKeys(i),w(this,qe,t)}))),void(yield f(this,Je)));f(this,ze).debug("Media keys already set on media element")}))},it=function(e,t){return S(this,null,(function*(){(0,n.a)(f(this,qe),"No CDM manager found");const i=yield f(this,qe).getMediaKeys();if(!e||!b(this,Ke,st).call(this,e))return void f(this,ze).debug("Duplicate initData, no need to create new session",{initData:e});const s=i.createSession();f(this,ze).debug("Creating new session",{session:s}),s.addEventListener("keystatuseschange",f(this,rt)),s.closed.then((e=>{f(this,ze).info("Session is closed",{reason:e})})),s.addEventListener("message",f(this,nt)),f(this,Ze).set(s,e),f(this,ze).debug("Generating request for session",{session:s,initDataType:t,initData:e}),yield s.generateRequest(t,e)}))},st=function(e){for(const[t,i]of f(this,Ze))if(mt(e,i))return!1;return!0},nt=new WeakMap,rt=new WeakMap,ot=function(e,t){return S(this,null,(function*(){try{f(this,ze).debug("Setting server certificate",{certificate:t}),(yield e.setServerCertificate(t))||f(this,ze).warn("Server certificates are not supported by the CDM.")}catch(e){f(this,ze).error("Failed to set server certificate",{error:e})}}))},at=function(e){const{message:t,code:i,isFatal:s,error:n}=e;f(this,ze).error(t,{error:n}),f(this,Qe).emit("error",new be(t,{code:i,isFatal:s},{error:n}))},ht=new WeakMap,dt=function(e){const t=[];return e.clearkeys&&t.push("clearkey"),e.playreadyLicenseUrl&&t.push("playready"),e.widevineLicenseUrl&&t.push("widevine"),e.fairplayLicenseUrl&&e.fairplayCertificate&&t.push("fairplay"),t};const wt=(e,t=0)=>{for(let i=t;i<e.byteLength-4;i++){const t=1===e.getUint32(i),s=1==(e.getUint8(i)<<16|e.getUint16(i+1));if(t||s)return{position:i,nalPrefixSize:t?4:3}}},bt=e=>{const t=[],i=[];if(!(e=>0!==(e=>{const t=e.getUint32(0,!1);let i=0;return 1==(e.getUint8(0)<<16|e.getUint16(1,!1))?i+=3:1===t&&(i+=4),i})(new DataView(e,0)))(e)){const s=new DataView(e,0),n=31&s.getUint8(5);let r=6;for(let i=0;i<n;i++){const i=s.getUint16(r);t.push(e.slice(r+2,r+2+i)),r+=i+2}const o=s.getUint8(r);r+=1;for(let t=0;t<o;t++){const t=s.getUint16(r);i.push(e.slice(r+2,r+2+t)),r+=t+2}return{sequenceParameterSets:t,pictureParameterSets:i}}return((e,t)=>{const i=new DataView(e,0);let s=wt(i);for(;s;){const{position:n,nalPrefixSize:r}=s,o=wt(i,n+4),a=o?o.position-n-r:void 0;if(!t(new DataView(e,n+r,a)))return;s=o}})(e,(e=>{const s=e.byteOffset+e.byteLength;switch((e=>31&e)(e.getUint8(0))){case 8:i.push(e.buffer.slice(e.byteOffset,s));break;case 7:t.push(e.buffer.slice(e.byteOffset,s))}return!0})),{sequenceParameterSets:t,pictureParameterSets:i}},yt=[{numerator:0,denumerator:0},{numerator:1,denumerator:1},{numerator:12,denumerator:11},{numerator:10,denumerator:11},{numerator:16,denumerator:11},{numerator:40,denumerator:33},{numerator:24,denumerator:11},{numerator:20,denumerator:11},{numerator:32,denumerator:11},{numerator:80,denumerator:33},{numerator:18,denumerator:11},{numerator:15,denumerator:11},{numerator:64,denumerator:33},{numerator:160,denumerator:99},{numerator:4,denumerator:3},{numerator:3,denumerator:2},{numerator:2,denumerator:1}];function St(e){return{encoding:e.readUint8(),description:e.readUtf8String(),value:e.readUtf8String()}}function Et(e){const t=new ArrayBuffer(e.length),i=new Uint8Array(t);for(let t=0,s=e.length;t<s;t++)i[t]=e.charCodeAt(t);return new Uint8Array(t)}const Ct={ftyp:Et("ftyp"),mvhd:Et("mvhd"),moov:Et("moov"),trak:Et("trak"),tkhd:Et("tkhd"),mdia:Et("mdia"),mdhd:Et("mdhd"),hdlr:Et("hdlr"),minf:Et("minf"),vmhd:Et("vmhd"),smhd:Et("smhd"),dinf:Et("dinf"),dref:Et("dref"),stbl:Et("stbl"),stsd:Et("stsd"),avc1:Et("avc1"),av01:Et("av01"),av1C:Et("av1C"),avcC:Et("avcC"),esds:Et("esds"),colr:Et("colr"),nclx:Et("nclx"),mvex:Et("mvex"),trex:Et("trex"),udta:Et("udta"),meta:Et("meta"),ilst:Et("ilst"),moof:Et("moof"),mfhd:Et("mfhd"),traf:Et("traf"),tfhd:Et("tfhd"),tfdt:Et("tfdt"),trun:Et("trun"),mdat:Et("mdat"),mp4a:Et("mp4a"),Opus:Et("Opus"),prft:Et("prft"),dOps:Et("dOps"),emsg:Et("emsg")},Tt=Et("iso6"),kt=new Uint8Array([0,0,2,0]),xt=[Tt,new Uint8Array([105,115,111,109]),new Uint8Array([105,115,111,50]),new Uint8Array([97,118,99,49]),new Uint8Array([109,112,52,49])],It=[Tt,new Uint8Array([105,115,111,109]),new Uint8Array([105,115,111,50]),new Uint8Array([97,118,48,49]),new Uint8Array([109,112,52,49])],Bt=[Tt,new Uint8Array([105,115,111,109]),new Uint8Array([105,115,111,50]),new Uint8Array([109,112,52,49])];class Rt{constructor(){g(this,"writer",new z)}}const Pt=(e,t,i)=>{e.writer.writeUint32(i+8),e.writer.writeBytes(t)},Mt=(e,t,i,s,n)=>{Pt(e,t,i+4),e.writer.writeUint8(s),e.writer.writeUint24(n)},Ut=(e,t)=>{Pt(e,Ct.ftyp,Tt.byteLength+kt.byteLength+t.reduce(((e,t)=>e+t.byteLength),0)),e.writer.writeBytes(Tt),e.writer.writeBytes(kt),t.forEach((t=>e.writer.writeBytes(t)))},Lt=e=>"sequenceParameterSets"in e,_t=e=>"sequenceHeader"in e,Dt=e=>"video"==e.type,Ot=e=>"audio"==e.type,Ft=(e,t,i)=>{let s=3;for(e.writer.writeUint8(t);s>0;s--)e.writer.writeUint8(i>>7*s|128);e.writer.writeUint8(127&i)},Nt=(e,t)=>{const i=e.writer.position();Pt(e,Ct.minf,0),Dt(t)?(Mt(e,Ct.vmhd,8,0,1),e.writer.writeUint32(0),e.writer.writeUint32(0)):Ot(t)&&(Mt(e,Ct.smhd,4,0,0),e.writer.writeUint16(0),e.writer.writeUint16(0)),(e=>{const t=e.writer.position();Pt(e,Ct.dinf,0),Mt(e,Ct.dref,16,0,0),e.writer.writeUint32(1),Mt(e,Et("url "),0,0,1),e.writer.writeUint32At(t,e.writer.position()-t)})(e),((e,t)=>{const i=e.writer.position();Pt(e,Ct.stbl,0);const s=e.writer.position();Mt(e,Ct.stsd,0,0,0),e.writer.writeUint32(1),Dt(t)?((e,t)=>{const i=e.writer.position(),s=_t(t)?Ct.av01:Ct.avc1;Pt(e,s,0),e.writer.writeUint32(0),e.writer.writeUint16(0),e.writer.writeUint16(1),e.writer.writeUint16(0),e.writer.writeUint16(0),e.writer.writeUint32(0),e.writer.writeUint32(0),e.writer.writeUint32(0),e.writer.writeUint16(t.width),e.writer.writeUint16(t.height),e.writer.writeUint32(4718592),e.writer.writeUint32(4718592),e.writer.writeUint32(0),e.writer.writeUint16(1),e.writer.writeUint8(0),e.writer.writeBytes(new Uint8Array(31)),e.writer.writeUint16(24),e.writer.writeUint16(-1),Lt(t)?((e,t)=>{const i=e.writer.position();Pt(e,Ct.avcC,0),e.writer.writeUint8(1),e.writer.writeUint8(t.sequenceParameterSets[0][1]),e.writer.writeUint8(t.sequenceParameterSets[0][2]),e.writer.writeUint8(t.sequenceParameterSets[0][3]),e.writer.writeUint8(255),e.writer.writeUint8(224|t.sequenceParameterSets.length),t.sequenceParameterSets.forEach((t=>{e.writer.writeUint16(t.byteLength),e.writer.writeBytes(t)})),e.writer.writeUint8(t.pictureParameterSets.length),t.pictureParameterSets.forEach((t=>{e.writer.writeUint16(t.byteLength),e.writer.writeBytes(t)})),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t):_t(t)&&(((e,t)=>{var i,s;const n=e.writer.position();Pt(e,Ct.av1C,0);const{seqProfile:r,operatingPoints:o,colorConfig:a}=t.parsedSequenceHeader,h=o[0];e.writer.writeUint8(129),e.writer.writeUint8(r<<5|(null!=(i=null==h?void 0:h.seqLevelIdx)?i:0)),e.writer.writeUint8((null!=(s=null==h?void 0:h.tier)?s:0)|(a.highBitDepth?1:0)|(12===a.bitDepth?1:0)<<5|(a.monoChrome?1:0)<<4|a.subsamplingX<<3|a.subsamplingY<<2|65535&a.chromaSamplePosition),e.writer.writeUint8(0),e.writer.writeBytes(t.sequenceHeader),e.writer.writeUint32At(n,e.writer.position()-n)})(e,t),t.parsedSequenceHeader.colorConfig&&(Pt(e,Et("colr"),11),e.writer.writeBytes(Ct.nclx),e.writer.writeUint16(t.parsedSequenceHeader.colorConfig.colorPrimaries),e.writer.writeUint16(t.parsedSequenceHeader.colorConfig.transferCharacteristics),e.writer.writeUint16(t.parsedSequenceHeader.colorConfig.matrixCoefficients),e.writer.writeUint8(t.parsedSequenceHeader.colorConfig.colorRange?1:0))),t.pixelAspectRatio&&(Pt(e,Et("pasp"),8),e.writer.writeUint32(t.pixelAspectRatio.numerator),e.writer.writeUint32(t.pixelAspectRatio.denumerator)),t.bitrate&&(Pt(e,Et("btrt"),12),e.writer.writeUint32(0),e.writer.writeUint32(t.bitrate),e.writer.writeUint32(t.bitrate)),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t):Ot(t)&&((e,t)=>{const i=e.writer.position();switch(Pt(e,Et((e=>{switch(e){case"aac":case"mp3":return"mp4a";case"opus":return"Opus"}})(t.codec)),0),e.writer.writeUint32(0),e.writer.writeUint16(0),e.writer.writeUint16(1),e.writer.writeUint16(0),e.writer.writeUint16(0),e.writer.writeUint32(0),e.writer.writeUint16(t.channelCount),e.writer.writeUint16(16),e.writer.writeUint32(0),e.writer.writeUint16(t.sampleRate),e.writer.writeUint16(0),t.codec){case"aac":case"mp3":((e,t)=>{const i=t.decoderConfig.byteLength>0?t.decoderConfig.byteLength+5:0,s=e.writer.position();Mt(e,Ct.esds,0,0,0),Ft(e,3,21+i+5+1),e.writer.writeUint16(t.trackId),e.writer.writeUint8(0),Ft(e,4,13+i);const n="mp3"===t.codec&&t.sampleRate>24e3?107:64;e.writer.writeUint8(n),e.writer.writeUint8(21),e.writer.writeUint24(0),e.writer.writeUint32(t.bitrate||0),e.writer.writeUint32(t.bitrate||0),t.decoderConfig.byteLength>0&&(Ft(e,5,t.decoderConfig.byteLength),e.writer.writeBytes(t.decoderConfig)),Ft(e,6,1),e.writer.writeUint8(2),e.writer.writeUint32At(s,e.writer.position()-s)})(e,t);break;case"opus":((e,t)=>{const i=e.writer.position();Pt(e,Et("dOps"),0),e.writer.writeUint8(0);const s=t.decoderConfig,n=new DataView(s.buffer,s.byteOffset,s.byteLength);e.writer.writeUint8(n.getUint8(9)),e.writer.writeUint16(n.getUint16(10,!0)),e.writer.writeUint32(n.getUint32(12,!0)),e.writer.writeUint16(n.getUint16(16,!0)),e.writer.writeBytes(t.decoderConfig.slice(18)),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t)}t.bitrate&&(Pt(e,Et("btrt"),12),e.writer.writeUint32(0),e.writer.writeUint32(t.bitrate),e.writer.writeUint32(t.bitrate)),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t),e.writer.writeUint32At(s,e.writer.position()-s),Mt(e,Et("stts"),4,0,0),e.writer.writeUint32(0),Mt(e,Et("stsc"),4,0,0),e.writer.writeUint32(0),Mt(e,Et("stsz"),8,0,0),e.writer.writeUint32(0),e.writer.writeUint32(0),Mt(e,Et("stco"),4,0,0),e.writer.writeUint32(0),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t),e.writer.writeUint32At(i,e.writer.position()-i)},Wt=(e,t,i)=>{const s=e.writer.position();Pt(e,Ct.trak,0),((e,t,i)=>{const s=e.writer.position();Mt(e,Ct.tkhd,0,0,3),e.writer.writeUint32(0),e.writer.writeUint32(0),e.writer.writeUint32(t.trackId),e.writer.writeUint32(0),e.writer.writeUint32(t.duration*i/t.timescale),e.writer.writeUint32(0),e.writer.writeUint32(0),e.writer.writeUint16(0),e.writer.writeUint16(Ot(t)?1:0),e.writer.writeUint16(Ot(t)?256:0),e.writer.writeUint16(0),e.writer.writeBytes(new Uint8Array([0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0])),Dt(t)?(e.writer.writeUint32(65536*t.width),e.writer.writeUint32(65536*t.height)):Ot(t)&&(e.writer.writeUint32(0),e.writer.writeUint32(0)),e.writer.writeUint32At(s,e.writer.position()-s)})(e,t,i),((e,t)=>{const i=e.writer.position();Pt(e,Ct.mdia,0),((e,t)=>{Mt(e,Ct.mdhd,20,0,0),e.writer.writeUint32(0),e.writer.writeUint32(0),e.writer.writeUint32(t.timescale),e.writer.writeUint32(t.duration);const i=t.lang||"und",s=(31&i.charCodeAt(0))<<10|(31&i.charCodeAt(1))<<5|31&i.charCodeAt(2);e.writer.writeUint16(s),e.writer.writeUint16(0)})(e,t),((e,t)=>{const i=e.writer.position();Mt(e,Ct.hdlr,0,0,0),e.writer.writeUint32(0),e.writer.writeBytes(Et(Dt(t)?"vide":"soun")),e.writer.writeUint32(0),e.writer.writeUint32(0),e.writer.writeUint32(0),e.writer.writeBytes(Et(Dt(t)?"VideoHandler\0":"SoundHandler\0")),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t),Nt(e,t),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t),e.writer.writeUint32At(s,e.writer.position()-s)},Vt=(e,t,i,s)=>{const n=e.writer.position();Pt(e,Ct.moov,0),((e,t,i)=>{Mt(e,Ct.mvhd,96,0,0),e.writer.writeUint32(0),e.writer.writeUint32(0),e.writer.writeUint32(i),e.writer.writeUint32(0),e.writer.writeUint32(65536),e.writer.writeUint16(256),e.writer.writeBytes(new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0])),e.writer.writeUint32(2)})(e,0,i),t.forEach((t=>Wt(e,t,i))),((e,t)=>{const i=e.writer.position();Pt(e,Ct.mvex,0),t.forEach((t=>((e,t)=>{Mt(e,Ct.trex,20,0,0),e.writer.writeUint32(t.trackId),e.writer.writeUint32(1),e.writer.writeUint32(0),e.writer.writeUint32(0),e.writer.writeUint32(0)})(e,t))),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t),e.writer.writeUint32At(n,e.writer.position()-n)},zt=e=>e.isSync?33554432:16842752,Qt=(e,t)=>{const i=e.writer.position();Pt(e,Ct.moof,0),((e,t)=>{Mt(e,Ct.mfhd,4,0,0),e.writer.writeUint32(t)})(e,t.sequenceNumber),((e,t)=>{const i=e.writer.position();Pt(e,Ct.traf,0),((e,t)=>{const i=e.writer.position();Mt(e,Ct.tfhd,16,0,56),e.writer.writeUint32(t.trackId),e.writer.writeUint32(t.defaultDuration||0),e.writer.writeUint32(t.defaultSize||0),e.writer.writeUint32(t.defaultFlags||0),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t),((e,t)=>{const i=e.writer.position();Mt(e,Ct.tfdt,8,1,0);const s=Math.floor(t.timestamp/4294967296),n=(4294967295&t.timestamp)>>>0;e.writer.writeUint32(s),e.writer.writeUint32(n),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t),((e,t)=>{if(!t.samples[0])throw new Error("At least one sample must be provided");const i=t.samples.some((e=>!!e.compositionTimeOffset)),s=zt(t.samples[0])!==t.defaultFlags,n=t.samples.length>1;let r=1;s&&(r|=4),i&&(r|=2048),n&&(r|=512,r|=256,r|=1024);const o=e.writer.position();Mt(e,Ct.trun,16,1,r),e.writer.writeUint32(t.samples.length);const a=e.writer.position();e.writer.writeUint32(0),s&&e.writer.writeUint32(zt(t.samples[0]));for(const s of t.samples)n&&(e.writer.writeUint32(s.duration),e.writer.writeUint32(s.data.byteLength),e.writer.writeUint32(zt(s))),i&&e.writer.writeUint32(s.compositionTimeOffset||0);e.writer.writeUint32At(a,e.writer.position()+8),e.writer.writeUint32At(o,e.writer.position()-o)})(e,t),e.writer.writeUint32At(i,e.writer.position()-i)})(e,t),e.writer.writeUint32At(i,e.writer.position()-i)},Gt=(e,t)=>{const i=new Rt,s=e.filter((e=>Dt(e)&&Lt(e))).length>0;return e.filter((e=>Dt(e)&&_t(e))).length>0?Ut(i,It):Ut(i,s?xt:Bt),Vt(i,e,1e3),i.writer.buffer()},Xt=e=>{const t=new Rt;return Qt(t,e),((e,t)=>{const i=t.samples.reduce(((e,t)=>e+t.data.byteLength),0);Pt(e,Ct.mdat,i),t.samples.forEach((t=>e.writer.writeBytes(t.data)))})(t,e),t.writer.buffer()},Ht=e=>{const{sequenceParameterSets:t,pictureParameterSets:i}=bt(e),s=t[0],n=i[0];if(!s||!n)throw new Error("No sps or pps provided");return(e=>{var t;const i=new DataView(e),s=i.getUint8(1),n=i.getUint8(2),r=i.getUint8(3),o=new x(e,32);o.readUnsignedExpGolomb();let a=1;switch(s){case 100:case 110:case 122:case 244:case 44:case 83:case 86:case 118:case 128:case 138:case 144:if(a=o.readUnsignedExpGolomb(),3===a&&o.readBits(1),o.readUnsignedExpGolomb(),o.readUnsignedExpGolomb(),o.readBit(),o.readBit())for(let e=0;e<(3!=a?8:12);e++)if(o.readBit()){const t=e<6?16:64;let i=0,s=8,n=8;for(let e=0;e<t;e++)0!=n&&(i=o.readSignedExpGolomb(),n=(s+i+256)%256),s=0==n?s:n}}o.readUnsignedExpGolomb();const h=o.readUnsignedExpGolomb();if(0==h)o.readUnsignedExpGolomb();else if(1==h)throw new Error("Unhandled case");o.readUnsignedExpGolomb(),o.readBit();const d=o.readUnsignedExpGolomb(),c=o.readUnsignedExpGolomb(),l=o.readBit();0===l&&o.readBit(),o.readBit();let u=d+1,m=c+1;if(m*=2-l,m*=16,u*=16,o.readBit()){const e=1<<(1==a||2==a?1:0),t=2-l<<(1==a?1:0);u-=o.readUnsignedExpGolomb()*e+o.readUnsignedExpGolomb()*e,m-=o.readUnsignedExpGolomb()*t+o.readUnsignedExpGolomb()*t}let A={numerator:1,denumerator:1};return o.readBit()&&o.readBit()&&(A=null!=(t=yt[o.readBits(8)])?t:{numerator:0,denumerator:0}),{width:u,height:m,pixelAspectRatio:A,profileIdc:s,constraintFlags:n,levelIdc:r}})(s)},jt=e=>{const t=new x(e);return 1===t.peekBit()&&t.readBits(32),qt(t),Zt(t)},qt=e=>{const t=e.readBits(8);if(t>>7&1)return;const i=t>>3&15,s=t>>2&1,n=t>>1&1;return 1==s&&e.readBits(8),1==n&&(e=>{let t=0;for(let i=0;i<8;i++){const s=e.readBits(8);if(t|=(127&s)<<7*i,128&~s)break}})(e),{headerLength:1+s,type:i}},Zt=e=>{const t=e.readBits(3),i=0!==e.readBit(),s=0!==e.readBit();let n,r=!1,o=!1,a=!1,h=0,d=0;const c=[];if(s)e.readBits(5);else{if(o=0!==e.readBit(),o&&(n=(e=>{const t=e.readBits(32),i=e.readBits(32),s=0!==e.readBit();let n=0;return s&&(n=(e=>{let t=0;for(;t<100&&0===e.readBit();)t++;return t>=32?0:e.readBits(t)+(1<<t)-1})(e)+1),{timescale:i,equalPictureInterval:s,numUnitsInDisplayTick:t,numTicksPerPicture:n}})(e),r=0!==e.readBit(),r))throw new Error("Not implemented");a=0!==e.readBit();const t=e.readBits(5)+1;for(let i=0;i<t;i++){const t=e.readBits(12),i=e.readBits(5);let s=0;if(i>7&&(s=e.readBit()),r)throw new Error("decoderModelInfoPresentFlag==1");a&&0!==e.readBit()&&e.readBits(4),c.push({tier:s,operatingPointIdc:t,seqLevelIdx:i})}}const l=e.readBits(4)+1,u=e.readBits(4)+1,m=e.readBits(l)+1,A=e.readBits(u)+1;let g=!1;g=!s&&0!==e.readBit(),g&&(h=e.readBits(4)+2,d=e.readBits(3)+1);const p=0!==e.readBit(),f=0!==e.readBit(),v=0!==e.readBit();let w=!1,b=!1,y=!1,S=!1,E=!1,C=!1,T=!1,k=2,x=2,I=0;return s||(w=0!==e.readBit(),b=0!==e.readBit(),y=0!==e.readBit(),S=0!==e.readBit(),E=0!==e.readBit(),E&&(C=0!==e.readBit(),T=0!==e.readBit()),k=0!==e.readBit()?2:e.readBit(),x=k>0?e.readBit()>0?2:e.readBit():2,I=E?e.readBits(3):0),{seqProfile:t,stillPicture:i,reducedStillPictureHeader:s,timingInfoPresentFlag:o,timingInfo:null!=n?n:{equalPictureInterval:!1,numUnitsInDisplayTick:0,timescale:0,numTicksPerPicture:0},decoderModelInfoPresentFlag:r,initialDisplayDelayPresentFlag:a,operatingPoints:c,frameWidthBits:l,frameHeightBits:u,maxFrameWidth:m,maxFrameHeight:A,frameIdNumbersPresentFlag:g,deltaFrameIdLength:h,additionalFrameIdLength:d,use_128x128Superblock:p,enableFilterIntra:f,enableIntraEdgeFilter:v,enableInterintraCompound:w,enableMaskedCompound:b,enableWarpedMotion:y,enableDualFilter:S,enableOrderHint:E,enableJntComp:C,enableRefFrameMvs:T,seqForceScreenContentTools:k,seqForceIntegerMv:x,orderHintBits:I,enableSuperres:0!==e.readBit(),enableCdef:0!==e.readBit(),enableRestoration:0!==e.readBit(),colorConfig:Jt(e,t),filmGrainParamsPresent:0!==e.readBit()}},Jt=(e,t)=>{const i=0!==e.readBit();let s=8,n=!1;2===t&&i?s=0!==e.readBit()?12:10:t<=2&&(s=i?10:8),n=1!==t&&0!==e.readBit();const r=n?1:3;let o=2,a=2,h=2,d=!1,c=0,l=0,u=0,m=!1;return 0!==e.readBit()&&(o=e.readBits(8),a=e.readBits(8),h=e.readBits(8)),n?(d=0!==e.readBit(),c=1,l=1,u=0,m=!1,{highBitDepth:i,bitDepth:s,monoChrome:n,chromaSamplePosition:u,colorPrimaries:o,colorRange:d,matrixCoefficients:h,numPlanes:r,separateUvDeltaQ:m,subsamplingX:c,subsamplingY:l,transferCharacteristics:a}):1===o&&13==a&&0==h?(d=!0,c=0,l=0,{highBitDepth:i,bitDepth:s,monoChrome:n,chromaSamplePosition:u,colorPrimaries:o,colorRange:d,matrixCoefficients:h,numPlanes:r,separateUvDeltaQ:m,subsamplingX:c,subsamplingY:l,transferCharacteristics:a}):(d=0!==e.readBit(),0===t?(c=1,l=1):1===t?(c=0,l=0):12===s?(c=e.readBit(),l=0!==c?e.readBit():0):(c=1,l=0),0!==c&&0!==l&&(u=e.readBits(2)),m=0!==e.readBit(),{highBitDepth:i,bitDepth:s,monoChrome:n,chromaSamplePosition:u,colorPrimaries:o,colorRange:d,matrixCoefficients:h,numPlanes:r,separateUvDeltaQ:m,subsamplingX:c,subsamplingY:l,transferCharacteristics:a})},Yt=e=>!!(1&e),$t=()=>"wakeLock"in navigator&&-1===window.navigator.userAgent.indexOf("Samsung");class Kt{constructor(){g(this,"enabled",!1),g(this,"wakeLockVideo"),g(this,"_wakeLock",null),g(this,"handleVisibilityChange",(()=>{null!==this._wakeLock&&"visible"===document.visibilityState&&this.enable()})),$t()&&(this._wakeLock=null,document.addEventListener("visibilitychange",this.handleVisibilityChange),document.addEventListener("fullscreenchange",this.handleVisibilityChange))}_addSourceToVideo(e,t,i){const s=document.createElement("source");s.src=i,s.type=`video/${t}`,e.appendChild(s)}get isEnabled(){return this.enabled}attach(e){if(!$t()){if(!this.wakeLockVideo){const e=document.createElement("video");this.wakeLockVideo=e,this.wakeLockVideo.setAttribute("title","Live Stream"),this.wakeLockVideo.setAttribute("playsinline",""),this._addSourceToVideo(this.wakeLockVideo,"mp4","data:video/mp4;base64,AAAAHGZ0eXBNNFYgAAACAGlzb21pc28yYXZjMQAAAAhmcmVlAAAGF21kYXTeBAAAbGliZmFhYyAxLjI4AABCAJMgBDIARwAAArEGBf//rdxF6b3m2Ui3lizYINkj7u94MjY0IC0gY29yZSAxNDIgcjIgOTU2YzhkOCAtIEguMjY0L01QRUctNCBBVkMgY29kZWMgLSBDb3B5bGVmdCAyMDAzLTIwMTQgLSBodHRwOi8vd3d3LnZpZGVvbGFuLm9yZy94MjY0Lmh0bWwgLSBvcHRpb25zOiBjYWJhYz0wIHJlZj0zIGRlYmxvY2s9MTowOjAgYW5hbHlzZT0weDE6MHgxMTEgbWU9aGV4IHN1Ym1lPTcgcHN5PTEgcHN5X3JkPTEuMDA6MC4wMCBtaXhlZF9yZWY9MSBtZV9yYW5nZT0xNiBjaHJvbWFfbWU9MSB0cmVsbGlzPTEgOHg4ZGN0PTAgY3FtPTAgZGVhZHpvbmU9MjEsMTEgZmFzdF9wc2tpcD0xIGNocm9tYV9xcF9vZmZzZXQ9LTIgdGhyZWFkcz02IGxvb2thaGVhZF90aHJlYWRzPTEgc2xpY2VkX3RocmVhZHM9MCBucj0wIGRlY2ltYXRlPTEgaW50ZXJsYWNlZD0wIGJsdXJheV9jb21wYXQ9MCBjb25zdHJhaW5lZF9pbnRyYT0wIGJmcmFtZXM9MCB3ZWlnaHRwPTAga2V5aW50PTI1MCBrZXlpbnRfbWluPTI1IHNjZW5lY3V0PTQwIGludHJhX3JlZnJlc2g9MCByY19sb29rYWhlYWQ9NDAgcmM9Y3JmIG1idHJlZT0xIGNyZj0yMy4wIHFjb21wPTAuNjAgcXBtaW49MCBxcG1heD02OSBxcHN0ZXA9NCB2YnZfbWF4cmF0ZT03NjggdmJ2X2J1ZnNpemU9MzAwMCBjcmZfbWF4PTAuMCBuYWxfaHJkPW5vbmUgZmlsbGVyPTAgaXBfcmF0aW89MS40MCBhcT0xOjEuMDAAgAAAAFZliIQL8mKAAKvMnJycnJycnJycnXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXiEASZACGQAjgCEASZACGQAjgAAAAAdBmjgX4GSAIQBJkAIZACOAAAAAB0GaVAX4GSAhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZpgL8DJIQBJkAIZACOAIQBJkAIZACOAAAAABkGagC/AySEASZACGQAjgAAAAAZBmqAvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZrAL8DJIQBJkAIZACOAAAAABkGa4C/AySEASZACGQAjgCEASZACGQAjgAAAAAZBmwAvwMkhAEmQAhkAI4AAAAAGQZsgL8DJIQBJkAIZACOAIQBJkAIZACOAAAAABkGbQC/AySEASZACGQAjgCEASZACGQAjgAAAAAZBm2AvwMkhAEmQAhkAI4AAAAAGQZuAL8DJIQBJkAIZACOAIQBJkAIZACOAAAAABkGboC/AySEASZACGQAjgAAAAAZBm8AvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZvgL8DJIQBJkAIZACOAAAAABkGaAC/AySEASZACGQAjgCEASZACGQAjgAAAAAZBmiAvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZpAL8DJIQBJkAIZACOAAAAABkGaYC/AySEASZACGQAjgCEASZACGQAjgAAAAAZBmoAvwMkhAEmQAhkAI4AAAAAGQZqgL8DJIQBJkAIZACOAIQBJkAIZACOAAAAABkGawC/AySEASZACGQAjgAAAAAZBmuAvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZsAL8DJIQBJkAIZACOAAAAABkGbIC/AySEASZACGQAjgCEASZACGQAjgAAAAAZBm0AvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZtgL8DJIQBJkAIZACOAAAAABkGbgCvAySEASZACGQAjgCEASZACGQAjgAAAAAZBm6AnwMkhAEmQAhkAI4AhAEmQAhkAI4AhAEmQAhkAI4AhAEmQAhkAI4AAAAhubW9vdgAAAGxtdmhkAAAAAAAAAAAAAAAAAAAD6AAABDcAAQAAAQAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAwAAAzB0cmFrAAAAXHRraGQAAAADAAAAAAAAAAAAAAABAAAAAAAAA+kAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAALAAAACQAAAAAAAkZWR0cwAAABxlbHN0AAAAAAAAAAEAAAPpAAAAAAABAAAAAAKobWRpYQAAACBtZGhkAAAAAAAAAAAAAAAAAAB1MAAAdU5VxAAAAAAALWhkbHIAAAAAAAAAAHZpZGUAAAAAAAAAAAAAAABWaWRlb0hhbmRsZXIAAAACU21pbmYAAAAUdm1oZAAAAAEAAAAAAAAAAAAAACRkaW5mAAAAHGRyZWYAAAAAAAAAAQAAAAx1cmwgAAAAAQAAAhNzdGJsAAAAr3N0c2QAAAAAAAAAAQAAAJ9hdmMxAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAALAAkABIAAAASAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGP//AAAALWF2Y0MBQsAN/+EAFWdCwA3ZAsTsBEAAAPpAADqYA8UKkgEABWjLg8sgAAAAHHV1aWRraEDyXyRPxbo5pRvPAyPzAAAAAAAAABhzdHRzAAAAAAAAAAEAAAAeAAAD6QAAABRzdHNzAAAAAAAAAAEAAAABAAAAHHN0c2MAAAAAAAAAAQAAAAEAAAABAAAAAQAAAIxzdHN6AAAAAAAAAAAAAAAeAAADDwAAAAsAAAALAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAAiHN0Y28AAAAAAAAAHgAAAEYAAANnAAADewAAA5gAAAO0AAADxwAAA+MAAAP2AAAEEgAABCUAAARBAAAEXQAABHAAAASMAAAEnwAABLsAAATOAAAE6gAABQYAAAUZAAAFNQAABUgAAAVkAAAFdwAABZMAAAWmAAAFwgAABd4AAAXxAAAGDQAABGh0cmFrAAAAXHRraGQAAAADAAAAAAAAAAAAAAACAAAAAAAABDcAAAAAAAAAAAAAAAEBAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAkZWR0cwAAABxlbHN0AAAAAAAAAAEAAAQkAAADcAABAAAAAAPgbWRpYQAAACBtZGhkAAAAAAAAAAAAAAAAAAC7gAAAykBVxAAAAAAALWhkbHIAAAAAAAAAAHNvdW4AAAAAAAAAAAAAAABTb3VuZEhhbmRsZXIAAAADi21pbmYAAAAQc21oZAAAAAAAAAAAAAAAJGRpbmYAAAAcZHJlZgAAAAAAAAABAAAADHVybCAAAAABAAADT3N0YmwAAABnc3RzZAAAAAAAAAABAAAAV21wNGEAAAAAAAAAAQAAAAAAAAAAAAIAEAAAAAC7gAAAAAAAM2VzZHMAAAAAA4CAgCIAAgAEgICAFEAVBbjYAAu4AAAADcoFgICAAhGQBoCAgAECAAAAIHN0dHMAAAAAAAAAAgAAADIAAAQAAAAAAQAAAkAAAAFUc3RzYwAAAAAAAAAbAAAAAQAAAAEAAAABAAAAAgAAAAIAAAABAAAAAwAAAAEAAAABAAAABAAAAAIAAAABAAAABgAAAAEAAAABAAAABwAAAAIAAAABAAAACAAAAAEAAAABAAAACQAAAAIAAAABAAAACgAAAAEAAAABAAAACwAAAAIAAAABAAAADQAAAAEAAAABAAAADgAAAAIAAAABAAAADwAAAAEAAAABAAAAEAAAAAIAAAABAAAAEQAAAAEAAAABAAAAEgAAAAIAAAABAAAAFAAAAAEAAAABAAAAFQAAAAIAAAABAAAAFgAAAAEAAAABAAAAFwAAAAIAAAABAAAAGAAAAAEAAAABAAAAGQAAAAIAAAABAAAAGgAAAAEAAAABAAAAGwAAAAIAAAABAAAAHQAAAAEAAAABAAAAHgAAAAIAAAABAAAAHwAAAAQAAAABAAAA4HN0c3oAAAAAAAAAAAAAADMAAAAaAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAACMc3RjbwAAAAAAAAAfAAAALAAAA1UAAANyAAADhgAAA6IAAAO+AAAD0QAAA+0AAAQAAAAEHAAABC8AAARLAAAEZwAABHoAAASWAAAEqQAABMUAAATYAAAE9AAABRAAAAUjAAAFPwAABVIAAAVuAAAFgQAABZ0AAAWwAAAFzAAABegAAAX7AAAGFwAAAGJ1ZHRhAAAAWm1ldGEAAAAAAAAAIWhkbHIAAAAAAAAAAG1kaXJhcHBsAAAAAAAAAAAAAAAALWlsc3QAAAAlqXRvbwAAAB1kYXRhAAAAAQAAAABMYXZmNTUuMzMuMTAw"),Object.assign(this.wakeLockVideo.style,{position:"absolute",left:"-100%",top:"-100%"}),this.wakeLockVideo.addEventListener("loadedmetadata",(()=>{e.addEventListener("timeupdate",(()=>{e.currentTime>.5&&(e.currentTime=Math.random())}))}))}e&&e.appendChild(this.wakeLockVideo)}}enable(){return S(this,null,(function*(){var e,t;return $t()?navigator.wakeLock.request("screen").then((e=>{this._wakeLock=e,this.enabled=!0,this._wakeLock.addEventListener("release",(()=>{}))})).catch((()=>{this.enabled=!1})):(null!=(t=null==(e=this.wakeLockVideo)?void 0:e.play())?t:Promise.resolve()).then((e=>(this.enabled=!0,e))).catch((()=>{this.enabled=!1}))}))}disable(){var e,t;$t()?(this._wakeLock&&this._wakeLock.release(),this._wakeLock=null):(null==(e=this.wakeLockVideo)||e.pause(),null==(t=this.wakeLockVideo)||t.remove()),this.enabled=!1}unload(){document.removeEventListener("visibilitychange",this.handleVisibilityChange),document.removeEventListener("fullscreenchange",this.handleVisibilityChange),this.disable()}}const ei=/\r\n|\r|\n/;var ti,ii,si,ni,ri;class oi{constructor(e){v(this,ti),v(this,ii),w(this,ti,e),w(this,ii,0)}skipEmptyLines(){let e=0;for(;""===f(this,ti)[f(this,ii)];)y(this,ii)._++,e++;return e}readLine(){return f(this,ti)[y(this,ii)._++]}takeUntilEmptyLine(){const e=[];for(;""!==f(this,ti)[f(this,ii)];){const t=this.readLine();if(void 0===t)break;e.push(t)}return e}linesLeft(){return f(this,ti).length-f(this,ii)}}ti=new WeakMap,ii=new WeakMap;class ai{constructor(){v(this,si)}parse(e){const t=[],i=e.split(ei),s=new oi(i),n=s.readLine();if(!n||!n.startsWith("WEBVTT"))throw new Error("missing 'WEBVTT' signature");for(;""!==s.readLine(););for(;s.linesLeft()>0;){const e=b(this,si,ni).call(this,s);t.push(e),s.skipEmptyLines()}return t}}si=new WeakSet,ni=function(e){e.skipEmptyLines();const t=e.takeUntilEmptyLine(),i=new oi(t);let s,n=i.readLine();if(null!=n&&n.includes("--\x3e")||(s=n,n=i.readLine()),void 0===n)throw new Error("expected cue line");const[r,o]=n.split("--\x3e").map((e=>e.trim()));if(!r||!o)throw new Error(`a cue needs both start and end time start: ${r} end: ${o}`);const[a,h]=o.split(" ",1).map((e=>e.trim()));if(!a)throw new Error(`missing end time: ${a}`);const d=i.readLine();if(!d)throw new Error("missing text");return{id:s,startTime:b(this,si,ri).call(this,r),endTime:b(this,si,ri).call(this,a),text:d}},ri=function(e){const t=e.split(":");if(2==t.length){const[e=0,i=0]=t.map((e=>parseFloat(e)));return 60*e+i}const[i=0,s=0,n=0]=t.map((e=>parseFloat(e)));return 60*i*60+60*s+n};class hi extends s.E{constructor({type:e,autoplay:t,muted:i,logger:s,poster:n}){super(),g(this,"element"),g(this,"logger"),g(this,"seekTimes",new T(10)),g(this,"seekStartTime"),g(this,"_userProvidedMuted"),g(this,"timers",new de),g(this,"_userHasProvidedInput",!1),g(this,"_isPaused",!0),g(this,"isActivated",!1),g(this,"dummy"),g(this,"_iosHackEnterPiPMode",(()=>{const e=this.element.parentElement,t=this.element.clientWidth/this.element.clientHeight;this.element.style.position="fixed",this.element.style.opacity="0",this.element.style.pointerEvents="none",e&&(this.dummy=document.createElement("video"),this.dummy.style.paddingBottom="calc(100% / "+t+")",this.dummy.style.width="100%",this.dummy.style.height="0px",e.appendChild(this.dummy))})),g(this,"_iosHackExitPiPMode",(()=>{this.element.style.position="relative",this.element.style.opacity="1",this.element.style.pointerEvents="auto",this.dummy&&(this.dummy.remove(),this.dummy=void 0)})),g(this,"attach",(e=>{this.element.remove(),e.appendChild(this.element)})),g(this,"load",(()=>{this.timers.setInterval(this.onPlayPause,500),this.timers.setTimeout((()=>{this.timers.setInterval(this.onBufferStateChange,500)}),1e4)})),g(this,"unload",(()=>{this.timers.unload()})),g(this,"getPlaybackRate",(()=>this.element.playbackRate)),g(this,"getPlaybackState",(()=>this.element.readyState>=this.element.HAVE_FUTURE_DATA?"playing":"buffering")),g(this,"setPlaybackRate",(e=>{this.element.playbackRate=e})),g(this,"getBuffer",(()=>{const e=[],t=this.element.buffered;if(!t)return[];for(let i=0;i<t.length;i++)e.push({start:1e3*t.start(i),end:1e3*t.end(i)});return e})),g(this,"pause",(()=>{this._isPaused=!1,this.element.pause()})),g(this,"tryPlay",(()=>{this.element.muted=this._userProvidedMuted,this._play().catch(k)})),g(this,"play",(()=>{this.element.muted=this._userProvidedMuted,this._play().catch((e=>{if(e instanceof Error){const t=new be("Media Play Error",{source:e,isFatal:!1,code:"media_play_error"});this.emit("error",t)}}))})),g(this,"_play",(()=>S(this,null,(function*(){try{yield this.element.play(),this._userHasProvidedInput=!this.muted||this._userProvidedMuted}catch(e){if(!(e instanceof Error&&"NotAllowedError"===e.name))throw e;if(this._userHasProvidedInput=!1,!this.element.muted)return this.element.muted=!0,this.emit("needs user input",{forAudio:!0,forVideo:!1}),this._play();this.emit("needs user input",{forAudio:!0,forVideo:!0})}})))),g(this,"onEvent",(e=>{this.logger.trace(e.type,{state:this.element.readyState,event:e,playbackState:this.getPlaybackState()})})),g(this,"onVolumeChange",(()=>{this.logger.info("volume state",{isMuted:this.element.muted,volume:this.element.volume}),this.emit("volume state",{isMuted:this.element.muted,volume:this.element.volume})})),g(this,"onPlayPause",(()=>{this._isPaused!==this.element.paused&&(this._isPaused=this.element.paused,this.logger.info("player pause change",{paused:this.element.paused}),this.emit("media element state",this.element.paused?"paused":"playing"))})),g(this,"onBufferStateChange",(()=>{this.emit("buffer state",{isPaused:this.element.paused,buffered:this.getBuffer(),currentTime:this.currentTime,playbackState:this.getPlaybackState()})})),g(this,"onSeekStart",(()=>{this.seekStartTime=Date.now()})),g(this,"onSeekEnd",(()=>{this.seekStartTime&&(this.seekTimes.push(Date.now()-this.seekStartTime),this.seekStartTime=void 0)})),this.logger=s,this._userProvidedMuted=i,this.element=document.createElement(e),this.element instanceof HTMLVideoElement&&(this.element.playsInline=!0),this.element.controls=!1,this.element.autoplay=t,this.element.muted=i,this.element.style.display="block",this.element.style.width="100%",this.element.disableRemotePlayback=!0,this.element.setAttribute("poster","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAJCAQAAACRI2S5AAAAEElEQVR42mNkIAAYRxWAAQAG9gAKqv6+AwAAAABJRU5ErkJggg=="),this.onPlayPause(),setTimeout((()=>{!this.element||!n||this.element.setAttribute("poster",n)}),0),this.element.addEventListener("stalled",this.onEvent),this.element.addEventListener("canplay",this.onEvent),this.element.addEventListener("loadeddata",this.onEvent),this.element.addEventListener("loadedmetadata",this.onEvent),this.element.addEventListener("canplaythrough",this.onEvent),this.element.addEventListener("waiting",this.onEvent),this.element.addEventListener("playing",this.onPlayPause),this.element.addEventListener("pause",this.onPlayPause),this.element.addEventListener("seeked",this.onSeekEnd),this.element.addEventListener("seeking",this.onSeekStart),this.element.addEventListener("volumechange",this.onVolumeChange),this.element.addEventListener("timeupdate",this.onBufferStateChange),this.element.addEventListener("progress",this.onBufferStateChange)}get seekTime(){return this.seekTimes.isEmpty()?0:G(this.seekTimes.items())}get isSeeking(){return this.element.seeking}get currentTime(){return isNaN(this.element.currentTime)?0:1e3*this.element.currentTime}set currentTime(e){Number.isFinite(e)&&(this.element.currentTime=e/1e3)}get playbackRate(){return this.element.playbackRate}set playbackRate(e){this.element.playbackRate=e}get volume(){return this.element.volume}set volume(e){this.element.volume=e}get muted(){return this.element.muted}set muted(e){this._userProvidedMuted=e,this.element.muted=e}get userHasProvidedInput(){return this._userHasProvidedInput}get isPaused(){return this._isPaused}}const di=["minBufferTime","maxBufferTime","burstEnabled","sizeBasedResolutionCapEnabled","separateVideoSocketEnabled","videoCodecs"];class ci{constructor(e){g(this,"options"),g(this,"overrides",new Map),this.options=e}getOptions(){return this.options}addOverrides(e,t){this.overrides.set(e,t)}set(e,t){this.options[e]=t}get(e,t){var i,s;if(t&&(s=e,di.includes(s))){const s=null==(i=this.overrides.get(t))?void 0:i[e];if(void 0!==s)return s}return this.options[e]}getOverride(e,t){var i;return null==(i=this.overrides.get(t))?void 0:i[e]}}const li={cooldownTime:3e3,maxBufferingEvents:{last10Seconds:0},maxBufferingRatio:{last10Seconds:0},maxRecentDowngradesCount:3,maxDowngradeLookbackMs:6e4,minTimeSpentPlaying:{factor:.5,ratio:.1},maxCooldownRatio:2},ui=e=>t=>t>e,mi=class{constructor(e,t,i,s){g(this,"qualityOfServiceSource"),g(this,"config"),g(this,"emitter"),g(this,"logger"),g(this,"isSuspended",!1),g(this,"lastAdaptTime",Date.now()),g(this,"isEnabled",!0),g(this,"load",(()=>{this.emitter.on("buffer state",this.onBufferState),this.emitter.on("adapted level",this.onAdaptedLevel)})),g(this,"unload",(()=>{this.emitter.off("buffer state",this.onBufferState),this.emitter.off("adapted level",this.onAdaptedLevel)})),g(this,"suspend",(()=>{this.isSuspended=!0})),g(this,"unsuspend",(()=>{this.reset(),this.isSuspended=!1})),g(this,"reset",((e=0)=>{this.lastAdaptTime=Date.now()+e})),g(this,"getStatistics",(()=>({isAbrEnabled:this.isEnabled}))),g(this,"isQoSOk",(e=>{const t=this.qualityOfServiceSource.getLevelStats(e),{upgradesFromLevel:i,downgradesFromLevel:s}=null!=t?t:{upgradesFromLevel:[],downgradesFromLevel:[]},n=Date.now()-this.config.maxDowngradeLookbackMs,r=s.filter(ui(n)).length,o=i.filter(ui(n)).length;if(r-o>this.config.maxRecentDowngradesCount)return this.logger.debug("Recent downgrades count is over maximum",{downgrades:r-o,maxRecentDowngradesCount:this.config.maxRecentDowngradesCount}),!1;const a=this.qualityOfServiceSource.timeSpentPlayingInAtLeastLevelRatio(e),h=a*(this.qualityOfServiceSource.timeActive()-this.qualityOfServiceSource.timeSpentBuffering())/this.config.maxDowngradeLookbackMs;if(r>1&&h<this.config.minTimeSpentPlaying.factor)return this.logger.debug("Time spent playing is too low",{recentDowngrades:r,timeSpentPlayingInAtLeastLevelRatio:a}),!1;if(r>1&&a<this.config.minTimeSpentPlaying.ratio)return this.logger.debug("Time spent playing in at least this level is too low",{recentDowngrades:r,timeSpentPlayingInAtLeastLevelRatio:a}),!1;const d=Math.max(0,s.length-i.length-h),c=Date.now()-this.config.maxDowngradeLookbackMs*d,l=s.filter(ui(c)).length;return!(l&&d>this.config.maxCooldownRatio&&(this.logger.debug("Too many downgrades compared to time spent playing",{downgradesWithinCooldownTime:l,cooldownRatio:d}),1))})),g(this,"onBufferState",(e=>{if(!this.isEnabled||this.isSuspended||this.lastAdaptTime+this.config.cooldownTime>Date.now())return;const{bufferFullness:t,general:i}=this.qualityOfServiceSource.getMetrics(),s=this.qualityOfServiceSource.getBufferFullnessRegression();if(!s)return;const{slope:n}=s,r=s.predict(15),o=n<0,a=s.predict(15)<.4&&s.slope<0,h=s.predict(15)>.6,d=this.qualityOfServiceSource.timeSpentBufferingLast(3e4),c=this.qualityOfServiceSource.timeSpentActiveLast(3e4);t<.15&&d/c>.8?this.adaptLevel("reconnect"):i.decodeRate<=1?this.adaptLevel("downgrade"):a||t<.15?o&&t<.4&&r<.2&&this.adaptLevel("buffering"===e.playbackState?"double downgrade":"downgrade"):t>.5&&h&&!this.tooMuchTimeBuffering(1e4)&&!this.tooManyBufferingEvents(1e4)&&this.adaptLevel("upgrade")})),g(this,"onAdaptedLevel",(()=>{this.reset()})),g(this,"adaptLevel",(e=>this.emitter.emit("adapt level",e))),this.qualityOfServiceSource=i,this.config=m(m({},li),s),this.emitter=e,this.logger=t}tooMuchTimeBuffering(e){return this.qualityOfServiceSource.timeSpentBufferingLast(e)/this.qualityOfServiceSource.timeSpentActiveLast(e)>this.config.maxBufferingRatio.last10Seconds}tooManyBufferingEvents(e){return this.qualityOfServiceSource.timeSpentBufferingLast(e)>this.config.maxBufferingEvents.last10Seconds}};g(mi,"create",((e,t,i,s={})=>new mi(e,t,i,s)));let Ai=mi;const gi={minBufferTime:1500,maxBufferTime:1500,cooldownTime:3e4,maxBufferingEvents:{last30Seconds:3},maxBufferingRatio:{last30Seconds:.15}},pi=class e{constructor(t,i,s,n,r){g(this,"qualityOfServiceSource"),g(this,"targetBufferTimeTarget"),g(this,"config"),g(this,"emitter"),g(this,"logger"),g(this,"isSuspended",!1),g(this,"lastIncreaseTime",Date.now()),g(this,"bufferTimeAdjustmentCount",0),g(this,"load",(()=>{this.emitter.on("buffer state",this.onBufferState)})),g(this,"unload",(()=>{this.emitter.off("buffer state",this.onBufferState)})),g(this,"suspend",(()=>{this.isSuspended=!0})),g(this,"unsuspend",(()=>{this.reset(),this.isSuspended=!1})),g(this,"reset",(()=>{this.lastIncreaseTime=Date.now()})),g(this,"getStatistics",(()=>({bufferTimeAdjustmentCount:this.bufferTimeAdjustmentCount}))),g(this,"onBufferState",(t=>{const{minBufferTime:i,maxBufferTime:s,cooldownTime:n}=this.config;if(this.isSuspended||this.lastIncreaseTime+n>Date.now()||this.targetBufferTimeTarget.targetBufferTime>=s)return;const r=this.qualityOfServiceSource.timeSpentBufferingLast(3e4),o=this.qualityOfServiceSource.bufferingEventsLast(3e4),a=r/this.qualityOfServiceSource.timeSpentActiveLast(3e4),h=Math.ceil(Math.max((s-i)/(e.BUFFER_TIME_MAX_STEPS-1),e.BUFFER_TIME_STEP_SIZE));(a>this.config.maxBufferingRatio.last30Seconds||o>this.config.maxBufferingEvents.last30Seconds)&&(this.targetBufferTimeTarget.targetBufferTime=Math.min(s,this.targetBufferTimeTarget.targetBufferTime+h),this.bufferTimeAdjustmentCount++,this.reset())})),this.qualityOfServiceSource=s,this.targetBufferTimeTarget=n,this.config=m(m({},gi),r),this.emitter=t,this.logger=i}updateConfig(e){this.config=m(m({},this.config),e)}};g(pi,"BUFFER_TIME_STEP_SIZE",500),g(pi,"BUFFER_TIME_MAX_STEPS",3),g(pi,"create",((e,t,i,s,n={})=>new pi(e,t,i,s,n)));let fi=pi;class vi extends s.E{constructor(e,t){super(),g(this,"options"),g(this,"websockets",[]),g(this,"logger"),g(this,"reconnectState",{reconnectRetries:0}),g(this,"isSuspended",!1),g(this,"_connectionAttemptCount",0),g(this,"connectStartTime",0),g(this,"_connectTime"),g(this,"shouldContinueConnecting",!1),g(this,"_isConnectInProgress",!1),g(this,"readyState",(()=>{if(0===this.websockets.length)return WebSocket.CLOSED;const e=this.websockets.map((e=>e.readyState));for(const t of e)if(t!==WebSocket.OPEN)return t;return WebSocket.OPEN})),g(this,"url",(()=>{var e;return null==(e=this.websockets[0])?void 0:e.url})),g(this,"send",(e=>{var t;this.websockets.length&&(null==(t=this.websockets[0])||t.send(e))})),g(this,"close",(e=>{var t;let i=!1;return null==(t=this.websockets)||t.forEach((t=>{t.onmessage=k,t.removeEventListener("error",this.onError),t.removeEventListener("close",this.onClose),t.removeEventListener("open",this.onOpen),t.close(1e3,e),i=!0})),this.websockets=[],this.shouldContinueConnecting=!1,this._isConnectInProgress=!1,this.logger.info("Closed websocket",{reason:e}),i})),g(this,"suspend",(()=>{this.isSuspended=!0})),g(this,"unsuspend",(()=>{this.isSuspended=!1,this.readyState()!==WebSocket.OPEN&&!this.isConnectInProgress&&this.connect()})),g(this,"onMessage",((e,t)=>{0!==this.websockets.length&&this.options.onMessage(e,t.data)})),g(this,"onError",(()=>{this.logger.info("On error",m({},this.options)),this.close("one websocket had an error"),this.emit("error",new be("WebSocket error",{code:"websocket_error",isFatal:!1}))})),g(this,"onClose",(e=>{switch(this.logger.info("Closed",A(m({},this.options),{reason:e.reason,code:e.code,isSuspended:this.isSuspended})),this.close("one websocket was closed"),e.code){case 4e3:case 4001:this.emit("error",xe(ke()));break;case 4002:this.emit("error",(i=ke(),new be("Authentication Expired",{isFatal:!0,code:"authentication_expired",source:i})));break;case 4003:this.emit("error",Ie("internal",ke()));break;case 4010:this.emit("error",(t=ke(),new be("Connection closed due to inactivity",{isFatal:!1,code:"connection_inactivity",source:t,type:"internal"})))}var t,i;this.emit("close",this)})),g(this,"onOpen",(()=>{this.logger.info("Opened",m({},this.options)),this.readyState()===WebSocket.OPEN&&(this._connectTime=Date.now()-this.connectStartTime,this.reconnectState.reconnectRetries=0,this._isConnectInProgress=!1,this.emit("open",this))})),g(this,"connect",((e=!1)=>S(this,null,(function*(){if(this.isConnectInProgress)return this.logger.info("Connect already in progress"),!1;if(this.isSuspended)return!1;if(this.readyState()!==WebSocket.CLOSED&&this.close("new connection in progress"),this.shouldContinueConnecting=!0,this._isConnectInProgress=!0,e&&this.options.reconnectDelay>0){this.logger.info("Waiting for reconnect delay",m({},this.options)),yield le(this.options.reconnectDelay);const e=yield this.options.reconnectHandler(this.reconnectState);if(this.reconnectState.reconnectRetries++,!e)return this._isConnectInProgress=!1,this.emit("error",Be()),!1}this._connectionAttemptCount++;try{if(!this.shouldContinueConnecting)return this._isConnectInProgress=!1,this.logger.info("Connection aborted"),!1;const{url:e,connectionCount:t}=yield this.options.connectHandler();if(this.connectStartTime=Date.now(),!this.shouldContinueConnecting)return this._isConnectInProgress=!1,this.logger.info("Connection aborted"),!1;this.logger.info("Connecting websockets",A(m({},this.options),{url:e}));for(let i=0;i<t;i++){const t=new WebSocket(e);t.binaryType="arraybuffer",t.onmessage=e=>this.onMessage(i,e),t.addEventListener("error",this.onError),t.addEventListener("close",this.onClose),t.addEventListener("open",this.onOpen),this.websockets.push(t)}return!0}catch(e){return this._isConnectInProgress=!1,e instanceof be&&(this.logger.error("Failed to connect",e.toStringifiable()),e.isFatal())||this.shouldContinueConnecting&&(this.logger.info("Connection aborted",{error:e}),this.emit("error",new be("Failed to connect",{code:"failed_to_connect",isFatal:!1,source:e,type:"internal"}))),!1}})))),this.options=e,this.logger=t}get isConnectInProgress(){return this._isConnectInProgress}get connectionCount(){return this.websockets.length}get connectionAttemptCount(){return this._connectionAttemptCount}get connectTime(){return this._connectTime}}const wi=e=>471859200/e,bi=class e{constructor(t,i,s){g(this,"emitter"),g(this,"transport"),g(this,"logger"),g(this,"config"),g(this,"rtts",new T(10)),g(this,"lastPingSentTime",Date.now()),g(this,"isPingInFlight",!1),g(this,"connectCount",0),g(this,"_firstConnectionTime"),g(this,"_lastConnectionTime"),g(this,"missedPings",0),g(this,"_estimatedPingBandwidth"),g(this,"contextSwitchesInProgress",new Set),g(this,"contextSwitchesCompleted",new Set),g(this,"buffer",[]),g(this,"disconnected",new C),g(this,"unload",(()=>{this.logger.debug("Unloading module..."),this.close("Unloading"),this.emitter.off("send signal",this.sendSignal),this.emitter.off("disconnect",this.close),this.emitter.off("reconnect",this.reconnect),this.logger.debug("Unloaded module")})),g(this,"suspend",(()=>{this.resetPingState(),this.transport.suspend()})),g(this,"unsuspend",(()=>{this.transport.unsuspend()})),g(this,"getState",(()=>{switch(this.transport.readyState()){case WebSocket.OPEN:return"connected";case WebSocket.CONNECTING:return"connecting";default:return"disconnected"}})),g(this,"sendSignal",(e=>{this.logger.debug("sending signal",{signal:e}),this.transport.readyState()===WebSocket.OPEN?this.transport.send(JSON.stringify(e)):this.logger.debug("transport is closed")})),g(this,"getStatistics",(()=>{var e;const t=X(this.rtts.items());return{rtt:t,estimatedBandwidth:wi(t.average),edgeUrl:null==(e=this.transport)?void 0:e.url(),connectionProtocol:"vindral_ws"}})),g(this,"onMessage",((e,t)=>{var i;if(this.pingCooldownExpired()&&this.sendPing(),this.contextSwitchesCompleted.size===(null==(i=this.transport)?void 0:i.connectionCount)){this.logger.info("Completing context switch"),this.contextSwitchesInProgress.clear(),this.contextSwitchesCompleted.clear();const e=this.buffer.filter((([e,t])=>!(t instanceof ArrayBuffer))),t=this.buffer.filter((([e,t])=>t instanceof ArrayBuffer));e.map((e=>this.handleMessage(e[0],e[1]))),t.map((e=>this.handleMessage(e[0],e[1]))),this.buffer=[]}if(this.contextSwitchesInProgress.has(e)){if(!(t instanceof ArrayBuffer)){const i=JSON.parse(t);if(ve(i)&&"context switch complete"===i.type)return this.logger.info("context switch completed",{socketId:e}),this.emitter.emit("context switch complete"),void this.contextSwitchesCompleted.add(e)}this.buffer.push([e,t])}else this.handleMessage(e,t)})),g(this,"resolveEdgeUrl",(()=>S(this,null,(function*(){const e=this.config.connectInfo,t=yield this.config.onConnectInfo(e),i=this.config.options.getOverride("separateVideoSocketEnabled",t.channelId);let s=1;"audio+video"===this.config.options.get("media")&&(s=!1!==i?2:1);const n=((e,t)=>{const i=new URL("/subscribe",e);return i.searchParams.append("channelId",t.channelId),i.searchParams.append("sessionId",t.sessionId),i.searchParams.append("clientId",t.clientId),t.audio&&t.audio.codec&&(i.searchParams.append("audio.bitRate",Math.round(t.audio.bitRate).toString()),i.searchParams.append("audio.codec",t.audio.codec),t.audio.language&&i.searchParams.append("audio.language",t.audio.language)),t.video&&t.video.codec&&(i.searchParams.append("video.width",t.video.width.toString()),i.searchParams.append("video.height",t.video.height.toString()),i.searchParams.append("video.bitRate",Math.round(t.video.bitRate).toString()),i.searchParams.append("video.codec",t.video.codec)),t.expectAdditionalConnection&&i.searchParams.append("expectAdditionalConnection",t.expectAdditionalConnection.toString()),t.burstMs&&i.searchParams.append("burstMs",t.burstMs.toString()),t.channelGroupId&&i.searchParams.append("channelGroupId",t.channelGroupId),t.authToken&&(i.searchParams.append("auth.token",t.authToken),i.searchParams.append("auth.type","jwt")),i.toString()})(this.config.edgeUrl,{video:t.video,audio:t.audio,burstMs:t.burstMs,sessionId:t.sessionId,clientId:t.clientId,channelId:t.channelId,channelGroupId:t.channelGroupId,expectAdditionalConnection:s>1,authToken:this.config.options.get("authenticationToken")});return this.logger.debug("Resolved edge url",{edgeUrl:n}),{url:n,connectionCount:s}})))),g(this,"handleMessage",((e,t)=>{if(t instanceof ArrayBuffer)this.emitter.emit("received data",t);else{const i=JSON.parse(t);if(!ve(i))return;switch(i.type){case"pong":this.lastPingSentTime&&(this.rtts.push(Date.now()-this.lastPingSentTime),this.isPingInFlight=!1,this.emitter.emit("rtt",this.rtt));break;case"context switch":this.logger.info("Starting context switch",{socketId:e}),this.emitter.emit("context switch started"),this.contextSwitchesInProgress.add(e);break;default:this.emitter.emit("received signal",i)}}})),g(this,"connectWebSocketTransport",(()=>{const e=new vi({reconnectDelay:1e3,onMessage:this.onMessage,reconnectHandler:this.config.reconnectHandler,connectHandler:this.resolveEdgeUrl},this.logger.createContext("Transport"));return e.on("open",this.onTransportChange),e.on("close",this.onTransportChange),e.on("error",(e=>this.disconnected.reject(e))),e.connect(),e})),g(this,"close",((e="Disconnect Requested")=>{var t;this.contextSwitchesCompleted.clear(),this.contextSwitchesInProgress.clear(),this.buffer=[],this.resetPingState(),this.disconnected.resolve(),null==(t=this.transport)||t.close(e)})),g(this,"onTransportChange",(()=>{var t;"connected"===this.getState()?(null!=(t=this.transport)&&t.connectTime&&(this.rtts.push(this.transport.connectTime/e.TLS_ROUNDTRIPS/this.transport.connectionCount),this.emitter.emit("rtt",this.rtt)),this._lastConnectionTime=Date.now(),this._firstConnectionTime||(this._firstConnectionTime=this._lastConnectionTime),this.connectCount++,this.resetPingState()):(this.contextSwitchesCompleted.clear(),this.contextSwitchesInProgress.clear(),this.buffer=[],this.resetPingState(),this.disconnected.resolve()),this.emitter.emit("connection state",this.getState())})),g(this,"reconnect",(e=>{this.transport.isConnectInProgress?this.logger.debug("Stopping reconnect, already mid-connection"):this.close(e)})),g(this,"resetPingState",(()=>{this.missedPings=0,this.isPingInFlight=!1})),g(this,"pingCooldownExpired",(()=>Date.now()-this.lastPingSentTime>e.PING_INTERVAL)),g(this,"sendPing",(()=>{if(this.isPingInFlight)return this.missedPings++,void(this.missedPings>e.MAX_MISSED_PINGS&&this.reconnect("missed pings"));this.isPingInFlight=!0,this.lastPingSentTime=Date.now(),this.missedPings=0,this.sendSignal({type:"ping"})})),this._estimatedPingBandwidth=wi(s.estimatedRtt),this.logger=i,this.emitter=t,this.config=s,this.emitter.on("send signal",this.sendSignal),this.emitter.on("disconnect",this.close),this.emitter.on("reconnect",this.reconnect),this.disconnected.promise.catch(k),this.transport=this.connectWebSocketTransport()}get rtt(){return this.rtts.items().length>0?G(this.rtts.items()):0}get estimatedBandwidth(){return this.rtt>0?wi(this.rtt):this._estimatedPingBandwidth}get firstConnectionTime(){return this._firstConnectionTime}get lastConnectionTime(){return this._lastConnectionTime}closed(){return this.disconnected.promise}};g(bi,"PING_INTERVAL",5e3),g(bi,"MAX_MISSED_PINGS",4),g(bi,"TLS_ROUNDTRIPS",3),g(bi,"start",((e,t,i)=>new Promise(((s,n)=>{const r=new bi(e,t,i);r.transport.once("error",(e=>n(e))),r.transport.once("open",(()=>s(r)))}))));let yi=bi;var Si,Ei,Ci,Ti,ki,xi,Ii,Bi,Ri,Pi,Mi;class Ui{constructor(e){v(this,Si),v(this,Ei,[]),v(this,Ci),w(this,Si,e)}select(e){if(f(this,Si).edgeUrl)return f(this,Si).edgeUrl;0===f(this,Ei).length&&w(this,Ei,f(this,Ei).concat(e));const t=f(this,Ei).shift();return w(this,Ci,t),t||void 0}shiftedEdge(){return f(this,Ci)}reset(){w(this,Ci,void 0),w(this,Ei,[])}}Si=new WeakMap,Ei=new WeakMap,Ci=new WeakMap;const Li=class e{constructor(t,i,s){v(this,Pi),g(this,"emitter"),g(this,"logger"),g(this,"config"),g(this,"apiClient"),g(this,"connectionImpl"),v(this,Ti,!0),v(this,ki),v(this,xi,0),v(this,Ii,0),g(this,"unload",(()=>{var e;this.logger.debug("Unloading module..."),this.disconnect("Unloading"),null==(e=this.connectionImpl)||e.unload(),this.logger.debug("Unloaded module")})),g(this,"suspend",(()=>{var e;w(this,Ti,!1),null==(e=this.connectionImpl)||e.suspend()})),g(this,"unsuspend",(()=>{var e;w(this,Ti,!0),null==(e=this.connectionImpl)||e.unsuspend(),this.connect()})),g(this,"getState",(()=>this.connectionImpl?this.connectionImpl.getState():"disconnected")),g(this,"getStatistics",(()=>this.connectionImpl?A(m({},this.connectionImpl.getStatistics()),{connectCount:f(this,Ii),connectionAttemptCount:f(this,xi)}):{rtt:{min:0,max:0,average:0,last:0},estimatedBandwidth:0,connectCount:f(this,Ii),connectionAttemptCount:f(this,xi),connectionProtocol:void 0})),g(this,"connect",(()=>{w(this,Ti,!0),!f(this,ki)&&w(this,ki,b(this,Pi,Mi).call(this))})),g(this,"disconnect",((e="Disconnect Requested")=>{var t;w(this,Ti,!1),null==(t=this.connectionImpl)||t.close(e)})),g(this,"reconnect",(e=>{this.disconnect(e),this.connect()})),v(this,Bi,(()=>S(this,null,(function*(){try{return yield this.apiClient.connect(this.config.options.getOptions())}catch(t){if((0,n.b)(t))switch(t.status){case 401:throw this.emitter.emit("error",xe(t)),xe(t);case 403:throw this.emitter.emit("error",Re(t.message)),Re(t.message)}throw this.emitter.emit("error",(e=t instanceof Error?t:void 0,new be("Connection attempt failed",{isFatal:!1,code:"connection_failed",source:e}))),t}var e})))),v(this,Ri,(()=>S(this,null,(function*(){const t=Date.now(),i=()=>Date.now()-t;return Promise.race([le(e.PING_TIMEOUT),fetch(new URL("/api/v4/connect/ping",this.config.options.get("url")).toString(),{method:"HEAD"})]).then(i,i)})))),this.logger=i,this.emitter=t,this.config=s,this.apiClient=new n.A({publicEndpoint:this.config.options.get("url").toString(),tokenFactory:()=>this.config.options.get("authenticationToken")})}get rtt(){var e,t;return null!=(t=null==(e=this.connectionImpl)?void 0:e.rtt)?t:0}get estimatedBandwidth(){var e;return(null==(e=this.connectionImpl)?void 0:e.estimatedBandwidth)||Number.MAX_SAFE_INTEGER}get firstConnectionTime(){var e;return null==(e=this.connectionImpl)?void 0:e.firstConnectionTime}get lastConnectionTime(){var e;return null==(e=this.connectionImpl)?void 0:e.lastConnectionTime}};Ti=new WeakMap,ki=new WeakMap,xi=new WeakMap,Ii=new WeakMap,Bi=new WeakMap,Ri=new WeakMap,Pi=new WeakSet,Mi=function(){return S(this,null,(function*(){var e;const t=new Ui({edgeUrl:this.config.options.get("edgeUrl")});for(w(this,xi,0);;){y(this,xi)._++;try{const[e,s]=yield Promise.all([f(this,Bi).call(this),f(this,Ri).call(this)]),r=s/2;if(!f(this,Ti))break;const o=t.select(e.edges);if(!o)throw new be("Failed to resolve edge url",{isFatal:!0,code:"failed_to_resolve_edge_url"});if((0,n.i)(e)){const{MoqConnectionAdapter:t}=yield i.e(487).then(i.bind(i,4487));this.connectionImpl=yield t.start(this.emitter,this.logger,this.apiClient,A(m({},this.config),{connectInfo:e,estimatedRtt:r,edgeUrl:o}))}else(0,n.a)("string"==typeof o,"Edge URL is expected to be a string"),this.connectionImpl=yield yi.start(this.emitter,this.logger,A(m({},this.config),{connectInfo:e,estimatedRtt:r,edgeUrl:o}));t.reset(),y(this,Ii)._++,w(this,xi,0),yield this.connectionImpl.closed()}catch(e){this.logger.info("Failed to connect",e);const i=t.shiftedEdge();i&&this.emitter.emit("telemetry event",{code:"shifted_edge",edgeUrl:"string"==typeof i?i:i.moqUrl||i.moqWsUrl}),e instanceof be&&this.emitter.emit("error",e)}if(null==(e=this.connectionImpl)||e.unload(),this.connectionImpl=void 0,!f(this,Ti))break;if(!(yield this.config.reconnectHandler({reconnectRetries:f(this,xi)}))){this.emitter.emit("error",Be());break}if(yield le(1e3),!f(this,Ti))break}w(this,ki,void 0)}))},g(Li,"PING_TIMEOUT",1e3),g(Li,"create",((e,t,i)=>new Li(e,t,i)));let _i=Li;const Di=()=>({video:A(m({},fe()),{bitRate:pe()}),audio:{bitRate:pe()}}),Oi=class e{constructor(t,i,s,n){g(this,"emitter"),g(this,"timers",new de),g(this,"pictureInPictureSource"),g(this,"element"),g(this,"currentCap"),g(this,"userSpecifiedCap"),g(this,"renditionLevelSource"),g(this,"resizeObserver"),g(this,"elementSize"),g(this,"_sizeBasedResolutionCapEnabled"),g(this,"unload",(()=>{var e;this.emitter.off("enter picture in picture",this.enterPictureInPicture),this.emitter.off("exit picture in picture",this.exitPictureInPicture),null==(e=this.resizeObserver)||e.disconnect(),this.suspend()})),g(this,"load",(()=>{window.ResizeObserver&&(this.resizeObserver=new ResizeObserver(this.onResize),this.resizeObserver.observe(this.element)),this.evaluateConstraintCap()})),g(this,"unsuspend",(()=>{this.timers.setInterval(this.evaluateConstraintCap,e.CHECK_SIZE_INTERVAL),this.evaluateConstraintCap()})),g(this,"suspend",(()=>{this.timers.unload()})),g(this,"setUserSpecifiedCap",(e=>{var t;const i=null!=(t=this.getUserSpecifiedCap())?t:Di();this.userSpecifiedCap=A(m({},i),{video:m(m({},i.video),e.video),audio:m(m({},i.audio),e.audio)}),this.evaluateConstraintCap()})),g(this,"getUserSpecifiedCap",(()=>this.userSpecifiedCap)),g(this,"getCurrentConstraintCap",(()=>this.currentCap)),g(this,"getStatistics",(()=>({constraintCap:this.getUserSpecifiedCap(),windowInnerWidth:window.innerWidth,windowInnerHeight:window.innerHeight,elementWidth:this.elementSize.width,elementHeight:this.elementSize.height,pixelRatio:window.devicePixelRatio}))),g(this,"constrainSubscription",(e=>{const t=this.getCurrentConstraintCap();return t&&(e.video.codec&&(e.video.bitRate=Math.min(t.video.bitRate,e.video.bitRate),e.video.width=Math.min(t.video.width,e.video.width),e.video.height=Math.min(t.video.height,e.video.height)),e.audio.codec&&(e.audio.bitRate=Math.min(t.audio.bitRate,e.audio.bitRate))),e})),g(this,"onResize",(e=>{e.forEach((e=>{this.elementSize={width:e.contentRect.width,height:e.contentRect.height}}))})),g(this,"evaluateConstraintCap",(()=>{var e,t,i,s,n;const r=this.sizeBasedResolutionCapEnabled?A(m({},Di()),{video:{width:window.innerWidth,height:window.innerHeight,bitRate:pe()}}):Di();if(!this.resizeObserver){const e=this.element.getBoundingClientRect();this.elementSize={width:e.width,height:e.height}}if(this.sizeBasedResolutionCapEnabled){const t=window.devicePixelRatio,i=null==(e=this.pictureInPictureSource)?void 0:e.getPictureInPictureSize();this.elementSize.width>0&&this.elementSize.height>0&&(r.video.width=this.elementSize.width,r.video.height=this.elementSize.height),i&&(r.video.width=i.width,r.video.height=i.height),r.video.width*=t,r.video.height*=t}const o=this.renditionLevelSource.getRenditionLevels().find((e=>{if(e.video)return e.video.width/e.video.height>r.video.width/r.video.height?e.video.width>r.video.width:e.video.height>r.video.height}));o&&o.video&&(r.video.width=o.video.width,r.video.height=o.video.height);const a=null==(t=this.userSpecifiedCap)?void 0:t.video,h=null==(i=this.userSpecifiedCap)?void 0:i.audio;a&&r.video.width>a.width&&r.video.height>a.height&&(r.video.width=a.width,r.video.height=a.height),r.video.bitRate=null!=(s=null==a?void 0:a.bitRate)?s:r.video.bitRate,r.audio.bitRate=null!=(n=null==h?void 0:h.bitRate)?n:r.audio.bitRate,j(r,this.currentCap)?this.currentCap=m({},r):(this.currentCap=m({},r),this.emitter.emit("constraint cap changed",r))})),g(this,"enterPictureInPicture",(e=>{this.pictureInPictureSource=e,this.evaluateConstraintCap()})),g(this,"exitPictureInPicture",(()=>{this.pictureInPictureSource=void 0,this.evaluateConstraintCap()})),this.element=i;const r=this.element.getBoundingClientRect();this.elementSize={width:r.width,height:r.height},this.emitter=t,this.renditionLevelSource=s,this._sizeBasedResolutionCapEnabled=n,this.emitter.on("enter picture in picture",this.enterPictureInPicture),this.emitter.on("exit picture in picture",this.exitPictureInPicture)}get sizeBasedResolutionCapEnabled(){return this._sizeBasedResolutionCapEnabled}set sizeBasedResolutionCapEnabled(e){this._sizeBasedResolutionCapEnabled=e,this.evaluateConstraintCap()}};g(Oi,"CHECK_SIZE_INTERVAL",1e3),g(Oi,"create",((e,t,i,s)=>new Oi(e,t,i,s)));let Fi=Oi;class Ni{constructor(e,t,i,s){g(this,"timers",de.create()),g(this,"logger"),g(this,"emitter"),g(this,"trackContexts"),g(this,"playbackSource"),g(this,"isSuspended",!1),g(this,"load",(()=>{this.timers.setInterval(this.emitDecodedFrames,100),this.timers.setInterval(this.emitDecodeRate,1e3),this.emitter.on("init segment",this.onInitSegment),this.emitter.on("coded sample",this.decode)})),g(this,"unload",(()=>{this.trackContexts.forEach((({decoderContext:e})=>e.unload())),this.timers.unload(),this.emitter.off("init segment",this.onInitSegment),this.emitter.off("coded sample",this.decode)})),g(this,"suspend",(()=>{this.isSuspended=!0})),g(this,"unsuspend",(()=>{this.isSuspended=!1})),g(this,"getBuffer",(e=>{var t;return null==(t=this.trackContexts.get(e))?void 0:t.buffer})),g(this,"videoDecodeRate",(()=>{var e,t,i;const s=this.trackContexts.get("video"),n=null!=(e=null==s?void 0:s.sampleDuration)?e:40,r=X(null!=(t=null==s?void 0:s.decodeTime.items())?t:[]),o=X(null!=(i=null==s?void 0:s.transportTime.items())?i:[]);return n/(r.average+o.average)})),g(this,"getStatistics",(()=>{var e,t,i,s;const n=this.trackContexts.get("video"),r=X(null!=(e=null==n?void 0:n.decodeTime.items())?e:[]),o=X(null!=(t=null==n?void 0:n.transportTime.items())?t:[]),a=X(null!=(s=null==(i=this.trackContexts.get("audio"))?void 0:i.decodeTime.items())?s:[]);return{videoDecodeRate:this.videoDecodeRate(),videoDecodeTime:r,audioDecodeTime:a,videoTransportTime:o}})),g(this,"onInitSegment",(({initSegment:e})=>{var t;const i=null==(t=this.trackContexts.get(e.type))?void 0:t.decoderContext;if(!i)throw new be("No known decoder context",{code:"no_known_decoder_context",isFatal:!1});i.initSegment(e)})),g(this,"decode",(e=>{const t=this.trackContexts.get(e.type);if(!t)throw new be("No known decoder context",{code:"no_known_decoder_context",isFatal:!1});if(this.isSuspended)return;t.sampleDuration=e.duration/e.timescale*1e3;const{decoderContext:i,buffer:s}=t,n=e.timestamp/e.timescale*1e3,r=e.duration/e.timescale*1e3,o=s[s.length-1];!o||n-5>o.end?s.push({start:n,end:n+r}):n+5*r<o.end?t.buffer=[{start:n,end:n+r}]:o.end=n+r,i.enqueue(e),this.emitDecodedFrames()})),g(this,"emitDecodedFrames",(()=>{let e;this.updateBufferState(),this.trackContexts.forEach((t=>{var i,s;let n;for(;void 0!==(n=null==(s=(i=t.decoderContext).error)?void 0:s.call(i));)this.emitter.emit("error",ye(!1,n));for(;void 0!==(e=t.decoderContext.take());){const{statistics:i}=e;i&&(t.decodeTime.push(i.decodeTime),t.transportTime.push((i.transportTimeToWorker+i.transportTimeFromWorker)/i.samplesInBatch)),this.emitter.emit("decoded frame",e)}}))})),g(this,"emitDecodeRate",(()=>{this.emitter.emit("video decode rate",this.videoDecodeRate())})),g(this,"updateBufferState",(()=>{var e,t;let i;if(this.trackContexts.forEach((e=>{var t,s,n,r;if(i){const o=null!=(s=null==(t=e.buffer[e.buffer.length-1])?void 0:t.end)?s:0;(null!=(r=null==(n=i[i.length-1])?void 0:n.end)?r:0)>o&&(i=e.buffer)}else i=e.buffer})),!i)return;const s=this.playbackSource.currentTime<(null!=(t=null==(e=i[i.length-1])?void 0:e.end)?t:0)?"playing":"buffering";this.emitter.emit("buffer state",{buffered:i,currentTime:this.playbackSource.currentTime,isPaused:this.playbackSource.isPaused,playbackState:s})})),this.logger=t,this.emitter=e,this.trackContexts=i,this.playbackSource=s}static create(e,t,s,n,r){return S(this,null,(function*(){const o=new Map;for(const e of s)switch(e.type){case"audio":{const{OpusDecoderContext:t}=yield i.e(767).then(i.bind(i,6767));o.set(e.type,{buffer:[],decoderContext:yield t.create(48e3,2),decodeTime:new T(100),transportTime:new T(100),sampleDuration:40});break}case"video":{const{H264DecoderWorkerContext:t}=yield i.e(515).then(i.bind(i,6515));o.set(e.type,{buffer:[],decoderContext:yield t.create(r),decodeTime:new T(100),transportTime:new T(100),sampleDuration:40});break}}return new Ni(e,t,o,n)}))}}const Wi=class{constructor(e){g(this,"emitter"),g(this,"isVisibleCount",0),g(this,"isHiddenCount",0),g(this,"isOnlineCount",0),g(this,"isOfflineCount",0),g(this,"isActive","visible"===document.visibilityState),g(this,"unload",(()=>{document.removeEventListener("visibilitychange",this.onVisibilityChanged),window.removeEventListener("pagehide",this.onPageHide),window.removeEventListener("online",this.onOnline),window.removeEventListener("offline",this.onOffline)})),g(this,"load",(()=>{document.addEventListener("visibilitychange",this.onVisibilityChanged),window.addEventListener("pagehide",this.onPageHide),window.addEventListener("online",this.onOnline),window.addEventListener("offline",this.onOffline)})),g(this,"unsuspend",(()=>{})),g(this,"getStatistics",(()=>{var e,t,i,s,n;return{isVisible:this.isVisible,isOnline:this.isOnline,isVisibleCount:this.isVisibleCount,isHiddenCount:this.isHiddenCount,isOnlineCount:this.isOnlineCount,isOfflineCount:this.isOfflineCount,navigatorRtt:null==(e=navigator.connection)?void 0:e.rtt,navigatorEffectiveType:null==(t=navigator.connection)?void 0:t.effectiveType,navigatorConnectionType:null==(i=navigator.connection)?void 0:i.type,navigatorSaveData:null==(s=navigator.connection)?void 0:s.saveData,navigatorDownlink:null==(n=navigator.connection)?void 0:n.downlink}})),g(this,"onOnline",(()=>this.isOnlineCount++)),g(this,"onOffline",(()=>this.isOfflineCount++)),g(this,"onPageHide",(e=>this.emitter.emit("pagehide",e))),g(this,"onVisibilityChanged",(()=>{this.setIsActive("visible"===document.visibilityState)})),g(this,"setIsActive",(e=>{e!==this.isActive&&(this.emitter.emit("page active",e),e?this.isVisibleCount++:this.isHiddenCount++),this.isActive=e})),this.emitter=e}get isOnline(){return navigator.onLine}get isVisible(){return"visible"===document.visibilityState}};g(Wi,"create",(e=>new Wi(e)));let Vi=Wi;const zi=class e{constructor(t,i,s){var n;g(this,"logger"),g(this,"emitter"),g(this,"waitingEvents",[]),g(this,"isTriggered",(n=e.EVENT_TIMEOUT,(e,t,i)=>e.timestamp<=t||e.timestampAdded<=i-n)),g(this,"timeSource"),g(this,"timers",new de),g(this,"load",(()=>{this.timers.setInterval(this.onBufferedStateChanged,e.EVENT_CHECK_INTERVAL),this.emitter.on("add event",this.addEvent)})),g(this,"unload",(()=>{this.timers.unload(),this.emitter.off("add event",this.addEvent)})),g(this,"addEvent",(e=>{this.logger.debug("Adding event",{event:e}),!this.waitingEvents.some((t=>void 0!==t.id&&t.id===e.id))&&this.waitingEvents.push(A(m({},e),{timestampAdded:Date.now()}))})),g(this,"extractEvent",((e,t)=>{"video"===t.type&&e.channelId!==t.channelId&&this.addEvent({type:"channel switch",channelId:t.channelId,timestamp:t.timestamp/t.timescale*1e3}),"audio"===t.type&&"audio"===e.type&&void 0!==t.language&&t.language!==e.language&&this.addEvent({type:"language switch",language:t.language,timestamp:t.timestamp/t.timescale*1e3})})),g(this,"onBufferedStateChanged",(()=>{var e;const t=Date.now(),i=null!=(e=this.timeSource.drift)?e:0,s=this.timeSource.serverCurrentTime-i;if(0===this.waitingEvents.length)return;const n=this.waitingEvents.filter((e=>this.isTriggered(e,s,t)));this.waitingEvents=this.waitingEvents.filter((e=>!this.isTriggered(e,s,t))),n.forEach((e=>{this.logger.debug("Emitting event",{event:e}),this.emitter.emit("event",e)}))})),this.logger=i,this.emitter=t,this.timeSource=s}};g(zi,"EVENT_TIMEOUT",5e3),g(zi,"EVENT_CHECK_INTERVAL",20),g(zi,"create",((e,t,i)=>new zi(e,t,i)));let Qi=zi;const Gi=class e{constructor(t){g(this,"emitter"),g(this,"timers",de.create()),g(this,"bytesReceived",new Map),g(this,"timeoutInterval"),g(this,"lastBytesUpdated",Date.now()),g(this,"load",(()=>{this.emitter.on("connection state",this.onConnectionState),this.timers.setInterval((()=>this.bytesReceived.forEach((e=>e.tick()))),100)})),g(this,"unload",(()=>{this.emitter.off("connection state",this.onConnectionState),this.timers.unload()})),g(this,"averageBitRate",(e=>{var t,i;return 8*(null!=(i=null==(t=this.bytesReceived.get(e))?void 0:t.average)?i:0)})),g(this,"totalBytesReceived",(()=>{let e=0;return this.bytesReceived.forEach((t=>{e+=t.total})),e})),g(this,"add",((t,i)=>{let s=this.bytesReceived.get(t);s||(s=new H(20),this.bytesReceived.set(t,s)),i>0&&(this.lastBytesUpdated=Date.now(),this.timeoutInterval||(this.timeoutInterval=this.timers.setInterval(this.checkTimeout,e.UPDATE_RECEIVED_BYTES_INTERVAL))),s.add(i)})),g(this,"getStatistics",(()=>({bytesReceived:this.totalBytesReceived(),videoBitRate:this.averageBitRate("video"),audioBitRate:this.averageBitRate("audio")}))),g(this,"onConnectionState",(t=>{this.clearTimeoutInterval(),"connected"===t&&(this.lastBytesUpdated=Date.now(),this.timeoutInterval=this.timers.setInterval(this.checkTimeout,e.UPDATE_RECEIVED_BYTES_INTERVAL))})),g(this,"checkTimeout",(()=>{const t=Date.now()-this.lastBytesUpdated;if(0===this.totalBytesReceived()&&t>e.NO_DATA_ERROR_TIMEOUT)return this.emitter.emit("error",new be("No Incoming Data",{isFatal:!1,code:"no_incoming_data_error",source:undefined})),this.emitter.emit("reconnect","no incoming data"),void this.clearTimeoutInterval();t>e.NO_DATA_TIMEOUT&&this.totalBytesReceived()>0&&(this.emitter.emit("no data timeout",this.totalBytesReceived()),this.clearTimeoutInterval())})),g(this,"clearTimeoutInterval",(()=>{this.timeoutInterval&&(this.timers.clearInterval(this.timeoutInterval),this.timeoutInterval=void 0)})),this.emitter=t}};g(Gi,"NO_DATA_ERROR_TIMEOUT",2e4),g(Gi,"NO_DATA_TIMEOUT",5e3),g(Gi,"UPDATE_RECEIVED_BYTES_INTERVAL",1e3),g(Gi,"create",(e=>new Gi(e)));let Xi=Gi;const Hi=class e extends s.E{constructor(){super(),g(this,"context",new(window.AudioContext||window.webkitAudioContext)),g(this,"timers",de.create()),g(this,"previousCurrentTime",0),g(this,"_isStuck",!1),g(this,"mediaStreamDestination"),g(this,"unload",(()=>(this.timers.unload(),this.context.removeEventListener("statechange",this.onStateChange),"closed"!==this.context.state?this.context.close():Promise.resolve()))),g(this,"createGain",(()=>this.context.createGain())),g(this,"createBuffer",((e,t,i)=>this.context.createBuffer(e,t,i))),g(this,"createBufferSource",(()=>this.context.createBufferSource())),g(this,"getMediaStreamDestination",(()=>(this.mediaStreamDestination||(this.mediaStreamDestination=this.context.createMediaStreamDestination()),this.mediaStreamDestination))),g(this,"getDefaultDestination",(()=>this.context.destination)),g(this,"createSplitter",(()=>this.context.createChannelSplitter(2))),g(this,"resume",(()=>S(this,null,(function*(){try{return yield Promise.race([this.context.resume(),ue(1e3,new be("Web Audio Context resume timeout",{isFatal:!1,code:"web_audio_context_resume_timeout"}))])}catch(e){throw this.suspend().catch(k),e}})))),g(this,"suspend",(()=>S(this,null,(function*(){var e;yield null!=(e=this.context.suspend())?e:Promise.resolve()})))),g(this,"onStateChange",(()=>this.emit("state",this.state))),this.context.addEventListener("statechange",this.onStateChange),this.timers.setInterval((()=>{this._isStuck=this.isRunning&&this.context.currentTime===this.previousCurrentTime,this._isStuck&&this.emit("stuck"),this.previousCurrentTime=this.context.currentTime}),e.CHECK_INTERVAL)}get isStuck(){return this._isStuck}get isRunning(){return"running"===this.state}get currentTime(){return this.context.currentTime}get sampleRate(){return this.context.sampleRate}get state(){return this.context.state}};g(Hi,"CHECK_INTERVAL",1e3);let ji=Hi;const qi=class extends s.E{constructor(e,t,{muted:i,reInitWhenStuck:s}){super(),g(this,"logger"),g(this,"audio"),g(this,"gainNode"),g(this,"splitter"),g(this,"_volume",1),g(this,"_userProvidedMuted",!1),g(this,"_muted",!1),g(this,"startTime",0),g(this,"samples",new Float32Array(new ArrayBuffer(38400))),g(this,"preInitSampleQueue",new T(500)),g(this,"unplayedBufferSources",new T(100)),g(this,"sampleRate",48e3),g(this,"channels",2),g(this,"index",0),g(this,"clockSource"),g(this,"clockDelta"),g(this,"startTimeIsInvalidated",!0),g(this,"lastSampleTimestamp",0),g(this,"reInitWhenStuck"),g(this,"ignoreSuspendCalls",!1),g(this,"isActivated",!1),g(this,"unload",(()=>S(this,null,(function*(){var e,t;null==(e=this.gainNode)||e.disconnect(),yield null==(t=this.audio)?void 0:t.unload(),this.reset(),this.audio=void 0,this.gainNode=void 0})))),g(this,"suspend",(()=>{this.setGain(0)})),g(this,"unsuspend",(()=>{var e;this.setGain(this._volume),this.ignoreSuspendCalls=!!this.audio,null==(e=this.audio)||e.suspend().then((()=>S(this,null,(function*(){yield this.resume(),this.ignoreSuspendCalls=!1})))).catch((()=>{this.ignoreSuspendCalls=!1,this.emit("state change","suspended")}))})),g(this,"flush",(()=>{if(!this.audio||!this.gainNode)throw new be("AudioContext must be initialized to flush",{isFatal:!1,code:"audiocontext_must_be_initialized"});const e=this.samples.length/this.channels,t=this.audio.createBufferSource(),i=this.audio.createBuffer(this.channels,e,this.sampleRate);let s=0;for(let t=0;t<this.channels;t++){s=t;const n=i.getChannelData(t);for(let t=0;t<e;t++)n[t]=this.samples[s],s+=this.channels}const n=Math.max(this.startTime,0);t.buffer=i,t.connect(this.gainNode),this.splitter&&t.connect(this.splitter),t.start(n),this.unplayedBufferSources.push([n,t]),this.startTime+=i.duration})),g(this,"onDecodedFrame",(e=>{if(this.gainNode&&this.audio&&this.audio.isRunning){for(;!this.preInitSampleQueue.isEmpty();){const e=this.preInitSampleQueue.items();this.preInitSampleQueue.clear(),e.forEach(this.onDecodedFrame)}if(this.unplayedBufferSources.filterPop((([e,t])=>{var i,s;return(null!=(s=null==(i=this.audio)?void 0:i.currentTime)?s:0)<e})),"audio"===e.type){const t=e.timestamp/e.timescale*1e3;if(t<this.lastSampleTimestamp&&(this.logger.info("Unordered timestamp - invalidating start time"),this.startTimeIsInvalidated=!0),this.lastSampleTimestamp=t,this.startTimeIsInvalidated){const e=1e3*this.audio.currentTime,i=this.clockSource.currentTime,s=(e+t-i)/1e3;this.clockDelta=i-e,this.startTime=s,this.startTimeIsInvalidated=!1,this.unplayedBufferSources.items().forEach((([e,t])=>{s<=e&&t.stop()}))}this.samples.set(e.data,this.index),this.index+=e.data.length,this.channels=e.channels,this.sampleRate=e.sampleRate,this.samples.length<=this.index&&(this.index=0,this.flush())}}else if("audio"===e.type){this.preInitSampleQueue.push(A(m({},e),{data:e.data.slice(0,e.data.length)}));const t=this.clockSource.currentTime;this.preInitSampleQueue.filterPop((({timestamp:e,timescale:i})=>e/i*1e3>t))}})),g(this,"play",(()=>S(this,null,(function*(){this.audio=this.getAudioContext(),yield this.resume()})))),g(this,"pause",(()=>{})),g(this,"flushBuffer",(()=>{this.unplayedBufferSources.items().forEach((([e,t])=>t.stop())),this.index=0})),g(this,"resume",(()=>S(this,null,(function*(){var e;if(!this._userProvidedMuted)try{yield null==(e=this.audio)?void 0:e.resume(),this._muted=this._userProvidedMuted,this.startTimeIsInvalidated=!0}catch(e){throw this._muted=!0,e}})))),g(this,"getAudioContext",(()=>this.audio?this.audio:this.setupContext())),g(this,"setupContext",(()=>{var e,t,i;return null==(e=this.audio)||e.unload(),this.audio=new ji,this.audio.on("state",(e=>{this.logger.info("AudioContext state change",{state:e}),"running"===e&&(this._muted=this._userProvidedMuted,this.setGain(this._volume)),!this.ignoreSuspendCalls&&this.emit("state change",e)})),this.audio.on("stuck",(()=>{this.reInitWhenStuck&&(this.logger.info("Re-init audio context"),this.setupContext(),this.resume().catch(k),this.emit("stuck"))})),null==(t=this.gainNode)||t.disconnect(),this.gainNode=this.audio.createGain(),this.setGain(this._volume),this.startTime=this.audio.currentTime,null==(i=this.splitter)||i.disconnect(),this.splitter=this.audio.createSplitter(),this.audio})),g(this,"setGain",(e=>{this.gainNode&&(this.gainNode.gain.value=this._muted?0:e)})),this._muted=i,this._userProvidedMuted=i,this.logger=e,this.clockSource=t,this.reInitWhenStuck=s}get isContextRunning(){var e;return"running"===(null==(e=this.audio)?void 0:e.state)}get volume(){return this._volume}set volume(e){this._volume=e,this.muted||this.setGain(e)}get seekTime(){return 0}get isSeeking(){return!1}get muted(){var e;return this._muted||!(null!=(e=this.audio)&&e.isRunning)}set muted(e){this._userProvidedMuted=e,this._muted=e,this.setGain(this._volume)}get isPaused(){return!1}get currentTime(){var e;return this.audio&&this.audio.isRunning&&!this.audio.isStuck?1e3*this.audio.currentTime+(null!=(e=this.clockDelta)?e:0):this.clockSource.currentTime}set currentTime(e){this.logger.debug("setting current time to",{currentTime:e}),this.startTimeIsInvalidated=!0}get audioNode(){return this.splitter}useMediaStreamDestination(){var e;const t=this.getAudioContext().getMediaStreamDestination();return null==(e=this.gainNode)||e.connect(t),t}useDefaultDestination(){var e;const t=this.getAudioContext().getDefaultDestination();return null==(e=this.gainNode)||e.connect(t),t}};g(qi,"create",((e,t,i)=>new qi(e,t,i)));let Zi=qi;var Ji;class Yi{constructor(){v(this,Ji,[]),w(this,Ji,[])}addTextTrack(e,t,i){const s=[],n={kind:e,label:t,language:i,mode:"disabled",cues:s,addCue:e=>{s.push(e)},removeCue:e=>{const t=s.findIndex((t=>t===e));-1!==t&&s.splice(t,1)}};return f(this,Ji).push(n),n}set language(e){f(this,Ji).forEach((t=>{t.language===e?t.mode="showing":t.mode="hidden"}))}get language(){var e;return null==(e=f(this,Ji).find((e=>"showing"===e.mode)))?void 0:e.language}getActiveCues(e){const t=f(this,Ji).find((e=>"showing"===e.mode));return t?t.cues.filter((({startTime:t,endTime:i})=>e>=t&&e<=i)):[]}}Ji=new WeakMap;const $i=(e,t)=>{let i;for(i=t;e>1;e--)i+=t;return i};class Ki{constructor(){g(this,"audio"),g(this,"unmute",(()=>this.audio.play().catch(k)));const e=document.createElement("div");e.innerHTML="<audio x-webkit-airplay='deny'></audio>";const t=e.children.item(0);if(!(t instanceof HTMLAudioElement))throw new Error("Failed to create audio tag");this.audio=t,this.audio.controls=!1,this.audio.disableRemotePlayback=!0,this.audio.preload="auto",this.audio.src="data:audio/mpeg;base64,//uQx"+$i(23,"A")+"WGluZwAAAA8AAAACAAACcQCA"+$i(16,"gICA")+$i(66,"/")+"8AAABhTEFNRTMuMTAwA8MAAAAAAAAAABQgJAUHQQAB9AAAAnGMHkkI"+$i(320,"A")+"//sQxAADgnABGiAAQBCqgCRMAAgEAH"+$i(15,"/")+"7+n/9FTuQsQH//////2NG0jWUGlio5gLQTOtIoeR2WX////X4s9Atb/JRVCbBUpeRUq"+$i(18,"/")+"9RUi0f2jn/+xDECgPCjAEQAABN4AAANIAAAAQVTEFNRTMuMTAw"+$i(97,"V")+"Q==",this.audio.loop=!1,this.audio.load()}}var es,ts,is,ss,ns,rs,os,as;class hs{constructor(){v(this,ns),v(this,es,[]),v(this,ts,document.createElement("canvas")),v(this,is),v(this,ss,window.devicePixelRatio||1),g(this,"config",{backgroundColor:"rgba(0,0,0,0.6)",textPadding:8,fontSize:"28px",lineGap:16});const e=f(this,ts).getContext("2d",{alpha:!0});if(!e)throw new Error("Failed to create 2d context");w(this,is,e),b(this,ns,os).call(this)}get canvas(){return f(this,ts)}setActiveCues(e){w(this,es,e)}render(e,t=!1){const i=f(this,es).flatMap((t=>t.text.split("\n").flatMap((t=>b(this,ns,as).call(this,t,e.width))).map((e=>{b(this,ns,os).call(this);const t=f(this,is).measureText(e);return{text:e,measurement:t,size:{height:t.fontBoundingBoxAscent+t.fontBoundingBoxDescent+2*this.config.textPadding,width:t.width+2*this.config.textPadding}}})))),s=Math.max(...i.map((e=>e.size.width))),n=i.reduce(((e,{size:t})=>e+t.height),0)+(i.length-1)*this.config.lineGap;let r=0;b(this,ns,rs).call(this,s,n),f(this,is).clearRect(0,0,f(this,ts).width,f(this,ts).height);for(const{size:e,text:t}of i)b(this,ns,os).call(this),f(this,is).fillStyle=this.config.backgroundColor,f(this,is).fillRect(0,r,e.width,e.height),b(this,ns,os).call(this),f(this,is).fillText(t,this.config.textPadding,r+this.config.textPadding),r+=e.height+this.config.lineGap;t&&(f(this,is).strokeStyle="red",f(this,is).strokeRect(0,0,e.width,f(this,ts).height))}}es=new WeakMap,ts=new WeakMap,is=new WeakMap,ss=new WeakMap,ns=new WeakSet,rs=function(e,t){f(this,ts).width=e*f(this,ss),f(this,ts).height=t*f(this,ss),f(this,is).scale(f(this,ss),f(this,ss)),this.canvas.style.width=`${e}px`,this.canvas.style.height=`${t}px`},os=function(){f(this,is).fillStyle="white",f(this,is).textAlign="left",f(this,is).textBaseline="top",f(this,is).font=`${this.config.fontSize} sans-serif`},as=function(e,t){const i=[],s=e.split(" ");let n="";for(;s.length>0;){b(this,ns,os).call(this);let e=0;for(;f(this,is).measureText(n+(n.length>0?" ":"")+s[0]).width+2*this.config.textPadding<=t&&s.length>0;)e++,n+=(n.length>0?" ":"")+s.shift();0!=e?(i.push(n),n=""):(i.push(s.shift()||""),n="")}return i};const ds=(e,t)=>{let i=e.getContext("webgl",t);if(i||(i=e.getContext("experimental-webgl",t)),!i)throw new be("Failed to create webgl context",{isFatal:!0,code:"failed_to_create_web_gl_context"});return i},cs=(e,t,i)=>{const s=e.createShader(t);if(!s)throw new be("Failed to create shader",{isFatal:!0,code:"failed_to_create_shader"});if(e.shaderSource(s,i),e.compileShader(s),!e.getShaderParameter(s,e.COMPILE_STATUS)){const t=e.getShaderInfoLog(s);throw new be(`Failed to compile shader: ${null!=t?t:""}`,{isFatal:!0,code:"failed_to_compile_shader"})}return s},ls=e=>{const t=e.createTexture();if(!t)throw new be("Failed to create texture",{isFatal:!0,code:"failed_to_create_texture"});return e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),t},us=(e,t)=>{const i=e.createBuffer();if(!i)throw new be("Failed to create buffer",{isFatal:!0,code:"failed_to_create_buffer"});return e.bindBuffer(e.ARRAY_BUFFER,i),e.bufferData(e.ARRAY_BUFFER,t.buffer,e.STATIC_DRAW),i},ms=(e,t,i)=>{const s=e.createProgram();if(!s)throw new be("Failed to create program",{isFatal:!0,code:"failed_to_create_program"});if(e.attachShader(s,i),e.attachShader(s,t),e.linkProgram(s),!e.getProgramParameter(s,e.LINK_STATUS)){const t=e.getShaderInfoLog(s);throw new be(`Failed to link program: ${null!=t?t:""}`,{isFatal:!0,code:"failed_to_link_program"})}return s};var As,gs,ps,fs,vs,ws,bs,ys,Ss,Es;class Cs{constructor(e){v(this,bs),v(this,As,96),v(this,gs),v(this,ps),v(this,fs),v(this,vs),v(this,ws),g(this,"subtitleRenderer",new hs),v(this,Es,((e,t,i,s)=>[e,0,0,0,0,-t,0,0,0,0,1,0,i,s,0,1])),w(this,gs,e),w(this,ps,ls(e)),w(this,fs,cs(e,e.FRAGMENT_SHADER,"\nprecision mediump float;\nuniform sampler2D texture;\n\nvarying vec2 texture_coordinate;\n\nvoid main() {\n  float y = texture2D(texture, texture_coordinate).r;\n  float a = texture2D(texture, texture_coordinate).a;\n\n  gl_FragColor = vec4(y, y, y, a);\n}\n")),w(this,vs,cs(e,e.VERTEX_SHADER,"\n  attribute vec2 position;\n  varying vec2 texture_coordinate;\n  uniform mat4 model;\n\n  void main() {\n    texture_coordinate = position;\n    gl_Position = model * vec4(position, 0.0, 1.0);\n  }\n")),w(this,ws,ms(e,f(this,vs),f(this,fs))),this.subtitleRenderer.config.fontSize="64px"}setActiveCues(e,t){this.subtitleRenderer.setActiveCues(e),this.subtitleRenderer.render(t)}render(e){const t=this.subtitleRenderer.canvas,i=(e.padding+f(this,As))*window.devicePixelRatio;0!==t.width&&(f(this,gs).useProgram(f(this,ws)),b(this,bs,ys).call(this),b(this,bs,Ss).call(this,this.subtitleRenderer.canvas.width/e.width,this.subtitleRenderer.canvas.height/e.height,-this.subtitleRenderer.canvas.width/e.width/2,-(1-(this.subtitleRenderer.canvas.height+i)/e.height)),f(this,gs).uniform1i(f(this,gs).getUniformLocation(f(this,ws),"texture"),4),f(this,gs).activeTexture(f(this,gs).TEXTURE4),f(this,gs).bindTexture(f(this,gs).TEXTURE_2D,f(this,ps)),f(this,gs).enable(f(this,gs).BLEND),f(this,gs).blendFunc(f(this,gs).SRC_ALPHA,f(this,gs).ONE_MINUS_SRC_ALPHA),f(this,gs).texImage2D(f(this,gs).TEXTURE_2D,0,f(this,gs).RGBA,f(this,gs).RGBA,f(this,gs).UNSIGNED_BYTE,t),f(this,gs).texParameteri(f(this,gs).TEXTURE_2D,f(this,gs).TEXTURE_MAG_FILTER,f(this,gs).LINEAR),f(this,gs).drawArrays(f(this,gs).TRIANGLE_STRIP,0,4))}}As=new WeakMap,gs=new WeakMap,ps=new WeakMap,fs=new WeakMap,vs=new WeakMap,ws=new WeakMap,bs=new WeakSet,ys=function(){const e=f(this,gs).getAttribLocation(f(this,ws),"position");f(this,gs).enableVertexAttribArray(e),f(this,gs).vertexAttribPointer(e,2,f(this,gs).FLOAT,!1,0,0)},Ss=function(e,t,i,s){const n=f(this,gs).getUniformLocation(f(this,ws),"model");f(this,gs).uniformMatrix4fv(n,!1,f(this,Es).call(this,e,t,i,s))},Es=new WeakMap;const Ts="\nprecision mediump float;\nuniform sampler2D y_texture;\nuniform sampler2D u_texture;\nuniform sampler2D v_texture;\nuniform mat4 conversion;\n\nvarying vec2 texture_coordinate;\n\nvoid main() {\n  float y = texture2D(y_texture, texture_coordinate).r;\n  float u = texture2D(u_texture, texture_coordinate).r;\n  float v = texture2D(v_texture, texture_coordinate).r;\n\n  gl_FragColor = vec4(y, u, v, 1) * conversion;\n}\n",ks="\n  attribute vec2 position;\n  varying vec2 texture_coordinate;\n  uniform mat4 model;\n\n  void main() {\n    texture_coordinate = position;\n    gl_Position = model * vec4(position, 0.0, 1.0);\n  }\n",xs={width:256,codedWidth:256,height:144,codedHeight:144},Is={preserveDrawingBuffer:!1,alpha:!1,depth:!1,stencil:!1,antialias:!1,premultipliedAlpha:!1},Bs=class e extends s.E{constructor(){super(),g(this,"canvas",document.createElement("canvas")),g(this,"context",ds(this.canvas,Is)),g(this,"pixelShader",cs(this.context,this.context.FRAGMENT_SHADER,Ts)),g(this,"vertexShader",cs(this.context,this.context.VERTEX_SHADER,ks)),g(this,"buffer",us(this.context,e.SQUARE_VERTICES)),g(this,"program",ms(this.context,this.vertexShader,this.pixelShader)),g(this,"textures",{y:ls(this.context),u:ls(this.context),v:ls(this.context)}),g(this,"textRenderer"),g(this,"size",xs),g(this,"onContextLost",(e=>{this.textRenderer=void 0;const t=new Error(e instanceof WebGLContextEvent?e.statusMessage:"webgl context lost");this.emit("context lost",new be("WebGL Context Lost",{isFatal:!1,code:"webgl_context_lost_error",source:t,type:"internal"})),e.preventDefault()})),g(this,"onContextRestored",(()=>{this.emit("context restored"),this.context=ds(this.canvas,Is),this.pixelShader=cs(this.context,this.context.FRAGMENT_SHADER,Ts),this.vertexShader=cs(this.context,this.context.VERTEX_SHADER,ks),this.buffer=us(this.context,e.SQUARE_VERTICES),this.program=ms(this.context,this.vertexShader,this.pixelShader),this.textures={y:ls(this.context),u:ls(this.context),v:ls(this.context)},this.load()})),g(this,"load",(()=>{this.context.useProgram(this.program),this.setupPositionVertexAttributes(),this.setSize(xs),this.context.uniform1i(this.context.getUniformLocation(this.program,"y_texture"),0),this.context.uniform1i(this.context.getUniformLocation(this.program,"u_texture"),1),this.context.uniform1i(this.context.getUniformLocation(this.program,"v_texture"),2),this.setConversionMatrix(this.rec709())})),g(this,"unload",(()=>{var e;this.setSize({width:1,height:1,codedHeight:1,codedWidth:1}),[this.textures.y,this.textures.u,this.textures.v].forEach((e=>this.context.deleteTexture(e))),this.context.deleteShader(this.pixelShader),this.context.deleteShader(this.vertexShader),this.context.deleteProgram(this.program),this.context.deleteBuffer(this.buffer),this.canvas.removeEventListener("webglcontextlost",this.onContextLost),this.canvas.removeEventListener("webglcontextrestored",this.onContextRestored),null==(e=this.context.getExtension("WEBGL_lose_context"))||e.loseContext()})),g(this,"resetSize",(()=>{this.setSize({width:this.size.width/2,height:this.size.height/2,codedHeight:this.size.codedHeight/2,codedWidth:this.size.codedWidth/2})})),g(this,"render",((e,t)=>{var i;this.context.useProgram(this.program),this.setSize({width:e.width,height:e.height,codedWidth:e.codedWidth,codedHeight:e.codedHeight}),this.setConversionMatrix(this.rec709()),this.setModelMatrix(this.size.width/this.size.codedWidth,this.size.height/this.size.codedHeight),this.context.activeTexture(this.context.TEXTURE0),this.updateTexture(this.textures.y,this.size.codedWidth,this.size.codedHeight,e.data[0]),this.context.activeTexture(this.context.TEXTURE1),this.updateTexture(this.textures.u,this.size.codedWidth/2,this.size.codedHeight/2,e.data[1]),this.context.activeTexture(this.context.TEXTURE2),this.updateTexture(this.textures.v,this.size.codedWidth/2,this.size.codedHeight/2,e.data[2]),this.context.drawArrays(this.context.TRIANGLE_STRIP,0,4),this.textRenderer&&this.textRenderer.render({width:Math.max(t.clientWidth,960)*window.devicePixelRatio,height:Math.max(t.clientHeight,540)*window.devicePixelRatio,padding:-parseInt(null!=(i=t.style.getPropertyValue("--vindral-control-bar-offset"))?i:"0",10)})})),g(this,"updateTexture",((e,t,i,s)=>{const n=this.context.LUMINANCE,r=this.context.UNSIGNED_BYTE;this.context.bindTexture(this.context.TEXTURE_2D,e),this.context.texImage2D(this.context.TEXTURE_2D,0,n,t,i,0,n,r,s)})),g(this,"setupPositionVertexAttributes",(()=>{const e=this.context.getAttribLocation(this.program,"position");this.context.enableVertexAttribArray(e),this.context.vertexAttribPointer(e,2,this.context.FLOAT,!1,0,0)})),g(this,"setSize",(e=>{j(e,this.size)||(this.size=e,this.canvas.setAttribute("width",e.width.toString()),this.canvas.setAttribute("height",e.height.toString()),this.context.viewport(0,0,e.width,e.height),this.setModelMatrix(e.width/e.codedWidth,e.height/e.codedHeight))})),g(this,"setModelMatrix",((e,t)=>{const i=this.context.getUniformLocation(this.program,"model");this.context.uniformMatrix4fv(i,!1,this.transformMatrix(e,t))})),g(this,"setConversionMatrix",(e=>{const t=this.context.getUniformLocation(this.program,"conversion");this.context.uniformMatrix4fv(t,!1,e)})),g(this,"transformMatrix",((e,t)=>[2/e,0,0,0,0,-2/t,0,0,0,0,2,0,-1,1,0,1])),g(this,"rec709",(()=>[1.16438,0,1.79274,-.97295,1.16438,-.21325,-.53291,.30148,1.16438,2.1124,0,-1.1334,0,0,0,1])),g(this,"rec601",(()=>[1.16438,0,1.59603,-.87079,1.16438,-.39176,-.81297,.52959,1.16438,2.01723,0,-1.08139,0,0,0,1])),this.canvas.addEventListener("webglcontextlost",this.onContextLost),this.canvas.addEventListener("webglcontextrestored",this.onContextRestored,!1),this.canvas.style.width="100%",this.canvas.style.position="relative"}getTextRenderer(){return this.textRenderer||(this.textRenderer=new Cs(this.context)),this.textRenderer}};g(Bs,"SQUARE_VERTICES",new Float32Array([0,0,0,1,1,0,1,1]));let Rs=Bs;const Ps=class{constructor(e,t,i,s){g(this,"oldTimestampLimit",400),g(this,"pool"),g(this,"logger"),g(this,"videoRenderer",new Rs),g(this,"renderQueue",[]),g(this,"clockSource"),g(this,"isFirstFrame",!0),g(this,"animationFrameRequest"),g(this,"renderedFrameCount",0),g(this,"rendererDroppedFrameCount",0),g(this,"renderTargetSize"),g(this,"load",(()=>{this.videoRenderer.load()})),g(this,"unload",(()=>(this.stopRender(),this.videoRenderer.unload(),Promise.resolve()))),g(this,"suspend",(()=>{this.renderQueue=[],this.stopRender()})),g(this,"unsuspend",(()=>{this.animationFrameRequest=requestAnimationFrame(this.render)})),g(this,"element",(()=>this.videoRenderer.canvas)),g(this,"getStatistics",(()=>({renderedFrameCount:this.renderedFrameCount,rendererDroppedFrameCount:this.rendererDroppedFrameCount,contextLostCount:0,contextRestoredCount:0}))),g(this,"resetSize",(()=>{this.videoRenderer.resetSize()})),g(this,"setActiveCues",((e,t)=>{this.videoRenderer.getTextRenderer().setActiveCues(e,t)})),g(this,"onDecodedFrame",(e=>{if("video"===e.type)if(this.isFirstFrame)this.isFirstFrame=!1,requestAnimationFrame((()=>{this.renderSample(e)}));else{const t=(this.clockSource.currentTime-this.oldTimestampLimit)/1e3;this.renderQueue=this.renderQueue.filter((i=>{const s=i.timestamp/i.timescale,n=e.timestamp/e.timescale,r=s>t&&s<=n;return r||this.pool.reclaim(i.buffer),r})),this.renderQueue.push(e)}})),g(this,"render",(()=>{const e=this.clockSource.currentTime;let t,i=this.renderQueue[0],s=0;for(;i&&i.timestamp/i.timescale*1e3<=e;)i=this.renderQueue.shift(),i&&(s++,t&&this.pool.reclaim(t.buffer),t=i),i=this.renderQueue[0];t&&this.renderSample(t),this.rendererDroppedFrameCount+=Math.max(s-1,0),this.animationFrameRequest=requestAnimationFrame(this.render)})),g(this,"renderSample",(e=>{this.renderedFrameCount++,this.videoRenderer.render(e,this.renderTargetSize),this.pool.reclaim(e.buffer)})),g(this,"stopRender",(()=>{this.animationFrameRequest&&cancelAnimationFrame(this.animationFrameRequest)})),this.logger=e,this.clockSource=t,this.pool=i,this.renderTargetSize=s||this.videoRenderer.canvas}};g(Ps,"create",((e,t,i,s)=>new Ps(e,t,i,s)));let Ms=Ps;const Us=class{constructor(e,t,i,s,n){g(this,"logger"),g(this,"emitter"),g(this,"audioPlayer"),g(this,"videoPlayer"),g(this,"pool"),g(this,"unmuter",new Ki),g(this,"_isPaused",!1),g(this,"isDisconnected",!1),g(this,"timers",new de),g(this,"textTracks",new Yi),g(this,"playbackRate"),g(this,"reset",(()=>{})),g(this,"load",(()=>{this.audioPlayer.useDefaultDestination(),this.emitter.on("decoded frame",this.onDecodedFrame),this.emitter.on("flush buffers",this.flushBuffers),this.videoPlayer.load(),this.timers.setInterval((()=>{if(!this.textTracks.language)return;const e=this.textTracks.getActiveCues(this.currentTime/1e3);this.videoPlayer.setActiveCues(e,{width:this.videoPlayer.element().clientWidth,height:this.videoPlayer.element().clientHeight})}),100)})),g(this,"unload",(()=>{this.emitter.off("decoded frame",this.onDecodedFrame),this.emitter.off("flush buffers",this.flushBuffers),this.audioPlayer.unload(),this.videoPlayer.unload(),this.timers.unload()})),g(this,"suspend",(()=>{this.videoPlayer.suspend(),this.audioPlayer.suspend()})),g(this,"unsuspend",(()=>{this.videoPlayer.unsuspend(),this.audioPlayer.unsuspend()})),g(this,"element",(()=>this.videoPlayer.element())),g(this,"getStatistics",(()=>this.videoPlayer.getStatistics())),g(this,"flushBuffers",(()=>{this.audioPlayer.flushBuffer()})),g(this,"activateAudioPlayer",(()=>(this.isDisconnected&&(this.isDisconnected=!1,this.audioPlayer.useDefaultDestination()),this._isPaused=!1,this.unmuter.unmute(),this.audioPlayer.play()))),g(this,"onDecodedFrame",(e=>{try{this.audioPlayer.onDecodedFrame(e)}catch(e){e instanceof Error&&this.emitter.emit("error",Se(!1,e))}this.videoPlayer.onDecodedFrame(e)})),this.logger=t,this.emitter=e,this.pool=i,this.audioPlayer=Zi.create(this.logger.createContext("AudioPlayerModule"),s,{muted:n,reInitWhenStuck:!0}),this.audioPlayer.on("stuck",(()=>{this.isDisconnected=!0})),this.audioPlayer.on("state change",(()=>{this.emitter.emit("volume state",{volume:this.volume,isMuted:this.muted})})),this.videoPlayer=Ms.create(this.logger.createContext("VideoPlayerModule"),this.audioPlayer,this.pool)}get volume(){return this.audioPlayer.volume}set volume(e){this.audioPlayer.volume=e}get muted(){return this.audioPlayer.muted}set muted(e){const t=this.muted;this.audioPlayer.muted=e,!e&&t&&this.activateAudioPlayer().catch(k)}get currentTime(){return this.audioPlayer.currentTime}set currentTime(e){this.audioPlayer.currentTime=e}get isActivated(){return this.audioPlayer.isActivated}set isActivated(e){this.audioPlayer.isActivated=e}get seekTime(){return this.audioPlayer.seekTime}get isPaused(){return this._isPaused}get isSeeking(){return this.audioPlayer.isSeeking}get audioNode(){return this.audioPlayer.audioNode}play(){this.activateAudioPlayer().then((()=>{this.emitter.emit("media element state","playing")})).catch((()=>{this.emitter.emit("needs user input",{forAudio:!0,forVideo:!1})}))}pause(){this._isPaused=!0,this.audioPlayer.pause(),this.emitter.emit("media element state","paused")}};g(Us,"create",((e,t,i,s,n)=>new Us(e,t,i,s,n)));let Ls=Us;const _s=class{constructor(e,t,i,s,{muted:n,type:r,poster:o}){g(this,"logger"),g(this,"emitter"),g(this,"mediaElement"),g(this,"audioPlayer"),g(this,"videoPlayer"),g(this,"pool"),g(this,"isDisconnected",!0),g(this,"_userProvidedMuted",!1),g(this,"timers",new de),g(this,"volumeState"),g(this,"textTracks",new Yi),g(this,"reset",(()=>{})),g(this,"load",(()=>{this.mediaElement.load(),this.emitter.on("decoded frame",this.onDecodedFrame),this.emitter.on("flush buffers",this.flushBuffers),this.emitter.on("ios-hack: reset size",this.resetCanvasSize),this.emitter.on("enter picture in picture",this.onEnterIOSHack),this.emitter.on("exit picture in picture",this.onExitIOSHack),this.element().element.addEventListener("webkitendfullscreen",this.onExitIOSHack),this.element().element.addEventListener("webkitbeginfullscreen",this.onEnterIOSHack),this.videoPlayer.load(),this.timers.setInterval((()=>{if(!this.textTracks.language)return;const e=this.textTracks.getActiveCues(this.currentTime/1e3);this.videoPlayer.setActiveCues(e,{width:this.mediaElement.element.clientWidth,height:this.mediaElement.element.clientHeight})}),100)})),g(this,"unload",(()=>{this.emitter.off("decoded frame",this.onDecodedFrame),this.emitter.off("flush buffers",this.flushBuffers),this.emitter.off("ios-hack: reset size",this.resetCanvasSize),this.emitter.off("enter picture in picture",this.onEnterIOSHack),this.emitter.off("exit picture in picture",this.onExitIOSHack),this.element().element.removeEventListener("webkitendfullscreen",this.onExitIOSHack),this.element().element.removeEventListener("webkitbeginfullscreen",this.onEnterIOSHack),this.mediaElement.unload(),this.timers.unload(),this.audioPlayer.unload(),this.videoPlayer.unload()})),g(this,"suspend",(()=>{this.videoPlayer.suspend(),this.audioPlayer.suspend()})),g(this,"unsuspend",(()=>{this.videoPlayer.unsuspend(),this.audioPlayer.unsuspend()})),g(this,"element",(()=>this.mediaElement)),g(this,"getStatistics",(()=>this.videoPlayer.getStatistics())),g(this,"activateAudioPlayer",(()=>(this.isDisconnected&&this.connectStreams(),this.audioPlayer.play()))),g(this,"flushBuffers",(()=>{this.audioPlayer.flushBuffer()})),g(this,"resetCanvasSize",(()=>{this.videoPlayer.resetSize()})),g(this,"onEnterIOSHack",(()=>{this.mediaElement._iosHackEnterPiPMode()})),g(this,"onExitIOSHack",(()=>{this.mediaElement._iosHackExitPiPMode()})),g(this,"onDecodedFrame",(e=>{try{this.audioPlayer.onDecodedFrame(e)}catch(e){e instanceof Error&&this.emitter.emit("error",Se(!1,e))}this.videoPlayer.onDecodedFrame(e)})),g(this,"connectStreams",(()=>{const e=this.videoPlayer.element().captureStream(),t=this.audioPlayer.useMediaStreamDestination().stream,i=[];i.push(...e.getTracks(),...t.getTracks()),this.mediaElement.element.srcObject=new MediaStream(i),this.isDisconnected=!1})),g(this,"updateVolumeState",(()=>{const e={isMuted:this.muted,volume:this.volume};j(e,this.volumeState)||(this.volumeState=e,this.emitter.emit("volume state",this.volumeState))})),this.logger=t,this.emitter=e,this.pool=i,this._userProvidedMuted=n,this.mediaElement=new hi({poster:o,type:r,muted:n,autoplay:!1,logger:this.logger.createContext("MediaElement")}),this.mediaElement.on("volume state",(e=>{this.updateVolumeState(),!e.isMuted&&!this.audioPlayer.isContextRunning&&this.activateAudioPlayer().catch(k),e.isMuted||(this._userProvidedMuted=!1)})),this.mediaElement.on("media element state",(e=>{"paused"===e&&this.audioPlayer.flushBuffer(),this.emitter.emit("media element state",e)})),this.audioPlayer=Zi.create(this.logger.createContext("AudioPlayerModule"),s,{muted:!1,reInitWhenStuck:!1}),this.audioPlayer.on("stuck",(()=>{this.isDisconnected=!0})),this.audioPlayer.on("state change",(e=>{"suspended"===e||"interrupted"===e?this.mediaElement.muted=!0:"running"===e&&(this.mediaElement.muted=this._userProvidedMuted||"hidden"===document.visibilityState),this.updateVolumeState()})),this.videoPlayer=Ms.create(this.logger.createContext("VideoPlayerModule"),this.audioPlayer,this.pool,this.mediaElement.element),this.volumeState={volume:this.volume,isMuted:this.muted}}get volume(){return this.mediaElement.volume}set volume(e){this.mediaElement.volume=e}get muted(){return this.mediaElement.muted||this.audioPlayer.muted}set muted(e){const t=this.muted;this._userProvidedMuted=e,this.mediaElement.muted=e,!e&&t&&this.activateAudioPlayer().catch(k)}get currentTime(){return this.audioPlayer.currentTime}set currentTime(e){this.audioPlayer.currentTime=e}get isActivated(){return this.mediaElement.isActivated}set isActivated(e){this.mediaElement.isActivated=e}get seekTime(){return this.mediaElement.seekTime}get isPaused(){return this.mediaElement.isPaused}get isSeeking(){return this.mediaElement.isSeeking}get audioNode(){return this.audioPlayer.audioNode}play(){const e=this._userProvidedMuted;return this.activateAudioPlayer().catch((()=>{e||this.emitter.emit("needs user input",{forAudio:!0,forVideo:!1})})),this.mediaElement.play()}pause(){this.mediaElement.pause()}};g(_s,"create",((e,t,i,s,n)=>new _s(e,t,i,s,n)));let Ds=_s;const Os=()=>e=>Fs(e.buffered.start(0),e.buffered.end(e.buffered.length-1)),Fs=(e,t)=>i=>i.remove(Math.max(0,e),Math.min(Number.POSITIVE_INFINITY,t)),Ns=e=>t=>t.appendBuffer(e);class Ws{constructor(e){g(this,"commandQueue",[]),g(this,"sourceBuffer"),g(this,"currentInit"),g(this,"handleQueue",(()=>{var e;this.sourceBuffer.updating||null==(e=this.commandQueue.shift())||e.execute(this.sourceBuffer)})),g(this,"appendBuffer",((e,t)=>new Promise(((i,s)=>{if(t&&this.currentInit!==t){const e=new Q(Ns(t),i,s);this.commandQueue.push(e),this.currentInit=t}const n=new Q(Ns(e),i,s);this.commandQueue.push(n),this.handleQueue()})))),g(this,"execute",(e=>new Promise(((t,i)=>{const s=new Q((n=e,e=>n(e)),t,i);var n;this.commandQueue.push(s),this.handleQueue()})))),g(this,"buffered",(()=>this.sourceBuffer.buffered)),g(this,"removeFromMediaSource",(e=>{e.removeSourceBuffer(this.sourceBuffer)})),g(this,"changeType",(e=>new Promise(((t,i)=>{const s=new Q((n=e,e=>e.changeType(n)),t,i);var n;this.commandQueue.push(s),this.handleQueue()})))),g(this,"removeBuffer",((e,t)=>new Promise(((i,s)=>{const n=new Q(Fs(e,t),i,s);this.commandQueue.push(n),this.handleQueue()})))),g(this,"flush",(()=>new Promise(((e,t)=>{const i=new Q(Os,e,t);this.commandQueue.push(i),this.handleQueue()})))),this.sourceBuffer=e,this.sourceBuffer.addEventListener("updateend",this.handleQueue)}}class Vs extends s.E{constructor(){super(),g(this,"MediaSource",I()),g(this,"mediaSource",new this.MediaSource),g(this,"isOpen",(()=>"open"===this.mediaSource.readyState)),g(this,"isClosed",(()=>"closed"===this.mediaSource.readyState)),g(this,"isEnded",(()=>"ended"===this.mediaSource.readyState)),g(this,"createObjectURL",(()=>URL.createObjectURL(this.mediaSource))),g(this,"attach",(e=>{const t=e;if("srcObject"in t)try{t.srcObject=this.mediaSource}catch(e){if(e instanceof Error&&"TypeError"!==e.name)throw e;t.src=this.createObjectURL()}else e.src=this.createObjectURL()})),g(this,"detach",(e=>{if(this.mediaSource&&"open"===this.mediaSource.readyState)try{this.mediaSource.endOfStream()}catch(e){}e.srcObject&&(e.srcObject=null),""!==e.src&&(URL.revokeObjectURL(e.src),e.removeAttribute("src")),e.load()})),g(this,"addSourceBuffer",(e=>{const t=this.mediaSource.addSourceBuffer(e);return new Ws(t)})),g(this,"removeSourceBuffer",(e=>{e.removeFromMediaSource(this.mediaSource)})),g(this,"endOfStream",(e=>{this.mediaSource.endOfStream(e)})),g(this,"onSourceOpen",(()=>{this.setDurationIfNeeded(),this.emit("source open")})),g(this,"onSourceEnded",(()=>this.emit("source ended"))),g(this,"onSourceClosed",(()=>this.emit("source close"))),g(this,"setDurationIfNeeded",(()=>{if(Number.isNaN(this.mediaSource.duration)&&"open"===this.mediaSource.readyState){for(let e=0;e<this.mediaSource.sourceBuffers.length;e++){const t=this.mediaSource.sourceBuffers[e];if(null!=t&&t.updating)return}this.mediaSource.duration=Number.POSITIVE_INFINITY}})),this.mediaSource.addEventListener("sourceopen",this.onSourceOpen),this.mediaSource.addEventListener("sourceclose",this.onSourceClosed),this.mediaSource.addEventListener("sourceended",this.onSourceEnded)}}g(Vs,"isTypeSupported",(e=>{var t,i;return null!=(i=null==(t=I())?void 0:t.isTypeSupported(e))&&i}));class zs{constructor(){g(this,"initSegments",new Map),g(this,"set",((e,t,i)=>{var s;const n=null!=(s=this.initSegments.get(e))?s:new Map;n.set(t,i),this.initSegments.set(e,n)})),g(this,"get",((e,t)=>{var i;return null==(i=this.initSegments.get(e))?void 0:i.get(t)}))}}function Qs(e,{mediaSource:t,mimeType:i}){return A(m({},e),{state:"initialized",mimeType:i,sourceBuffer:t.addSourceBuffer(i),isWorkingOnPendingSamples:!1,sequenceNumber:0,lastBufferCleanupTime:Date.now()})}function Gs({initSegments:e,pendingSamples:t}){return{state:"uninitialized",initSegments:null!=e?e:new zs,sequenceNumber:0,isWorkingOnPendingSamples:!1,hasFirstSync:!!t,pendingSamples:null!=t?t:[],consecutiveQuotaExceededErrorCount:0,successfulAppendCalls:0}}const Xs=class{constructor(e,t,i){g(this,"maxChunkSize",20),g(this,"minConsecutiveErrorsBeforeEmit",5),g(this,"maxSecondsInBuffer",60),g(this,"logger"),g(this,"timers",de.create()),g(this,"emitter"),g(this,"mediaElement"),g(this,"mediaSource",new Vs),g(this,"trackContexts",new Map),g(this,"autoRecoverFromMediaErrors",!0),g(this,"quotaErrorCount",0),g(this,"recoveredFromErrorCount",0),g(this,"sourceOpenStartTime",Date.now()),g(this,"sourceOpenEndTime",Date.now()),g(this,"pendingTracksToAddSourceBuffers"),g(this,"hasAddedInitialPosterFrame",!0),g(this,"load",(()=>{this.emitter.on("init segment",this.init),this.emitter.on("coded sample",this.onCodedSample),this.emitter.on("flush buffers",this.flushBuffers),this.emitter.on("fragment",this.onFragment)})),g(this,"unload",(()=>{this.logger.debug("Unloading module..."),this.emitter.off("init segment",this.init),this.emitter.off("coded sample",this.onCodedSample),this.emitter.off("flush buffers",this.flushBuffers),this.emitter.off("fragment",this.onFragment),this.mediaSource.off("source ended",this.onSourceEnded),this.mediaSource.off("source open",this.onSourceOpen),this.mediaSource.detach(this.mediaElement),this.trackContexts.forEach((e=>e.pendingSamples=[])),this.timers.unload(),this.logger.debug("Unloaded module")})),g(this,"getStatistics",(()=>{var e,t,i,s;const n={quotaErrorCount:this.quotaErrorCount,mediaSourceOpenTime:this.sourceOpenEndTime-this.sourceOpenStartTime,successfulAudioAppendsCalls:null==(e=this.trackContexts.get("audio"))?void 0:e.successfulAppendCalls,successfulVideoAppendCalls:null==(t=this.trackContexts.get("video"))?void 0:t.successfulAppendCalls};if(this.mediaElement instanceof HTMLVideoElement){const e=null==(s=(i=this.mediaElement).getVideoPlaybackQuality)?void 0:s.call(i);n.totalVideoFrames=null==e?void 0:e.totalVideoFrames,n.droppedVideoFrames=null==e?void 0:e.droppedVideoFrames}return n})),g(this,"flushBuffers",(()=>{this.trackContexts.forEach((e=>{e.pendingSamples=[],e.hasFirstSync=!1,"uninitialized"!==e.state&&this.mediaSource.isOpen()&&e.sourceBuffer.removeBuffer(0,Number.POSITIVE_INFINITY).catch((e=>{this.logger.error("Failed to remove buffer",e)}))}))})),g(this,"setTrackContexts",((e=new Map)=>{this.logger.debug("setTrackContexts"),["audio","video"].forEach((t=>{var i,s,n,r;const o=null!=(s=null==(i=e.get(t))?void 0:i.pendingSamples)?s:[],a=null==(n=e.get(t))?void 0:n.initSegments;for(;o.length>0&&(null==(r=o[0])||!r.isSync);)o.shift();this.trackContexts.set(t,Gs({pendingSamples:o,initSegments:a}))}))})),g(this,"setSourceBuffers",(e=>S(this,null,(function*(){if(this.mediaSource.isClosed())return void(this.pendingTracksToAddSourceBuffers=e);let t=!0;for(const i of e){const e=this.trackContexts.get(i.type);if(!e||"uninitialized"===e.state||e.mimeType!==i.mimeType){t=!1;break}}if(t)this.logger.debug("Already setup with the correct mime types");else for(const t of e){let e=this.trackContexts.get(t.type);e||(e=Gs({pendingSamples:[],initSegments:new zs}),this.trackContexts.set(t.type,e)),"initialized"===e.state?t.mimeType!==e.mimeType&&(yield e.sourceBuffer.changeType(t.mimeType)):this.trackContexts.set(t.type,Qs(e,{mimeType:t.mimeType,mediaSource:this.mediaSource}))}})))),g(this,"getBuffer",(e=>{const t=[];if(this.mediaSource.isClosed())return[];const i=this.trackContexts.get(e);if(!i||"uninitialized"===i.state)return[];try{const e=i.sourceBuffer.buffered();if(!e)return[];for(let i=0;i<e.length;i++)t.push({start:1e3*e.start(i),end:1e3*e.end(i)});return t}catch(e){return[]}})),g(this,"init",(({initSegment:e,mimeType:t})=>{this.logger.debug("Added init segment",{channel:e.channelId,renditionId:e.renditionId});const i=this.trackContexts.get(e.type);if(!i)throw Ce(e.type,e.renditionId);"initialized"===i.state&&(i.mimeType=t);const s=((e,t,i)=>{switch(e){case"h264":return((e,t)=>((e,t)=>{const{sequenceParameterSets:i,pictureParameterSets:s}=bt(e),n=Ht(e);return Gt([{type:"video",sequenceParameterSets:i.map((e=>new Uint8Array(e))),pictureParameterSets:s.map((e=>new Uint8Array(e))),width:n.width,height:n.height,timescale:t,duration:0,trackId:1}])})(e,t))(t,i);case"av1":return((e,t)=>((e,t)=>{const i=jt(e);if(!i)throw new Error("Failed to parse sequence header");return Gt([{type:"video",parsedSequenceHeader:i,sequenceHeader:new Uint8Array(e),width:i.maxFrameWidth,height:i.maxFrameHeight,timescale:t,duration:0,trackId:1}])})(e,t))(t,i);case"opus":return((e,t)=>((e,t,i)=>Gt([{type:"audio",trackId:1,channelCount:2,timescale:i,codec:"opus",decoderConfig:e,duration:0,sampleRate:48e3}]))(new Uint8Array(e),0,t))(t,i);case"aac":return((e,t)=>((e,t,i,s)=>Gt([{type:"audio",codec:"aac",decoderConfig:e,channelCount:2,sampleRate:i,timescale:s,duration:0,trackId:1}]))(new Uint8Array(e),0,t,t))(t,i);default:throw new Error(`Failed to initialize ${e} segment`)}})(e.codec,e.data,e.timescale);s&&i.initSegments.set(e.channelId,e.renditionId,s)})),g(this,"append",((e,t)=>S(this,null,(function*(){var i;const s=e[0];if(!s)return;const n=this.trackContexts.get(s.type),r=null==n?void 0:n.initSegments.get(s.channelId,s.renditionId);if(this.mediaSource.isClosed())return;if(!r)throw((e,t)=>new be(`No init segment for rendition id ${e} for channel ${t}`,{isFatal:!1,code:"missing_init_segment",type:"internal"}))(s.renditionId,s.channelId);if(!n)throw Ce(s.type,s.renditionId);if("uninitialized"===n.state)throw Te(s.type,s.renditionId);if(t){const e=(s.timestamp+(null!=(i=s.compositionTimeOffset)?i:0))/s.timescale;yield n.sourceBuffer.removeBuffer(e,Number.POSITIVE_INFINITY);const t=n.previousSample;if(t&&t.codec!==s.codec&&n.sourceBuffer.changeType)try{yield n.sourceBuffer.changeType(n.mimeType)}catch(e){}yield n.sourceBuffer.appendBuffer(r)}const o=Math.max(0,s.timestamp/s.timescale-this.maxSecondsInBuffer);o>0&&Date.now()-n.lastBufferCleanupTime>1e4&&(n.lastBufferCleanupTime=Date.now(),yield n.sourceBuffer.removeBuffer(0,o+10));try{let t=n.sequenceNumber;const i=((e,t)=>{if(!e[0])throw new Error("At least one sample must be provided");switch(e[0].codec){case"h264":return((e,t)=>{const i=e.map((e=>A(m({},e),{data:new Uint8Array(e.data)})));if(!i[0])throw new Error("At least one sample must be provided");const{isSync:s,timestamp:n,data:r,duration:o}=i[0];return Xt({trackId:1,timestamp:n,sequenceNumber:t,defaultSize:r.byteLength,defaultFlags:s?33554432:16842752,defaultDuration:o,samples:i})})(e,t);case"opus":return((e,t)=>{const i=e.map((e=>A(m({},e),{data:new Uint8Array(e.data)})));if(!i[0])throw new Error("At least one sample must be provided");const{timestamp:s,data:n,duration:r}=i[0];return Xt({trackId:1,timestamp:s,sequenceNumber:t,defaultSize:n.byteLength,defaultFlags:33554432,defaultDuration:r,samples:i})})(e,t);case"aac":return((e,t)=>{const i=e.map((e=>A(m({},e),{data:new Uint8Array(e.data)})));if(!i[0])throw new Error("At least one sample must be provided");const{timestamp:s,data:n,duration:r}=i[0];return Xt({trackId:1,timestamp:s,sequenceNumber:t,defaultSize:n.byteLength,defaultFlags:33554432,defaultDuration:r,samples:i})})(e,t);case"av1":return((e,t)=>{const i=e.map((e=>A(m({},e),{data:new Uint8Array(e.data)})));if(!i[0])throw new Error("At least one sample must be provided");const{isSync:s,timestamp:n,data:r,duration:o}=i[0];return Xt({trackId:1,timestamp:n,sequenceNumber:t,defaultSize:r.byteLength,defaultFlags:s?33554432:16842752,defaultDuration:o,samples:i})})(e,t);default:throw new Error(`Unsupported codec ${e[0].codec}`)}})(e,t++);yield n.sourceBuffer.appendBuffer(i),n.sequenceNumber=t,n.consecutiveQuotaExceededErrorCount=0,n.successfulAppendCalls++}catch(t){throw t instanceof DOMException&&(t.code===DOMException.QUOTA_EXCEEDED_ERR?(this.quotaErrorCount++,n.consecutiveQuotaExceededErrorCount++,this.logger.error("quota exceeded error",{error:t}),n.pendingSamples.unshift(...e)):this.mediaElement.error&&n.pendingSamples.unshift(...e)),t}})))),g(this,"onFragment",(({fragment:e})=>{const t=e.mediaType();if(!t)return;const i=this.trackContexts.get(t);if(!i)throw Ce(t);if(!this.mediaSource.isClosed()){if("uninitialized"===i.state)throw Te(t);i.sourceBuffer.appendBuffer(e.rawBytes(),e.header().rawBytes()).catch((e=>console.log(e)))}})),g(this,"onCodedSample",(e=>{if(0===e.duration)return;const t=this.trackContexts.get(e.type);if(!t)throw Ce(e.type,e.renditionId);if(t.hasFirstSync||e.isSync){if(this.hasAddedInitialPosterFrame&&e.isSync&&"video"===e.type){this.hasAddedInitialPosterFrame=!1;const i=m({},e);i.timestamp=0,t.pendingSamples.push(i)}t.hasFirstSync=!0,t.pendingSamples.push(e),"uninitialized"!==t.state&&(t.isWorkingOnPendingSamples||qs(t,this.append,this.maxChunkSize).catch((i=>{if(t.isWorkingOnPendingSamples=!1,i instanceof Error){if(this.logger.error("append failed",{message:i.message,name:i.name}),i instanceof DOMException&&i.code===DOMException.QUOTA_EXCEEDED_ERR){if(t.consecutiveQuotaExceededErrorCount>=this.minConsecutiveErrorsBeforeEmit){const s=Ee(!1,i,t.consecutiveQuotaExceededErrorCount,e.type);this.emitter.emit("error",s)}}else{const s=Ee(!1,i,t.consecutiveQuotaExceededErrorCount,e.type);this.emitter.emit("error",s)}this.mediaElement.error&&this.onSourceEnded()}})))}})),g(this,"onSourceOpen",(()=>{this.logger.debug("source opened"),this.sourceOpenEndTime=Date.now(),this.pendingTracksToAddSourceBuffers&&(this.setSourceBuffers(this.pendingTracksToAddSourceBuffers),this.pendingTracksToAddSourceBuffers=void 0)})),g(this,"onSourceEnded",(()=>{const{error:e}=this.mediaElement;if(e){const t=((e,t)=>new be("MediaElement Error",{isFatal:e,code:"media_element_error",source:t},{mediaErrorCode:t.code}))(/AUDIO_RENDERER/.test(e.message)||!this.autoRecoverFromMediaErrors,e);if(this.logger.error("MediaElement error",{error:t}),this.emitter.emit("error",t),!t.isFatal()){this.logger.info("Re-opening MediaSource"),this.emitter.emit("recovered from media error",{error:t,count:this.recoveredFromErrorCount}),this.recoveredFromErrorCount++;const e=!this.mediaElement.paused,i=[];this.trackContexts.forEach(((e,t)=>{"initialized"===e.state&&i.push({type:t,mimeType:e.mimeType})})),this.sourceOpenStartTime=Date.now(),this.pendingTracksToAddSourceBuffers=i,this.mediaElement.src="",this.setTrackContexts(this.trackContexts),this.mediaSource.attach(this.mediaElement),e&&this.mediaElement.play().catch(k)}}this.logger.debug("source ended")})),this.logger=e,this.mediaElement=i,this.emitter=t}};g(Xs,"create",((e,t,i)=>{const s=new Xs(e,t,i);return s.setTrackContexts(),s.mediaSource.on("source ended",s.onSourceEnded),s.mediaSource.on("source open",s.onSourceOpen),s.mediaSource.attach(i),s}));let Hs=Xs;const js=(e,t)=>{var i;const s=e.renditionId!==t.renditionId,n=e.channelId!==t.channelId,r=(null!=(i=e.timestamp)?i:0)>t.timestamp,o="video"===e.type&&"video"===t.type&&e.levelIdc!==t.levelIdc;let a=!1;return"video"===e.type&&"video"===t.type&&(a=t.width!==e.width||t.height!==e.height),n||s||r||a||o},qs=(e,t,i)=>S(void 0,null,(function*(){for(e.isWorkingOnPendingSamples=!0;e.pendingSamples.length>0;){const s=[];let n=0;for(let t=0;t<e.pendingSamples.length;t++){n=t;const r=e.pendingSamples[t],o=e.pendingSamples[t+1];if(r&&(s.push(r),o)){if(js(r,o))break;const e=(r.timestamp+r.duration)/r.timescale;if(o.timestamp/o.timescale-e>.1)break}if(t===i-1)break}const r=s[0];if(!r)break;const o=!e.previousSample||js(e.previousSample,r);yield t(s,o),e.pendingSamples=e.pendingSamples.slice(n+1),e.previousSample=s[s.length-1]}e.isWorkingOnPendingSamples=!1})),Zs=class{constructor(e,t){g(this,"logger"),g(this,"emitter"),g(this,"element"),g(this,"pictureInPictureWindow"),g(this,"unload",(()=>{this.emitter.off("add picture in picture listener",this.onEnablePictureInPicture)})),g(this,"onEnablePictureInPicture",(e=>{this.element=e.element,e.element.addEventListener("leavepictureinpicture",(()=>{this.pictureInPictureWindow=void 0,this.logger.debug("Leave picture in picture"),this.emitter.emit("exit picture in picture")})),e.element.addEventListener("enterpictureinpicture",(e=>{this.pictureInPictureWindow=e.pictureInPictureWindow,this.logger.debug("Enter picture in picture"),this.emitter.emit("enter picture in picture",this)})),e.element.autopictureinpicture=!0})),g(this,"getPictureInPictureSize",(()=>this.pictureInPictureWindow)),g(this,"isPictureInPictureActive",(()=>this.isWebkitPresentationModeActive()||this.isStandardPictureInPictureActive())),g(this,"isPictureInPictureSupported",(()=>this.isWebkitPresentationModeSupported()||this.isStandardPictureInPictureSupported())),g(this,"requestPictureInPicture",(()=>(this.emitter.emit("ios-hack: reset size"),this.isStandardPictureInPictureSupported()?this.requestStandardPictureInPicture():this.isWebkitPresentationModeSupported()?this.requestWebkitPresentationMode("picture-in-picture"):Promise.reject(new Error("Picture in picture is not supported"))))),g(this,"exitPictureInPicture",(()=>this.isStandardPictureInPictureSupported()?this.exitStandardPictureInPicture():this.isWebkitPresentationModeSupported()?this.requestWebkitPresentationMode("inline"):Promise.reject(new Error("Picture in picture is not supported")))),g(this,"getStatistics",(()=>({isPictureInPictureActive:this.isPictureInPictureActive()}))),g(this,"requestStandardPictureInPicture",(()=>S(this,null,(function*(){return yield this.element.requestPictureInPicture()})))),g(this,"exitStandardPictureInPicture",(()=>S(this,null,(function*(){return yield document.exitPictureInPicture()})))),g(this,"isStandardPictureInPictureSupported",(()=>!!this.element&&!!this.element.requestPictureInPicture&&!!document.pictureInPictureEnabled)),g(this,"isStandardPictureInPictureActive",(()=>!!this.element&&!!document.pictureInPictureElement)),g(this,"isWebkitPresentationModeActive",(()=>!!this.element&&"picture-in-picture"===this.element.webkitPresentationMode)),g(this,"requestWebkitPresentationMode",(e=>S(this,null,(function*(){return this.element.webkitSetPresentationMode(e),Promise.resolve()})))),g(this,"isWebkitPresentationModeSupported",(()=>!!this.element&&!!this.element.webkitSetPresentationMode)),this.emitter=e,this.logger=t,this.emitter.on("add picture in picture listener",this.onEnablePictureInPicture)}};g(Zs,"create",((e,t)=>new Zs(e,t)));let Js=Zs;const Ys=class{constructor(e,t,i,s){g(this,"emitter"),g(this,"logger"),g(this,"clockSource"),g(this,"state","buffering"),g(this,"bufferFullness",0),g(this,"targetBufferTime"),g(this,"lastBufferStateEvent","drained"),g(this,"firstFrameTime"),g(this,"currentTimeIsInRange",!1),g(this,"needsInputForAudioCount",0),g(this,"needsInputForVideoCount",0),g(this,"unload",(()=>{this.emitter.off("buffer state",this.onBufferedStateChanged),this.emitter.off("needs user input",this.onNeedsUserInput)})),g(this,"setTargetBufferTime",(e=>{this.targetBufferTime=e})),g(this,"getTargetBufferTime",(()=>this.targetBufferTime)),g(this,"getBufferFullness",(()=>this.bufferFullness)),g(this,"getLastBufferStateEvent",(()=>this.lastBufferStateEvent)),g(this,"getState",(()=>this.state)),g(this,"getFirstFrameTime",(()=>this.firstFrameTime)),g(this,"getStatistics",(()=>({bufferTime:this.targetBufferTime,needsInputForAudioCount:this.needsInputForAudioCount,needsInputForVideoCount:this.needsInputForVideoCount}))),g(this,"onBufferedStateChanged",(({buffered:e,isPaused:t})=>{const i=this.clockSource.currentTime,s=e.some((e=>e.start<i&&i<e.end)),n=e[e.length-1],r=!!n&&n.end-n.start>=this.targetBufferTime,o=n?Math.max(0,n.end-i)/this.targetBufferTime:0,a=t?"paused":s?"playing":"buffering",h=this.state;this.currentTimeIsInRange===s||s?s&&r&&"drained"===this.lastBufferStateEvent&&(this.lastBufferStateEvent="filled",this.emitter.emit("buffer state event",this.lastBufferStateEvent)):(this.lastBufferStateEvent="drained",this.emitter.emit("buffer state event",this.lastBufferStateEvent)),"playing"===a&&!this.firstFrameTime&&(this.firstFrameTime=Date.now()),this.currentTimeIsInRange=s,this.state=a,this.bufferFullness=s?o:0,h!==a&&this.emitter.emit("playback state",a),this.emitter.emit("buffer fullness",this.bufferFullness)})),g(this,"onNeedsUserInput",(({forAudio:e,forVideo:t})=>{e&&this.needsInputForAudioCount++,t&&this.needsInputForVideoCount++})),this.emitter=e,this.logger=t,this.clockSource=i,this.targetBufferTime=s,this.emitter.on("buffer state",this.onBufferedStateChanged),this.emitter.on("needs user input",this.onNeedsUserInput)}};g(Ys,"create",((e,t,i,s)=>new Ys(e,t,i,s)));let $s=Ys;const Ks=()=>({upgradesFromLevel:[],downgradesFromLevel:[],bufferingRanges:[],activeRanges:[],decodeRate:Number.MAX_SAFE_INTEGER}),en=class{constructor(e,t){g(this,"minBufferFullnessLengthForRegression",6),g(this,"logger"),g(this,"emitter"),g(this,"timers",de.create()),g(this,"metrics",{levels:{},levelDowngrades:[],levelUpgrades:[],bufferFullness:0,general:Ks()}),g(this,"bufferFullness",new T(30)),g(this,"bufferFullnessRegression"),g(this,"currentLevel"),g(this,"isSuspended",!1),g(this,"_fatalQosCount",0),g(this,"hasAsserted",!1),g(this,"load",(()=>{this.emitter.on("playback state",this.onPlaybackState),this.emitter.on("buffer fullness",this.onBufferFullness),this.emitter.on("rendition level changed",this.onRenditionLevelChanged),this.emitter.on("video decode rate",this.onVideoDecodeRate)})),g(this,"unload",(()=>{this.emitter.off("playback state",this.onPlaybackState),this.emitter.off("buffer fullness",this.onBufferFullness),this.emitter.off("rendition level changed",this.onRenditionLevelChanged),this.emitter.off("video decode rate",this.onVideoDecodeRate),this.suspend()})),g(this,"suspend",(()=>{this.isSuspended=!0,this.timers.unload(),this.stopBuffering(),this.unsetActive()})),g(this,"unsuspend",(()=>{this.isSuspended=!1,this.currentLevel&&this.setActive()})),g(this,"fatalQosGraceTime",(()=>1e4*(this.fatalQosCount+1))),g(this,"incrementFatalQosCount",(()=>{this._fatalQosCount++})),g(this,"getMetrics",(()=>this.metrics)),g(this,"getLevelStats",(e=>{var t,i,s,n;const r=(null!=(i=null==(t=e.video)?void 0:t.bitRate)?i:0)+(null!=(n=null==(s=e.audio)?void 0:s.bitRate)?n:0);return this.metrics.levels[r]})),g(this,"getBufferFullnessRegression",(()=>this.bufferFullnessRegression)),g(this,"activeRatios",(()=>{const e=new Map,t=oe(this.metrics.general.activeRanges);if(Object.entries(this.metrics.levels).forEach((([i,s])=>{e.set(i,t?oe(s.activeRanges)/t:0)})),!this.hasAsserted){const t=!e.size||Math.abs(Array.from(e.values()).reduce(((e,t)=>e+t),0)-1)<=.02;t||(this.hasAsserted=!0,console.assert(t,`Active ratios should be close to 1 - actual: ${Array.from(e.values()).reduce(((e,t)=>e+t),0)}`))}return e})),g(this,"bufferingRatios",(()=>{const e=new Map,t=oe(this.metrics.general.bufferingRanges);if(Object.entries(this.metrics.levels).forEach((([i,s])=>{e.set(i,t?oe(s.bufferingRanges)/t:0)})),!this.hasAsserted){const t=Array.from(e.values()).reduce(((e,t)=>e+t),0)<=1;t||(this.hasAsserted=!0,console.assert(t,`Buffering ratios should be less than 1 - actual: ${Array.from(e.values()).reduce(((e,t)=>e+t),0)}`))}return e})),g(this,"bufferingEventsLast",(e=>this.metrics.general.bufferingRanges.filter((t=>t.start>=Date.now()-e)).length)),g(this,"timeSpentBufferingLast",(e=>ae(this.metrics.general.bufferingRanges,e))),g(this,"timeSpentActiveLast",(e=>ae(this.metrics.general.activeRanges,e))),g(this,"timeSpentPlayingInAtLeastLevelRatio",(e=>{var t,i,s,n;const r=this.timeSpentBuffering(),o=this.timeActive(),a=this.bufferingRatios(),h=this.activeRatios(),d=(null!=(i=null==(t=e.video)?void 0:t.bitRate)?i:0)+(null!=(n=null==(s=e.audio)?void 0:s.bitRate)?n:0),c=r/o;return Object.keys(this.metrics.levels).map((e=>parseInt(e,10))).filter((e=>e>=d)).reduce(((e,t)=>{var i,s;return(null!=(i=h.get(t.toString()))?i:0)-(null!=(s=a.get(t.toString()))?s:0)*c+e}),0)})),g(this,"timeSpentBuffering",(()=>oe(this.metrics.general.bufferingRanges))),g(this,"timeActive",(()=>oe(this.metrics.general.activeRanges))),g(this,"getStatistics",(()=>({timeSpentBuffering:this.timeSpentBuffering(),bufferingEventsCount:this.metrics.general.bufferingRanges.length,timeSpentRatio:[...this.activeRatios()].reduce(((e,[t,i])=>(e[t]=i,e)),{}),fatalQosCount:this.fatalQosCount}))),g(this,"onRenditionLevelChanged",(e=>{var t,i,s,n,r,o,a,h,d,c,l,u,m,A;const g=(null!=(s=null==(i=null==(t=e.from)?void 0:t.video)?void 0:i.bitRate)?s:0)+(null!=(o=null==(r=null==(n=e.from)?void 0:n.audio)?void 0:r.bitRate)?o:0),p=(null!=(d=null==(h=null==(a=e.to)?void 0:a.video)?void 0:h.bitRate)?d:0)+(null!=(u=null==(l=null==(c=e.to)?void 0:c.audio)?void 0:l.bitRate)?u:0);this.logger.info("rendition level changed",{fromLevel:g,toLevel:p}),0===this.metrics.general.activeRanges.length&&this.setActive(),e.from&&e.to&&(g<p?this.metrics.general.upgradesFromLevel.push(Date.now()):this.metrics.general.downgradesFromLevel.push(Date.now()));let f=!1;if(e.from){const e=null!=(m=this.metrics.levels[g])?m:Ks();g<p?e.upgradesFromLevel.push(Date.now()):e.downgradesFromLevel.push(Date.now()),ne(e.activeRanges);const t=e.bufferingRanges[e.bufferingRanges.length-1];f=!!t&&!t.end,ne(e.bufferingRanges),this.metrics.levels[g]=e}if(e.to){const e=null!=(A=this.metrics.levels[p])?A:Ks();re(e.activeRanges),f&&re(e.bufferingRanges),this.metrics.levels[p]=e,this.currentLevel=p}})),g(this,"onBufferFullness",(e=>{this.bufferFullness.push(e),this.metrics.bufferFullness=e,this.bufferFullness.items().length>=this.minBufferFullnessLengthForRegression&&(this.bufferFullnessRegression=this.calculateLinearRegression())})),g(this,"onPlaybackState",(e=>{switch(this.logger.info("Playback state",{state:e,currentLevel:this.currentLevel}),e){case"playing":this.stopBuffering();break;case"buffering":this.isSuspended||this.startBuffering()}})),g(this,"onVideoDecodeRate",(e=>{var t;if(this.metrics.general.decodeRate=e,!this.currentLevel)return;const i=this.metrics.levels[null!=(t=this.currentLevel)?t:0];i&&(i.decodeRate=e)})),g(this,"calculateLinearRegression",(()=>(e=>{let t=0,i=0,s=0,n=0,r=0;for(let o=0;o<e.length;o++){const{x:a,y:h}=e[o];t+=a,i+=h,s+=a*h,n+=a*a,r+=h*h}const o=(e.length*s-t*i)/(e.length*n-t*t),a=(i-o*t)/e.length,h=Math.pow((e.length*s-t*i)/Math.sqrt((e.length*n-t*t)*(e.length*r-i*i)),2);return{slope:o,intercept:a,r2:h,predict:t=>o*(e.length+t)+a}})(this.bufferFullness.items().map(((e,t)=>({x:t,y:e})))))),g(this,"stopBuffering",(()=>{if(this.currentLevel){const e=this.metrics.levels[this.currentLevel];e&&ne(e.bufferingRanges)}ne(this.metrics.general.bufferingRanges)})),g(this,"startBuffering",(()=>{if(this.currentLevel){const e=this.metrics.levels[this.currentLevel];e&&re(e.bufferingRanges)}re(this.metrics.general.bufferingRanges)})),g(this,"unsetActive",(()=>{if(this.currentLevel){const e=this.metrics.levels[this.currentLevel];e&&ne(e.activeRanges)}ne(this.metrics.general.activeRanges)})),this.logger=t,this.emitter=e}get fatalQosCount(){return this._fatalQosCount}setActive(){if(this.currentLevel){const e=this.metrics.levels[this.currentLevel];e&&re(e.activeRanges)}re(this.metrics.general.activeRanges)}};g(en,"create",((e,t)=>new en(e,t)));let tn=en;const sn=class{constructor(e,t){g(this,"renditions",new Map),g(this,"renditionLevels",[]),g(this,"languages",[]),g(this,"emitter"),g(this,"subscriptionSource"),g(this,"renditionLevelChangeCount",0),g(this,"unload",(()=>{this.emitter.off("renditions",this.onRenditions),this.emitter.off("subscription changed",this.onSubscriptionChanged)})),g(this,"getRenditionLevels",(e=>e?this.createRenditionLevels(e):this.renditionLevels)),g(this,"getRenditionLevel",(e=>{var t;const i=null!=e?e:this.getCurrentSubscription(),s=e?this.createRenditionLevels(e):this.renditionLevels;if(!i.video)return s.length?s[0]:void 0;const n=i.video.bitRate||Number.MAX_SAFE_INTEGER,r=i.video.width||Number.MAX_SAFE_INTEGER,o=i.video.height||Number.MAX_SAFE_INTEGER;return null!=(t=s.filter((e=>!e.video||!i.video||e.video.bitRate<=n&&e.video.width<=r&&e.video.height<=o)).pop())?t:s[0]})),g(this,"setRenditions",((e,t)=>{this.renditions.set(e,t)})),g(this,"getLanguages",(()=>this.languages)),g(this,"getVideoRendition",((e,t=this.getCurrentSubscription().channelId)=>{const i=this.getRendition(e,t);if(i&&me(i))return i})),g(this,"getAudioRenditions",(e=>{const t=this.renditions.get(e);return null==t?void 0:t.filter((e=>Ae(e)))})),g(this,"getVideoRenditions",(e=>{const t=this.renditions.get(e);return null==t?void 0:t.filter((e=>me(e)))})),g(this,"getAudioRendition",((e,t=this.getCurrentSubscription().channelId)=>{const i=this.getRendition(e,t);if(i&&Ae(i))return i})),g(this,"getRendition",((e,t=this.getCurrentSubscription().channelId)=>{var i;return null==(i=this.renditions.get(t))?void 0:i.find((t=>t.id===e))})),g(this,"getStatistics",(()=>{var e,t,i,s,n,r,o,a,h,d;const c=this.getRenditionLevel();return{videoCodec:null==(e=null==c?void 0:c.video)?void 0:e.codec,audioCodec:null==(t=null==c?void 0:c.audio)?void 0:t.codec,videoRenditionId:null==(i=null==c?void 0:c.video)?void 0:i.id,audioRenditionId:null==(s=null==c?void 0:c.audio)?void 0:s.id,videoWidth:null==(n=null==c?void 0:c.video)?void 0:n.width,videoHeight:null==(r=null==c?void 0:c.video)?void 0:r.height,expectedVideoBitRate:null==(o=null==c?void 0:c.video)?void 0:o.bitRate,expectedAudioBitRate:null==(a=null==c?void 0:c.audio)?void 0:a.bitRate,frameRate:null==(h=null==c?void 0:c.video)?void 0:h.frameRate,language:null==(d=null==c?void 0:c.audio)?void 0:d.language,renditionLevelChangeCount:this.renditionLevelChangeCount}})),g(this,"onRenditions",(e=>{const t=this.subscriptionSource.getCurrentSubscription();this.renditions.set(e.channelId,e.renditions),this.updateRenditionLevels({to:t,from:t})})),g(this,"onSubscriptionChanged",(e=>{this.updateRenditionLevels(e)})),g(this,"updateRenditionLevels",(({to:e,from:t})=>{var i;const{channelId:s,initiator:n}=e,r=this.getRenditionLevel(t),o=new Set;(null!=(i=this.renditions.get(s))?i:[]).filter((e=>"webvtt"!==e.codec)).forEach((e=>e.language?o.add(e.language):void 0)),this.languages=Array.from(o),this.renditionLevels=this.createRenditionLevels(e);const a=this.getRenditionLevel(e);j(r,a)||(this.renditionLevelChangeCount++,this.emitter.emit("rendition level changed",{to:a,from:r,reason:n?"manual":"abr"}))})),g(this,"createRenditionLevels",(e=>{var t;const{video:i,audio:s,channelId:n}=e,r=null!=(t=this.renditions.get(n))?t:[],o=r.filter(me).filter((e=>i&&e.codec===i.codec)),a=r.filter(Ae).filter((e=>s&&e.codec===s.codec&&e.language===s.language)),h=Math.max(o.length,a.length),d=[];for(let e=0;e<h;e++){const t=o[Math.min(o.length-1,e)],i=a[Math.min(a.length-1,e)];d.push({audio:i,video:t})}return d})),g(this,"getCurrentSubscription",(()=>this.subscriptionSource.getCurrentSubscription())),this.subscriptionSource=t,this.emitter=e,this.emitter.on("renditions",this.onRenditions),this.emitter.on("subscription changed",this.onSubscriptionChanged)}};g(sn,"create",((e,t)=>new sn(e,t)));let nn=sn;const rn=e=>JSON.parse(JSON.stringify(e)),on=class{constructor(e,t,i){g(this,"logger"),g(this,"timers",new de),g(this,"emitter"),g(this,"targetSubscription"),g(this,"currentSubscription"),g(this,"_isSwitchingSubscription",!1),g(this,"pendingSubscriptionTimeoutId"),g(this,"burstMs",0),g(this,"unload",(()=>{this.logger.debug("Unloading module..."),this.timers.unload(),this.emitter.off("subscription changed",this.onSubscriptionChanged),this.logger.debug("Unloaded module")})),g(this,"isSwitchingSubscription",(()=>this._isSwitchingSubscription)),g(this,"getTargetSubscription",(()=>this.targetSubscription)),g(this,"getCurrentSubscription",(()=>this.currentSubscription)),g(this,"enableBurst",(e=>{this.burstMs=e})),g(this,"setSize",(e=>{this.targetSubscription.video.width=e.width,this.targetSubscription.video.height=e.height,this.scheduleSubscriptionChange()})),g(this,"setVideoConstraint",(e=>{this.targetSubscription.video=e,this.scheduleSubscriptionChange()})),g(this,"setAudioConstraint",(e=>{this.targetSubscription.audio=e,this.scheduleSubscriptionChange()})),g(this,"setVideoBitRate",(e=>{this.targetSubscription.video.bitRate=e,this.scheduleSubscriptionChange()})),g(this,"setAudioBitRate",(e=>{this.targetSubscription.audio.bitRate=e,this.scheduleSubscriptionChange()})),g(this,"setChannelId",(e=>{this.targetSubscription.channelId=e,this.scheduleSubscriptionChange()})),g(this,"setLanguage",(e=>{this.targetSubscription.audio.language=e,this.scheduleSubscriptionChange()})),g(this,"setVideoCodec",(e=>{this.targetSubscription.video.codec=e,this.scheduleSubscriptionChange()})),g(this,"setAudioCodec",(e=>{this.targetSubscription.audio.codec=e,this.scheduleSubscriptionChange()})),g(this,"setBurst",(e=>{e?this.targetSubscription.burstMs=e:delete this.targetSubscription.burstMs})),g(this,"isNewSubscription",(()=>{const e=["burstMs","meta","initiator","channelGroupId"];return!j(se(this.currentSubscription,e),se(this.targetSubscription,e))})),g(this,"onSubscriptionChanged",(({to:e,reset:t})=>{this.logger.debug("onSubscriptionChanged",{to:e,reset:t}),t?this.targetSubscription=rn(this.currentSubscription):this.currentSubscription=rn(e),this._isSwitchingSubscription=this.isNewSubscription()})),g(this,"scheduleSubscriptionChange",(()=>{this.targetSubscription=rn(this.targetSubscription),this._isSwitchingSubscription=this.isNewSubscription();const e=this.currentSubscription.channelId,t=this.targetSubscription.channelId,i=e!==t;this._isSwitchingSubscription&&(i&&this.burstMs?this.setBurst(this.burstMs):this.setBurst(0),this.pendingSubscriptionTimeoutId&&(this.timers.clearTimeout(this.pendingSubscriptionTimeoutId),this.pendingSubscriptionTimeoutId=void 0),i&&this.timers.setTimeout((()=>{this.currentSubscription.channelId===e&&this.targetSubscription.channelId===t&&(this.logger.warn("Channel switch timeout",t),this.targetSubscription=rn(this.currentSubscription),this.emitter.emit("channel switch timeout",t))}),1e4),this.pendingSubscriptionTimeoutId=this.timers.setTimeout((()=>this.emitter.emit("send signal",{type:"subscribe",subscription:this.getTargetSubscription()})),0))})),this.logger=e,this.targetSubscription=t,this.currentSubscription=rn(t),this.emitter=i,this.emitter.on("subscription changed",this.onSubscriptionChanged)}};g(on,"create",((e,t,i)=>new on(e,i,t)));let an=on;const hn=()=>L()||_()||-1!==R.indexOf("CrKey")?100:0,dn=e=>t=>t>e,cn=class{constructor(e,t,i,s,n){g(this,"emitter"),g(this,"logger"),g(this,"playbackSource"),g(this,"bufferSource"),g(this,"keyframeTimestamps",new T(10)),g(this,"lastSeekTime",Date.now()),g(this,"seekCooldownTime",1e3),g(this,"seekTimeoutTime",5e3),g(this,"seekKeyframeOvershoot",50),g(this,"syncMaxBehind"),g(this,"syncMaxBehindMultiplierStep",1),g(this,"syncMaxBehindIncreaseEvery",2),g(this,"syncMaxBehindMaximumAllowed",2e3),g(this,"syncMaxBehindMultiplier",1),g(this,"timeshiftOnAudio",!1),g(this,"syncMaxAhead",150),g(this,"timeshiftSync",{enabled:!1,maxBehind:50,multiplier:1,maxBehindAllowed:600,overshoot:hn(),minOvershootAllowed:hn(),maxOvershootAllowed:500}),g(this,"maxTimeSyncDifferenceTolerance",150),g(this,"timers",de.create()),g(this,"rtt",0),g(this,"channelSyncInfo",new Map),g(this,"driftAdjustmentsCount",0),g(this,"timeshiftDriftAdjustmentCount",0),g(this,"driftAdjustments",[]),g(this,"timeShiftAdjustments",[]),g(this,"timestampOffset"),g(this,"currentChannelId"),g(this,"highestSeenTimestamps",new Map),g(this,"isSuspended",!1),g(this,"isSyncAdjustmentActivated",!1),g(this,"load",(()=>{this.timers.setInterval(this.onSync,100)})),g(this,"unload",(()=>{this.logger.debug("Unloading module..."),this.emitter.off("rtt",this.updateRtt),this.timers.unload(),this.logger.debug("Unloaded module")})),g(this,"suspend",(()=>{this.isSuspended=!0})),g(this,"unsuspend",(()=>{this.resetSyncState(),this.isSuspended=!1})),g(this,"deactivateSyncAdjustments",(()=>{this.isSyncAdjustmentActivated=!1})),g(this,"activateSyncAdjustments",(()=>{this.tryApplySyncInfo(0),this.lastSeekTime=Date.now(),this.isSyncAdjustmentActivated=!0})),g(this,"reset",(()=>{this.logger.info("Reset sync state"),this.currentChannelId=void 0,this.timestampOffset=void 0,this.resetSyncState(),this.highestSeenTimestamps.clear()})),g(this,"getTimeshiftOffset",(()=>{var e;return null!=(e=this.timestampOffset)?e:0})),g(this,"getCurrentChannelId",(()=>this.currentChannelId)),g(this,"resetSyncState",(()=>{this.timeshiftSync.multiplier=1,this.syncMaxBehindMultiplier=1,this.driftAdjustments=[],this.timeShiftAdjustments=[]})),g(this,"getLiveEdgeTime",(e=>{const t=this.channelSyncInfo.get(e);if(!t)return;const i=Date.now()-t.localTimestamp;return t.timestamp+i})),g(this,"getLiveEdgeTimeLatencyAdjusted",(e=>{const t=this.getLiveEdgeTime(e);if(t)return t+this.rtt/2})),g(this,"getWallclockTime",(e=>{const t=this.channelSyncInfo.get(e);if(!t)return;const i=Date.now()-t.localTimestamp;return t.wallclockTime+i})),g(this,"getWallclockTimeLatencyAdjusted",(e=>{const t=this.getWallclockTime(e);if(t)return t+this.rtt/2})),g(this,"processSample",(e=>{var t;if(!e.channelId)throw new Error("Sample must be assigned to a channel");this.currentChannelId||(this.currentChannelId=e.channelId),this.timestampOffset||(this.timestampOffset=e.timestamp/e.timescale*1e3-5e3);const i="video"===e.type&&e.isSync;if(this.currentChannelId!==e.channelId){let t=Number.MAX_SAFE_INTEGER;console.assert(0!==this.highestSeenTimestamps.size,"no known timestamps"),this.highestSeenTimestamps.forEach((e=>{t=Math.min(t,e)}));const i=e.timestamp/e.timescale*1e3;this.currentChannelId=e.channelId,this.timestampOffset=i-t}else(i||this.timeshiftOnAudio)&&this.tryTimeshiftSync();const s=this.timestampOffset*e.timescale/1e3;return e.timestamp-=s,i&&this.keyframeTimestamps.push(e.timestamp/e.timescale*1e3),this.highestSeenTimestamps.set(e.type,Math.max(null!=(t=this.highestSeenTimestamps.get(e.type))?t:0,e.timestamp/e.timescale*1e3)),e})),g(this,"processFragment",((e,t)=>{var i;this.currentChannelId||(this.currentChannelId=e);const s=t.mediaType();if(!s)throw new Error("Fragment must have a media type");this.timestampOffset||(this.timestampOffset=t.baseMediaDecodeTime()/t.timescale()*1e3-5e3);const n="video"===t.mediaType()&&t.startsWithKeyframe();this.currentChannelId!==e?(console.assert(0!==this.highestSeenTimestamps.size,"no known timestamps"),this.highestSeenTimestamps.forEach((e=>{})),this.currentChannelId=e):(n||this.timeshiftOnAudio)&&this.tryTimeshiftSync();const r=this.timestampOffset*t.timescale()/1e3;return t.updateBaseMediaDecodeTime(t.baseMediaDecodeTime()-r),n&&this.keyframeTimestamps.push(t.baseMediaDecodeTime()/t.timescale()*1e3),this.highestSeenTimestamps.set(s,Math.max(null!=(i=this.highestSeenTimestamps.get(s))?i:0,t.baseMediaDecodeTime()/t.timescale()*1e3)),t})),g(this,"getStatistics",(()=>({drift:this.drift,driftAdjustmentCount:this.driftAdjustmentsCount,timeshiftDriftAdjustmentCount:this.timeshiftDriftAdjustmentCount,seekTime:this.playbackSource.seekTime}))),g(this,"updateRtt",(e=>{this.rtt=e})),g(this,"isPlaybackSourceReadyToSeek",(()=>!this.isSeeking()&&this.isSeekCooldownExpired()&&this.isSyncAdjustmentActivated)),g(this,"isSeeking",(()=>!!this.playbackSource.isSeeking&&!this.isSeekTimeoutExpired())),g(this,"isAllowedToSync",(()=>this.isPlaybackSourceReadyToSeek()&&!!this.currentChannelId&&!this.isSuspended&&!this.playbackSource.isPaused)),g(this,"isSeekCooldownExpired",(()=>Date.now()-this.lastSeekTime>this.seekCooldownTime)),g(this,"isSeekTimeoutExpired",(()=>Date.now()-this.lastSeekTime>this.seekTimeoutTime)),g(this,"currentTimeshiftMaxBehind",(()=>Math.min(this.timeshiftSync.maxBehind*this.timeshiftSync.multiplier,this.timeshiftSync.maxBehindAllowed))),g(this,"currentSyncMaxBehind",(()=>Math.min(this.syncMaxBehindMultiplier*this.syncMaxBehind,this.syncMaxBehindMaximumAllowed))),g(this,"currentSyncMaxAhead",(()=>this.playbackSource.seekTime>500?Math.max(this.syncMaxAhead*this.syncMaxBehindMultiplier,300):this.syncMaxAhead)),g(this,"tryTimeshiftSync",(()=>{var e;if(!this.timeshiftSync.enabled||!this.isAllowedToSync())return;const t=null!=(e=this.drift)?e:0;if(t>=this.syncMaxBehind)return;if(t<this.currentTimeshiftMaxBehind())return void(this.timeshiftSync.overshoot=0);if(!this.timestampOffset)return;const i=Date.now()-this.seekTimeoutTime*this.timeshiftSync.multiplier,s=this.timeShiftAdjustments.filter(dn(i)).length;if(s&&this.timeshiftSync.multiplier>2)return this.logger.debug("Too many diff timeShifts within sliding window",{timeShiftsCooldownMs:i,timeShiftsWithinCooldownTime:s}),!1;const n=t+this.timeshiftSync.overshoot;this.logger.info("Adjusting for drift using timeshift",{drift:t,syncAmount:n,currentTime:this.playbackSource.currentTime,rtt:this.rtt,overshoot:this.timeshiftSync.overshoot}),this.timestampOffset+=n,this.lastSeekTime=Date.now(),!this.playbackSource.isPaused&&(this.timeShiftAdjustments.push(this.lastSeekTime),this.timeshiftDriftAdjustmentCount++,this.timeshiftSync.multiplier++,this.timeshiftSync.overshoot=Math.max(this.timeshiftSync.minOvershootAllowed,Math.min(this.timeshiftSync.multiplier*t/2,this.timeshiftSync.maxOvershootAllowed)))})),g(this,"onSync",(()=>{var e;if(!this.isAllowedToSync())return;const t=null!=(e=this.drift)?e:0;if(t<0&&-t<this.currentSyncMaxAhead()||t>0&&t<this.currentSyncMaxBehind()||Math.abs(t)<1||!this.isSeekCooldownExpired())return;const i=Date.now()-this.seekTimeoutTime*this.syncMaxBehindMultiplier,s=this.driftAdjustments.filter(dn(i)).length;if(s&&this.syncMaxBehindMultiplier>2)return this.logger.debug("Too many diff adjustments within sliding window",{adjustmentsCooldownMs:i,adjustmentsWithinCooldownTime:s}),!1;const n=this.playbackSource.seekTime,r=this.playbackSource.currentTime+t,o=this.findKeyframeCloseToTimestamp(r);if(o||this.keyframeTimestamps.isEmpty()){const e=o?o+this.seekKeyframeOvershoot:r;if(this.logger.info("Adjusting for drift using seek",{drift:t,currentTime:this.playbackSource.currentTime,targetCurrentTime:e,seekTime:n,rtt:this.rtt}),this.lastSeekTime=Date.now(),this.driftAdjustments.push(this.lastSeekTime),this.driftAdjustmentsCount++,this.playbackSource.currentTime=e+n,this.timeshiftSync.overshoot=Math.max(this.timeshiftSync.minOvershootAllowed,this.timeshiftSync.overshoot/2),this.driftAdjustmentsCount%this.syncMaxBehindIncreaseEvery==0&&!this.playbackSource.isPaused){const e=this.currentSyncMaxBehind;this.syncMaxBehindMultiplier+=this.syncMaxBehindMultiplierStep,e!==this.currentSyncMaxBehind&&this.logger.info("Increasing max drift behind allowed",{from:e,to:this.currentSyncMaxBehind})}}})),g(this,"findKeyframeCloseToTimestamp",(e=>{const t=this.keyframeTimestamps.items();for(const i of t)if(i>=e&&i<=e+200)return i})),this.logger=t,this.emitter=e,this.playbackSource=i,this.bufferSource=s,this.timeshiftSync.enabled=n,this.syncMaxBehind=this.timeshiftSync.enabled?1e3:200,this.emitter.on("rtt",this.updateRtt)}updateChannelSyncInfo(e,t){const i=Date.now(),s=this.channelSyncInfo.get(e),n=this.getLiveEdgeTime(e);if(this.isSuspended)return;if(!s||!n)return this.logger.info("Initial timing info",{syncInfo:t}),void this.channelSyncInfo.set(e,A(m({},t),{localTimestamp:i,timeDifferences:new T(12)}));const r=t.wallclockTime-s.wallclockTime,o=t.timestamp-s.timestamp,a=i-s.localTimestamp,h=o-a;if(s.timeDifferences.push(h),this.logger.debug("Timing info",{rtt:this.rtt,channelId:e,syncInfo:t,localTimestamp:i,diffFromEstimated:h,timestampDelta:o,wallclockDelta:r,localWallclockDelta:a}),Math.abs(h)>=2*this.bufferSource.getTargetBufferTime())return this.logger.info("Resetting sync info",{diffFromEstimated:h}),this.channelSyncInfo.set(e,A(m({},t),{localTimestamp:i,timeDifferences:new T(s.timeDifferences.maxSize+1)})),void(this.currentChannelId&&this.currentChannelId===e&&(this.reset(),this.emitter.emit("channel reset")));s.timeDifferences.isFull()&&this.tryApplySyncInfo(this.maxTimeSyncDifferenceTolerance)}tryApplySyncInfo(e){const t=this.getCurrentChannelId();if(!t)return;const i=this.channelSyncInfo.get(t);if(!i)return;const s=G(i.timeDifferences.items());Math.abs(s)>e&&(this.logger.info("Adjusting sync info",{averageDifference:s}),i.timestamp+=s,i.timeDifferences.clear())}get serverCurrentTime(){return this.channelCurrentTime-this.getTimeshiftOffset()}get channelCurrentTime(){const e=this.getCurrentChannelId();if(!e)return 0;const t=this.getLiveEdgeTime(e);return t?t-this.bufferSource.getTargetBufferTime():0}get drift(){return this.serverCurrentTime-this.playbackSource.currentTime}};g(cn,"create",((e,t,i,s,n)=>new cn(e,t,i,s,n)));let ln=cn;const un={enabled:!0,interval:3e4,includeErrors:!0,includeEvents:!0,includeStats:!0,maxRetries:10,maxErrorReports:50,maxEvents:50},mn=(e,t)=>A(m({},t),{type:e,timestamp:(new Date).toISOString(),discriminator:"web"}),An=class{constructor(e,t,i,s){g(this,"logger"),g(this,"timers",new de),g(this,"emitter"),g(this,"options"),g(this,"parentContext"),g(this,"unsentLines",new T(100)),g(this,"retries",0),g(this,"errorCount",0),g(this,"eventCount",0),g(this,"statsCount",0),g(this,"unload",(()=>{this.logger.debug("Unloading module..."),window.removeEventListener("error",this.onError),window.removeEventListener("unhandledrejection",this.onRejection),this.timers.unload(),this.emitter.off("error",this.addError),this.emitter.off("visibilitystate",this.onVisibilityChange),this.emitter.off("pagehide",this.onPageHide),this.emitter.off("telemetry event",this.addEvent),this.addStats({isFinal:!0,initiator:"unload"}),this.send("beacon"),this.logger.debug("Unloaded module")})),g(this,"load",(()=>{window.addEventListener("error",this.onError),window.addEventListener("unhandledrejection",this.onRejection),this.emitter.on("error",this.addError),this.emitter.on("visibilitystate",this.onVisibilityChange),this.emitter.on("pagehide",this.onPageHide),this.emitter.on("telemetry event",this.addEvent),this.timers.setInterval((()=>{this.addStats(),this.send("fetch")}),this.options.interval)})),g(this,"addStats",(({isFinal:e,initiator:t}={isFinal:!1,initiator:"interval"},i={})=>{if(!this.options.includeStats)return;const s=this.parentContext.getStatistics(),n=mn("stats",A(m(m({},i),s),{isFinal:e,initiator:t,count:this.statsCount++}));this.unsentLines.push(n)})),g(this,"addEvent",(e=>{if(!this.options.includeEvents||this.eventCount>this.options.maxEvents)return;const t=this.parentContext.getStatistics(),i=mn("event",m(m({},t),e));this.eventCount++,this.unsentLines.push(i)})),g(this,"getStatistics",(()=>({errorCount:this.errorCount}))),g(this,"send",(e=>S(this,null,(function*(){if(this.options.enabled&&!(this.retries>=this.options.maxRetries)&&!this.unsentLines.isEmpty()){this.logger.debug("Sending telemetry",{lines:this.unsentLines.items()});try{const t=this.unsentLines.items().map((e=>JSON.stringify(e))).reverse().join("\n");"beacon"===e?navigator.sendBeacon(this.options.url,t):"connected"===this.parentContext.connectionState?this.emitter.emit("send signal",{type:"telemetry",body:t}):yield(0,n.p)(new URL(this.options.url),{body:t,headers:{"Content-Type":"text/plain"}}),this.retries=0,this.unsentLines.clear()}catch(e){this.retries++}}})))),g(this,"onVisibilityChange",(e=>{"hidden"===e&&(this.addStats({isFinal:!0,initiator:"visibilitychange"}),this.send("beacon"))})),g(this,"onPageHide",(e=>{this.addStats({isFinal:!0,initiator:"pagehide"},{persisted:e.persisted}),this.send("beacon")})),g(this,"onRejection",(e=>this.addError(e.reason))),g(this,"onError",(e=>this.addError(e.error))),g(this,"addError",(e=>{const{includeErrors:t,maxErrorReports:i}=this.options;if(t&&e instanceof be){if(this.errorCount++,this.errorCount>i)return;const t=this.parentContext.getStatistics();this.unsentLines.push(mn("error",m(m({},t),e.toStringifiable())))}})),this.logger=e,this.emitter=t,this.options=m(m({},un),i),this.parentContext=s}};g(An,"create",((e,t,i,s)=>new An(e,t,i,s)));let gn=An;const pn=class{constructor(e,t,i){g(this,"logger"),g(this,"element"),g(this,"documentState"),g(this,"timers",new de),g(this,"unload",(()=>{this.timers.unload()})),g(this,"unpause",(()=>{this.element.userHasProvidedInput&&this.element.isPaused&&this.documentState.isVisible&&this.documentState.isOnline&&(this.logger.debug("Unpause video"),this.element.tryPlay())})),this.logger=e,this.element=t,this.documentState=i,this.timers.setInterval(this.unpause,100)}};g(pn,"create",((e,t,i)=>new pn(e,t,i)));let fn=pn;class vn{constructor(){var e;g(this,"highEntropyValues"),null==(e=self.navigator.userAgentData)||e.getHighEntropyValues(["architecture","model","platformVersion","fullVersionList"]).then((e=>{this.highEntropyValues=e}))}getUserAgentInformation(){var e,t,i,s,n,r;const o=window.location.origin,a=o&&"null"!=o?`${window.location.pathname}${window.location.search}`.substring(0,1e3):"",h={locationOrigin:window.location.origin,locationPath:a,ancestorOrigins:(null==(e=window.location.ancestorOrigins)?void 0:e.length)>0?Array.from(window.location.ancestorOrigins):void 0,hardwareConcurrency:navigator.hardwareConcurrency,deviceMemory:navigator.deviceMemory};if(self.navigator.userAgentData&&this.highEntropyValues){const e="1",o=[...null!=(t=this.highEntropyValues.brands)?t:[]];o.sort(((e,t)=>e.brand.localeCompare(t.brand)));const a=[...null!=(i=this.highEntropyValues.fullVersionList)?i:[]];a.sort(((e,t)=>e.brand.localeCompare(t.brand)));const d=a.map((e=>e.version)),c=o.map((e=>e.brand)),l=o.map((e=>e.version)),u=parseInt(null!=(n=null==(s=this.highEntropyValues.platformVersion)?void 0:s.split(".")[0])?n:e);return m({userAgentLegacy:window.navigator.userAgent,ua:{browser:{brands:c,fullVersionBrands:d,majorVersions:l},device:this.highEntropyValues.model||"Other",os:{family:this.highEntropyValues.platform||"Other",version:null!=(r=this.highEntropyValues.platformVersion)?r:e,major_version:Number.isFinite(u)?u:0}}},h)}return m({userAgent:window.navigator.userAgent},h)}}var wn,bn,yn;const Sn=class e extends s.E{constructor(t){var i,r;super(),g(this,"pictureInPicture"),g(this,"browser",(()=>{var e;const t=!!I();let i=!1;return t&&(i=(()=>{var e,t;return!_()&&null!=(t=null==(e=I())?void 0:e.isTypeSupported('audio/mp4; codecs="opus"'))&&t})()),{isMobile:P,supportsMp4Opus:i,supportsMediaSource:t,supportsHls:M(),supportsWebAssembly:U(),platform:{iosVersion:null!=(e=D())?e:Number.MAX_SAFE_INTEGER,isIpadOS:_(),isMacOS:L(),isIOS:R.indexOf("iphone")>=0&&R.indexOf("like iphone")<0||R.indexOf("ipad")>=0&&R.indexOf("like ipad")<0||R.indexOf("ipod")>=0&&R.indexOf("like ipod")<0||_()}}})()),g(this,"options"),g(this,"element"),g(this,"playbackSource"),g(this,"emitter",new s.E),g(this,"logger"),g(this,"modules"),g(this,"clientIp"),g(this,"sessionId"),g(this,"clientId",ce()),g(this,"_channels",[]),g(this,"createdAt",Date.now()),g(this,"hasCalledConnect",!1),g(this,"latestEmittedLanguages",[]),g(this,"wakeLock"),g(this,"pool",new E(e.MAX_POOL_SIZE)),g(this,"userAgentInformation",new vn),g(this,"encryptedMediaExtensions"),v(this,wn,0),v(this,bn,[]),g(this,"sampleProcessingSesssions",new Map),g(this,"sizes",new Map),g(this,"isSuspended",!0),g(this,"disconnectTimeout"),v(this,yn),g(this,"attach",(e=>{var t;null==(t=this.wakeLock)||t.attach(e),e.appendChild(this.element)})),g(this,"getOptions",(()=>this.options.getOptions())),g(this,"getThumbnailUrl",(()=>{let e=this.options.get("edgeUrl")||this.options.get("url");e=e.replace("wss://","https://"),e=e.replace("ws://","http://"),e=e.endsWith("/")?e.slice(0,-1):e;const t=window.devicePixelRatio||1,i=Math.round(window.innerWidth*t),s=Math.round(window.innerHeight*t),n=this.options.get("authenticationToken"),r=n?`&auth.token=${n}`:"";return`${e}/api/thumbnail?channelId=${this.channelId}${r}&width=${i}&height=${s}`})),g(this,"updateAuthenticationToken",(e=>{this.logger.debug("Got new auth token",{token:e}),this.options.set("authenticationToken",e),this.emitter.emit("send signal",{type:"refresh auth",token:e})})),g(this,"connect",(()=>{this.hasCalledConnect||(this.play(),this._connect())})),g(this,"_connect",(()=>{var e,t;this.hasCalledConnect||(this.hasCalledConnect=!0,Object.values(this.modules).forEach((e=>{e&&"load"in e&&e.load()})),this.unsuspend(),this.playbackSource instanceof hi&&(null==(t=(e=this.playbackSource).load)||t.call(e)),this.modules.connection.connect())})),g(this,"getCastOptions",(()=>({url:this.options.get("url"),channelId:this.options.get("channelId"),channelGroupId:this.options.get("channelGroupId"),authenticationToken:this.options.get("authenticationToken"),language:this.options.get("language"),logLevel:this.options.get("logLevel"),minBufferTime:this.options.get("minBufferTime"),tags:this.options.get("tags"),ownerSessionId:this.sessionId,edgeUrl:this.options.get("edgeUrl"),media:this.options.get("media"),drm:this.options.get("drm")}))),g(this,"onConnectInfo",(e=>S(this,null,(function*(){var t;this.sessionId=ce();const i=this.modules.subscription.getTargetSubscription(),s=e.channels.find((e=>e.channelId===i.channelId));if(this.emitter.emit("connect info",e),this._channels=e.channels,this.updateTextTracks(null!=(t=null==s?void 0:s.renditions)?t:[]),!this.textTrack&&this.options.get("textTrack")&&(this.textTrack=this.options.get("textTrack")),yield Promise.all(e.channels.map((e=>S(this,null,(function*(){e.overrides&&this.options.addOverrides(e.channelId,e.overrides),e.renditions=yield this.filterRenditions(e.renditions),this.modules.renditions.setRenditions(e.channelId,e.renditions)}))))),!s)throw Ie("external");const n=this.options.getOverride("sizeBasedResolutionCapEnabled",this.channelId);void 0!==n&&(this.modules.constraintCap.sizeBasedResolutionCapEnabled=n);const r=this.options.getOverride("minBufferTime",this.channelId),o=this.options.getOverride("maxBufferTime",this.channelId);if((r||o)&&(this.modules.bufferTime.updateConfig({minBufferTime:this.options.get("minBufferTime",this.channelId),maxBufferTime:this.options.get("maxBufferTime",this.channelId)}),this.targetBufferTime=this.options.get("minBufferTime",this.channelId)),this.options.get("burstEnabled",this.channelId)&&this.modules.subscription.enableBurst(this.targetBufferTime),this.emit("is live",s.isLive),!s.isLive)throw new Error("Waiting for channel to go live");this.patchSubscription(s,this.modules.connection.estimatedBandwidth),yield this.initializeDecodingModule(),this.resetModules(),this.emit("rendition levels",this.modules.renditions.getRenditionLevels()),this.emit("channels",this.channels),this.emitLanguagesIfChanged(),this.sampleProcessingSesssions.clear();const a=this.options.get("burstEnabled",this.channelId);return{video:this.targetSubscription.video,audio:this.targetSubscription.audio,burstMs:a?this.targetBufferTime:void 0,sessionId:this.sessionId,clientId:this.clientId,channelId:this.channelId,channelGroupId:this.options.get("channelGroupId"),authToken:this.options.get("authenticationToken"),textTrack:this.textTrack}})))),g(this,"emitLanguagesIfChanged",(()=>{const e=this.modules.renditions.getLanguages(),t=this.latestEmittedLanguages;e.length==t.length&&e.every((e=>t.includes(e)))||(this.logger.debug("Emitting new languages",{currentLanguages:e}),this.latestEmittedLanguages=e,this.emit("languages",this.latestEmittedLanguages))})),g(this,"updateTextTracks",(e=>{const t=e.filter((e=>"webvtt"===e.codec));t.forEach((e=>{if(!f(this,bn).find((t=>t.language===e.language)))if(this.modules.canvasModule){const t=this.modules.canvasModule.textTracks.addTextTrack(e.kind,e.label||e.language||"",e.language||"");f(this,bn).push(t)}else if(this.mediaElement instanceof HTMLVideoElement){const t=this.mediaElement.addTextTrack(e.kind,e.label||e.language,e.language);f(this,bn).push(t)}}));for(const e of f(this,bn))t.find((t=>t.language===e.language))?"disabled"===e.mode&&(e.mode="hidden"):e.mode="disabled";this.emit("text tracks",this.textTracks)})),g(this,"cleanupTextTracks",((e=this.currentTime-2e4)=>{f(this,bn).forEach((t=>{if(t.cues)for(const i of t.cues)1e3*i.endTime<e-2e3&&t.removeCue(i)}))})),g(this,"filterRenditions",(e=>S(this,null,(function*(){const t=yield Promise.all(e.map((e=>S(this,null,(function*(){var t,i,s;if(Ae(e))return!0;if(!me(e)||!this.isSupportedVideoCodecProfile(e.codec,e.codecString))return!1;if(!this.willUseMediaSource()){const n=this.options.get("advanced"),r=null!=(t=n.wasmDecodingConstraint.bitRate)?t:Number.MAX_SAFE_INTEGER,o=null!=(i=n.wasmDecodingConstraint.width)?i:Number.MAX_SAFE_INTEGER,a=null!=(s=n.wasmDecodingConstraint.height)?s:Number.MAX_SAFE_INTEGER;return e.bitRate<=r&&e.width<=o&&e.height<=a}const n=yield(e=>{if(!navigator.mediaCapabilities)return Promise.resolve({smooth:!0,supported:!0,powerEfficient:!0,failedToQuery:!0});if("webvtt"===e.codec)throw new Error("WebVTT is not supported");let t;return t=Ae(e)?{type:"media-source",audio:{contentType:ge(e),bitrate:e.bitRate,channels:e.channels.toString(),samplerate:e.sampleRate}}:{type:"media-source",video:{contentType:ge(e),bitrate:e.bitRate,width:e.width,height:e.height,framerate:e.frameRate[0]/e.frameRate[1]}},navigator.mediaCapabilities.decodingInfo(t)})(e);if(!n.supported||"av1"==e.codec&&!n.smooth&&!n.powerEfficient)return!1;const r=this.options.getOverride("maxVideoBitRate",this.channelId);return!r||r>=e.bitRate})))));let i=e.filter(((e,i)=>t[i]));const s=i.filter((e=>"h264"===e.codec)).reverse()[0],n=i.filter((e=>"av1"===e.codec)).reverse()[0];return s&&n&&s.width>n.width&&s.height>n.height&&(i=i.filter((e=>"av1"!==e.codec))),i})))),g(this,"patchSubscription",((t,i)=>{const s=Math.min(this.options.get("maxVideoBitRate"),e.INITIAL_MAX_BIT_RATE,i,this.targetSubscription.video.bitRate),n=Math.min(this.options.get("maxAudioBitRate"),e.INITIAL_MAX_BIT_RATE,i,this.targetSubscription.audio.bitRate),r="audio"===this.options.get("media")?[]:this.options.get("videoCodecs",this.channelId),o=this.supportedAudioCodecs(),a=t.renditions.filter(Ae),h=t.renditions.filter(me),d=o.find((e=>void 0!==a.find((t=>t.codec===e)))),c=r.find((e=>void 0!==h.find((t=>t.codec===e)))),l=a.map((e=>e.language));if(this.logger.debug("supported and selected codecs",{audioCodecs:o,videoCodecs:r,audioCodec:d,videoCodec:c}),c){const e=this.options.get("maxSize");this.modules.subscription.setVideoConstraint(m({codec:c,bitRate:this.abrEnabled?s:this.options.get("maxVideoBitRate")},e))}d&&(this.modules.subscription.setAudioConstraint({codec:d,bitRate:this.abrEnabled?n:this.options.get("maxAudioBitRate"),language:this.options.get("language")}),(!l.includes(this.options.get("language"))||void 0===this.language)&&this.modules.subscription.setLanguage(l[0])),this.alignSizeAndBitRate(this.targetSubscription);const u=this.modules.subscription.getTargetSubscription();this.emitter.emit("subscription changed",{to:u,from:this.modules.subscription.getCurrentSubscription()})})),g(this,"isSupportedVideoCodecProfile",((e,t)=>{if(this.willUseMediaSource()){const i=I();return!i||i.isTypeSupported(ge({codec:e,codecString:t}))}if("h264"===e){const e=!(null==t||!t.startsWith("avc1.42")),i=!(null==t||!t.startsWith("avc1.66."));return e||i}return"av1"!==e})),g(this,"supportedAudioCodecs",(()=>{if("video"===this.options.get("media"))return[];const e=[];return(this.browser.supportsMp4Opus&&this.options.get("mseOpusEnabled")||!this.willUseMediaSource())&&e.push("opus"),this.willUseMediaSource()&&e.push("aac"),e})),g(this,"initializeDecodingModule",(()=>S(this,null,(function*(){var e,t;const i=this.currentRenditionLevel,s=[];if(!i)throw new be("No currentRenditionLevel",{code:"no_current_rendition_level",isFatal:!1});if(null!=i&&i.video&&s.push({type:"video",mimeType:ge(i.video)}),null!=i&&i.audio&&s.push({type:"audio",mimeType:ge(i.audio)}),0===s.length)throw new be("Can't initialize decoding module without tracks",{code:"no_tracks",isFatal:!1});if(this.willUseMediaSource()&&this.element instanceof HTMLMediaElement)this.emitter.emit("flush buffers"),yield null==(e=this.modules.mseModule)?void 0:e.setSourceBuffers(s);else{const e=yield Ni.create(this.emitter,this.logger.createContext("DecoderModule"),s,this.playbackSource,this.pool);null==(t=this.modules.decoder)||t.unload(),this.modules.decoder=e,this.modules.decoder.load()}})))),g(this,"unload",(()=>S(this,null,(function*(){var t,i,s;this.logger.debug("Unloading modules..."),yield Promise.all(Object.values(this.modules).map((e=>null==e?void 0:e.unload()))),null==(t=this.wakeLock)||t.unload(),this.pool=new E(e.MAX_POOL_SIZE),null==(s=(i=this.playbackSource).unload)||s.call(i),this.element.remove(),this.emitter.reset(),this.encryptedMediaExtensions.unload(),this.reset(),this.logger.debug("Unloaded modules")})))),g(this,"userInput",(()=>{this.play()})),g(this,"pause",(()=>{this.options.get("pauseSupportEnabled")&&"paused"!==this.playbackState&&(this.playbackSource.pause(),this.hasCalledConnect&&this.suspend())})),g(this,"registerDebugInstance",(()=>{(e=>{const t=window;t.vindralInstances=t.vindralInstances||{},t.vindralInstances[e.getStatistics().clientId.substring(0,8)]=e})(this)})),g(this,"play",(()=>{var t;this.hasCalledConnect?this.unsuspend():"playing"!==this.playbackState&&(this._connect(),self.addEventListener("__vindral_register_debug__",this.registerDebugInstance),this.modules.timer.setInterval((()=>this.cleanupTextTracks()),e.REMOVE_CUE_THRESHOLD)),null==(t=this.wakeLock)||t.enable(),"paused"===this.playbackState&&(this.resetModules(),this.emitter.emit("flush buffers"),this.cleanupTextTracks(Number.MAX_SAFE_INTEGER)),this.playbackSource.play()})),g(this,"getStatistics",(()=>Object.values(this.modules).reduce(((e,t)=>t&&"getStatistics"in t?m(m({},e),t.getStatistics()):e),this.getRuntimeInfo()))),g(this,"resetModules",(()=>{Object.values(this.modules).forEach((e=>{e&&"reset"in e&&e.reset()})),this.sampleProcessingSesssions.clear(),this.playbackSource.currentTime=0,this.playbackSource.isActivated=!1})),g(this,"getRuntimeInfo",(()=>{const e=this.modules.canvasModule?this.options.get("iosMediaElementEnabled"):void 0;return m({uptime:Date.now()-this.createdAt,version:"4.0.0-106-g9e37c403",clientId:this.clientId,sessionId:this.sessionId,channelId:this.channelId,channelGroupId:this.options.get("channelGroupId"),ip:this.clientIp,url:this.options.get("url"),timeToFirstFrame:this.timeToFirstFrame(),iosMediaElementEnabled:e},this.userAgentInformation.getUserAgentInformation())})),g(this,"onMediaElementState",(e=>{this.logger.info("media element state",{state:e}),this.options.get("pauseSupportEnabled")&&("paused"===e?this.modules.documentState.isVisible&&(this.suspend(),this.modules.connection.disconnect()):(this.unsuspend(),"disconnected"===this.modules.connection.getState()&&this.modules.connection.unsuspend()))})),g(this,"onBufferEvent",(e=>{var t,i,s,n;this.emit("buffer state event",e);const r=!this.playbackSource.isActivated||this.playbackSource.isPaused;if("filled"===e&&r){const e=Math.max(this.currentTime,null!=(i=null==(t=this.videoBufferedRanges[0])?void 0:t.start)?i:0,null!=(n=null==(s=this.audioBufferedRanges[0])?void 0:s.start)?n:0);this.logger.info("Buffer filled - starting playback",{currentTime:e}),this.playbackSource.currentTime=e,this.modules.sync.activateSyncAdjustments(),this.playbackSource.isActivated=!0}else"drained"===e&&this.playbackSource.isPaused&&(this.playbackSource.isActivated=!1,this.modules.sync.deactivateSyncAdjustments())})),g(this,"timeToFirstFrame",(()=>{const e=this.modules.playback.getFirstFrameTime(),t=this.modules.connection.firstConnectionTime;if(t&&e)return e-t})),this.options=new ci(m(m({},we),(e=>{if(!(e=>!("object"!=typeof e||!Me(e,"channelId")||"string"!=typeof e.channelId||!Me(e,"url")||"string"!=typeof e.url||0===e.channelId.length||0===e.url.length))(e))throw new be("Invalid options",{isFatal:!0,code:"invalid_options"});const t=m({},e);return Object.keys(t).forEach((e=>{const i=t;void 0===i[e]&&delete i[e]})),t})(t))),void 0===t.telemetryEnabled&&["localhost","127.0.0.1"].includes(location.hostname)&&this.options.set("telemetryEnabled",!1);const o={channelId:this.options.get("channelId"),audio:{language:this.options.get("language"),bitRate:this.options.get("maxAudioBitRate")},video:{bitRate:this.options.get("maxVideoBitRate"),width:this.options.get("maxSize").width,height:this.options.get("maxSize").height}},a=te.get();a.setLevel(this.options.get("logLevel")),a.setDebug(!1),this.logger=a;const h=Js.create(this.emitter,this.logger.createContext("PictureInPictureModule")),d=de.create(),c=_i.create(this.emitter,this.logger.createContext("ConnectionModule"),{reconnectHandler:this.options.get("reconnectHandler"),options:this.options,onConnectInfo:this.onConnectInfo}),l=an.create(this.logger.createContext("SubscriptionModule"),this.emitter,o),u=nn.create(this.emitter,l),p=tn.create(this.emitter,this.logger.createContext("QualityOfServiceModule")),b=$s.create(this.emitter,this.logger.createContext("PlaybackModule"),this,this.options.get("minBufferTime"));this.encryptedMediaExtensions=new vt(this.emitter,this.logger.createContext("EncryptedMediaExtensions"),null==(i=t.drm)?void 0:i.headers,null==(r=t.drm)?void 0:r.queryParams);const y=Vi.create(this.emitter),C=this.options.get("poster"),T=!0===C?this.getThumbnailUrl():C||void 0;let k,x,B;if(this.willUseMediaSource()){const e=new hi({type:"audio"==this.options.get("media")?"audio":"video",autoplay:!1,muted:this.options.get("muted")||"video"===this.options.get("media"),logger:this.logger.createContext("MediaElement"),poster:T});e.on("buffer state",(e=>this.emitter.emit("buffer state",e))),e.on("needs user input",(e=>this.emitter.emit("needs user input",e))),e.on("volume state",(e=>this.emit("volume state",e))),e.on("media element state",(e=>this.onMediaElementState(e))),this.element=e.element,this.playbackSource=e,vt.isSupported()&&this.encryptedMediaExtensions.attach(e.element),k=Hs.create(this.logger.createContext("MseModule"),this.emitter,this.element),this.options.get("pauseSupportEnabled")||(x=fn.create(this.logger.createContext("UnpauseModule"),e,y)),this.options.get("pictureInPictureEnabled")&&this.emitter.emit("add picture in picture listener",{element:e.element})}else if(this.browser.platform.iosVersion>=15&&this.options.get("iosMediaElementEnabled")){const e=Ds.create(this.emitter,this.logger.createContext("ModernCanvasModule"),this.pool,this,{type:"audio"==this.options.get("media")?"audio":"video",muted:this.options.get("muted")||"video"===this.options.get("media"),poster:T}),t=e.element();this.element=t.element,this.playbackSource=e,B=e,this.options.get("pictureInPictureEnabled")&&this.browser.platform.iosVersion>15&&this.emitter.emit("add picture in picture listener",{element:this.element}),this.options.get("pauseSupportEnabled")||(x=fn.create(this.logger.createContext("UnpauseModule"),t,y))}else{const e=Ls.create(this.emitter,this.logger.createContext("LegacyCanvasModule"),this.pool,this,this.options.get("muted")||"video"===this.options.get("media"));this.element=e.element(),this.playbackSource=e,B=e,this.options.get("iosWakeLockEnabled")&&(this.wakeLock=new Kt)}this.emitter.on("channel reset",this.resetModules),this.emitter.on("no data timeout",this.resetModules),this.emitter.on("media element state",(e=>this.onMediaElementState(e))),this.emitter.on("volume state",(e=>this.emit("volume state",e))),this.options.get("pauseSupportEnabled")||this.emitter.on("exit picture in picture",(()=>d.setTimeout((()=>this.play()),0))),this.emitter.on("constraint cap changed",(e=>{this.logger.info("new cap set",{cap:e}),this.alignSizeAndBitRate(this.targetSubscription)})),this.pictureInPicture={enter:()=>h.requestPictureInPicture(),exit:()=>h.exitPictureInPicture(),isActive:()=>h.isPictureInPictureActive(),isSupported:()=>h.isPictureInPictureSupported()},this.emitter.on("error",(e=>{if("external"===e.type()&&this.emit("error",e),e.isFatal())return()=>{this.unload()}}));const F=this.browser.platform.isIOS&&!this.browser.platform.isIpadOS,N=ln.create(this.emitter,this.logger.createContext("SyncModule"),this.playbackSource,b,this.willUseMediaSource()&&!F),W=(this.options.get("edgeUrl")||this.options.get("url")).replace("wss://","https://").replace("ws://","http://").replace("//lb.","//errors."),z=new URL("/telemetry",W).toString(),Q=gn.create(this.logger.createContext("TelemetryModule"),this.emitter,{url:z,enabled:this.options.get("telemetryEnabled"),includeStats:!1,interval:5e3},this);let G;this.modules={telemetry:Q,bufferTime:fi.create(this.emitter,this.logger.createContext("BufferTimeModule"),p,this,{maxBufferTime:this.options.get("maxBufferTime"),minBufferTime:this.options.get("minBufferTime")}),incomingData:Xi.create(this.emitter),adaptivity:Ai.create(this.emitter,this.logger.createContext("AdaptivityModule"),p,{cooldownTime:Math.max(this.options.get("minBufferTime"),2e3)}),constraintCap:Fi.create(this.emitter,this.element,u,!!this.options.get("abrEnabled")&&this.options.get("sizeBasedResolutionCapEnabled")),event:Qi.create(this.emitter,this.logger.createContext("EventModule"),N),sync:N,documentState:y,connection:c,playback:b,pictureInPicture:h,timer:d,subscription:l,renditions:u,qualityOfService:p,mseModule:k,unpause:x,canvasModule:B},this.modules.adaptivity.isEnabled=this.options.get("abrEnabled"),this.emitter.on("page active",(t=>{var i;t&&"number"==typeof this.disconnectTimeout&&(this.modules.timer.clearInterval(this.disconnectTimeout),this.disconnectTimeout=void 0),t?this.playbackSource.isPaused||(this.logger.debug("Unsuspending"),this.unsuspend()):(this.logger.debug("Suspending"),this.suspend(),this.modules.decoder?this.options.get("iosBackgroundPlayEnabled")?(this.modules.decoder.unsuspend(),null==(i=this.modules.canvasModule)||i.unsuspend()):this.modules.connection.disconnect():(this.disconnectTimeout&&this.modules.timer.clearInterval(this.disconnectTimeout),this.disconnectTimeout=this.modules.timer.setInterval((()=>{const e="paused"===this.playbackState||this.muted;"connected"===this.connectionState&&e&&(this.emitter.emit("flush buffers"),this.modules.connection.disconnect("Page inactive timeout"))}),e.DISCONNECT_TIMEOUT)))})),this.emitter.on("context switch complete",(()=>{G||(G=window.setTimeout((()=>{window.clearTimeout(G),G=void 0,this.emit("context switch","completed"),this.emitLanguagesIfChanged()}),this.targetBufferTime))})),this.emitter.on("context switch started",(()=>this.emit("context switch","started"))),this.emitter.on("needs user input",(e=>this.emit("needs user input",e))),this.emitter.on("event",(e=>{switch(e.type){case"metadata":this.emit("metadata",e);break;case"channel switch":this.emit("channel switch",{channelId:e.channelId});break;case"language switch":this.emit("language switch",{language:e.language})}})),this.emitter.on("buffer state event",this.onBufferEvent),this.emitter.on("playback state",(e=>this.emit("playback state",e))),this.emitter.on("rendition level changed",(({to:e})=>{e&&this.emit("rendition level",e)})),this.emitter.on("connection state",(e=>{this.emit("connection state",e)})),this.emitter.on("recovered from media error",(()=>{this.modules.adaptivity.reset(2*this.targetBufferTime)})),this.emitter.once("connect info",(e=>{var t,i,s;const n=(null!=(i=null==(t=e.telemetry)?void 0:t.probability)?i:1)>=Math.random();e.telemetry&&(null==(s=this.modules.telemetry)||s.unload(),this.modules.telemetry=gn.create(this.logger.createContext("TelemetryModule"),this.emitter,A(m({},e.telemetry),{enabled:this.options.get("telemetryEnabled")&&n}),this),this.modules.telemetry.load())})),this.emitter.on("adapt level",(e=>{var t,i,s,n,r;this.logger.debug("adapt level",{direction:e});const o=this.modules.renditions.getRenditionLevels(),a=this.modules.renditions.getRenditionLevel(),h=o.findIndex((e=>e===a)),d=o.length-1;let c=h;switch(e){case"upgrade":{const e=Math.min(h+1,d),a=o[e],l=null!=(t=this.modules.connection.estimatedBandwidth)?t:pe(),u=(null!=(s=null==(i=null==a?void 0:a.audio)?void 0:i.bitRate)?s:0)+(null!=(r=null==(n=null==a?void 0:a.video)?void 0:n.bitRate)?r:0);a&&2*l>u&&this.modules.adaptivity.isQoSOk(a)&&(c=e)}break;case"downgrade":c=Math.max(h-1,0);break;case"double downgrade":c=Math.max(h-2,0);break;case"reconnect":if(0===h||this.modules.qualityOfService.timeSpentBufferingLast(6e3)>5e3){if(!this.modules.connection.lastConnectionTime||Date.now()-this.modules.connection.lastConnectionTime<this.modules.qualityOfService.fatalQosGraceTime()||"connected"!==this.modules.connection.getState())return;return this.modules.qualityOfService.incrementFatalQosCount(),this.logger.info("Reconnecting due to poor qos"),this.modules.connection.reconnect("Fatal QOS"),void this.emitter.emit("adapted level")}c=0}if(c===h)return;const l=o[c];this.alignSizeAndBitRate(A(m({},this.targetSubscription),{video:m(m({},this.targetSubscription.video),null==l?void 0:l.video),audio:m(m({},this.targetSubscription.audio),null==l?void 0:l.audio)})),this.emitter.emit("adapted level")})),this.emitter.on("text track data",(e=>{const t=f(this,bn).find((t=>t.language===e.language)),i=this.modules.sync.getTimeshiftOffset()/1e3,s=i-f(this,wn);if(w(this,wn,i),t){if(t.cues)for(const e of t.cues)e.startTime-=s,e.endTime-=s;for(const s of e.cues){const e=new VTTCue(s.startTime-i,s.endTime-i,s.text);t.addCue(e)}}})),this.emitter.on("received signal",(e=>{var t;const i=e,s=this.modules.subscription.getCurrentSubscription();switch(this.logger.debug("received",m({},i)),i.type){case"client ip":this.clientIp=i.ip;break;case"renditions":this.updateTextTracks(i.renditions),w(this,yn,this.filterRenditions(i.renditions).then((e=>{this.emitter.emit("renditions",{renditions:e,channelId:this.currentSubscription.channelId}),this.emit("rendition levels",this.modules.renditions.getRenditionLevels()),this.emitLanguagesIfChanged()})).finally((()=>{w(this,yn,void 0)})));break;case"subscription changed":try{(e=>{if("object"!=typeof e||null===e)throw new Error("not an object");if(!("video"in e))throw new Error("missing video in subscription");if(!("audio"in e))throw new Error("missing audio in subscription");if(!("channelId"in e))throw new Error("missing channelId")})(i.subscription)}catch(e){this.emitter.emit("error",new be("Subscription failed validation",{source:e instanceof Error?e:void 0,isFatal:!1,code:"subscription_failed_validation"}))}this.emitter.emit("subscription changed",{reset:i.reset,to:i.subscription,from:this.modules.subscription.getCurrentSubscription()}),i.reset&&s.channelId!==i.subscription.channelId&&(this.emit("error",Pe(i.subscription.channelId)),this.emit("channel switch failed",{channelId:s.channelId})),this.modules.sync.timeshiftOnAudio=!(null!=(t=i.subscription.video)&&t.codec),this.modules.adaptivity.reset();break;case"timing info":this.modules.sync.updateChannelSyncInfo(i.timingInfo.channelId,i.timingInfo),this.emit("server wallclock time",i.timingInfo.wallclockTime)}})),this.emitter.on("channel switch timeout",(e=>{this.emit("error",Pe(e)),this.emit("channel switch failed",{channelId:this.currentSubscription.channelId})})),this.emitter.on("received data",(e=>{const t=this.modules.subscription.getCurrentSubscription(),i=(e=>{const t=new DataView(e,0),i=t.getUint8(0),s=t.getUint16(1),n=t.getUint8(3),r=t.getUint8(4),o=O(new Uint8Array(e),5,12),a=t.getUint32(13),h=(e=>!!(16&e))(n)?t.getInt16(17):void 0;return{version:i,renditionId:r,flags:n,timestamp:o,timescale:a,payload:e.slice(s),compositionTimeOffset:h}})(e);t?H(A(m({},i),{channelId:t.channelId})):this.logger.warn("Received unwanted message",m({},i))})),this.emitter.on("received moq data",(e=>{var t,i,s;const n=e.payload.mediaType(),r=e.channelId,o=e.renditionId,a=this.modules.sync.processFragment(r,e.payload);if(this.modules.incomingData.add(n,e.payload.rawBytes().byteLength),a.fragment().emsgs.forEach((e=>{if(!e.presentationTime)return;const t=function(e){const t=new V(e),i=function(e){return{id:e.readBytes(3),majorVersion:e.readUint8(),minorVersion:e.readUint8(),flags:e.readUint8(),size:e.readUint32()}}(t);184549376&i.flags&&function(e){const t=e.readUint32();e.readBytes(t-4)}(t);const s=function(e){return{frameId:e.readBytes(4),size:e.readUint32(),flags:e.readUint16()}}(t);if("TXXX"===String.fromCharCode(...s.frameId))return{header:i,txx:St(new V(t.readBytes(s.size)))}}(e.data);t&&this.modules.event.addEvent({id:e.id,timestamp:e.presentationTime/e.timescale*1e3-this.modules.sync.getTimeshiftOffset(),content:t.txx.value,type:"metadata"})})),this.modules.decoder){const e=null==(t=a.header().init().moov.traks[0])?void 0:t.mdia.minf.stbl.stsd,h=null==(i=null==e?void 0:e.avc1)?void 0:i.avcC.bytes,d=null!=(s=null==e?void 0:e.codec)?s:"h264";if(h){const e=h.buffer.slice(h.byteOffset,h.byteOffset+h.byteLength);if("text"===n)throw new Error("Subtitles are not supported");this.emitter.emit("init segment",{initSegment:{channelId:r,renditionId:o,data:e,timescale:1e3,type:n,codec:d},mimeType:n})}for(let e=0;e<a.samplesCount();e++){const t=a.sample(e);t&&this.emitter.emit("coded sample",A(m({},t),{renditionId:o,channelId:r,data:t.data.buffer.slice(t.data.byteOffset,t.data.byteOffset+t.data.byteLength)}))}}else this.emitter.emit("fragment",{fragment:a,channelId:r})}));const X=this.options.get("container");X&&this.attach(X),this.logger.info("Created Vindral instance",{options:this.options});const H=e=>S(this,null,(function*(){const t=e.channelId;f(this,yn)&&(yield f(this,yn));const i=this.modules.renditions.getRendition(e.renditionId,t);if(!(4&e.flags))if(8&e.flags){const t=(new TextDecoder).decode(e.payload),i=this.modules.sync.getTimeshiftOffset();if(0!==e.renditionId){const e=(0,n.t)(t);if(e&&void 0!==e.language){const t=(new ai).parse(e.content||""),s=i/1e3,n=f(this,bn).find((t=>t.language===e.language)),r=s-f(this,wn);if(w(this,wn,s),n){if(n.cues)for(const e of n.cues)e.startTime-=r,e.endTime-=r;for(const e of t){const t=new VTTCue(e.startTime-s,e.endTime-s,e.text);n.addCue(t)}}}}else this.modules.event.addEvent({timestamp:e.timestamp/e.timescale*1e3-this.modules.sync.getTimeshiftOffset(),content:t,type:"metadata"})}else if(null!=i&&i.codec){const s=(0,n.d)(i.codec);if("text"===s)throw new Error("Subtitles are not supported");if(this.modules.incomingData.add(s,e.payload.byteLength),(e=>!!(2&e))(e.flags)){const n=A(m({type:s,data:e.payload,codec:i.codec},e),{channelId:t}),r=((e,t)=>{switch(e){case"h264":return Ht(t);case"av1":return(e=>{const t=jt(e);if(t)return{width:t.maxFrameWidth,height:t.maxFrameHeight}})(t)}})(n.codec,n.payload);r&&this.sizes.set(n.renditionId,r);const o=ge({codec:i.codec,codecString:i.codecString});this.emitter.emit("init segment",{initSegment:n,mimeType:o}),this.emit("initialized media")}else{const t=((e,t,i)=>{if(me(t))return m(A(m({},e),{type:"video",codec:t.codec,isSync:Yt(e.flags),data:e.payload,duration:0,width:t.width,height:t.height}),i);if("webvtt"===t.codec)throw new Error("WebVTT is not supported");return A(m({},e),{type:"audio",channels:t.channels,sampleRate:t.sampleRate,codec:t.codec,language:t.language,isSync:Yt(e.flags),data:e.payload,duration:0})})(e,i,this.sizes.get(e.renditionId));let n=this.sampleProcessingSesssions.get(s);if(n){const e=n(this.modules.sync.processSample(t),this.isSwitchingRenditionLevel&&"video"===t.type);let i=t;e.forEach((e=>{this.modules.event.extractEvent(e,i),this.emitter.emit("coded sample",e),i=e}))}else n=(e=>{let t=[e],i=0,s=0,n=!1;return(e,r=!1)=>{if(e.flags&&Yt(e.flags)&&r&&(n=!n),!(r&&t.length<6&&n)&&t.length>0){n=!1;let r=e;for(let e=t.length-1;e>0;e--){const i=t[e];if(!i||!r)break;i.timestamp>=r.timestamp?t.splice(e,1):r=i}const o=t.map(((n,r)=>((e,t)=>{var n,r,o;e.flags&&Yt(e.flags)&&(i=null!=(n=e.compositionTimeOffset)?n:0),e.timestamp+=i,e.compositionTimeOffset=(null!=(r=e.compositionTimeOffset)?r:0)-i;const a=e.timestamp/e.timescale,h=t.flags&&Yt(t.flags)?null!=(o=t.compositionTimeOffset)?o:0:i,d=(t.timestamp+h)/t.timescale,c=Math.max(0,Math.round((d-a)*e.timescale));return c>0&&(s=c),A(m({},e),{duration:c>0?c:s})})(n,t[r+1]||e)));return t=[e],o}return t.push(e),[]}})(this.modules.sync.processSample(t)),this.sampleProcessingSesssions.set(s,n)}}}));this.options.get("maxVideoBitRate")!==Number.MAX_SAFE_INTEGER&&(this.maxVideoBitRate=this.options.get("maxVideoBitRate")),this.options.get("maxAudioBitRate")!==Number.MAX_SAFE_INTEGER&&(this.maxAudioBitRate=this.options.get("maxAudioBitRate")),j(this.options.get("maxSize"),fe())||(this.maxSize=this.options.get("maxSize")),this.options.get("burstEnabled")&&l.enableBurst(this.targetBufferTime)}set volume(e){this.playbackSource.volume=e}get volume(){return this.playbackSource.volume}set muted(e){if(e===this.muted)return;const t=this.playbackSource.muted;this.playbackSource.muted=e,!e&&t&&!this.playbackSource.isPaused&&this.playbackSource.play()}get muted(){return this.playbackSource.muted}get media(){return this.options.get("media")}get videoBitRate(){return this.modules.incomingData.averageBitRate("video")}get audioBitRate(){return this.modules.incomingData.averageBitRate("audio")}get connectionState(){return this.modules.connection.getState()}get playbackState(){return this.modules.playback.getState()}get bufferFullness(){return this.modules.playback.getBufferFullness()}get sizeBasedResolutionCapEnabled(){return this.modules.constraintCap.sizeBasedResolutionCapEnabled}set sizeBasedResolutionCapEnabled(e){this.modules.constraintCap.sizeBasedResolutionCapEnabled=e}get abrEnabled(){return this.modules.adaptivity.isEnabled}set abrEnabled(e){this.modules.constraintCap.sizeBasedResolutionCapEnabled=!!e&&this.options.get("sizeBasedResolutionCapEnabled"),this.modules.adaptivity.isEnabled=e,this.alignSizeAndBitRate(this.targetSubscription)}get serverEdgeTime(){return this.modules.sync.getLiveEdgeTimeLatencyAdjusted(this.currentSubscription.channelId)}get serverWallclockTime(){return this.modules.sync.getWallclockTimeLatencyAdjusted(this.currentSubscription.channelId)}get currentTime(){return this.modules.sync.serverCurrentTime}get channelCurrentTime(){return this.modules.sync.channelCurrentTime}get targetBufferTime(){return this.modules.playback.getTargetBufferTime()}set targetBufferTime(e){this.modules.playback.getTargetBufferTime()!==e&&(this.modules.playback.setTargetBufferTime(e),this.playbackSource.currentTime=this.modules.sync.serverCurrentTime,this.options.get("burstEnabled",this.channelId)?this.modules.subscription.enableBurst(this.targetBufferTime):this.modules.subscription.enableBurst(0))}get playbackLatency(){var e;if(0!==this.playbackSource.currentTime)return this.targetBufferTime+(null!=(e=this.modules.sync.drift)?e:0)+this.modules.connection.rtt/2}get playbackWallclockTime(){if(this.serverWallclockTime&&this.playbackLatency)return this.serverWallclockTime-this.playbackLatency}get channels(){return this._channels}get languages(){return this.modules.renditions.getLanguages()}get language(){return this.modules.subscription.getTargetSubscription().audio.language}set language(e){this.modules.subscription.setLanguage(e)}set textTrack(e){f(this,bn).forEach((t=>{t.label===e?t.mode="showing":t.mode="hidden"})),this.emitter.emit("text track",e)}get textTracks(){return f(this,bn).filter((e=>"disabled"!==e.mode)).map((e=>e.label))}get textTrack(){var e;return null==(e=f(this,bn).find((e=>"showing"===e.mode)))?void 0:e.label}get channelId(){var e,t;return null!=(t=null==(e=this.modules)?void 0:e.subscription.getTargetSubscription().channelId)?t:this.options.get("channelId")}set channelId(e){if(e===this.channelId)return;this.modules.subscription.setChannelId(e);const t="audio"===this.options.get("media")?[]:this.options.get("videoCodecs"),i=this.modules.renditions.getAudioRenditions(e),s=this.modules.renditions.getVideoRenditions(e),n=this.targetSubscription.audio.language,r=null==i?void 0:i.some((e=>e.language===n)),o=t.find((e=>void 0!==(null==s?void 0:s.find((t=>t.codec===e)))));o&&this.modules.subscription.setVideoCodec(o),this.logger.debug("Channel switch - started",{audioRenditions:i,targetSubscriptionLanguage:n,targetHasCurrentLanguage:r}),this.alignSizeAndBitRate(this.targetSubscription)}get maxSize(){var e,t;const{width:i,height:s}=null!=(t=null==(e=this.modules.constraintCap.getCurrentConstraintCap())?void 0:e.video)?t:fe();return{width:i,height:s}}set maxSize(e){this.modules.constraintCap.setUserSpecifiedCap({video:{width:e.width,height:e.height}}),this.alignSizeAndBitRate(this.targetSubscription)}get maxVideoBitRate(){var e,t;return null!=(t=null==(e=this.modules.constraintCap.getCurrentConstraintCap())?void 0:e.video.bitRate)?t:pe()}set maxVideoBitRate(e){this.modules.constraintCap.setUserSpecifiedCap({video:{bitRate:e}}),this.alignSizeAndBitRate(this.targetSubscription)}get maxAudioBitRate(){var e,t;return null!=(t=null==(e=this.modules.constraintCap.getCurrentConstraintCap())?void 0:e.audio.bitRate)?t:pe()}set maxAudioBitRate(e){this.modules.constraintCap.setUserSpecifiedCap({audio:{bitRate:e}}),this.alignSizeAndBitRate(this.targetSubscription)}get renditionLevels(){return this.modules.renditions.getRenditionLevels()}get currentRenditionLevel(){return this.modules.renditions.getRenditionLevel()}get targetRenditionLevel(){return this.modules.renditions.getRenditionLevel(this.modules.subscription.getTargetSubscription())}get isSwitchingRenditionLevel(){return this.modules.subscription.isSwitchingSubscription()}get videoBufferedRanges(){var e,t,i,s;return null!=(s=null!=(i=null==(e=this.modules.mseModule)?void 0:e.getBuffer("video"))?i:null==(t=this.modules.decoder)?void 0:t.getBuffer("video"))?s:[]}get audioBufferedRanges(){var e,t,i,s;return null!=(s=null!=(i=null==(e=this.modules.mseModule)?void 0:e.getBuffer("audio"))?i:null==(t=this.modules.decoder)?void 0:t.getBuffer("audio"))?s:[]}getApiClient(){return this.modules.connection.apiClient}get lastBufferEvent(){return this.modules.playback.getLastBufferStateEvent()}get activeRatios(){return this.modules.qualityOfService.activeRatios()}get bufferingRatios(){return this.modules.qualityOfService.bufferingRatios()}get timeSpentBuffering(){return this.modules.qualityOfService.timeSpentBuffering()}get timeActive(){return this.modules.qualityOfService.timeActive()}get mediaElement(){return this.element}get audioNode(){var e;return null!=(e=this.modules)&&e.canvasModule?this.modules.canvasModule.audioNode:void 0}get drmStatistics(){var e;return null==(e=this.encryptedMediaExtensions)?void 0:e.getStatistics()}get uptime(){return Date.now()-this.createdAt}suspend(){this.isSuspended||(Object.values(this.modules).forEach((e=>{e&&"suspend"in e&&e.suspend()})),this.isSuspended=!0)}unsuspend(){this.isSuspended&&(Object.values(this.modules).forEach((e=>{e&&"unsuspend"in e&&e.unsuspend()})),this.isSuspended=!1)}alignSizeAndBitRate(e){const t=this.modules.constraintCap.constrainSubscription(A(m({},e),{video:m({},e.video),audio:m({},e.audio)})),i=this.modules.constraintCap.getUserSpecifiedCap();!this.abrEnabled&&i&&(t.audio.bitRate=i.audio.bitRate,t.video.bitRate=i.video.bitRate,t.video.width=i.video.width,t.video.height=i.video.height);const s=this.modules.renditions.getRenditionLevel(t);if(s)if(s.video&&(this.modules.subscription.setVideoBitRate(s.video.bitRate),this.modules.subscription.setSize(s.video)),s.audio)this.modules.subscription.setAudioBitRate(s.audio.bitRate),this.modules.subscription.setLanguage(s.audio.language);else if(t.audio.language){let e=this.modules.renditions.getAudioRenditions(t.channelId);!this.abrEnabled&&i&&(e=null==e?void 0:e.filter((e=>e.bitRate<i.audio.bitRate)));const s=t.audio.language,n=null==e?void 0:e.some((e=>e.language===s)),r=null==e?void 0:e.find((e=>e.language)),o=(null==e?void 0:e.length)&&e[0]||void 0;n||(r?(this.logger.debug("Randomizing language since target did not have current language"),this.modules.subscription.setAudioBitRate(r.bitRate),this.modules.subscription.setLanguage(r.language)):(this.logger.debug("Randomizing audio rendition since target did not have current language"),null!=o&&o.bitRate&&this.modules.subscription.setAudioBitRate(o.bitRate),this.modules.subscription.setLanguage(null==o?void 0:o.language)))}}get currentSubscription(){return this.modules.subscription.getCurrentSubscription()}get targetSubscription(){return this.modules.subscription.getTargetSubscription()}willUseMediaSource(){return this.browser.supportsMediaSource&&this.options.get("mseEnabled")}};wn=new WeakMap,bn=new WeakMap,yn=new WeakMap,g(Sn,"MAX_POOL_SIZE",10),g(Sn,"INITIAL_MAX_BIT_RATE",25e5),g(Sn,"DISCONNECT_TIMEOUT",15e3),g(Sn,"REMOVE_CUE_THRESHOLD",1e4);let En=Sn}},s={};function n(e){var t=s[e];if(void 0!==t)return t.exports;var r=s[e]={exports:{}};return i[e](r,r.exports,n),r.exports}n.m=i,n.d=(e,t)=>{for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},n.f={},n.e=e=>Promise.all(Object.keys(n.f).reduce(((t,i)=>(n.f[i](e,t),t)),[])),n.u=e=>e+"."+{487:"4fb5fea640ec45082140",515:"77283be08bf0a32d2ba9",767:"960208d03b9fbf7a14a5"}[e]+".bundle.js",n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},t="vindral-examples:",n.l=(i,s,r,o)=>{if(e[i])e[i].push(s);else{var a,h;if(void 0!==r)for(var d=document.getElementsByTagName("script"),c=0;c<d.length;c++){var l=d[c];if(l.getAttribute("src")==i||l.getAttribute("data-webpack")==t+r){a=l;break}}a||(h=!0,(a=document.createElement("script")).charset="utf-8",a.timeout=120,n.nc&&a.setAttribute("nonce",n.nc),a.setAttribute("data-webpack",t+r),a.src=i),e[i]=[s];var u=(t,s)=>{a.onerror=a.onload=null,clearTimeout(m);var n=e[i];if(delete e[i],a.parentNode&&a.parentNode.removeChild(a),n&&n.forEach((e=>e(s))),t)return t(s)},m=setTimeout(u.bind(null,void 0,{type:"timeout",target:a}),12e4);a.onerror=u.bind(null,a.onerror),a.onload=u.bind(null,a.onload),h&&document.head.appendChild(a)}},n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;n.g.importScripts&&(e=n.g.location+"");var t=n.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var i=t.getElementsByTagName("script");if(i.length)for(var s=i.length-1;s>-1&&(!e||!/^http(s?):/.test(e));)e=i[s--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),n.p=e})(),(()=>{var e={679:0};n.f.j=(t,i)=>{var s=n.o(e,t)?e[t]:void 0;if(0!==s)if(s)i.push(s[2]);else{var r=new Promise(((i,n)=>s=e[t]=[i,n]));i.push(s[2]=r);var o=n.p+n.u(t),a=new Error;n.l(o,(i=>{if(n.o(e,t)&&(0!==(s=e[t])&&(e[t]=void 0),s)){var r=i&&("load"===i.type?"missing":i.type),o=i&&i.target&&i.target.src;a.message="Loading chunk "+t+" failed.\n("+r+": "+o+")",a.name="ChunkLoadError",a.type=r,a.request=o,s[1](a)}}),"chunk-"+t,t)}};var t=(t,i)=>{var s,r,[o,a,h]=i,d=0;if(o.some((t=>0!==e[t]))){for(s in a)n.o(a,s)&&(n.m[s]=a[s]);h&&h(n)}for(t&&t(i);d<o.length;d++)r=o[d],n.o(e,r)&&e[r]&&e[r][0](),e[r]=0},i=self.webpackChunkvindral_examples=self.webpackChunkvindral_examples||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))})();var r=n(4903);const o=document.querySelector("#vindral-container"),a=document.querySelector("#activate-audio-button"),h=document.querySelector("#playback-state");a.style.display="none";const d=new r.V({url:"https://lb.cdn.vindral.com",channelId:"vindral_demo1_ci_099ee1fa-80f3-455e-aa23-3d184e93e04f",minBufferTime:1e3});d.on("error",(e=>{e.isFatal()&&console.log("fatal error: ",e.message)})),d.on("playback state",(e=>h.textContent=e)),d.on("metadata",(e=>console.log("metadata: ",e.content))),d.on("needs user input",(()=>a.style.display="block")),d.play(),d.attach(o),a.addEventListener("click",(()=>{a.style.display="none",d.play()}))})();